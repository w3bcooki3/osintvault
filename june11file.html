
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Primary Meta Tags -->
    <title>OSINTVault - Your Personal OSINT Workspace</title>
    <meta name="title" content="OSINTVault - Your Personal OSINT Workspace">
    <meta name="description" content="OSINTVault is a free, browser-based OSINT workspace to manage tools, investigations, dorks, IOCs, and notes — no backend, fully private.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://w3bcooki3.github.io/osintvault/">
    <meta property="og:title" content="OSINTVault - Your Personal OSINT Workspace">
    <meta property="og:description" content="A free, privacy-respecting tool for managing OSINT tools, investigations, dork queries, and more — all in your browser.">
    <meta property="og:image" content="https://w3bcooki3.github.io/osintvault/assets/preview-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://w3bcooki3.github.io/osintvault/">
    <meta property="twitter:title" content="OSINTVault - Your Personal OSINT Workspace">
    <meta property="twitter:description" content="A free, privacy-respecting tool for managing OSINT tools, investigations, dork queries, and more — all in your browser.">
    <meta property="twitter:image" content="https://w3bcooki3.github.io/osintvault/assets/preview-image.png">

    <!-- SEO -->
    <meta name="keywords" content="OSINT, OSINT tools, cybersecurity, threat intelligence, investigation, dork builder, open source, local storage, incident response, malware analysis">
    <meta name="author" content="w3bcooki3">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./favicon.png" type="image/x-icon">

    <style>
        :root {
            --primary: #007bff; /* Slightly less vibrant blue, more authoritative */
            --primary-dark: #0056b3;
            --secondary: #ff6b35; /* Strong accent for highlights */
            --accent: #28a745; /* Positive action/success */
            --danger: #dc3545;
            --warning: #ffaa00;
            --success: #28a745;

            /* Darker, more professional greyscale for dark theme */
            --bg-primary: #0C1017; /* Deeper primary background */
            --bg-secondary: #171E28; /* Slightly lighter card/section background */
            --bg-tertiary: #212B3B; /* Input/hover background */
            --bg-card: #1E2736;     /* Card background */

            --text-primary: #E0E6F0; /* Brighter text for contrast */
            --text-secondary: #9BAEC8; /* Muted text */
            --text-muted: #6A7F9D;    /* Even more muted text */

            --border: #3D4C61;      /* Stronger but still subtle border */
            --border-light: #526680; /* Lighter border for dividers */

            /* Softer, multi-layered shadow */
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.3), 0 16px 60px rgba(0, 0, 0, 0.2);

            --glow: 0 0 15px rgba(0, 123, 255, 0.4); /* Adjusted glow for new primary */
            --primary-shadow-color: rgba(0, 123, 255, 0.3); /* For primary button shadow */
            --primary-shadow-color-hover: rgba(0, 123, 255, 0.4);

            /* Very subtle gradient, mainly for active states or branding */
            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #1e8738);
            /* Softened background gradient */
            --gradient-bg: linear-gradient(135deg, #0C1017, #171E28);

            /* Default Tab Colors */
            --tab-color-default: var(--primary);
            --tab-color-red: #e74c3c;
            --tab-color-blue: #3498db;
            --tab-color-green: #2ecc71;
            --tab-color-yellow: #f1c40f;
            --tab-color-purple: #9b59b6;
            --tab-color-orange: #e67e22;
        }

        [data-theme="light"] {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --accent: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;

            /* Lighter, professional greyscale for light theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F9FC; /* Slightly off-white for sections */
            --bg-tertiary: #E8EEF5; /* Light grey for inputs/hovers */
            --bg-card: #FFFFFF;    /* White card background */

            --text-primary: #2C3E50; /* Darker text for readability */
            --text-secondary: #607D8B; /* Muted grey text */
            --text-muted: #95A5A6;    /* Even more muted */

            --border: #CFD8DC; /* Light grey border */
            --border-light: #ECEFF1; /* Very light border */

            --glow: 0 0 10px rgba(0, 123, 255, 0.2);
            --shadow: 0 1px 4px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08);

            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #218838);
            --gradient-bg: linear-gradient(135deg, #F7F9FC, #E8EEF5);

            /* Default Tab Colors (Light Theme) */
            --tab-color-default: var(--primary);
            --tab-color-red: #c0392b;
            --tab-color-blue: #2980b9;
            --tab-color-green: #27ae60;
            --tab-color-yellow: #f39c12;
            --tab-color-purple: #8e44ad;
            --tab-color-orange: #d35400;


            --nav-bg-primary: #f8fafc;
            --nav-bg-secondary: #ffffff;
            --nav-bg-tertiary: #f1f5f9;
            --nav-bg-card: rgba(255, 255, 255, 0.9);
            --nav-text-primary: #1e293b;
            --nav-text-secondary: #64748b;
            --nav-text-muted: #94a3b8;
            --nav-accent-primary: #0ea5e9;
            --nav-accent-secondary: #8b5cf6;
            --nav-accent-success: #10b981;
            --nav-accent-warning: #f59e0b;
            --nav-accent-danger: #ef4444;
            --nav-border-primary: #e2e8f0;
            --nav-border-secondary: #cbd5e1;
            --nav-shadow-light: rgba(0, 0, 0, 0.05);
            --nav-shadow-medium: rgba(0, 0, 0, 0.1);
            --nav-shadow-heavy: rgba(0, 0, 0, 0.25);
            --nav-glow-primary: rgba(14, 165, 233, 0.3);
            --nav-glow-secondary: rgba(139, 92, 246, 0.3);
            --nav-grid-color: rgba(148, 163, 184, 0.1);
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --nav-bg-primary: #0f172a;
            --nav-bg-secondary: #1e293b;
            --nav-bg-tertiary: #334155;
            --nav-bg-card: rgba(30, 41, 59, 0.9);
            --nav-text-primary: #f8fafc;
            --nav-text-secondary: #cbd5e1;
            --nav-text-muted: #64748b;
            --nav-accent-primary: #06b6d4;
            --nav-accent-secondary: #a855f7;
            --nav-accent-success: #22c55e;
            --nav-accent-warning: #fbbf24;
            --nav-accent-danger: #f87171;
            --nav-border-primary: #334155;
            --nav-border-secondary: #475569;
            --nav-shadow-light: rgba(0, 0, 0, 0.3);
            --nav-shadow-medium: rgba(0, 0, 0, 0.5);
            --nav-shadow-heavy: rgba(0, 0, 0, 0.8);
            --nav-glow-primary: rgba(6, 182, 212, 0.4);
            --nav-glow-secondary: rgba(168, 85, 247, 0.4);
            --nav-grid-color: rgba(148, 163, 184, 0.05);
        }



        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg); 
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* New class for body to prevent scrolling when mobile menu/sidebar is open */
        body.no-scroll {
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin: 0 auto; 
        }

        /* Header Styles - Redesigned with --nav- colors (Fixed Responsive) */
        header {
            background: linear-gradient(135deg, var(--nav-bg-card), var(--nav-bg-secondary));
            backdrop-filter: blur(25px) saturate(180%);
            border-bottom: 1px solid var(--nav-border-primary);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 
                0 8px 32px var(--nav-shadow-light),
                0 2px 16px var(--nav-shadow-medium),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        /* Animated background grid */
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--nav-grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--nav-grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, 20px); }
        }

        /* Floating glow effect */
        header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at 30% 50%, 
                var(--nav-glow-primary) 0%, 
                transparent 25%
            ),
            radial-gradient(
                circle at 70% 30%, 
                var(--nav-glow-secondary) 0%, 
                transparent 25%
            );
            opacity: 0.1;
            animation: floatGlow 15s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes floatGlow {
            0%, 100% { transform: translate(-10px, -10px) rotate(0deg); }
            33% { transform: translate(10px, -20px) rotate(120deg); }
            66% { transform: translate(-20px, 10px) rotate(240deg); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px 40px;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
        }


        /* Left section - Logo and Title */
        .logo-and-title-container {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
            min-width: 0;
            margin-right: auto;
            position: relative;
        }

        /* Logo with enhanced effects */
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 65px;
            position: relative;
            flex-shrink: 0;
        }

        .header-logo::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--nav-accent-primary), var(--nav-accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .header-logo:hover::before {
            opacity: 0.2;
        }

        .osintvault-logo-img {
            display: block;
            max-height: 100%;
            width: auto;
            filter: 
                drop-shadow(0 0 15px var(--nav-glow-primary))
                drop-shadow(0 0 30px var(--nav-glow-secondary));
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: logoPulse 4s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .osintvault-logo-img:hover {
            filter: 
                drop-shadow(0 0 25px var(--nav-glow-primary))
                drop-shadow(0 0 45px var(--nav-glow-secondary));
            transform: scale(1.1) rotate(5deg);
        }

        /* Text group styling */
        .header-text-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            flex-grow: 1;
            min-width: 0;
            position: relative;
        }

        .header-title {
            font-size: 2.4em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--nav-accent-primary), var(--nav-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Outfit', sans-serif;
            letter-spacing: -1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            animation: titleShimmer 3s ease-in-out infinite;
        }

        @keyframes titleShimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .header-tagline {
            font-size: 0.85rem;
            color: var(--nav-text-secondary);
            font-family: 'Inter', sans-serif;
            margin-top: 4px;
            font-weight: 500;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Right section - Controls */
        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
            min-width: 0;
            justify-content: flex-end;
            margin-left: auto;
        }

        /* Enhanced search container */
        .search-container {
            position: relative;
            min-width: 350px;
            display: flex;
            align-items: center;
            background: var(--nav-bg-tertiary);
            border-radius: 16px;
            padding: 4px;
            box-shadow: 
                0 4px 20px var(--nav-shadow-light),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid var(--nav-border-primary);
            transition: all 0.3s ease;
        }

        .search-container:hover {
            box-shadow: 
                0 8px 30px var(--nav-shadow-medium),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: var(--nav-accent-primary);
        }

        .search-input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            background: transparent;
            color: var(--nav-text-primary);
            transition: all 0.3s ease;
            flex-grow: 1;
            font-weight: 500;
        }

        .search-input::placeholder {
            color: var(--nav-text-muted);
            opacity: 0.8;
        }

        .search-input:focus {
            outline: none;
            background: var(--nav-bg-card);
            box-shadow: 0 0 0 2px var(--nav-glow-primary);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--nav-text-secondary);
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .search-container:hover .search-icon {
            color: var(--nav-accent-primary);
            transform: translateY(-50%) scale(1.1);
        }

        /* Enhanced search scope select */
        #searchScopeSelect {
            margin-left: 12px;
            padding: 12px 32px 12px 16px;
            border-radius: 12px;
            background: var(--nav-bg-card);
            color: var(--nav-text-primary);
            border: 1px solid var(--nav-border-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--nav-shadow-light);
            font-weight: 500;
            font-size: 13px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%236A7F9D%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H19a17.6%2017.6%200%200%200-13.6%206.4%2017.6%2017.6%200%200%200%200%2025.2l128%20128c6.9%206.9%2017.9%206.9%2024.7%200l128-128a17.6%2017.6%200%200%200%200-25.2z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 12px auto;
        }

        #searchScopeSelect:focus {
            outline: none;
            border-color: var(--nav-accent-primary);
            box-shadow: 0 0 0 3px var(--nav-glow-primary);
        }

        #searchScopeSelect:hover {
            background: var(--nav-bg-tertiary);
            border-color: var(--nav-accent-primary);
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none; /* Hidden by default, shown in media query */
            background: var(--nav-bg-tertiary);
            border: 1px solid var(--nav-border-primary);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--nav-text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: var(--nav-bg-card);
            box-shadow: 0 4px 15px var(--nav-shadow-light);
        }

        /* Mobile Sidebar Menu (NEW) */
        .mobile-sidebar-menu {
            position: fixed;
            top: 0;
            right: -320px; /* Off-screen initially */
            width: 280px; /* Adjusted width for mobile */
            max-width: 80vw; /* Ensure it doesn't overflow very small screens */
            height: 100vh;
            background: var(--nav-bg-card);
            backdrop-filter: blur(25px) saturate(180%);
            border-left: 1px solid var(--nav-border-primary);
            z-index: 1000; /* High z-index to appear on top */
            transition: right 0.3s ease-in-out;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            overflow-y: auto; /* Allow scrolling for long menus */
            padding: 20px;
        }

        .mobile-sidebar-menu.active {
            right: 0; /* Slide in when active */
        }

        .mobile-sidebar-menu .close-menu-btn {
            background: none;
            border: none;
            color: var(--nav-text-primary);
            font-size: 24px;
            position: absolute; /* Changed to absolute for consistent positioning within menu */
            top: 10px;
            right: 10px;
            cursor: pointer;
            z-index: 1001; /* Ensure it's above menu content */
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        .mobile-sidebar-menu .close-menu-btn:hover {
            background: var(--bg-tertiary);
        }

        .mobile-sidebar-menu .mobile-menu-content {
            padding-top: 40px; /* Space for the close button */
        }

        .mobile-sidebar-menu .mobile-nav-cloned {
            display: flex;
            flex-direction: column; /* Stack tabs vertically in mobile menu */
            width: 100%;
            align-items: flex-start; /* Align tabs to the left */
            border: none; /* Remove border */
            box-shadow: none; /* Remove shadow */
            padding: 0; /* Remove padding */
            margin: 0; /* Remove margin */
            background: none; /* Remove background */
        }

        .mobile-sidebar-menu .mobile-nav-cloned .nav-tab {
            width: 100%; /* Make tabs full width */
            justify-content: flex-start; /* Align text to left */
            flex-direction: row; /* Icon and text in a row */
            padding: 12px 15px; /* Larger tap target */
            font-size: 1rem;
            gap: 10px;
            margin-bottom: 5px; /* Space between items */
            border-radius: 8px; /* Restore some rounding */
        }
        .mobile-sidebar-menu .mobile-nav-cloned .nav-tab i {
            margin-bottom: 0;
        }

        .mobile-sidebar-menu .mobile-controls-cloned {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--nav-border-primary);
        }
        .mobile-sidebar-menu .mobile-controls-cloned .btn {
            width: 100%;
            justify-content: center;
        }
        .mobile-sidebar-menu .mobile-controls-cloned .search-container {
            width: 100%;
            max-width: none;
            padding: 8px;
            flex-direction: column;
            align-items: stretch;
        }
        .mobile-sidebar-menu .mobile-controls-cloned .search-input {
            padding: 12px 40px 12px 15px;
            margin-bottom: 10px;
        }
        .mobile-sidebar-menu .mobile-controls-cloned #searchScopeSelect {
            margin-left: 0;
            margin-top: 0;
            width: 100%;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
                margin: 20px 20px;
                width: calc(100% - 40px);
                gap: 20px;
            }
            .header-content {
                padding: 15px 20px;
            }
            .main-nav-tabs {
                padding: 8px 10px;
                gap: 5px;
            }
            .nav-tab {
                padding: 12px 14px;
                font-size: 0.85rem;
            }
            .search-container {
                min-width: 250px;
            }
        }

        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                align-items: center;
                padding: 15px;
                gap: 15px;
            }
            .logo-and-title-container {
                justify-content: center;
                width: 100%;
                margin-right: 0;
            }
            .controls {
                width: 100%;
                justify-content: center;
                margin-left: 0;
                order: 1;
            }
            .search-container {
                min-width: auto;
                width: 100%;
                max-width: 450px;
                flex-direction: row;
                padding: 8px;
            }
            .search-input {
                padding: 12px 40px 12px 15px;
                margin-bottom: 0;
            }
            #searchScopeSelect {
                margin-left: 10px;
                margin-top: 0;
                width: auto;
            }

            .tools-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
            }
            .tool-card {
                padding: 20px;
            }
            .tool-title {
                font-size: 1.05rem;
            }
            .tool-url {
                font-size: 0.75rem;
            }

            .pre-templates-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .pre-templates-sidebar {
                position: static;
                margin-bottom: 0;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .dashboard {
                margin: 15px 10px;
                width: calc(100% - 20px);
                gap: 15px;
            }

            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                gap: 10px;
            }
            .logo-and-title-container {
                justify-content: flex-start;
                width: auto;
                flex-grow: 1;
            }
            .header-text-group {
                display: none;
            }
            .controls {
                display: none;
                order: unset;
            }
            .mobile-menu-toggle {
                display: block;
                order: 2;
            }
            .header-logo {
                height: 50px;
            }

            .main-nav-tabs {
                padding: 4px;
                border-radius: 10px;
                margin: 0 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-tab {
                padding: 8px 10px;
                font-size: 0.75rem;
                gap: 5px;
                flex-direction: column;
                text-align: center;
                min-width: 65px;
            }
            .nav-tab i {
                font-size: 0.9rem;
                margin-bottom: 2px;
            }
            .sub-nav-tabs {
                margin: 10px 0;
                padding: 3px;
                border-radius: 8px;
            }
            .sub-nav-tab {
                padding: 6px 10px;
                font-size: 0.7rem;
                min-height: 28px;
            }
            .stat-item:nth-child(2n) {
                border-right: none;
            }
            .stat-item:last-child {
                border-right: none;
            }

            .main-content {
                padding: 15px;
            }
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .content-title {
                font-size: 24px;
                width: 100%; 
                text-align: center;
            }
            .content-header .controls {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                gap: 10px;
            }
            .content-header .btn {
                width: 100%;
                justify-content: center;
            }

            .tools-grid, .tools-list {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .tools-list .tool-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .tools-list .tool-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 5px;
            }
            .tool-card {
                padding: 15px;
            }
            .tool-title {
                font-size: 15px;
            }
            .tool-url {
                font-size: 10px;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px;
            }
            .bulk-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .analytics-card {
                padding: 20px;
            }
            .analytics-value {
                font-size: 2.5rem;
            }
            .analytics-list li {
                font-size: 13px;
                padding: 8px 0;
            }

            .threat-item {
                padding: 15px;
                margin-bottom: 10px;
            }
            .threat-header h4 {
                font-size: 1.1em;
            }
            .threat-level {
                font-size: 0.7em;
                padding: 3px 8px;
            }

            .modal-content {
                padding: 25px;
                border-radius: 12px;
            }
            .form-group label {
                font-size: 0.9em;
                margin-bottom: 8px;
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 13px;
                border-radius: 8px;
            }
            .btn {
                padding: 10px 15px;
                font-size: 13px;
                border-radius: 10px;
            }
            .btn2 {
                padding: 10px 15px;
                font-size: 13px;
                border-radius: 10px;
            }

            .toast {
                max-width: calc(100% - 40px);
                margin: 0 auto;
                text-align: center;
                right: auto;
                left: 50%;
                transform: translateX(-50%);
            }

            .handbook-container {
                grid-template-columns: 1fr;
                gap: 0;
                margin: 0;
                width: 100%;
            }
            .handbook-sidebar {
                position: fixed;
                left: -320px;
                top: 0;
                bottom: 0;
                width: 300px;
                z-index: 1000;
                border-radius: 0;
                transition: left 0.3s ease;
                overflow-y: auto;
                background: var(--nav-bg-card);
                border-right: 1px solid var(--nav-border-primary);
                box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            }
            .handbook-sidebar.mobile-open {
                left: 0;
            }
            .handbook-mobile-toggle {
                display: flex;
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1001;
                width: 50px;
                height: 50px;
                font-size: 24px;
                background: var(--primary);
                color: white;
                border-radius: 50%;
                justify-content: center;
                align-items: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            }
            
            body.handbook-overlay-active {
                overflow: hidden;
            }
            .handbook-content-container {
                padding: 15px;
                margin-top: 0;
                width: 100%; 
            }
            .notes-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .notes-search-container {
                margin-left: 0;
                width: 100%;
                order: 1; 
            }
            .new-note-btn {
                width: 100%;
                justify-content: center;
                order: 3;
            }
            #noteSortFilter {
                width: 100%;
                order: 2;
            }
            .notes-grid {
                grid-template-columns: 1fr;
            }
            .note-editor-actions {
                flex-direction: column;
                gap: 10px;
            }
            .formatting-toolbar {
                padding: 8px;
                flex-wrap: wrap;
                justify-content: center;
                gap: 3px;
            }
            .formatting-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            #intelligenceVaultParentTabs,
            #customVaultEntryParentTabs {
                flex-direction: column; /* Stack parent tabs vertically */
                width: 100%;
                margin: 15px 0 0 0; /* Adjust margins for stacking */
                padding: 5px; /* Adjust padding for stacked buttons */
                box-shadow: none; /* Remove shadow if desired for stacked appearance */
                border-radius: 8px;
            }

            #intelligenceVaultParentTabs .nav-tab,
            #customVaultEntryParentTabs .nav-tab {
                width: 100%; /* Make each button fill the container */
                justify-content: flex-start; /* Align content to the left within button */
                margin-bottom: 5px; /* Add space between stacked buttons */
                padding: 10px 15px; /* Adjust padding */
                font-size: 0.8rem;
                flex-direction: row; /* Keep icon and text in a row within each button */
            }

            #intelligenceVaultChildTabs,
            #customVaultEntryChildTabs {
                flex-direction: column; /* Stack child tabs vertically */
                width: 100%;
                margin: 10px 0 0 0; /* Adjust margins for stacking */
                padding: 5px; /* Adjust padding for stacked buttons */
                box-shadow: none; /* Remove shadow if desired for stacked appearance */
                border-radius: 8px;
            }

            #intelligenceVaultChildTabs .sub-nav-tab,
            #customVaultEntryChildTabs .sub-nav-tab {
                width: 100%; /* Make each button fill the container */
                justify-content: flex-start; /* Align content to the left within button */
                margin-bottom: 5px; /* Add space between stacked buttons */
                padding: 8px 15px; /* Adjust padding */
                font-size: 0.75rem;
                flex-direction: row; /* Keep icon and text in a row within each button */
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                margin: 10px 5px; /* Even tighter margins for very small screens */
                width: calc(100% - 10px);
                gap: 10px;
            }
            .header-content {
                padding: 8px 10px;
            }
            .header-logo {
                height: 40px; /* Smallest logo size */
            }
            .main-nav-tabs {
                margin: 0 5px;
                padding: 3px;
            }
            .nav-tab {
                padding: 6px 8px;
                font-size: 0.65rem;
                min-width: 60px;
            }
            .sub-nav-tabs {
                margin: 8px 0;
                padding: 2px;
            }
            .sub-nav-tab {
                padding: 4px 8px;
                font-size: 0.6rem;
                min-height: 25px;
            }

            #intelligenceVaultParentTabs .nav-tab,
            #customVaultEntryParentTabs .nav-tab,
            #intelligenceVaultChildTabs .sub-nav-tab,
            #customVaultEntryChildTabs .sub-nav-tab {
                padding: 8px 10px; /* Make them even tighter */
                font-size: 0.7rem;
                margin-bottom: 3px; /* Smaller gap */
            }
            .main-content {
                padding: 10px;
            }
            .content-title {
                font-size: 20px;
            }
            .tool-card {
                padding: 10px;
            }
            .tool-title {
                font-size: 14px;
            }
            .tool-url {
                font-size: 9px;
            }
            .tag {
                padding: 3px 8px;
                font-size: 0.7rem;
            }
            .modal-content {
                padding: 20px;
            }
            .form-group input, .form-group select, .form-group textarea {
                padding: 8px;
                font-size: 12px;
            }
            .btn, .btn2 {
                padding: 8px 12px;
                font-size: 12px;
            }
            .notes-empty-state, .empty-state {
                padding: 30px 10px;
            }
            .notes-empty-state h3, .empty-state h3 {
                font-size: 1.2em;
            }
            .notes-empty-state p, .empty-state p {
                font-size: 0.85em;
            }
            .notes-empty-state i, .empty-state i {
                font-size: 48px;
            }
            .theme-toggle, .handbook-mobile-toggle {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            #desktopRecommendationModal .modal-content {
                padding: 20px;
            }
            #desktopRecommendationModal h3 {
                font-size: 18px;
            }
            #desktopRecommendationModal p {
                font-size: 13px;
            }
            /* Dork assistant adjustments */
            .dork-subtab-content > div { /* Target the flex container */
                flex-direction: column; /* Stack columns */
            }
            .dork-subtab-content > div > div { /* Target the flex children (builder and preview) */
                width: 100%;
                max-width: none; /* Remove max-width constraint */
            }
            .pre-templates-sidebar .category-item {
                flex-direction: row; /* Keep items in a row */
                text-align: left;
                padding: 8px 10px;
                font-size: 0.8em;
            }
            .pre-templates-sidebar .category-item i {
                font-size: 1em;
                margin-right: 5px;
            }
            .pre-templates-sidebar .category-item span {
                flex-grow: 1;
            }
            .pre-templates-sidebar .category-item .template-count {
                font-size: 0.7em;
                padding: 2px 6px;
            }
            .dork-operator-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            #savedQueriesSearch, #preTemplateSearchInput {
                max-width: 100%; /* Allow search inputs to fill width */
                margin-right: 0 !important; /* Remove specific margin */
                margin-bottom: 10px; /* Add some space below */
            }
            .content-header .controls button { /* Target buttons in content header when stacked */
                margin-right: 0 !important;
                width: 100%;
            }

            /* Investigation Wall adjustments */
            .wall-header {
                padding: 1.5rem 1rem;
            }
            .section-title {
                font-size: clamp(1.8rem, 8vw, 3rem); /* Adjust font size range for smaller screens */
                margin-bottom: 0.8rem;
            }
            .section-subtitle {
                font-size: clamp(0.9rem, 3vw, 1.1rem);
                margin-top: 1rem;
            }
            .evidence-container {
                padding: 0 1rem;
            }
            .evidence-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .evidence-card {
                padding: 1.2rem;
                border-radius: 12px;
            }
            .card-icon {
                width: 40px;
                height: 40px;
                padding: 10px;
                margin-right: 0.8rem;
            }
            .card-title {
                font-size: 1rem;
            }
            .card-content {
                font-size: 0.9rem;
            }
            .highlight {
                font-size: 0.8rem;
                padding: 1px 6px;
            }
        }

        /* Enhanced buttons */
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid var(--nav-border-primary);
            background: linear-gradient(135deg, var(--nav-bg-card), var(--nav-bg-tertiary));
            color: var(--nav-text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px var(--nav-shadow-light);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--nav-bg-tertiary), var(--nav-bg-card));
            box-shadow: 
                0 8px 25px var(--nav-shadow-medium),
                0 0 0 1px var(--nav-accent-primary);
            transform: translateY(-2px);
            border-color: var(--nav-accent-primary);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px var(--nav-shadow-light);
        }

        .btn i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .btn:hover i {
            transform: scale(1.1);
        }

        .btn2 {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.2px;
        }

        .btn2::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn2:hover::before {
            left: 100%;
        }


        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 51, 102, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        /* Nav */

        .nav-tabs {
            display: flex;
            gap: 0;
            background: var(--nav-bg-nav);
            backdrop-filter: var(--nav-backdrop-blur);
            -webkit-backdrop-filter: var(--nav-backdrop-blur);
            border: 1px solid var(--nav-border-primary);
            border-radius: 16px;
            padding: 8px;
            margin: 0 auto;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            box-shadow: 
                0 20px 25px -5px var(--nav-shadow-light),
                0 10px 10px -5px var(--nav-shadow-medium);
            position: relative;
        }

        .nav-tabs::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary));
            border-radius: 16px;
            opacity: 0.05;
            z-index: 0;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: var(--nav-border-secondary);
            border-radius: 2px;
        }

        .nav-tab {
            position: relative;
            padding: 14px 20px;
            background: none;
            border: none;
            color: var(--nav-text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1;
            min-width: max-content;
            overflow: hidden;
        }

        .nav-tab i {
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary));
            opacity: 0;
            border-radius: 12px;
            transition: all 0.3s ease;
            z-index: -1;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: var(--nav-bg-nav);
            border-radius: 10px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: -1;
        }

        .nav-tab:hover:not(.active) {
            color: var(--nav-text-primary);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active)::before {
            opacity: 0.1;
        }

        .nav-tab:hover:not(.active) i {
            color: var(--nav-accent-primary);
            transform: scale(1.1);
        }

        .nav-tab.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: 
                0 10px 15px -3px var(--nav-glow-primary),
                0 4px 6px -2px var(--nav-shadow-medium);
        }

        .nav-tab.active::before {
            opacity: 1;
        }

        .nav-tab.active::after {
            opacity: 1;
        }

        .nav-tab.active i {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: pulse 2s infinite;
        }

        /* Cybersecurity-specific tab colors */
        .nav-tab[data-tab="intelligence-vault"].active::before {
            background: linear-gradient(135deg, var(--nav-accent-primary), #0284c7);
        }

        .nav-tab[data-tab="custom-tabs"].active::before {
            background: linear-gradient(135deg, var(--nav-accent-secondary), #7c3aed);
        }

        .nav-tab[data-tab="analytics"].active::before {
            background: linear-gradient(135deg, var(--nav-accent-success), #059669);
        }

        .nav-tab[data-tab="threats"].active::before {
            background: linear-gradient(135deg, var(--nav-accent-danger), #dc2626);
        }

        .nav-tab[data-tab="dork-assistant"].active::before {
            background: linear-gradient(135deg, var(--nav-accent-warning), #d97706);
        }

        .nav-tab[data-tab="handbook"].active::before {
            background: linear-gradient(135deg, #6366f1, #4338ca);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .nav-tab {
                padding: 12px 16px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                padding: 6px;
                border-radius: 12px;
                margin: 0 1rem;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 0.75rem;
                gap: 6px;
            }
            
            .nav-tab i {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 1rem;
            }
            
            .nav-tabs {
                margin: 0;
                padding: 4px;
                border-radius: 10px;
            }
            
            .nav-tab {
                padding: 8px 10px;
                font-size: 0.7rem;
                gap: 4px;
                flex-direction: column;
                text-align: center;
                min-width: 70px;
            }
            
            .nav-tab i {
                font-size: 0.75rem;
                margin-bottom: 2px;
            }
        }

        /* Theme toggle for demo */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--nav-bg-secondary);
            border: 1px solid var(--nav-border-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px var(--nav-shadow-light);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 15px -3px var(--nav-shadow-medium);
        }

        /* Sub-navigation tabs styling */
        .sub-nav-tabs {
            display: flex;
            gap: 2px;
            margin-top: 16px;
            background: var(--nav-bg-tertiary);
            border: 1px solid var(--nav-border-secondary);
            border-radius: 10px;
            padding: 4px;
            flex-wrap: wrap;
            box-shadow: 
                inset 0 1px 3px 0 var(--nav-shadow-light),
                0 1px 2px 0 var(--nav-shadow-light);
            position: relative;
            overflow: hidden;
        }

        .sub-nav-tabs::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.02), 
                transparent);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }

        .sub-nav-tab {
            position: relative;
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--nav-text-muted);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
            flex-grow: 1;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            letter-spacing: 0.025em;
        }

        .sub-nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.5s ease;
            pointer-events: none;
        }

        .sub-nav-tab:hover::before {
            left: 100%;
        }

        .sub-nav-tab:hover:not(.active) {
            color: var(--nav-text-primary);
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.05), 
                rgba(255, 255, 255, 0.02));
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--nav-shadow-light);
        }

        .sub-nav-tab.active {
            color: white;
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                rgba(14, 165, 233, 0.8));
            box-shadow: 
                0 4px 8px rgba(14, 165, 233, 0.3),
                0 2px 4px var(--nav-shadow-medium),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .sub-nav-tab.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1), 
                transparent, 
                rgba(255, 255, 255, 0.05));
            border-radius: 6px;
            pointer-events: none;
        }

        /* Different sub-tab categories with distinct styling */
        .sub-nav-tab[data-category="tools"].active {
            background: linear-gradient(135deg, var(--nav-accent-primary), #0369a1);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3), 0 2px 4px var(--nav-shadow-medium);
        }

        .sub-nav-tab[data-category="data"].active {
            background: linear-gradient(135deg, var(--nav-accent-success), #047857);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3), 0 2px 4px var(--nav-shadow-medium);
        }

        .sub-nav-tab[data-category="analysis"].active {
            background: linear-gradient(135deg, var(--nav-accent-secondary), #6d28d9);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3), 0 2px 4px var(--nav-shadow-medium);
        }

        .sub-nav-tab[data-category="config"].active {
            background: linear-gradient(135deg, var(--nav-accent-warning), #b45309);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3), 0 2px 4px var(--nav-shadow-medium);
        }

        .sub-nav-tab[data-category="alert"].active {
            background: linear-gradient(135deg, var(--nav-accent-danger), #b91c1c);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3), 0 2px 4px var(--nav-shadow-medium);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Responsive sub-tabs */
        @media (max-width: 768px) {
            .sub-nav-tabs {
                margin-top: 12px;
                padding: 3px;
                gap: 1px;
            }
            
            .sub-nav-tab {
                padding: 6px 12px;
                font-size: 0.75rem;
                min-height: 32px;
            }
        }

        @media (max-width: 640px) {
            .sub-nav-tab {
                padding: 5px 8px;
                font-size: 0.7rem;
                min-height: 28px;
            }
        }


        /* Footer Styles - Center Tagline moved from Header */
        footer {
            background: linear-gradient(135deg, var(--nav-bg-card), var(--nav-bg-secondary));
            backdrop-filter: blur(25px) saturate(180%);
            border-top: 1px solid var(--nav-border-primary);
            position: relative;
            overflow: hidden;
            margin-top: auto;
            width: 100%;
            box-shadow: 
                0 -8px 32px var(--nav-shadow-light),
                0 -2px 16px var(--nav-shadow-medium),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Animated background grid for footer */
        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--nav-grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--nav-grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.2;
            animation: gridMoveReverse 25s linear infinite;
            pointer-events: none;
        }

        @keyframes gridMoveReverse {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-20px, -20px); }
        }

        /* Floating glow effect for footer */
        footer::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at 70% 30%, 
                var(--nav-glow-secondary) 0%, 
                transparent 25%
            ),
            radial-gradient(
                circle at 30% 70%, 
                var(--nav-glow-primary) 0%, 
                transparent 25%
            );
            opacity: 0.08;
            animation: floatGlowReverse 18s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes floatGlowReverse {
            0%, 100% { transform: translate(10px, 10px) rotate(0deg); }
            33% { transform: translate(-10px, 20px) rotate(-120deg); }
            66% { transform: translate(20px, -10px) rotate(-240deg); }
        }

        .footer-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 40px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }


        @keyframes footerTaglinePulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 4px 20px var(--nav-shadow-light); 
            }
            50% { 
                transform: scale(1.02); 
                box-shadow: 0 6px 30px var(--nav-shadow-medium); 
            }
        }

        /* Demo content styling - full width */
        .demo-content {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        /* Main heading styling */
        .demo-content h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--nav-accent-primary), var(--nav-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.5px;
            margin: 0 0 20px 0;
            animation: titleGlow 4s ease-in-out infinite;
            padding: 10px 10px;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        /* Copyright text styling */
        .demo-content p:first-of-type {
            font-size: 1rem;
            color: var(--nav-text-secondary) !important;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            margin-bottom: 1rem !important;
            opacity: 0.9;
            line-height: 1.5;
        }

        /* Features list styling */
        .demo-content p:last-of-type {
            color: var(--nav-text-muted) !important;
            font-size: 0.875rem !important;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            opacity: 0.8;
            margin: 0;
            padding: 12px 0 0 0;
            position: relative;
        }

        @media (max-width: 768px) {
            .footer-content {
                padding: 30px 20px;
            }
            
            .demo-content h1 {
                font-size: 1.8rem;
                margin-bottom: 16px;
            }
            
            .demo-content p:first-of-type {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .demo-content p:last-of-type {
                font-size: 0.8rem !important;
            }
        }

        @media (max-width: 480px) {
            .footer-content {
                padding: 25px 15px;
            }
            
            .demo-content h1 {
                font-size: 1.6rem;
                letter-spacing: -0.3px;
            }
            
            .demo-content p:first-of-type {
                font-size: 0.85rem;
            }
            
            .demo-content p:last-of-type {
                font-size: 0.75rem !important;
                line-height: 1.3;
            }
        }

        /* --- COMPACT HEADER CONTROLS --- */
        .header-controls-expanded {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping onto new lines if space is constrained */
            justify-content: space-between; /* Spreads out filters and quick actions */
            align-items: center; /* Vertically aligns items in the middle */
            gap: 20px; /* Space between the two main compact sections */
            max-width: 1800px;
            margin: 0 auto;
            padding: 15px 40px; /* Reduced vertical padding for a more compact look */
            border-top: 1px solid var(--nav-border-primary);
            background: rgba(0,0,0,0.05); /* Subtle background */
            position: relative;
            z-index: 2;
        }

        .header-filters-compact,
        .header-quick-actions-compact {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allows items within these sections to wrap */
            gap: 15px; /* Space between filter/action items */
            /* Remove background, border, shadow from previous sections */
            /* background: none; */
            /* border: none; */
            /* box-shadow: none; */
            padding: 0; /* Remove padding as it's now handled by .header-controls-expanded */
        }

        /* Style the main text labels for "Filters:" and "Quick Actions:" */
        .header-filters-compact > label,
        .header-quick-actions-compact > span {
            font-weight: 600;
            color: var(--text-primary); /* Use primary text color for labels */
            font-size: 15px;
            white-space: nowrap; /* Prevent label from wrapping */
            flex-shrink: 0; /* Prevent labels from shrinking */
        }

        /* Styles for inline form groups (Category, Sort By) */
        .header-filters-compact .form-group-inline {
            display: flex;
            align-items: center;
            gap: 8px; /* Space between "Category:" label and dropdown */
            margin: 0; /* Remove default form-group margin */
        }

        .header-filters-compact .form-group-inline label {
            font-weight: 500; /* Slightly lighter weight for sub-labels */
            color: var(--text-secondary); /* Muted color for sub-labels */
            margin: 0; /* Remove default label margin */
            white-space: nowrap; /* Prevent sub-label from wrapping */
        }

        .header-filters-compact select {
            padding: 8px 12px; /* Adjusted padding for dropdowns */
            border-radius: 8px; /* Softer border radius */
            background: var(--nav-bg-tertiary); /* Input background */
            color: var(--nav-text-primary);
            border: 1px solid var(--nav-border-primary);
            font-size: 13px;
            min-width: 120px; /* Ensure dropdowns have a minimum width */
            max-width: 180px; /* Max width for readability */
        }

        /* Styles for compact buttons in Quick Actions */
        .header-quick-actions-compact .btn-compact {
            padding: 8px 12px; /* Smaller padding for compact buttons */
            font-size: 13px;
            border-radius: 8px; /* Match filter dropdowns */
            gap: 6px; /* Smaller gap between icon and text */
            min-width: unset; /* Allow buttons to size based on content */
            width: auto; /* Ensure width adjusts to content */
        }

        /* Ensure buttons don't take 100% width unless forced by wrap */
        .header-quick-actions-compact .btn {
            width: auto; /* Override previous 100% width for quick actions buttons */
            margin-bottom: 0; /* Remove bottom margin here */
        }

        /* --- Media Queries for responsiveness --- */

        @media (max-width: 992px) {
            .header-controls-expanded {
                flex-direction: column; /* Stack the entire control section vertically */
                align-items: flex-start; /* Align contents to the start */
                padding: 15px 20px; /* Adjust padding for smaller screens */
                gap: 15px; /* Space between stacked compact sections */
            }

            .header-filters-compact,
            .header-quick-actions-compact {
                width: 100%; /* Take full width when stacked */
                justify-content: flex-start; /* Align content to the start */
                flex-direction: column; /* Stack items within these sections */
                gap: 10px; /* Space between stacked items */
                align-items: flex-start; /* Align labels/inputs to start */
            }

            .header-filters-compact > label,
            .header-quick-actions-compact > span {
                width: 100%; /* Ensure main labels span full width */
                text-align: left; /* Align them left */
                margin-bottom: 5px; /* Add some space below labels */
            }

            .header-filters-compact .form-group-inline,
            .header-quick-actions-compact .btn-compact {
                width: 100%; /* Force filter dropdowns and buttons to take full width */
                justify-content: flex-start; /* Align content left */
            }
            
            .header-filters-compact select {
                width: 100%; /* Dropdowns take full width */
                min-width: unset; /* Remove min-width constraint */
            }
        }

        @media (max-width: 768px) {
            /* Adjustments for even smaller screens */
            .header-controls-expanded {
                padding: 10px 15px;
                gap: 10px;
            }
            .header-filters-compact > label,
            .header-quick-actions-compact > span {
                font-size: 14px;
            }
            .header-filters-compact select,
            .header-quick-actions-compact .btn-compact {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--nav-accent-success);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin: 30px 40px;
            width: calc(100% - 80px);
        }

        /* Main Content */
        .main-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box; 
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        

        .content-title {
            font-size: 28px; 
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }


        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow); 
        }

        .tools-list .tool-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
        }

        .tools-list .tool-header {
            width: 100%;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }

        .tool-header > div:first-child {
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0;
        }
        .tools-list .tool-title {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .tools-list .tool-url {
            font-size: 11px;
        }

        .tools-list .tool-actions {
            margin-left: auto;
            flex-shrink: 0;
        }

        .tools-list .tool-tags {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .tools-list .tool-tags .threat-level {
            margin-left: auto;
            float: none;
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-7px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .tool-card:hover::before {
            opacity: 1;
        }

        .tool-card.starred {
            border-color: var(--secondary);
        }

        .tool-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .tool-card.selected {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.05), transparent);
        }
        /* Style for shared highlight */
        .tool-card.shared-highlight {
            border-color: var(--primary); /* Highlight with primary color */
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.08), transparent);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }


        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top */
            margin-bottom: 15px;
            width: 100%; /* Ensure it takes full width of the card */
            flex-wrap: wrap; /* Allow header content to wrap if needed */
            gap: 10px; /* Space between the title/URL part and actions */
        }

        .tool-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* NEW: Allow elements within the title (checkbox, favicon, text) to wrap */
            min-width: 0; /* Ensures the title itself can shrink if necessary */
            word-break: break-word; /* NEW: Ensure long words break */
        }

        .tool-favicon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .tool-url {
            font-size: 0.8rem; /* Slightly smaller URL */
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .external-link-icon {
            color: var(--primary);
            font-size: 10px;
            opacity: 0.7;
        }

        .tool-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px; /* Smaller padding for action buttons */
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9rem; /* Slightly smaller icon size */
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary); /* Hover color for actions */
            transform: scale(1.15); /* Slightly more prominent icon scaling */
        }

        .action-btn.starred {
            color: var(--secondary);
        }

        .action-btn.pinned {
            color: var(--accent);
        }


        /* Bulk Actions */
        .bulk-actions {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow); /* Add shadow to bulk actions */
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-checkbox {
            margin-right: 10px;
        }

        .threat-high {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px; /* More padding */
            text-align: center;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-value {
            font-size: 3rem; /* Larger font size */
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px; /* Tighter spacing for numbers */
        }

        .analytics-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .analytics-list {
            list-style: none;
            padding: 0;
        }

        .analytics-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
        }

        .analytics-list li:last-child {
            border-bottom: none;
        }

        .analytics-list li span:first-child {
            color: var(--text-primary);
            font-weight: 500;
        }

        .analytics-list li span:last-child {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }


        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
                margin: 20px 20px;
                width: calc(100% - 40px);
                gap: 20px; 
            }

            .header-content, .stats-bar {
                padding: 15px 20px;
            }
            .main-nav-tabs { 
                padding: 8px 10px;
                gap: 5px;
            }
            .nav-tab {
                padding: 12px 14px;
                font-size: 0.85rem;
            }
            .search-container {
                min-width: 250px;
            }

            .main-content {
                padding: 20px;
            }
            /* ADD THIS FOR THE NEW HEADER SECTION */
            .header-controls-expanded {
                padding: 15px 20px;
                gap: 15px;
            }
            .header-filter-section, .header-quick-actions {
                min-width: 200px; /* Adjust min-width if needed for smaller screens */
                padding: 10px 15px;
            }
        }

        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                align-items: center;
                padding: 15px;
                gap: 15px;
            }
            .logo-and-title-container {
                justify-content: center;
                width: 100%; 
                margin-right: 0;
            }
            .controls {
                width: 100%;
                justify-content: center;
                margin-left: 0;
                order: 1;
            }
            .search-container {
                min-width: auto;
                width: 100%;
                max-width: 450px;
                flex-direction: row;
                padding: 8px;
            }
            .search-input {
                padding: 12px 40px 12px 15px;
                margin-bottom: 0;
            }
            #searchScopeSelect {
                margin-left: 10px;
                margin-top: 0; 
                width: auto;
            }

            .tools-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
                gap: 15px;
            }
            .tool-card {
                padding: 20px;
            }
            .tool-title {
                font-size: 1.05rem; 
            }
            .tool-url {
                font-size: 0.75rem; 
            }

            .pre-templates-container {
                grid-template-columns: 1fr; 
                gap: 20px;
            }
            .pre-templates-sidebar {
                position: static;
                margin-bottom: 0;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0; 
            }
            .dashboard {
                margin: 15px 10px;
                width: calc(100% - 20px);
                gap: 15px;
            }

            .header-content {
                flex-direction: row; 
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                gap: 10px; 
            }
            .logo-and-title-container {
                justify-content: flex-start; 
                width: auto; 
                flex-grow: 1; 
            }
            .header-text-group {
                display: none;
            }
            .controls {
                display: none; /* Hide desktop controls */
                order: unset; /* Reset order */
            }
            .mobile-menu-toggle {
                display: block; /* Show mobile menu toggle */
                order: 2; /* Ensure it's on the right */
            }
            .header-logo {
                height: 50px; /* Smaller logo */
            }

            .main-nav-tabs {
                padding: 4px; /* Even tighter padding for main nav */
                border-radius: 10px;
                margin: 0 10px; /* Match dashboard padding */
                flex-wrap: wrap; /* Allow tabs to wrap */
                justify-content: center; /* Center tabs when wrapped */
            }
            .nav-tab {
                padding: 8px 10px;
                font-size: 0.75rem;
                gap: 5px;
                flex-direction: column; /* Stack icon and text */
                text-align: center;
                min-width: 65px; /* Minimum width for tap target */
            }
            .nav-tab i {
                font-size: 0.9rem;
                margin-bottom: 2px;
            }
            .sub-nav-tabs {
                margin: 10px 0; /* Adjust margin for sub-nav tabs */
                padding: 3px;
                border-radius: 8px;
            }
            .sub-nav-tab {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-height: 32px;
            }

            .main-content {
                padding: 15px; /* Consistent padding */
            }
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .content-title {
                font-size: 24px;
                width: 100%; 
                text-align: center; /* Center align title */
            }
            .content-header .controls {
                display: flex; /* Re-show controls within content-header, but stack them */
                flex-direction: column;
                align-items: center;
                width: 100%;
                gap: 10px;
            }
            .content-header .btn {
                width: 100%; /* Make buttons full width */
                justify-content: center;
            }

            .tools-grid, .tools-list {
                grid-template-columns: 1fr; /* Single column on mobile */
                gap: 15px;
            }
            .tools-list .tool-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px; /* Gap between title/url and actions */
            }
            .tools-list .tool-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start; /* Align action buttons to left */
                flex-wrap: wrap; /* Allow action buttons to wrap */
                gap: 5px;
            }
            .tool-card {
                padding: 15px; /* Reduce card padding */
            }
            .tool-title {
                font-size: 15px;
            }
            .tool-url {
                font-size: 10px;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px;
            }
            .bulk-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .analytics-grid {
                grid-template-columns: 1fr; /* Stack analytics cards */
                gap: 15px;
            }
            .analytics-card {
                padding: 20px;
            }
            .analytics-value {
                font-size: 2.5rem; /* Smaller numbers */
            }
            .analytics-list li {
                font-size: 13px;
                padding: 8px 0;
            }

            .threat-item {
                padding: 15px;
                margin-bottom: 10px;
            }
            .threat-header h4 {
                font-size: 1.1em;
            }
            .threat-level {
                font-size: 0.7em;
                padding: 3px 8px;
            }

            .modal-content {
                padding: 25px; /* Reduce internal padding for modals */
                border-radius: 12px;
            }
            .form-group label {
                font-size: 0.9em;
                margin-bottom: 8px;
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px; /* Smaller input fields */
                font-size: 13px;
                border-radius: 8px;
            }
            .btn {
                padding: 10px 15px;
                font-size: 13px;
                border-radius: 10px;
            }
            .btn2 {
                padding: 10px 15px;
                font-size: 13px;
                border-radius: 10px;
            }

            .toast {
                max-width: calc(100% - 40px); /* Adjusted for padding */
                margin: 0 auto; /* Center toasts */
                text-align: center;
                right: auto; /* Remove right fixed position */
                left: 50%;
                transform: translateX(-50%);
            }

            /* Handbook & Notes Mobile adjustments */
            .handbook-container {
                grid-template-columns: 1fr; /* Sidebar stacks */
                gap: 0; /* Remove gap when stacked */
                margin: 0; /* Remove margin from container */
                width: 100%; 
            }
            .handbook-sidebar {
                position: fixed; /* Make sidebar fixed */
                left: -320px; /* Hide off-screen */
                top: 0;
                bottom: 0;
                width: 300px; /* Fixed width for mobile sidebar */
                z-index: 1000;
                border-radius: 0; /* No rounded corners on mobile sidebar */
                transition: left 0.3s ease;
                overflow-y: auto; /* Allow scrolling */
                background: var(--nav-bg-card); /* Use nav background for consistency */
                border-right: 1px solid var(--nav-border-primary); /* Add border to the right */
                box-shadow: 5px 0 15px rgba(0,0,0,0.3); /* Add shadow for open effect */
            }
            .handbook-sidebar.mobile-open {
                left: 0; /* Slide in */
            }
            .handbook-mobile-toggle {
                display: flex; /* Show mobile toggle */
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1001; /* Ensure it's above content */
                width: 50px;
                height: 50px;
                font-size: 24px;
                background: var(--primary);
                color: white;
                border-radius: 50%;
                justify-content: center;
                align-items: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            }
            /* Prevent body scroll when overlay active */
            body.handbook-overlay-active {
                overflow: hidden;
            }
            .handbook-content-container {
                padding: 15px; /* Adjust padding for mobile content */
                margin-top: 0; /* Remove top margin */
                width: 100%; 
            }
            .notes-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .notes-search-container {
                margin-left: 0;
                width: 100%;
                order: 1; /* Order search first */
            }
            .new-note-btn {
                width: 100%;
                justify-content: center;
                order: 3; /* Order button last */
            }
            #noteSortFilter {
                width: 100%;
                order: 2; /* Order sort filter second */
            }
            .notes-grid {
                grid-template-columns: 1fr;
            }
            .note-editor-actions {
                flex-direction: column;
                gap: 10px;
            }
            .formatting-toolbar {
                padding: 8px;
                flex-wrap: wrap; /* Allow toolbar buttons to wrap */
                justify-content: center;
                gap: 3px;
            }
            .formatting-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                margin: 10px 5px; /* Even tighter margins for very small screens */
                width: calc(100% - 10px);
                gap: 10px;
            }
            .header-content {
                padding: 8px 10px;
            }
            .header-logo {
                height: 40px; /* Smallest logo size */
            }
            .main-nav-tabs {
                margin: 0 5px;
                padding: 3px;
            }
            .nav-tab {
                padding: 6px 8px;
                font-size: 0.65rem;
                min-width: 60px;
            }
            .sub-nav-tabs {
                margin: 8px 0;
                padding: 2px;
            }
            .sub-nav-tab {
                padding: 4px 8px;
                font-size: 0.6rem;
                min-height: 25px;
            }
            .main-content {
                padding: 10px;
            }
            .content-title {
                font-size: 20px;
            }
            .tool-card {
                padding: 10px;
            }
            .tool-title {
                font-size: 14px;
            }
            .tool-url {
                font-size: 9px;
            }
            .tag {
                padding: 3px 8px;
                font-size: 0.7rem;
            }
            .modal-content {
                padding: 20px;
            }
            .form-group input, .form-group select, .form-group textarea {
                padding: 8px;
                font-size: 12px;
            }
            .btn, .btn2 {
                padding: 8px 12px;
                font-size: 12px;
            }
            .notes-empty-state, .empty-state {
                padding: 30px 10px;
            }
            .notes-empty-state h3, .empty-state h3 {
                font-size: 1.2em;
            }
            .notes-empty-state p, .empty-state p {
                font-size: 0.85em;
            }
            .notes-empty-state i, .empty-state i {
                font-size: 48px;
            }
            .theme-toggle, .handbook-mobile-toggle {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            #desktopRecommendationModal .modal-content {
                padding: 20px;
            }
            #desktopRecommendationModal h3 {
                font-size: 18px;
            }
            #desktopRecommendationModal p {
                font-size: 13px;
            }
            /* Dork assistant adjustments */
            .dork-subtab-content > div { /* Target the flex container */
                flex-direction: column; /* Stack columns */
            }
            .dork-subtab-content > div > div { /* Target the flex children (builder and preview) */
                width: 100%;
                max-width: none; /* Remove max-width constraint */
            }
            .pre-templates-sidebar .category-item {
                flex-direction: row; /* Keep items in a row */
                text-align: left;
                padding: 8px 10px;
                font-size: 0.8em;
            }
            .pre-templates-sidebar .category-item i {
                font-size: 1em;
                margin-right: 5px;
            }
            .pre-templates-sidebar .category-item span {
                flex-grow: 1;
            }
            .pre-templates-sidebar .category-item .template-count {
                font-size: 0.7em;
                padding: 2px 6px;
            }
            .dork-operator-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            #savedQueriesSearch, #preTemplateSearchInput {
                max-width: 100%; /* Allow search inputs to fill width */
                margin-right: 0 !important; /* Remove specific margin */
                margin-bottom: 10px; /* Add some space below */
            }
            .content-header .controls button { /* Target buttons in content header when stacked */
                margin-right: 0 !important;
                width: 100%;
            }

            /* Investigation Wall adjustments */
            .wall-header {
                padding: 1.5rem 1rem;
            }
            .section-title {
                font-size: clamp(1.8rem, 8vw, 3rem); /* Adjust font size range for smaller screens */
                margin-bottom: 0.8rem;
            }
            .section-subtitle {
                font-size: clamp(0.9rem, 3vw, 1.1rem);
                margin-top: 1rem;
            }
            .evidence-container {
                padding: 0 1rem;
            }
            .evidence-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .evidence-card {
                padding: 1.2rem;
                border-radius: 12px;
            }
            .card-icon {
                width: 40px;
                height: 40px;
                padding: 10px;
                margin-right: 0.8rem;
            }
            .card-title {
                font-size: 1rem;
            }
            .card-content {
                font-size: 0.9rem;
            }
            .highlight {
                font-size: 0.8rem;
                padding: 1px 6px;
            }

        }


        /* Modal and Form Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 15px; /* Add some padding to the modal container itself for small screens */
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            transition: background 0.3s ease, border-color 0.3s ease;
            position: relative; /* ADD THIS LINE if it's not already there */
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px; /* More space below label */
            font-weight: 600; /* Bolder labels */
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px; /* Larger input fields */
            border: 1px solid var(--border);
            border-radius: 10px; /* Match button rounding */
            background: var(--bg-tertiary); /* Lighter background for inputs */
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Subtle inner shadow */
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 4px rgba(0,0,0,0.1);
        }
        .form-group.metadata-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px; /* Smaller margin for repeated entries */
        }

        .form-group.metadata-entry input {
            flex: 1; /* Key and value inputs take equal space */
        }

        .form-group.metadata-entry .remove-metadata-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s ease;
        }

        .form-group.metadata-entry .remove-metadata-btn:hover {
            background: var(--primary-dark);
        }

        .add-metadata-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 5px;
        }

        .add-metadata-btn:hover {
            background: var(--primary-dark);
        }


        /* Toast Notifications Container */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002; /* Ensure it's above individual toasts */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between toasts */
            align-items: flex-end; /* Align toasts to the right */
        }

        /* Existing .toast styles remain the same, but remove fixed positioning, right, and top */
        .toast {
            /* position: fixed;  REMOVE THIS LINE */
            /* top: 20px;       REMOVE THIS LINE */
            /* right: 20px;     REMOVE THIS LINE */
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            /* NEW: Adjust width for better readability on smaller screens, keeping desktop reasonable */
            max-width: 350px;
            width: 100%; /* Take full width of max-width */
            box-sizing: border-box; /* Include padding/border in width calculation */
            text-align: left; /* Default text alignment */
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }
        .toast.info { /* For read-only banner */
            background: var(--primary-dark);
        }

        .toast-warning {
            background: var(--danger);
        }

        .toast-info { /* For read-only banner */
            background: var(--tab-color-yellow);
        }

        .toast-error {
            background: var(--warning);
        }

        @keyframes fadeIn { 
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px; /* More vertical padding */
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px dashed var(--border-light); /* Dashed border for a softer look */
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .empty-state i {
            font-size: 72px; /* Larger icon */
            margin-bottom: 20px;
            opacity: 0.2; /* Lighter opacity */
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tag {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 10px; /* More padding for tags */
            border-radius: 16px; /* More rounded */
            font-size: 0.75rem; /* Slightly smaller font */
            margin-right: 6px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .threat-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .threat-tags {
            margin-top: 10px;
        }

        .threat-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .threat-high {
            background: var(--danger);
            color: white;
        }
        .threat-medium {
            background: var(--warning);
            color: black;
        }
        .threat-low {
            background: var(--success);
            color: white;
        }

        .scan-progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .scan-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .scan-result:last-child {
            border-bottom: none;
        }

        .scan-result i {
            width: 20px;
        }

        /* Custom Tabs Tool Assignment */
        .custom-tab-assignment {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .custom-tab-assignment h4 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .custom-tab-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .custom-tab-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 8px; /* Slightly softer */
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid var(--border-light); /* More prominent default border */
            transition: all 0.2s ease;
        }

        .custom-tab-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .custom-tab-checkbox.checked {
            border-color: var(--primary);
            background: rgba(0, 123, 255, 0.15); /* Match new primary color */
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2);
        }

        /* Style for Icon picker */
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .icon-picker-item {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            border-radius: 6px; /* Slightly softer */
            cursor: pointer;
            border: 1px solid var(--border-light); /* Visible border */
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .icon-picker-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .icon-picker-item.selected {
            background: var(--primary); /* Use primary color */
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        /* Style for Color picker */
        .color-picker-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker-item {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-picker-item.selected {
            border-color: var(--text-primary); /* Border for selected color */
            box-shadow: 0 0 0 3px var(--primary-dark); /* Thicker, slightly darker glow */
        }

        /*---- Investigation Wall -------*/
        .investigation-wall {
            height: 100%;
            width: 100%;
            position: relative;
            background: 
                linear-gradient(135deg, var(--nav-bg-primary) 0%, var(--nav-bg-secondary) 100%);
            overflow: hidden;
            padding: 2rem 0;
        }

        /* Animated grid background */
        .wall-texture {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--nav-grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--nav-grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            opacity: 0.6;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Floating particles */
        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: var(--nav-accent-primary);
            border-radius: 50%;
            opacity: 0;
            animation: particleFloat 15s linear infinite;
        }

        @keyframes particleFloat {
            0% { 
                opacity: 0; 
                transform: translateY(100vh) scale(0);
            }
            10% { 
                opacity: 0.6; 
                transform: translateY(90vh) scale(1);
            }
            90% { 
                opacity: 0.6; 
                transform: translateY(-10vh) scale(1);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-20vh) scale(0);
            }
        }

        /* Enhanced header section */
        .wall-header {
            position: relative;
            text-align: center;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            z-index: 10;
        }

        .wall-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary),
                var(--nav-accent-success));
            opacity: 0.05;
            border-radius: 0 0 50px 50px;
        }

        .section-title {
            font-size: clamp(2rem, 6vw, 4rem);
            font-weight: 900;
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
            line-height: 1.1;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary));
            border-radius: 2px;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { box-shadow: 0 0 10px var(--nav-glow-primary); }
            100% { box-shadow: 0 0 30px var(--nav-glow-secondary); }
        }

        .section-subtitle {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            color: var(--nav-text-secondary);
            font-weight: 500;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--nav-bg-card);
            border: 1px solid var(--nav-border-primary);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--nav-accent-success);
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--nav-accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        /* Evidence grid */
        .evidence-container {
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            z-index: 5;
        }

        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            position: relative;
        }

        .evidence-card {
            background: var(--nav-bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--nav-border-primary);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            transform: perspective(1000px) rotateX(0deg) rotateY(0deg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 10px 25px var(--nav-shadow-light),
                0 20px 48px var(--nav-shadow-medium);
            overflow: hidden;
        }

        .evidence-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary),
                var(--nav-accent-success));
            border-radius: 20px 20px 0 0;
        }

        .evidence-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent, 
                rgba(255, 255, 255, 0.03), 
                transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
            opacity: 0;
        }

        .evidence-card:hover {
            transform: perspective(1000px) rotateX(2deg) rotateY(2deg) translateY(-10px);
            box-shadow: 
                0 20px 40px var(--nav-shadow-medium),
                0 30px 60px var(--nav-shadow-heavy),
                0 0 30px var(--nav-glow-primary);
            border-color: var(--nav-accent-primary);
        }

        .evidence-card:hover::after {
            opacity: 1;
            animation: shimmer 1.5s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            margin-right: 1rem;
            padding: 12px;
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary));
            border-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--nav-glow-primary);
            transition: all 0.3s ease;
        }

        .evidence-card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 24px var(--nav-glow-secondary);
        }

        .card-title {
            color: var(--nav-text-primary);
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-content {
            color: var(--nav-text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
            position: relative;
        }

        .highlight {
            background: linear-gradient(135deg, 
                var(--nav-accent-primary), 
                var(--nav-accent-secondary));
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px var(--nav-glow-primary);
            transition: all 0.3s ease;
        }

        .highlight:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--nav-glow-secondary);
        }

        /* Connecting lines animation */
        .connecting-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--nav-accent-primary), 
                transparent);
            animation: lineFlow 4s ease-in-out infinite;
            opacity: 0.3;
        }

        @keyframes lineFlow {
            0%, 100% { opacity: 0.1; transform: scaleX(0); }
            50% { opacity: 0.6; transform: scaleX(1); }
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--nav-bg-card);
            border: 1px solid var(--nav-border-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--nav-shadow-light);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 24px var(--nav-shadow-medium);
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .evidence-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
            }
            
            .wall-header {
                padding: 2rem 1rem;
            }
        }

        @media (max-width: 768px) {
            .investigation-wall {
                padding: 1rem 0;
            }
            
            .evidence-container {
                padding: 0 1rem;
            }
            
            .evidence-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .evidence-card {
                padding: 1.5rem;
                border-radius: 16px;
            }
            
            .wall-header {
                padding: 1.5rem 1rem;
                margin-bottom: 1rem;
            }
            
            .card-icon {
                width: 40px;
                height: 40px;
                padding: 10px;
            }
        }


        /* Special card categories */
        .evidence-card[data-category="search"] .card-icon {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }

        .evidence-card[data-category="social"] .card-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .evidence-card[data-category="documentation"] .card-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .evidence-card[data-category="digital"] .card-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .evidence-card[data-category="security"] .card-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .evidence-card[data-category="verification"] .card-icon {
            background: linear-gradient(135deg, #6366f1, #4338ca);
        }
        /*-------- End of Investigation Wall Styles --------*/


        /* Dork Assistant Styles */

        .dork-subtab-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
        }
        .dork-subtab-content .content-title {
            margin-top: 0; /* Adjust for subtab content header */
        }
        .dork-template-card, .saved-query-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dork-template-card:hover, .saved-query-card:hover {
            border-color: var(--primary);
        }
        .dork-template-card .template-header, .saved-query-card .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .dork-template-card .template-query, .saved-query-card .query-string {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
            word-break: break-all; /* Ensure long queries wrap */
        }
        .dork-template-card .template-description, .saved-query-card .query-description {
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .dork-template-card .template-actions, .saved-query-card .query-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .dork-template-card .template-engine, .saved-query-card .query-engine {
            font-size: 0.8em;
            background: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }
        .saved-query-tags .tag {
            font-size: 0.7em;
            padding: 2px 6px;
        }
        .pre-templates-container {
            display: grid;
            grid-template-columns: 280px 1fr; /* Fixed sidebar width, flexible main content */
            gap: 20px;
            height: 100%; /* Take full height of parent */
        }

        .pre-templates-sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            height: fit-content; /* Adjusts to content, but stays sticky */
            position: sticky; /* Makes it scroll with the main content */
            top: 120px; /* Adjust based on your header height */
            transition: all 0.3s ease;
        }

        .pre-templates-sidebar .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .pre-templates-sidebar .category-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .pre-templates-sidebar .category-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }
        .pre-templates-sidebar .category-item i {
            font-size: 1.1em;
        }
        .pre-templates-sidebar .category-item span {
            flex-grow: 1;
        }
        .pre-templates-sidebar .category-item .template-count {
            font-size: 0.8em;
            background: rgba(0,0,0,0.2); /* Darker background for contrast on active */
            padding: 3px 8px;
            border-radius: 10px;
        }
        .pre-templates-sidebar .category-item.active .template-count {
            background: rgba(255,255,255,0.2); /* Lighter for contrast on active */
        }

        .pre-templates-main {
            background: var(--bg-card); /* Match other main content areas */
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            box-sizing: border-box;
        }

        /* Responsive adjustments for pre-templates */
        @media (max-width: 992px) {
            .pre-templates-container {
                grid-template-columns: 1fr; /* Stack on smaller screens */
            }
            .pre-templates-sidebar {
                position: static; /* Remove sticky behavior when stacked */
                margin-bottom: 20px;
            }
        }

        .form-group-input { /* Reusing your existing input styles, but explicitly for select elements */
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }

        .form-group-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 4px rgba(0,0,0,0.1);
        }

        .dork-operator-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .dork-operator-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .dork-operator-btn:active {
            transform: translateY(0);
        }

        /* Adjustments for responsive layout */
        @media (max-width: 992px) {
            #dork-assistantTab > div {
                flex-direction: column;
            }
            #dork-assistantTab > div > div {
                flex: none;
                width: 100%;
            }
        }



        /* OSINT Handbook & Notes Styles */
        /* General Handbook Styles */
        .handbook-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            height: 100%;
            position: relative;
        }

        /* Handbook Sidebar */
        .handbook-sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            height: 100%;
            overflow-y: auto;
            transition: all 0.3s ease;
            position: sticky;
            top: 20px;
        }

        .handbook-search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .handbook-search {
            width: 100%;
            padding: 12px 20px 12px 40px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .handbook-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .handbook-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .handbook-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .handbook-nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .handbook-nav-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .handbook-category {
            margin-bottom: 10px;
        }

        .handbook-category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .handbook-category-header:hover {
            background: var(--bg-tertiary);
        }

        .handbook-category-header .category-toggle {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .handbook-category-header .category-toggle.rotate {
            transform: rotate(180deg);
        }

        .handbook-subcategories {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-left: 10px;
        }

        /* Handbook Content */
        .handbook-content-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }

        .handbook-content {
            max-width: 800px;
            /* Changed: Align to the left instead of centering */
            margin: 0; /* Remove auto margins to prevent centering */
            margin-left: 0; /* Explicitly align to the left */
            margin-right: auto; /* Allow auto margin on right for remaining space, keeping left fixed */
            line-height: 1.7;
        }

        .handbook-content h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 10px;
        }

        .handbook-content h3 {
            font-size: 22px;
            font-weight: 600;
            margin: 25px 0 15px;
            color: var(--text-primary);
        }

        .handbook-content p {
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .handbook-content ul, 
        .handbook-content ol {
            margin-bottom: 20px;
            margin-left: 25px;
            color: var(--text-secondary);
        }

        .handbook-content ul li, 
        .handbook-content ol li {
            margin-bottom: 8px;
        }

        .handbook-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .code-block {
            position: relative;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            border-left: 4px solid var(--primary);
        }

        .code-block pre {
            margin: 0;
            padding-right: 40px; /* Space for copy button */
        }

        .code-block code {
            color: var(--text-primary);
            display: block;
            white-space: pre;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .copy-btn:hover {
            background: var(--primary);
            color: white;
        }

        .tag-section {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .handbook-content .tag {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }


        /* Mobile sidebar toggle (hidden by default) */
        .handbook-mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px; /* Slightly larger for easier tap */
            height: 50px; /* Slightly larger for easier tap */
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            z-index: 1001; /* Ensure it's above other elements */
            cursor: pointer;
            display: flex; /* Always display as flex to properly center icon */
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        /* Add this new class at the top level of your CSS, not inside a media query */
        body.handbook-overlay-active {
            overflow: hidden; /* Prevent scrolling of content behind modal/sidebar */
        }

        .handbook-mobile-toggle:hover {
            transform: scale(1.05);
        }

        /* Notes Styles */
        .notes-container {
            height: 100%;
            position: relative;
        }

        .notes-list-view, .note-editor-view {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 25px;
            height: 100%;
            overflow-y: auto;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap; /* Allow items to wrap */
            gap: 15px; /* Add gap between items when wrapped */
        }

        .notes-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .notes-search-container {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
            margin-left: 20px;
        }

        .notes-search {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .notes-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .notes-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .new-note-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .new-note-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .note-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .note-card:hover::before {
            opacity: 1;
        }

        .note-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .note-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.3;
        }

        .note-actions {
            display: flex;
            gap: 8px;
            opacity: 0.2;
            transition: opacity 0.2s ease;
        }

        .note-card:hover .note-actions {
            opacity: 1;
        }

        /* NEW: Styling for pinned notes */
        .note-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
            order: -1; /* Pinned items appear first in flex/grid */
        }

        .note-action-btn.pinned {
            color: var(--accent); /* Color for active pin button */
        }

        .note-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .note-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .note-action-btn.delete-note:hover {
            color: var(--danger);
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
            max-height: 120px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
        }

        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-muted);
        }

        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .note-footer .tag {
            padding: 2px 8px;
            font-size: 11px;
        }

        .notes-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px dashed var(--border-light);
            margin-top: 20px;
        }

        .notes-empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Note Editor View */
        .note-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .note-editor-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .note-editor-actions {
            display: flex;
            gap: 10px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .save-note-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .save-note-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .edit-note-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            color: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-note-btn:hover {
            background: var(--primary);
            color: white;
        }

        .note-title-input {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .note-title-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .note-title-input:read-only {
            border-color: transparent;
            background: transparent;
            padding-left: 0;
            padding-right: 0;
        }

        .formatting-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .formatting-btn {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .formatting-btn:hover {
            background: var(--primary);
            color: white;
        }

        .formatting-btn.has-dropdown {
            width: auto;
            padding: 0 12px;
        }

        .note-content-editor {
            min-height: 300px;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow-y: auto;
        }

        .note-content-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .note-content-editor[contenteditable="false"] {
            border-color: transparent;
            background: transparent;
            padding-left: 0;
            padding-right: 0;
        }

        .note-content-editor h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 25px 0 15px;
            color: var(--text-primary);
        }

        .note-content-editor h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 20px 0 15px;
            color: var(--text-primary);
        }

        .note-content-editor h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0 10px;
            color: var(--text-primary);
        }

        .note-content-editor p {
            margin-bottom: 15px;
        }

        .note-content-editor ul, 
        .note-content-editor ol {
            margin-bottom: 15px;
            margin-left: 25px;
        }

        .note-content-editor li {
            margin-bottom: 5px;
        }

        .note-content-editor a {
            color: var(--primary);
            text-decoration: underline;
        }

        .note-tags-section {
            margin-top: 25px;
        }

        .note-tags-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .note-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .note-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 20px;
            font-size: 14px;
        }

        .remove-tag-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-tag-btn:hover {
            color: var(--danger);
        }

        .tag-input-container {
            display: flex;
            gap: 10px;
        }

        .note-tags-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .note-tags-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .add-tag-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-tag-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .handbook-container {
                grid-template-columns: 280px 1fr;
                gap: 20px;
            }
            
            .handbook-content-container {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .handbook-container {
                grid-template-columns: 1fr;
            }
            
            .handbook-sidebar {
                position: fixed;
                left: -320px;
                top: 0;
                bottom: 0;
                width: 300px; /* Adjusted width for mobile sidebar */
                z-index: 1000;
                border-radius: 0;
                transition: left 0.3s ease;
            }
            
            .handbook-sidebar.mobile-open {
                left: 0;
                box-shadow: var(--shadow-lg); /* Add shadow to open sidebar */
            }
                    
            .handbook-mobile-toggle {
                display: flex;
                z-index: 1001;
            }
            
            .notes-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .handbook-content-container {
                padding: 15px;
            }
            
            .handbook-content h2 {
                font-size: 24px;
            }
            
            .handbook-content h3 {
                font-size: 20px;
            }
            
            .note-editor-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .formatting-toolbar {
                padding: 8px;
                gap: 3px;
            }
            
            .formatting-btn {
                width: 30px;
                height: 30px;
            }
        }
        /* Handbook Controls */
        .handbook-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-light);
        }

        .handbook-btn {
            padding: 8px 15px;
            font-size: 14px;
        }

        /* Search Enhancements */
        .handbook-search-container {
            position: relative;
        }

        .handbook-search {
            padding-right: 40px; /* Space for the clear button/icon */
        }

        .handbook-search-icon {
            transition: all 0.2s ease;
        }

        .handbook-search-icon:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        .handbook-no-results {
            padding: 15px;
            text-align: center;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .handbook-no-results i {
            font-size: 24px;
            opacity: 0.5;
        }

        /* Search highlights */
        .search-highlight {
            background-color: rgba(255, 170, 0, 0.3);
            border-radius: 3px;
            padding: 2px 0;
        }

        mark.search-highlight {
            background-color: rgba(255, 170, 0, 0.3);
            color: inherit;
        }

        .handbook-nav-item.search-highlight {
            background-color: rgba(0, 123, 255, 0.1);
            border-left: 3px solid var(--primary);
        }

        /* Section Editor */
        #section-editor-modal .modal-content {
            max-width: 800px;
        }

        #section-editor-content {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Icon picker tweaks */
        .icon-picker-grid {
            margin-top: 10px;
            max-height: 180px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .handbook-controls {
                flex-wrap: wrap;
            }
            
            .handbook-btn {
                flex-grow: 1;
            }
        }

        /* Animation for new/edit controls */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .handbook-controls {
            animation: fadeIn 0.3s ease-out;
        }

        /* NEW: Desktop Recommendation Modal Specific Styling */
        #desktopRecommendationModal .modal-content {
            max-width: 550px; /* Make this modal slightly narrower */
            text-align: center;
            padding: 30px; /* Adjust padding as needed */
        }

        #desktopRecommendationModal h3 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #desktopRecommendationModal p {
            font-size: 15px;
        }

        #desktopRecommendationModal .btn {
            margin-top: 10px;
            width: auto; /* Allow button to size itself */
            justify-content: center; /* Center content within the button */
        }

        /* Timeline Specific Styles */
        #timeline-events-display {
            margin-top: 20px;
            display: flex;
            flex-direction: column; /* Events stack vertically */
            gap: 15px; /* Space between events */
            position: relative; /* For the vertical line */
            padding-left: 30px; /* Space for the timeline line and markers */
            box-sizing: border-box;
        }

        #timeline-events-display::before {
            content: '';
            position: absolute;
            left: 15px; /* Position of the vertical line */
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-light); /* Thin vertical line */
            z-index: 0;
        }

        .timeline-event-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            position: relative;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            margin-left: 20px; /* Offset to make space for the marker */
        }

        .timeline-event-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .timeline-event-card::before {
            content: '';
            position: absolute;
            left: -35px; /* Position of the marker relative to the card */
            top: 20px;
            width: 15px;
            height: 15px;
            background: var(--primary); /* Default marker color */
            border-radius: 50%;
            border: 3px solid var(--bg-card); /* Border around the marker */
            z-index: 1;
            box-shadow: 0 0 0 2px var(--primary-shadow-color);
        }

        .timeline-event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .timeline-event-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
        }

        .timeline-event-timestamp {
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .timeline-event-notes {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .timeline-event-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 10px;
            border-top: 1px solid var(--border-light);
            padding-top: 10px;
        }

        .timeline-event-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timeline-event-meta i {
            color: var(--primary);
        }

        /* Category/Confidence Specific Colors & Icons for Markers */
        .timeline-event-card[data-confidence="low"]::before { background: #6c757d; box-shadow: 0 0 0 2px rgba(108, 117, 125, 0.3); } /* Grey */
        .timeline-event-card[data-confidence="medium"]::before { background: #ffc107; box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3); } /* Yellow */
        .timeline-event-card[data-confidence="high"]::before { background: #28a745; box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3); } /* Green */
        .timeline-event-card[data-confidence="critical"]::before { background: #dc3545; box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.3); } /* Red */

        /* Optional: Category specific marker colors (override confidence if desired) */
        .timeline-event-card[data-category="phishing"]::before { background: #e74c3c; }
        .timeline-event-card[data-category="initial_access"]::before { background: #3498db; }
        .timeline-event-card[data-category="lateral_movement"]::before { background: #9b59b6; }
        .timeline-event-card[data-category="exfiltration"]::before { background: #f1c40f; }
        .timeline-event-card[data-category="malware_delivery"]::before { background: #e67e22; }
        .timeline-event-card[data-category="remediation"]::before { background: #2ecc71; }
        /* Add more category specific colors as needed */

        .timeline-event-actions {
            display: flex;
            gap: 5px;
        }

        .timeline-event-actions .action-btn {
            padding: 5px 8px; /* Adjust button size */
            font-size: 0.8rem;
        }
        /* Ensure custom vault buttons stay in one row */
        #customVaultButtonsRow {
            display: flex;
            flex-wrap: nowrap; /* CRITICAL: Prevent wrapping */
            justify-content: flex-end; /* Align to the right */
            align-items: center;
            gap: 10px; /* Space between buttons */
            width: 100%; /* Ensure it uses full available width */
            overflow-x: auto; /* Allow horizontal scrolling if buttons absolutely cannot fit (fallback) */
            padding-bottom: 5px; /* Add slight padding in case of scrollbar */
            box-sizing: border-box; /* Include padding in width */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Further reduce button size specifically within this row if needed for very small screens */
        @media (max-width: 480px) {
            #customVaultButtonsRow .btn {
                padding: 8px 10px; /* Even smaller padding */
                font-size: 11px; /* Even smaller font size */
                white-space: nowrap; /* Prevent button text from wrapping */
                flex-shrink: 0; /* Prevent buttons from shrinking too much (optional, can remove if you want them to compress) */
            }
        }

        /* --- New Case Studies Tab Styles --- */
        /* Main tab icon (using a new one) */
        .nav-tab[data-tab="case-studies"].active::before {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); /* A vibrant purple for case studies */
        }

        /* Case Study Grid/List Styles (similar to tools but distinct) */
        .case-studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Slightly smaller min-width for more cards */
            gap: 20px;
            width: 100%;
        }

        .case-studies-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .case-study-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer; /* Indicates clickable */
        }

        .case-studies-list .case-study-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
        }

        .case-study-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6c5ce7, #a29bfe); /* Purple gradient */
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .case-study-card:hover {
            transform: translateY(-7px);
            box-shadow: var(--shadow-lg);
            border-color: #6c5ce7; /* Match hover border to new tab color */
        }

        .case-study-card:hover::before {
            opacity: 1;
        }

        /* Status highlights for case studies (e.g., solved, ongoing) */
        .case-study-card.solved {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), transparent);
        }

        .case-study-card.ongoing {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.05), transparent);
        }

        .case-study-card.starred {
            border-color: var(--secondary);
        }

        .case-study-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .case-study-card.selected {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.05), transparent);
        }

        .case-study-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            width: 100%;
            flex-wrap: wrap;
            gap: 10px;
        }

        .case-study-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            min-width: 0;
            word-break: break-word;
        }

        .case-study-icon {
            font-size: 20px;
            color: var(--primary); /* Use primary for icon color */
            flex-shrink: 0;
        }

        .case-study-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .case-study-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0; /* Prevent actions from shrinking */
        }

        /* Reusing existing action-btn styles */

        .case-study-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
            max-height: 90px; /* Limit height for preview */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Show maximum 3 lines */
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }

        .case-study-tags {
            margin-top: 10px;
        }

        /* Reusing existing tag styles */

        /* Case Study Detail Modal Styles (similar to notes/editor) */
        #caseStudyDetailModal .modal-content {
            max-width: 850px; /* Wider modal for detailed content */
            padding: 30px;
        }

        #caseStudyDetailModal .case-study-detail-header {
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }

        #caseStudyDetailModal .detail-title {
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); /* Purple gradient for modal title */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        #caseStudyDetailModal .detail-meta {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        #caseStudyDetailModal .detail-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #caseStudyDetailModal .detail-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 50vh; /* Limit height for scrollable content */
            overflow-y: auto;
            color: var(--text-primary);
            line-height: 1.7;
        }

        #caseStudyDetailModal .detail-content h3 {
            font-size: 1.3em;
            color: var(--primary); /* Primary blue for subheadings */
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: 5px;
        }

        #caseStudyDetailModal .detail-content ul,
        #caseStudyDetailModal .detail-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        #caseStudyDetailModal .detail-content li {
            margin-bottom: 5px;
        }

        #caseStudyDetailModal .detail-tags {
            margin-top: 15px;
            text-align: center; /* Center tags in detail view */
        }

        /* Responsive Adjustments for Case Studies */
        @media (max-width: 768px) {
            .case-studies-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
                gap: 15px;
            }

            .case-studies-list .case-study-card {
                padding: 10px 15px;
            }

            .case-study-title {
                font-size: 1rem;
                flex-direction: column; /* Stack icon and text vertically if needed */
                align-items: flex-start;
            }
            .case-study-title .case-study-icon {
                margin-bottom: 5px;
            }

            .case-study-meta {
                font-size: 0.75rem;
                flex-wrap: wrap; /* Allow meta items to wrap */
                gap: 5px;
            }

            .case-study-description {
                font-size: 13px;
                max-height: 75px; /* Adjust preview height */
                -webkit-line-clamp: 3;
            }

            #caseStudyDetailModal .modal-content {
                padding: 20px;
            }

            #caseStudyDetailModal .detail-title {
                font-size: 1.5em;
            }

            #caseStudyDetailModal .detail-meta {
                font-size: 0.8em;
                gap: 10px;
            }

            #caseStudyDetailModal .detail-content {
                padding: 15px;
                font-size: 14px;
            }

            #caseStudyDetailModal .detail-content h3 {
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            .case-study-card {
                padding: 10px;
            }
            .case-study-title {
                font-size: 0.9rem;
            }
            .case-study-meta {
                font-size: 0.7rem;
            }
            .case-study-actions {
                gap: 3px;
            }
            .action-btn {
                padding: 4px;
                font-size: 0.8rem;
            }
        }

        /* --- New Close Modal Button Styles --- */
        .close-modal-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--bg-tertiary); /* Give it a distinct background */
            border: 1px solid var(--border); /* Add a subtle border */
            border-radius: 50%; /* Make it round */
            width: 32px; /* Fixed width */
            height: 32px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px; /* Larger 'x' */
            color: var(--text-primary); /* Ensure contrast with primary text color */
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10; /* Ensure it's above other content in the modal */
            box-shadow: var(--shadow-light); /* Subtle shadow */
        }

        .close-modal-btn:hover {
            background: var(--danger); /* Red background on hover for "close" action */
            color: white; /* White 'x' on hover */
            transform: scale(1.1); /* Slightly enlarge on hover */
            border-color: var(--danger);
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3); /* More pronounced shadow */
        }

        /* Threat Hunting Tab Colors (New) */
        .nav-tab[data-tab="threat-hunting"].active::before {
            background: linear-gradient(135deg, #10b981, #059669); /* A vibrant green for threat hunting */
        }

        /* Threat Hunting Sub-tab Content */
        .th-subtab-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
        }

        /* Script Card Styles (Reusing .tool-card as base) */
        .script-card { /* Can be used as a modifier if needed, or simply let .tool-card styles apply */
            /* Many styles inherited from .tool-card, but define specific if needed */
        }

        .script-card .script-language {
            font-size: 0.7em;
            background: var(--accent); /* Green accent for language */
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            margin-left: auto; /* Push to right */
            flex-shrink: 0;
        }

        /* Script Code Display Modal */
        #scriptCodeDisplayModal .modal-content {
            max-width: 800px;
            padding: 30px;
        }

        #scriptCodeDisplayModal pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        #scriptCodeDisplayModal .copy-code-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        #scriptCodeDisplayModal .copy-code-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--primary-shadow-color-hover);
        }

        /* Responsive adjustments for Threat Hunting Toolkit */
        @media (max-width: 768px) {
            .th-subtab-content {
                padding: 15px;
            }
            .script-card {
                padding: 15px;
            }
            .script-card .tool-header { /* Reusing tool-header for consistency */
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .script-card .tool-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 5px;
            }
            .script-card .script-language {
                margin-left: 0; /* Reset alignment */
                margin-top: 5px; /* Add space below name/title */
            }

            /* Code preview in modal */
            #scriptCodeDisplayModal pre {
                font-size: 12px;
                padding: 10px;
            }
            #scriptCodeDisplayModal .modal-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .th-subtab-content {
                padding: 10px;
            }
            /* Hide some elements if necessary for very small screens */
            .script-card .script-language {
                font-size: 0.6em;
                padding: 2px 6px;
            }
        }
        
        /* Add this CSS rule to your existing <style> block */
            .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5); /* Semi-transparent black overlay */
            z-index: 999; /* Below the sidebar but above other content */
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* Allows clicks to pass through by default */
        }

        .mobile-sidebar-menu.active + .mobile-menu-overlay {
            opacity: 1;
            pointer-events: auto; /* Enable clicks on the overlay when menu is active */
        }


 /* New: Styles for the Random Discovery section layouts */

/* Basic styling for the main section container */
.discovery-section {
    width: 100%;
    max-width: 1800px; /* Match header/footer max-width for consistency */
    margin: 30px auto; /* Centered with top/bottom margin */
    padding: 20px 40px; /* Match padding of main content/header */
    box-sizing: border-box; /* Ensure padding is included in width */
    background: var(--bg-card); /* Card background for this section */
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: var(--shadow);
    text-align: center; /* Center content within the section */
    display: flex; /* Make it a flex container to center its own content */
    flex-direction: column;
    align-items: center; /* Center horizontally */
    justify-content: center; /* Center vertically */
    gap: 20px; /* Space between header/content and button */
}

/* Styles for the inner random discovery container. This is #randomDiscovery */
/* It will now receive layout classes (e.g., .two-rows) */
.random-display {
    width: 100%; /* Take full width of parent section */
    display: flex;
    flex-direction: column; /* Default to column, overridden by layout classes */
    align-items: center;
    justify-content: center;
    gap: 20px; /* Space between header and content wrapper */
    background: none; /* No extra background */
    border: none; /* No extra border */
    box-shadow: none; /* No extra shadow */
    padding: 0;
    min-height: auto;
}

/* Header for the random discovery section */
.random-display .random-display-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--text-primary);
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-light);
    width: 100%; /* Ensure header spans full width for border */
    max-width: 600px; /* Constrain header width if desired */
    margin-bottom: 20px; /* Space below header */
}

.random-display .random-display-header .header-icon {
    font-size: 1.8em;
    color: var(--primary);
    text-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
}

.random-display .random-display-header .header-text {
    font-size: 1.2em;
    margin: 0;
    font-family: 'Outfit', sans-serif;
    letter-spacing: -0.5px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Wrapper for the actual content cards. This is #randomItemDisplay */
.random-content-wrapper {
    width: 100%;
    /* Default is flex column, overridden by layout classes on its parent (#randomDiscovery) */
}

/* Base style for individual content cards */
.random-content-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 15px;
    box-shadow: var(--shadow-light);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    min-height: 150px; /* Ensure cards have a minimum height */
}

.random-content-card .card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
}

.random-content-card .card-header i {
    font-size: 1.5em;
    color: var(--primary);
}

.random-content-card .card-header img.tool-favicon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
}

.random-content-card .card-title {
    font-size: 1.1em;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.random-content-card .card-description {
    font-size: 0.9em;
    color: var(--text-secondary);
    line-height: 1.4;
    flex-grow: 1; /* Allow description to take available space */
}

.random-content-card .card-link {
    margin-top: 10px;
    padding: 8px 15px;
    font-size: 0.85em;
    font-weight: 500;
    border-radius: 8px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

/* Specific styling for different content types (for visual cues) */
.random-tool-card {
    border-left: 4px solid var(--primary);
}

.random-tip-card {
    border-left: 4px solid var(--accent);
}

.random-case-study-card {
    border-left: 4px solid #6c5ce7; /* Match case study tab color */
}

/* Placeholder card for when content is not available */
.random-content-card.placeholder {
    border: 1px dashed var(--border-light);
    color: var(--text-muted);
}
.random-content-card.placeholder i {
    color: var(--text-muted);
    opacity: 0.5;
}

/* Layout specific styles applied to .random-display (#randomDiscovery) */

/* Single centered item layout */
.random-display.single-centered .random-content-wrapper {
    max-width: 500px; /* Constrain width of the single item */
    margin: 0 auto;
    display: flex; /* Ensure it's a flex container for its single child */
    flex-direction: column;
    align-items: center;
}
.random-display.single-centered .random-content-wrapper .random-content-card {
    width: 100%; /* Ensure card takes full width within its wrapper */
}


/* Two columns layout (side-by-side) */
.random-display.two-columns .random-content-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two equal columns */
    gap: 20px; /* Space between columns */
    max-width: 900px; /* Max width for two columns */
    margin: 0 auto; /* Center the grid */
}
.random-display.two-columns .random-content-wrapper .random-content-card {
    width: 100%; /* Fill grid cell */
}


/* --- FIXED: Two rows layout (one large card, two smaller stacked on the right) --- */
/* Target the random-content-wrapper (#randomItemDisplay) as the grid container when its parent (#randomDiscovery) has 'two-rows' class */
.random-display.two-rows .random-content-wrapper {
    display: grid;
    /* Define 2 columns: first is 1 fraction unit, second is 1 fraction unit */
    grid-template-columns: 1fr 1fr;
    /* Define 2 rows: both automatically sized to content */
    grid-template-rows: auto auto;
    /* Define named areas: 'card1' spans both rows of the first column */
    grid-template-areas: 
        "card1 card2"
        "card1 card3";
    gap: 20px; /* Space between grid items */
    max-width: 900px; /* Max width for this layout */
    margin: 0 auto; /* Center the grid within its wrapper */
    align-items: stretch; /* Stretch items to fill grid cells vertically */
}

/* Explicitly assign grid areas to the direct child cards based on their order */
.random-display.two-rows .random-content-wrapper > .random-content-card:nth-child(1) {
    grid-area: card1; /* The big card on the left */
    min-height: 320px; /* Ensure it's tall enough to contain the other two, adjust as needed */
}
.random-display.two-rows .random-content-wrapper > .random-content-card:nth-child(2) {
    grid-area: card2; /* Top right card */
}
.random-display.two-rows .random-content-wrapper > .random-content-card:nth-child(3) {
    grid-area: card3; /* Bottom right card */
}


/* Media queries for responsiveness for the random discovery section */
@media (max-width: 992px) {
    .discovery-section {
        padding: 15px 20px;
        margin: 20px auto;
    }

    /* On smaller screens, stack all layout types into a single column */
    .random-display.single-centered .random-content-wrapper,
    .random-display.two-columns .random-content-wrapper,
    .random-display.two-rows .random-content-wrapper {
        grid-template-columns: 1fr; /* Stack into a single column */
        grid-template-rows: auto; /* Remove explicit row sizing */
        grid-template-areas: none; /* Clear grid areas for stacking */
        max-width: 500px; /* Adjust max width for single column */
        display: flex; /* Change back to flex for simpler stacking */
        flex-direction: column;
        align-items: center; /* Center items in column */
    }
    /* Reset specific card height if it was set for spanning rows */
    .random-display .random-content-wrapper .random-content-card { /* Target all cards within dynamic area */
        min-height: 150px; /* Revert to base min-height */
    }
}

@media (max-width: 480px) {
    .discovery-section {
        padding: 10px 15px;
        margin: 15px auto;
    }

    .random-display .random-display-header {
        font-size: 0.9em;
        gap: 8px;
        margin-bottom: 10px;
    }

    .random-display .random-display-header .header-icon {
        font-size: 1.5em;
    }

    .random-display .random-display-header .header-text {
        font-size: 1.1em;
    }

    .random-content-card {
        padding: 10px;
        min-height: 120px;
    }

    .random-content-card .card-title {
        font-size: 1em;
    }

    .random-content-card .card-description {
        font-size: 0.85em;
    }

    .random-content-card .card-link {
        padding: 6px 12px;
        font-size: 0.8em;
    }
}
        
    </style>
</head>
    <body>
        <header>
            <div class="header-content">
                <div class="logo-and-title-container">
                    <div class="header-logo">
                        <img src="./favicon.png" alt="OSINTVault Logo" class="osintvault-logo-img">
                    </div>
                    <div class="header-text-group">
                        <div class="header-title">
                            OSINTVault
                        </div>
                        <span class="header-tagline">Carry your investigations everywhere</span>
                    </div>
                </div>
        
                <div class="mobile-menu-toggle">☰</div>
                <div class="controls">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search intelligence tools, techniques, indicators...">
                        <i class="fas fa-search search-icon"></i>
                        <select id="searchScopeSelect">
                            <option value="currentTab">Current Tab</option>
                            <option value="allVault">All Intelligence Vault</option>
                            <option value="allData">All Data</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" id="exportBtn">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn btn-secondary" id="shareOptionsBtn">
                        <i class="fas fa-share-alt"></i>
                        Share
                    </button>
                    <button class="btn btn-secondary" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <div class="header-controls-expanded">
                <div class="header-filters-compact">
                    <label for="categoryFilter">Filters:</label>
                    <div class="form-group-inline">
                        <label for="categoryFilter">Category:</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="form-group-inline">
                        <label for="sortFilter">Sort By:</label>
                        <select id="sortFilter">
                            <option value="name">Name (A-Z)</option>
                            <option value="recent">Recently Added</option>
                            <option value="popular">Most Used</option>
                        </select>
                    </div>
                </div>

                <div class="header-quick-actions-compact">
                    <span>Quick Actions:</span>
                    <button class="btn btn-secondary btn-compact" id="showAllBtn" title="Show All Entries">
                        <i class="fas fa-eye"></i> Show All
                    </button>
                    <button class="btn btn-secondary btn-compact" id="pinAllBtn" title="Show Pinned Entries">
                        <i class="fas fa-thumbtack"></i> Pinned
                    </button>
                    <button class="btn btn-secondary btn-compact" id="starAllBtn" title="Show Starred Entries">
                        <i class="fas fa-star"></i> Starred
                    </button>
                    <button class="btn btn-success btn-compact" id="reportBtn" title="Generate Report">
                        <i class="fas fa-file-alt"></i> Report
                    </button>
                </div>
            </div>
        </header>

        <div id="mobileSidebarMenu" class="mobile-sidebar-menu">
            <button class="close-menu-btn">&times;</button>
            <div class="mobile-menu-content"></div>
        </div>

        <div class="dashboard">
            <div class="main-content">
                <div class="nav-tabs main-nav-tabs">
                    <button class="nav-tab active" data-tab="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button class="nav-tab" data-tab="intelligence-vault">
                        <i class="fas fa-tools"></i>
                        Intelligence Vault
                    </button>
                    <button class="nav-tab" data-tab="custom-tabs">
                        <i class="fas fa-layer-group"></i>
                        Multi-Vault
                    </button>
                    <button class="nav-tab" data-tab="dork-assistant">
                        <i class="fas fa-terminal"></i> 
                        Dork Assistant
                    </button>
                    <button class="nav-tab" data-tab="case-studies">
                        <i class="fas fa-microscope"></i>
                        Case Studies
                    </button>
                    <button class="nav-tab" data-tab="handbook">
                        <i class="fas fa-book"></i> 
                        OSINT Handbook & Notes
                    </button>
                    <button class="nav-tab" data-tab="threat-hunting">
                        <i class="fas fa-crosshairs"></i>
                        Threat Hunting
                    </button>
                    <button class="nav-tab" data-tab="timeline">
                        <i class="fas fa-stream"></i> 
                        TraceLink
                    </button>
                    <button class="nav-tab" data-tab="threats">
                        <i class="fas fa-exclamation-triangle"></i>
                        Threat Intel
                    </button>
                </div>

                <div class="bulk-actions" id="bulkActions">
                    <span>Selected: <span id="selectedCount">0</span> tools</span>
                    <button class="btn btn-secondary" id="bulkStarBtn">
                        <i class="fas fa-star"></i>
                        Star/Unstar Selected
                    </button>
                    <button class="btn btn-secondary" id="bulkPinBtn">
                        <i class="fas fa-thumbtack"></i>
                        Pin/Unpin Selected
                    </button>
                    <button class="btn btn-danger" id="bulkDeleteBtn">
                        <i class="fas fa-trash"></i>
                        Delete Selected
                    </button>
                </div>

                <div class="tab-content" id="toolsTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Tools Arsenal</h2>
                        <div class="controls">
                            <button class="btn btn-secondary" id="viewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                    
                    <div class="tools-grid" id="toolsGrid">
                        </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-search"></i>
                        <h3>No Tools Found</h3>
                        <p>No intelligence tools match your current search criteria.</p>
                        <button class="btn btn-primary" id="clearFiltersBtn">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <div class="tab-content active" id="dashboardTab">
                    <div class="content-header">
                        <h2 class="content-title">Dashboard Overview</h2>
                    </div>
                
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="totalToolsCount">0</div>
                            <div>Total Entries</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="activeVaultsCount">0</div>
                            <div>Active Custom Vaults</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="usedToolsTodayCount">0</div>
                            <div>Entries Used Today</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="notesCount">0</div>
                            <div>Total Notes</div>
                        </div>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 30px;">
                        <h4 style="margin-bottom: 20px;">Overall OSINT Metrics</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px;">
                                <canvas id="entriesByTypeChart"></canvas>
                            </div>
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px;">
                                <canvas id="usageTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 30px;">
                        <h4 style="margin-bottom: 20px;">Vault Content Distribution</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px;">
                                <canvas id="topCategoriesChart"></canvas>
                            </div>
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px;">
                                <canvas id="pinnedStarredDonutChart"></canvas>
                            </div>
                        </div>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 30px;">
                        <h4 style="margin-bottom: 20px;">Vault Growth & Health</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px;">
                                <canvas id="entryGrowthOverTimeChart"></canvas>
                            </div>
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px;">
                                <canvas id="taggingOverviewChart"></canvas>
                            </div>
                        </div>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 20px;">
                        <h4>Starred & Pinned Breakdown by Type</h4>
                        <ul class="analytics-list" id="starredPinnedBreakdownList">
                            </ul>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 20px;">
                        <h4>Intelligence Vault Summary (Tools)</h4>
                        <ul class="analytics-list" id="intelligenceVaultSummaryList">
                            <li><span>Total Tools:</span> <span class="stat-value" id="intelVaultTotalTools">0</span></li>
                            <li><span>Starred Tools:</span> <span class="stat-value" id="intelVaultStarredTools">0</span></li>
                            <li><span>Pinned Tools:</span> <span class="stat-value" id="intelVaultPinnedTools">0</span></li>
                            <li><span>Tool Categories:</span> <span class="stat-value" id="intelVaultCategoriesCount">0</span></li>
                        </ul>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 20px;">
                        <h4>Custom Vaults Summary</h4>
                        <ul class="analytics-list" id="customVaultsSummaryList">
                            <li><span>Total Custom Vaults:</span> <span class="stat-value" id="customVaultsTotal">0</span></li>
                            <li><span>Total Entries in Custom Vaults:</span> <span class="stat-value" id="customVaultsTotalEntries">0</span></li>
                            <li><span>Avg. Entries per Custom Vault:</span> <span class="stat-value" id="customVaultsAvgEntries">0</span></li>
                            <div class="analytics-card" style="flex: 1; min-width: 300px; height: 300px; margin-top: 20px;">
                                <canvas id="entriesPerCustomVaultChart"></canvas>
                            </div>
                        </ul>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 20px;">
                        <h4>Notes & Dork Assistant Summary</h4>
                        <ul class="analytics-list" id="notesDorkSummaryList">
                            <li><span>Total Notes:</span> <span class="stat-value" id="notesSummaryTotal">0</span></li>
                            <li><span>Pinned Notes:</span> <span class="stat-value" id="notesSummaryPinned">0</span></li>
                            <li><span>Total Saved Dork Queries:</span> <span class="stat-value" id="dorksSummaryTotal">0</span></li>
                            <li><span>Pre-Templates Available:</span> <span class="stat-value" id="dorksSummaryTemplates">0</span></li>
                        </ul>
                    </div>
                
                    <div class="analytics-section" style="margin-top: 20px;">
                        <h4>Top 5 Most Used Entries</h4>
                        <ul class="analytics-list" id="mostUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noMostUsedTools" style="display:none; padding:20px;">
                            <p>No usage data available yet.</p>
                        </div>
                    </div>
                
                    <div class="analytics-section">
                        <h4>Entries Never Used</h4>
                        <ul class="analytics-list" id="neverUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noNeverUsedTools" style="display:none; padding:20px;">
                            <p>All entries have been used at least once!</p>
                        </div>
                    </div>
                
                    <div class="analytics-section">
                        <h4>Entries Added Per Week</h4>
                        <ul class="analytics-list" id="toolsAddedPerWeekList">
                            </ul>
                        <div class="empty-state" id="noToolsAdded" style="display:none; padding:20px;">
                            <p>No entries added recently.</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="threatsTab">
                    <div class="content-header">
                        <h2 class="content-title">Threat Intelligence Feed</h2>
                        <button class="btn btn-primary" id="refreshThreatsBtn">
                            <i class="fas fa-sync"></i>
                            Refresh Feed
                        </button>
                    </div>
                    
                    <div id="threatsList">
                        </div>
                </div>

                <div class="tab-content active" id="intelligence-vaultTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Vault (OSINT Tools)</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="addToolBtnIntelligenceVault">
                                <i class="fas fa-plus-circle"></i>
                                Add New Tool
                            </button>
                            <button class="btn btn-secondary" id="vaultViewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                
                    <div class="nav-tabs" id="intelligenceVaultParentTabs" style="margin-top: 20px;">
                        </div>
                
                    <div class="sub-nav-tabs" id="intelligenceVaultChildTabs" style="display: none; margin-top: 15px;">
                        </div>
                
                    <div class="tools-grid" id="intelligenceVaultEntries" style="margin-top: 20px;">
                        </div>

                    <div class="empty-state" id="emptyCustomTabState" style="display: none;">
                        </div>
                
                    <div class="empty-state" id="emptyIntelligenceVaultState" style="display: none;">
                        <i class="fas fa-database"></i>
                        <h3>No Tools Found in This Category</h3>
                        <p>No OSINT tools match your current criteria in this category.</p>
                        <button class="btn2 btn-primary" id="addToolBtnEmptyState">
                            Add New Tool
                        </button>
                    </div>
                </div>


                <div class="tab-content" id="custom-tabsTab">
                    <div class="content-header">
                        <h2 class="content-title">Multi-Vault: Your Investigations</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="createSubTabBtn">
                                <i class="fas fa-plus"></i>
                                Create Custom Vault
                            </button>
                            <button class="btn btn-secondary" id="editSubTabBtn" style="display: none;">
                                <i class="fas fa-edit"></i>
                                Edit Vault
                            </button>
                            <button class="btn btn-danger" id="deleteSubTabBtn" style="display: none;">
                                <i class="fas fa-trash"></i>
                                Delete Vault
                            </button>
                            <button class="btn btn-secondary" id="exportSubTabBtn" style="display: none;">
                                <i class="fas fa-download"></i>
                                Export Vault
                            </button>
                        </div>
                    </div>

                    <div class="sub-nav-tabs" id="customSubTabs">
                    </div>

                    <div id="customVaultButtonsRow" style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-success" id="addEntryBtnCustomVault">
                            <i class="fas fa-plus-circle"></i>
                            Add New Entry
                        </button>
                        <button class="btn btn-secondary" id="customVaultTimelineBtn">
                            <i class="fas fa-stream"></i>
                            Vault Timeline
                        </button>
                        <button class="btn btn-secondary" id="customVaultViewToggle" title="Switched to List View">
                            <i class="fas fa-list"></i>
                            List View
                        </button>
                    </div>

                    <div class="nav-tabs" id="customVaultEntryParentTabs" style="margin-top: 20px; display: none;">
                        </div>
                
                    <div class="sub-nav-tabs" id="customVaultEntryChildTabs" style="margin-top: 15px; display: none;">
                        </div>

                    <div class="tools-grid" id="customTabToolsGrid" style="margin-top: 20px;">
                        </div>

                    <div id="customTabTimelineDisplay" style="display: none; margin-top: 20px;">
                        </div>

                    <div class="empty-state" id="emptyCustomVaultTimelineState" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <h3>No Events in this Vault</h3>
                        <p>Add entries to this custom vault to see them on the timeline!</p>
                    </div>
                    <div class="empty-state" id="emptyCustomTabState" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Custom Vault Yet</h3>
                        <p>Create your first custom vault to organize your investigations!</p>
                        <button class="btn2 btn-primary" id="createSubTabBtnEmptyState">
                            Create Custom Vault
                        </button>
                    </div>
                    <div class="empty-state" id="emptyCurrentCustomTabState" style="display: none;">
                        <i class="fas fa-clipboard"></i>
                        <h3>No Entries in this Custom Vault</h3>
                        <p>Add tools or collected intelligence to this vault using the "Add New Entry" button.</p>
                    </div>
                </div>

                <div class="tab-content" id="handbookTab">

                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab handbook-subtab active" data-subtab="handbook">
                            <i class="fas fa-book"></i> OSINT Handbook
                        </button>
                        <button class="sub-nav-tab handbook-subtab" data-subtab="notes">
                            <i class="fas fa-sticky-note"></i> My Notes
                        </button>
                    </div>

                    <div class="handbook-subtab-content" id="handbook-content" style="display: block;">
                        <div class="handbook-container">
                            <div class="handbook-sidebar" id="handbook-sidebar">
                                <div class="handbook-search-container">
                                    <input type="text" id="handbook-search" class="handbook-search" placeholder="Search handbook...">
                                    <i class="fas fa-search handbook-search-icon"></i>
                                </div>
                                </div>
                            
                            <div class="handbook-content-container">
                                <div class="handbook-content" id="handbook-article-area"> </div>
                            </div>
                        </div>
                        
                        <button id="handbook-mobile-toggle" class="handbook-mobile-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    
                    <div class="handbook-subtab-content" id="notes-content" style="display: none;">
                        <div class="notes-container">
                            <div id="notes-list-view" class="notes-list-view">
                                <div class="notes-header">
                                    <h2 class="notes-title">My Notes</h2>
                                    <div class="notes-search-container">
                                        <input type="text" id="search-notes" class="notes-search" placeholder="Search notes...">
                                        <i class="fas fa-search notes-search-icon"></i>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="noteSortFilter" class="sr-only">Sort Notes</label>
                                        <select id="noteSortFilter" style="padding: 10px 12px; border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);">
                                            <option value="updated_desc">Last Updated (Newest)</option>
                                            <option value="updated_asc">Last Updated (Oldest)</option>
                                            <option value="created_desc">Created (Newest)</option>
                                            <option value="created_asc">Created (Oldest)</option>
                                            <option value="title_asc">Title (A-Z)</option>
                                            <option value="title_desc">Title (Z-A)</option>
                                        </select>
                                    </div>
                                    <button id="new-note-btn" class="new-note-btn">
                                        <i class="fas fa-plus"></i> New Note
                                    </button>
                                </div>
                                
                                <div id="notes-list"></div>
                            </div>
                            
                            <div id="note-editor-view" class="note-editor-view" style="display: none;">
                                <div class="note-editor-header">
                                    <h2 class="note-editor-title">Edit Note</h2>
                                    <div class="note-editor-actions">
                                        <button id="back-to-notes-btn" class="back-btn">
                                            <i class="fas fa-arrow-left"></i> Back to Notes
                                        </button>
                                        <button id="edit-note-btn" class="edit-note-btn" style="display: none;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button id="cancel-edit-note-btn" class="btn btn-secondary" style="display: none;">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                        <button id="save-note-btn" class="save-note-btn">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                    </div>
                                </div>
                                
                                <input type="text" id="note-title-input" class="note-title-input" placeholder="Note Title" maxlength="70">
                                
                                <div id="formatting-toolbar" class="formatting-toolbar">
                                    <button class="formatting-btn" data-command="bold" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="italic" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="underline" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="strikeThrough" title="Strikethrough">
                                        <i class="fas fa-strikethrough"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h1" title="Heading 1">
                                        <i class="fas fa-heading"></i>1
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                                        <i class="fas fa-heading"></i>2
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                                        <i class="fas fa-heading"></i>3
                                    </button>
                                    <button class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="createLink" title="Insert Link">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyLeft" title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyCenter" title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyRight" title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                                
                                <div id="note-content-editor" class="note-content-editor" contenteditable="true"></div>
                                
                                <div class="note-tags-section">
                                    <h3 class="note-tags-header">Tags</h3>
                                    <div id="note-tags-container" class="note-tags-container">
                                        </div>
                                    <div id="tag-input-container" class="tag-input-container">
                                        <input type="text" id="note-tags-input" class="note-tags-input" placeholder="Add a tag...">
                                        <button id="add-tag-btn" class="add-tag-btn">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="dork-assistantTab">
                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab dork-subtab active" data-dork-subtab="query-playground">
                            <i class="fas fa-hammer"></i> Query Playground
                        </button>
                        <button class="sub-nav-tab dork-subtab" data-dork-subtab="pre-templates">
                            <i class="fas fa-list-alt"></i> Pre-Templates
                        </button>
                        <button class="sub-nav-tab dork-subtab" data-dork-subtab="saved-queries">
                            <i class="fas fa-save"></i> Saved Queries
                        </button>
                    </div>

                    <div class="dork-subtab-content" id="query-playground-content" style="display: block; margin-top: 20px;">
                        <div class="content-header">
                            <h2 class="content-title">Query Playground</h2>
                            <div class="controls">
                                <button class="btn btn-secondary" id="clearDorkBuilderBtn">
                                    <i class="fas fa-eraser"></i> Clear Builder
                                </button>
                                <button class="btn btn-primary" id="executeDorkBtn">
                                    <i class="fas fa-play"></i> Execute Query
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: var(--shadow);">
                                <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-cogs"></i> Builder Options</h4>
                                <div class="form-group">
                                    <label for="dorkEngineSelect">Target Search Engine</label>
                                    <select id="dorkEngineSelect" class="form-group-input">
                                        <option value="google">Google</option>
                                        <option value="duckduckgo">DuckDuckGo</option>
                                        <option value="bing">Bing</option>
                                        <option value="yandex">Yandex</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Keywords / Phrases (separated by comma)</label>
                                    <input type="text" id="dorkKeywords" placeholder="e.g., 'john doe', 'confidential report'">
                                </div>

                                <div style="margin-top: 20px;">
                                    <h5 style="color: var(--text-primary); margin-bottom: 10px;">Operators</h5>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="site:" title="Search within a specific website.">site:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="filetype:" title="Search for specific file types (e.g., pdf, docx, xls).">filetype:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="intitle:" title="Search for terms in the page title.">intitle:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="inurl:" title="Search for terms in the URL.">inurl:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="intext:" title="Search for terms within the page text.">intext:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="related:" title="Find sites related to a given URL.">related:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="cache:" title="Show the cached version of a page.">cache:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="AROUND()" title="Find terms within a certain proximity (e.g., term1 AROUND(5) term2).">AROUND()</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="OR" title="Boolean OR operator.">OR</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="AND" title="Boolean AND operator.">AND</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="-" title="Exclude a term.">-</button>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-top: 20px;">
                                    <label>Additional Custom Operators / Terms</label>
                                    <textarea id="dorkCustomInput" rows="4" placeholder="Add custom operators or full dork segments here. Example: inurl:/admin/ &quot;login&quot;"></textarea>
                                </div>
                                <button class="btn btn-success" id="saveCurrentDorkBtn" style="width: 100%; margin-top: 20px;">
                                    <i class="fas fa-save"></i> Save Current Query
                                </button>
                            </div>

                            <div style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: var(--shadow);">
                                <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-eye"></i> Live Query Preview</h4>
                                <textarea id="dorkQueryPreview" rows="12" readonly style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: vertical;"></textarea>

                                <div style="margin-top: 20px;">
                                    <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-exchange-alt"></i> Convert Query</h4>
                                    <div class="form-group">
                                        <label for="conversionTarget">Convert to (Shodan/Censys)</label>
                                        <select id="conversionTarget" class="form-group-input">
                                            <option value="">Select Target</option>
                                            <option value="shodan">Shodan</option>
                                            <option value="censys">Censys</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-secondary" id="convertDorkBtn" style="width: 100%; margin-bottom: 10px;">Convert & Preview</button>
                                    <textarea id="convertedDorkPreview" rows="4" readonly style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: vertical; display: none;"></textarea>
                                    <button class="btn btn-primary" id="executeConvertedDorkBtn" style="width: 100%; margin-top: 10px; display: none;">
                                        <i class="fas fa-play"></i> Execute Converted Query
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dork-subtab-content" id="pre-templates-content" style="display: none; margin-top: 20px;">
                        <div class="pre-templates-container">
                            <div class="pre-templates-sidebar">
                                <h3 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-folder-open"></i> Categories</h3>
                                <div id="preTemplateCategoriesList">
                                    </div>
                                <div class="empty-state" id="preTemplateCategoriesEmptyState" style="display: none; padding: 15px; margin-top: 15px;">
                                    <i class="fas fa-info-circle" style="font-size: 24px;"></i>
                                    <p style="font-size: 0.9em;">No categories available.</p>
                                </div>
                            </div>

                            <div class="pre-templates-main">
                                <div class="content-header">
                                    <h2 class="content-title" id="currentTemplateCategoryTitle">All Templates</h2>
                                    <div class="controls">
                                        <input type="text" id="preTemplateSearchInput" class="search-input" placeholder="Search templates..." style="max-width: 300px; margin-right: 10px;">
                                        <button class="btn btn-secondary" id="clearPreTemplateSearch">
                                            <i class="fas fa-times"></i> Clear Search
                                        </button>
                                    </div>
                                </div>
                                <div id="dorkTemplatesList" class="tools-grid">
                                    </div>
                                <div class="empty-state" id="preTemplatesEmptyState" style="display: none;">
                                    <i class="fas fa-clipboard-list"></i>
                                    <h3>No Templates Found</h3>
                                    <p>Adjust your search or select another category.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dork-subtab-content" id="saved-queries-content" style="display: none; margin-top: 20px;">
                        <div class="content-header">
                            <h2 class="content-title">My Saved Dork Queries</h2>
                            <div class="controls">
                                <input type="text" id="savedQueriesSearch" class="search-input" placeholder="Search saved queries..." style="max-width: 300px; margin-right: 10px;">
                                <button class="btn btn-secondary" id="clearSavedQueriesSearch">
                                    <i class="fas fa-times"></i> Clear Search
                                </button>
                            </div>
                        </div>
                        <div id="savedQueriesList" class="tools-grid">
                            </div>
                        <div class="empty-state" id="savedQueriesEmptyState" style="display: block;">
                            <i class="fas fa-bookmark"></i>
                            <h3>No Saved Queries Yet</h3>
                            <p>Save your favorite dork queries from the Query Playground!</p>
                        </div>
                    </div>

                    <div class="modal" id="saveDorkQueryModal">
                        <div class="modal-content">
                            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-save"></i> Save Dork Query</h3>
                            <form id="saveDorkQueryForm">
                                <div class="form-group">
                                    <label for="savedQueryName">Query Name</label>
                                    <input type="text" id="savedQueryName" required placeholder="e.g., Exposed PDF Reports for Acme Corp">
                                </div>
                                <div class="form-group">
                                    <label for="savedQueryDescription">Description (Optional)</label>
                                    <textarea id="savedQueryDescription" rows="3" placeholder="Brief description of what this query targets or finds."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="savedQueryTags">Tags (comma separated)</label>
                                    <input type="text" id="savedQueryTags" placeholder="e.g., recon, filetype, google">
                                </div>
                                <div class="form-group">
                                    <label>Generated Query</label>
                                    <textarea id="savedQueryGenerated" rows="4" readonly style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="savedQueryEngine">Target Engine</label>
                                    <input type="text" id="savedQueryEngine" readonly class="form-group-input" style="background: var(--bg-tertiary); color: var(--text-primary);">
                                </div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                    <button type="button" class="btn btn-secondary" id="cancelSaveDorkQuery">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Query</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="modal" id="editExecuteTemplateModal">
                        <div class="modal-content">
                            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-edit"></i> Edit & Execute Template</h3>
                            <form id="editExecuteTemplateForm">
                                <input type="hidden" id="editExecuteTemplateId">

                                <div class="form-group">
                                    <label for="editExecuteTemplateName">Template Name</label>
                                    <input type="text" id="editExecuteTemplateName" readonly style="background: var(--bg-tertiary); color: var(--text-primary);">
                                </div>
                                <div class="form-group">
                                    <label for="editExecuteTemplateQuery">Query to Edit</label>
                                    <textarea id="editExecuteTemplateQuery" rows="6" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: vertical;" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editExecuteTemplateEngine">Target Engine</label>
                                    <select id="editExecuteTemplateEngine" class="form-group-input">
                                        <option value="google">Google</option>
                                        <option value="duckduckgo">DuckDuckGo</option>
                                        <option value="bing">Bing</option>
                                        <option value="yandex">Yandex</option>
                                        <option value="shodan">Shodan</option>
                                        <option value="censys">Censys</option>
                                    </select>
                                </div>

                                <div id="editExecuteConversionSection" style="display: none; margin-top: 15px; border: 1px solid var(--border); border-radius: 8px; padding: 15px; background: var(--bg-tertiary);">
                                    <p style="margin-bottom: 10px; color: var(--text-primary);">
                                        The selected engine is Shodan or Censys. Click below to convert your query to the appropriate syntax.
                                    </p>
                                    <button type="button" class="btn btn-secondary btn-sm" id="performEditExecuteConversionBtn" style="width: 100%;">
                                        <i class="fas fa-magic"></i> Convert Query to Shodan/Censys
                                    </button>
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                    <button type="button" class="btn btn-secondary" id="cancelEditExecuteTemplate">Cancel</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-play"></i> Execute Query
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="modal" id="dorkWarningModal">
                        <div class="modal-content">
                            <h3 style="margin-bottom: 20px; color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Query Engine Mismatch Warning</h3>
                            <p id="dorkWarningMessage" style="margin-bottom: 25px; color: var(--text-primary); line-height: 1.6;">
                                </p>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" id="cancelDorkWarning">Cancel</button>
                                <button type="button" class="btn btn-warning" id="convertAndGoToPlayground">
                                    <i class="fas fa-magic"></i> Convert Query Here
                                </button>
                                <button type="button" class="btn btn-primary" id="continueDorkExecution">
                                    <i class="fas fa-play"></i> Continue Anyway
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="timelineTab">
                    <div class="content-header">
                        <h2 class="content-title">Investigation Timeline</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="addTimelineEventBtn">
                                <i class="fas fa-plus-circle"></i> Add Event
                            </button>
                            <button class="btn btn-secondary" id="exportTimelineBtn">
                                <i class="fas fa-download"></i> Export Timeline
                            </button>
                            <button class="btn btn-secondary" id="importTimelineBtn">
                                <i class="fas fa-upload"></i> Import Timeline
                            </button>
                        </div>
                    </div>

                    <div id="timeline-events-display">
                        <div class="empty-state" id="emptyTimelineState" style="display: none;">
                            <i class="fas fa-clock"></i>
                            <h3>No Events Yet</h3>
                            <p>Start by adding your first investigation event!</p>
                            <button class="btn2 btn-primary" id="addEventBtnEmptyState">
                                Add First Event
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="case-studiesTab">
                    <div class="content-header">
                        <h2 class="content-title">Cyber Investigation Case Studies</h2>
                        <div class="controls">
                            <input type="text" id="caseStudySearchInput" class="search-input" placeholder="Search case studies..." style="max-width: 300px; margin-right: 10px;">
                            <select id="caseStudyFilterSelect" class="form-group-input" style="max-width: 150px; margin-right: 10px;">
                                <option value="">All Types</option>
                                <option value="ransomware">Ransomware</option>
                                <option value="phishing">Phishing</option>
                                <option value="insider-threat">Insider Threat</option>
                                <option value="data-breach">Data Breach</option>
                                <option value="apt">APT Activity</option>
                                <option value="ddos">DDoS Attack</option>
                                <option value="malware">Malware Analysis</option>
                                <option value="fraud">Fraud</option>
                                <option value="other">Other</option>
                            </select>
                            <button class="btn btn-primary" id="addCaseStudyBtn">
                                <i class="fas fa-plus-circle"></i> Add Case Study
                            </button>
                        </div>
                    </div>

                    <div class="case-studies-grid" id="caseStudiesGrid">
                        </div>

                    <div class="empty-state" id="emptyCaseStudiesState" style="display: none;">
                        <i class="fas fa-book-open"></i>
                        <h3>No Case Studies Found</h3>
                        <p>No cyber investigation case studies match your current criteria.</p>
                        <button class="btn btn-primary" id="addCaseStudyEmptyStateBtn">
                            <i class="fas fa-plus"></i> Add First Case Study
                        </button>
                    </div>
                </div>

                <div class="tab-content" id="threat-huntingTab">
                    <div class="content-header">
                        <h2 class="content-title">Cyber Threat Hunting Toolkit</h2>
                        <div class="controls">
                            <input type="text" id="scriptSearchInput" class="search-input" placeholder="Search scripts..." style="max-width: 300px; margin-right: 10px;">
                            <select id="scriptLanguageFilter" class="form-group-input" style="max-width: 150px; margin-right: 10px;">
                                <option value="">All Languages</option>
                            </select>
                            <button class="btn btn-primary" id="addScriptBtn">
                                <i class="fas fa-plus-circle"></i> Add New Script
                            </button>
                        </div>
                    </div>

                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab th-subtab active" data-th-subtab="script-library">
                            <i class="fas fa-code"></i> Script Library
                        </button>
                        <button class="sub-nav-tab th-subtab" data-th-subtab="dashboards">
                            <i class="fas fa-chart-bar"></i> Dashboards
                        </button>
                        <button class="sub-nav-tab th-subtab" data-th-subtab="playbooks">
                            <i class="fas fa-book-open"></i> Playbooks
                        </button>
                    </div>

                    <div class="th-subtab-content" id="script-library-content" style="display: block; margin-top: 20px;">
                        <div class="tools-grid" id="scriptLibraryGrid">
                            </div>
                        <div class="empty-state" id="emptyScriptLibraryState" style="display: none;">
                            <i class="fas fa-code"></i>
                            <h3>No Scripts Found</h3>
                            <p>Add your first threat hunting script to get started!</p>
                            <button class="btn btn-primary" id="addScriptEmptyStateBtn">
                                <i class="fas fa-plus"></i> Add First Script
                            </button>
                        </div>
                    </div>

                    <div class="th-subtab-content" id="dashboards-content" style="display: none; margin-top: 20px;">
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <h3>Dashboards (Coming Soon)</h3>
                            <p>This section will feature interactive dashboards for threat hunting, such as visualizing common attack patterns or network anomalies (requires external services or more complex client-side charting).</p>
                        </div>
                    </div>

                    <div class="th-subtab-content" id="playbooks-content" style="display: none; margin-top: 20px;">
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <h3>Hunting Playbooks (Coming Soon)</h3>
                            <p>A collection of step-by-step guides for various threat hunting scenarios, outlining techniques, tools, and expected outcomes.</p>
                        </div>
                    </div>
                </div>


                <div class="modal" id="addEventModal">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Timeline Event</h3>
                        <form id="addEventForm">
                            <input type="hidden" id="editEventId">
                            <div class="form-group">
                                <label for="eventTimestamp">Timestamp</label>
                                <input type="datetime-local" id="eventTimestamp" required>
                            </div>
                            <div class="form-group">
                                <label for="eventTitle">Title</label>
                                <input type="text" id="eventTitle" maxlength="100" placeholder="e.g., Phishing email received" required>
                            </div>
                            <div class="form-group">
                                <label for="eventCategory">Category</label>
                                <select id="eventCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="phishing">Phishing</option>
                                    <option value="initial_access">Initial Access</option>
                                    <option value="lateral_movement">Lateral Movement</option>
                                    <option value="exfiltration">Data Exfiltration</option>
                                    <option value="command_control">Command & Control</option>
                                    <option value="reconnaissance">Reconnaissance</option>
                                    <option value="malware_delivery">Malware Delivery</option>
                                    <option value="persistence">Persistence</option>
                                    <option value="privilege_escalation">Privilege Escalation</option>
                                    <option value="defense_evasion">Defense Evasion</option>
                                    <option value="credential_access">Credential Access</option>
                                    <option value="discovery">Discovery</option>
                                    <option value="collection">Collection</option>
                                    <option value="impact">Impact</option>
                                    <option value="remediation">Remediation</option>
                                    <option value="fraud">Financial Fraud</option>
                                    <option value="insider_threat">Insider Threat</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="eventNotes">Notes</label>
                                <textarea id="eventNotes" rows="4" placeholder="Detailed notes about the event, observations, etc."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="eventConfidence">Confidence / Severity</label>
                                <select id="eventConfidence" required>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="eventEvidence">Evidence Link / Reference</label>
                                <input type="text" id="eventEvidence" placeholder="URL, file hash, log entry ID, etc.">
                            </div>
                            <div class="form-group">
                                <label for="eventActor">Actor (Optional)</label>
                                <input type="text" id="eventActor" placeholder="e.g., Attacker, Victim, APT28, Employee X">
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" id="cancelAddEvent">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="saveEventBtn">Add Event</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="modal" id="importTimelineModal">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-upload"></i> Import Timeline</h3>
                        <p style="margin-bottom: 15px; color: var(--text-primary);">
                            Upload a JSON file containing timeline data.
                        </p>
                        <div class="form-group">
                            <label for="importTimelineFile">Choose JSON File</label>
                            <input type="file" id="importTimelineFile" accept=".json" required>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" id="cancelImportTimeline">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmImportTimeline">Import</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <section class="investigation-wall">
            <div class="wall-texture"></div>
            <div class="floating-particles" id="particles"></div>
            <div class="connecting-lines" id="connecting-lines"></div>
    
            <div class="wall-header">
                <h1 class="section-title">
                    OSINT Investigation Hub
                </h1>
                <p class="section-subtitle">
                    Intelligence Gathering & Analysis Techniques
                </p>
            </div>
    
            <div class="evidence-container">
                <div class="evidence-grid">
                    <div class="evidence-card" data-category="search">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="card-title">Advanced Search Techniques</div>
                        </div>
                        <div class="card-content">
                            Master <span class="highlight">Google Dorks</span> with operators like site:, filetype:, and intitle:. Use <span class="highlight">Boolean logic</span> with AND, OR, NOT. Combine with quotation marks for exact phrase matching and minus operator for exclusions.
                        </div>
                    </div>
    
                    <div class="evidence-card" data-category="social">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="card-title">Social Media Intelligence</div>
                        </div>
                        <div class="card-content">
                            Extract <span class="highlight">EXIF metadata</span> from images. Perform reverse image searches across platforms. Track <span class="highlight">username patterns</span> and cross-reference profile information for digital footprint mapping.
                        </div>
                    </div>
    
                    <div class="evidence-card" data-category="documentation">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-file-shield"></i>
                            </div>
                            <div class="card-title">Evidence Documentation</div>
                        </div>
                        <div class="card-content">
                            Create <span class="highlight">timestamped screenshots</span> with metadata. Use archive.org for historical data. Maintain detailed <span class="highlight">chain of custody</span> documentation for legal admissibility.
                        </div>
                    </div>
    
                    <div class="evidence-card" data-category="digital">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-fingerprint"></i>
                            </div>
                            <div class="card-title">Digital Footprint Analysis</div>
                        </div>
                        <div class="card-content">
                            Analyze <span class="highlight">WHOIS records</span> and DNS data. Use Shodan for IoT device discovery. Examine <span class="highlight">SSL certificates</span> and email headers for routing intelligence and infrastructure mapping.
                        </div>
                    </div>
    
                    <div class="evidence-card" data-category="security">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-user-secret"></i>
                            </div>
                            <div class="card-title">Operational Security</div>
                        </div>
                        <div class="card-content">
                            Use <span class="highlight">VPN + Tor</span> for anonymity layers. Create isolated investigation personas. Always use <span class="highlight">burner accounts</span> and clean browser sessions for operational integrity.
                        </div>
                    </div>
    
                    <div class="evidence-card" data-category="verification">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-shield-check"></i>
                            </div>
                            <div class="card-title">Information Verification</div>
                        </div>
                        <div class="card-content">
                            Implement <span class="highlight">multi-source verification</span> protocols. Use geolocation tools and timestamp analysis. Detect <span class="highlight">deepfakes</span> and manipulated media through technical analysis.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="modal" id="desktopRecommendationModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: var(--warning);"><i class="fas fa-desktop"></i> Attention: Desktop Recommended</h3>
                <p style="margin-bottom: 15px; color: var(--text-primary);">
                    OSINTVault is primarily designed for desktop use to provide the best experience and access to all features. For optimal functionality, please access this tool on a larger screen.
                </p>
                <p style="margin-bottom: 25px; color: var(--text-secondary);">
                    You can still proceed, but some options may not be fully visible or functional on smaller screens.
                </p>
                <div style="display: flex; justify-content: flex-end;">
                    <button type="button" class="btn btn-primary" id="continueAnywayBtn">
                        <i class="fas fa-arrow-right"></i> Continue Anyway
                    </button>
                </div>
            </div>
        </div>


        <div class="modal" id="addToolOnlyModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Tool</h3>
                <form id="addToolOnlyForm">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolOnlyName" name="toolOnlyName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolOnlyUrl" name="toolOnlyUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolOnlyCategory" required>
                            <option value="">Select Category</option>
                            </select>
                        <input type="text" id="newToolOnlyCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolOnlyDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolOnlyTags" placeholder="osint, investigation, cybersecurity">
                    </div>

                    <div class="custom-tab-assignment" id="intelligenceVaultCategoriesAssignmentAddTool">
                        <h4>Add to Intelligence Vault Categories</h4>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">Select one or more intelligence categories for this tool.</p>
                    
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div style="position: relative;">
                                <input type="text" id="intelligenceVaultCategorySearch" class="search-input" placeholder="Search categories..." style="padding-right: 40px;">
                                <i class="fas fa-search search-icon" style="right: 15px;"></i>
                            </div>
                        </div>
                    
                        <div class="custom-tab-checkboxes-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                            <div class="custom-tab-checkboxes" id="intelligenceVaultCategoriesCheckboxesAddTool">
                                </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" id="cancelAddToolOnly">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Tool</button>
                    </div>
                </form>
            </div>
        </div>

        <section class="discovery-section">
            <div class="random-display" id="randomDiscovery">
                <div class="random-display-header">
                    <span class="header-icon"><i class="fas fa-magic"></i></span>
                    <h3 class="header-text">Daily OSINT Discovery</h3>
                </div>
                <div id="randomItemDisplay" class="random-content-wrapper">
                    <div class="random-content-card placeholder">
                        <i class="fas fa-question-circle"></i>
                        <h4 class="card-title">Loading Discovery...</h4>
                        <p class="card-description">Please wait.</p>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary btn-sm" id="newRandomBtn">
                <i class="fas fa-sync-alt"></i> New Discovery
            </button>
        </section>


        <footer>
            <div class="footer-content">
                <div class="demo-content">
                    <h1>Your OSINT tools, always with you.</h1>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        &copy; 2025 OSINTVault. Designed for OSINT, cybersecurity analysts, cybersecurity professionals and researchers.
                    </p>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">
                        • Responsive design • Dark/Light mode • Modern aesthetics • Tactical feel
                    </p>
                </div>
            </div>
        </footer>
    </div>



    <div class="modal" id="addEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Entry</h3>
            <form id="addEntryForm">
                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="entryTypeSelect">
                        <option value="tool">Tool</option>
                        <option value="email">Email Address</option>
                        <option value="phone">Phone Number</option>
                        <option value="crypto">Crypto Transaction</option>
                        <option value="location">Location</option>
                        <option value="link">Social / Internet Link</option>
                        <option value="media">Image / Video</option>
                        <option value="password">Password</option>
                        <option value="keyword">Keyword</option>
                        <option value="social">Social Media Profile</option>

                        <option value="domain">Domain/IP/URL</option>
                        <option value="username">Username/Handle</option>
                        <option value="threat">Threat Intelligence</option>
                        <option value="vulnerability">Vulnerability</option>
                        <option value="malware">Malware/File</option>
                        <option value="breach">Data Breach</option>
                        <option value="credential">Credential Dump</option>
                        <option value="forum">Forum/Market</option>
                        <option value="vendor">Underground Vendor</option>
                        <option value="telegram">Telegram Channel</option>
                        <option value="paste">Paste Site</option>
                        <option value="document">Document</option>
                        <option value="network">Network Analysis</option>
                        <option value="metadata">Metadata</option>
                        <option value="archive">Archive/Cache</option>
                        <option value="messaging">Messaging App</option>
                        <option value="dating">Dating Profile</option>
                        <option value="audio">Audio File</option>
                        <option value="facial">Facial Recognition</option>
                        <option value="persona">Persona/Identity</option>
                        <option value="vpn">VPN/Anonymity</option>
                        <option value="honeypot">Honeypot</option>
                        <option value="exploit">Exploit/Market</option>
                        <option value="publicrecord">Public Record</option>
                    </select>
                </div>
                
                <div id="addToolFields" class="entry-fields">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolName" name="toolName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolUrl" name="toolUrl">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolCategory">
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="newCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="toolInvestigationNotes" rows="3" placeholder="Any specific notes or observations about this tool in your investigation."></textarea>
                    </div>
                </div>
                
                <div id="addEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="emailAddress" name="emailAddress" maxlength="60">
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="emailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="emailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="emailDescription" rows="3" placeholder="Brief description of the email's context or significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="emailNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="phoneNumber" maxlength="15" name="phoneNumber" placeholder="e.g., +1-234-567-8901">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="phoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="phoneLocation" placeholder="e.g., City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="phoneDescription" rows="3" placeholder="Brief description of the phone number's context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="phoneNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="cryptoAddress" name="cryptoAddress" maxlength="120" placeholder="e.g., 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="cryptoTxid" name="cryptoTxid">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" id="cryptoAmount" name="cryptoAmount" placeholder="e.g., 0.005 BTC">
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="cryptoSource" placeholder="exchange, darkweb, personal" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="cryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="cryptoDescription" rows="3" placeholder="Brief description of the transaction or address's significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="cryptoNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="locationName" name="locationName" placeholder="e.g., Target building, Suspect's residence" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="locationCoordinates" name="locationCoordinates" placeholder="e.g., 34.0522, -118.2437">
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="locationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="locationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="locationDescription" rows="3" placeholder="Brief description of the location's relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="locationNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="linkUrl" name="linkUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="linkPlatform" placeholder="twitter, reddit, pastebin, forum" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="linkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="linkDescription" rows="3" placeholder="Brief description of what the link contains or its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="linkNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="mediaTitle" name="mediaTitle" maxlength="50" placeholder="e.g., Suspect Photo, Video Evidence">
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="mediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload File (Local Only)</label>
                        <input type="file" id="mediaFile" accept="image/*,video/*">
                        <input type="hidden" id="mediaBase64Data"> <small style="color: var(--text-muted);">For local storage only. File will be base64 encoded.</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="mediaDescription" rows="3" placeholder="Brief description of the media content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="mediaNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="passwordService" name="passwordService" placeholder="e.g., Facebook, Gmail, Database">
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="passwordUsername" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="passwordValue" placeholder="e.g., P@ssw0rd123!" maxlength="120">
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="passwordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="passwordDescription" rows="3" placeholder="Context or relevance of this password."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="passwordNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="keywordValue" name="keywordValue" placeholder="e.g., 'John Doe', 'Project X', 'Confidential'">
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="keywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="keywordDescription" rows="3" placeholder="Elaborate on why this keyword is important."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="keywordNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="socialPlatform" name="socialPlatform" placeholder="e.g., Twitter, Instagram, TikTok">
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="socialUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="socialUsername" placeholder="e.g., @suspectprofile" maxlength="60">
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="socialFollowCounts" maxlength="50" placeholder="e.g., 12k followers, 500 following">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="socialDescription" rows="3" placeholder="Overview of the profile's content and activity."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="socialNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addDomainFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Domain/IP/URL</label>
                        <input type="text" id="domainValue" name="domainValue" placeholder="e.g., example.com, 192.168.1.1, https://suspicious-site.com">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="domainType">
                            <option value="domain">Domain</option>
                            <option value="ip">IP Address</option>
                            <option value="url">URL</option>
                            <option value="subdomain">Subdomain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Registrar/ISP</label>
                        <input type="text" id="domainRegistrar" placeholder="e.g., GoDaddy, Cloudflare, Comcast">
                    </div>
                    <div class="form-group">
                        <label>Country/Location</label>
                        <input type="text" id="domainLocation" placeholder="e.g., United States, Russia">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="domainStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspicious">Suspicious</option>
                            <option value="malicious">Malicious</option>
                            <option value="parked">Parked</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>WHOIS Info</label>
                        <textarea id="domainWhois" rows="3" placeholder="WHOIS registration details"></textarea>
                    </div>
                    <div class="form-group">
                        <label>DNS Records</label>
                        <textarea id="domainDns" rows="3" placeholder="A, MX, NS, TXT records"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="domainTags" placeholder="phishing, c2, malware, suspicious">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="domainNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addUsernameFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="usernameValue" name="usernameValue" placeholder="e.g., darkweb_trader, john_doe123" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Platforms Found</label>
                        <textarea id="usernamePlatforms" rows="3" placeholder="List platforms where this username was found"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated Email(s)</label>
                        <input type="text" id="usernameEmails" placeholder="email1@domain.com, email2@domain.com">
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="usernameRealName" placeholder="e.g., John Doe" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="usernameActivity">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="usernameDescription" rows="3" placeholder="Elaborate on the significance of this username."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="usernameNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addThreatFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Threat Type</label>
                        <select id="threatType">
                            <option value="malware">Malware</option>
                            <option value="apt">APT Group</option>
                            <option value="ioc">IOC (Indicator of Compromise)</option>
                            <option value="ttp">TTP (Tactics, Techniques, Procedures)</option>
                            <option value="campaign">Campaign</option>
                            <option value="actor">Threat Actor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Threat Name/ID</label>
                        <input type="text" id="threatName" name="threatName" placeholder="e.g., APT29, WannaCry, Emotet" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Severity Level</label>
                        <select id="threatSeverity">
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="info">Informational</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>IOCs (comma separated)</label>
                        <textarea id="threatIocs" rows="3" placeholder="IP addresses, domains, file hashes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Sectors</label>
                        <input type="text" id="threatTargets" placeholder="e.g., Government, Healthcare, Finance">
                    </div>
                    <div class="form-group">
                        <label>Attribution</label>
                        <input type="text" id="threatAttribution" placeholder="e.g., Nation-state, Criminal group, Unknown">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="threatDescription" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="threatSource" placeholder="e.g., MISP, AlienVault OTX, Internal">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="threatNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addVulnerabilityFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>CVE ID</label>
                        <input type="text" id="vulnCve" name="vulnCve" placeholder="e.g., CVE-2023-12345" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>CVSS Score</label>
                        <input type="number" step="0.1" min="0" max="10" id="vulnCvss" placeholder="e.g., 9.8">
                    </div>
                    <div class="form-group">
                        <label>Affected Software</label>
                        <input type="text" id="vulnSoftware" placeholder="e.g., Apache HTTP Server 2.4.x">
                    </div>
                    <div class="form-group">
                        <label>Vulnerability Type</label>
                        <select id="vulnType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="sqli">SQL Injection</option>
                            <option value="xss">Cross-Site Scripting</option>
                            <option value="privilege">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="info">Information Disclosure</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exploit Available</label>
                        <select id="vulnExploit">
                            <option value="no">No</option>
                            <option value="poc">PoC Available</option>
                            <option value="public">Public Exploit</option>
                            <option value="weaponized">Weaponized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="vulnDescription" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Mitigation</label>
                        <textarea id="vulnMitigation" rows="3" placeholder="Patches, workarounds, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="vulnNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMalwareFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>File Name</label>
                        <input type="text" id="malwareFilename" name="malwareFilename" placeholder="e.g., suspicious.exe, document.pdf" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA1/SHA256)</label>
                        <input type="text" id="malwareHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <select id="malwareType">
                            <option value="executable">Executable (.exe, .dll)</option>
                            <option value="document">Document (.pdf, .doc, .xls)</option>
                            <option value="script">Script (.js, .vbs, .ps1)</option>
                            <option value="archive">Archive (.zip, .rar)</option>
                            <option value="image">Image (.jpg, .png)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Malware Family</label>
                        <input type="text" id="malwareFamily" placeholder="e.g., Emotet, TrickBot, Ransomware">
                    </div>
                    <div class="form-group">
                        <label>Detection Ratio</label>
                        <input type="text" id="malwareDetection" placeholder="e.g., 45/70 (VirusTotal)">
                    </div>
                    <div class="form-group">
                        <label>Behavior</label>
                        <textarea id="malwareBehavior" rows="4" placeholder="File behavior, network connections, registry changes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="malwareSource" placeholder="e.g., Email attachment, Drive-by download">
                    </div>
                    <div class="form-group">
                        <label>Analysis Tools Used</label>
                        <input type="text" id="malwareTools" placeholder="e.g., VirusTotal, Hybrid Analysis, Cuckoo">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="malwareNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addBreachFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Company/Organization</label>
                        <input type="text" id="breachCompany" name="breachCompany" placeholder="e.g., Equifax, Target, LinkedIn" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Breach Date</label>
                        <input type="date" id="breachDate">
                    </div>
                    <div class="form-group">
                        <label>Records Affected</label>
                        <input type="number" id="breachRecords" placeholder="e.g., 147000000">
                    </div>
                    <div class="form-group">
                        <label>Data Types Compromised</label>
                        <textarea id="breachDataTypes" rows="3" placeholder="e.g., Names, SSNs, Credit card numbers, Passwords"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Attack Vector</label>
                        <select id="breachVector">
                            <option value="hacking">Hacking/Intrusion</option>
                            <option value="insider">Insider Threat</option>
                            <option value="physical">Physical</option>
                            <option value="malware">Malware</option>
                            <option value="social">Social Engineering</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="breachStatus">
                            <option value="confirmed">Confirmed</option>
                            <option value="suspected">Suspected</option>
                            <option value="investigating">Under Investigation</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source/Reference</label>
                        <input type="url" id="breachSource" placeholder="News article, official statement, etc.">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="breachDescription" rows="3" placeholder="Detailed description of the breach incident."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="breachNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addCredentialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Credential Type</label>
                        <select id="credentialType">
                            <option value="email_password">Email & Password</option>
                            <option value="username_password">Username & Password</option>
                            <option value="api_key">API Key</option>
                            <option value="ssh_key">SSH Key</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <textarea id="credentialValue" rows="3" placeholder="e.g., user@example.com:password123, username:password"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Service/Platform</label>
                        <input type="text" id="credentialService" placeholder="e.g., Company X Database, Internal System">
                    </div>
                    <div class="form-group">
                        <label>Breach/Source</label>
                        <input type="text" id="credentialBreachSource" placeholder="e.g., Pastebin, Dark Web Forum, Company Breach">
                    </div>
                    <div class="form-group">
                        <label>Date Found</label>
                        <input type="date" id="credentialDateFound">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="credentialDescription" rows="3" placeholder="Context or relevance of this credential dump."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="credentialNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addForumFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Forum/Market Name</label>
                        <input type="text" id="forumName" name="forumName" placeholder="e.g., BreachForums, Hydra Market" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="forumUrl" placeholder="e.g., http://xyz.onion/forum">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="forumType">
                            <option value="forum">Forum</option>
                            <option value="market">Marketplace</option>
                            <option value="carding">Carding Forum</option>
                            <option value="hacking">Hacking Forum</option>
                            <option value="ransomware">Ransomware Group</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="forumStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="down">Down/Seized</option>
                            <option value="scam">Scam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Primary Language</label>
                        <input type="text" id="forumLanguage" placeholder="e.g., English, Russian">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="forumDescription" rows="3" placeholder="Brief description of the forum/market and its primary focus."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="forumNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addVendorFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Vendor Name/Alias</label>
                        <input type="text" id="vendorAlias" name="vendorAlias" placeholder="e.g., 'DarkWebSupply', 'CredsMaster'" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Associated Platforms</label>
                        <textarea id="vendorPlatforms" rows="3" placeholder="e.g., Dark Web Market A, Telegram Channel B, Forum C"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Products/Services</label>
                        <input type="text" id="vendorProducts" placeholder="e.g., Stolen Credentials, Malware, Drugs">
                    </div>
                    <div class="form-group">
                        <label>Reputation Score</label>
                        <input type="text" id="vendorReputation" placeholder="e.g., 4.5/5, High Trust, Scammer">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="vendorDescription" rows="3" placeholder="Detailed description of the vendor's activities and offerings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="vendorNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addTelegramFields" class="entry-fields">
                    <div class="form-group">
                        <label>Channel Name</label>
                        <input type="text" id="telegramName" name="telegramName" placeholder="e.g., @darkweb_market" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Channel URL</label>
                        <input type="url" id="telegramUrl" placeholder="https://t.me/channelname">
                    </div>
                    <div class="form-group">
                        <label>Channel Type</label>
                        <select id="telegramType">
                            <option value="market">Marketplace</option>
                            <option value="news">News/Info</option>
                            <option value="leak">Data Leaks</option>
                            <option value="hacking">Hacking/Security</option>
                            <option value="crypto">Cryptocurrency</option>
                            <option value="social">Social/Chat</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subscriber Count</label>
                        <input type="number" id="telegramSubscribers" placeholder="e.g., 15000">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <input type="text" id="telegramLanguage" placeholder="e.g., English, Russian, Spanish" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="telegramActivity">
                            <option value="high">High (Daily posts)</option>
                            <option value="medium">Medium (Weekly posts)</option>
                            <option value="low">Low (Occasional posts)</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Content Description</label>
                        <textarea id="telegramContent" rows="3" placeholder="Description of typical content shared"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Admin/Owner Info</label>
                        <input type="text" id="telegramAdmin" placeholder="Known admin usernames or info">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="telegramTags" placeholder="darkweb, marketplace, leaks, cybercrime">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="telegramNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPasteFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Paste URL</label>
                        <input type="url" id="pasteUrl" name="pasteUrl" placeholder="e.g., https://pastebin.com/xyz123">
                    </div>
                    <div class="form-group">
                        <label>Source Site</label>
                        <input type="text" id="pasteSourceSite" placeholder="e.g., Pastebin, Pastie, Ghostbin">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="pasteContentSummary" rows="3" placeholder="Brief summary of leaked data or text"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Keywords/Indicators</label>
                        <input type="text" id="pasteKeywords" placeholder="e.g., email list, database dump, exploit code">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="pasteDescription" rows="3" placeholder="Detailed description of the paste's content and its relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="pasteNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addDocumentFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Document Title/Name</label>
                        <input type="text" id="documentTitle" name="documentTitle" placeholder="e.g., Project Proposal, Leaked Memo" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <input type="text" id="documentFileType" placeholder="e.g., PDF, DOCX, XLSX, TXT">
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA256)</label>
                        <input type="text" id="documentHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="documentContentSummary" rows="4" placeholder="Brief summary of document content, key findings"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="documentSource" placeholder="e.g., Email attachment, Public server, Data breach">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="documentDescription" rows="3" placeholder="Detailed description of the document's content and context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="documentNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addNetworkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Analysis Subject</label>
                        <input type="text" id="networkSubject" name="networkSubject" placeholder="e.g., 'Target Network Scan', 'Suspect's IP Traffic'" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Type of Analysis</label>
                        <select id="networkType">
                            <option value="scan">Port Scan</option>
                            <option value="traffic">Network Traffic Analysis</option>
                            <option value="dns">DNS Analysis</option>
                            <option value="whois">WHOIS Lookup</option>
                            <option value="fingerprint">Device Fingerprinting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Findings</label>
                        <textarea id="networkFindings" rows="4" placeholder="Open ports, suspicious traffic, identified services, vulnerabilities"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated IPs/Domains</label>
                        <textarea id="networkAssociated" rows="3" placeholder="Comma-separated list of IPs, domains, or URLs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="networkTools" placeholder="e.g., Nmap, Wireshark, Shodan">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="networkDescription" rows="3" placeholder="Overall description of the network analysis conducted."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="networkNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMetadataEntryFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Metadata Title/Context</label>
                        <input type="text" id="metadataTitle" placeholder="e.g., EXIF Data from Image, PDF Creation Info">
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">Use the 'Custom Metadata' section below to add key-value pairs for this entry.</p>
                    <div class="form-group">
                        <label>Metadata Description</label>
                        <textarea id="metadataDescription" rows="3" placeholder="A general description of the metadata collected or its context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>File/Source</label>
                        <input type="text" id="metadataFileSource" placeholder="e.g., image.jpg, document.pdf, website header">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="metadataNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addArchiveFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Original URL</label>
                        <input type="url" id="archiveOriginalUrl" name="archiveOriginalUrl" placeholder="e.g., https://example.com/old-page">
                    </div>
                    <div class="form-group">
                        <label>Archived URL/Link</label>
                        <input type="url" id="archiveUrl" name="archiveUrl" placeholder="e.g., https://web.archive.org/web/...">
                    </div>
                    <div class="form-group">
                        <label>Archiving Service</label>
                        <input type="text" id="archiveService" placeholder="e.g., Wayback Machine, Archive.is, Google Cache">
                    </div>
                    <div class="form-group">
                        <label>Timestamp</label>
                        <input type="datetime-local" id="archiveTimestamp">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="archiveContentSummary" rows="4" placeholder="Brief summary of the archived content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="archiveDescription" rows="3" placeholder="Context or relevance of this archived page/content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="archiveNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMessagingFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Messaging App</label>
                        <select id="messagingApp">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="telegram">Telegram</option>
                            <option value="signal">Signal</option>
                            <option value="discord">Discord</option>
                            <option value="irc">IRC</option>
                            <option value="matrix">Matrix</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Username/ID</label>
                        <input type="text" id="messagingUsername" name="messagingUsername" placeholder="e.g., @userhandle, +1234567890">
                    </div>
                    <div class="form-group">
                        <label>Channel/Group/Chat ID</label>
                        <input type="text" id="messagingChatId" placeholder="e.g., Group Name, Channel ID">
                    </div>
                    <div class="form-group">
                        <label>Relevant Content</label>
                        <textarea id="messagingContent" rows="4" placeholder="Summary of conversations, key messages, shared files"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="messagingDescription" rows="3" placeholder="Context or relevance of this messaging app entry."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="messagingNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addDatingFields" class="entry-fields">
                    <div class="form-group">
                        <label>Platform</label>
                        <select id="datingPlatform">
                            <option value="tinder">Tinder</option>
                            <option value="bumble">Bumble</option>
                            <option value="match">Match.com</option>
                            <option value="pof">Plenty of Fish</option>
                            <option value="okcupid">OkCupid</option>
                            <option value="hinge">Hinge</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Profile Name/Username</label>
                        <input type="text" id="datingUsername" name="datingUsername" placeholder="e.g., John_D_NYC" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="datingDisplayName" placeholder="e.g., John, 28" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" min="18" max="99" id="datingAge" placeholder="e.g., 28">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="datingLocation" placeholder="e.g., New York, NY" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Profile Photos</label>
                        <textarea id="datingPhotos" rows="3" placeholder="Description of photos, reverse image search results, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bio/Description</label>
                        <textarea id="datingBio" rows="3" placeholder="Profile bio or description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Verification Status</label>
                        <select id="datingVerified">
                            <option value="verified">Verified</option>
                            <option value="unverified">Unverified</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Suspicious Flags</label>
                        <textarea id="datingSuspicious" rows="3" placeholder="Any red flags or suspicious indicators"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="datingNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addAudioFields" class="entry-fields">
                    <div class="form-group">
                        <label>Audio Title</label>
                        <input type="text" id="audioTitle" name="audioTitle" placeholder="e.g., Phone call recording, Voice message" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>File Format</label>
                        <select id="audioFormat">
                            <option value="mp3">MP3</option>
                            <option value="wav">WAV</option>
                            <option value="m4a">M4A</option>
                            <option value="ogg">OGG</option>
                            <option value="flac">FLAC</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <input type="text" id="audioDuration" placeholder="e.g., 2:30, 45 seconds">
                    </div>
                    <div class="form-group">
                        <label>Quality</label>
                        <select id="audioQuality">
                            <option value="high">High Quality</option>
                            <option value="medium">Medium Quality</option>
                            <option value="low">Low Quality</option>
                            <option value="poor">Poor Quality</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Language(s)</label>
                        <input type="text" id="audioLanguage" placeholder="e.g., English, Spanish, Multiple">
                    </div>
                    <div class="form-group">
                        <label>Transcript</label>
                        <textarea id="audioTranscript" rows="5" placeholder="Transcription of audio content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Speaker Analysis</label>
                        <textarea id="audioSpeakers" rows="3" placeholder="Number of speakers, gender, accents, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Background Noise</label>
                        <input type="text" id="audioBackground" placeholder="e.g., Traffic, music, office sounds">
                    </div>
                    <div class="form-group">
                        <label>Analysis Tools Used</label>
                        <input type="text" id="audioTools" placeholder="e.g., Audacity, Adobe Audition, Forensic tools">
                    </div>
                    <div class="form-group">
                        <label>Upload File (Local Only)</label>
                        <input type="file" id="audioFile" accept="audio/*">
                        <small>For local storage only. File will be base64 encoded.</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="audioDescription" rows="3" placeholder="Detailed description of the audio content and its relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="audioNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addFacialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Subject/Person Identified</label>
                        <input type="text" id="facialSubject" name="facialSubject" placeholder="e.g., John Doe, Suspect 1" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Source Image/Video Description</label>
                        <textarea id="facialSourceDescription" rows="3" placeholder="Where was the image/video found?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Identified Profiles/Platforms</label>
                        <textarea id="facialIdentifiedProfiles" rows="3" placeholder="e.g., Facebook Profile URL, Instagram Username"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Confidence Score</label>
                        <input type="text" id="facialConfidence" placeholder="e.g., High, 85%">
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="facialToolsUsed" placeholder="e.g., PimEyes, Google Images, Facial Recognition Software">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="facialDescription" rows="3" placeholder="Overall description of the facial recognition finding."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="facialNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPersonaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Persona Name/Alias</label>
                        <input type="text" id="personaName" name="personaName" placeholder="e.g., 'Online Gamer X', 'Business Account Y'" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="personaRealName" placeholder="e.g., John Doe" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Associated Usernames/Emails</label>
                        <textarea id="personaAssociatedAccounts" rows="3" placeholder="List all linked usernames, emails, phone numbers"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bio/Description</label>
                        <textarea id="personaBio" rows="4" placeholder="Profile bio or description of the persona."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Platforms Used</label>
                        <input type="text" id="personaPlatforms" placeholder="e.g., Twitter, Discord, Dark Web Forums">
                    </div>
                    <div class="form-group">
                        <label>Origin/Purpose</label>
                        <input type="text" id="personaOrigin" placeholder="e.g., Scammer, Investigator, Activist">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="personaNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addVpnFields" class="entry-fields">
                    <div class="form-group">
                        <label>Service Name</label>
                        <input type="text" id="vpnName" name="vpnName" placeholder="e.g., NordVPN, Tor Browser, ProtonVPN" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="vpnType">
                            <option value="vpn">VPN Service</option>
                            <option value="proxy">Proxy</option>
                            <option value="tor">Tor Network</option>
                            <option value="browser">Anonymous Browser</option>
                            <option value="os">Anonymous OS</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction</label>
                        <input type="text" id="vpnJurisdiction" placeholder="e.g., Panama, Switzerland, No logs">
                    </div>
                    <div class="form-group">
                        <label>Logging Policy</label>
                        <select id="vpnLogs">
                            <option value="no-logs">No Logs</option>
                            <option value="minimal">Minimal Logs</option>
                            <option value="connection">Connection Logs</option>
                            <option value="full">Full Logs</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Methods</label>
                        <input type="text" id="vpnPayment" placeholder="e.g., Bitcoin, Cash, Credit Card">
                    </div>
                    <div class="form-group">
                        <label>Server Locations</label>
                        <input type="text" id="vpnLocations" placeholder="e.g., 60+ countries, Europe only">
                    </div>
                    <div class="form-group">
                        <label>Known Issues/Leaks</label>
                        <textarea id="vpnIssues" rows="3" placeholder="DNS leaks, IP leaks, law enforcement cooperation, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Use Case</label>
                        <select id="vpnUseCase">
                            <option value="investigation">Investigation</option>
                            <option value="target">Used by Target</option>
                            <option value="opsec">Operational Security</option>
                            <option value="testing">Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="vpnDescription" rows="3" placeholder="General description of the VPN service or anonymity tool."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="vpnNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addHoneypotFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Honeypot Type</label>
                        <select id="honeypotType">
                            <option value="low-interaction">Low Interaction</option>
                            <option value="high-interaction">High Interaction</option>
                            <option value="data">Data Honeypot</option>
                            <option value="network">Network Honeypot</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deployment Location/IP</label>
                        <input type="text" id="honeypotLocation" placeholder="e.g., Public Cloud, 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label>Purpose</label>
                        <input type="text" id="honeypotPurpose" placeholder="e.g., Malware Analysis, Threat Actor Tracking">
                    </div>
                    <div class="form-group">
                        <label>Captured Data Summary</label>
                        <textarea id="honeypotDataSummary" rows="4" placeholder="Summary of captured attacks, malware, IPs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Alerts/Indicators</label>
                        <textarea id="honeypotAlerts" rows="3" placeholder="Key indicators or alerts generated"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="honeypotDescription" rows="3" placeholder="Detailed description of the honeypot setup and findings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="honeypotNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addExploitFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Exploit Name/ID</label>
                        <input type="text" id="exploitName" name="exploitName" placeholder="e.g., EternalBlue, CVE-2023-XXXX" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Target Vulnerability</label>
                        <input type="text" id="exploitTargetVuln" placeholder="e.g., MS17-010, Adobe Flash Zero-Day">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="exploitType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="privesc">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="zero-day">Zero-Day</option>
                            <option value="poc">PoC</option>
                            <option value="weaponized">Weaponized</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Market/Source</label>
                        <input type="text" id="exploitMarketSource" placeholder="e.g., Exploit-DB, Underground Market, Private Sale">
                    </div>
                    <div class="form-group">
                        <label>Price/Value</label>
                        <input type="text" id="exploitPrice" placeholder="e.g., $10,000, 2 BTC">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="exploitDescription" rows="3" placeholder="Technical description of the exploit and its capabilities."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="exploitNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPublicRecordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Record Type</label>
                        <select id="publicRecordType">
                            <option value="court">Court Record</option>
                            <option value="property">Property Record</option>
                            <option value="business">Business Registration</option>
                            <option value="voter">Voter Registration</option>
                            <option value="license">License/Permit</option>
                            <option value="tax">Tax Record</option>
                            <option value="marriage">Marriage/Divorce</option>
                            <option value="birth_death">Birth/Death Certificate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject Name</label>
                        <input type="text" id="publicRecordSubjectName" name="publicRecordSubjectName" placeholder="e.g., John Doe" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Case/Reference ID</label>
                        <input type="text" id="publicRecordRefId" placeholder="e.g., Case #12345, Doc-XYZ">
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction/Location</label>
                        <input type="text" id="publicRecordJurisdiction" placeholder="e.g., New York, NY; Federal Court">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="publicRecordDate">
                    </div>
                    <div class="form-group">
                        <label>Summary/Key Details</label>
                        <textarea id="publicRecordSummary" rows="4" placeholder="Summary of record content and relevance"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source URL/Location</label>
                        <input type="url" id="publicRecordSourceUrl" placeholder="e.g., official website link">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="publicRecordDescription" rows="3" placeholder="General description of the public record and its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="publicRecordNotes" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group" id="entrySourceGroup" style="display: none;">
                    <label>Source (Where was this info collected?)</label>
                    <input type="text" id="entrySource" name="entrySource" placeholder="e.g., public record, social media, dark web forum">
                </div>

                <div id="customMetadataGroup" style="display: none;">
                    <label>Custom Metadata</label>
                    <div id="customMetadataEntries">
                        </div>
                    <button type="button" class="btn btn-secondary btn-sm add-metadata-btn" id="addMetadataBtn">
                        <i class="fas fa-plus"></i> Add Metadata Field
                    </button>
                </div>


                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelAddEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-edit"></i> Edit Entry</h3>
            <form id="editEntryForm">
                <input type="hidden" id="editEntryId">
                <input type="hidden" id="editEntryType">
    
                <div id="editToolFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="editToolName" name="editToolName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editToolUrl" name="editToolUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="editToolCategory" required>
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="editNewCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editToolDescription" rows="3" placeholder="Brief description of the tool."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editToolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editToolInvestigationNotes" rows="3" placeholder="Any specific notes or observations about this tool in your investigation."></textarea>
                    </div>
                    <div class="custom-tab-assignment" id="intelligenceVaultCategoriesAssignmentEditTool">
                        <h4>Add to Intelligence Vault Categories</h4>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">Select one or more intelligence categories for this tool.</p>
    
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div style="position: relative;">
                                <input type="text" id="editIntelligenceVaultCategorySearch" class="search-input" placeholder="Search categories..." style="padding-right: 40px;">
                                <i class="fas fa-search search-icon" style="right: 15px;"></i>
                            </div>
                        </div>
    
                        <div class="custom-tab-checkboxes-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                            <div class="custom-tab-checkboxes" id="intelligenceVaultCategoriesCheckboxesEditTool">
                            </div>
                        </div>
                    </div>
                </div>
    
                <div id="editEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="editEmailAddress" name="editEmailAddress" maxlength="60" required>
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="editEmailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="editEmailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editEmailDescription" rows="3" placeholder="Brief description of the email's context or significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editEmailNotes" rows="3" placeholder="Any specific notes or observations about this email."></textarea>
                    </div>
                </div>
    
                <div id="editPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="editPhoneNumber" maxlength="15" name="editPhoneNumber" placeholder="e.g., +1-234-567-8901" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editPhoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="editPhoneLocation" placeholder="e.g., City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPhoneDescription" rows="3" placeholder="Brief description of the phone number's context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPhoneNotes" rows="3" placeholder="Any specific notes or observations about this phone number."></textarea>
                    </div>
                </div>
    
                <div id="editCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="editCryptoAddress" name="editCryptoAddress" maxlength="120" placeholder="e.g., 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa" required>
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="editCryptoTxid" name="editCryptoTxid" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" name="editCryptoAmount" id="editCryptoAmount" placeholder="e.g., 0.005 BTC" required>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="editCryptoSource" placeholder="exchange, darkweb, personal" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editCryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editCryptoDescription" rows="3" placeholder="Brief description of the transaction or address's significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editCryptoNotes" rows="3" placeholder="Any specific notes or observations about this crypto entry."></textarea>
                    </div>
                </div>
    
                <div id="editLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="editLocationName" name="editLocationName" maxlength="50" placeholder="e.g., Target building, Suspect's residence" required>
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="editLocationCoordinates" name="editLocationCoordinates" placeholder="e.g., 34.0522, -118.2437" required>
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="editLocationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="editLocationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editLocationDescription" rows="3" placeholder="Brief description of the location's relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editLocationNotes" rows="3" placeholder="Any specific notes or observations about this location."></textarea>
                    </div>
                </div>
    
                <div id="editLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editLinkUrl" name="editLinkUrl" placeholder="e.g., https://twitter.com/suspectprofile" required>
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="editLinkPlatform" placeholder="twitter, reddit, pastebin, forum" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editLinkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editLinkDescription" rows="3" placeholder="Brief description of what the link contains or its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editLinkNotes" rows="3" placeholder="Any specific notes or observations about this link."></textarea>
                    </div>
                </div>
    
                <div id="editMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editMediaTitle" name="editMediaTitle" maxlength="50" placeholder="e.g., Suspect Photo, Video Evidence" required>
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="editMediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload New File (Optional)</label>
                        <input type="file" id="editMediaFile" accept="image/*,video/*">
                        <input type="hidden" id="editMediaBase64Data"> <small style="color: var(--text-muted);">Upload a new file to replace the existing one.</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editMediaDescription" rows="3" placeholder="Brief description of the media content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMediaNotes" rows="3" placeholder="Any specific notes or observations about this media file."></textarea>
                    </div>
                </div>
    
                <div id="editPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="editPasswordService" name="editPasswordService" placeholder="e.g., Facebook, Gmail, Database" required>
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="editPasswordUsername" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="editPasswordValue" placeholder="e.g., P@ssw0rd123!" maxlength="120" required>
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="editPasswordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPasswordDescription" rows="3" placeholder="Context or relevance of this password."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPasswordNotes" rows="3" placeholder="Any specific notes or observations about this password."></textarea>
                    </div>
                </div>
    
                <div id="editKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="editKeywordValue" name="editKeywordValue" placeholder="e.g., 'John Doe', 'Project X', 'Confidential'" required>
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="editKeywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editKeywordDescription" rows="3" placeholder="Elaborate on why this keyword is important."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editKeywordNotes" rows="3" placeholder="Any specific notes or observations about this keyword."></textarea>
                    </div>
                </div>
    
                <div id="editSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="editSocialPlatform" name="editSocialPlatform" placeholder="e.g., Twitter, Instagram, TikTok" required>
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="editSocialUrl" placeholder="e.g., https://twitter.com/suspectprofile" required>
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="editSocialUsername" placeholder="e.g., @suspectprofile" maxlength="60" required>
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="editSocialFollowCounts" maxlength="50" placeholder="e.g., 12k followers, 500 following">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editSocialDescription" rows="3" placeholder="Overview of the profile's content and activity."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editSocialNotes" rows="3" placeholder="Any specific notes or observations about this social profile."></textarea>
                    </div>
                </div>
    
                <div id="editDomainFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Domain/IP/URL</label>
                        <input type="text" id="editDomainValue" name="editDomainValue" placeholder="e.g., example.com, 192.168.1.1, https://suspicious-site.com" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editDomainType" required>
                            <option value="domain">Domain</option>
                            <option value="ip">IP Address</option>
                            <option value="url">URL</option>
                            <option value="subdomain">Subdomain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Registrar/ISP</label>
                        <input type="text" id="editDomainRegistrar" placeholder="e.g., GoDaddy, Cloudflare, Comcast">
                    </div>
                    <div class="form-group">
                        <label>Country/Location</label>
                        <input type="text" id="editDomainLocation" placeholder="e.g., United States, Russia">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editDomainStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspicious">Suspicious</option>
                            <option value="malicious">Malicious</option>
                            <option value="parked">Parked</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>WHOIS Info</label>
                        <textarea id="editDomainWhois" rows="3" placeholder="WHOIS registration details"></textarea>
                    </div>
                    <div class="form-group">
                        <label>DNS Records</label>
                        <textarea id="editDomainDns" rows="3" placeholder="A, MX, NS, TXT records"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editDomainTags" placeholder="phishing, c2, malware, suspicious">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDomainDescription" rows="3" placeholder="Brief description of the domain/IP/URL's relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editDomainNotes" rows="3" placeholder="Any specific notes or observations about this domain/IP/URL."></textarea>
                    </div>
                </div>
    
                <div id="editUsernameFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="editUsernameValue" name="editUsernameValue" placeholder="e.g., darkweb_trader, john_doe123" maxlength="50" required>
                    </div>
                    <div class="form-group">
                        <label>Platforms Found</label>
                        <textarea id="editUsernamePlatforms" rows="3" placeholder="List platforms where this username was found"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated Email(s)</label>
                        <input type="text" id="editUsernameEmails" placeholder="email1@domain.com, email2@domain.com">
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="editUsernameRealName" placeholder="e.g., John Doe" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="editUsernameActivity">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editUsernameDescription" rows="3" placeholder="Elaborate on the significance of this username."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editUsernameNotes" rows="3" placeholder="Any specific notes or observations about this username."></textarea>
                    </div>
                </div>
    
                <div id="editThreatFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Threat Type</label>
                        <select id="editThreatType" required>
                            <option value="malware">Malware</option>
                            <option value="apt">APT Group</option>
                            <option value="ioc">IOC (Indicator of Compromise)</option>
                            <option value="ttp">TTP (Tactics, Techniques, Procedures)</option>
                            <option value="campaign">Campaign</option>
                            <option value="actor">Threat Actor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Threat Name/ID</label>
                        <input type="text" id="editThreatName" name="editThreatName" placeholder="e.g., APT29, WannaCry, Emotet" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Severity Level</label>
                        <select id="editThreatSeverity">
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="info">Informational</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>IOCs (comma separated)</label>
                        <textarea id="editThreatIocs" rows="3" placeholder="IP addresses, domains, file hashes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Sectors</label>
                        <input type="text" id="editThreatTargets" placeholder="e.g., Government, Healthcare, Finance">
                    </div>
                    <div class="form-group">
                        <label>Attribution</label>
                        <input type="text" id="editThreatAttribution" placeholder="e.g., Nation-state, Criminal group, Unknown">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editThreatDescription" rows="4" placeholder="Detailed description of the threat."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="editThreatSource" placeholder="e.g., MISP, AlienVault OTX, Internal">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editThreatNotes" rows="3" placeholder="Any specific notes or observations about this threat intelligence."></textarea>
                    </div>
                </div>
    
                <div id="editVulnerabilityFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>CVE ID</label>
                        <input type="text" id="editVulnCve" name="editVulnCve" placeholder="e.g., CVE-2023-12345" maxlength="20" required>
                    </div>
                    <div class="form-group">
                        <label>CVSS Score</label>
                        <input type="number" step="0.1" min="0" max="10" id="editVulnCvss" placeholder="e.g., 9.8">
                    </div>
                    <div class="form-group">
                        <label>Affected Software</label>
                        <input type="text" id="editVulnSoftware" placeholder="e.g., Apache HTTP Server 2.4.x">
                    </div>
                    <div class="form-group">
                        <label>Vulnerability Type</label>
                        <select id="editVulnType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="sqli">SQL Injection</option>
                            <option value="xss">Cross-Site Scripting</option>
                            <option value="privilege">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="info">Information Disclosure</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exploit Available</label>
                        <select id="editVulnExploit">
                            <option value="no">No</option>
                            <option value="poc">PoC Available</option>
                            <option value="public">Public Exploit</option>
                            <option value="weaponized">Weaponized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editVulnDescription" rows="4" placeholder="Detailed description of the vulnerability."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Mitigation</label>
                        <textarea id="editVulnMitigation" rows="3" placeholder="Patches, workarounds, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editVulnNotes" rows="3" placeholder="Any specific notes or observations about this vulnerability."></textarea>
                    </div>
                </div>
    
                <div id="editMalwareFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>File Name</label>
                        <input type="text" id="editMalwareFilename" name="editMalwareFilename" placeholder="e.g., suspicious.exe, document.pdf" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA1/SHA256)</label>
                        <input type="text" id="editMalwareHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <select id="editMalwareType">
                            <option value="executable">Executable (.exe, .dll)</option>
                            <option value="document">Document (.pdf, .doc, .xls)</option>
                            <option value="script">Script (.js, .vbs, .ps1)</option>
                            <option value="archive">Archive (.zip, .rar)</option>
                            <option value="image">Image (.jpg, .png)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Malware Family</label>
                        <input type="text" id="editMalwareFamily" placeholder="e.g., Emotet, TrickBot, Ransomware">
                    </div>
                    <div class="form-group">
                        <label>Detection Ratio</label>
                        <input type="text" id="editMalwareDetection" placeholder="e.g., 45/70 (VirusTotal)">
                    </div>
                    <div class="form-group">
                        <label>Behavior</label>
                        <textarea id="editMalwareBehavior" rows="4" placeholder="File behavior, network connections, registry changes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="editMalwareSource" placeholder="e.g., Email attachment, Drive-by download">
                    </div>
                    <div class="form-group">
                        <label>Analysis Tools Used</label>
                        <input type="text" id="editMalwareTools" placeholder="e.g., VirusTotal, Hybrid Analysis, Cuckoo">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMalwareNotes" rows="3" placeholder="Any specific notes or observations about this malware."></textarea>
                    </div>
                </div>
    
                <div id="editBreachFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Company/Organization</label>
                        <input type="text" id="editBreachCompany" name="editBreachCompany" placeholder="e.g., Equifax, Target, LinkedIn" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Breach Date</label>
                        <input type="date" id="editBreachDate" required>
                    </div>
                    <div class="form-group">
                        <label>Records Affected</label>
                        <input type="number" id="editBreachRecords" placeholder="e.g., 147000000">
                    </div>
                    <div class="form-group">
                        <label>Data Types Compromised</label>
                        <textarea id="editBreachDataTypes" rows="3" placeholder="e.g., Names, SSNs, Credit card numbers, Passwords"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Attack Vector</label>
                        <select id="editBreachVector">
                            <option value="hacking">Hacking/Intrusion</option>
                            <option value="insider">Insider Threat</option>
                            <option value="physical">Physical</option>
                            <option value="malware">Malware</option>
                            <option value="social">Social Engineering</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editBreachStatus">
                            <option value="confirmed">Confirmed</option>
                            <option value="suspected">Suspected</option>
                            <option value="investigating">Under Investigation</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source/Reference</label>
                        <input type="url" id="editBreachSource" placeholder="News article, official statement, etc.">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editBreachDescription" rows="3" placeholder="Detailed description of the breach incident."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editBreachNotes" rows="3" placeholder="Any specific notes or observations about this data breach."></textarea>
                    </div>
                </div>
    
                <div id="editCredentialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Credential Type</label>
                        <select id="editCredentialType">
                            <option value="email_password">Email & Password</option>
                            <option value="username_password">Username & Password</option>
                            <option value="api_key">API Key</option>
                            <option value="ssh_key">SSH Key</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <textarea id="editCredentialValue" rows="3" placeholder="e.g., user@example.com:password123, username:password" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Service/Platform</label>
                        <input type="text" id="editCredentialService" placeholder="e.g., Company X Database, Internal System">
                    </div>
                    <div class="form-group">
                        <label>Breach/Source</label>
                        <input type="text" id="editCredentialBreachSource" placeholder="e.g., Pastebin, Dark Web Forum, Company Breach">
                    </div>
                    <div class="form-group">
                        <label>Date Found</label>
                        <input type="date" id="editCredentialDateFound">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editCredentialDescription" rows="3" placeholder="Context or relevance of this credential dump."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editCredentialNotes" rows="3" placeholder="Any specific notes or observations about this credential."></textarea>
                    </div>
                </div>
    
                <div id="editForumFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Forum/Market Name</label>
                        <input type="text" id="editForumName" name="editForumName" placeholder="e.g., BreachForums, Hydra Market" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editForumUrl" placeholder="e.g., http://xyz.onion/forum" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editForumType">
                            <option value="forum">Forum</option>
                            <option value="market">Marketplace</option>
                            <option value="carding">Carding Forum</option>
                            <option value="hacking">Hacking Forum</option>
                            <option value="ransomware">Ransomware Group</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editForumStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="down">Down/Seized</option>
                            <option value="scam">Scam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Primary Language</label>
                        <input type="text" id="editForumLanguage" placeholder="e.g., English, Russian">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editForumDescription" rows="3" placeholder="Brief description of the forum/market and its primary focus."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editForumNotes" rows="3" placeholder="Any specific notes or observations about this forum/market."></textarea>
                    </div>
                </div>
    
                <div id="editVendorFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Vendor Name/Alias</label>
                        <input type="text" id="editVendorAlias" name="editVendorAlias" placeholder="e.g., 'DarkWebSupply', 'CredsMaster'" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Associated Platforms</label>
                        <textarea id="editVendorPlatforms" rows="3" placeholder="e.g., Dark Web Market A, Telegram Channel B, Forum C"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Products/Services</label>
                        <input type="text" id="editVendorProducts" placeholder="e.g., Stolen Credentials, Malware, Drugs">
                    </div>
                    <div class="form-group">
                        <label>Reputation Score</label>
                        <input type="text" id="editVendorReputation" placeholder="e.g., 4.5/5, High Trust, Scammer">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editVendorDescription" rows="3" placeholder="Detailed description of the vendor's activities and offerings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editVendorNotes" rows="3" placeholder="Any specific notes or observations about this vendor."></textarea>
                    </div>
                </div>
    
                <div id="editPasteFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Paste URL</label>
                        <input type="url" id="editPasteUrl" name="editPasteUrl" placeholder="e.g., https://pastebin.com/xyz123" required>
                    </div>
                    <div class="form-group">
                        <label>Source Site</label>
                        <input type="text" id="editPasteSourceSite" placeholder="e.g., Pastebin, Pastie, Ghostbin">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="editPasteContentSummary" rows="3" placeholder="Brief summary of leaked data or text"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Keywords/Indicators</label>
                        <input type="text" id="editPasteKeywords" placeholder="e.g., email list, database dump, exploit code">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPasteDescription" rows="3" placeholder="Detailed description of the paste's content and its relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPasteNotes" rows="3" placeholder="Any specific notes or observations about this paste."></textarea>
                    </div>
                </div>
    
                <div id="editDocumentFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Document Title/Name</label>
                        <input type="text" id="editDocumentTitle" name="editDocumentTitle" placeholder="e.g., Project Proposal, Leaked Memo" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <input type="text" id="editDocumentFileType" placeholder="e.g., PDF, DOCX, XLSX, TXT">
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA256)</label>
                        <input type="text" id="editDocumentHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="editDocumentContentSummary" rows="4" placeholder="Brief summary of document content, key findings"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="editDocumentSource" placeholder="e.g., Email attachment, Public server, Data breach">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDocumentDescription" rows="3" placeholder="Detailed description of the document's content and context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editDocumentNotes" rows="3" placeholder="Any specific notes or observations about this document."></textarea>
                    </div>
                </div>
    
                <div id="editNetworkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Analysis Subject</label>
                        <input type="text" id="editNetworkSubject" name="editNetworkSubject" placeholder="e.g., 'Target Network Scan', 'Suspect's IP Traffic'" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Type of Analysis</label>
                        <select id="editNetworkType">
                            <option value="scan">Port Scan</option>
                            <option value="traffic">Network Traffic Analysis</option>
                            <option value="dns">DNS Analysis</option>
                            <option value="whois">WHOIS Lookup</option>
                            <option value="fingerprint">Device Fingerprinting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Findings</label>
                        <textarea id="editNetworkFindings" rows="4" placeholder="Open ports, suspicious traffic, identified services, vulnerabilities"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated IPs/Domains</label>
                        <textarea id="editNetworkAssociated" rows="3" placeholder="Comma-separated list of IPs, domains, or URLs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="editNetworkTools" placeholder="e.g., Nmap, Wireshark, Shodan">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editNetworkDescription" rows="3" placeholder="Overall description of the network analysis conducted."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editNetworkNotes" rows="3" placeholder="Any specific notes or observations about this network analysis."></textarea>
                    </div>
                </div>
    
                <div id="editMetadataEntryFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Metadata Title/Context</label>
                        <input type="text" id="editMetadataTitle" placeholder="e.g., EXIF Data from Image, PDF Creation Info" required>
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">Use the 'Custom Metadata' section below to add key-value pairs for this entry.</p>
                    <div class="form-group">
                        <label>Metadata Description</label>
                        <textarea id="editMetadataDescription" rows="3" placeholder="A general description of the metadata collected or its context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>File/Source</label>
                        <input type="text" id="editMetadataFileSource" placeholder="e.g., image.jpg, document.pdf, website header">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMetadataNotes" rows="3" placeholder="Any specific notes or observations about this metadata."></textarea>
                    </div>
                </div>
    
                <div id="editArchiveFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Original URL</label>
                        <input type="url" id="editArchiveOriginalUrl" name="editArchiveOriginalUrl" placeholder="e.g., https://example.com/old-page" required>
                    </div>
                    <div class="form-group">
                        <label>Archived URL/Link</label>
                        <input type="url" id="editArchiveUrl" name="editArchiveUrl" placeholder="e.g., https://web.archive.org/web/..." required>
                    </div>
                    <div class="form-group">
                        <label>Archiving Service</label>
                        <input type="text" id="editArchiveService" placeholder="e.g., Wayback Machine, Archive.is, Google Cache">
                    </div>
                    <div class="form-group">
                        <label>Timestamp</label>
                        <input type="datetime-local" id="editArchiveTimestamp">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="editArchiveContentSummary" rows="4" placeholder="Brief summary of the archived content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editArchiveDescription" rows="3" placeholder="Context or relevance of this archived page/content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editArchiveNotes" rows="3" placeholder="Any specific notes or observations about this archived content."></textarea>
                    </div>
                </div>
    
                <div id="editMessagingFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Messaging App</label>
                        <select id="editMessagingApp" required>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="telegram">Telegram</textareareadonly>
                            <option value="signal">Signal</option>
                            <option value="discord">Discord</option>
                            <option value="irc">IRC</option>
                            <option value="matrix">Matrix</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Username/ID</label>
                        <input type="text" id="editMessagingUsername" name="editMessagingUsername" placeholder="e.g., @userhandle, +1234567890" required>
                    </div>
                    <div class="form-group">
                        <label>Channel/Group/Chat ID</label>
                        <input type="text" id="editMessagingChatId" placeholder="e.g., Group Name, Channel ID">
                    </div>
                    <div class="form-group">
                        <label>Relevant Content</label>
                        <textarea id="editMessagingContent" rows="4" placeholder="Summary of conversations, key messages, shared files"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editMessagingDescription" rows="3" placeholder="Context or relevance of this messaging app entry."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMessagingNotes" rows="3" placeholder="Any specific notes or observations about this messaging app entry."></textarea>
                    </div>
                </div>
    
                <div id="editFacialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Subject/Person Identified</label>
                        <input type="text" id="editFacialSubject" name="editFacialSubject" placeholder="e.g., John Doe, Suspect 1" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Source Image/Video Description</label>
                        <textarea id="editFacialSourceDescription" rows="3" placeholder="Where was the image/video found?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Identified Profiles/Platforms</label>
                        <textarea id="editFacialIdentifiedProfiles" rows="3" placeholder="e.g., Facebook Profile URL, Instagram Username"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Confidence Score</label>
                        <input type="text" id="editFacialConfidence" placeholder="e.g., High, 85%">
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="editFacialToolsUsed" placeholder="e.g., PimEyes, Google Images, Facial Recognition Software">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editFacialDescription" rows="3" placeholder="Overall description of the facial recognition finding."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editFacialNotes" rows="3" placeholder="Any specific notes or observations about this facial recognition entry."></textarea>
                    </div>
                </div>
    
                <div id="editPersonaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Persona Name/Alias</label>
                        <input type="text" id="editPersonaName" name="editPersonaName" placeholder="e.g., 'Online Gamer X', 'Business Account Y'" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="editPersonaRealName" placeholder="e.g., John Doe" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Associated Usernames/Emails</label>
                        <textarea id="editPersonaAssociatedAccounts" rows="3" placeholder="List all linked usernames, emails, phone numbers"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bio/Description</label>
                        <textarea id="editPersonaBio" rows="4" placeholder="Profile bio or description of the persona."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Platforms Used</label>
                        <input type="text" id="editPersonaPlatforms" placeholder="e.g., Twitter, Discord, Dark Web Forums">
                    </div>
                    <div class="form-group">
                        <label>Origin/Purpose</label>
                        <input type="text" id="editPersonaOrigin" placeholder="e.g., Scammer, Investigator, Activist">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPersonaNotes" rows="3" placeholder="Any specific notes or observations about this persona."></textarea>
                    </div>
                </div>
    
                <div id="editHoneypotFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Honeypot Type</label>
                        <select id="editHoneypotType" required>
                            <option value="low-interaction">Low Interaction</option>
                            <option value="high-interaction">High Interaction</option>
                            <option value="data">Data Honeypot</option>
                            <option value="network">Network Honeypot</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deployment Location/IP</label>
                        <input type="text" id="editHoneypotLocation" placeholder="e.g., Public Cloud, 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label>Purpose</label>
                        <input type="text" id="editHoneypotPurpose" placeholder="e.g., Malware Analysis, Threat Actor Tracking">
                    </div>
                    <div class="form-group">
                        <label>Captured Data Summary</label>
                        <textarea id="editHoneypotDataSummary" rows="4" placeholder="Summary of captured attacks, malware, IPs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Alerts/Indicators</label>
                        <textarea id="editHoneypotAlerts" rows="3" placeholder="Key indicators or alerts generated"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editHoneypotDescription" rows="3" placeholder="Detailed description of the honeypot setup and findings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editHoneypotNotes" rows="3" placeholder="Any specific notes or observations about this honeypot."></textarea>
                    </div>
                </div>
    
                <div id="editExploitFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Exploit Name/ID</label>
                        <input type="text" id="editExploitName" name="editExploitName" placeholder="e.g., EternalBlue, CVE-2023-XXXX" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Target Vulnerability</label>
                        <input type="text" id="editExploitTargetVuln" placeholder="e.g., MS17-010, Adobe Flash Zero-Day">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editExploitType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="privesc">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="zero-day">Zero-Day</option>
                            <option value="poc">PoC</option>
                            <option value="weaponized">Weaponized</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Market/Source</label>
                        <input type="text" id="editExploitMarketSource" placeholder="e.g., Exploit-DB, Underground Market, Private Sale">
                    </div>
                    <div class="form-group">
                        <label>Price/Value</label>
                        <input type="text" id="editExploitPrice" placeholder="e.g., $10,000, 2 BTC">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editExploitDescription" rows="3" placeholder="Technical description of the exploit and its capabilities."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editExploitNotes" rows="3" placeholder="Any specific notes or observations about this exploit."></textarea>
                    </div>
                </div>
    
                <div id="editPublicRecordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Record Type</label>
                        <select id="editPublicRecordType" required>
                            <option value="court">Court Record</option>
                            <option value="property">Property Record</option>
                            <option value="business">Business Registration</option>
                            <option value="voter">Voter Registration</option>
                            <option value="license">License/Permit</option>
                            <option value="tax">Tax Record</option>
                            <option value="marriage">Marriage/Divorce</option>
                            <option value="birth_death">Birth/Death Certificate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject Name</label>
                        <input type="text" id="editPublicRecordSubjectName" name="editPublicRecordSubjectName" placeholder="e.g., John Doe" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Case/Reference ID</label>
                        <input type="text" id="editPublicRecordRefId" placeholder="e.g., Case #12345, Doc-XYZ">
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction/Location</label>
                        <input type="text" id="editPublicRecordJurisdiction" placeholder="e.g., New York, NY; Federal Court">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="editPublicRecordDate">
                    </div>
                    <div class="form-group">
                        <label>Summary/Key Details</label>
                        <textarea id="editPublicRecordSummary" rows="4" placeholder="Summary of record content and relevance"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source URL/Location</label>
                        <input type="url" id="editPublicRecordSourceUrl" placeholder="e.g., official website link">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPublicRecordDescription" rows="3" placeholder="General description of the public record and its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPublicRecordNotes" rows="3" placeholder="Any specific notes or observations about this public record."></textarea>
                    </div>
                </div>
    
                <div class="form-group" id="editEntrySourceGroup">
                    <label>Source (Where was this info collected?)</label>
                    <input type="text" id="editEntrySource" name="editEntrySource" placeholder="e.g., public record, social media, dark web forum">
                </div>
    
                <div id="editCustomMetadataGroup">
                    <label>Custom Metadata</label>
                    <div id="editCustomMetadataEntries">
                        </div>
                    <button type="button" class="btn btn-secondary btn-sm add-metadata-btn" id="editAddMetadataBtn">
                        <i class="fas fa-plus"></i> Add Metadata Field
                    </button>
                </div>
    
                <div class="custom-tab-assignment" id="assignCustomTabs">
                    <h4>Assign to Custom Vault Tab(s)</h4>
                    <div class="custom-tab-checkboxes" id="assignCustomTabsCheckboxes">
                    </div>
                </div>
    
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-plus-circle"></i>
                Create New Custom Vault
            </h3>
            <form id="createSubTabForm">
                <div class="form-group">
                    <label>Vault Name</label>
                    <input type="text" id="newSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="newSubTabIcon" placeholder="fas fa-globe">
                    <div class="icon-picker-grid" id="newSubTabIconPicker"></div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="newSubTabColor">
                    <div class="color-picker-grid" id="newSubTabColorPicker"></div>
                </div>
                <div class="form-group">
                    <label>Add Tools to this Vault</label>
                    <div id="newCustomVaultToolSelection" class="custom-tab-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                        </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelCreateSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Vault</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-edit"></i>
                Edit Custom Vault
            </h3>
            <form id="editSubTabForm">
                <input type="hidden" id="editSubTabId">
                <div class="form-group">
                    <label>Vault Name</label>
                    <input type="text" id="editedSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="editedSubTabIcon" placeholder="fas fa-globe">
                     <div class="icon-picker-grid" id="editedSubTabIconPicker"></div>
                </div>
                 <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="editedSubTabColor">
                    <div class="color-picker-grid" id="editedSubTabColorPicker"></div>
                </div>
                <div class="form-group">
                    <label>Tools in this Vault</label>
                    <div id="editCustomVaultToolSelection" class="custom-tab-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                        </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="shareOptionsModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-share-alt"></i> Share Intelligence
            </h3>
            <form id="shareForm">
                <div class="form-group">
                    <label for="shareScopeSelect">What would you like to share?</label>
                    <select id="shareScopeSelect">
                        <option value="currentTab">Current Tab (Read-Only View)</option>
                        <option value="allVault">All Intelligence Vault (Read-Only View)</option>
                        <option value="allData">All Data (Read-Only View)</option>
                        <option value="specificCustomTabPlaceholder">Specific Custom Vault...</option>
                        </select>
                </div>
    
                <div id="specificCustomTabSelector" class="form-group" style="display:none;">
                    <label for="selectCustomTabForSharing">Select a Custom Vault to share:</label>
                    <select id="selectCustomTabForSharing">
                        </select>
                </div>
    
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelShareOptions">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Link</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="caseStudyDetailModal">
        <div class="modal-content">
            <button type="button" class="close-modal-btn" onclick="hideModal('caseStudyDetailModal')">&times;</button>
            
            <div class="case-study-detail-header">
                <h3 class="detail-title" id="detailCaseStudyTitle"></h3>
                <div class="detail-meta">
                    <span><i class="fas fa-tags"></i> Type: <span id="detailCaseStudyType"></span></span>
                    <span><i class="fas fa-calendar-alt"></i> Date: <span id="detailCaseStudyDate"></span></span>
                    <span><i class="fas fa-user-secret"></i> Actor: <span id="detailCaseStudyActor"></span></span>
                    <span><i class="fas fa-level-up-alt"></i> Difficulty: <span id="detailCaseStudyDifficulty"></span></span>
                </div>
            </div>
            <div class="detail-content">
                <h3>Overview</h3>
                <p id="detailCaseStudySummary"></p>

                <h3>Attack Chain</h3>
                <div id="detailCaseStudyAttackChain"></div>

                <h3>OSINT Techniques Used</h3>
                <ul id="detailCaseStudyTechniques"></ul>

                <h3>Key Tools Involved</h3>
                <ul id="detailCaseStudyTools"></ul>

                <h3>Lessons Learned</h3>
                <div id="detailCaseStudyLessons"></div>
            </div>
            <div class="detail-tags" id="detailCaseStudyTags"></div>
        </div>
    </div>

    <div class="modal" id="addEditCaseStudyModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> <span id="addEditCaseStudyModalTitle">Add New Case Study</span></h3>
            <form id="addEditCaseStudyForm">
                <input type="hidden" id="caseStudyId">
                <div class="form-group">
                    <label for="caseStudyTitle">Title</label>
                    <input type="text" id="caseStudyTitle" required placeholder="e.g., SolarWinds Supply Chain Attack">
                </div>
                <div class="form-group">
                    <label for="caseStudyIncidentType">Incident Type</label>
                    <select id="caseStudyIncidentType" required>
                        <option value="">Select Type</option>
                        <option value="ransomware">Ransomware</option>
                        <option value="phishing">Phishing</option>
                        <option value="insider-threat">Insider Threat</option>
                        <option value="data-breach">Data Breach</option>
                        <option value="apt">APT Activity</option>
                        <option value="ddos">DDoS Attack</option>
                        <option value="malware">Malware Analysis</option>
                        <option value="fraud">Fraud</option>
                        <option value="other">Other</option>
                        <option value="custom">Custom Type</option>
                    </select>
                    <input type="text" id="newCaseStudyTypeInput" placeholder="Or enter new type" style="margin-top: 10px; display: none;">
                </div>
                <div class="form-group">
                    <label for="caseStudyDateRange">Date (e.g., 2023-01-01 to 2023-01-31)</label>
                    <input type="text" id="caseStudyDateRange" placeholder="e.g., 2023-01-01 to 2023-01-31" required>
                </div>
                <div class="form-group">
                    <label for="caseStudyActor">Threat Actor (Optional)</label>
                    <input type="text" id="caseStudyActor" placeholder="e.g., APT28, UNC2452">
                </div>
                <div class="form-group">
                    <label for="caseStudyDifficulty">Difficulty</label>
                    <select id="caseStudyDifficulty" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="caseStudySummary">Summary</label>
                    <textarea id="caseStudySummary" rows="3" placeholder="Brief overview of the case study."></textarea>
                </div>
                <div class="form-group">
                    <label for="caseStudyAttackChain">Attack Chain (Rich Text)</label>
                    <div class="formatting-toolbar">
                        <button type="button" class="formatting-btn" data-command="bold" title="Bold">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="italic" title="Italic">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="underline" title="Underline">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="createLink" title="Insert Link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    <div id="caseStudyAttackChain" class="note-content-editor" contenteditable="true" style="min-height: 150px;"></div>
                </div>
                <div class="form-group">
                    <label for="caseStudyOsintTechniques">OSINT Techniques Used (comma separated)</label>
                    <input type="text" id="caseStudyOsintTechniques" placeholder="e.g., DNS Recon, Social Media Analysis">
                </div>
                <div class="form-group">
                    <label for="caseStudyToolsUsed">Key Tools Involved (comma separated)</label>
                    <input type="text" id="caseStudyToolsUsed" placeholder="e.g., Wireshark, Maltego, VirusTotal">
                </div>
                <div class="form-group">
                    <label for="caseStudyLessons">Lessons Learned (Rich Text)</label>
                     <div class="formatting-toolbar">
                        <button type="button" class="formatting-btn" data-command="bold" title="Bold">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="italic" title="Italic">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="underline" title="Underline">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button type="button" class="formatting-btn" data-command="createLink" title="Insert Link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    <div id="caseStudyLessons" class="note-content-editor" contenteditable="true" style="min-height: 150px;"></div>
                </div>
                <div class="form-group">
                    <label for="caseStudyTags">Tags (comma separated)</label>
                    <input type="text" id="caseStudyTags" placeholder="e.g., cybercrime, forensics, darkweb">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelCaseStudyAddEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveCaseStudyBtn">Save Case Study</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addEditScriptModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> <span id="addEditScriptModalTitle">Add New Script</span></h3>
            <form id="addEditScriptForm">
                <input type="hidden" id="scriptId">
                <div class="form-group">
                    <label for="scriptName">Script Name</label>
                    <input type="text" id="scriptName" required placeholder="e.g., Sysmon Event Parser, Firewall Log Analyzer">
                </div>
                <div class="form-group">
                    <label for="scriptDescription">Description</label>
                    <textarea id="scriptDescription" rows="3" placeholder="Brief explanation of what the script does and its purpose."></textarea>
                </div>
                <div class="form-group">
                    <label for="scriptLanguage">Language</label>
                    <select id="scriptLanguage" required>
                        <option value="">Select Language</option>
                        <option value="powershell">PowerShell</option>
                        <option value="python">Python</option>
                        <option value="bash">Bash/Shell</option>
                        <option value="cmd">CMD Batch</option>
                        <option value="c#">C#</option>
                        <option value="go">Go</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scriptCode">Script Code (or Command)</label>
                    <textarea id="scriptCode" rows="10" placeholder="Paste your script code here, or a single command/snippet." style="font-family: 'JetBrains Mono', monospace;"></textarea>
                </div>
                <div class="form-group">
                    <label for="scriptTags">Tags (comma separated)</label>
                    <input type="text" id="scriptTags" placeholder="e.g., endpoint, network, detection, forensics">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelScriptAddEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveScriptBtn">Save Script</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="scriptCodeDisplayModal">
        <div class="modal-content">
            <button type="button" class="close-modal-btn" onclick="hideModal('scriptCodeDisplayModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-code"></i> Script Code: <span id="displayScriptName"></span></h3>
            <pre id="displayScriptCode"></pre>
            <div style="text-align: right;">
                <button class="copy-code-btn" id="copyScriptCodeBtn">
                    <i class="fas fa-copy"></i> Copy Code
                </button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="threat-huntingTab">
        <div class="content-header">
            <h2 class="content-title">Cyber Threat Hunting Toolkit</h2>
            <div class="controls">
                <button class="btn btn-primary" id="addScriptBtn">
                    <i class="fas fa-plus-circle"></i>
                    Add New Script
                </button>
                <button class="btn btn-secondary" id="scriptViewToggle" title="Switch to List View">
                    <i class="fas fa-list"></i>
                    List View
                </button>
            </div>
        </div>
        <div class="sub-nav-tabs">
            <button class="sub-nav-tab th-subtab active" data-th-subtab="script-library">
                <i class="fas fa-code"></i> Script Library
            </button>
            <button class="sub-nav-tab th-subtab" data-th-subtab="dashboards">
                <i class="fas fa-chart-bar"></i> Dashboards
            </button>
            <button class="sub-nav-tab th-subtab" data-th-subtab="playbooks">
                <i class="fas fa-book-open"></i> Playbooks
            </button>
        </div>

        <div class="th-subtab-content" id="script-library-content" style="display: block; margin-top: 20px;">
            <div class="tools-grid" id="scriptLibraryGrid">
                </div>
            <div class="empty-state" id="emptyScriptLibraryState" style="display: none;">
                <i class="fas fa-code"></i>
                <h3>No Scripts Found</h3>
                <p>Add your first threat hunting script to get started!</p>
                <button class="btn btn-primary" id="addScriptEmptyStateBtn">
                    <i class="fas fa-plus"></i> Add First Script
                </button>
            </div>
        </div>

        <div class="th-subtab-content" id="dashboards-content" style="display: none; margin-top: 20px;">
            <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <h3>Dashboards (Coming Soon)</h3>
                <p>This section will feature interactive dashboards for threat hunting.</p>
            </div>
        </div>

        <div class="th-subtab-content" id="playbooks-content" style="display: none; margin-top: 20px;">
            <div class="empty-state">
                <i class="fas fa-book-open"></i>
                <h3>Hunting Playbooks (Coming Soon)</h3>
                <p>A collection of step-by-step guides for various threat hunting scenarios.</p>
            </div>
        </div>
    </div>


    <script>
        let appState = {
            tools: [],
            emails: [],
            phones: [],
            crypto: [],
            locations: [],
            links: [],
            media: [],
            passwords: [],
            keywords: [],
            socials: [],
            domains: [],
            usernames: [],
            threats: [],
            vulnerabilities: [],
            malware: [],
            breaches: [],
            credentials: [],
            forums: [],
            vendors: [],
            telegramChannels: [],
            pastes: [],
            documents: [],
            networks: [],
            metadataEntries: [],
            archives: [],
            messagingApps: [],
            datingProfiles: [],
            audioEntries: [],
            facialRecognition: [],
            personas: [],
            vpns: [],
            honeypots: [],
            exploits: [],
            publicRecords: [],
            caseStudies: [], // Explicitly define as an empty array here
            selectedEntries: new Set(),
            currentTab: 'dashboard',
            currentIntelligenceVaultParentTab: 'generalAndCore',
            currentIntelligenceVaultChildTab: 'tools',
            currentCustomVaultEntrySubTab: 'tool',
            currentCustomVaultParentTab: 'coreInvestigation',
            customTabs: [],
            filters: {
                category: '',
                search: '',
                sort: 'name',
                searchScope: 'currentTab'
            },
            caseStudyFilters: { // Filters specific to case studies
                search: '',
                type: ''
            },
            theme: localStorage.getItem('theme') || 'dark',
            viewMode: localStorage.getItem('viewMode') || 'grid',
            usageStats: {
                toolsUsedToday: 0
            },
            osintTips: [
                "Always use a VPN for anonymity during investigations.",
                "Verify your sources: Cross-reference information from multiple independent channels.",
                "Analyze metadata: Hidden data in images and documents can reveal crucial clues.",
                "Utilize archived web pages with tools like the Wayback Machine.",
                "Be mindful of your digital footprint; everything you do online leaves a trace.",
                "Learn advanced search operators for targeted information retrieval.",
                "Understand your target's OPSEC (Operational Security) to anticipate their moves.",
                "Never compromise your own security for an investigation. Think OPSEC first."
            ],
            threatHuntingScripts: [], // NEW: Array to store threat hunting scripts
            selectedScripts: new Set(), // NEW: For bulk selection of scripts
            currentThSubTab: 'script-library', // NEW: Default sub-tab for Threat Hunting
            scriptFilters: { // NEW: Filters specific to scripts
                search: '',
                language: ''
            },
            timeline: {
                events: [],
                currentTimelineId: null,
                timelines: [],
            },
            readOnlyMode: false,
            sharedTabId: null,
            sharedEntryIds: [],
            randomDiscoveryLayouts: ['single-centered', 'two-columns', 'two-rows'],

        };
        // --- End of appState definition ---

        // Define sampleCaseStudies array here, before any function that might try to use it.
        const sampleCaseStudies = [{
            id: 'cs-solarwinds-001',
            title: 'SolarWinds Supply Chain Attack (SUNBURST)',
            incidentType: 'apt',
            dateRange: '2020 Q1 - 2021 Q2',
            summary: 'A sophisticated supply chain attack impacting SolarWinds Orion platform, allowing attackers to compromise thousands of organizations worldwide, including government agencies and Fortune 500 companies.',
            attackChain: `
                <h3>Phase 1: Initial Compromise & Supply Chain Injection</h3>
                <p>Attackers injected malicious code (SUNBURST backdoor) into SolarWinds Orion software updates. This was a highly stealthy operation, blending the malicious code with legitimate updates.</p>
                <ul>
                    <li><strong>Method:</strong> Supply Chain Attack</li>
                    <li><strong>Initial Vector:</strong> Compromised SolarWinds build environment</li>
                </ul>
                <h3>Phase 2: Distribution & Foothold</h3>
                <p>Victim organizations downloaded the trojanized Orion updates, which established a backdoor. The malware remained dormant for up to two weeks before activating.</p>
                <ul>
                    <li><strong>Delivery:</strong> Legitimate software update</li>
                    <li><strong>Persistence:</strong> Implanted backdoor within Orion software</li>
                </ul>
                <h3>Phase 3: Lateral Movement & Data Exfiltration</h3>
                <p>Once active, SUNBURST allowed attackers to escalate privileges, move laterally within victim networks, and steal sensitive data, including emails and intellectual property. Attackers often used compromised credentials to access cloud environments like Microsoft 365.</p>
                <ul>
                    <li><strong>Techniques:</strong> Credential theft, Golden SAML, Lateral Movement, Cloud environment compromise</li>
                    <li><strong>Impact:</strong> Data exfiltration, espionage</li>
                </ul>
            `,
            osintTechniquesUsed: ['DNS Recon', 'WHOIS Lookup', 'Public Records', 'Threat Intelligence Platform Analysis', 'Domain Squatting Checks'],
            toolsUsed: ['VirusTotal', 'Shodan', 'Passive DNS tools', 'Public record databases', 'Threat intelligence platforms'],
            lessonsLearned: `
                <p>This case study highlights the severe risks of supply chain attacks and the importance of robust security practices across the entire software development lifecycle.</p>
                <ul>
                    <li><strong>Supply Chain Security:</strong> Implement strict vetting and continuous monitoring of third-party software and vendors.</li>
                    <li><strong>Zero Trust Architecture:</strong> Adopt a zero-trust model where no entity is inherently trusted, regardless of its location.</li>
                    <li><strong>MFA & Endpoint Detection:</strong> Enforce multi-factor authentication everywhere and deploy advanced endpoint detection and response (EDR) solutions.</li>
                    <li><strong>Threat Hunting:</strong> Actively hunt for anomalous behavior, even when traditional security alerts are quiet.</li>
                    <li><strong>Log Analysis:</strong> Centralize and analyze logs from all systems, including cloud services, for suspicious activity.</li>
                </ul>
            `,
            threatActor: 'APT29 (UNC2452 / Nobelium)',
            difficulty: 'advanced',
            tags: ['apt', 'supply-chain', 'espionage', 'government', 'microsoft', 'orion'],
            starred: true,
            pinned: false,
            addedDate: new Date('2021-03-10T09:00:00Z')
        }, {
            id: 'cs-phishing-xyz-002',
            title: 'Phishing Attack on Healthcare Provider',
            incidentType: 'phishing',
            dateRange: '2024-05-15',
            summary: 'A targeted phishing campaign delivered ransomware disguised as urgent medical invoices, impacting a small regional healthcare provider and encrypting patient records.',
            attackChain: `
                <h3>Phase 1: Spear Phishing</h3>
                <p>Attackers crafted highly personalized emails targeting administrative staff, using publicly available information about the healthcare provider.</p>
                <ul>
                    <li><strong>Method:</strong> Spear Phishing</li>
                    <li><strong>Lure:</strong> Fake medical invoice attached</li>
                </ul>
                <h3>Phase 2: Malware Delivery & Execution</h3>
                <p>An attached malicious PDF (containing embedded malware) was opened by an unsuspecting employee. The malware then executed, initiating the ransomware payload.</p>
                <ul>
                    <li><strong>Payload:</strong> Ransomware variant (e.g., Conti, LockBit)</li>
                    <li><strong>Execution:</strong> Malicious document macro/exploit</li>
                </ul>
                <h3>Phase 3: Encryption & Extortion</h3>
                <p>The ransomware rapidly encrypted critical patient databases and internal network shares. Attackers demanded a cryptocurrency payment for decryption keys.</p>
                <ul>
                    <li><strong>Impact:</strong> Data encryption, operational disruption, extortion</li>
                </ul>
            `,
            osintTechniquesUsed: ['Email Header Analysis', 'Domain Reputation Checks', 'Social Media Scanning (for employee info)', 'Public Records (for business contacts)'],
            toolsUsed: ['MXToolbox', 'VirusTotal', 'Have I Been Pwned', 'URLVoid', 'Email security gateways'],
            lessonsLearned: `
                <p>This case highlights the ongoing threat of phishing, especially against vulnerable sectors like healthcare.</p>
                <ul>
                    <li><strong>Employee Training:</strong> Regular and effective cybersecurity awareness training for all staff.</li>
                    <li><strong>Email Filtering:</strong> Implement robust email security solutions with advanced threat detection.</li>
                    <li><strong>Backup Strategy:</strong> Maintain frequent, offline, and immutable backups of critical data.</li>
                    <li><strong>Incident Response Plan:</strong> Have a well-tested incident response plan specifically for ransomware attacks.</li>
                    <li><strong>Network Segmentation:</strong> Segment networks to limit lateral movement in case of a breach.</li>
                </ul>
            `,
            threatActor: 'Unattributed Cybercriminal Group',
            difficulty: 'intermediate',
            tags: ['ransomware', 'healthcare', 'phishing', 'cybercrime', 'data-encryption'],
            starred: false,
            pinned: true,
            addedDate: new Date('2024-05-20T14:30:00Z')
        }, {
            id: 'cs-insider-003',
            title: 'Insider Threat: Data Exfiltration by Disgruntled Employee',
            incidentType: 'insider-threat',
            dateRange: '2023-11-01 to 2024-01-20',
            summary: 'A disgruntled former employee exfiltrated sensitive customer data before leaving the company, using unauthorized cloud storage services.',
            attackChain: `
                <h3>Phase 1: Unauthorized Access & Data Collection</h3>
                <p>The employee, while still employed, accessed internal databases beyond their normal job function, collecting customer records.</p>
                <ul>
                    <li><strong>Method:</strong> Privilege Abuse</li>
                    <li><strong>Source:</strong> Internal Database, CRM system</li>
                </ul>
                <h3>Phase 2: Data Staging & Obfuscation</h3>
                <p>Data was copied to local machine, compressed, and sometimes renamed to evade detection before being uploaded to personal cloud accounts.</p>
                <ul>
                    <li><strong>Techniques:</strong> Data compression, renaming files</li>
                    <li><strong>Tools:</strong> WinRAR, standard OS tools</li>
                </ul>
                <h3>Phase 3: Exfiltration</h3>
                <p>Sensitive data was uploaded to a personal cloud storage service (e.g., Dropbox, Google Drive) over several weeks, often outside business hours.</p>
                <ul>
                    <li><strong>Vector:</strong> Cloud storage (e.g., Dropbox, Google Drive)</li>
                    <li><strong>Timing:</b> Off-hours activity</li>
                </ul>
                <h3>Phase 4: Post-Termination Access Attempt</h3>
                <p>Attempts to access internal systems were detected from the former employee's home IP address post-termination, triggering alarms and leading to forensic investigation.</p>
                <ul>
                    <li><strong>Detection:</strong> Failed login attempts, IP monitoring</li>
                </ul>
            `,
            osintTechniquesUsed: ['Employee Social Media Monitoring (public info)', 'Email Address Recon (for personal accounts)', 'IP Geolocation', 'Domain/Cloud Provider WHOIS'],
            toolsUsed: ['OSINT Tools for social media search', 'IP lookup tools', 'Cloud service provider terms of service analysis'],
            lessonsLearned: `
                <p>Insider threats are difficult to detect but often leave digital breadcrumbs.</p>
                <ul>
                    <li><strong>DLP (Data Loss Prevention):</strong> Implement and configure DLP solutions to monitor and block unauthorized data transfers to cloud services.</li>
                    <li><strong>UBA (User Behavior Analytics):</b> Deploy UBA tools to detect anomalous user behavior (e.g., accessing unusual files, large data transfers).</li>
                    <li><strong>Strict Access Controls:</strong> Implement least privilege and role-based access control, regularly reviewing permissions.</li>
                    <li><strong>Offboarding Procedures:</strong> Ensure immediate revocation of all access upon employee termination.</li>
                    <li><strong>Log Monitoring:</strong> Continuously monitor and alert on unusual login patterns or access attempts from former employees.</li>
                </ul>
            `,
            threatActor: 'Disgruntled Employee (Internal)',
            difficulty: 'intermediate',
            tags: ['insider-threat', 'data-exfiltration', 'cloud-security', 'privilege-abuse', 'forensics'],
            starred: true,
            pinned: true,
            addedDate: new Date('2024-02-01T10:00:00Z')
        }];

        const timelineCategories = {
            "phishing": { name: "Phishing", icon: "fas fa-fish", color: "#e74c3c" },
            "initial_access": { name: "Initial Access", icon: "fas fa-door-open", color: "#3498db" },
            "lateral_movement": { name: "Lateral Movement", icon: "fas fa-arrows-alt-h", color: "#9b59b6" },
            "exfiltration": { name: "Data Exfiltration", icon: "fas fa-cloud-upload-alt", color: "#f1c40f" },
            "command_control": { name: "Command & Control", icon: "fas fa-satellite-dish", color: "#e67e22" },
            "reconnaissance": { name: "Reconnaissance", icon: "fas fa-binoculars", color: "#1abc9c" },
            "malware_delivery": { name: "Malware Delivery", icon: "fas fa-bug", color: "#d35400" },
            "persistence": { name: "Persistence", icon: "fas fa-redo-alt", color: "#f39c12" },
            "privilege_escalation": { name: "Privilege Escalation", icon: "fas fa-lock-open", color: "#16a085" },
            "defense_evasion": { name: "Defense Evasion", icon: "fas fa-shield-virus", color: "#c0392b" },
            "credential_access": { name: "Credential Access", icon: "fas fa-user-lock", color: "#2980b9" },
            "discovery": { name: "Discovery", icon: "fas fa-compass", color: "#8e44ad" },
            "collection": { name: "Collection", icon: "fas fa-box-open", color: "#27ae60" },
            "impact": { name: "Impact", icon: "fas fa-explosion", color: "#e74c3c" },
            "remediation": { name: "Remediation", icon: "fas fa-wrench", color: "#2ecc71" },
            "fraud": { name: "Financial Fraud", icon: "fas fa-money-check-alt", color: "#f1c40f" },
            "insider_threat": { name: "Insider Threat", icon: "fas fa-user-secret", color: "#c0392b" },
            "other": { name: "Other", icon: "fas fa-info-circle", color: "#7f8c8d" },
        };

        const availableIcons = [
            'fas fa-globe', 'fas fa-search', 'fas fa-fingerprint', 'fas fa-shield-alt',
            'fas fa-link', 'fas fa-network-wired', 'fas fa-envelope', 'fas fa-image',
            'fas fa-map-marker-alt', 'fas fa-book', 'fas fa-coins', 'fas fa-users',
            'fas fa-camera', 'fas fa-lock', 'fas fa-key', 'fas fa-bug', 'fas fa-cloud',
            'fas fa-mobile-alt', 'fas fa-server', 'fas fa-database', 'fas fa-code',
            'fas fa-chart-line', 'fas fa-user-secret', 'fas fa-lightbulb', 'fas fa-laptop-code',
            'fas fa-phone', 'fas fa-money-bill-wave', 'fas fa-video', 'fas fa-paste', 'fas fa-location-arrow',
            'fas fa-font',
            'fas fa-microscope' // NEW: Added microscope for case studies
        ];

        const availableColors = [
            'var(--tab-color-default)', 'var(--tab-color-red)', 'var(--tab-color-blue)',
            'var(--tab-color-green)', 'var(--tab-color-yellow)', 'var(--tab-color-purple)',
            'var(--tab-color-orange)'
        ];

        const defaultTools = [
            {
                id: 'google-advanced-search',
                type: 'tool',
                name: 'Google Advanced Search',
                url: 'https://www.google.com/advanced_search',
                category: 'search engines',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Advanced search operators and techniques for comprehensive information gathering',
                tags: ['search', 'google', 'operators'],
                starred: false,
                pinned: false,
                favicon: 'https://www.google.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-01-15T10:00:00Z'),
                customTabs: [], // Initialize customTabs array
                origin: 'pre-added'
            },
            {
                id: 'shodan',
                type: 'tool',
                name: 'Shodan',
                url: 'https://www.shodan.io',
                category: 'network analysis',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Search engine for Internet-connected devices and systems',
                tags: ['iot', 'network', 'scanning', 'security'],
                starred: true,
                pinned: false,
                favicon: 'https://www.shodan.io/static/img/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-02-20T11:30:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'maltego',
                type: 'tool',
                name: 'Maltego',
                url: 'https://www.maltego.com',
                category: 'network analysis',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Link analysis and data mining application for gathering and connecting information',
                tags: ['analysis', 'visualization', 'mapping'],
                starred: false,
                pinned: true,
                favicon: 'https://www.maltego.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-03-01T14:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'have-i-been-pwned',
                type: 'tool',
                name: 'Have I Been Pwned',
                url: 'https://haveibeenpwned.com',
                category: 'email investigation',
                intelligenceVaultCategories: ['emailTools'], // Assign to 'Email Tools'
                description: 'Check if email addresses have been compromised in data breaches',
                tags: ['breach', 'email', 'security', 'compromise'],
                starred: true,
                pinned: false,
                favicon: 'https://haveibeenpwned.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-04-10T09:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'virustotal',
                type: 'tool',
                name: 'VirusTotal',
                url: 'https://www.virustotal.com',
                category: 'threat intelligence',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Analyze suspicious files and URLs to detect types of malware',
                tags: ['malware', 'analysis', 'threat', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.virustotal.com/gui/images/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-05-05T16:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'wayback-machine',
                type: 'tool',
                name: 'Wayback Machine',
                url: 'https://web.archive.org',
                category: 'archive',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Browse historical snapshots of websites',
                tags: ['archive', 'history', 'web', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://web.archive.org/static/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-06-01T08:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'whois-lookup',
                type: 'tool',
                name: 'WHOIS Lookup',
                url: 'https://whois.net',
                category: 'domain research',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Domain registration and ownership information',
                tags: ['domain', 'registration', 'ownership'],
                starred: false,
                pinned: false,
                favicon: 'https://whois.net/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-07-12T13:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'tineye',
                type: 'tool',
                name: 'TinEye',
                url: 'https://tineye.com',
                category: 'image analysis',
                intelligenceVaultCategories: ['mediaTools'], // Assign to 'Media Tools'
                description: 'Reverse image search engine',
                tags: ['image', 'reverse', 'search', 'verification'],
                starred: false,
                pinned: false,
                favicon: 'https://tineye.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-08-20T10:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },{
                id: 'tor-browser',
                type: 'tool',
                name: 'Tor Browser',
                url: 'https://www.torproject.org/',
                category: 'anonymity',
                intelligenceVaultCategories: ['darkWebTools'], // Assign to 'DarkWeb'
                description: 'Free and open-source software for enabling anonymous communication.',
                tags: ['anonymity', 'privacy', 'darkweb', 'browser'],
                starred: false,
                pinned: false,
                favicon: 'https://www.torproject.org/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-01T08:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'nmap',
                type: 'tool',
                name: 'Nmap (Network Mapper)',
                url: 'https://nmap.org/',
                category: 'network scanning',
                intelligenceVaultCategories: ['vulnerabilityTools'], // Assign to 'Vulnerability'
                description: 'Free and open-source utility for network discovery and security auditing.',
                tags: ['network', 'scanning', 'vulnerability', 'auditing'],
                starred: false,
                pinned: false,
                favicon: 'https://nmap.org/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-05T10:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'any-run',
                type: 'tool',
                name: 'Any.Run',
                url: 'https://any.run/',
                category: 'malware analysis',
                intelligenceVaultCategories: ['fileMalwareTools'], // Assign to 'File/Malware'
                description: 'Interactive malware analysis service for dynamic investigation of threats.',
                tags: ['malware', 'analysis', 'sandbox', 'threats'],
                starred: false,
                pinned: false,
                favicon: 'https://any.run/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-10T12:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'splunk-phantom',
                type: 'tool',
                name: 'Splunk SOAR (Phantom)',
                url: 'https://www.splunk.com/en_us/software/security-orchestration-automation-response-phantom.html',
                category: 'security orchestration',
                intelligenceVaultCategories: ['threatIntelligenceTools'], // Assign to 'Threat Intelligence'
                description: 'Security Orchestration, Automation, and Response platform.',
                tags: ['soar', 'automation', 'threat-intel', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.splunk.com/etc/designs/splunk-website/clientlibs-all/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-15T14:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'openai-chatgpt',
                type: 'tool',
                name: 'OpenAI ChatGPT',
                url: 'https://chat.openai.com/',
                category: 'ai assistant',
                intelligenceVaultCategories: ['aiTools'], // Assign to 'AI'
                description: 'AI-powered chatbot for various tasks including data summarization and idea generation.',
                tags: ['ai', 'chatbot', 'generative-ai', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://chat.openai.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-20T16:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            }
        ];

        const intelligenceVaultTabStructure = [
        {
            id: 'generalAndCore',
            name: 'General',
            icon: 'fas fa-globe-americas',
            children: [
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
                { id: 'aiTools', name: 'AI & Generative', icon: 'fas fa-brain' },
                { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' }, // NEW
                { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' }, // NEW
            ]
        },
        {
            id: 'identityAndSocial',
            name: 'Identity/Social',
            icon: 'fas fa-users',
            children: [
                { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
                { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' }, // NEW
                { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' }, // NEW
            ]
        },
        {
            id: 'technicalFootprints',
            name: 'Footprints',
            icon: 'fas fa-fingerprint',
            children: [
                { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' }, // Name adjusted for clarity
                { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' }, // Name adjusted
                { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' }, // Name adjusted
                { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' }, // NEW
                { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' }, // NEW
            ]
        },
        {
            id: 'cybersecurityIntel',
            name: 'Threat Intel',
            icon: 'fas fa-shield-alt',
            children: [
                { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' }, // NEW (Font Awesome 6)
                { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' }, // NEW
            ]
        },
        {
            id: 'breachAndLeaks',
            name: 'Breach/Leaks',
            icon: 'fas fa-database',
            children: [
                { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' }, // Renamed from passwordTools
                { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' }, // Renamed from Dump Search Engines
                { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' }, // NEW (Font Awesome 6)
            ]
        },
        {
            id: 'undergroundSources',
            name: 'Forums/Markets',
            icon: 'fas fa-user-ninja',
            children: [
                { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' }, // Name adjusted
                { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
                { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' }, // NEW (Font Awesome Brands)
                { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' }, // NEW
            ]
        },
        // NEW PARENT CATEGORY: Media Analysis
        {
            id: 'mediaAnalysis',
            name: 'Media',
            icon: 'fas fa-image',
            children: [
                { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' }, // Moved from Identity & Social
                { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' }, // NEW
                { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' }, // NEW
                { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' }, // NEW (Font Awesome 6)
                { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' }, // NEW
            ]
        },
        // NEW PARENT CATEGORY: Operational Security (OPSEC)
        {
            id: 'opsec',
            name: 'OpSec',
            icon: 'fas fa-lock',
            children: [
                { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' }, // Broadening DarkWebTools concept
                { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' }, // NEW
                { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' }, // NEW
                { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' }, // NEW
            ]
        },
        ];

        const customVaultEntryStructure = [{
            id: 'coreInvestigation',
            name: 'General',
            icon: 'fas fa-globe-americas',
            children: [
                { id: 'tool', name: 'General Tools', icon: 'fas fa-tools' }, // Matches entry.type 'tool'
                { id: 'keyword', name: 'Keyword & Text Analysis', icon: 'fas fa-font' }, // Matches entry.type 'keyword'
                { id: 'ai', name: 'AI & Generative', icon: 'fas fa-brain' }, // Placeholder, needs actual entry.type if not 'tool'
                { id: 'osintSearch', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' }, // Placeholder
                { id: 'archive', name: 'Archiving & Cache', icon: 'fas fa-archive' }, // Matches entry.type 'archive'
            ]
        }, {
            id: 'identityCommunication',
            name: 'Identity/Social',
            icon: 'fas fa-users',
            children: [
                { id: 'username', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'social', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'email', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phone', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messaging', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
                { id: 'dating', name: 'Dating Apps', icon: 'fas fa-heart' },
                { id: 'persona', name: 'Persona Management', icon: 'fas fa-id-badge' },
                { id: 'facial', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
            ]
        }, {
            id: 'digitalTrace',
            name: 'Footprints',
            icon: 'fas fa-fingerprint',
            children: [
                { id: 'domain', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
                { id: 'location', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'crypto', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
                { id: 'darkWeb', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
                { id: 'metadata', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'network', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
                { id: 'document', name: 'Document Analysis', icon: 'fas fa-file-alt' },
                { id: 'link', name: 'General Links', icon: 'fas fa-external-link-alt' },
            ]
        }, {
            id: 'cyberIntel',
            name: 'Threat Intel',
            icon: 'fas fa-shield-alt',
            children: [
                { id: 'threat', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerability', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'malware', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypot', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
                { id: 'exploit', name: 'Exploit/Market', icon: 'fas fa-bomb' },
            ]
        }, {
            id: 'breachAndLeak',
            name: 'Breach/Leaks',
            icon: 'fas fa-database',
            children: [
                { id: 'password', name: 'Password Leaks', icon: 'fas fa-key' },
                { id: 'credential', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'breach', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'publicrecord', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },
            ]
        }, {
            id: 'undergroundSource',
            name: 'Forums/Markets',
            icon: 'fas fa-user-ninja',
            children: [
                { id: 'forum', name: 'Hacking & Security Forums', icon: 'fas fa-comments' },
                { id: 'vendor', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegram', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
                { id: 'paste', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },
            ]
        }, {
            id: 'mediaAnalysis',
            name: 'Media',
            icon: 'fas fa-image',
            children: [
                { id: 'media', name: 'Image & Video Analysis', icon: 'fas fa-camera' },
                { id: 'audio', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
            ]
        }, {
            id: 'opsecurity',
            name: 'OpSec',
            icon: 'fas fa-lock',
            children: [
                { id: 'vpn', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
                { id: 'secureComm', name: 'Secure Communication', icon: 'fas fa-lock-open' },
                { id: 'persona', name: 'Persona Management', icon: 'fas fa-id-badge' },
            ]
        }, ];



        let notesState = {
            notes: [],
            currentNote: null,
            editMode: false,
            noteSortFilter: localStorage.getItem('noteSortFilter') || 'updated_desc'
        };

        const defaultThreatHuntingScripts = [
    {
        id: 'th-sysmon-proc-creation',
        name: 'Sysmon Process Creation Anomalies',
        description: 'PowerShell script to query Sysmon Event ID 1 (Process Creation) logs for suspicious executables launched from unusual directories (e.g., AppData, Temp) or by unusual parent processes.',
        language: 'powershell',
        code: `
        # Requires Sysmon Event ID 1 logging enabled
        # Searches for suspicious process creations

        $logName = "Microsoft-Windows-Sysmon/Operational"
        $eventName = 1 # Event ID for Process Create

        $suspiciousPaths = @(
            "\\AppData\\Local\\Temp\\",
            "\\Windows\\Temp\\",
            "\\ProgramData\\",
            "\\Users\\Public\\",
            "\\PerfLogs\\"
        )

        $suspiciousParents = @(
            "mshta.exe",
            "wscript.exe",
            "cscript.exe",
            "rundll32.exe",
            "regsvr32.exe",
            "cmd.exe",
            "powershell.exe"
        )

        Write-Host "Searching for Sysmon Event ID 1 (Process Create) with suspicious characteristics..."
        Write-Host "--------------------------------------------------------------------------------"

        Get-WinEvent -LogName $logName -FilterXPath "*[System[(EventID=$eventName)]]" -MaxEvents 5000 | ForEach-Object {
            $event = $_
            $eventData = [xml]$event.ToXml()
            $processName = $eventData.Event.EventData.Data | Where-Object {$_.Name -eq 'Image'} | Select-Object -ExpandProperty '#text'
            $parentProcessName = $eventData.Event.EventData.Data | Where-Object {$_.Name -eq 'ParentImage'} | Select-Object -ExpandProperty '#text'
            $commandLine = $eventData.Event.EventData.Data | Where-Object {$_.Name -eq 'CommandLine'} | Select-Object -ExpandProperty '#text'
            $originalFileName = $eventData.Event.EventData.Data | Where-Object {$_.Name -eq 'OriginalFileName'} | Select-Object -ExpandProperty '#text'

            $isSuspiciousPath = $false
            foreach ($path in $suspiciousPaths) {
                if ($processName -like "*$path*") {
                    $isSuspiciousPath = $true
                    break
                }
            }

            $isSuspiciousParent = $false
            foreach ($parent in $suspiciousParents) {
                if ($parentProcessName -like "*$parent*") {
                    $isSuspiciousParent = $true
                    break
                }
            }
            
            if ($isSuspiciousPath -or $isSuspiciousParent) {
                Write-Host "Timestamp: $($event.TimeCreated)" -ForegroundColor Cyan
                Write-Host "Process:   $processName" -ForegroundColor Yellow
                Write-Host "Parent:    $parentProcessName" -ForegroundColor Yellow
                Write-Host "Command:   $commandLine" -ForegroundColor Green
                Write-Host "Reason:    Possible execution from suspicious path or by suspicious parent." -ForegroundColor Red
                Write-Host "---"
            }
        }
        Write-Host "Search complete."
                `,
                tags: ['sysmon', 'powershell', 'endpoint', 'process', 'anomalies', 'detection'],
                addedDate: new Date('2025-05-15T10:00:00Z'),
                usageCount: 0
            },
            {
                id: 'th-python-ip-reputation',
                name: 'Python IP Reputation Checker',
                description: 'Python script that takes a list of IP addresses and checks their reputation against a public API (e.g., ipinfo.io or VirusTotal, simplified example).',
                language: 'python',
                code: `
        import requests
        import json

        # IMPORTANT: This is a simplified example.
        # For a real-world script, you would use proper API keys
        # and handle rate limiting, errors, and specific API responses.
        # Example: Using ipinfo.io (free tier has limits)

        API_TOKEN = "YOUR_IPINFO_API_TOKEN" # Replace with your actual token
        IP_LIST = [
            "1.1.1.1", # Cloudflare DNS
            "8.8.8.8", # Google DNS
            "185.199.108.153", # Example potentially malicious IP (replace with actual IOCs)
            "92.204.148.169" # Example another IP
        ]

        print("Checking IP Reputation...")
        print("-" * 30)

        for ip in IP_LIST:
            try:
                response = requests.get(f"https://ipinfo.io/{ip}/json?token={API_TOKEN}")
                response.raise_for_status() # Raise an exception for HTTP errors (4xx or 5xx)
                data = response.json()

                print(f"IP: {ip}")
                print(f"  Country: {data.get('country', 'N/A')}")
                print(f"  Org:     {data.get('org', 'N/A')}")
                print(f"  Hostname: {data.get('hostname', 'N/A')}")
                print(f"  Location: {data.get('loc', 'N/A')}")

                # Add more reputation checks here (e.g., against VirusTotal, AbuseIPDB if you have APIs)
                # For demonstration, we'll just flag certain IPs
                if ip == "185.199.108.153": # This is a placeholder for a known bad IP
                    print("  Reputation: !!! SUSPICIOUS - Known Malicious (Example) !!!")
                else:
                    print("  Reputation: No immediate flag (Requires deeper analysis)")
                
                print("-" * 30)

            except requests.exceptions.RequestException as e:
                print(f"Error checking {ip}: {e}")
            except json.JSONDecodeError:
                print(f"Error decoding JSON response for {ip}")
            except Exception as e:
                print(f"An unexpected error occurred for {ip}: {e}")

        print("IP reputation check complete.")
                `,
                tags: ['network', 'ip', 'reputation', 'python', 'api'],
                addedDate: new Date('2025-05-20T14:30:00Z'),
                usageCount: 0
            },
            {
                id: 'th-bash-web-log-parser',
                name: 'Bash Web Log Parser',
                description: 'Bash script to quickly parse Apache/Nginx access logs for unusual HTTP status codes, suspicious user agents, or high request counts from a single IP.',
                language: 'bash',
                code: `
        #!/bin/bash

        LOG_FILE="/var/log/apache2/access.log" # Adjust path for your log file
        THRESHOLD_REQUESTS=500 # IP requests over this threshold
        SUSPICIOUS_STATUS_CODES="400|401|403|404|405|408|429|500|502|503|504" # Common error/client/server errors
        SUSPICIOUS_USER_AGENTS="sqlmap|nmap|curl|wget|nessus|nikto|bot|scanner" # Common scanning tools

        echo "Analyzing web server logs: \${LOG_FILE}"
        echo "-------------------------------------"

        if [[ ! -f "\${LOG_FILE}" ]]; then
            echo "Error: Log file not found at \${LOG_FILE}"
            exit 1
        fi

        echo "--- Top 10 IPs by Request Count ---"
        awk '{print \$1}' "\${LOG_FILE}" | sort | uniq -c | sort -nr | head -n 10
        echo ""

        echo "--- Requests with Suspicious Status Codes ---"
        grep -E "HTTP/1\\\.[01]\" (\${SUSPICIOUS_STATUS_CODES})" "\${LOG_FILE}" | head -n 20 # Show first 20 matches
        echo ""

        echo "--- Requests with Suspicious User Agents ---"
        grep -iE "User-Agent:.*(\${SUSPICIOUS_USER_AGENTS})" "\${LOG_FILE}" | head -n 20 # Show first 20 matches
        echo ""

        echo "--- IPs with High Request Counts (over \${THRESHOLD_REQUESTS}) ---"
        awk '{print \$1}' "\${LOG_FILE}" | sort | uniq -c | sort -nr | awk -v thresh="\$THRESHOLD_REQUESTS" '\$1 > thresh {print \$0}'
        echo ""

        echo "Log analysis complete."
                `,
                tags: ['logs', 'web', 'bash', 'network', 'detection'],
                addedDate: new Date('2025-05-25T09:15:00Z'),
                usageCount: 0
            }
        ];

        // OSINT Handbook main functionality
        const handbookData = {
        sections: [
            {
            id: "getting-started",
            title: "Getting Started",
            icon: "fas fa-rocket",
            content: `
                <h2>Getting Started with OSINT</h2>
                <p>Open Source Intelligence (OSINT) is the collection and analysis of information from publicly available sources. This handbook will guide you through essential techniques, tools, and methodologies.</p>
                
                <h3>Basic Principles</h3>
                <p>Remember these fundamental principles when conducting OSINT investigations:</p>
                <ul>
                <li>Use secure, anonymous connections (VPNs, Tor)</li>
                <li>Create separate research personas</li>
                <li>Document everything</li>
                <li>Verify information through multiple sources</li>
                <li>Follow legal and ethical guidelines</li>
                </ul>
            `,
            },
            {
            id: "osint-framework",
            title: "OSINT Framework Overview",
            icon: "fas fa-sitemap",
            content: `
                <h2>OSINT Framework Overview</h2>
                <p>The OSINT Framework provides a structured approach to gathering intelligence across various domains.</p>
                
                <h3>Key Components</h3>
                <ul>
                <li><strong>Reconnaissance</strong>: Initial information gathering</li>
                <li><strong>Identification</strong>: Pinpointing relevant data sources</li>
                <li><strong>Collection</strong>: Systematic gathering of intelligence</li>
                <li><strong>Processing</strong>: Organizing and filtering collected data</li>
                <li><strong>Analysis</strong>: Deriving insights and connections</li>
                <li><strong>Reporting</strong>: Documenting findings in a structured format</li>
                </ul>
                
                <h3>OSINT Cycle</h3>
                <p>The OSINT process is cyclical, with each phase informing the next. As new information is discovered, you may need to revisit earlier phases to refine your search parameters.</p>
                
                <div class="code-block">
                <pre><code>Planning → Collection → Processing → Analysis → Dissemination → Feedback → Planning</code></pre>
                <button class="copy-btn" data-clipboard-target="#osint-cycle-code"><i class="fas fa-copy"></i></button>
                </div>
            `,
            },
            {
            id: "tools-category",
            title: "Tools by Category",
            icon: "fas fa-tools",
            isCategory: true,
            subcategories: [
                {
                id: "people-search",
                title: "People Search",
                icon: "fas fa-user-secret",
                content: `
                    <h2>People Search Tools</h2>
                    <p>These tools help locate and gather information about individuals through public records, social media, and other sources.</p>
                    
                    <h3>Essential Tools</h3>
                    <ul>
                    <li><strong>Pipl</strong>: Comprehensive people search engine</li>
                    <li><strong>BeenVerified</strong>: Background check service</li>
                    <li><strong>Spokeo</strong>: People search and public records</li>
                    <li><strong>PeekYou</strong>: Searches across social networks</li>
                    <li><strong>WebMii</strong>: Person-centric web search</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Validate a phone number pattern */
        const validatePhone = (phone) => {
            const regex = /^(\+\d{1,2}\s)?\(?\d{3}\)?[\s.-]\d{3}[\s.-]\d{4}$/;
            return regex.test(phone);
        }</code></pre>
                    <button class="copy-btn" data-clipboard-target="#phone-validate-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">people</span>
                    <span class="tag">social</span>
                    <span class="tag">identity</span>
                    <span class="tag">background</span>
                    </div>
                `,
                },
                {
                id: "domain-whois",
                title: "Domain/WHOIS",
                icon: "fas fa-globe",
                content: `
                    <h2>Domain & WHOIS Investigation Tools</h2>
                    <p>These tools allow investigators to gather information about domain registrations, ownership, and infrastructure.</p>
                    
                    <h3>Key Tools</h3>
                    <ul>
                    <li><strong>WHOIS Lookup</strong>: Domain registration information</li>
                    <li><strong>DomainTools</strong>: Domain profile and history</li>
                    <li><strong>ViewDNS.info</strong>: Multiple DNS research tools</li>
                    <li><strong>Shodan</strong>: Internet-connected device search engine</li>
                    <li><strong>SecurityTrails</strong>: Historical DNS data</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Basic WHOIS lookup using command line */
        whois example.com

        /* Reverse IP lookup using host command */
        host example.com</code></pre>
                    <button class="copy-btn" data-clipboard-target="#whois-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">domain</span>
                    <span class="tag">dns</span>
                    <span class="tag">hosting</span>
                    <span class="tag">infrastructure</span>
                    </div>
                `,
                },
                {
                id: "crypto-tracking",
                title: "Crypto Tracking",
                icon: "fas fa-coins",
                content: `
                    <h2>Cryptocurrency Tracking Tools</h2>
                    <p>These tools help track and analyze cryptocurrency transactions, wallets, and entities across various blockchains.</p>
                    
                    <h3>Essential Tools</h3>
                    <ul>
                    <li><strong>Blockchain.com Explorer</strong>: Bitcoin blockchain analysis</li>
                    <li><strong>Etherscan</strong>: Ethereum blockchain explorer</li>
                    <li><strong>Chainalysis</strong>: Advanced cryptocurrency investigation</li>
                    <li><strong>CipherTrace</strong>: Financial crime tracking in crypto</li>
                    <li><strong>Crystal Blockchain</strong>: Crypto AML and analytics</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Example API call to get Bitcoin address information */
        curl -X GET "https://blockchain.info/rawaddr/1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"</code></pre>
                    <button class="copy-btn" data-clipboard-target="#crypto-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">crypto</span>
                    <span class="tag">blockchain</span>
                    <span class="tag">bitcoin</span>
                    <span class="tag">ethereum</span>
                    </div>
                `,
                }
            ]
            },
            {
            id: "techniques",
            title: "Techniques",
            icon: "fas fa-lightbulb",
            isCategory: true,
            subcategories: [
                {
                id: "pivoting",
                title: "Pivoting",
                icon: "fas fa-network-wired",
                content: `
                    <h2>Pivoting Techniques</h2>
                    <p>Pivoting is the process of using discovered information to find new leads and expand your investigation.</p>
                    
                    <h3>Key Pivoting Methods</h3>
                    <ul>
                    <li><strong>Email Pivoting</strong>: Use email addresses to discover accounts across platforms</li>
                    <li><strong>Username Pivoting</strong>: Track usernames across multiple services</li>
                    <li><strong>Image Pivoting</strong>: Use reverse image search to find related content</li>
                    <li><strong>Network Pivoting</strong>: Map connections between people and organizations</li>
                    <li><strong>Domain Pivoting</strong>: Find related websites and infrastructure</li>
                    </ul>
                    
                    <h3>Practical Example</h3>
                    <p>Starting with an email address, you might:</p>
                    <ol>
                    <li>Check email breach databases for password history</li>
                    <li>Search for the email in document metadata</li>
                    <li>Use the username portion to search social platforms</li>
                    <li>Look up the domain for related websites</li>
                    <li>Search for the email in forum posts and comments</li>
                    </ol>
                    
                    <div class="tag-section">
                    <span class="tag">pivoting</span>
                    <span class="tag">methodology</span>
                    <span class="tag">investigation</span>
                    </div>
                `,
                },
                {
                id: "sock-puppets",
                title: "Sock Puppet Accounts",
                icon: "fas fa-user-secret",
                content: `
                    <h2>Sock Puppet Accounts</h2>
                    <p>Sock puppets are alternate online identities created for research purposes to protect your real identity during investigations.</p>
                    
                    <h3>Creation Guidelines</h3>
                    <ul>
                    <li>Use a dedicated device or VM if possible</li>
                    <li>Always access through VPN/Tor</li>
                    <li>Create a complete, consistent backstory</li>
                    <li>Use generated photos for profiles (never your own)</li>
                    <li>Maintain regular activity to build history</li>
                    <li>Never connect to personal accounts or information</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* OPSEC checklist for sock puppets */
        1. Separate email account
        2. Unique username not used elsewhere
        3. Unique password not used elsewhere
        4. 2FA on a dedicated device
        5. Consistent profile details
        6. Regular login patterns
        7. No personal information leakage</code></pre>
                    <button class="copy-btn" data-clipboard-target="#sockpuppet-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">identity</span>
                    <span class="tag">opsec</span>
                    <span class="tag">anonymity</span>
                    </div>
                `,
                }
            ]
            },
            {
            id: "cheat-sheets",
            title: "Cheat Sheets",
            icon: "fas fa-file-alt",
            isCategory: true,
            subcategories: [
                {
                id: "command-line",
                title: "Command Line Tools",
                icon: "fas fa-terminal",
                content: `
                    <h2>Command Line OSINT Tools</h2>
                    <p>These command-line tools can significantly enhance your OSINT capabilities and automation.</p>
                    
                    <h3>Essential CLI Tools</h3>
                    <div class="code-block">
                    <pre><code># Recon-ng - Full-featured reconnaissance framework
        pip install recon-ng

        # TheHarvester - Email, subdomain and name harvester
        theHarvester -d example.com -b google,linkedin

        # Sherlock - Hunt down social media accounts by username
        python3 sherlock username

        # Amass - In-depth DNS enumeration
        amass enum -d example.com

        # Shodan CLI - Internet device search
        shodan search --fields ip_str,port,org,hostnames apache</code></pre>
                    <button class="copy-btn" data-clipboard-target="#cli-tools-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <h3>Quick Reference: Google Dorks</h3>
                    <div class="code-block">
                    <pre><code># Find specific file types
        filetype:pdf "confidential"

        # Search within a site
        site:example.com password

        # Find exposed directories
        intitle:"index of" "parent directory"

        # Find exposed cameras
        intitle:"webcamXP 5"

        # Find exposed databases
        intitle:"Index of" phpmyadmin</code></pre>
                    <button class="copy-btn" data-clipboard-target="#google-dorks-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">cli</span>
                    <span class="tag">terminal</span>
                    <span class="tag">automation</span>
                    <span class="tag">dorks</span>
                    </div>
                `,
                }
            ]
            }
        ]
        };

        function initApp() {
            loadDorkAssistantState(); // Load the dork assistant state first
            loadState(); // This loads all other appState data, including timeline and case studies.
            parseShareableLink();
            updateStats();
            bindEvents();
            initTheme();

            checkAndShowDesktopRecommendation();

            const validTabs = ['dashboard', 'intelligence-vault', 'custom-tabs', 'timeline', 'threats', 'handbook', 'dork-assistant', 'case-studies', 'threat-hunting'];
            if (!validTabs.includes(appState.currentTab)) {
                appState.currentTab = 'dashboard';
            }

            switchTab(appState.currentTab); // This will call renderIntelligenceEntries, renderTimelineEvents, renderCaseStudies, etc.

            // This is the correct place to call the enhanced random discovery
            showRandomDiscovery(); 
            
            populateCategoryFilter();
            updateDashboard(); // Calls all dashboard rendering functions, including charts
            applyReadOnlyMode();
            

            const viewToggleButtons = document.querySelectorAll('#viewToggle, #vaultViewToggle, #customVaultViewToggle');
            viewToggleButtons.forEach(btn => {
                if (appState.viewMode === 'grid') {
                    btn.innerHTML = '<i class="fas fa-list"></i> List View';
                    btn.title = 'Switch to List View';
                } else {
                    btn.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    btn.title = 'Switch to Grid View';
                }
            });
        }
        // --- End of initApp (full code block) ---

        function switchTab(tabName) {
            // Update main tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                // Hide specific sub-tab containers when switching main tabs
                if (content.id === 'intelligence-vaultTab') {
                    document.getElementById('intelligenceVaultParentTabs').style.display = 'none';
                    document.getElementById('intelligenceVaultChildTabs').style.display = 'none';
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
                } else if (content.id === 'custom-tabsTab') {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'none';
                    document.getElementById('customVaultEntryChildTabs').style.display = 'none';
                    document.getElementById('addEntryBtnCustomVault').style.display = 'none';
                }
            });

            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                targetTabContent.classList.add('active');
            }

            // Update appState and clear filters for new tab
            appState.currentTab = tabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = '';
            document.getElementById('searchInput').value = '';

            // Specific logic for each main tab
            if (tabName === 'intelligence-vault') {
                document.getElementById('intelligenceVaultParentTabs').style.display = 'flex'; // Show parent tabs
                renderIntelligenceVaultParentTabs(); // This will populate parent tabs and activate current one

                const currentIntelParent = intelligenceVaultTabStructure.find(p => p.id === appState.currentIntelligenceVaultParentTab);
                if (!currentIntelParent) {
                    appState.currentIntelligenceVaultParentTab = intelligenceVaultTabStructure[0].id;
                }
                switchIntelligenceVaultParentTab(appState.currentIntelligenceVaultParentTab);

                if (!appState.readOnlyMode) {
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'inline-flex';
                }
                renderIntelligenceEntries(); // Render entries specific to intelligence-vault

            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render main custom tabs (the list of custom vaults)

                if (appState.customTabs.length > 0) {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'flex'; // Show parent tabs for entries
                    renderCustomVaultParentTabs(); // Render custom vault entry parent tabs

                    const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
                    if (!currentCustomParent) {
                        appState.currentCustomVaultParentTab = customVaultEntryStructure[0].id;
                    }
                    const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                    if (!currentCustomChild) {
                        appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                    }
                    switchCustomVaultParentTab(appState.currentCustomVaultParentTab);

                    if (!appState.readOnlyMode) {
                        document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                    }
                }
                renderIntelligenceEntries(); // Render entries specific to custom-tabs

            } else if (tabName === 'timeline') {
                renderTimelineEvents();
            } else if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'handbook') {
                initHandbookAndNotes();
            } else if (tabName === 'dork-assistant') {
                initDorkAssistant();
            } else if (tabName === 'case-studies') { // Handle Case Studies tab
                renderCaseStudies(); // Now call renderCaseStudies to display content
                // Reset filters for case studies specifically when entering the tab
                appState.caseStudyFilters.search = '';
                appState.caseStudyFilters.type = '';
                document.getElementById('caseStudySearchInput').value = '';
                document.getElementById('caseStudyFilterSelect').value = '';
            } else if (tabName === 'threat-hunting') { // Handle Threat Hunting tab
                initThreatHuntingToolkit();
                // Ensure the 'script-library' sub-tab is explicitly activated
                switchThSubTab('script-library'); 
            }

            saveState(); // Save state after tab switch
        }

        // --- Start of loadCaseStudiesData (utility function) ---
        // This function should be called within loadState to handle persistence
        function loadCaseStudiesData() {
            const savedCaseStudies = localStorage.getItem('osintCaseStudies');
            if (savedCaseStudies) {
                try {
                    const parsed = JSON.parse(savedCaseStudies);
                    if (Array.isArray(parsed)) {
                        return parsed.map(cs => ({
                            ...cs,
                            addedDate: cs.addedDate ? new Date(cs.addedDate) : null,
                            starred: typeof cs.starred === 'undefined' ? false : cs.starred,
                            pinned: typeof cs.pinned === 'undefined' ? false : cs.pinned
                        }));
                    }
                } catch (e) {
                    console.error("Error parsing saved case studies, loading sample data:", e);
                }
            }
            // If no saved data, or parsing failed, return sample data
            return sampleCaseStudies.map(cs => ({
                ...cs,
                addedDate: new Date(cs.addedDate) // Ensure sample dates are Date objects
            }));
        }
        // --- End of loadCaseStudiesData ---


        // NEW: Render Intelligence Vault Parent Tabs
        function renderIntelligenceVaultParentTabs() {
            const parentTabsContainer = document.getElementById('intelligenceVaultParentTabs');
            if (!parentTabsContainer) return;

            // Clear previous content to ensure new buttons are rendered clean
            parentTabsContainer.innerHTML = ''; 

            intelligenceVaultTabStructure.map(parentTab => {
                const button = document.createElement('button');
                button.classList.add('nav-tab', 'intelligence-vault-parent-tab');
                button.dataset.parentTab = parentTab.id;
                button.innerHTML = `<i class="${parentTab.icon}"></i> ${parentTab.name}`;
                parentTabsContainer.appendChild(button);
            });

            // Re-attach event listener using delegation to the container (if it exists, and not already done)
            // This listener is now only set up once in bindEvents to avoid duplicates.
            // When renderIntelligenceVaultParentTabs is called, it just re-populates the innerHTML.
            // The event listener is attached to the parentTabsContainer, which persists.

            // Activate the currently selected parent tab
            const activeParentBtn = parentTabsContainer.querySelector(`.intelligence-vault-parent-tab[data-parent-tab="${appState.currentIntelligenceVaultParentTab}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }
        }


        // NEW: Switch Intelligence Vault Parent Tab
        function switchIntelligenceVaultParentTab(parentId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all parent tabs
            document.querySelectorAll('#intelligenceVaultParentTabs .intelligence-vault-parent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked parent tab
            const activeParentBtn = document.querySelector(`#intelligenceVaultParentTabs .intelligence-vault-parent-tab[data-parent-tab="${parentId}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }

            appState.currentIntelligenceVaultParentTab = parentId;

            // Find the selected parent tab's children
            const selectedParent = intelligenceVaultTabStructure.find(p => p.id === parentId);
            const childTabsContainer = document.getElementById('intelligenceVaultChildTabs'); // Get the direct reference

            if (selectedParent && childTabsContainer) {
                childTabsContainer.style.display = 'flex'; // Show the child tabs container
                // Update the innerHTML of the existing container
                childTabsContainer.innerHTML = selectedParent.children.map(childTab => `
                    <button class="sub-nav-tab intelligence-vault-child-tab" data-child-tab="${childTab.id}">
                        <i class="${childTab.icon}"></i> ${childTab.name}
                    </button>
                `).join('');

                // The click listener for child tabs is already delegated to `intelligenceVaultChildTabsContainer`
                // in `bindEvents()`, so no need to re-add it here.

                // Automatically activate the first child tab or the previously selected child tab under this parent
                let childToActivate = appState.currentIntelligenceVaultChildTab;
                if (!selectedParent.children.some(c => c.id === childToActivate)) {
                    childToActivate = selectedParent.children[0]?.id; // Default to first child if current is not in this parent
                }
                if (childToActivate) {
                    switchIntelligenceVaultChildTab(childToActivate);
                } else {
                    // No child tabs for this parent, clear display
                    appState.currentIntelligenceVaultChildTab = null;
                    appState.filters.category = '';
                    renderIntelligenceEntries();
                }

            } else {
                childTabsContainer.style.display = 'none'; // Hide if no children or container not found
                appState.currentIntelligenceVaultChildTab = null;
                appState.filters.category = '';
                renderIntelligenceEntries();
            }

            saveState(); // Save the parent tab state
        }

        // MODIFIED: Switch Intelligence Vault Child Sub-tabs (now show tools)
        // This function now expects a 'childId' which maps directly to the `intelligenceVaultCategories` (tools, emailTools, etc.)
        function switchIntelligenceVaultChildTab(childId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all child tabs
            document.querySelectorAll('#intelligenceVaultChildTabs .intelligence-vault-child-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked child tab
            const targetChildTabBtn = document.querySelector(`#intelligenceVaultChildTabs .intelligence-vault-child-tab[data-child-tab="${childId}"]`);
            if (targetChildTabBtn) {
                targetChildTabBtn.classList.add('active');
            }

            appState.currentIntelligenceVaultChildTab = childId;
            appState.filters.category = ''; // Clear category filter when switching intel vault sub-tabs
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant tools
            saveState(); // Save the child tab state
        }

        // --- Start of loadState (full code block) ---
        function loadState() {
            const savedState = localStorage.getItem('osintArsenalState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);

                // Explicitly initialize all array properties with empty arrays first,
                // so they are never undefined, even if not present in older savedState.
                appState.tools = [];
                appState.emails = [];
                appState.phones = [];
                appState.crypto = [];
                appState.locations = [];
                appState.links = [];
                appState.media = [];
                appState.passwords = [];
                appState.keywords = [];
                appState.socials = [];
                appState.domains = [];
                appState.usernames = [];
                appState.threats = [];
                appState.vulnerabilities = [];
                appState.malware = [];
                appState.breaches = [];
                appState.credentials = [];
                appState.forums = [];
                appState.vendors = [];
                appState.telegramChannels = [];
                appState.pastes = [];
                appState.documents = [];
                appState.networks = [];
                appState.metadataEntries = [];
                appState.archives = [];
                appState.messagingApps = [];
                appState.datingProfiles = [];
                appState.audioEntries = [];
                appState.facialRecognition = [];
                appState.personas = [];
                appState.vpns = [];
                appState.honeypots = [];
                appState.exploits = [];
                appState.publicRecords = [];
                appState.caseStudies = []; // Ensure initialized as empty array
                appState.threatHuntingScripts = []; // NEW: Initialize threatHuntingScripts as empty array

                // Now, populate from parsedState, safely falling back to empty arrays if null/undefined
                appState.tools = (parsedState.tools || []).map(entry => ({
                    ...entry,
                    addedDate: entry.addedDate ? new Date(entry.addedDate) : null,
                    lastUsed: entry.lastUsed || 0,
                    customTabs: entry.customTabs || [],
                    intelligenceVaultCategories: entry.intelligenceVaultCategories || [],
                    origin: entry.origin || 'user-added'
                }));

                appState.emails = (parsedState.emails || []).map(entry => ({
                    ...entry,
                    linkedPlatforms: entry.linkedPlatforms || []
                }));

                appState.phones = parsedState.phones || [];

                appState.crypto = (parsedState.crypto || []).map(entry => ({
                    ...entry,
                    amount: parseFloat(entry.amount) || 0
                }));

                appState.locations = parsedState.locations || [];

                appState.links = parsedState.links || [];

                appState.media = (parsedState.media || []).map(entry => ({
                    ...entry,
                    base64Data: entry.base64Data || ''
                }));

                appState.passwords = parsedState.passwords || [];

                appState.keywords = parsedState.keywords || [];

                appState.socials = parsedState.socials || [];

                appState.domains = parsedState.domains || [];

                appState.usernames = parsedState.usernames || [];

                appState.threats = parsedState.threats || [];

                appState.vulnerabilities = (parsedState.vulnerabilities || []).map(entry => ({
                    ...entry,
                    cvss: parseFloat(entry.cvss) || 0
                }));

                appState.malware = parsedState.malware || [];

                appState.breaches = (parsedState.breaches || []).map(entry => ({
                    ...entry,
                    records: parseInt(entry.records) || 0
                }));

                appState.credentials = parsedState.credentials || [];

                appState.forums = parsedState.forums || [];

                appState.vendors = parsedState.vendors || [];

                appState.telegramChannels = (parsedState.telegramChannels || []).map(entry => ({
                    ...entry,
                    subscribers: parseInt(entry.subscribers) || 0
                }));

                appState.pastes = parsedState.pastes || [];

                appState.documents = parsedState.documents || [];

                appState.networks = parsedState.networks || [];

                appState.metadataEntries = parsedState.metadataEntries || [];

                appState.archives = (parsedState.archives || []).map(entry => ({
                    ...entry,
                    timestamp: entry.timestamp ? new Date(entry.timestamp).getTime() : null
                }));

                appState.messagingApps = (parsedState.messagingApps || []);

                appState.datingProfiles = (parsedState.datingProfiles || []).map(entry => ({
                    ...entry,
                    age: parseInt(entry.age) || null
                }));

                appState.audioEntries = (parsedState.audioEntries || []).map(entry => ({
                    ...entry,
                    base64Data: entry.base64Data || ''
                }));

                appState.facialRecognition = parsedState.facialRecognition || [];

                appState.personas = parsedState.personas || [];

                appState.vpns = parsedState.vpns || [];

                appState.honeypots = parsedState.honeypots || [];

                appState.exploits = parsedState.exploits || [];

                appState.publicRecords = parsedState.publicRecords || [];

                appState.threatHuntingScripts = (parsedState.threatHuntingScripts || []).map(script => ({ // NEW
                    ...script,
                    addedDate: script.addedDate ? new Date(script.addedDate) : null,
                    usageCount: script.usageCount || 0
                }));

                // Correctly load case studies data
                appState.caseStudies = loadCaseStudiesData(); // This handles merging with sample data if localStorage is empty for case studies.

                // Timeline Events
                appState.timeline = parsedState.timeline || { events: [] };
                appState.timeline.events.forEach(event => {
                    if (typeof event.timestamp === 'string') {
                        event.timestamp = new Date(event.timestamp);
                    }
                });

                // Ensure other appState properties are loaded/initialized safely
                appState.selectedEntries = new Set(Array.isArray(parsedState.selectedEntries) ? parsedState.selectedEntries : []);
                appState.filters = parsedState.filters || {
                    category: '',
                    search: '',
                    sort: 'name',
                    searchScope: 'currentTab'
                };
                appState.caseStudyFilters = parsedState.caseStudyFilters || {
                    search: '',
                    type: ''
                };
                appState.scriptFilters = parsedState.scriptFilters || { // NEW
                    search: '',
                    language: ''
                };
                appState.theme = parsedState.theme || 'dark';
                appState.viewMode = parsedState.viewMode || 'grid';
                appState.usageStats = parsedState.usageStats || { toolsUsedToday: 0 };
                appState.customTabs = parsedState.customTabs || [];
                appState.currentCustomTab = parsedState.currentCustomTab && appState.customTabs.some(t => t.id === parsedState.currentCustomTab) ? parsedState.currentCustomTab : (appState.customTabs.length > 0 ? appState.customTabs[0].id : null);
                appState.currentIntelligenceVaultParentTab = parsedState.currentIntelligenceVaultParentTab || 'generalAndCore';
                appState.currentIntelligenceVaultChildTab = parsedState.currentIntelligenceVaultChildTab || 'tools';
                appState.currentCustomVaultParentTab = parsedState.currentCustomVaultParentTab || 'coreInvestigation';
                appState.currentCustomVaultEntrySubTab = parsedState.currentCustomVaultEntrySubTab || 'tool';
                appState.currentThSubTab = parsedState.currentThSubTab || 'script-library'; // NEW


                // Notes State
                appState.notesState = parsedState.notesState || { notes: [], currentNote: null, editMode: false, noteSortFilter: 'updated_desc' };
                appState.notesState.notes.forEach(note => {
                    note.createdAt = new Date(note.createdAt);
                    note.updatedAt = new Date(note.updatedAt);
                    if (typeof note.pinned === 'undefined') {
                        note.pinned = false;
                    }
                });

                // Dork Assistant State
                appState.dorkAssistantState = parsedState.dorkAssistantState || {
                    keywords: '',
                    customInput: '',
                    engine: 'google',
                    previewQuery: '',
                    convertedQuery: '',
                    currentDorkSubTab: 'query-playground',
                    savedQueries: [],
                    savedQuerySearchTerm: '',
                    currentTemplateCategory: 'All Templates',
                    preTemplateSearchTerm: '',
                    conversionJustPerformed: false
                };
                if (appState.dorkAssistantState.savedQueries) {
                    appState.dorkAssistantState.savedQueries.forEach(query => {
                        if (query.createdAt && typeof query.createdAt === 'string') {
                            query.createdAt = new Date(query.createdAt);
                        }
                    });
                }

                appState.customVaultViewMode = parsedState.customVaultViewMode || 'entries';

                // Merge default tools after loading saved state
                defaultTools.forEach(defaultTool => {
                    const exists = appState.tools.some(tool => tool.id === defaultTool.id);
                    if (!exists) {
                        appState.tools.push({
                            ...defaultTool,
                            addedDate: new Date(defaultTool.addedDate),
                            origin: 'pre-added'
                        });
                    }
                });

            } else {
                // If no saved state exists (first-time user), initialize with default values
                appState.tools = defaultTools.map(tool => ({ ...tool, addedDate: new Date(tool.addedDate), origin: 'pre-added' }));
                appState.customTabs = [{
                    id: generateId(),
                    name: 'My First Vault',
                    toolIds: [],
                    icon: 'fas fa-folder',
                    color: 'var(--tab-color-default)'
                }];
                appState.currentCustomTab = appState.customTabs[0]?.id || null;

                appState.currentIntelligenceVaultParentTab = 'generalAndCore';
                appState.currentIntelligenceVaultChildTab = 'tools';
                appState.currentCustomVaultParentTab = 'coreInvestigation';
                appState.currentCustomVaultEntrySubTab = 'tool';
                appState.currentThSubTab = 'script-library'; // NEW


                // Initialize all other arrays as empty for a fresh start (Crucial for first-time load)
                appState.emails = [];
                appState.phones = [];
                appState.crypto = [];
                appState.locations = [];
                appState.links = [];
                appState.media = [];
                appState.passwords = [];
                appState.keywords = [];
                appState.socials = [];
                appState.domains = [];
                appState.usernames = [];
                appState.threats = [];
                appState.vulnerabilities = [];
                appState.malware = [];
                appState.breaches = [];
                appState.credentials = [];
                appState.forums = [];
                appState.vendors = [];
                appState.telegramChannels = [];
                appState.pastes = [];
                appState.documents = [];
                appState.networks = [];
                appState.metadataEntries = [];
                appState.archives = [];
                appState.messagingApps = [];
                appState.datingProfiles = [];
                appState.audioEntries = [];
                appState.facialRecognition = [];
                appState.personas = [];
                appState.vpns = [];
                appState.honeypots = [];
                appState.exploits = [];
                appState.publicRecords = [];
                appState.threatHuntingScripts = []; // NEW

                // Load sample case studies only on first-time use
                appState.caseStudies = loadCaseStudiesData();

                appState.timeline = {
                    events: createSampleTimelineEvents()
                };

                appState.notesState = { notes: [], currentNote: null, editMode: false, noteSortFilter: 'updated_desc' };

                appState.dorkAssistantState = {
                    keywords: '',
                    customInput: '',
                    engine: 'google',
                    previewQuery: '',
                    convertedQuery: '',
                    currentDorkSubTab: 'query-playground',
                    savedQueries: [],
                    savedQuerySearchTerm: '',
                    currentTemplateCategory: 'All Templates',
                    preTemplateSearchTerm: '',
                    conversionJustPerformed: false
                };
                appState.caseStudyFilters = {
                    search: '',
                    type: ''
                };
                appState.scriptFilters = { // NEW
                    search: '',
                    language: ''
                };
                appState.customVaultViewMode = 'entries';
            }
        }
        // --- End of loadState (full code block) ---

        function openMobileMenu() {
            const mobileSidebarMenu = document.getElementById('mobileSidebarMenu');
            const mobileMenuContent = mobileSidebarMenu.querySelector('.mobile-menu-content');
            const mainNavTabs = document.querySelector('.main-nav-tabs');
            const headerControls = document.querySelector('.controls');
            mobileMenuContent.innerHTML = '';

            const navClonedContainer = document.createElement('div');
            navClonedContainer.classList.add('mobile-nav-cloned');
            mobileMenuContent.appendChild(navClonedContainer);

            mainNavTabs.querySelectorAll('.nav-tab').forEach(originalTab => {
                const newTabButton = document.createElement('button');
                newTabButton.classList.add('nav-tab');
                newTabButton.dataset.tab = originalTab.dataset.tab;
                newTabButton.innerHTML = originalTab.innerHTML;
                newTabButton.addEventListener('click', () => {
                    switchTab(originalTab.dataset.tab);
                    closeMobileMenu();
                });
                navClonedContainer.appendChild(newTabButton);
            });

            // Create container for cloned controls
            const controlsClonedContainer = document.createElement('div');
            controlsClonedContainer.classList.add('mobile-controls-cloned');
            mobileMenuContent.appendChild(controlsClonedContainer);

            const searchContainerHtml = `
                <div class="search-container">
                    <input type="text" class="search-input" id="mobileSearchInput" placeholder="Search...">
                    <i class="fas fa-search search-icon"></i>
                    <select id="mobileSearchScopeSelect">
                        <option value="currentTab">Current Tab</option>
                        <option value="allVault">All Intelligence Vault</option>
                        <option value="allData">All Data</option>
                    </select>
                </div>
            `;
            controlsClonedContainer.insertAdjacentHTML('beforeend', searchContainerHtml);

            // Export Button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                const mobileExportBtn = document.createElement('button');
                mobileExportBtn.className = exportBtn.className + ' mobile-btn';
                mobileExportBtn.innerHTML = exportBtn.innerHTML;
                mobileExportBtn.addEventListener('click', () => { exportData(); closeMobileMenu(); });
                controlsClonedContainer.appendChild(mobileExportBtn);
            }

            // Share Button
            const shareOptionsBtn = document.getElementById('shareOptionsBtn');
            if (shareOptionsBtn) {
                const mobileShareOptionsBtn = document.createElement('button');
                mobileShareOptionsBtn.className = shareOptionsBtn.className + ' mobile-btn';
                mobileShareOptionsBtn.innerHTML = shareOptionsBtn.innerHTML;
                mobileShareOptionsBtn.addEventListener('click', () => { showShareOptionsModal(); closeMobileMenu(); });
                controlsClonedContainer.appendChild(mobileShareOptionsBtn);
            }

            // Theme Toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const mobileThemeToggle = document.createElement('button');
                mobileThemeToggle.className = themeToggle.className + ' mobile-btn';
                mobileThemeToggle.innerHTML = themeToggle.innerHTML;
                mobileThemeToggle.addEventListener('click', toggleTheme);
                controlsClonedContainer.appendChild(mobileThemeToggle);
            }

            const mobileSearchInput = mobileMenuContent.querySelector('#mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.value = appState.filters.search;
                mobileSearchInput.addEventListener('input', (e) => {
                    appState.filters.search = e.target.value;
                    renderIntelligenceEntries();
                });
            }

            const mobileSearchScopeSelect = mobileMenuContent.querySelector('#mobileSearchScopeSelect');
            if (mobileSearchScopeSelect) {
                mobileSearchScopeSelect.value = appState.filters.searchScope;
                mobileSearchScopeSelect.addEventListener('change', (e) => {
                    appState.filters.searchScope = e.target.value;
                    renderIntelligenceEntries();
                });
            }


            mobileSidebarMenu.classList.add('active');
            document.body.classList.add('no-scroll');

            mobileSidebarMenu.querySelector('.close-menu-btn').addEventListener('click', closeMobileMenu);
        }


        

        function saveState() {
            const stateToSave = JSON.parse(JSON.stringify(appState));

            // Convert Date objects within the timeline events to ISO strings for storage
            if (stateToSave.timeline && stateToSave.timeline.events) {
                stateToSave.timeline.events.forEach(event => {
                    if (event.timestamp && typeof event.timestamp.toISOString === 'function') {
                        event.timestamp = event.timestamp.toISOString();
                    }
                });
            }

            // Convert Date objects for tools
            if (stateToSave.tools) {
                stateToSave.tools.forEach(tool => {
                    if (tool.addedDate && typeof tool.addedDate.toISOString === 'function') {
                        tool.addedDate = tool.addedDate.toISOString();
                    }
                });
            }

            // Convert Date objects for notes
            if (stateToSave.notesState && stateToSave.notesState.notes) {
                stateToSave.notesState.notes.forEach(note => {
                    if (note.createdAt && typeof note.createdAt.toISOString === 'function') {
                        note.createdAt = note.createdAt.toISOString();
                    }
                    if (note.updatedAt && typeof note.updatedAt.toISOString === 'function') {
                        note.updatedAt = note.updatedAt.toISOString();
                    }
                });
            }

            // Convert Date objects for dork saved queries
            if (stateToSave.dorkAssistantState && stateToSave.dorkAssistantState.savedQueries) {
                stateToSave.dorkAssistantState.savedQueries.forEach(query => {
                    if (query.createdAt && typeof query.createdAt.toISOString === 'function') {
                        query.createdAt = query.createdAt.toISOString();
                    }
                });
            }

            // NEW: Convert Date objects for case studies
            if (stateToSave.caseStudies) {
                stateToSave.caseStudies.forEach(cs => {
                    if (cs.addedDate && typeof cs.addedDate.toISOString === 'function') {
                        cs.addedDate = cs.addedDate.toISOString();
                    }
                });
            }

            if (stateToSave.threatHuntingScripts) {
                stateToSave.threatHuntingScripts.forEach(script => {
                    if (script.addedDate && typeof script.addedDate.toISOString === 'function') {
                        script.addedDate = script.addedDate.toISOString();
                    }
                });
            }

            localStorage.setItem('osintArsenalState', JSON.stringify(stateToSave));
        }


        function updateStats() {
            // Combine all entries from all types for total entries
            const allEntries = [
                ...(appState.tools || []),
                ...(appState.emails || []),
                ...(appState.phones || []),
                ...(appState.crypto || []),
                ...(appState.locations || []),
                ...(appState.links || []),
                ...(appState.media || []),
                ...(appState.passwords || []),
                ...(appState.keywords || []),
                ...(appState.socials || []),
                ...(appState.domains || []),
                ...(appState.usernames || []),
                ...(appState.threats || []),
                ...(appState.vulnerabilities || []),
                ...(appState.malware || []),
                ...(appState.breaches || []),
                ...(appState.credentials || []),
                ...(appState.forums || []),
                ...(appState.vendors || []),
                ...(appState.telegramChannels || []),
                ...(appState.pastes || []),
                ...(appState.documents || []),
                ...(appState.networks || []),
                ...(appState.metadataEntries || []),
                ...(appState.archives || []),
                ...(appState.messagingApps || []),
                ...(appState.datingProfiles || []),
                ...(appState.audioEntries || []),
                ...(appState.facialRecognition || []),
                ...(appState.personas || []),
                ...(appState.vpns || []),
                ...(appState.honeypots || []),
                ...(appState.exploits || []),
                ...(appState.publicRecords || []),
                ...(appState.caseStudies || [])
            ];

            // --- Main Overview Stats (These are the big numbers at the top of the Dashboard tab) ---
            document.getElementById('totalToolsCount').textContent = allEntries.length;
            document.getElementById('activeVaultsCount').textContent = appState.customTabs.length;
            document.getElementById('usedToolsTodayCount').textContent = appState.usageStats.toolsUsedToday;
            document.getElementById('notesCount').textContent = notesState.notes.length;


            // --- Detailed Starred & Pinned Breakdown by Type ---
            const starredPinnedBreakdownList = document.getElementById('starredPinnedBreakdownList');
            if (starredPinnedBreakdownList) {
                let breakdownHtml = '';
                const entryTypes = [
                    'tool', 'email', 'phone', 'crypto', 'location', 'link', 'media', 'password',
                    'keyword', 'social', 'domain', 'username', 'threat', 'vulnerability', 'malware',
                    'breach', 'credential', 'forum', 'vendor', 'telegram', 'paste', 'document',
                    'network', 'metadata', 'archive', 'messaging', 'dating', 'audio', 'facial',
                    'persona', 'vpn', 'honeypot', 'exploit', 'publicrecord', 'caseStudy'
                ];

                // Count for each type
                const typeCounts = {};
                allEntries.forEach(entry => {
                    // Normalize entry.type if necessary, e.g., 'telegram' -> 'telegramChannels' for lookup
                    let typeKey = entry.type;
                    if (typeKey === 'telegram') typeKey = 'telegramChannels';
                    if (typeKey === 'metadata') typeKey = 'metadataEntries';
                    if (typeKey === 'messaging') typeKey = 'messagingApps';
                    if (typeKey === 'dating') typeKey = 'datingProfiles';
                    if (typeKey === 'audio') typeKey = 'audioEntries';
                    if (typeKey === 'facial') typeKey = 'facialRecognition';
                    if (typeKey === 'persona') typeKey = 'personas';
                    if (typeKey === 'vpn') typeKey = 'vpns';
                    if (typeKey === 'caseStudy') typeKey = 'caseStudies';

                    // Ensure the key exists in our counts object
                    if (!typeCounts[typeKey]) {
                        typeCounts[typeKey] = {
                            starred: 0,
                            pinned: 0
                        };
                    }
                    if (entry.starred) {
                        typeCounts[typeKey].starred++;
                    }
                    if (entry.pinned) {
                        typeCounts[typeKey].pinned++;
                    }
                });

                // Add overall starred/pinned totals first for clarity
                breakdownHtml += `<li><span>Total Starred Entries:</span> <span class="stat-value">${allEntries.filter(e => e.starred).length}</span></li>`;
                breakdownHtml += `<li><span>Total Pinned Entries:</span> <span class="stat-value">${allEntries.filter(e => e.pinned).length}</span></li>`;
                breakdownHtml += `<li><hr style="border: 0; height: 1px; background: var(--border-light); margin: 10px 0;"></li>`; // Divider

                // Iterate through counts and build HTML
                entryTypes.forEach(type => {
                    let pluralType = type + 's'; // Default plural
                    // Adjust plural for specific arrays if they differ from type + 's'
                    if (type === 'telegram') pluralType = 'telegramChannels';
                    if (type === 'metadata') pluralType = 'metadataEntries';
                    if (type === 'messaging') pluralType = 'messagingApps';
                    if (type === 'dating') pluralType = 'datingProfiles';
                    if (type === 'audio') pluralType = 'audioEntries';
                    if (type === 'facial') pluralType = 'facialRecognition';
                    if (type === 'persona') pluralType = 'personas';
                    if (type === 'vpn') pluralType = 'vpns';
                    if (type === 'caseStudy') pluralType = 'caseStudies';

                    const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
                    if (typeCounts[pluralType] && (typeCounts[pluralType].starred > 0 || typeCounts[pluralType].pinned > 0)) {
                        if (typeCounts[pluralType].starred > 0) {
                            breakdownHtml += `<li><span>Starred ${capitalizedType}s:</span> <span class="stat-value">${typeCounts[pluralType].starred}</span></li>`;
                        }
                        if (typeCounts[pluralType].pinned > 0) {
                            breakdownHtml += `<li><span>Pinned ${capitalizedType}s:</span> <span class="stat-value">${typeCounts[pluralType].pinned}</span></li>`;
                        }
                    }
                });
                starredPinnedBreakdownList.innerHTML = breakdownHtml;
            }


            // --- Intelligence Vault Summary ---
            const intelVaultCategories = new Set((appState.tools || []).map(tool => tool.category));
            document.getElementById('intelVaultTotalTools').textContent = (appState.tools || []).length;
            document.getElementById('intelVaultStarredTools').textContent = (appState.tools || []).filter(tool => tool.starred).length;
            document.getElementById('intelVaultPinnedTools').textContent = (appState.tools || []).filter(tool => tool.pinned).length;
            document.getElementById('intelVaultCategoriesCount').textContent = intelVaultCategories.size;

            // --- Custom Vaults Summary ---
            let totalEntriesInCustomVaults = 0;
            (appState.customTabs || []).forEach(tab => {
                totalEntriesInCustomVaults += (tab.toolIds || []).length;
            });
            const totalCustomVaults = (appState.customTabs || []).length;
            document.getElementById('customVaultsTotal').textContent = totalCustomVaults;
            document.getElementById('customVaultsTotalEntries').textContent = totalEntriesInCustomVaults;
            document.getElementById('customVaultsAvgEntries').textContent = totalCustomVaults > 0 ? (totalEntriesInCustomVaults / totalCustomVaults).toFixed(1) : '0';

            // Render chart for entries per custom vault
            renderEntriesPerCustomVaultChart();


            // --- Notes & Dork Assistant Summary ---
            const totalTemplates = Object.values(dorkTemplates).flat().length;
            document.getElementById('notesSummaryTotal').textContent = (notesState.notes || []).length;
            document.getElementById('notesSummaryPinned').textContent = (notesState.notes || []).filter(n => n.pinned).length;
            document.getElementById('dorksSummaryTotal').textContent = (dorkAssistantState.savedQueries || []).length;
            document.getElementById('dorksSummaryTemplates').textContent = totalTemplates;


            // --- Render lists ---
            renderMostUsedTools();
            renderNeverUsedTools();
            renderToolsAddedPerWeek();

            // --- Chart Rendering Calls ---
            renderEntriesByTypeChart();
            renderUsageTrendChart();
            renderTopCategoriesChart();
            renderPinnedStarredDonutChart();
            renderEntryGrowthOverTimeChart();
            renderTaggingOverviewChart();
        }

        // --- NEW: Case Studies Functions ---

        // Renders the list of case studies
        function renderCaseStudies() {
            const caseStudiesGrid = document.getElementById('caseStudiesGrid');
            const emptyState = document.getElementById('emptyCaseStudiesState');

            const filteredCaseStudies = filterCaseStudies();

            if (filteredCaseStudies.length === 0) {
                emptyState.style.display = 'block';
                caseStudiesGrid.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                caseStudiesGrid.style.display = 'grid'; // Ensure grid display for case studies
                caseStudiesGrid.innerHTML = filteredCaseStudies.map(caseStudy => createCaseStudyCard(caseStudy)).join('');
            }
        }

        // Filters case studies based on current search and type filters
        function filterCaseStudies() {
            let filtered = [...appState.caseStudies];

            const searchTerm = appState.caseStudyFilters.search.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(cs => {
                    const searchFields = [
                        cs.title, cs.summary, cs.incidentType, cs.threatActor,
                        cs.osintTechniquesUsed ? cs.osintTechniquesUsed.join(' ') : '',
                        cs.toolsUsed ? cs.toolsUsed.join(' ') : '',
                        cs.lessonsLearned, cs.attackChain,
                        cs.tags ? cs.tags.join(' ') : ''
                    ].map(field => String(field || '').toLowerCase());
                    return searchFields.some(field => field.includes(searchTerm));
                });
            }

            const selectedType = appState.caseStudyFilters.type;
            if (selectedType) {
                filtered = filtered.filter(cs => cs.incidentType === selectedType);
            }

            // Sort by addedDate descending (most recent first)
            filtered.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate));

            return filtered;
        }

        // Creates the HTML for a single case study card
        function createCaseStudyCard(caseStudy) {
            const isStarred = caseStudy.starred;
            const isPinned = caseStudy.pinned;
            const difficultyIcon = {
                'beginner': 'fas fa-leaf',
                'intermediate': 'fas fa-seedling',
                'advanced': 'fas fa-tree'
            }[caseStudy.difficulty] || 'fas fa-info-circle';

            return `
                <div class="case-study-card ${isStarred ? 'starred' : ''} ${isPinned ? 'pinned' : ''}" data-case-study-id="${caseStudy.id}">
                    <div class="case-study-header">
                        <div>
                            <div class="case-study-title">
                                <i class="fas fa-microscope case-study-icon" style="color: #6c5ce7;"></i>
                                <span>${caseStudy.title}</span>
                            </div>
                            <div class="case-study-meta">
                                <span><i class="fas fa-tags"></i> ${caseStudy.incidentType.charAt(0).toUpperCase() + caseStudy.incidentType.slice(1)}</span>
                                <span><i class="${difficultyIcon}"></i> ${caseStudy.difficulty.charAt(0).toUpperCase() + caseStudy.difficulty.slice(1)}</span>
                                <span><i class="fas fa-calendar-alt"></i> ${caseStudy.dateRange}</span>
                            </div>
                        </div>
                        <div class="case-study-actions">
                            <button class="action-btn" data-action="edit-case-study" title="Edit Case Study">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn ${isStarred ? 'starred' : ''}" data-action="star-case-study" title="Star Case Study">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="action-btn ${isPinned ? 'pinned' : ''}" data-action="pin-case-study" title="Pin Case Study">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <button class="action-btn" data-action="delete-case-study" title="Delete Case Study">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="case-study-description">${caseStudy.summary}</p>
                    <div class="case-study-tags">
                        ${caseStudy.tags ? caseStudy.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                    </div>
                </div>
            `;
        }

        // Opens the modal to display full case study details
        function openCaseStudyDetailModal(caseStudyId) {
            const caseStudy = appState.caseStudies.find(cs => cs.id === caseStudyId);
            if (!caseStudy) {
                showToast("Case study not found.", "error");
                return;
            }

            document.getElementById('detailCaseStudyTitle').textContent = caseStudy.title;
            document.getElementById('detailCaseStudyType').textContent = caseStudy.incidentType.charAt(0).toUpperCase() + caseStudy.incidentType.slice(1);
            document.getElementById('detailCaseStudyDate').textContent = caseStudy.dateRange;
            document.getElementById('detailCaseStudyActor').textContent = caseStudy.threatActor || 'N/A';
            document.getElementById('detailCaseStudyDifficulty').textContent = caseStudy.difficulty.charAt(0).toUpperCase() + caseStudy.difficulty.slice(1);
            document.getElementById('detailCaseStudySummary').textContent = caseStudy.summary;
            document.getElementById('detailCaseStudyAttackChain').innerHTML = caseStudy.attackChain;
            document.getElementById('detailCaseStudyTechniques').innerHTML = caseStudy.osintTechniquesUsed ? caseStudy.osintTechniquesUsed.map(t => `<li>${t}</li>`).join('') : '<li>No specific techniques listed.</li>';
            document.getElementById('detailCaseStudyTools').innerHTML = caseStudy.toolsUsed ? caseStudy.toolsUsed.map(t => `<li>${t}</li>`).join('') : '<li>No specific tools listed.</li>';
            document.getElementById('detailCaseStudyLessons').innerHTML = caseStudy.lessonsLearned;
            document.getElementById('detailCaseStudyTags').innerHTML = caseStudy.tags ? caseStudy.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '';

            showModal('caseStudyDetailModal');
        }

        function createSampleTimelineEvents() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 3600000);
            const twoHoursAgo = new Date(now.getTime() - 7200000);
            const sixHoursAgo = new Date(now.getTime() - 21600000);
            const oneDayAgo = new Date(now.getTime() - 86400000);
            const twoDaysAgo = new Date(now.getTime() - (2 * 86400000));

            return [
                {
                    id: generateId(),
                    timestamp: twoDaysAgo, // Make sure these are Date objects
                    title: "Phishing Email Delivered to Employee X",
                    category: "phishing",
                    notes: "Employee X received a suspicious email with a malicious attachment disguised as an invoice. Subject: 'Urgent Invoice Payment #12345'.",
                    confidence: "high",
                    evidence: "email_id:XYZ789, email_header_analysis.pdf",
                    actor: "Attacker (APT28)",
                },
                {
                    id: generateId(),
                    timestamp: sixHoursAgo, // Make sure these are Date objects
                    title: "Successful Lateral Movement to File Server",
                    category: "lateral_movement",
                    notes: "Attacker gained access to file server FS-001-B using compromised credentials from workstation WS-001-A.",
                    confidence: "high",
                    evidence: "file_server_logs:FS-001-B_auth.log",
                    actor: "Attacker (APT28)",
                },
                {
                    id: generateId(),
                    timestamp: twoHoursAgo, // Make sure these are Date objects
                    title: "Suspicious Data Exfiltration Attempt",
                    category: "exfiltration",
                    notes: "Large volume of data detected transferring from FS-001-B to an external IP address via unusual port.",
                    confidence: "critical",
                    evidence: "firewall_logs:FW-001, dlp_alert:DLP-005",
                    actor: "Attacker (APT28)",
                },
                {
                    id: generateId(),
                    timestamp: oneHourAgo, // Make sure these are Date objects
                    title: "Incident Response Team Engaged",
                    category: "remediation",
                    notes: "Security operations center (SOC) alerted. Incident response team initiated containment procedures.",
                    confidence: "high",
                    evidence: "ir_ticket:IR-2025-001",
                    actor: "SOC Team",
                }
            ].sort((a, b) => a.timestamp - b.timestamp); // Ensure sample data is sorted by timestamp
        }

        // --- NEW: Add/Edit Case Study Functions ---

        // Opens the Add/Edit Case Study Modal
        function openAddEditCaseStudyModal(mode, caseStudyId = null) {
            if (appState.readOnlyMode) {
                showToast("Cannot add/edit case studies in read-only shared view.", "warning");
                return;
            }

            const form = document.getElementById('addEditCaseStudyForm');
            form.reset(); // Clear all form fields
            document.getElementById('caseStudyId').value = ''; // Clear hidden ID

            // Reset rich text editors manually
            document.getElementById('caseStudyAttackChain').innerHTML = '';
            document.getElementById('caseStudyLessons').innerHTML = '';

            // Populate Incident Type dropdown (and handle custom input)
            const incidentTypeSelect = document.getElementById('caseStudyIncidentType');
            const newCaseStudyTypeInput = document.getElementById('newCaseStudyTypeInput');

            incidentTypeSelect.value = ''; // Default select to empty
            newCaseStudyTypeInput.style.display = 'none'; // Hide custom input by default
            newCaseStudyTypeInput.value = '';

            // Add event listener for incident type select (if not already added)
            incidentTypeSelect.onchange = () => { // Using onchange to ensure single assignment
                if (incidentTypeSelect.value === 'custom') {
                    newCaseStudyTypeInput.style.display = 'block';
                    newCaseStudyTypeInput.setAttribute('required', 'required');
                } else {
                    newCaseStudyTypeInput.style.display = 'none';
                    newCaseStudyTypeInput.removeAttribute('required');
                    newCaseStudyTypeInput.value = '';
                }
            };


            if (mode === 'add') {
                document.getElementById('addEditCaseStudyModalTitle').textContent = 'Add New Case Study';
                document.getElementById('saveCaseStudyBtn').textContent = 'Add Case Study';
                document.getElementById('saveCaseStudyBtn').dataset.mode = 'add';
                document.getElementById('caseStudyDifficulty').value = 'intermediate'; // Default for add
            } else if (mode === 'edit' && caseStudyId) {
                const caseStudyToEdit = appState.caseStudies.find(cs => cs.id === caseStudyId);
                if (!caseStudyToEdit) {
                    showToast("Case study not found for editing.", "error");
                    return;
                }

                document.getElementById('addEditCaseStudyModalTitle').textContent = 'Edit Case Study';
                document.getElementById('saveCaseStudyBtn').textContent = 'Save Changes';
                document.getElementById('saveCaseStudyBtn').dataset.mode = 'edit';

                // Populate fields with data from caseStudyToEdit
                document.getElementById('caseStudyId').value = caseStudyToEdit.id;
                document.getElementById('caseStudyTitle').value = caseStudyToEdit.title;

                // Handle incident type (check if it's a custom type not in dropdown)
                if (Array.from(incidentTypeSelect.options).some(opt => opt.value === caseStudyToEdit.incidentType)) {
                    incidentTypeSelect.value = caseStudyToEdit.incidentType;
                } else {
                    incidentTypeSelect.value = 'custom';
                    newCaseStudyTypeInput.style.display = 'block';
                    newCaseStudyTypeInput.value = caseStudyToEdit.incidentType;
                }

                document.getElementById('caseStudyDateRange').value = caseStudyToEdit.dateRange;
                document.getElementById('caseStudyActor').value = caseStudyToEdit.threatActor || '';
                document.getElementById('caseStudyDifficulty').value = caseStudyToEdit.difficulty;
                document.getElementById('caseStudySummary').value = caseStudyToEdit.summary;
                document.getElementById('caseStudyAttackChain').innerHTML = caseStudyToEdit.attackChain; // Rich text
                document.getElementById('caseStudyOsintTechniques').value = caseStudyToEdit.osintTechniquesUsed ? caseStudyToEdit.osintTechniquesUsed.join(', ') : '';
                document.getElementById('caseStudyToolsUsed').value = caseStudyToEdit.toolsUsed ? caseStudyToEdit.toolsUsed.join(', ') : '';
                document.getElementById('caseStudyLessons').innerHTML = caseStudyToEdit.lessonsLearned; // Rich text
                document.getElementById('caseStudyTags').value = caseStudyToEdit.tags ? caseStudyToEdit.tags.join(', ') : '';
            }

            showModal('addEditCaseStudyModal');
            // Re-initialize rich text editor for new content in modal
            setupCaseStudyRichTextEditors();
        }

        // Handles form submission for adding or editing a case study
        function handleCaseStudyFormSubmit(e) {
            e.preventDefault();
            if (appState.readOnlyMode) {
                showToast("Cannot save case studies in read-only shared view.", "warning");
                return;
            }

            const mode = document.getElementById('saveCaseStudyBtn').dataset.mode;
            const caseStudyId = document.getElementById('caseStudyId').value;

            const title = document.getElementById('caseStudyTitle').value.trim();
            let incidentType = document.getElementById('caseStudyIncidentType').value;
            const newCaseStudyTypeInput = document.getElementById('newCaseStudyTypeInput').value.trim();

            const dateRange = document.getElementById('caseStudyDateRange').value.trim();
            const actor = document.getElementById('caseStudyActor').value.trim();
            const difficulty = document.getElementById('caseStudyDifficulty').value;
            const summary = document.getElementById('caseStudySummary').value.trim();
            const attackChain = document.getElementById('caseStudyAttackChain').innerHTML.trim(); // Get HTML content
            const osintTechniques = document.getElementById('caseStudyOsintTechniques').value.split(',').map(t => t.trim()).filter(t => t);
            const toolsUsed = document.getElementById('caseStudyToolsUsed').value.split(',').map(t => t.trim()).filter(t => t);
            const lessonsLearned = document.getElementById('caseStudyLessons').innerHTML.trim(); // Get HTML content
            const tags = document.getElementById('caseStudyTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

            if (!title || !incidentType || !dateRange || !summary || !difficulty) {
                showToast('Please fill in all required fields (Title, Incident Type, Date, Summary, Difficulty).', 'error');
                return;
            }

            if (incidentType === 'custom') {
                if (!newCaseStudyTypeInput) {
                    showToast('Please enter a custom incident type name.', 'error');
                    return;
                }
                incidentType = newCaseStudyTypeInput.toLowerCase(); // Use lowercase for consistency
            }

            const newCaseStudy = {
                id: mode === 'add' ? generateId() : caseStudyId,
                title: title,
                incidentType: incidentType,
                dateRange: dateRange,
                summary: summary,
                attackChain: attackChain,
                osintTechniquesUsed: osintTechniques,
                toolsUsed: toolsUsed,
                lessonsLearned: lessonsLearned,
                threatActor: actor,
                difficulty: difficulty,
                tags: tags,
                starred: false, // Default for new, will be overwritten for edit
                pinned: false,  // Default for new, will be overwritten for edit
                addedDate: new Date() // Set/update added date
            };

            if (mode === 'add') {
                appState.caseStudies.push(newCaseStudy);
                showToast('Case study added successfully!');
            } else if (mode === 'edit') {
                const index = appState.caseStudies.findIndex(cs => cs.id === caseStudyId);
                if (index > -1) {
                    // Retain existing starred/pinned status from the old object
                    newCaseStudy.starred = appState.caseStudies[index].starred;
                    newCaseStudy.pinned = appState.caseStudies[index].pinned;
                    appState.caseStudies[index] = newCaseStudy;
                    showToast('Case study updated successfully!');
                } else {
                    showToast('Error: Case study not found for update.', 'error');
                }
            }

            hideModal('addEditCaseStudyModal');
            saveCaseStudies(); // Save to local storage
            renderCaseStudies(); // Re-render the list
            updateStats(); // Update dashboard stats
        }

        // Saves case studies to localStorage
        function saveCaseStudies() {
            localStorage.setItem('osintCaseStudies', JSON.stringify(appState.caseStudies));
        }

        // Function to setup rich text editors for attack chain and lessons learned
        function setupCaseStudyRichTextEditors() {
            const attackChainEditor = document.getElementById('caseStudyAttackChain');
            const lessonsEditor = document.getElementById('caseStudyLessons');

            // Make sure editors are contenteditable if not in read-only mode
            if (!appState.readOnlyMode) {
                if (attackChainEditor) attackChainEditor.contentEditable = true;
                if (lessonsEditor) lessonsEditor.contentEditable = true;
            } else { // In read-only mode, ensure they are not editable
                if (attackChainEditor) attackChainEditor.contentEditable = false;
                if (lessonsEditor) lessonsEditor.contentEditable = false;
            }

            // You can attach generic event listeners for the toolbars directly to the document
            // and check event.target.closest('.formatting-btn') to see which button was clicked,
            // and then apply the command to the currently focused contenteditable div.
            // This setup would be similar to how your 'notes' editor's toolbar works.
            // For simplicity, this example just makes them editable; the toolbar logic itself
            // is already present in your main bindEvents if you extend it for these new ids.
            // Make sure the `formatting-toolbar` buttons for these specific modals are also handled
            // by `initSectionEditor` or a similar function for modal-specific toolbars.
        }

        // Populate category filter and Add Tool modal
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const toolCategorySelect = document.getElementById('toolCategory');
            const editToolCategorySelect = document.getElementById('editToolCategory');
            const toolOnlyCategorySelect = document.getElementById('toolOnlyCategory'); // For Add Tool Only Modal

            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));

            // Add static options
            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation',
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...Array.from(existingCategories)]);

            // Clear existing options
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            editToolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            toolOnlyCategorySelect.innerHTML = '<option value="">Select Category</option>';


            // Sort categories alphabetically for dropdowns
            const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));

            sortedCategories.forEach(category => {
                // Filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(filterOption);

                // Add Tool dropdown
                const toolOption = document.createElement('option');
                toolOption.value = category;
                toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolCategorySelect.appendChild(toolOption);

                // Edit Tool dropdown
                const editToolOption = document.createElement('option');
                editToolOption.value = category;
                editToolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                editToolCategorySelect.appendChild(editToolOption);

                // Add Tool Only dropdown
                const toolOnlyOption = document.createElement('option');
                toolOnlyOption.value = category;
                toolOnlyOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolOnlyCategorySelect.appendChild(toolOnlyOption);
            });

            // Add "Custom" option to tool category select
            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);

            // Add "Custom" option to toolOnlyCategorySelect
            const customOptionAddToolOnly = document.createElement('option');
            customOptionAddToolOnly.value = 'custom';
            customOptionAddToolOnly.textContent = 'Custom Category';
            toolOnlyCategorySelect.appendChild(customOptionAddToolOnly);

            const customOptionEdit = document.createElement('option');
            customOptionEdit.value = 'custom';
            customOptionEdit.textContent = 'Custom Category';
            editToolCategorySelect.appendChild(customOptionEdit);


            // Set selected values for filters
            categoryFilter.value = appState.filters.category;
            document.getElementById('sortFilter').value = appState.filters.sort;
        }

        function renderIntelligenceEntries() {
            const toolsContainer = document.getElementById('toolsGrid');
            const customTabToolsContainer = document.getElementById('customTabToolsGrid');
            const intelligenceVaultEntriesContainer = document.getElementById('intelligenceVaultEntries');
            const emptyState = document.getElementById('emptyState');
            const emptyCustomTabState = document.getElementById('emptyCustomTabState');
            const emptyCurrentCustomTabState = document.getElementById('emptyCurrentCustomTabState');
            const emptyIntelligenceVaultState = document.getElementById('emptyIntelligenceVaultState');

            // References for parent/child tabs
            const intelligenceVaultParentTabs = document.getElementById('intelligenceVaultParentTabs');
            const intelligenceVaultChildTabs = document.getElementById('intelligenceVaultChildTabs');
            const customVaultEntryParentTabs = document.getElementById('customVaultEntryParentTabs');
            const customVaultEntryChildTabs = document.getElementById('customVaultEntryChildTabs');


            // Hide all empty states and containers initially
            toolsContainer.style.display = 'none';
            customTabToolsContainer.style.display = 'none';
            intelligenceVaultEntriesContainer.style.display = 'none';
            emptyState.style.display = 'none';
            emptyCustomTabState.style.display = 'none';
            emptyCurrentCustomTabState.style.display = 'none';
            emptyIntelligenceVaultState.style.display = 'none';

            // Also hide all tab containers by default, they will be explicitly shown below
            if (intelligenceVaultParentTabs) intelligenceVaultParentTabs.style.display = 'none';
            if (intelligenceVaultChildTabs) intelligenceVaultChildTabs.style.display = 'none';
            if (customVaultEntryParentTabs) customVaultEntryParentTabs.style.display = 'none';
            if (customVaultEntryChildTabs) customVaultEntryChildTabs.style.display = 'none';


            let filteredEntries = filterEntries(); 

            let targetContainer = null;
            let currentEmptyState = null;

            if (appState.currentTab === 'intelligence-vault') {
                targetContainer = intelligenceVaultEntriesContainer;
                currentEmptyState = emptyIntelligenceVaultState;

                // Ensure intelligence vault parent and child tabs are visible
                if (intelligenceVaultParentTabs) intelligenceVaultParentTabs.style.display = 'flex';
                if (appState.currentIntelligenceVaultChildTab && intelligenceVaultChildTabs) {
                     intelligenceVaultChildTabs.style.display = 'flex';
                }

                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                } else {
                    currentEmptyState.style.display = 'none';
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                }

            } else if (appState.currentTab === 'custom-tabs') {
                targetContainer = customTabToolsContainer;

                // Only show parent/child entry tabs if there's an active custom vault selected
                if (appState.customTabs.length === 0) {
                    emptyCustomTabState.style.display = 'block';
                    document.getElementById('addEntryBtnCustomVault').style.display = 'none'; // Hide add entry button if no custom tabs
                    return;
                } else {
                    emptyCustomTabState.style.display = 'none'; // Hide global empty state if custom tabs exist
                }

                if (appState.currentCustomTab) { // If a specific custom vault is selected
                    if (customVaultEntryParentTabs) customVaultEntryParentTabs.style.display = 'flex';
                    if (appState.currentCustomVaultEntrySubTab && customVaultEntryChildTabs) {
                        customVaultEntryChildTabs.style.display = 'flex';
                    }
                     document.getElementById('addEntryBtnCustomVault').style.display = appState.readOnlyMode ? 'none' : 'inline-flex';


                    if (filteredEntries.length === 0) {
                        emptyCurrentCustomTabState.style.display = 'block'; // Show empty state for selected custom tab
                        targetContainer.style.display = 'none';
                    } else {
                        emptyCurrentCustomTabState.style.display = 'none';
                        targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                    }
                } else { // No specific custom vault selected, but custom tabs exist
                    emptyCurrentCustomTabState.style.display = 'block'; // Show empty state for selected custom tab
                    targetContainer.style.display = 'none';
                }


            } else if (appState.currentTab === 'tools') { // This `toolsTab` might be obsolete if `intelligence-vault` replaces it
                targetContainer = toolsContainer;
                currentEmptyState = emptyState;
                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                } else {
                    currentEmptyState.style.display = 'none';
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                }
            }
            // For other tabs (analytics, threats, handbook), no entries are rendered in this function.

            // Set the appropriate class based on viewMode
            if (targetContainer) { // Only apply if a container is actually being targeted
                if (appState.viewMode === 'grid') {
                    targetContainer.classList.remove('tools-list');
                    targetContainer.classList.add('tools-grid');
                } else {
                    targetContainer.classList.remove('tools-grid');
                    targetContainer.classList.add('tools-list');
                }
                targetContainer.innerHTML = filteredEntries.map(entry => createEntryCard(entry)).join('');
            }

            // Update view toggle button text based on appState.viewMode
            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            const customVaultViewToggleButton = document.getElementById('customVaultViewToggle'); // This was fixed to exist

            if (appState.viewMode === 'grid') {
                if (viewToggleButton) viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                if (vaultViewToggleButton) vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                if (customVaultViewToggleButton) customVaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View'; // Use the correct ID here
            } else {
                if (viewToggleButton) viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                if (vaultViewToggleButton) vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                if (customVaultViewToggleButton) customVaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View'; // Use the correct ID here
            }
            
            // New: Apply shared-highlight if in read-only mode and relevant entries are found
            if (appState.readOnlyMode && appState.sharedEntryIds.length > 0) {
                // Determine if the current view corresponds to the shared scope
                let shouldHighlight = false;
                if (appState.sharedTabId === 'allData' || appState.sharedTabId === 'allVault') {
                    shouldHighlight = true; // Always highlight all if allData/allVault shared
                } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared custom tab
                } else if (appState.currentTab === 'intelligence-vault' && appState.currentIntelligenceVaultChildTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared intel vault child tab
                }

                if (shouldHighlight) {
                    appState.sharedEntryIds.forEach(id => {
                        const entryCard = document.querySelector(`.tool-card[data-entry-id="${id}"]`);
                        if (entryCard) {
                            entryCard.classList.add('shared-highlight');
                        }
                    });
                }
            }

            saveState(); // Save state after rendering entries
        }

        // MODIFIED: filterEntries function to include all new entry types
        function filterEntries() {
            let entriesToSearch = [];

            // Combine all entries from all types for the base set
            const allKnownEntries = [
                ...appState.tools,
                ...appState.emails,
                ...appState.phones,
                ...appState.crypto,
                ...appState.locations,
                ...appState.links,
                ...appState.media,
                ...appState.passwords,
                ...appState.keywords,
                ...appState.socials,
                ...appState.domains,
                ...appState.usernames,
                ...appState.threats,
                ...appState.vulnerabilities,
                ...appState.malware,
                ...appState.breaches,
                ...appState.credentials,
                ...appState.forums,
                ...appState.vendors,
                ...appState.telegramChannels,
                ...appState.pastes,
                ...appState.documents,
                ...appState.networks,
                ...appState.metadataEntries,
                ...appState.archives,
                ...appState.messagingApps,
                ...appState.datingProfiles,
                ...appState.audioEntries,
                ...appState.facialRecognition,
                ...appState.personas,
                ...appState.vpns,
                ...appState.honeypots,
                ...appState.exploits,
                ...appState.publicRecords
            ];

            if (appState.filters.searchScope === 'allData' || appState.filters.searchScope === 'allVault') {
                entriesToSearch = allKnownEntries;
            } else {
                // For 'currentTab' scope within intelligence-vault or custom-tabs
                if (appState.currentTab === 'intelligence-vault') {
                    // Filter tools based on the active intelligence vault child tab
                    entriesToSearch = appState.tools.filter(tool =>
                        (tool.intelligenceVaultCategories || []).includes(appState.currentIntelligenceVaultChildTab)
                    );
                } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
                    const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
                    if (activeCustomTab) {
                        // First, filter entries that belong to the currently active custom tab
                        let entriesInActiveCustomTab = allKnownEntries.filter(entry =>
                            (entry.customTabs || []).includes(activeCustomTab.id)
                        );

                        // Then, filter these entries based on the currently selected child sub-tab (Tools, Emails, etc.)
                        if (appState.currentCustomVaultEntrySubTab) {
                            entriesToSearch = entriesInActiveCustomTab.filter(entry =>
                                entry.type === appState.currentCustomVaultEntrySubTab
                            );
                        } else {
                            entriesToSearch = entriesInActiveCustomTab; // Show all entries in the custom tab if no specific sub-type selected
                        }

                    } else {
                        entriesToSearch = [];
                    }
                } else {
                    entriesToSearch = []; // No specific entries to filter for other tabs like analytics, threats, handbook
                }
            }

            let filtered = [...entriesToSearch]; // Start filtering from this base set

            // Apply search filter
            if (appState.filters.search) {
                const searchTerm = appState.filters.search.toLowerCase();
                filtered = filtered.filter(entry => {
                    const searchableFields = [
                        // Core fields common across many types
                        entry.name, entry.title, entry.description, entry.notes, entry.url, entry.value,
                        entry.category, // Only for tools
                        entry.source,

                        // Specific fields for each type (check for existence to prevent errors)
                        entry.email, entry.number, entry.address, entry.txid,
                        entry.linkedPlatforms, entry.breachResults,
                        entry.phoneType, entry.location, entry.mapLink, entry.ipGeoIntel,
                        entry.mediaType,
                        entry.service, entry.username, entry.password, entry.strength,
                        entry.context,
                        entry.platform, entry.followCounts,

                        // New fields for all the added types
                        entry.domainType, entry.registrar, entry.status, entry.whois, entry.dns,
                        entry.platformsFound, entry.emails, entry.realName, entry.activity,
                        entry.threatType, entry.threatName, entry.severity, entry.iocs, entry.targets, entry.attribution, entry.threatSource,
                        entry.cve, entry.cvss, entry.software, entry.vulnType, entry.exploit, entry.mitigation,
                        entry.filename, entry.hash, entry.fileType, entry.family, entry.detection, entry.behavior, entry.malwareSource, entry.tools,
                        entry.company, entry.date, entry.records, entry.dataTypes, entry.vector, entry.breachStatus, entry.breachSource,
                        entry.credentialType, entry.credentialValue, entry.credentialService, entry.dateFound,
                        entry.forumName, entry.forumUrl, entry.forumType, entry.forumStatus, entry.forumLanguage,
                        entry.vendorAlias, entry.vendorPlatforms, entry.vendorProducts, entry.vendorReputation,
                        entry.telegramName, entry.telegramUrl, entry.telegramType, entry.subscribers, entry.language, entry.telegramActivity, entry.content, entry.admin,
                        entry.pasteUrl, entry.sourceSite, entry.contentSummary, entry.keywords,
                        entry.documentTitle, entry.documentFileType, entry.documentHash, entry.documentContentSummary, entry.documentSource,
                        entry.networkSubject, entry.networkType, entry.networkFindings, entry.associatedIpsDomains, entry.toolsUsed,
                        entry.metadataTitle, entry.fileSource, // For metadata entry type itself
                        entry.originalUrl, entry.archiveUrl, entry.service, entry.timestamp, // For archives
                        entry.messagingApp, entry.chatId, // For messaging
                        entry.datingPlatform, entry.displayName, entry.age, entry.photos, entry.bio, entry.verified, entry.suspicious,
                        entry.format, entry.duration, entry.quality, entry.audioLanguage, entry.transcript, entry.speakers, entry.background,
                        entry.subject, entry.sourceDescription, entry.identifiedProfiles, entry.confidence, entry.facialToolsUsed,
                        entry.realName, entry.associatedAccounts, entry.platformsUsed, entry.origin, // For persona
                        entry.vpnName, entry.vpnType, entry.jurisdiction, entry.logs, entry.payment, entry.locations, entry.issues, entry.useCase, // For VPN
                        entry.honeypotType, entry.honeypotLocation, entry.honeypotPurpose, entry.honeypotDataSummary, entry.honeypotAlerts,
                        entry.exploitName, entry.targetVuln, entry.exploitType, entry.marketSource, entry.price,
                        entry.recordType, entry.subjectName, entry.refId, entry.jurisdiction, entry.date, entry.summary, entry.sourceUrl
                    ].map(field => String(field || '').toLowerCase());

                    if (entry.tags) {
                        searchableFields.push(...entry.tags.map(tag => tag.toLowerCase()));
                    }

                    if (entry.metadata) {
                        searchableFields.push(...entry.metadata.flatMap(meta => [String(meta.key || '').toLowerCase(), String(meta.value || '').toLowerCase()]));
                    }

                    return searchableFields.some(field => field.includes(searchTerm));
                });
            }

            // Apply universal "category" filters for pinned/starred
            if (appState.filters.category === 'pinned') {
                filtered = filtered.filter(entry => entry.pinned);
            } else if (appState.filters.category === 'starred') {
                filtered = filtered.filter(entry => entry.starred);
            } else if (appState.filters.category) {
                // This 'else if' block handles actual categories, only apply if the current view is for tools
                // Now, only filter by category if we are explicitly on an 'Intelligence Vault' tab that displays tools,
                // or if we are on the 'tools' sub-tab within a custom vault.
                if (appState.currentTab === 'intelligence-vault' || (appState.currentTab === 'custom-tabs' && appState.currentCustomVaultEntrySubTab === 'tool')) { // Changed to 'tool'
                    filtered = filtered.filter(entry => entry.type === 'tool' && entry.category === appState.filters.category);
                } else {
                    // If a category filter is applied while not on a 'tools' tab, clear it visually.
                    document.getElementById('categoryFilter').value = '';
                    appState.filters.category = ''; // Ensure state is reset too
                }
            }

            // Apply sorting
            filtered.sort((a, b) => {
                switch (appState.filters.sort) {
                    case 'recent':
                        return new Date(b.addedDate || 0) - new Date(a.addedDate || 0);
                    case 'popular': // Sort by lastUsed (most recent first)
                        return (b.lastUsed || 0) - (a.lastUsed || 0);
                    default: // 'name' (or primary identifier, which is often the first significant field)
                        // Use a more comprehensive list of potential name fields
                        const nameA = a.name || a.title || a.email || a.number || a.address || a.value || a.username || a.filename || a.company || a.credentialValue || a.forumName || a.vendorAlias || a.telegramName || a.pasteUrl || a.documentTitle || a.networkSubject || a.metadataTitle || a.originalUrl || a.messagingUsername || a.facialSubject || a.personaName || a.vpnName || a.exploitName || a.publicRecordSubjectName || '';
                        const nameB = b.name || b.title || b.email || b.number || b.address || b.value || b.username || b.filename || b.company || b.credentialValue || b.forumName || b.vendorAlias || b.telegramName || b.pasteUrl || b.documentTitle || b.networkSubject || b.metadataTitle || b.originalUrl || b.messagingUsername || b.facialSubject || b.personaName || b.vpnName || b.exploitName || b.publicRecordSubjectName || '';
                        return nameA.localeCompare(nameB);
                }
            });

            return filtered;
        }

            // Create a generic entry card HTML
            // MODIFIED: createEntryCard function to include all new entry types
            function createEntryCard(entry) {
                const isSelected = appState.selectedEntries.has(entry.id);
                let title, subtitle, description, icon, faviconHtml = '', extraContent = '';

                // Determine the origin tag HTML
                let originTagHtml = '';
                if (entry.origin === 'pre-added') {
                    originTagHtml = `<span class="tag" style="background-color: var(--primary); color: white; margin-left: 10px;">Pre-added</span>`;
                } else if (entry.origin === 'user-added') {
                    originTagHtml = `<span class="tag" style="background-color: var(--accent); color: white; margin-left: 10px;">User-added</span>`;
                }

                // Default notes if not specified for a type
                const investigationNotes = entry.notes ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Notes:</strong> ${entry.notes}</p>` : '';

                switch (entry.type) {
                    case 'tool':
                        title = entry.name;
                        subtitle = entry.url;
                        description = entry.description;
                        icon = 'fas fa-tools';
                        faviconHtml = `<img src="${entry.favicon}" alt="" class="tool-favicon" onerror="this.src='https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}'">`;
                        extraContent += investigationNotes;
                        break;
                    case 'email':
                        title = entry.email;
                        subtitle = entry.linkedPlatforms.join(', ') || 'No linked platforms';
                        description = entry.description || entry.notes;
                        icon = 'fas fa-envelope';
                        extraContent = entry.breachResults ? `<p style="color: var(--danger); font-size: 12px; margin-top: 5px;"><i class="fas fa-exclamation-triangle"></i> Breach: ${entry.breachResults}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'phone':
                        title = entry.number;
                        subtitle = `Type: ${entry.phoneType}`;
                        description = entry.description || entry.notes;
                        icon = 'fas fa-phone';
                        extraContent = entry.location ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${entry.location}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'crypto':
                        title = entry.address;
                        subtitle = `TXID: ${entry.txid}`;
                        description = entry.description || `Amount: ${entry.amount} | Source: ${entry.source}`;
                        icon = 'fas fa-coins';
                        extraContent += investigationNotes;
                        break;
                    case 'location':
                        title = entry.name;
                        subtitle = `Coordinates: ${entry.coordinates}`;
                        description = entry.description || entry.notes;
                        icon = 'fas fa-map-marker-alt';
                        extraContent = entry.mapLink ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.mapLink}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> View Map</a></p>` : '';
                        extraContent += entry.ipGeoIntel ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">IP/Geo: ${entry.ipGeoIntel}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'link':
                        title = entry.url;
                        subtitle = entry.platform || 'General Link';
                        description = entry.description || entry.notes;
                        icon = 'fas fa-link';
                        try {
                            faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
                        } catch (e) {
                            faviconHtml = '';
                        }
                        extraContent += investigationNotes;
                        break;
                    case 'media':
                        title = entry.title;
                        subtitle = entry.mediaType === 'image' ? 'Image' : 'Video';
                        description = entry.description || entry.notes;
                        icon = entry.mediaType === 'image' ? 'fas fa-image' : 'fas fa-video';
                        extraContent = entry.base64Data ? (entry.mediaType === 'image' ? `<img src="${entry.base64Data}" alt="Media thumbnail" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">` : `<video controls style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;"><source src="${entry.base64Data}" type="video/mp4"></video>`) : '';
                        extraContent += investigationNotes;
                        break;
                    case 'password':
                        title = entry.service;
                        subtitle = `Username: ${entry.username || 'N/A'}`;
                        description = entry.description || `Password: ${entry.password} | Strength: ${entry.strength || 'N/A'}`;
                        icon = 'fas fa-key';
                        extraContent += investigationNotes;
                        break;
                    case 'keyword':
                        title = entry.value;
                        subtitle = `Context: ${entry.context || 'General'}`;
                        description = entry.description || entry.notes;
                        icon = 'fas fa-font';
                        extraContent += investigationNotes;
                        break;
                    case 'social':
                        title = entry.username;
                        subtitle = `Platform: ${entry.platform}`;
                        description = entry.description || `URL: ${entry.url}\nFollowers/Following: ${entry.followCounts || 'N/A'}`;
                        icon = 'fas fa-users';
                        try {
                            faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
                        } catch (e) {
                            faviconHtml = '';
                        }
                        extraContent += investigationNotes;
                        break;
                    case 'domain':
                        title = entry.value;
                        subtitle = `Type: ${entry.domainType} | Status: ${entry.status || 'N/A'}`;
                        description = entry.description || `Registrar: ${entry.registrar || 'N/A'}\nLocation: ${entry.location || 'N/A'}`;
                        icon = 'fas fa-globe';
                        extraContent = entry.whois ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>WHOIS:</strong> ${entry.whois}</p>` : '';
                        extraContent += entry.dns ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>DNS:</strong> ${entry.dns}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'username':
                        title = entry.value;
                        subtitle = `Real Name: ${entry.realName || 'N/A'}`;
                        description = entry.description || `Platforms: ${entry.platformsFound || 'N/A'}\nEmails: ${entry.emails || 'N/A'}\nActivity: ${entry.activity || 'N/A'}`;
                        icon = 'fas fa-user';
                        extraContent += investigationNotes;
                        break;
                    case 'threat':
                        title = entry.name;
                        subtitle = `Type: ${entry.threatType} | Severity: ${entry.severity}`;
                        description = entry.description;
                        icon = 'fas fa-skull-crossbones';
                        extraContent = entry.iocs ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>IOCs:</strong> ${entry.iocs}</p>` : '';
                        extraContent += entry.targets ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Targets:</strong> ${entry.targets}</p>` : '';
                        extraContent += entry.attribution ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Attribution:</strong> ${entry.attribution}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'vulnerability':
                        title = entry.cve;
                        subtitle = `CVSS: ${entry.cvss} | Type: ${entry.vulnType}`;
                        description = entry.description || `Affected: ${entry.software || 'N/A'}\nExploit: ${entry.exploit || 'N/A'}`;
                        icon = 'fas fa-bug';
                        extraContent = entry.mitigation ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Mitigation:</strong> ${entry.mitigation}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'malware':
                        title = entry.filename;
                        subtitle = `Type: ${entry.fileType} | Hash: ${entry.hash}`;
                        description = entry.behavior || `Family: ${entry.family || 'N/A'}\nDetection: ${entry.detection || 'N/A'}`;
                        icon = 'fas fa-biohazard'; // More distinct malware icon
                        extraContent = entry.malwareSource ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Source:</strong> ${entry.malwareSource}</p>` : '';
                        extraContent += entry.tools ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Tools:</strong> ${entry.tools}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'breach':
                        title = entry.company;
                        subtitle = `Date: ${entry.date || 'N/A'} | Records: ${entry.records || 'N/A'}`;
                        description = entry.description || `Data Types: ${entry.dataTypes || 'N/A'}\nVector: ${entry.vector || 'N/A'}\nStatus: ${entry.status || 'N/A'}`;
                        icon = 'fas fa-database';
                        extraContent = entry.source ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.source}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> Source</a></p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'credential':
                        title = entry.credentialService || 'N/A';
                        subtitle = `Type: ${entry.credentialType}`;
                        description = entry.description || `Value: ${entry.credentialValue.substring(0, 50)}${entry.credentialValue.length > 50 ? '...' : ''}\nBreach Source: ${entry.breachSource || 'N/A'}`;
                        icon = 'fas fa-user-lock'; // Specific for credentials
                        extraContent += investigationNotes;
                        break;
                    case 'forum':
                        title = entry.forumName;
                        subtitle = `Type: ${entry.forumType} | Status: ${entry.forumStatus}`;
                        description = entry.description || `URL: ${entry.forumUrl}\nLanguage: ${entry.forumLanguage || 'N/A'}`;
                        icon = 'fas fa-comments';
                        try {
                            faviconHtml = entry.forumUrl ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.forumUrl).hostname}" alt="" class="tool-favicon">` : '';
                        } catch (e) {
                            faviconHtml = '';
                        }
                        extraContent += investigationNotes;
                        break;
                    case 'vendor':
                        title = entry.vendorAlias;
                        subtitle = `Reputation: ${entry.vendorReputation || 'N/A'}`;
                        description = entry.description || `Products: ${entry.vendorProducts || 'N/A'}\nPlatforms: ${entry.vendorPlatforms || 'N/A'}`;
                        icon = 'fas fa-store';
                        extraContent += investigationNotes;
                        break;
                    case 'telegram':
                        title = entry.name;
                        subtitle = `Type: ${entry.telegramType} | Subs: ${entry.subscribers || 'N/A'}`;
                        description = entry.content || `URL: ${entry.url}\nLanguage: ${entry.language || 'N/A'}\nActivity: ${entry.activity || 'N/A'}\nAdmin: ${entry.admin || 'N/A'}`;
                        icon = 'fab fa-telegram-plane';
                        try {
                            faviconHtml = entry.url ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">` : '';
                        } catch (e) {
                            faviconHtml = '';
                        }
                        extraContent += investigationNotes;
                        break;
                    case 'paste':
                        title = entry.url;
                        subtitle = `Source: ${entry.sourceSite || 'N/A'}`;
                        description = entry.contentSummary || entry.description || `Keywords: ${entry.keywords || 'N/A'}`;
                        icon = 'fas fa-paste';
                        try {
                            faviconHtml = entry.url ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">` : '';
                        } catch (e) {
                            faviconHtml = '';
                        }
                        extraContent += investigationNotes;
                        break;
                    case 'document':
                        title = entry.title;
                        subtitle = `Type: ${entry.fileType} | Hash: ${entry.hash || 'N/A'}`;
                        description = entry.contentSummary || entry.description;
                        icon = 'fas fa-file-alt';
                        extraContent = entry.source ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Source:</strong> ${entry.source}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'network':
                        title = entry.subject;
                        subtitle = `Analysis Type: ${entry.networkType}`;
                        description = entry.findings || entry.description;
                        icon = 'fas fa-network-wired';
                        extraContent = entry.associatedIpsDomains ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Associated:</strong> ${entry.associatedIpsDomains}</p>` : '';
                        extraContent += entry.toolsUsed ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Tools:</strong> ${entry.toolsUsed}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'metadata':
                        title = entry.title;
                        subtitle = `File/Source: ${entry.fileSource || 'N/A'}`;
                        description = entry.description; // Description specifically for metadata entry
                        icon = 'fas fa-info-circle'; // General info icon
                        extraContent += investigationNotes;
                        break;
                    case 'archive':
                        title = `Archived: ${entry.originalUrl}`;
                        subtitle = `Service: ${entry.service || 'N/A'} | Timestamp: ${entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'N/A'}`;
                        description = entry.contentSummary || entry.description;
                        icon = 'fas fa-archive';
                        try {
                            faviconHtml = entry.url ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">` : '';
                        } catch (e) {
                            faviconHtml = '';
                        }
                        extraContent += investigationNotes;
                        break;
                    case 'messaging':
                        title = entry.username;
                        subtitle = `App: ${entry.messagingApp} | Chat: ${entry.chatId || 'N/A'}`;
                        description = entry.content || entry.description;
                        icon = 'fas fa-comment-dots';
                        extraContent += investigationNotes;
                        break;
                    case 'dating':
                        title = entry.username;
                        subtitle = `Platform: ${entry.platform} | Age: ${entry.age || 'N/A'}`;
                        description = entry.bio || entry.description || `Location: ${entry.location || 'N/A'}\nVerified: ${entry.verified || 'N/A'}\nSuspicious: ${entry.suspicious || 'N/A'}`;
                        icon = 'fas fa-heart';
                        extraContent = entry.photos ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Photos:</strong> ${entry.photos}</p>` : '';
                        extraContent += investigationNotes;
                        break;
                    case 'audio':
                        title = entry.title;
                        subtitle = `Format: ${entry.format} | Duration: ${entry.duration || 'N/A'}`;
                        description = entry.description || `Quality: ${entry.quality || 'N/A'}\nLanguage: ${entry.language || 'N/A'}\nTranscript: ${entry.transcript || 'N/A'}`;
                        icon = 'fas fa-volume-up';
                        extraContent = entry.base64Data ? `<audio controls style="max-width: 100%; margin-top: 10px;"><source src="${entry.base64Data}" type="audio/${entry.format}"></audio>` : '';
                        extraContent += `Speakers: ${entry.speakers || 'N/A'}<br>Background Noise: ${entry.background || 'N/A'}<br>Tools: ${entry.tools || 'N/A'}`;
                        extraContent += investigationNotes;
                        break;
                    case 'facial':
                        title = entry.subject;
                        subtitle = `Confidence: ${entry.confidence || 'N/A'}`;
                        description = entry.description || `Source: ${entry.sourceDescription || 'N/A'}\nProfiles: ${entry.identifiedProfiles || 'N/A'}\nTools: ${entry.toolsUsed || 'N/A'}`;
                        icon = 'fas fa-face-id-card'; // Font Awesome 6
                        extraContent += investigationNotes;
                        break;
                    case 'persona':
                        title = entry.name;
                        subtitle = `Real Name: ${entry.realName || 'N/A'}`;
                        description = entry.bio || entry.description || `Accounts: ${entry.associatedAccounts || 'N/A'}\nPlatforms: ${entry.platformsUsed || 'N/A'}\nOrigin: ${entry.origin || 'N/A'}`;
                        icon = 'fas fa-id-badge';
                        extraContent += investigationNotes;
                        break;
                    case 'vpn':
                        title = entry.name;
                        subtitle = `Type: ${entry.vpnType} | Jurisdiction: ${entry.jurisdiction || 'N/A'}`;
                        description = entry.description || `Logging: ${entry.logs || 'N/A'}\nPayment: ${entry.payment || 'N/A'}\nIssues: ${entry.issues || 'N/A'}`;
                        icon = 'fas fa-shield-alt';
                        extraContent += investigationNotes;
                        break;
                    case 'honeypot':
                        title = `Honeypot: ${entry.honeypotType}`;
                        subtitle = `Location: ${entry.location || 'N/A'}`;
                        description = entry.dataSummary || entry.description || `Purpose: ${entry.purpose || 'N/A'}\nAlerts: ${entry.alerts || 'N/A'}`;
                        icon = 'fas fa-honey-pot'; // Font Awesome 6
                        extraContent += investigationNotes;
                        break;
                    case 'exploit':
                        title = entry.name;
                        subtitle = `Target: ${entry.targetVuln} | Type: ${entry.exploitType}`;
                        description = entry.description || `Source: ${entry.marketSource || 'N/A'}\nPrice: ${entry.price || 'N/A'}`;
                        icon = 'fas fa-bomb';
                        extraContent += investigationNotes;
                        break;
                    case 'publicrecord':
                        title = `Record: ${entry.recordType}`;
                        subtitle = `Subject: ${entry.subjectName} | ID: ${entry.refId || 'N/A'}`;
                        description = entry.summary || entry.description || `Jurisdiction: ${entry.jurisdiction || 'N/A'}\nDate: ${entry.date || 'N/A'}`;
                        icon = 'fas fa-scale-balanced'; // Font Awesome 6
                        extraContent = entry.sourceUrl ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.sourceUrl}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> Source</a></p>` : '';
                        extraContent += investigationNotes;
                        break;
                    default:
                        title = entry.name || entry.title || entry.value || 'Unknown Entry';
                        subtitle = `Type: ${entry.type}`;
                        description = entry.description || entry.notes || 'No description available.';
                        icon = 'fas fa-question-circle';
                        break;
                }

                // NEW: Add source and metadata to card if they exist
                if (entry.source) { // Apply to all entries
                    extraContent += `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-satellite-dish"></i> Source: ${entry.source}</p>`;
                }
                if (entry.metadata && entry.metadata.length > 0) {
                    extraContent += `<div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Metadata:</strong>`;
                    entry.metadata.forEach(meta => {
                        extraContent += `<p style="margin-left: 10px;">- ${meta.key}: ${meta.value}</p>`;
                    });
                    extraContent += `</div>`;
                }

                return `
                    <div class="tool-card ${entry.starred ? 'starred' : ''} ${entry.pinned ? 'pinned' : ''} ${isSelected ? 'selected' : ''}"
                    data-entry-id="${entry.id}" data-entry-type="${entry.type}">
                        <div class="tool-header">
                            <div>
                                <div class="tool-title">
                                    <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''}>
                                    ${faviconHtml} <i class="${icon}" style="margin-right: 5px;"></i> <span>${title}</span>
                                    ${originTagHtml} </div>
                                <div class="tool-url">
                                    <span>${subtitle}</span> ${entry.url ? '<i class="fas fa-external-link-alt external-link-icon"></i>' : ''}
                                </div>
                            </div>
                            <div class="tool-actions">
                                <button class="action-btn" data-action="edit" title="Edit Entry">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn ${entry.starred ? 'starred' : ''}" data-action="star" title="Star Entry">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="action-btn ${entry.pinned ? 'pinned' : ''}" data-action="pin" title="Pin Entry">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                ${entry.url ? `<button class="action-btn" data-action="visit" title="Visit Link">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>` : ''}
                                <button class="action-btn" data-action="delete" title="Delete Entry">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                            ${description}
                        </p>
                        ${extraContent}
                        <div class="tool-tags">
                            ${entry.tags ? entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                        </div>
                    </div>
                `;
            }

        // MODIFIED: bindEvents function for event delegation
        function bindEvents() {

             // NEW: Case Studies Tab Event Listeners
            // Handle Case Studies Tab Navigation
            document.querySelector('[data-tab="case-studies"]').addEventListener('click', () => {
                switchTab('case-studies');
            });

            // Case Study Search Input
            document.getElementById('caseStudySearchInput').addEventListener('input', (e) => {
                appState.caseStudyFilters.search = e.target.value;
                renderCaseStudies();
            });

            // Case Study Type Filter Select
            document.getElementById('caseStudyFilterSelect').addEventListener('change', (e) => {
                appState.caseStudyFilters.type = e.target.value;
                renderCaseStudies();
            });

            // Add Case Study Button
            document.getElementById('addCaseStudyBtn').addEventListener('click', () => openAddEditCaseStudyModal('add'));
            document.getElementById('addCaseStudyEmptyStateBtn').addEventListener('click', () => openAddEditCaseStudyModal('add'));

            // Handle clicks on case study cards (for opening detail modal)
            document.getElementById('caseStudiesGrid').addEventListener('click', (e) => {
                const card = e.target.closest('.case-study-card');
                const actionBtn = e.target.closest('.action-btn');

                if (card && !actionBtn) { // If card is clicked and it's not an action button
                    const caseStudyId = card.dataset.caseStudyId;
                    openCaseStudyDetailModal(caseStudyId);
                } else if (actionBtn) { // If an action button is clicked
                    handleCaseStudyAction(e);
                }
            });

            // Threat Hunting Tab Event Listeners
            document.querySelector('[data-tab="threat-hunting"]').addEventListener('click', () => {
                switchTab('threat-hunting');
            });

            // Threat Hunting Sub-tab navigation
            document.querySelectorAll('.th-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchThSubTab(e.target.dataset.thSubtab);
                });
            });

            // Script Search Input
            document.getElementById('scriptSearchInput').addEventListener('input', (e) => {
                appState.scriptFilters.search = e.target.value;
                renderThreatHuntingScripts();
            });

            // Script Language Filter Select
            document.getElementById('scriptLanguageFilter').addEventListener('change', (e) => {
                appState.scriptFilters.language = e.target.value;
                renderThreatHuntingScripts();
            });

            // Add Script Button
            document.getElementById('addScriptBtn').addEventListener('click', () => openAddEditScriptModal('add'));
            document.getElementById('addScriptEmptyStateBtn').addEventListener('click', () => openAddEditScriptModal('add'));

            // Add/Edit Script Modal Buttons
            const cancelScriptAddEditBtn = document.getElementById('cancelScriptAddEdit');
            if (cancelScriptAddEditBtn) {
                cancelScriptAddEditBtn.onclick = () => hideModal('addEditScriptModal');
            }
            document.getElementById('addEditScriptForm').addEventListener('submit', handleAddEditScriptFormSubmit);

            // Script Library Grid/List actions (using delegation)
            const scriptLibraryGrid = document.getElementById('scriptLibraryGrid');
            if (scriptLibraryGrid) {
                scriptLibraryGrid.addEventListener('click', handleScriptAction);
            }

            // Script Code Display Modal (View Code) copy button
            const copyScriptCodeBtn = document.getElementById('copyScriptCodeBtn');
            if (copyScriptCodeBtn) {
                copyScriptCodeBtn.addEventListener('click', () => {
                    const codeToCopy = document.getElementById('displayScriptCode').textContent;
                    copyToClipboard(codeToCopy);
                    showToast('Script code copied to clipboard!');
                    hideModal('scriptCodeDisplayModal');
                });
            }

            // Case Study Add/Edit Modal Buttons
            document.getElementById('cancelCaseStudyAddEdit').addEventListener('click', () => hideModal('addEditCaseStudyModal'));
            document.getElementById('addEditCaseStudyForm').addEventListener('submit', handleCaseStudyFormSubmit);

            // Dynamic handling for custom incident type input
            document.getElementById('caseStudyIncidentType').addEventListener('change', (e) => {
                const newCaseStudyTypeInput = document.getElementById('newCaseStudyTypeInput');
                if (e.target.value === 'custom') {
                    newCaseStudyTypeInput.style.display = 'block';
                    newCaseStudyTypeInput.setAttribute('required', 'required');
                } else {
                    newCaseStudyTypeInput.style.display = 'none';
                    newCaseStudyTypeInput.removeAttribute('required');
                    newCaseStudyTypeInput.value = '';
                }
            });

            // Toolbar events for Add/Edit Case Study Modal rich text areas
            // You can attach generic listeners to the document for `formatting-btn` clicks
            // and then use `window.getSelection().focusNode` or `document.activeElement`
            // to determine which contenteditable div to apply the command to.
            // Example:
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('#addEditCaseStudyModal .formatting-toolbar .formatting-btn');
                if (!btn) return;

                const command = btn.dataset.command;
                const value = btn.dataset.value || null;
                const activeEditor = document.activeElement; // Get the currently focused contenteditable div

                if (activeEditor && (activeEditor.id === 'caseStudyAttackChain' || activeEditor.id === 'caseStudyLessons')) {
                    if (command === 'createLink') {
                        const url = prompt('Enter the URL:');
                        if (url) {
                            document.execCommand(command, false, url);
                        }
                    } else {
                        document.execCommand(command, false, value);
                    }
                    activeEditor.focus(); // Keep focus on the editor after command
                }
            });


            // Event listener for the "Vault Timeline" button in Custom Vault
            const customVaultTimelineBtn = document.getElementById('customVaultTimelineBtn');
            if (customVaultTimelineBtn) {
                customVaultTimelineBtn.addEventListener('click', () => {
                    if (appState.readOnlyMode) {
                        showToast("Cannot view timeline in read-only shared view.", "warning");
                        return;
                    }

                    // Set the view mode for this custom vault to 'timeline'
                    appState.customVaultViewMode = 'timeline';
                    saveState(); // Persist this preference

                    // Hide entry grid and show timeline display
                    document.getElementById('customTabToolsGrid').style.display = 'none';
                    document.getElementById('customTabTimelineDisplay').style.display = 'block';

                    // Hide entry-specific controls
                    document.getElementById('addEntryBtnCustomVault').style.display = 'none';
                    document.getElementById('customVaultViewToggle').style.display = 'none';
                    document.getElementById('bulkActions').style.display = 'none';

                    // NO LONGER HIDE PARENT/CHILD TABS HERE. They remain visible.
                    // document.getElementById('customVaultEntryParentTabs').style.display = 'none';
                    // document.getElementById('customVaultEntryChildTabs').style.display = 'none';

                    // Deactivate all child sub-tabs (like 'tool', 'email', etc.)
                    // This is important for visual consistency, as you're now in "timeline view"
                    document.querySelectorAll('.custom-vault-entry-child-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    // Also deactivate the parent tab if it's currently active based on an entry type
                    document.querySelectorAll('.custom-vault-entry-parent-tab').forEach(tab => {
                         tab.classList.remove('active');
                    });


                    renderCustomVaultTimeline(); // Render timeline for the current custom vault
                    showToast('Viewing Custom Vault Timeline.');
                });
            }

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                appState.filters.search = e.target.value;
                renderIntelligenceEntries();
            });

            // Search Scope Select
            document.getElementById('searchScopeSelect').addEventListener('change', (e) => {
                appState.filters.searchScope = e.target.value;
                renderIntelligenceEntries(); // Re-render with new scope
            });

            // Timeline Tab Buttons
            document.getElementById('addTimelineEventBtn').addEventListener('click', () => openAddEventModal('add'));
            document.getElementById('addEventBtnEmptyState').addEventListener('click', () => openAddEventModal('add'));
            document.getElementById('exportTimelineBtn').addEventListener('click', exportTimeline);
            document.getElementById('importTimelineBtn').addEventListener('click', () => showModal('importTimelineModal'));

            // Add Event Modal Buttons - Use `onclick` for direct assignment to ensure one listener
            const cancelAddEventBtn = document.getElementById('cancelAddEvent');
            if (cancelAddEventBtn) {
                cancelAddEventBtn.onclick = () => hideModal('addEventModal');
            }
            // Bind the submit event listener once to the form itself
            document.getElementById('addEventForm').addEventListener('submit', handleAddEditEvent);

            // Import Timeline Modal Buttons - Use `onclick` for direct assignment
            const cancelImportTimelineBtn = document.getElementById('cancelImportTimeline');
            if (cancelImportTimelineBtn) {
                cancelImportTimelineBtn.onclick = () => hideModal('importTimelineModal');
            }
            const confirmImportTimelineBtn = document.getElementById('confirmImportTimeline');
            if (confirmImportTimelineBtn) {
                confirmImportTimelineBtn.onclick = importTimeline;
            }

            // IMPORTANT FIX: Event delegation for timeline event card actions
            // Attach this listener ONCE to the stable parent container.
            // The `handleTimelineEventAction` function will then determine
            // which specific button within a dynamically generated card was clicked.
            const timelineEventsDisplay = document.getElementById('timeline-events-display');
            if (timelineEventsDisplay) {
                // Remove any existing listener to prevent duplicates if bindEvents is called multiple times
                // (though in current structure it should only be called once on init)
                timelineEventsDisplay.removeEventListener('click', handleTimelineEventAction); 
                timelineEventsDisplay.addEventListener('click', handleTimelineEventAction);
            }


            // Event listener for Desktop Recommendation Modal's "Continue Anyway" button
            const continueAnywayBtn = document.getElementById('continueAnywayBtn');
            if (continueAnywayBtn) {
                continueAnywayBtn.onclick = () => {
                    hideModal('desktopRecommendationModal');
                    sessionStorage.setItem('desktopRecommendationShown', 'true');
                };
            }

            // Filter controls
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                appState.filters.category = e.target.value;
                renderIntelligenceEntries();
            });

            document.getElementById('sortFilter').addEventListener('change', (e) => {
                appState.filters.sort = e.target.value;
                renderIntelligenceEntries();
            });
            
            // Handbook and Notes subtab events
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const subtab = e.target.dataset.subtab;
                    switchHandbookSubtab(subtab);
                });
            });

            document.getElementById('addToolBtnEmptyState').addEventListener('click', () => {
                openAddToolOnlyModal();
            });

            document.getElementById('addToolBtnIntelligenceVault').addEventListener('click', () => {
                openAddToolOnlyModal();
            });

            // Add event listeners for the new modal
            const cancelAddToolOnlyBtn = document.getElementById('cancelAddToolOnly');
            if (cancelAddToolOnlyBtn) {
                cancelAddToolOnlyBtn.onclick = () => hideModal('addToolOnlyModal');
            }
            document.getElementById('addToolOnlyForm').addEventListener('submit', handleAddToolOnly);

            // Add custom category input for the new modal
            document.getElementById('toolOnlyCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newToolOnlyCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = '';
                }
            });

            // Main tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });

            // Custom Vault Entry Parent Tabs (Delegation)
            const customVaultEntryParentTabsContainer = document.getElementById('customVaultEntryParentTabs');
            if (customVaultEntryParentTabsContainer) {
                customVaultEntryParentTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.custom-vault-entry-parent-tab');
                    if (tabBtn && tabBtn.dataset.parentTab) {
                        switchCustomVaultParentTab(tabBtn.dataset.parentTab);
                    }
                });
            }

            // Intelligence Vault Parent Tabs (Delegation)
            const intelligenceVaultParentTabsContainer = document.getElementById('intelligenceVaultParentTabs');
            if (intelligenceVaultParentTabsContainer) {
                intelligenceVaultParentTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.intelligence-vault-parent-tab');
                    if (tabBtn && tabBtn.dataset.parentTab) {
                        switchIntelligenceVaultParentTab(tabBtn.dataset.parentTab);
                    }
                });
            }

            // Intelligence Vault Child Tabs (Delegation)
            const intelligenceVaultChildTabsContainer = document.getElementById('intelligenceVaultChildTabs');
            if (intelligenceVaultChildTabsContainer) {
                intelligenceVaultChildTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.intelligence-vault-child-tab');
                    if (tabBtn && tabBtn.dataset.childTab) {
                        switchIntelligenceVaultChildTab(tabBtn.dataset.childTab);
                    }
                });
            }

            // Custom Vault Entry Child Tabs (Delegation)
            const customVaultEntryChildTabsContainer = document.getElementById('customVaultEntryChildTabs');
            if (customVaultEntryChildTabsContainer) {
                customVaultEntryChildTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.custom-vault-entry-child-tab');
                    if (tabBtn && tabBtn.dataset.childTab) {
                        switchCustomVaultEntrySubTab(tabBtn.dataset.childTab);
                    }
                });
            }


            // Tool actions (now generic for all entries) - Event delegation on the main content containers
            document.getElementById('toolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('customTabToolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('intelligenceVaultEntries').addEventListener('click', handleEntryAction);
            
            // Event delegation for bulk selection checkboxes
            document.getElementById('toolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('customTabToolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('intelligenceVaultEntries').addEventListener('change', handleBulkSelection);

            // Modal controls (Add New Entry) - specific to Multi-Vault now
            document.getElementById('addEntryBtnCustomVault').addEventListener('click', () => {
                document.getElementById('entryTypeSelect').value = 'tool';
                displayEntryForm();
                showModal('addEntryModal');
            });
            const cancelAddEntryBtn = document.getElementById('cancelAddEntry');
            if (cancelAddEntryBtn) {
                cancelAddEntryBtn.onclick = () => hideModal('addEntryModal');
            }

            // Dynamic form display for Add Entry modal
            document.getElementById('entryTypeSelect').addEventListener('change', displayEntryForm);
            
            // Custom category input (Add Tool)
            document.getElementById('toolCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = '';
                }
            });
            
            // Intelligence Vault Category Search (for Add Tool modal)
            const intelligenceVaultCategorySearchInputAdd = document.getElementById('intelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInputAdd) {
                intelligenceVaultCategorySearchInputAdd.addEventListener('input', (e) => {
                    const currentSelections = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked')).map(cb => cb.value);
                    populateIntelligenceVaultCategoriesCheckboxesAddTool(currentSelections, e.target.value);
                });
            }

            // Intelligence Vault Category Search (for EDIT Tool modal, using unique ID)
            const intelligenceVaultCategorySearchInputEdit = document.getElementById('editIntelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInputEdit) {
                intelligenceVaultCategorySearchInputEdit.addEventListener('input', (e) => {
                    const currentToolId = document.getElementById('editEntryId').value;
                    const toolToEdit = appState.tools.find(t => t.id === currentToolId);
                    if (toolToEdit) {
                        populateIntelligenceVaultCategoriesCheckboxesEditTool(toolToEdit.intelligenceVaultCategories || [], e.target.value);
                    }
                });
            }

            // Form submission (Add Entry)
            document.getElementById('addEntryForm').addEventListener('submit', handleAddEntry);

            // Modal controls (Edit Entry)
            const cancelEditEntryBtn = document.getElementById('cancelEditEntry');
            if (cancelEditEntryBtn) {
                cancelEditEntryBtn.onclick = () => hideModal('editEntryModal');
            }
            // Custom category input (Edit Tool)
            document.getElementById('editToolCategory').addEventListener('change', (e) => {
                const editNewCategoryInput = document.getElementById('editNewCategoryInput');
                if (e.target.value === 'custom') {
                    editNewCategoryInput.style.display = 'block';
                    editNewCategoryInput.setAttribute('required', 'required');
                } else {
                    editNewCategoryInput.style.display = 'none';
                    editNewCategoryInput.removeAttribute('required');
                    editNewCategoryInput.value = '';
                }
            });
            // Form submission (Edit Entry)
            document.getElementById('editEntryForm').addEventListener('submit', handleEditEntry);

            // NEW: Add/Remove Metadata buttons in Add/Edit Entry forms
            document.getElementById('addMetadataBtn').addEventListener('click', () => addMetadataField('add'));
            document.getElementById('customMetadataEntries').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-metadata-btn')) {
                    e.target.closest('.form-group.metadata-entry').remove();
                }
            });
            document.getElementById('editAddMetadataBtn').addEventListener('click', () => addMetadataField('edit'));
            document.getElementById('editCustomMetadataEntries').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-metadata-btn')) {
                    e.target.closest('.form-group.metadata-entry').remove();
                }
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Quick actions
            document.getElementById('pinAllBtn').addEventListener('click', togglePinFilter);
            document.getElementById('starAllBtn').addEventListener('click', toggleStarFilter);
            document.getElementById('showAllBtn').addEventListener('click', clearFilters);
            document.getElementById('reportBtn').addEventListener('click', generateReport);

            // Clear filters (from empty state button)
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

            // Bulk actions
            document.getElementById('bulkStarBtn').addEventListener('click', () => bulkAction('star'));
            document.getElementById('bulkPinBtn').addEventListener('click', () => bulkAction('pin'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', () => bulkAction('delete'));

            // Export
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // View toggle (Grid/List)
            document.getElementById('viewToggle').addEventListener('click', toggleViewMode);
            // Intelligence Vault View Toggle
            document.getElementById('vaultViewToggle').addEventListener('click', toggleViewMode);
            //Multi Vault View Toggle
            document.getElementById('customVaultViewToggle').addEventListener('click', toggleViewMode);

            // Refresh Threats button
            document.getElementById('refreshThreatsBtn').addEventListener('click', loadThreats);

            // Custom Sub-tab buttons
            document.getElementById('createSubTabBtn').addEventListener('click', () => showCreateSubTabModal());
            document.getElementById('createSubTabBtnEmptyState').addEventListener('click', () => showCreateSubTabModal());
            const cancelCreateSubTabBtn = document.getElementById('cancelCreateSubTab');
            if (cancelCreateSubTabBtn) {
                cancelCreateSubTabBtn.onclick = () => hideModal('createSubTabModal');
            }
            document.getElementById('createSubTabForm').addEventListener('submit', handleCreateSubTab);

            document.getElementById('editSubTabBtn').addEventListener('click', () => openEditSubTabModal());
            const cancelEditSubTabBtn = document.getElementById('cancelEditSubTab');
            if (cancelEditSubTabBtn) {
                cancelEditSubTabBtn.onclick = () => hideModal('editSubTabModal');
            }
            document.getElementById('editSubTabForm').addEventListener('submit', handleEditSubTab);

            document.getElementById('deleteSubTabBtn').addEventListener('click', handleDeleteSubTab);
            document.getElementById('exportSubTabBtn').addEventListener('click', exportCustomTab);
            document.getElementById('newRandomBtn').addEventListener('click', showRandomDiscovery);
            
            // New: Share options button and modal events
            document.getElementById('shareOptionsBtn').addEventListener('click', showShareOptionsModal);
            const cancelShareOptionsBtn = document.getElementById('cancelShareOptions');
            if (cancelShareOptionsBtn) {
                cancelShareOptionsBtn.onclick = () => hideModal('shareOptionsModal');
            }
            document.getElementById('shareScopeSelect').addEventListener('change', handleShareScopeChange);
            document.getElementById('shareForm').addEventListener('submit', handleShareFormSubmit);


            // Click listener for custom sub-tabs (delegated)
            document.getElementById('customSubTabs').addEventListener('click', (e) => {
                const tabBtn = e.target.closest('.sub-nav-tab');
                if (tabBtn && tabBtn.dataset.subTabId) {
                    switchCustomTab(tabBtn.dataset.subTabId);
                }
            });

            // Event listener for custom tab checkboxes in Edit Tool Modal
            document.getElementById('assignCustomTabsCheckboxes').addEventListener('change', (e) => {
                if (e.target.classList.contains('custom-tab-assign-checkbox')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            });

            // Icon picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#newSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('newSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Icon picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#editedSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('editedSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Color picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#newSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('newSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

            // Color picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#editedSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('editedSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', openMobileMenu);
            }
            const mainNavTabs = document.querySelector('.main-nav-tabs');
            const headerControls = document.querySelector('.controls');

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', () => {
                    const mobileMenuOverlay = document.createElement('div');
                    mobileMenuOverlay.classList.add('mobile-menu-overlay');
                    document.body.appendChild(mobileMenuOverlay);

                    const mobileSidebarMenu = document.getElementById('mobileSidebarMenu');
                    if (!mobileSidebarMenu) {
                        // This block should ideally create the menu if it doesn't exist.
                        // However, the menu's HTML structure is already in the document, just hidden.
                        // Re-creating it here would duplicate elements.
                        // The correct approach is to populate the *existing* mobile menu.
                        console.error("Mobile sidebar menu element not found. Please ensure #mobileSidebarMenu is in HTML.");
                        return; // Exit to prevent errors if element missing
                    }
                    
                    // Populate the mobile menu content when opened
                    const mobileMenuContent = mobileSidebarMenu.querySelector('.mobile-menu-content');
                    mobileMenuContent.innerHTML = ''; // Clear existing content before populating

                    const navClonedContainer = document.createElement('div');
                    navClonedContainer.classList.add('mobile-nav-cloned');
                    mobileMenuContent.appendChild(navClonedContainer);

                    mainNavTabs.querySelectorAll('.nav-tab').forEach(originalTab => {
                        const newTabButton = document.createElement('button');
                        newTabButton.classList.add('nav-tab');
                        newTabButton.dataset.tab = originalTab.dataset.tab;
                        newTabButton.innerHTML = originalTab.innerHTML;
                        newTabButton.addEventListener('click', () => {
                            switchTab(originalTab.dataset.tab);
                            closeMobileMenu();
                        });
                        navClonedContainer.appendChild(newTabButton);
                    });

                    const controlsClonedContainer = document.createElement('div');
                    controlsClonedContainer.classList.add('mobile-controls-cloned');
                    mobileMenuContent.appendChild(controlsClonedContainer);

                    const searchContainerHtml = `
                        <div class="search-container">
                            <input type="text" class="search-input" id="mobileSearchInput" placeholder="Search...">
                            <i class="fas fa-search search-icon"></i>
                            <select id="mobileSearchScopeSelect">
                                <option value="currentTab">Current Tab</option>
                                <option value="allVault">All Intelligence Vault</option>
                                <option value="allData">All Data</option>
                            </select>
                        </div>
                    `;
                    controlsClonedContainer.insertAdjacentHTML('beforeend', searchContainerHtml);

                    const exportBtn = document.getElementById('exportBtn');
                    if (exportBtn) {
                        const mobileExportBtn = document.createElement('button');
                        mobileExportBtn.className = exportBtn.className + ' mobile-btn';
                        mobileExportBtn.innerHTML = exportBtn.innerHTML;
                        mobileExportBtn.addEventListener('click', () => { exportData(); closeMobileMenu(); });
                        controlsClonedContainer.appendChild(mobileExportBtn);
                    }

                    const shareOptionsBtn = document.getElementById('shareOptionsBtn');
                    if (shareOptionsBtn) {
                        const mobileShareOptionsBtn = document.createElement('button');
                        mobileShareOptionsBtn.className = shareOptionsBtn.className + ' mobile-btn';
                        mobileShareOptionsBtn.innerHTML = shareOptionsBtn.innerHTML;
                        mobileShareOptionsBtn.addEventListener('click', () => { showShareOptionsModal(); closeMobileMenu(); });
                        controlsClonedContainer.appendChild(mobileShareOptionsBtn);
                    }

                    const themeToggle = document.getElementById('themeToggle');
                    if (themeToggle) {
                        const mobileThemeToggle = document.createElement('button');
                        mobileThemeToggle.className = themeToggle.className + ' mobile-btn';
                        mobileThemeToggle.innerHTML = themeToggle.innerHTML;
                        mobileThemeToggle.addEventListener('click', toggleTheme);
                        controlsClonedContainer.appendChild(mobileThemeToggle);
                    }

                    const mobileSearchInput = mobileMenuContent.querySelector('#mobileSearchInput');
                    if (mobileSearchInput) {
                        mobileSearchInput.value = appState.filters.search;
                        mobileSearchInput.addEventListener('input', (e) => {
                            appState.filters.search = e.target.value;
                            renderIntelligenceEntries();
                        });
                    }

                    const mobileSearchScopeSelect = mobileMenuContent.querySelector('#mobileSearchScopeSelect');
                    if (mobileSearchScopeSelect) {
                        mobileSearchScopeSelect.value = appState.filters.searchScope;
                        mobileSearchScopeSelect.addEventListener('change', (e) => {
                            appState.filters.searchScope = e.target.value;
                            renderIntelligenceEntries();
                        });
                    }

                    mobileSidebarMenu.classList.add('active');
                    document.body.classList.add('no-scroll');

                    mobileSidebarMenu.querySelector('.close-menu-btn').addEventListener('click', closeMobileMenu);
                    mobileMenuOverlay.addEventListener('click', closeMobileMenu); // Close when clicking overlay
                });
            }
        }

        function closeMobileMenu() {
            const mobileSidebarMenu = document.getElementById('mobileSidebarMenu');
            const mobileMenuOverlay = document.querySelector('.mobile-menu-overlay'); // Assuming you add this overlay for better UX

            if (mobileSidebarMenu) {
                mobileSidebarMenu.classList.remove('active'); // CSS to slide out
            }
            if (mobileMenuOverlay) {
                mobileMenuOverlay.remove(); // Remove the overlay from DOM
            }
            document.body.classList.remove('no-scroll');
        }

        // Handles actions on individual case study cards (star, pin, edit, delete)
        function handleCaseStudyAction(e) {
            if (appState.readOnlyMode) {
                showToast("Cannot perform actions in read-only shared view.", "warning");
                return;
            }

            const targetBtn = e.target.closest('.action-btn');
            if (!targetBtn) return;

            e.stopPropagation(); // Prevent the card click from opening the detail modal
            const action = targetBtn.dataset.action;
            const caseStudyId = targetBtn.dataset.caseStudyId || targetBtn.closest('.case-study-card').dataset.caseStudyId;

            const caseStudy = appState.caseStudies.find(cs => cs.id === caseStudyId);
            if (!caseStudy) return;

            switch (action) {
                case 'edit-case-study':
                    openAddEditCaseStudyModal('edit', caseStudy.id);
                    break;
                case 'star-case-study':
                    caseStudy.starred = !caseStudy.starred;
                    showToast(caseStudy.starred ? 'Case study starred!' : 'Case study unstarred!');
                    break;
                case 'pin-case-study':
                    caseStudy.pinned = !caseStudy.pinned;
                    showToast(caseStudy.pinned ? 'Case study pinned!' : 'Case study unpinned!');
                    break;
                case 'delete-case-study':
                    if (confirm('Are you sure you want to delete this case study?')) {
                        appState.caseStudies = appState.caseStudies.filter(cs => cs.id !== caseStudyId);
                        showToast('Case study deleted!', 'error');
                    }
                    break;
            }

            saveCaseStudies();
            renderCaseStudies(); // Re-render to reflect changes
            updateStats(); // Update global stats
        }
        // Timeline Functions
        function openAddEventModal(mode, eventId = null) {
            if (appState.readOnlyMode) {
                showToast("Cannot add/edit events in read-only shared view.", "warning");
                return;
            }

            const modalTitle = document.getElementById('addEventModal').querySelector('h3');
            const saveButton = document.getElementById('saveEventBtn');
            const form = document.getElementById('addEventForm');
            form.reset();
            document.getElementById('editEventId').value = '';

            // Populate categories dropdown
            const eventCategorySelect = document.getElementById('eventCategory');
            eventCategorySelect.innerHTML = '<option value="">Select Category</option>';
            for (const key in timelineCategories) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = timelineCategories[key].name;
                eventCategorySelect.appendChild(option);
            }

            if (mode === 'add') {
               modalTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Timeline Event';
               saveButton.textContent = 'Add Event';
               saveButton.dataset.mode = 'add';
               // Set current timestamp as default, formatted correctly for datetime-local
               const now = new Date();
               // The toISOString() method returns a string in simplified extended ISO format (ISO 8601),
               // which is 'YYYY-MM-DDTHH:mm:ss.sssZ'.
               // We need to slice it to 'YYYY-MM-DDTHH:mm' for datetime-local input.
               document.getElementById('eventTimestamp').value = now.toISOString().slice(0, 16);
           } else if (mode === 'edit' && eventId) {
               const eventToEdit = appState.timeline.events.find(event => event.id === eventId);
               if (!eventToEdit) {
                   showToast("Event not found for editing.", "error");
                   return;
               }
               modalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Timeline Event';
               saveButton.textContent = 'Save Changes';
               saveButton.dataset.mode = 'edit';
               document.getElementById('editEventId').value = eventToEdit.id;

               // Populate form fields with event data
               // Ensure edited timestamp is also formatted correctly for datetime-local
               document.getElementById('eventTimestamp').value = eventToEdit.timestamp.toISOString().slice(0, 16);
               document.getElementById('eventTitle').value = eventToEdit.title;
               document.getElementById('eventCategory').value = eventToEdit.category;
               document.getElementById('eventNotes').value = eventToEdit.notes;
               document.getElementById('eventConfidence').value = eventToEdit.confidence;
               document.getElementById('eventEvidence').value = eventToEdit.evidence;
               document.getElementById('eventActor').value = eventToEdit.actor;
           }
           showModal('addEventModal');
       }

        // Locate this function in your <script> block
        function handleAddEditEvent(e) {
            e.preventDefault();
            if (appState.readOnlyMode) {
                showToast("Cannot add/edit events in read-only shared view.", "warning");
                return;
            }

            const mode = document.getElementById('saveEventBtn').dataset.mode;
            const eventId = document.getElementById('editEventId').value;

            const timestampInput = document.getElementById('eventTimestamp').value;
            const timestamp = new Date(timestampInput);

            const title = document.getElementById('eventTitle').value.trim();
            const category = document.getElementById('eventCategory').value;
            const notes = document.getElementById('eventNotes').value.trim();
            const confidence = document.getElementById('eventConfidence').value;
            const evidence = document.getElementById('eventEvidence').value.trim();
            const actor = document.getElementById('eventActor').value.trim();
            
            if (!timestampInput || isNaN(timestamp.getTime()) || !title || !category || !confidence) {
                showToast("Please enter a valid date/time and fill in all required event fields.", "error");
                return;
            }

            if (mode === 'add') {
                const newEvent = {
                    id: generateId(),
                    timestamp: timestamp, 
                    title: title,
                    category: category,
                    notes: notes,
                    confidence: confidence,
                    evidence: evidence,
                    actor: actor,
                };
                appState.timeline.events.push(newEvent);
                showToast("Event added successfully!");
            } else if (mode === 'edit') {
                const eventToUpdate = appState.timeline.events.find(event => event.id === eventId);
                if (eventToUpdate) {
                    eventToUpdate.timestamp = timestamp; 
                    eventToUpdate.title = title;
                    eventToUpdate.category = category;
                    eventToUpdate.notes = notes;
                    eventToUpdate.confidence = confidence;
                    eventToUpdate.evidence = evidence;
                    eventToUpdate.actor = actor;
                    showToast("Event updated successfully!");
                } else {
                    showToast("Error: Event not found for update.", "error");
                }
            }

            hideModal('addEventModal');
            saveState(); // Save data immediately

            // CRITICAL FIX: Call renderTimelineEvents directly and immediately.
            renderTimelineEvents();
        }



        // Locate this function in your <script> block
        function renderTimelineEvents() {
            const timelineDisplay = document.getElementById('timeline-events-display');
            const emptyState = document.getElementById('emptyTimelineState');

            if (!timelineDisplay || !emptyState) {
                console.error("renderTimelineEvents: Required DOM elements (timeline-events-display or emptyTimelineState) not found.");
                return;
            }

            // Use a DocumentFragment for efficient DOM manipulation
            const fragment = document.createDocumentFragment();

            if (appState.timeline.events.length === 0) {
                // If no events, just show the empty state and clear the display
                emptyState.style.display = 'block';
                timelineDisplay.innerHTML = ''; // Ensure display is clear
            } else {
                emptyState.style.display = 'none';
                
                // Sort events by timestamp in ascending order
                const sortedEvents = [...appState.timeline.events].sort((a, b) => {
                    // Ensure timestamps are Date objects for comparison
                    const aTime = (a.timestamp instanceof Date) ? a.timestamp.getTime() : new Date(a.timestamp).getTime();
                    const bTime = (b.timestamp instanceof Date) ? b.timestamp.getTime() : new Date(b.timestamp).getTime();
                    return aTime - bTime;
                });

                sortedEvents.forEach(event => {
                    const categoryInfo = timelineCategories[event.category] || { name: event.category, icon: "fas fa-question-circle", color: "var(--primary)" };

                    // Robust check for valid Date object before trying to use it
                    if (!(event.timestamp instanceof Date) || isNaN(event.timestamp.getTime())) {
                        console.error("Invalid timestamp found for event, skipping rendering:", event);
                        return; // Skip this event if its timestamp is invalid
                    }

                    const eventDate = event.timestamp.toLocaleDateString();
                    const eventTime = event.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    const eventCardDiv = document.createElement('div');
                    eventCardDiv.classList.add('timeline-event-card');
                    if (event.category) eventCardDiv.dataset.category = event.category;
                    if (event.confidence) eventCardDiv.dataset.confidence = event.confidence;
                    eventCardDiv.dataset.eventId = event.id;
                    eventCardDiv.style.borderLeft = `5px solid ${categoryInfo.color || 'var(--primary)'}`;

                    eventCardDiv.innerHTML = `
                        <div class="timeline-event-header">
                            <div class="timeline-event-title">
                                <i class="${categoryInfo.icon}" style="color: ${categoryInfo.color || 'var(--primary)'};"></i> ${event.title}
                            </div>
                            <span class="timeline-event-timestamp">${eventDate} ${eventTime}</span>
                            <div class="timeline-event-actions">
                                <button class="action-btn edit-event-btn" data-event-id="${event.id}" title="Edit Event">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-event-btn" data-event-id="${event.id}" title="Delete Event">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="timeline-event-notes">${event.notes || 'No notes.'}</p>
                        <div class="timeline-event-meta">
                            <span><i class="fas fa-certificate"></i> Confidence: <strong style="color: var(--${event.confidence});">${event.confidence.charAt(0).toUpperCase() + event.confidence.slice(1)}</strong></span>
                            <span><i class="fas fa-tag"></i> Category: ${categoryInfo.name}</span>
                            ${event.actor ? `<span><i class="fas fa-user-circle"></i> Actor: ${event.actor}</span>` : ''}
                            ${event.evidence ? `<span><i class="fas fa-paperclip"></i> Evidence: <a href="${event.evidence}" target="_blank" style="color: var(--primary); text-decoration: none;">${event.evidence.length > 30 ? event.evidence.substring(0, 27) + '...' : event.evidence}</a></span>` : ''}
                        </div>
                    `;
                    fragment.appendChild(eventCardDiv);
                });

                // Clear the actual container first, then append the new fragment
                timelineDisplay.innerHTML = '';
                timelineDisplay.appendChild(fragment);

                // Force a reflow immediately after DOM update
                // This is a common hack to force the browser to re-render.
                void timelineDisplay.offsetHeight;

                // Ensure event listeners are re-attached to the newly rendered buttons.
                // This is critical since innerHTML replaced all elements.
                // The event delegation for handleTimelineEventAction already exists, so no new calls here.
                // We do *not* call addNoteCardListeners() here, as this function is for timeline events, not notes.
            }
        }
        // Locate this function in your <script> block
        function handleTimelineEventAction(e) {
            if (appState.readOnlyMode) {
                showToast("Cannot perform actions in read-only shared view.", "warning");
                return;
            }

            const targetBtn = e.target.closest('.action-btn');
            if (!targetBtn) return;

            e.preventDefault();
            const action = targetBtn.classList.contains('edit-event-btn') ? 'edit' : 'delete';
            const eventId = targetBtn.dataset.eventId || targetBtn.closest('.timeline-event-card').dataset.eventId;

            if (action === 'edit') {
                openAddEventModal('edit', eventId);
            } else if (action === 'delete') {
                if (confirm('Are you sure you want to delete this timeline event?')) {
                    appState.timeline.events = appState.timeline.events.filter(event => event.id !== eventId);
                    showToast("Event deleted!", "error");
                    saveState(); // Save data immediately

                    // CRITICAL FIX: Call renderTimelineEvents directly and immediately.
                    renderTimelineEvents();
                }
            }
        }

        function exportTimeline() {
            if (appState.readOnlyMode) {
                showToast("Cannot export timeline in read-only shared view.", "warning");
                return;
            }

            const dataToExport = JSON.parse(JSON.stringify(appState.timeline));
            dataToExport.events.forEach(event => {
                event.timestamp = new Date(event.timestamp).toISOString();
            });

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'osintvault_timeline.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Timeline exported successfully!', 'success');
        }

        function importTimeline() {
            if (appState.readOnlyMode) {
                showToast("Cannot import timeline in read-only shared view.", "warning");
                return;
            }

            const fileInput = document.getElementById('importTimelineFile');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Please select a JSON file to import.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (importedData.events && Array.isArray(importedData.events)) {
                        const validEvents = importedData.events.map(event => {
                            if (!event.id || !event.timestamp || !event.title || !event.category || !event.confidence) {
                                throw new Error("Invalid event format in imported file.");
                            }
                            const parsedDate = new Date(event.timestamp); // Ensure string is parsed to Date object
                            if (isNaN(parsedDate.getTime())) throw new Error("Invalid timestamp in imported event.");
                            event.timestamp = parsedDate;
                            return event;
                        });

                        appState.timeline.events = validEvents;
                        hideModal('importTimelineModal');
                        showToast('Timeline imported successfully!', 'success');
                        renderTimelineEvents();
                        saveState();
                    } else {
                        throw new Error("Invalid timeline data format. Expected an 'events' array.");
                    }
                } catch (e) {
                    showToast(`Error importing timeline: ${e.message}`, 'error');
                    console.error("Timeline import error:", e);
                }
            };
            reader.readAsText(file);
        }

        /* -------------------------------------------------------------------------- */
        /* Cyber Threat Hunting Toolkit JS                                            */
        /* -------------------------------------------------------------------------- */

        // Initializes the Threat Hunting Toolkit tab
        function initThreatHuntingToolkit() {
            populateScriptLanguageFilter(); // Populate language filter dropdown
            renderThreatHuntingScripts();   // Render scripts for the active sub-tab
            appState.currentThSubTab = 'script-library'; // **ADD THIS LINE**
            switchThSubTab(appState.currentThSubTab); // Ensure correct sub-tab is active
        }

        // Switches between Threat Hunting sub-tabs (Script Library, Dashboards, Playbooks)
        function switchThSubTab(subtabName) {
            appState.currentThSubTab = subtabName;

            document.querySelectorAll('.th-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.th-subtab[data-th-subtab="${subtabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }

            document.querySelectorAll('.th-subtab-content').forEach(content => {
                content.style.display = 'none';
            });
            const targetContent = document.getElementById(`${subtabName}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }

            // Only render scripts if on the 'script-library' sub-tab
            if (subtabName === 'script-library') {
                renderThreatHuntingScripts();
            }
            // No specific rendering needed for 'dashboards' or 'playbooks' currently, as they are empty states
            saveState();
        }

        // Populates the language filter dropdown for scripts
        function populateScriptLanguageFilter() {
            const languageFilterSelect = document.getElementById('scriptLanguageFilter');
            const existingLanguages = new Set(appState.threatHuntingScripts.map(script => script.language.toLowerCase()));

            const defaultLanguages = ['powershell', 'python', 'bash', 'cmd', 'c#', 'go', 'other'];

            const allLanguages = new Set([...defaultLanguages.map(lang => lang.toLowerCase()), ...Array.from(existingLanguages)]);

            languageFilterSelect.innerHTML = '<option value="">All Languages</option>';

            Array.from(allLanguages)
                .sort((a, b) => a.localeCompare(b))
                .forEach(language => {
                    const option = document.createElement('option');
                    option.value = language;
                    option.textContent = language.charAt(0).toUpperCase() + language.slice(1);
                    languageFilterSelect.appendChild(option);
                });

            languageFilterSelect.value = appState.scriptFilters.language; // Set selected filter
        }


        // Renders the list of threat hunting scripts
        function renderThreatHuntingScripts() {
            const scriptLibraryGrid = document.getElementById('scriptLibraryGrid');
            const emptyState = document.getElementById('emptyScriptLibraryState');

            const filteredScripts = filterThreatHuntingScripts();

            if (filteredScripts.length === 0) {
                emptyState.style.display = 'block';
                scriptLibraryGrid.style.display = 'none';
                if (appState.scriptFilters.search || appState.scriptFilters.language) {
                    emptyState.innerHTML = `<i class="fas fa-search"></i><h3>No matching scripts found</h3><p>Adjust your search or filters.</p>`;
                } else {
                    emptyState.innerHTML = `<i class="fas fa-code"></i><h3>No Scripts Found</h3><p>Add your first threat hunting script to get started!</p><button class="btn btn-primary" id="addScriptEmptyStateBtn"><i class="fas fa-plus"></i> Add First Script</button>`;
                    document.getElementById('addScriptEmptyStateBtn').addEventListener('click', () => openAddEditScriptModal('add'));
                }
            } else {
                emptyState.style.display = 'none';
                scriptLibraryGrid.style.display = 'grid'; // Ensure grid display for scripts
                scriptLibraryGrid.innerHTML = filteredScripts.map(script => createScriptCard(script)).join('');
            }
            saveState(); // Save state after rendering
        }

        // Filters scripts based on current search and language filters
        function filterThreatHuntingScripts() {
            let filtered = [...appState.threatHuntingScripts];

            const searchTerm = appState.scriptFilters.search.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(script => {
                    const searchFields = [
                        script.name, script.description, script.language, script.code,
                        script.tags ? script.tags.join(' ') : ''
                    ].map(field => String(field || '').toLowerCase());
                    return searchFields.some(field => field.includes(searchTerm));
                });
            }

            const selectedLanguage = appState.scriptFilters.language;
            if (selectedLanguage) {
                filtered = filtered.filter(script => script.language.toLowerCase() === selectedLanguage.toLowerCase());
            }

            // Sort by addedDate descending (most recent first)
            filtered.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate));

            return filtered;
        }

        // Creates the HTML for a single script card
        function createScriptCard(script) {
            const languageIcon = {
                'powershell': 'fab fa-windows', // Windows icon for PowerShell
                'python': 'fab fa-python',
                'bash': 'fas fa-terminal',
                'cmd': 'fas fa-terminal',
                'c#': 'fas fa-code',
                'go': 'fab fa-gofore', // Go lang icon
                'other': 'fas fa-file-code'
            }[script.language.toLowerCase()] || 'fas fa-file-code'; // Default icon

            return `
                <div class="tool-card" data-script-id="${script.id}" data-script-language="${script.language}">
                    <div class="tool-header">
                        <div>
                            <div class="tool-title">
                                <i class="${languageIcon}" style="color: var(--accent); margin-right: 8px;"></i>
                                <span>${script.name}</span>
                                <span class="script-language">${script.language}</span>
                            </div>
                            <div class="tool-url" style="display: none;"></div>
                        </div>
                        <div class="tool-actions">
                            <button class="action-btn" data-action="view-code" title="View Script Code">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn" data-action="edit-script" title="Edit Script">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" data-action="copy-code" title="Copy Script Code">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn" data-action="delete-script" title="Delete Script">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                        ${script.description || 'No description available.'}
                    </p>
                    <div class="tool-tags">
                        ${script.tags ? script.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                    </div>
                </div>
            `;
        }

        // Opens the Add/Edit Script Modal
        function openAddEditScriptModal(mode, scriptId = null) {
            if (appState.readOnlyMode) {
                showToast("Cannot add/edit scripts in read-only shared view.", "warning");
                return;
            }

            const form = document.getElementById('addEditScriptForm');
            form.reset(); // Clear all form fields
            document.getElementById('scriptId').value = ''; // Clear hidden ID

            if (mode === 'add') {
                document.getElementById('addEditScriptModalTitle').textContent = 'Add New Script';
                document.getElementById('saveScriptBtn').textContent = 'Save Script';
                document.getElementById('saveScriptBtn').dataset.mode = 'add';
                document.getElementById('scriptLanguage').value = ''; // Reset language dropdown
            } else if (mode === 'edit' && scriptId) {
                const scriptToEdit = appState.threatHuntingScripts.find(s => s.id === scriptId);
                if (!scriptToEdit) {
                    showToast("Script not found for editing.", "error");
                    return;
                }

                document.getElementById('addEditScriptModalTitle').textContent = 'Edit Script';
                document.getElementById('saveScriptBtn').textContent = 'Save Changes';
                document.getElementById('saveScriptBtn').dataset.mode = 'edit';

                document.getElementById('scriptId').value = scriptToEdit.id;
                document.getElementById('scriptName').value = scriptToEdit.name;
                document.getElementById('scriptDescription').value = scriptToEdit.description;
                document.getElementById('scriptLanguage').value = scriptToEdit.language;
                document.getElementById('scriptCode').value = scriptToEdit.code;
                document.getElementById('scriptTags').value = scriptToEdit.tags ? scriptToEdit.tags.join(', ') : '';
            }
            showModal('addEditScriptModal');
        }

        // Handles form submission for adding or editing a script
        function handleAddEditScriptFormSubmit(e) {
            e.preventDefault();
            if (appState.readOnlyMode) {
                showToast("Cannot save scripts in read-only shared view.", "warning");
                return;
            }

            const mode = document.getElementById('saveScriptBtn').dataset.mode;
            const scriptId = document.getElementById('scriptId').value;

            const name = document.getElementById('scriptName').value.trim();
            const description = document.getElementById('scriptDescription').value.trim();
            const language = document.getElementById('scriptLanguage').value;
            const code = document.getElementById('scriptCode').value.trim();
            const tags = document.getElementById('scriptTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

            if (!name || !language || !code) {
                showToast('Please fill in all required fields (Name, Language, Code).', 'error');
                return;
            }

            const newScript = {
                id: mode === 'add' ? generateId() : scriptId,
                name: name,
                description: description,
                language: language,
                code: code,
                tags: tags,
                addedDate: new Date(),
                usageCount: 0 // Retain or set for new
            };

            if (mode === 'add') {
                appState.threatHuntingScripts.push(newScript);
                showToast('Script added successfully!');
            } else if (mode === 'edit') {
                const index = appState.threatHuntingScripts.findIndex(s => s.id === scriptId);
                if (index > -1) {
                    // Retain original usageCount if available
                    newScript.usageCount = appState.threatHuntingScripts[index].usageCount;
                    appState.threatHuntingScripts[index] = newScript;
                    showToast('Script updated successfully!');
                } else {
                    showToast('Error: Script not found for update.', 'error');
                }
            }

            hideModal('addEditScriptModal');
            renderThreatHuntingScripts(); // Re-render the list
            populateScriptLanguageFilter(); // Update language filter options
            saveState(); // Save to local storage
        }

        // Handles actions on individual script cards (view, edit, copy, delete)
        function handleScriptAction(e) {
            if (appState.readOnlyMode) {
                showToast("Cannot perform actions in read-only shared view.", "warning");
                return;
            }

            const targetBtn = e.target.closest('.action-btn');
            if (!targetBtn) return;

            e.preventDefault();
            const action = targetBtn.dataset.action;
            const scriptCard = e.target.closest('.tool-card'); // Reusing .tool-card class
            const scriptId = scriptCard.dataset.scriptId;

            const script = appState.threatHuntingScripts.find(s => s.id === scriptId);
            if (!script) return;

            switch (action) {
                case 'view-code':
                    document.getElementById('displayScriptName').textContent = script.name;
                    document.getElementById('displayScriptCode').textContent = script.code;
                    showModal('scriptCodeDisplayModal');
                    script.usageCount = (script.usageCount || 0) + 1; // Increment usage
                    break;
                case 'edit-script':
                    openAddEditScriptModal('edit', script.id);
                    break;
                case 'copy-code':
                    copyToClipboard(script.code);
                    showToast('Script code copied to clipboard!');
                    script.usageCount = (script.usageCount || 0) + 1; // Increment usage
                    break;
                case 'delete-script':
                    if (confirm(`Are you sure you want to delete the script "${script.name}"?`)) {
                        appState.threatHuntingScripts = appState.threatHuntingScripts.filter(s => s.id !== scriptId);
                        showToast('Script deleted!', 'error');
                        populateScriptLanguageFilter(); // Update filter options
                    }
                    break;
            }
            renderThreatHuntingScripts(); // Re-render to reflect changes (e.g., usage count update)
            saveState(); // Save state after any action
        }


        // MODIFIED: Function to open the Add Tool Only Modal
        function openAddToolOnlyModal() {
            if (appState.readOnlyMode) {
                showToast("Cannot add tools in read-only shared view.", "warning");
                return;
            }
            document.getElementById('addToolOnlyForm').reset();
            populateCategoryFilterForAddToolOnly();

            // Clear search input and populate with no search term
            const intelligenceVaultCategorySearchInput = document.getElementById('intelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInput) { // Safety check
                intelligenceVaultCategorySearchInput.value = '';
            }
            populateIntelligenceVaultCategoriesCheckboxesAddTool([], ''); // Pass empty array for selections, empty string for search

            // Pre-select the current Intelligence Vault child tab, if applicable
            const checkboxes = document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === appState.currentIntelligenceVaultChildTab) {
                    checkbox.checked = true;
                    // Manually add 'checked' class to the label for visual feedback
                    checkbox.closest('.custom-tab-checkbox').classList.add('checked');
                } else {
                    checkbox.checked = false;
                    checkbox.closest('.custom-tab-checkbox').classList.remove('checked');
                }
            });

            document.getElementById('newToolOnlyCategoryInput').style.display = 'none';
            showModal('addToolOnlyModal');
        }

        // NEW: Populate Category dropdown for the Add Tool Only Modal
        function populateCategoryFilterForAddToolOnly() {
            const toolCategorySelect = document.getElementById('toolOnlyCategory');
            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));

            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation',
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other',
                'Phone Investigation', 'Telecom', 'Cryptocurrency Analysis', 'Geospatial Intelligence',
                'OSINT Mapping', 'Link Analysis', 'URL Analysis', 'Media Analysis', 'Video Analysis',
                'Password Analysis', 'Credential Analysis', 'Keyword Analysis', 'Text Analysis',
                'Social Media Analysis', 'Social Engineering'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...existingCategories]);

            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';

            Array.from(allCategories)
                .sort((a, b) => a.localeCompare(b))
                .forEach(category => {
                    const toolOption = document.createElement('option');
                    toolOption.value = category;
                    toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    toolCategorySelect.appendChild(toolOption);
                });

            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);
        }

        // MODIFIED: Populate "Where to add" checkboxes for the Add Tool Only Modal
        function populateIntelligenceVaultCategoriesCheckboxesAddTool(assignedCategories = [], searchTerm = '') {
            // Correct ID for ADD modal's checkboxes container
            const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesAddTool');
            if (!checkboxesContainer) return; // Safety check
            checkboxesContainer.innerHTML = '';

            // IMPORTANT: This array must contain ALL child tabs from your intelligenceVaultTabStructure
            const intelligenceVaultCategories = [
                // From General & Core
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
                { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
                { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' },
                { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' },

                // From Identity & Social
                { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
                { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
                { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' },

                // From Technical Footprints
                { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
                { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
                { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
                { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
                { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' },

                // From Cybersecurity Intel
                { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
                { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' },

                // From Breach & Leaks
                { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' },
                { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' },
                { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },

                // From Underground Sources
                { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' },
                { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
                { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
                { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },

                // From Media Analysis
                { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' },
                { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' },
                { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
                { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
                { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' },

                // From Operational Security (OPSEC)
                { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
                { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' },
                { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' },
                { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' },
            ];

            const filteredCategories = intelligenceVaultCategories.filter(category =>
                category.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredCategories.length === 0) {
                checkboxesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No matching categories.</p>';
                return;
            }

            filteredCategories.forEach(category => {
                const isChecked = assignedCategories.includes(category.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) checkboxContainer.classList.add('checked');

                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="intelligence-vault-category-checkbox-add-tool" value="${category.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${category.icon}" style="margin-right: 5px;"></i>
                    <span>${category.name}</span>
                `;
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Add event listener only once, if it hasn't been added yet to the wrapper
            const containerWrapper = document.getElementById('intelligenceVaultCategoriesAssignmentAddTool'); // Correct ID for ADD modal wrapper
            if (containerWrapper && !containerWrapper.dataset.listenerAdded) {
                containerWrapper.addEventListener('change', (e) => {
                    if (e.target.classList.contains('intelligence-vault-category-checkbox-add-tool')) {
                        const checkbox = e.target;
                        const label = checkbox.closest('.custom-tab-checkbox');
                        if (label) {
                            label.classList.toggle('checked', checkbox.checked);
                        }
                    }
                });
                containerWrapper.dataset.listenerAdded = 'true'; // Mark as added
            }
        }
// MODIFIED: populateIntelligenceVaultCategoriesCheckboxesEditTool (simplified listener attachment)
function populateIntelligenceVaultCategoriesCheckboxesEditTool(assignedCategories = [], searchTerm = '') {
    const container = document.getElementById('intelligenceVaultCategoriesAssignmentEditTool');
    if (!container) return;
    container.style.display = 'block';

    const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesEditTool');
    if (!checkboxesContainer) return;
    checkboxesContainer.innerHTML = ''; // Clear previous checkboxes

    // IMPORTANT: This array must contain ALL child tabs from your intelligenceVaultTabStructure
    const intelligenceVaultCategories = [
        // From General & Core
        { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
        { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
        { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
        { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' },
        { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' },

        // From Identity & Social
        { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
        { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
        { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
        { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
        { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
        { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
        { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' },

        // From Technical Footprints
        { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
        { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
        { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
        { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
        { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
        { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
        { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' },

        // From Cybersecurity Intel
        { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
        { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
        { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
        { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
        { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' },

        // From Breach & Leaks
        { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' },
        { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
        { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
        { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' },
        { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },

        // From Underground Sources
        { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' },
        { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
        { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
        { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
        { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },

        // From Media Analysis
        { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' },
        { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' },
        { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
        { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
        { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' },

        // From Operational Security (OPSEC)
        { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
        { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' },
        { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' },
        { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' },
    ];

    const filteredCategories = intelligenceVaultCategories.filter(category =>
        category.name.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (filteredCategories.length === 0) {
        checkboxesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No matching categories.</p>';
        return;
    }

    filteredCategories.forEach(category => {
        const isChecked = assignedCategories.includes(category.id);
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        if (isChecked) checkboxContainer.classList.add('checked');

        checkboxContainer.innerHTML = `
            <input
                type="checkbox"
                class="intelligence-vault-category-checkbox-edit-tool"
                value="${category.id}"
                ${isChecked ? 'checked' : ''}
            >
            <i class="${category.icon}" style="margin-right: 5px;"></i>
            <span>${category.name}</span>
        `;
        checkboxesContainer.appendChild(checkboxContainer);
    });

    // Attach event listener directly to the checkboxesContainer.
    // This will replace the existing elements, so the old listeners are implicitly removed.
    checkboxesContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('intelligence-vault-category-checkbox-edit-tool')) {
            const checkbox = e.target;
            const label = checkbox.closest('.custom-tab-checkbox');
            if (label) {
                label.classList.toggle('checked', checkbox.checked);
            }
        }
    });
}
// NEW: Handle adding a new tool from the dedicated Intelligence Vault modal
    async function handleAddToolOnly(e) {
        e.preventDefault();
        if (appState.readOnlyMode) {
            showToast("Cannot add tools in read-only shared view.", "warning");
            return;
        }

        const toolName = document.getElementById('toolOnlyName').value.trim();
        const toolUrl = document.getElementById('toolOnlyUrl').value.trim();
        let toolCategory = document.getElementById('toolOnlyCategory').value;
        const newCategoryInput = document.getElementById('newToolOnlyCategoryInput').value.trim();
        const toolDescription = document.getElementById('toolOnlyDescription').value.trim();
        const toolTags = document.getElementById('toolOnlyTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

        const selectedIntelligenceVaultCategories = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);

        if (!toolName || !toolUrl || !toolCategory) {
            showToast('Please fill in all required tool fields (Name, URL, Category).', 'error');
            return;
        }

        if (toolCategory === 'custom') {
            if (!newCategoryInput) {
                showToast('Please enter a custom category name.', 'error');
                return;
            }
            toolCategory = newCategoryInput.toLowerCase();
        }

        if (selectedIntelligenceVaultCategories.length === 0) {
            showToast('Please select at least one Intelligence Vault category for the tool.', 'error');
            return;
        }

        const newTool = {
            id: generateId(),
            type: 'tool',
            name: toolName,
            url: toolUrl,
            category: toolCategory,
            description: toolDescription,
            tags: toolTags,
            starred: false,
            pinned: false,
            favicon: `https://www.google.com/s2/favicons?domain=${new URL(toolUrl).hostname}`,
            lastUsed: 0,
            addedDate: new Date(),
            customTabs: [],
            intelligenceVaultCategories: selectedIntelligenceVaultCategories
        };

        appState.tools.push(newTool);
        hideModal('addToolOnlyModal');
        document.getElementById('addToolOnlyForm').reset();
        showToast('Tool added successfully!');
        updateStats();
        populateCategoryFilter();
        renderIntelligenceEntries();
        saveState();
    }



// MODIFIED: handleEntryAction function to include all new entry types
function handleEntryAction(e) {
    if (appState.readOnlyMode) { // Prevent actions in read-only mode
        showToast("Cannot perform actions in read-only shared view.", "warning");
        return;
    }

    const targetBtn = e.target.closest('.action-btn');
    if (!targetBtn) return;

    e.preventDefault();
    const action = targetBtn.dataset.action;
    const entryCard = e.target.closest('.tool-card'); // Still using tool-card class for styling
    const entryId = entryCard.dataset.entryId;
    const entryType = entryCard.dataset.entryType;

    let entry = null;
    let entryArray = null;

    // Determine which array to look into based on entryType (ensure plural names are consistent)
    switch (entryType) {
        case 'tool': entryArray = appState.tools; break;
        case 'email': entryArray = appState.emails; break;
        case 'phone': entryArray = appState.phones; break;
        case 'crypto': entryArray = appState.crypto; break;
        case 'location': entryArray = appState.locations; break;
        case 'link': entryArray = appState.links; break;
        case 'media': entryArray = appState.media; break;
        case 'password': entryArray = appState.passwords; break;
        case 'keyword': entryArray = appState.keywords; break;
        case 'social': entryArray = appState.socials; break;
        case 'domain': entryArray = appState.domains; break;
        case 'username': entryArray = appState.usernames; break;
        case 'threat': entryArray = appState.threats; break;
        case 'vulnerability': entryArray = appState.vulnerabilities; break;
        case 'malware': entryArray = appState.malware; break;
        case 'breach': entryArray = appState.breaches; break;
        case 'credential': entryArray = appState.credentials; break;
        case 'forum': entryArray = appState.forums; break;
        case 'vendor': entryArray = appState.vendors; break;
        case 'telegram': entryArray = appState.telegramChannels; break; // Use the renamed array
        case 'paste': entryArray = appState.pastes; break;
        case 'document': entryArray = appState.documents; break;
        case 'network': entryArray = appState.networks; break;
        case 'metadata': entryArray = appState.metadataEntries; break; // Use the renamed array
        case 'archive': entryArray = appState.archives; break;
        case 'messaging': entryArray = appState.messagingApps; break; // Use the renamed array
        case 'dating': entryArray = appState.datingProfiles; break; // Use the renamed array
        case 'facial': entryArray = appState.facialRecognition; break; // Use the renamed array
        case 'persona': entryArray = appState.personas; break; // Use the renamed array
        case 'vpn': entryArray = appState.vpns; break; // Use the renamed array
        case 'honeypot': entryArray = appState.honeypots; break;
        case 'exploit': entryArray = appState.exploits; break;
        case 'publicrecord': entryArray = appState.publicRecords; break;
        default:
            console.warn(`Unknown entry type for action: ${entryType}`);
            return;
    }

    if (entryArray) {
        entry = entryArray.find(t => t.id === entryId);
    }

    if (!entry) return;

    switch (action) {
        case 'edit':
            openEditEntryModal(entry);
            break;
        case 'star':
            entry.starred = !entry.starred;
            showToast(entry.starred ? 'Entry starred!' : 'Entry unstarred!');
            break;
        case 'pin':
            entry.pinned = !entry.pinned;
            showToast(entry.pinned ? 'Entry pinned!' : 'Entry unpinned!');
            break;
        case 'visit':
            // Allow visiting URL for any entry type that has a 'url' property
            if (entry.url) { // Check for .url property instead of just entry.type === 'tool'
                entry.lastUsed = Date.now(); // Update lastUsed timestamp
                appState.usageStats.toolsUsedToday++; // Increment usage stat (generic for now)
                updateDashboard(); // Update analytics display
                window.open(entry.url, '_blank');
                showToast('Opening link...');
            } else {
                showToast('No URL available for this entry type.', 'info');
            }
            break;
        case 'delete':
            if (confirm('Are you sure you want to delete this entry?')) {
                // Remove entry from any custom tabs it belongs to
                appState.customTabs.forEach(tab => {
                    tab.toolIds = tab.toolIds.filter(id => id !== entryId);
                });

                if (entryArray) {
                    // Find index and remove
                    const index = entryArray.findIndex(e => e.id === entryId);
                    if (index > -1) {
                        entryArray.splice(index, 1);
                    }
                }
                appState.selectedEntries.delete(entryId); // Remove from selected if deleted
                showToast('Entry deleted!', 'error');
                updateStats();
                populateCategoryFilter(); // Recalculate categories (if a tool was deleted)
                renderCustomTabs(); // Re-render custom tabs to update counts/content
            }
            break;
    }

    renderIntelligenceEntries();
    updateStats(); // Also update stats bar after individual entry action
    saveState(); // Save state after any action
}

        // Handle bulk selection checkbox
        function handleBulkSelection(e) {
            if (appState.readOnlyMode) { // New: Prevent bulk selection in read-only mode
                e.target.checked = !e.target.checked; // Revert checkbox state
                showToast("Cannot select entries in read-only shared view.", "warning");
                return;
            }

            if (!e.target.classList.contains('bulk-checkbox')) return;
            
            const entryCard = e.target.closest('.tool-card');
            const entryId = entryCard.dataset.entryId;
            
            if (e.target.checked) {
                appState.selectedEntries.add(entryId);
            } else {
                appState.selectedEntries.delete(entryId);
            }
            
            updateBulkActions();
            entryCard.classList.toggle('selected', e.target.checked); // Visually mark selected
        }

        // Update bulk actions visibility and count
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (appState.readOnlyMode) { // New: Always hide bulk actions in read-only
                bulkActions.classList.remove('active');
                return;
            }

            if (appState.selectedEntries.size > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = appState.selectedEntries.size;
            } else {
                bulkActions.classList.remove('active');
            }
        }

 // Bulk actions (star, pin, delete selected)
function bulkAction(action) {
    if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
        showToast("Cannot perform bulk actions in read-only shared view.", "warning");
        return;
    }

    const selectedIds = Array.from(appState.selectedEntries);

    if (selectedIds.length === 0) {
        showToast(`No entries selected for ${action} action.`, 'warning');
        return;
    }

    if (action === 'delete' && !confirm('Are you sure you want to delete all selected entries?')) {
        return;
    }

    // Determine if all selected are already starred/pinned for toggling
    let allStarred = true;
    let allPinned = true;

    // Aggregate all entries from ALL appState arrays
    const allEntries = [
        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
        ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
        ...appState.publicRecords
    ];
    const selectedEntriesArray = allEntries.filter(entry => selectedIds.includes(entry.id));

    if (action === 'star' || action === 'pin') {
        allStarred = selectedEntriesArray.every(entry => entry.starred);
        allPinned = selectedEntriesArray.every(entry => entry.pinned);
    }

    selectedIds.forEach(id => {
        const entry = allEntries.find(e => e.id === id); // Find the actual entry object
        if (!entry) return;

        switch (action) {
            case 'star':
                entry.starred = !allStarred; // Toggle based on current state of all
                break;
            case 'pin':
                entry.pinned = !allPinned; // Toggle based on current state of all
                break;
            case 'delete':
                // Remove entry from any custom tabs it belongs to before deleting
                appState.customTabs.forEach(tab => {
                    tab.toolIds = tab.toolIds.filter(entryIdInTab => entryIdInTab !== id);
                });

                // Remove from its respective appState array based on its type
                const targetArrayKey = Object.keys(appState).find(key => Array.isArray(appState[key]) && appState[key].some(e => e.id === id));
                if (targetArrayKey) {
                    appState[targetArrayKey] = appState[targetArrayKey].filter(e => e.id !== id);
                }
                break;
        }
    });

    appState.selectedEntries.clear();
    updateBulkActions();
    renderIntelligenceEntries();
    updateStats();
    populateCategoryFilter();
    renderCustomTabs(); // Update custom tabs if entries were deleted
    showToast(`Bulk ${action} completed!`);
    saveState();
}

        // Quick actions (UPDATED)
        function togglePinFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'pinned') { // If already filtering by pinned, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'pinned'; // Set filter to show only pinned
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'pinned' ? 'Showing only pinned entries!' : 'Cleared pinned entries filter!');
        }

        function toggleStarFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'starred') { // If already filtering by starred, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'starred'; // Set filter to show only starred
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'starred' ? 'Showing only starred entries!' : 'Cleared starred entries filter!');
        }


        function switchTab(tabName) {
            // Update main tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                // Hide specific sub-tab containers when switching main tabs
                if (content.id === 'intelligence-vaultTab') {
                    document.getElementById('intelligenceVaultParentTabs').style.display = 'none';
                    document.getElementById('intelligenceVaultChildTabs').style.display = 'none';
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
                } else if (content.id === 'custom-tabsTab') {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'none';
                    document.getElementById('customVaultEntryChildTabs').style.display = 'none';
                    document.getElementById('addEntryBtnCustomVault').style.display = 'none';
                }
            });

            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                targetTabContent.classList.add('active');
            }

            // Update appState and clear filters for new tab
            appState.currentTab = tabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = '';
            document.getElementById('searchInput').value = '';

            // Specific logic for each main tab
            if (tabName === 'intelligence-vault') {
                document.getElementById('intelligenceVaultParentTabs').style.display = 'flex'; // Show parent tabs
                renderIntelligenceVaultParentTabs(); // This will populate parent tabs and activate current one

                const currentIntelParent = intelligenceVaultTabStructure.find(p => p.id === appState.currentIntelligenceVaultParentTab);
                if (!currentIntelParent) {
                    appState.currentIntelligenceVaultParentTab = intelligenceVaultTabStructure[0].id;
                }
                switchIntelligenceVaultParentTab(appState.currentIntelligenceVaultParentTab);

                if (!appState.readOnlyMode) {
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'inline-flex';
                }
                renderIntelligenceEntries(); // Render entries specific to intelligence-vault

            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render main custom tabs (the list of custom vaults)

                if (appState.customTabs.length > 0) {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'flex'; // Show parent tabs for entries
                    renderCustomVaultParentTabs(); // Render custom vault entry parent tabs

                    const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
                    if (!currentCustomParent) {
                        appState.currentCustomVaultParentTab = customVaultEntryStructure[0].id;
                    }
                    const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                    if (!currentCustomChild) {
                        appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                    }
                    switchCustomVaultParentTab(appState.currentCustomVaultParentTab);

                    if (!appState.readOnlyMode) {
                        document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                    }
                }
                renderIntelligenceEntries(); // Render entries specific to custom-tabs

            } else if (tabName === 'timeline') {
                renderTimelineEvents();
            } else if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'handbook') {
                initHandbookAndNotes();
            } else if (tabName === 'dork-assistant') {
                initDorkAssistant();
            } else if (tabName === 'case-studies') { // Handle Case Studies tab
                renderCaseStudies(); // Now call renderCaseStudies to display content
                // Reset filters for case studies specifically when entering the tab
                appState.caseStudyFilters.search = '';
                appState.caseStudyFilters.type = '';
                document.getElementById('caseStudySearchInput').value = '';
                document.getElementById('caseStudyFilterSelect').value = '';
            }

            saveState(); // Save state after tab switch
        }



        // Switch Intelligence Vault Sub-tabs (now show tools)
        function switchIntelligenceVaultSubTab(subTabName) {
            document.querySelectorAll('.intelligence-vault-sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.intelligence-vault-sub-tab[data-sub-tab="${subTabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            appState.currentIntelligenceVaultSubTab = subTabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries();
            saveState();
        }

        // MODIFIED: Switch Custom Vault Entry Child Sub-tabs
        function switchCustomVaultEntrySubTab(childTabName) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }
            appState.customVaultViewMode = 'entries';
            saveState(); 
            document.querySelectorAll('.custom-vault-entry-child-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetChildTabBtn = document.querySelector(`.custom-vault-entry-child-tab[data-child-tab="${childTabName}"]`);
            if (targetChildTabBtn) {
                targetChildTabBtn.classList.add('active');
            }
            appState.currentCustomVaultEntrySubTab = childTabName;
            appState.filters.category = ''; 
            document.getElementById('categoryFilter').value = '';
            document.getElementById('customTabTimelineDisplay').style.display = 'none';
            document.getElementById('customTabToolsGrid').style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
            if (!appState.readOnlyMode) { 
                document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
            }
            document.getElementById('customVaultViewToggle').style.display = 'inline-flex';
            document.getElementById('bulkActions').style.display = appState.selectedEntries.size > 0 && !appState.readOnlyMode ? 'flex' : 'none';
            renderIntelligenceEntries(); 
            saveState();
        }

        function renderCustomVaultTimeline() {
            const timelineContainer = document.getElementById('customTabTimelineDisplay');
            const emptyState = document.getElementById('emptyCustomVaultTimelineState');

            if (!timelineContainer || !emptyState) {
                console.error("renderCustomVaultTimeline: Required DOM elements (customTabTimelineDisplay or emptyCustomVaultTimelineState) not found. Please add them to your HTML.");
                return;
            }

            timelineContainer.innerHTML = ''; // Clear previous content
            timelineContainer.style.display = 'block'; // Make sure this container is visible

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);

            if (!activeCustomTab || activeCustomTab.toolIds.length === 0) {
                emptyState.style.display = 'block';
                timelineContainer.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';

            // Collect all entries from all appState arrays
            const allEntriesCombined = [
                ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
                ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
                ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
                ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
                ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
                ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
                ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
                ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
                ...appState.publicRecords
            ];

            // Filter to get only entries belonging to the current custom tab
            const vaultEntries = allEntriesCombined.filter(entry =>
                (entry.customTabs || []).includes(activeCustomTab.id)
            );

            // Map these entries to a timeline event structure
            const customVaultTimelineEvents = vaultEntries.map(entry => {
                let title = getEntryName(entry); // Use existing helper
                let category = entry.type; // Use entry type as category for now
                let notes = entry.description || entry.notes || 'No description available.';
                let confidence = 'info'; // Default confidence for custom vault entries
                let evidence = entry.url || entry.source || ''; // Use URL or source as evidence
                let actor = 'System/Investigator'; // Default actor

                // Attempt to get a more specific timestamp if available, otherwise fallback to addedDate
                let timestamp = entry.addedDate;
                if (entry.lastUsed && entry.lastUsed !== 0) { // If lastUsed is more recent than addedDate
                    timestamp = new Date(Math.max(new Date(entry.addedDate || 0).getTime(), entry.lastUsed));
                }
                if (entry.date) { // For types like breach, publicrecord which have specific 'date' fields
                    timestamp = new Date(entry.date);
                }
                if (entry.timestamp) { // For types like archive, which have their own 'timestamp'
                    timestamp = new Date(entry.timestamp);
                }

                // Add a "meta" field to notes for more detailed information if needed
                let detailedNotes = notes;
                if (entry.platform) detailedNotes += ` (Platform: ${entry.platform})`;
                if (entry.username) detailedNotes += ` (Username: ${entry.username})`;
                if (entry.filename) detailedNotes += ` (File: ${entry.filename})`;

                return {
                    id: entry.id, // Reuse entry ID for event ID
                    timestamp: timestamp || new Date(), // Fallback to current date if no timestamp
                    title: title,
                    category: category,
                    notes: detailedNotes,
                    confidence: confidence,
                    evidence: evidence,
                    actor: actor
                };
            }).sort((a, b) => a.timestamp - b.timestamp); // Sort by timestamp

            // Now, render these generated events into the custom vault timeline display.
            // We'll mimic the structure of renderTimelineEvents but apply it to the custom vault's specific div.
            const fragment = document.createDocumentFragment();

            if (customVaultTimelineEvents.length === 0) {
                emptyState.style.display = 'block';
                timelineContainer.innerHTML = '';
                return;
            }

            customVaultTimelineEvents.forEach(event => {
                // We need to define or reuse a mapping for categories to icons/colors for custom vault entries.
                // For simplicity, let's map common entry types to a default timeline category,
                // or create a simple fallback category for generic entries.
                const defaultCategoryMap = {
                    'tool': 'other', // Or a more specific tool category if you add one to timelineCategories
                    'email': 'phishing',
                    'phone': 'other',
                    'crypto': 'other',
                    'location': 'discovery',
                    'link': 'collection',
                    'media': 'collection',
                    'password': 'credential_access',
                    'keyword': 'reconnaissance',
                    'social': 'reconnaissance',
                    'domain': 'reconnaissance',
                    'username': 'reconnaissance',
                    'threat': 'malware_delivery',
                    'vulnerability': 'malware_delivery',
                    'malware': 'malware_delivery',
                    'breach': 'impact',
                    'credential': 'credential_access',
                    'forum': 'other',
                    'vendor': 'other',
                    'telegram': 'other',
                    'paste': 'collection',
                    'document': 'collection',
                    'network': 'discovery',
                    'metadata': 'collection',
                    'archive': 'collection',
                    'messaging': 'collection',
                    'dating': 'collection',
                    'audio': 'collection',
                    'facial': 'collection',
                    'persona': 'reconnaissance',
                    'vpn': 'other',
                    'honeypot': 'other',
                    'exploit': 'malware_delivery',
                    'publicrecord': 'collection'
                };

                const timelineCategory = defaultCategoryMap[event.category] || 'other';
                const categoryInfo = timelineCategories[timelineCategory] || { name: timelineCategory, icon: "fas fa-question-circle", color: "var(--primary)" };

                const eventDate = new Date(event.timestamp).toLocaleDateString();
                const eventTime = new Date(event.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const eventCardDiv = document.createElement('div');
                eventCardDiv.classList.add('timeline-event-card');
                eventCardDiv.dataset.category = timelineCategory; // Use the mapped category for styling
                eventCardDiv.dataset.confidence = event.confidence;
                eventCardDiv.dataset.eventId = event.id; // Keep original entry ID for reference
                eventCardDiv.style.borderLeft = `5px solid ${categoryInfo.color || 'var(--primary)'}`;

                eventCardDiv.innerHTML = `
                    <div class="timeline-event-header">
                        <div class="timeline-event-title">
                            <i class="${categoryInfo.icon}" style="color: ${categoryInfo.color || 'var(--primary)'};"></i> ${event.title}
                        </div>
                        <span class="timeline-event-timestamp">${eventDate} ${eventTime}</span>
                        <div class="timeline-event-actions">
                            <button class="action-btn" onclick="openEditEntryModal(findEntryById('${event.id}', '${event.category}'))" title="Edit Entry">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="handleEntryAction({ target: { closest: () => ({ dataset: { entryId: '${event.id}', entryType: '${event.category}' } }) }, preventDefault: () => {} }, 'delete')" title="Delete Entry">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="timeline-event-notes">${event.notes || 'No notes.'}</p>
                    <div class="timeline-event-meta">
                        <span><i class="fas fa-certificate"></i> Confidence: <strong style="color: var(--${event.confidence});">${event.confidence.charAt(0).toUpperCase() + event.confidence.slice(1)}</strong></span>
                        <span><i class="fas fa-tag"></i> Original Type: ${event.category}</span>
                        ${event.actor ? `<span><i class="fas fa-user-circle"></i> Actor: ${event.actor}</span>` : ''}
                        ${event.evidence ? `<span><i class="fas fa-paperclip"></i> Evidence: <a href="${event.evidence}" target="_blank" style="color: var(--primary); text-decoration: none;">${event.evidence.length > 30 ? event.evidence.substring(0, 27) + '...' : event.evidence}</a></span>` : ''}
                    </div>
                `;
                fragment.appendChild(eventCardDiv);
            });

            timelineContainer.appendChild(fragment);

            // Force a reflow
            void timelineContainer.offsetHeight;

            // Helper to find entry by ID across all arrays (needed for direct edit button)
            // This part should be defined once globally or in a scope accessible to onclick,
            // not redefined every time renderCustomVaultTimeline runs.
            // Ensure `window.findEntryById` is defined at the top-level of your script.
            if (typeof findEntryById === 'undefined') {
                window.findEntryById = function(id, type) {
                    let entryArray;
                    switch (type) {
                        case 'tool': entryArray = appState.tools; break;
                        case 'email': entryArray = appState.emails; break;
                        case 'phone': entryArray = appState.phones; break;
                        case 'crypto': entryArray = appState.crypto; break;
                        case 'location': entryArray = appState.locations; break;
                        case 'link': entryArray = appState.links; break;
                        case 'media': entryArray = appState.media; break;
                        case 'password': entryArray = appState.passwords; break;
                        case 'keyword': entryArray = appState.keywords; break;
                        case 'social': entryArray = appState.socials; break;
                        case 'domain': entryArray = appState.domains; break;
                        case 'username': entryArray = appState.usernames; break;
                        case 'threat': entryArray = appState.threats; break;
                        case 'vulnerability': entryArray = appState.vulnerabilities; break;
                        case 'malware': entryArray = appState.malware; break;
                        case 'breach': entryArray = appState.breaches; break;
                        case 'credential': entryArray = appState.credentials; break;
                        case 'forum': entryArray = appState.forums; break;
                        case 'vendor': entryArray = appState.vendors; break;
                        case 'telegram': entryArray = appState.telegramChannels; break;
                        case 'paste': entryArray = appState.pastes; break;
                        case 'document': entryArray = appState.documents; break;
                        case 'network': entryArray = appState.networks; break;
                        case 'metadata': entryArray = appState.metadataEntries; break;
                        case 'archive': entryArray = appState.archives; break;
                        case 'messaging': entryArray = appState.messagingApps; break;
                        case 'dating': entryArray = appState.datingProfiles; break;
                        case 'audio': entryArray = appState.audioEntries; break;
                        case 'facial': entryArray = appState.facialRecognition; break;
                        case 'persona': entryArray = appState.personas; break;
                        case 'vpn': entryArray = appState.vpns; break;
                        case 'honeypot': entryArray = appState.honeypots; break;
                        case 'exploit': entryArray = appState.exploits; break;
                        case 'publicrecord': entryArray = appState.publicRecords; break;
                        default: return null;
                    }
                    return entryArray ? entryArray.find(entry => entry.id === id) : null;
                };
            }
        }
        
        // NEW: Render Custom Vault Parent Tabs
        function renderCustomVaultParentTabs() {
            const parentTabsContainer = document.getElementById('customVaultEntryParentTabs');
            if (!parentTabsContainer) return;

            parentTabsContainer.innerHTML = customVaultEntryStructure.map(parentTab => `
                <button class="nav-tab custom-vault-entry-parent-tab" data-parent-tab="${parentTab.id}">
                    <i class="${parentTab.icon}"></i>
                    ${parentTab.name}
                </button>
            `).join('');

            // Add event listeners for parent tabs (delegation handled in bindEvents)

            // Activate the currently selected parent tab
            const activeParentBtn = document.querySelector(`.custom-vault-entry-parent-tab[data-parent-tab="${appState.currentCustomVaultParentTab}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }
        }

        // NEW: Switch Custom Vault Parent Tab
        function switchCustomVaultParentTab(parentId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all parent tabs
            document.querySelectorAll('.custom-vault-entry-parent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked parent tab
            const activeParentBtn = document.querySelector(`.custom-vault-entry-parent-tab[data-parent-tab="${parentId}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }

            appState.currentCustomVaultParentTab = parentId;

            // Find the selected parent tab's children
            const selectedParent = customVaultEntryStructure.find(p => p.id === parentId);
            const childTabsContainer = document.getElementById('customVaultEntryChildTabs');

            if (selectedParent && childTabsContainer) {
                childTabsContainer.style.display = 'flex'; // Show the child tabs container
                childTabsContainer.innerHTML = selectedParent.children.map(childTab => `
                    <button class="sub-nav-tab custom-vault-entry-child-tab" data-child-tab="${childTab.id}">
                        <i class="${childTab.icon}"></i> ${childTab.name}
                    </button>
                `).join('');

                // Remove existing child tab listeners (already handled by bindEvents delegation)

                // Automatically activate the first child tab or the previously selected child tab under this parent
                let childToActivate = appState.currentCustomVaultEntrySubTab;
                if (!selectedParent.children.some(c => c.id === childToActivate)) {
                    childToActivate = selectedParent.children[0]?.id; // Default to first child if current is not in this parent
                }
                if (childToActivate) {
                    switchCustomVaultEntrySubTab(childToActivate);
                } else {
                    // No child tabs for this parent, clear display
                    appState.currentCustomVaultEntrySubTab = null;
                    appState.filters.category = '';
                    renderIntelligenceEntries();
                }

            } else {
                childTabsContainer.style.display = 'none'; // Hide if no children or container not found
                appState.currentCustomVaultEntrySubTab = null;
                appState.filters.category = '';
                renderIntelligenceEntries();
            }

            saveState(); // Save the parent tab state
        }


        // Load threat intelligence
        function loadThreats() {
            const threatsList = document.getElementById('threatsList');
            const mockThreats = [
                {
                    id: 1,
                    title: 'New Phishing Campaign Detected',
                    description: 'Targeting financial institutions with COVID-19 themed lures. Be cautious of emails resembling official health advisories.',
                    severity: 'high',
                    tags: ['phishing', 'covid-19', 'financial', 'email'],
                    timestamp: new Date(Date.now() - 3600000)
                },
                {
                    id: 2,
                    title: 'Malware Sample Analysis: Xylos Variant',
                    description: 'New variant of banking trojan "Xylos" discovered in the wild. It employs obfuscation techniques and targets online banking portals. Update your antivirus signatures immediately.',
                    severity: 'medium',
                    tags: ['malware', 'banking', 'trojan', 'xylos', 'analysis'],
                    timestamp: new Date(Date.now() - 7200000)
                },
                {
                    id: 3,
                    title: 'Data Breach Alert: Gaming Platform',
                    description: 'Credentials leak detected on underground forums originating from a popular gaming platform. Users are advised to change passwords and enable multi-factor authentication.',
                    severity: 'high',
                    tags: ['breach', 'credentials', 'darkweb', 'gaming'],
                    timestamp: new Date(Date.now() - 10800000)
                },
                {
                    id: 4,
                    title: 'Ransomware Attack on Healthcare Provider',
                    description: 'A critical ransomware attack impacted a regional healthcare provider, compromising patient data. Incident response teams are engaged, and data recovery efforts are underway. Backups are crucial!',
                    severity: 'high',
                    tags: ['ransomware', 'healthcare', 'data-loss', 'cyberattack'],
                    timestamp: new Date(Date.now() - 86400000 * 2) // 2 days ago
                },
                {
                    id: 5,
                    title: 'Zero-Day Exploit in Popular Web Server',
                    description: 'A zero-day vulnerability has been identified in a widely used web server software. Patches are not yet available. Organizations are advised to implement temporary mitigation strategies and monitor their logs closely.',
                    severity: 'medium',
                    tags: ['zero-day', 'vulnerability', 'web-server', 'exploit'],
                    timestamp: new Date(Date.now() - 86400000 * 5) // 5 days ago
                }
            ];

            // Sort threats by timestamp (most recent first)
            mockThreats.sort((a, b) => b.timestamp - a.timestamp);

            threatsList.innerHTML = mockThreats.map(threat => `
                <div class="threat-item">
                    <div class="threat-header">
                        <h4>${threat.title}</h4> <div class="threat-level threat-${threat.severity}">${threat.severity}</div> </div>
                    <p>${threat.description}</p> <div class="threat-tags">
                        ${threat.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="threat-time">${formatTime(threat.timestamp)}</div>
                </div>
            `).join('');

        }

        // --- Start of updateDashboard (full code block) ---
        function updateDashboard() {
            // Define allEntries at the start of the function, combining all relevant appState arrays
            // Use the `|| []` operator for each appState property to ensure it's always an array,
            // even if `loadState` might have left it as `undefined` in older saves.
            const allEntries = [
                ...(appState.tools || []),
                ...(appState.emails || []),
                ...(appState.phones || []),
                ...(appState.crypto || []),
                ...(appState.locations || []),
                ...(appState.links || []),
                ...(appState.media || []),
                ...(appState.passwords || []),
                ...(appState.keywords || []),
                ...(appState.socials || []),
                ...(appState.domains || []),
                ...(appState.usernames || []),
                ...(appState.threats || []),
                ...(appState.vulnerabilities || []),
                ...(appState.malware || []),
                ...(appState.breaches || []),
                ...(appState.credentials || []),
                ...(appState.forums || []),
                ...(appState.vendors || []),
                ...(appState.telegramChannels || []),
                ...(appState.pastes || []),
                ...(appState.documents || []),
                ...(appState.networks || []),
                ...(appState.metadataEntries || []),
                ...(appState.archives || []),
                ...(appState.messagingApps || []),
                ...(appState.datingProfiles || []),
                ...(appState.audioEntries || []),
                ...(appState.facialRecognition || []),
                ...(appState.personas || []),
                ...(appState.vpns || []),
                ...(appState.honeypots || []),
                ...(appState.exploits || []),
                ...(appState.publicRecords || []),
                ...(appState.caseStudies || []) // Include case studies in total entries count
            ];

            // --- Main Overview Stats (These are the big numbers at the top of the Dashboard tab) ---
            // These elements exist in the dashboard tab and are correctly updated.
            document.getElementById('totalToolsCount').textContent = allEntries.length;
            document.getElementById('activeVaultsCount').textContent = appState.customTabs.length;
            document.getElementById('usedToolsTodayCount').textContent = appState.usageStats.toolsUsedToday;
            document.getElementById('notesCount').textContent = notesState.notes.length;


            // --- Detailed Starred & Pinned Breakdown by Type ---
            const starredPinnedBreakdownList = document.getElementById('starredPinnedBreakdownList');
            if (starredPinnedBreakdownList) {
                let breakdownHtml = '';
                const entryTypes = [
                    'tool', 'email', 'phone', 'crypto', 'location', 'link', 'media', 'password',
                    'keyword', 'social', 'domain', 'username', 'threat', 'vulnerability', 'malware',
                    'breach', 'credential', 'forum', 'vendor', 'telegram', 'paste', 'document',
                    'network', 'metadata', 'archive', 'messaging', 'dating', 'audio', 'facial',
                    'persona', 'vpn', 'honeypot', 'exploit', 'publicrecord', 'caseStudy' // Include caseStudy
                ]; // Explicitly list all types

                // Count for each type
                const typeCounts = {};
                allEntries.forEach(entry => {
                    // Normalize entry.type if necessary, e.g., 'telegram' -> 'telegramChannels' for lookup
                    let typeKey = entry.type;
                    if (typeKey === 'telegram') typeKey = 'telegramChannels';
                    if (typeKey === 'metadata') typeKey = 'metadataEntries';
                    if (typeKey === 'messaging') typeKey = 'messagingApps';
                    if (typeKey === 'dating') typeKey = 'datingProfiles';
                    if (typeKey === 'audio') typeKey = 'audioEntries';
                    if (typeKey === 'facial') typeKey = 'facialRecognition';
                    if (typeKey === 'persona') typeKey = 'personas';
                    if (typeKey === 'vpn') typeKey = 'vpns';
                    if (typeKey === 'caseStudy') typeKey = 'caseStudies'; // Add for case studies

                    // Ensure the key exists in our counts object
                    if (!typeCounts[typeKey]) {
                        typeCounts[typeKey] = { starred: 0, pinned: 0 };
                    }
                    if (entry.starred) {
                        typeCounts[typeKey].starred++;
                    }
                    if (entry.pinned) {
                        typeCounts[typeKey].pinned++;
                    }
                });

                // Add overall starred/pinned totals first for clarity
                breakdownHtml += `<li><span>Total Starred Entries:</span> <span class="stat-value">${allEntries.filter(e => e.starred).length}</span></li>`;
                breakdownHtml += `<li><span>Total Pinned Entries:</span> <span class="stat-value">${allEntries.filter(e => e.pinned).length}</span></li>`;
                breakdownHtml += `<li><hr style="border: 0; height: 1px; background: var(--border-light); margin: 10px 0;"></li>`; // Divider

                // Iterate through counts and build HTML
                entryTypes.forEach(type => {
                    let pluralType = type + 's'; // Default plural
                    // Adjust plural for specific arrays if they differ from type + 's'
                    if (type === 'telegram') pluralType = 'telegramChannels';
                    if (type === 'metadata') pluralType = 'metadataEntries';
                    if (type === 'messaging') pluralType = 'messagingApps';
                    if (type === 'dating') pluralType = 'datingProfiles';
                    if (type === 'audio') pluralType = 'audioEntries';
                    if (type === 'facial') pluralType = 'facialRecognition';
                    if (type === 'persona') pluralType = 'personas';
                    if (type === 'vpn') pluralType = 'vpns';
                    if (type === 'caseStudy') pluralType = 'caseStudies';

                    const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
                    if (typeCounts[pluralType] && (typeCounts[pluralType].starred > 0 || typeCounts[pluralType].pinned > 0)) {
                        if (typeCounts[pluralType].starred > 0) {
                            breakdownHtml += `<li><span>Starred ${capitalizedType}s:</span> <span class="stat-value">${typeCounts[pluralType].starred}</span></li>`;
                        }
                        if (typeCounts[pluralType].pinned > 0) {
                            breakdownHtml += `<li><span>Pinned ${capitalizedType}s:</span> <span class="stat-value">${typeCounts[pluralType].pinned}</span></li>`;
                        }
                    }
                });
                starredPinnedBreakdownList.innerHTML = breakdownHtml;
            }


            // --- Intelligence Vault Summary ---
            const intelVaultCategories = new Set((appState.tools || []).map(tool => tool.category)); // Safe access
            document.getElementById('intelVaultTotalTools').textContent = (appState.tools || []).length;
            document.getElementById('intelVaultStarredTools').textContent = (appState.tools || []).filter(tool => tool.starred).length;
            document.getElementById('intelVaultPinnedTools').textContent = (appState.tools || []).filter(tool => tool.pinned).length;
            document.getElementById('intelVaultCategoriesCount').textContent = intelVaultCategories.size;

            // --- Custom Vaults Summary ---
            let totalEntriesInCustomVaults = 0;
            (appState.customTabs || []).forEach(tab => { // Safe access
                totalEntriesInCustomVaults += (tab.toolIds || []).length; // toolIds now holds all entry types in custom tabs
            });
            const totalCustomVaults = (appState.customTabs || []).length; // Redefine here if needed for this section
            document.getElementById('customVaultsTotal').textContent = totalCustomVaults;
            document.getElementById('customVaultsTotalEntries').textContent = totalEntriesInCustomVaults;
            document.getElementById('customVaultsAvgEntries').textContent = totalCustomVaults > 0 ? (totalEntriesInCustomVaults / totalCustomVaults).toFixed(1) : '0';

            // Render chart for entries per custom vault
            renderEntriesPerCustomVaultChart();


            // --- Notes & Dork Assistant Summary ---
            const totalTemplates = Object.values(dorkTemplates).flat().length; // Count all pre-templates
            document.getElementById('notesSummaryTotal').textContent = (notesState.notes || []).length;
            document.getElementById('notesSummaryPinned').textContent = (notesState.notes || []).filter(n => n.pinned).length;
            document.getElementById('dorksSummaryTotal').textContent = (dorkAssistantState.savedQueries || []).length;
            document.getElementById('dorksSummaryTemplates').textContent = totalTemplates;


            // --- Render lists ---
            renderMostUsedTools();
            renderNeverUsedTools();
            renderToolsAddedPerWeek();

            // --- Chart Rendering Calls ---
            renderEntriesByTypeChart();
            renderUsageTrendChart();
            renderTopCategoriesChart();
            renderPinnedStarredDonutChart();
            renderEntryGrowthOverTimeChart();
            renderTaggingOverviewChart();
        }
        // --- End of updateDashboard (full code block) ---

        function renderEntriesPerCustomVaultChart() {
            const ctx = document.getElementById('entriesPerCustomVaultChart').getContext('2d');
            
            const customVaultNames = appState.customTabs.map(tab => tab.name);
            const entriesPerVault = appState.customTabs.map(tab => tab.toolIds.length);

            if (window.entriesPerCustomVaultChartInstance) {
                window.entriesPerCustomVaultChartInstance.destroy();
            }

            window.entriesPerCustomVaultChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: customVaultNames,
                    datasets: [{
                        label: 'Entries per Custom Vault',
                        data: entriesPerVault,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)', // Using a purple shade from your theme
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Entries in Custom Vaults',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
                                // Ensure ticks are integers
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            },
                            grid: { color: 'rgba(128, 128, 128, 0.1)' }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderTaggingOverviewChart() {
            const ctx = document.getElementById('taggingOverviewChart').getContext('2d');
            
            // Combine all entries to count tags across all types
            const allEntries = [
                ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
                ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
                ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
                ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
                ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
                ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
                ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
                ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
                ...appState.publicRecords
            ];

            let taggedEntriesCount = 0;
            let untaggedEntriesCount = 0;

            allEntries.forEach(entry => {
                if (entry.tags && entry.tags.length > 0) {
                    taggedEntriesCount++;
                } else {
                    untaggedEntriesCount++;
                }
            });

            const data = [taggedEntriesCount, untaggedEntriesCount];
            const labels = ['Tagged Entries', 'Untagged Entries'];

            if (window.taggingOverviewChartInstance) {
                window.taggingOverviewChartInstance.destroy();
            }

            window.taggingOverviewChartInstance = new Chart(ctx, {
                type: 'doughnut', // Doughnut chart is good for parts of a whole
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#28a745', // Green for tagged
                            '#dc3545'  // Red for untagged
                        ],
                        borderColor: 'var(--bg-primary)', // Border color from your theme variables
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Entry Tagging Overview',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                            }
                        }
                    }
                }
            });
        }

        // Chart rendering functions (these would be placed outside updateDashboard, in your main script)

        function renderTopCategoriesChart() {
            const ctx = document.getElementById('topCategoriesChart').getContext('2d');
            const categoryCounts = {};
            appState.tools.forEach(tool => { // Only tools have categories in your current setup
                const category = tool.category.charAt(0).toUpperCase() + tool.category.slice(1);
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            const labels = Object.keys(categoryCounts);
            const data = Object.values(categoryCounts);

            if (window.topCategoriesChartInstance) {
                window.topCategoriesChartInstance.destroy();
            }
            window.topCategoriesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tools per Category',
                        data: data,
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: '#007bff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Tools by Category', color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() }, grid: { color: 'rgba(128, 128, 128, 0.1)' } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() }, grid: { display: false } }
                    }
                }
            });
        }

        function renderPinnedStarredDonutChart() {
            const ctx = document.getElementById('pinnedStarredDonutChart').getContext('2d');
            // Combine all entries to count pinned/starred across all types
            const allEntries = [
                ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
                ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
                ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
                ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
                ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
                ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
                ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
                ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
                ...appState.publicRecords
            ];

            const pinnedCount = allEntries.filter(entry => entry.pinned).length;
            const starredCount = allEntries.filter(entry => entry.starred).length;

            // Calculate overlaps correctly: sum pinned and starred, then subtract count of items that are both.
            const bothCount = allEntries.filter(entry => entry.pinned && entry.starred).length;
            const uniquePinnedOrStarredCount = pinnedCount + starredCount - bothCount;
            const othersCount = allEntries.length - uniquePinnedOrStarredCount;

            const data = [pinnedCount, starredCount, othersCount]; // Using pinnedCount and starredCount directly for slices
            const labels = ['Pinned', 'Starred', 'Other Entries'];

            if (window.pinnedStarredDonutChartInstance) {
                window.pinnedStarredDonutChartInstance.destroy();
            }
            window.pinnedStarredDonutChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#28a745', '#ffc107', '#6c757d'], // Green for pinned, yellow for starred, grey for others
                        borderColor: 'var(--bg-primary)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Pinned & Starred Entries', color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() },
                        legend: { position: 'right', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() } }
                    }
                }
            });
        }

        function renderEntryGrowthOverTimeChart() {
            const ctx = document.getElementById('entryGrowthOverTimeChart').getContext('2d');
            const cumulativeData = {}; // { 'YYYY-MM-DD': cumulative_count }
            const allEntries = [
                ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
                ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
                ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
                ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
                ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
                ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
                ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
                ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
                ...appState.publicRecords
            ];

            // Sort entries by addedDate to calculate cumulative count
            allEntries.sort((a, b) => new Date(a.addedDate) - new Date(b.addedDate));

            let count = 0;
            allEntries.forEach(entry => {
                if (entry.addedDate) {
                    const date = new Date(entry.addedDate);
                    const key = date.toISOString().slice(0, 10); // Use YYYY-MM-DD as key
                    cumulativeData[key] = ++count; // Increment and assign cumulative count
                }
            });

            const sortedDates = Object.keys(cumulativeData).sort();
            
            let fullLabels = [];
            let fullData = [];

            if (sortedDates.length > 0) {
                let currentDate = new Date(sortedDates[0]);
                let lastCount = 0;
                // Ensure currentDate is initialized to start of first day
                currentDate.setHours(0, 0, 0, 0);

                const lastDate = new Date(sortedDates[sortedDates.length - 1]);
                lastDate.setHours(0, 0, 0, 0);

                let dateIndex = 0; // To track position in sortedDates

                while (currentDate.getTime() <= lastDate.getTime()) {
                    const key = currentDate.toISOString().slice(0, 10);
                    if (dateIndex < sortedDates.length && sortedDates[dateIndex] === key) {
                        lastCount = cumulativeData[key];
                        dateIndex++; // Move to the next available data point
                    }
                    fullLabels.push(currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    fullData.push(lastCount);
                    currentDate.setDate(currentDate.getDate() + 1); // Move to next day
                }
            }


            if (window.entryGrowthOverTimeChartInstance) {
                window.entryGrowthOverTimeChartInstance.destroy();
            }
            window.entryGrowthOverTimeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fullLabels, // Use fullLabels for smoother line
                    datasets: [{
                        label: 'Total Entries Over Time',
                        data: fullData, // Use fullData
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        fill: true,
                        tension: 0.3 // Smooth line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Total Entries Growth', color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() }, grid: { color: 'rgba(128, 128, 128, 0.1)' } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() }, grid: { color: 'rgba(128, 128, 128, 0.1)' } }
                    }
                }
            });
        }

function renderEntriesByTypeChart() {
            const ctx = document.getElementById('entriesByTypeChart').getContext('2d');
            const entryTypeCounts = {};
            // Aggregate all entries into a single array for counting, ensuring all are treated as arrays
            const allEntries = [
                ...(appState.tools || []),
                ...(appState.emails || []),
                ...(appState.phones || []),
                ...(appState.crypto || []),
                ...(appState.locations || []),
                ...(appState.links || []),
                ...(appState.media || []),
                ...(appState.passwords || []),
                ...(appState.keywords || []),
                ...(appState.socials || []),
                ...(appState.domains || []),
                ...(appState.usernames || []),
                ...(appState.threats || []),
                ...(appState.vulnerabilities || []),
                ...(appState.malware || []),
                ...(appState.breaches || []),
                ...(appState.credentials || []),
                ...(appState.forums || []),
                ...(appState.vendors || []),
                ...(appState.telegramChannels || []),
                ...(appState.pastes || []),
                ...(appState.documents || []),
                ...(appState.networks || []),
                ...(appState.metadataEntries || []),
                ...(appState.archives || []),
                ...(appState.messagingApps || []),
                ...(appState.datingProfiles || []),
                ...(appState.audioEntries || []),
                ...(appState.facialRecognition || []),
                ...(appState.personas || []),
                ...(appState.vpns || []),
                ...(appState.honeypots || []),
                ...(appState.exploits || []),
                ...(appState.publicRecords || []),
                ...(appState.caseStudies || [])
            ];

            allEntries.forEach(entry => {
                // **FIX STARTS HERE**
                // Safely access entry.type, defaulting to 'unknown' if it's not a string or is an empty string
                const type = (typeof entry.type === 'string' && entry.type) ?
                             entry.type.charAt(0).toUpperCase() + entry.type.slice(1) :
                             'Unknown';
                // **FIX ENDS HERE**
                entryTypeCounts[type] = (entryTypeCounts[type] || 0) + 1;
            });

            const labels = Object.keys(entryTypeCounts);
            const data = Object.values(entryTypeCounts);

            // Destroy existing chart if it exists to prevent redraw issues
            if (window.entriesByTypeChartInstance) {
                window.entriesByTypeChartInstance.destroy();
            }

            window.entriesByTypeChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d',
                            '#17a2b8', '#6610f2', '#fd7e14', '#e83e8c', '#20c997',
                            '#6f42c1', '#e0f2f1', '#e3f2fd', '#fff3e0', '#fce4ec',
                            '#e1f5fe', '#c8e6c9', '#ffe0b2', '#f8bbd0', '#bbdefb'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Entries by Type',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(), // Dynamic text color
                            font: { size: 16 }
                        },
                        legend: {
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() // Dynamic legend color
                            }
                        }
                    }
                }
            });
        }
        // --- End of renderEntriesByTypeChart ---


        function renderUsageTrendChart() {
            const ctx = document.getElementById('usageTrendChart').getContext('2d');
            const usageData = {}; // { 'YYYY-MM-DD': count } for week starts

            // Aggregate usage over time (you'll need to track 'lastUsed' more granularly for this if not already)
            // For now, let's just use 'addedDate' as a proxy for activity over time for demonstration
            // A more accurate chart would need actual usage logs per entry over time.
            const allEntries = [...appState.tools, /* ... all other appState arrays ... */]; // Comprehensive array

            allEntries.forEach(entry => {
                if (entry.addedDate) { // Or entry.lastUsed if you prefer
                    const date = new Date(entry.addedDate);
                    const weekStart = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)); // Monday of the week
                    const key = weekStart.toISOString().slice(0, 10);
                    usageData[key] = (usageData[key] || 0) + 1;
                }
            });

            const sortedDates = Object.keys(usageData).sort();
            const labels = sortedDates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const data = sortedDates.map(date => usageData[date]);

            // Destroy existing chart if it exists
            if (window.usageTrendChartInstance) {
                window.usageTrendChartInstance.destroy();
            }

            window.usageTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Entries Added Over Time', // Change to 'Entries Used Over Time' for real usage
                        data: data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Entry Activity Trend',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                            font: { size: 16 }
                        },
                        legend: {
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() },
                            grid: { color: 'rgba(128, 128, 128, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() },
                            grid: { color: 'rgba(128, 128, 128, 0.1)' }
                        }
                    }
                }
            });
        }

        function renderMostUsedTools() {
            const mostUsedToolsList = document.getElementById('mostUsedToolsList');
            const noMostUsedTools = document.getElementById('noMostUsedTools');
            
            // Combine all entry types that have lastUsed property and filter
            const allUsedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials]
                                    .filter(entry => entry.lastUsed > 0);

            const usedTools = allUsedEntries.sort((a, b) => b.lastUsed - a.lastUsed)
                                            .slice(0, 5); //
                  mostUsedToolsList.innerHTML = '';
            if (usedTools.length === 0) {
                noMostUsedTools.style.display = 'block';
            } else {
                noMostUsedTools.style.display = 'none';
                usedTools.forEach(entry => {
                    const listItem = document.createElement('li');
                    let name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    listItem.innerHTML = `<span>${name}</span><span>${formatTime(entry.lastUsed)}</span>`;
                    mostUsedToolsList.appendChild(listItem);
                });
            }
        }

        function renderNeverUsedTools() {
            const neverUsedToolsList = document.getElementById('neverUsedToolsList');
            const noNeverUsedTools = document.getElementById('noNeverUsedTools');

            // Combine all entry types
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            const neverUsed = allEntries.filter(entry => !entry.lastUsed || entry.lastUsed === 0)
                                        .sort((a, b) => {
                                            const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                                            const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                                            return nameA.localeCompare(nameB);
                                        });

            neverUsedToolsList.innerHTML = '';
            if (neverUsed.length === 0) {
                noNeverUsedTools.style.display = 'block';
            } else {
                noNeverUsedTools.style.display = 'none';
                neverUsed.forEach(entry => {
                    const listItem = document.createElement('li');
                    let name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    listItem.innerHTML = `<span>${name}</span><span>Never Used</span>`;
                    neverUsedToolsList.appendChild(listItem);
                });
            }
        }

        function renderToolsAddedPerWeek() {
            const toolsAddedPerWeekList = document.getElementById('toolsAddedPerWeekList');
            const noToolsAdded = document.getElementById('noToolsAdded');

            // Combine all entries that have an addedDate
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            const weeklyStats = {};
            allEntries.forEach(entry => {
                if (entry.addedDate) {
                    const date = new Date(entry.addedDate);
                    // Get the start of the week (e.g., Monday)
                    const day = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
                    const startOfWeek = new Date(date.setDate(diff));
                    startOfWeek.setHours(0, 0, 0, 0); // Normalize to start of day

                    const weekKey = startOfWeek.toISOString().split('T')[0]; // YYYY-MM-DD for week start
                    weeklyStats[weekKey] = (weeklyStats[weekKey] || 0) + 1;
                }
            });

            const sortedWeeks = Object.keys(weeklyStats).sort((a, b) => new Date(b) - new Date(a));

            toolsAddedPerWeekList.innerHTML = '';
            if (sortedWeeks.length === 0) {
                noToolsAdded.style.display = 'block';
            } else {
                noToolsAdded.style.display = 'none';
                sortedWeeks.forEach(weekKey => {
                    const count = weeklyStats[weekKey];
                    const weekStartDate = new Date(weekKey);
                    const options = {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    };
                    const formattedWeek = weekStartDate.toLocaleDateString(undefined, options);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>Week of ${formattedWeek}</span><span>${count} entries</span>`;
                    toolsAddedPerWeekList.appendChild(listItem);
                });
            }
        }


        // Format time for display
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp; // Difference in milliseconds

            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30.44); // Average days in a month
            const years = Math.floor(days / 365.25); // Average days in a year

            if (seconds < 60) {
                return seconds === 0 ? 'Just now' : `${seconds} second${seconds === 1 ? '' : 's'} ago`;
            } else if (minutes < 60) {
                return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
            } else if (hours < 24) {
                return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            } else if (days < 7) {
                return `${days} day${days === 1 ? '' : 's'} ago`;
            } else if (weeks < 4) {
                return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
            } else if (months < 12) {
                return `${months} month${months === 1 ? '' : 's'} ago`;
            } else {
                return `${years} year${years === 1 ? '' : 's'} ago`;
            }
        }


        // Universal Modal Functions
        function showModal(id) {
            document.getElementById(id).classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent scrolling background
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Display appropriate form fields based on selected entry type
        function displayEntryForm() {
            const entryType = document.getElementById('entryTypeSelect').value;
            document.querySelectorAll('.entry-fields').forEach(fieldSet => {
                fieldSet.style.display = 'none';
            });
            document.getElementById('entrySourceGroup').style.display = 'none'; // Hide by default
            document.getElementById('customMetadataGroup').style.display = 'none'; // Hide by default

            let fieldsToShow = [];
            switch (entryType) {
                case 'tool':
                    fieldsToShow = ['addToolFields'];
                    break;
                case 'email':
                    fieldsToShow = ['addEmailFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'phone':
                    fieldsToShow = ['addPhoneFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'crypto':
                    fieldsToShow = ['addCryptoFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'location':
                    fieldsToShow = ['addLocationFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'link':
                    fieldsToShow = ['addLinkFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'media':
                    fieldsToShow = ['addMediaFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'password':
                    fieldsToShow = ['addPasswordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'keyword':
                    fieldsToShow = ['addKeywordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'social':
                    fieldsToShow = ['addSocialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'domain':
                    fieldsToShow = ['addDomainFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'username':
                    fieldsToShow = ['addUsernameFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'threat':
                    fieldsToShow = ['addThreatFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'vulnerability':
                    fieldsToShow = ['addVulnerabilityFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'malware':
                    fieldsToShow = ['addMalwareFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'breach':
                    fieldsToShow = ['addBreachFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'credential':
                    fieldsToShow = ['addCredentialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'forum':
                    fieldsToShow = ['addForumFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'vendor':
                    fieldsToShow = ['addVendorFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'telegram':
                    fieldsToShow = ['addTelegramFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'paste':
                    fieldsToShow = ['addPasteFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'document':
                    fieldsToShow = ['addDocumentFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'network':
                    fieldsToShow = ['addNetworkFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'metadata':
                    fieldsToShow = ['addMetadataEntryFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'archive':
                    fieldsToShow = ['addArchiveFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'messaging':
                    fieldsToShow = ['addMessagingFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'dating':
                    fieldsToShow = ['addDatingFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'facial':
                    fieldsToShow = ['addFacialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'persona':
                    fieldsToShow = ['addPersonaFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'vpn':
                    fieldsToShow = ['addVpnFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'honeypot':
                    fieldsToShow = ['addHoneypotFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'exploit':
                    fieldsToShow = ['addExploitFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'publicrecord':
                    fieldsToShow = ['addPublicRecordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                default:
                    // This case should ideally not be hit if all options are covered
                    console.warn(`No form fields defined for entry type: ${entryType}`);
                    break;
            }

            fieldsToShow.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'block';
                }
            });

            // Populate category dropdown for tools (if 'tool' is selected)
            if (entryType === 'tool') {
                populateCategoryFilter();
            }
        }

// MODIFIED: handleAddEntry (ensure new array names are used)
async function handleAddEntry(e) {
    e.preventDefault();
    if (appState.readOnlyMode) {
        showToast("Cannot add entries in read-only shared view.", "warning");
        return;
    }

    const entryType = document.getElementById('entryTypeSelect').value;
    let newEntry = {
        id: generateId(),
        type: entryType,
        starred: false,
        pinned: false,
        lastUsed: 0,
        addedDate: new Date(),
        customTabs: [],
        origin: 'user-added'
    };

    const customMetadata = [];
    document.querySelectorAll('#customMetadataEntries .metadata-entry').forEach(row => {
        const keyInput = row.querySelector('.metadata-key');
        const valueInput = row.querySelector('.metadata-value');
        const key = keyInput ? keyInput.value.trim() : '';
        const value = valueInput ? valueInput.value.trim() : '';
        if (key && value) {
            customMetadata.push({ key, value });
        }
    });
    if (customMetadata.length > 0) {
        newEntry.metadata = customMetadata;
    }

    const entrySourceInput = document.getElementById('entrySource');
    if (entrySourceInput && entrySourceInput.value.trim()) {
        newEntry.source = entrySourceInput.value.trim();
    }


    switch (entryType) {
        case 'tool':
            newEntry.name = document.getElementById('toolName').value.trim();
            newEntry.url = document.getElementById('toolUrl').value.trim();
            let toolCategory = document.getElementById('toolCategory').value;
            const newCategoryInput = document.getElementById('newCategoryInput').value.trim();
            newEntry.description = document.getElementById('toolDescription').value.trim();
            newEntry.tags = document.getElementById('toolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.notes = document.getElementById('toolInvestigationNotes').value.trim();

            if (!newEntry.name || !newEntry.url || !toolCategory) { showToast('Please fill in all required tool fields (Name, URL, Category).', 'error'); return; }
            if (toolCategory === 'custom') {
                if (!newCategoryInput) { showToast('Please enter a custom category name.', 'error'); return; }
                toolCategory = newCategoryInput.toLowerCase();
            }
            newEntry.category = toolCategory;
            newEntry.favicon = `https://www.google.com/s2/favicons?domain=${new URL(newEntry.url).hostname}`;
            appState.tools.push(newEntry);
            break;
        case 'email':
            newEntry.email = document.getElementById('emailAddress').value.trim();
            newEntry.linkedPlatforms = document.getElementById('emailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p);
            newEntry.breachResults = document.getElementById('emailBreachResults').value.trim();
            newEntry.description = document.getElementById('emailDescription').value.trim();
            newEntry.notes = document.getElementById('emailNotes').value.trim();
            if (!newEntry.email) { showToast('Please enter an email address.', 'error'); return; }
            appState.emails.push(newEntry);
            break;
        case 'phone':
            newEntry.number = document.getElementById('phoneNumber').value.trim();
            newEntry.phoneType = document.getElementById('phoneType').value;
            newEntry.location = document.getElementById('phoneLocation').value.trim();
            newEntry.description = document.getElementById('phoneDescription').value.trim();
            newEntry.notes = document.getElementById('phoneNotes').value.trim();
            if (!newEntry.number) { showToast('Please enter a phone number.', 'error'); return; }
            appState.phones.push(newEntry);
            break;
        case 'crypto':
            newEntry.address = document.getElementById('cryptoAddress').value.trim();
            newEntry.txid = document.getElementById('cryptoTxid').value.trim();
            newEntry.amount = parseFloat(document.getElementById('cryptoAmount').value);
            newEntry.source = document.getElementById('cryptoSource').value.trim();
            newEntry.tags = document.getElementById('cryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.description = document.getElementById('cryptoDescription').value.trim();
            newEntry.notes = document.getElementById('cryptoNotes').value.trim();
            if (!newEntry.address || !newEntry.txid || isNaN(newEntry.amount)) { showToast('Please fill in all required crypto fields (Address, TXID, Amount).', 'error'); return; }
            appState.crypto.push(newEntry);
            break;
        case 'location':
            newEntry.name = document.getElementById('locationName').value.trim();
            newEntry.coordinates = document.getElementById('locationCoordinates').value.trim();
            newEntry.mapLink = document.getElementById('locationMapLink').value.trim();
            newEntry.ipGeoIntel = document.getElementById('locationIpGeoIntel').value.trim();
            newEntry.description = document.getElementById('locationDescription').value.trim();
            newEntry.notes = document.getElementById('locationNotes').value.trim();
            if (!newEntry.name || !newEntry.coordinates) { showToast('Please fill in all required location fields (Name, Coordinates).', 'error'); return; }
            appState.locations.push(newEntry);
            break;
        case 'link':
            newEntry.url = document.getElementById('linkUrl').value.trim();
            newEntry.platform = document.getElementById('linkPlatform').value.trim();
            newEntry.tags = document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.description = document.getElementById('linkDescription').value.trim();
            newEntry.notes = document.getElementById('linkNotes').value.trim();
            if (!newEntry.url) { showToast('Please enter a URL.', 'error'); return; }
            appState.links.push(newEntry);
            break;
        case 'media':
            newEntry.title = document.getElementById('mediaTitle').value.trim();
            newEntry.mediaType = document.getElementById('mediaType').value;
            const mediaFile = document.getElementById('mediaFile').files[0];
            newEntry.description = document.getElementById('mediaDescription').value.trim();
            newEntry.notes = document.getElementById('mediaNotes').value.trim();
            
            if (!newEntry.title) { showToast('Please enter a title for the media.', 'error'); return; }
            if (mediaFile) {
                newEntry.base64Data = await readFileAsBase64(mediaFile);
            } else {
                showToast('Please upload a file for media entry.', 'error');
                return;
            }
            appState.media.push(newEntry);
            break;
        case 'password':
            newEntry.service = document.getElementById('passwordService').value.trim();
            newEntry.username = document.getElementById('passwordUsername').value.trim();
            newEntry.password = document.getElementById('passwordValue').value.trim();
            newEntry.strength = document.getElementById('passwordStrength').value.trim();
            newEntry.description = document.getElementById('passwordDescription').value.trim();
            newEntry.notes = document.getElementById('passwordNotes').value.trim();
            if (!newEntry.service || !newEntry.password) { showToast('Please fill in all required password fields (Service, Password).', 'error'); return; }
            appState.passwords.push(newEntry);
            break;
        case 'keyword':
            newEntry.value = document.getElementById('keywordValue').value.trim();
            newEntry.context = document.getElementById('keywordContext').value.trim();
            newEntry.description = document.getElementById('keywordDescription').value.trim();
            newEntry.notes = document.getElementById('keywordNotes').value.trim();
            if (!newEntry.value) { showToast('Please enter a keyword/phrase.', 'error'); return; }
            appState.keywords.push(newEntry);
            break;
        case 'social':
            newEntry.platform = document.getElementById('socialPlatform').value.trim();
            newEntry.url = document.getElementById('socialUrl').value.trim();
            newEntry.username = document.getElementById('socialUsername').value.trim();
            newEntry.followCounts = document.getElementById('socialFollowCounts').value.trim();
            newEntry.description = document.getElementById('socialDescription').value.trim();
            newEntry.notes = document.getElementById('socialNotes').value.trim();
            if (!newEntry.platform || !newEntry.url || !newEntry.username) { showToast('Please fill in all required social profile fields (Platform, URL, Username).', 'error'); return; }
            appState.socials.push(newEntry);
            break;
        case 'domain':
            newEntry.value = document.getElementById('domainValue').value.trim();
            newEntry.domainType = document.getElementById('domainType').value;
            newEntry.registrar = document.getElementById('domainRegistrar').value.trim();
            newEntry.location = document.getElementById('domainLocation').value.trim();
            newEntry.status = document.getElementById('domainStatus').value;
            newEntry.whois = document.getElementById('domainWhois').value.trim();
            newEntry.dns = document.getElementById('domainDns').value.trim();
            newEntry.tags = document.getElementById('domainTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.description = document.getElementById('domainDescription').value.trim();
            newEntry.notes = document.getElementById('domainNotes').value.trim();
            if (!newEntry.value || !newEntry.domainType) { showToast('Please fill in all required domain fields (Domain/IP/URL, Type).', 'error'); return; }
            appState.domains.push(newEntry);
            break;
        case 'username':
            newEntry.value = document.getElementById('usernameValue').value.trim();
            newEntry.platformsFound = document.getElementById('usernamePlatforms').value.trim();
            newEntry.emails = document.getElementById('usernameEmails').value.trim();
            newEntry.realName = document.getElementById('usernameRealName').value.trim();
            newEntry.activity = document.getElementById('usernameActivity').value;
            newEntry.description = document.getElementById('usernameDescription').value.trim();
            newEntry.notes = document.getElementById('usernameNotes').value.trim();
            if (!newEntry.value) { showToast('Please enter a username/handle.', 'error'); return; }
            appState.usernames.push(newEntry);
            break;
        case 'threat':
            newEntry.threatType = document.getElementById('threatType').value;
            newEntry.name = document.getElementById('threatName').value.trim();
            newEntry.severity = document.getElementById('threatSeverity').value;
            newEntry.iocs = document.getElementById('threatIocs').value.trim();
            newEntry.targets = document.getElementById('threatTargets').value.trim();
            newEntry.attribution = document.getElementById('threatAttribution').value.trim();
            newEntry.description = document.getElementById('threatDescription').value.trim();
            newEntry.source = document.getElementById('threatSource').value.trim();
            newEntry.notes = document.getElementById('threatNotes').value.trim();
            if (!newEntry.name || !newEntry.threatType) { showToast('Please fill in all required threat fields (Name/ID, Type).', 'error'); return; }
            appState.threats.push(newEntry);
            break;
        case 'vulnerability':
            newEntry.cve = document.getElementById('vulnCve').value.trim();
            newEntry.cvss = parseFloat(document.getElementById('vulnCvss').value);
            newEntry.software = document.getElementById('vulnSoftware').value.trim();
            newEntry.vulnType = document.getElementById('vulnType').value;
            newEntry.exploit = document.getElementById('vulnExploit').value;
            newEntry.description = document.getElementById('vulnDescription').value.trim();
            newEntry.mitigation = document.getElementById('vulnMitigation').value.trim();
            newEntry.notes = document.getElementById('vulnNotes').value.trim();
            if (!newEntry.cve) { showToast('Please enter a CVE ID.', 'error'); return; }
            appState.vulnerabilities.push(newEntry);
            break;
        case 'malware':
            newEntry.filename = document.getElementById('malwareFilename').value.trim();
            newEntry.hash = document.getElementById('malwareHash').value.trim();
            newEntry.fileType = document.getElementById('malwareType').value;
            newEntry.family = document.getElementById('malwareFamily').value.trim();
            newEntry.detection = document.getElementById('malwareDetection').value.trim();
            newEntry.behavior = document.getElementById('malwareBehavior').value.trim();
            newEntry.source = document.getElementById('malwareSource').value.trim();
            newEntry.tools = document.getElementById('malwareTools').value.trim();
            newEntry.notes = document.getElementById('malwareNotes').value.trim();
            if (!newEntry.filename || !newEntry.hash) { showToast('Please fill in all required malware fields (File Name, File Hash).', 'error'); return; }
            appState.malware.push(newEntry);
            break;
        case 'breach':
            newEntry.company = document.getElementById('breachCompany').value.trim();
            newEntry.date = document.getElementById('breachDate').value;
            newEntry.records = parseInt(document.getElementById('breachRecords').value);
            newEntry.dataTypes = document.getElementById('breachDataTypes').value.trim();
            newEntry.vector = document.getElementById('breachVector').value;
            newEntry.status = document.getElementById('breachStatus').value;
            newEntry.source = document.getElementById('breachSource').value.trim();
            newEntry.description = document.getElementById('breachDescription').value.trim();
            newEntry.notes = document.getElementById('breachNotes').value.trim();
            if (!newEntry.company || !newEntry.date) { showToast('Please fill in all required breach fields (Company/Organization, Breach Date).', 'error'); return; }
            appState.breaches.push(newEntry);
            break;
        case 'credential':
            newEntry.credentialType = document.getElementById('credentialType').value;
            newEntry.credentialValue = document.getElementById('credentialValue').value.trim();
            newEntry.credentialService = document.getElementById('credentialService').value.trim();
            newEntry.breachSource = document.getElementById('credentialBreachSource').value.trim();
            newEntry.dateFound = document.getElementById('credentialDateFound').value;
            newEntry.description = document.getElementById('credentialDescription').value.trim();
            newEntry.notes = document.getElementById('credentialNotes').value.trim();
            if (!newEntry.credentialValue) { showToast('Please enter the credential value.', 'error'); return; }
            appState.credentials.push(newEntry);
            break;
        case 'forum':
            newEntry.forumName = document.getElementById('forumName').value.trim();
            newEntry.forumUrl = document.getElementById('forumUrl').value.trim();
            newEntry.forumType = document.getElementById('forumType').value;
            newEntry.forumStatus = document.getElementById('forumStatus').value;
            newEntry.forumLanguage = document.getElementById('forumLanguage').value.trim();
            newEntry.description = document.getElementById('forumDescription').value.trim();
            newEntry.notes = document.getElementById('forumNotes').value.trim();
            if (!newEntry.forumName || !newEntry.forumUrl) { showToast('Please fill in all required forum fields (Name, URL).', 'error'); return; }
            appState.forums.push(newEntry);
            break;
        case 'vendor':
            newEntry.vendorAlias = document.getElementById('vendorAlias').value.trim();
            newEntry.vendorPlatforms = document.getElementById('vendorPlatforms').value.trim();
            newEntry.vendorProducts = document.getElementById('vendorProducts').value.trim();
            newEntry.vendorReputation = document.getElementById('vendorReputation').value.trim();
            newEntry.description = document.getElementById('vendorDescription').value.trim();
            newEntry.notes = document.getElementById('vendorNotes').value.trim();
            if (!newEntry.vendorAlias) { showToast('Please enter a vendor name/alias.', 'error'); return; }
            appState.vendors.push(newEntry);
            break;
        case 'telegram':
            newEntry.name = document.getElementById('telegramName').value.trim();
            newEntry.url = document.getElementById('telegramUrl').value.trim();
            newEntry.telegramType = document.getElementById('telegramType').value;
            newEntry.subscribers = parseInt(document.getElementById('telegramSubscribers').value);
            newEntry.language = document.getElementById('telegramLanguage').value.trim();
            newEntry.activity = document.getElementById('telegramActivity').value;
            newEntry.content = document.getElementById('telegramContent').value.trim();
            newEntry.admin = document.getElementById('telegramAdmin').value.trim();
            newEntry.tags = document.getElementById('telegramTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.notes = document.getElementById('telegramNotes').value.trim();
            if (!newEntry.name || !newEntry.url) { showToast('Please fill in all required Telegram fields (Channel Name, URL).', 'error'); return; }
            appState.telegramChannels.push(newEntry);
            break;
        case 'paste':
            newEntry.url = document.getElementById('pasteUrl').value.trim();
            newEntry.sourceSite = document.getElementById('pasteSourceSite').value.trim();
            newEntry.contentSummary = document.getElementById('pasteContentSummary').value.trim();
            newEntry.keywords = document.getElementById('pasteKeywords').value.trim();
            newEntry.description = document.getElementById('pasteDescription').value.trim();
            newEntry.notes = document.getElementById('pasteNotes').value.trim();
            if (!newEntry.url) { showToast('Please enter a Paste URL.', 'error'); return; }
            appState.pastes.push(newEntry);
            break;
        case 'document':
            newEntry.title = document.getElementById('documentTitle').value.trim();
            newEntry.fileType = document.getElementById('documentFileType').value.trim();
            newEntry.hash = document.getElementById('documentHash').value.trim();
            newEntry.contentSummary = document.getElementById('documentContentSummary').value.trim();
            newEntry.source = document.getElementById('documentSource').value.trim();
            newEntry.description = document.getElementById('documentDescription').value.trim();
            newEntry.notes = document.getElementById('documentNotes').value.trim();
            if (!newEntry.title || !newEntry.hash) { showToast('Please fill in all required document fields (Title, File Hash).', 'error'); return; }
            appState.documents.push(newEntry);
            break;
        case 'network':
            newEntry.subject = document.getElementById('networkSubject').value.trim();
            newEntry.networkType = document.getElementById('networkType').value;
            newEntry.findings = document.getElementById('networkFindings').value.trim();
            newEntry.associatedIpsDomains = document.getElementById('networkAssociated').value.trim();
            newEntry.toolsUsed = document.getElementById('networkTools').value.trim();
            newEntry.description = document.getElementById('networkDescription').value.trim();
            newEntry.notes = document.getElementById('networkNotes').value.trim();
            if (!newEntry.subject || !newEntry.networkType) { showToast('Please fill in all required network fields (Analysis Subject, Type).', 'error'); return; }
            appState.networks.push(newEntry);
            break;
        case 'metadata':
            newEntry.title = document.getElementById('metadataTitle').value.trim();
            newEntry.description = document.getElementById('metadataDescription').value.trim();
            newEntry.fileSource = document.getElementById('metadataFileSource').value.trim();
            newEntry.notes = document.getElementById('metadataNotes').value.trim();
            if (!newEntry.title) { showToast('Please enter a Metadata Title/Context.', 'error'); return; }
            appState.metadataEntries.push(newEntry);
            break;
        case 'archive':
            newEntry.originalUrl = document.getElementById('archiveOriginalUrl').value.trim();
            newEntry.url = document.getElementById('archiveUrl').value.trim();
            newEntry.service = document.getElementById('archiveService').value.trim();
            newEntry.timestamp = document.getElementById('archiveTimestamp').value; // Keep as string or convert to Date/timestamp
            newEntry.contentSummary = document.getElementById('archiveContentSummary').value.trim();
            newEntry.description = document.getElementById('archiveDescription').value.trim();
            newEntry.notes = document.getElementById('archiveNotes').value.trim();
            if (!newEntry.originalUrl || !newEntry.url) { showToast('Please fill in all required archive fields (Original URL, Archived URL).', 'error'); return; }
            // Convert to timestamp if needed for consistency with other dates
            if (newEntry.timestamp) {
                newEntry.timestamp = new Date(newEntry.timestamp).getTime();
            }
            appState.archives.push(newEntry);
            break;
        case 'messaging':
            newEntry.messagingApp = document.getElementById('messagingApp').value;
            newEntry.username = document.getElementById('messagingUsername').value.trim();
            newEntry.chatId = document.getElementById('messagingChatId').value.trim();
            newEntry.content = document.getElementById('messagingContent').value.trim();
            newEntry.description = document.getElementById('messagingDescription').value.trim();
            newEntry.notes = document.getElementById('messagingNotes').value.trim();
            if (!newEntry.messagingApp || !newEntry.username) { showToast('Please fill in all required messaging fields (App, Username/ID).', 'error'); return; }
            appState.messagingApps.push(newEntry);
            break;
        case 'dating':
            newEntry.platform = document.getElementById('datingPlatform').value;
            newEntry.username = document.getElementById('datingUsername').value.trim();
            newEntry.displayName = document.getElementById('datingDisplayName').value.trim();
            newEntry.age = parseInt(document.getElementById('datingAge').value);
            newEntry.location = document.getElementById('datingLocation').value.trim();
            newEntry.photos = document.getElementById('datingPhotos').value.trim();
            newEntry.bio = document.getElementById('datingBio').value.trim();
            newEntry.verified = document.getElementById('datingVerified').value;
            newEntry.suspicious = document.getElementById('datingSuspicious').value.trim();
            newEntry.notes = document.getElementById('datingNotes').value.trim();
            if (!newEntry.platform || !newEntry.username) { showToast('Please fill in all required dating profile fields (Platform, Username).', 'error'); return; }
            appState.datingProfiles.push(newEntry);
            break;
        case 'audio':
            newEntry.title = document.getElementById('audioTitle').value.trim();
            newEntry.format = document.getElementById('audioFormat').value;
            newEntry.duration = document.getElementById('audioDuration').value.trim();
            newEntry.quality = document.getElementById('audioQuality').value;
            newEntry.language = document.getElementById('audioLanguage').value.trim();
            newEntry.transcript = document.getElementById('audioTranscript').value.trim();
            newEntry.speakers = document.getElementById('audioSpeakers').value.trim();
            newEntry.background = document.getElementById('audioBackground').value.trim();
            newEntry.tools = document.getElementById('audioTools').value.trim();
            newEntry.description = document.getElementById('audioDescription').value.trim();
            newEntry.notes = document.getElementById('audioNotes').value.trim();
            const audioFile = document.getElementById('audioFile').files[0];
            if (!newEntry.title || !newEntry.format) { showToast('Please fill in all required audio fields (Title, Format).', 'error'); return; }
            if (audioFile) {
                newEntry.base64Data = await readFileAsBase64(audioFile);
            } else {
                showToast('Please upload an audio file.', 'error');
                return;
            }
            appState.audioEntries.push(newEntry);
            break;
        case 'facial':
            newEntry.subject = document.getElementById('facialSubject').value.trim();
            newEntry.sourceDescription = document.getElementById('facialSourceDescription').value.trim();
            newEntry.identifiedProfiles = document.getElementById('facialIdentifiedProfiles').value.trim();
            newEntry.confidence = document.getElementById('facialConfidence').value.trim();
            newEntry.toolsUsed = document.getElementById('facialToolsUsed').value.trim();
            newEntry.description = document.getElementById('facialDescription').value.trim();
            newEntry.notes = document.getElementById('facialNotes').value.trim();
            if (!newEntry.subject) { showToast('Please enter a subject/person identified.', 'error'); return; }
            appState.facialRecognition.push(newEntry);
            break;
        case 'persona':
            newEntry.name = document.getElementById('personaName').value.trim();
            newEntry.realName = document.getElementById('personaRealName').value.trim();
            newEntry.associatedAccounts = document.getElementById('personaAssociatedAccounts').value.trim();
            newEntry.bio = document.getElementById('personaBio').value.trim();
            newEntry.platformsUsed = document.getElementById('personaPlatforms').value.trim();
            newEntry.origin = document.getElementById('personaOrigin').value.trim();
            newEntry.notes = document.getElementById('personaNotes').value.trim();
            if (!newEntry.name) { showToast('Please enter a persona name/alias.', 'error'); return; }
            appState.personas.push(newEntry);
            break;
        case 'vpn':
            newEntry.name = document.getElementById('vpnName').value.trim();
            newEntry.vpnType = document.getElementById('vpnType').value;
            newEntry.jurisdiction = document.getElementById('vpnJurisdiction').value.trim();
            newEntry.logs = document.getElementById('vpnLogs').value;
            newEntry.payment = document.getElementById('vpnPayment').value.trim();
            newEntry.locations = document.getElementById('vpnLocations').value.trim();
            newEntry.issues = document.getElementById('vpnIssues').value.trim();
            newEntry.useCase = document.getElementById('vpnUseCase').value;
            newEntry.description = document.getElementById('vpnDescription').value.trim();
            newEntry.notes = document.getElementById('vpnNotes').value.trim();
            if (!newEntry.name || !newEntry.vpnType) { showToast('Please fill in all required VPN fields (Service Name, Type).', 'error'); return; }
            appState.vpns.push(newEntry);
            break;
        case 'honeypot':
            newEntry.honeypotType = document.getElementById('honeypotType').value;
            newEntry.location = document.getElementById('honeypotLocation').value.trim();
            newEntry.purpose = document.getElementById('honeypotPurpose').value.trim();
            newEntry.dataSummary = document.getElementById('honeypotDataSummary').value.trim();
            newEntry.alerts = document.getElementById('honeypotAlerts').value.trim();
            newEntry.description = document.getElementById('honeypotDescription').value.trim();
            newEntry.notes = document.getElementById('honeypotNotes').value.trim();
            if (!newEntry.honeypotType || !newEntry.location) { showToast('Please fill in all required honeypot fields (Type, Deployment Location/IP).', 'error'); return; }
            appState.honeypots.push(newEntry);
            break;
        case 'exploit':
            newEntry.name = document.getElementById('exploitName').value.trim();
            newEntry.targetVuln = document.getElementById('exploitTargetVuln').value.trim();
            newEntry.exploitType = document.getElementById('exploitType').value;
            newEntry.marketSource = document.getElementById('exploitMarketSource').value.trim();
            newEntry.price = document.getElementById('exploitPrice').value.trim();
            newEntry.description = document.getElementById('exploitDescription').value.trim();
            newEntry.notes = document.getElementById('exploitNotes').value.trim();
            if (!newEntry.name || !newEntry.targetVuln) { showToast('Please fill in all required exploit fields (Name/ID, Target Vulnerability).', 'error'); return; }
            appState.exploits.push(newEntry);
            break;
        case 'publicrecord':
            newEntry.recordType = document.getElementById('publicRecordType').value;
            newEntry.subjectName = document.getElementById('publicRecordSubjectName').value.trim();
            newEntry.refId = document.getElementById('publicRecordRefId').value.trim();
            newEntry.jurisdiction = document.getElementById('publicRecordJurisdiction').value.trim();
            newEntry.date = document.getElementById('publicRecordDate').value;
            newEntry.summary = document.getElementById('publicRecordSummary').value.trim();
            newEntry.sourceUrl = document.getElementById('publicRecordSourceUrl').value.trim();
            newEntry.description = document.getElementById('publicRecordDescription').value.trim();
            newEntry.notes = document.getElementById('publicRecordNotes').value.trim();
            if (!newEntry.recordType || !newEntry.subjectName) { showToast('Please fill in all required public record fields (Record Type, Subject Name).', 'error'); return; }
            appState.publicRecords.push(newEntry);
            break;
    }

    if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
        const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
        if (activeCustomTab && !activeCustomTab.toolIds.includes(newEntry.id)) {
            activeCustomTab.toolIds.push(newEntry.id);
            newEntry.customTabs.push(activeCustomTab.id);
        }
    }

    hideModal('addEntryModal');
    document.getElementById('addEntryForm').reset();
    document.getElementById('customMetadataEntries').innerHTML = '';
    showToast('Entry added successfully!');
    updateStats();
    populateCategoryFilter();
    renderIntelligenceEntries();
    renderCustomTabs();
    saveState();
}

// MODIFIED: handleEditEntry function to include all new entry types
async function handleEditEntry(e) {
    e.preventDefault();
    if (appState.readOnlyMode) {
        showToast("Cannot edit entries in read-only shared view.", "warning");
        return;
    }

    const entryId = document.getElementById('editEntryId').value;
    const entryType = document.getElementById('editEntryType').value;

    let entryToEdit = null;
    let entryArray = null;

    // Determine which array to look into based on entryType
    switch (entryType) {
        case 'tool': entryArray = appState.tools; break;
        case 'email': entryArray = appState.emails; break;
        case 'phone': entryArray = appState.phones; break;
        case 'crypto': entryArray = appState.crypto; break;
        case 'location': entryArray = appState.locations; break;
        case 'link': entryArray = appState.links; break;
        case 'media': entryArray = appState.media; break;
        case 'password': entryArray = appState.passwords; break;
        case 'keyword': entryArray = appState.keywords; break;
        case 'social': entryArray = appState.socials; break;
        case 'domain': entryArray = appState.domains; break;
        case 'username': entryArray = appState.usernames; break;
        case 'threat': entryArray = appState.threats; break;
        case 'vulnerability': entryArray = appState.vulnerabilities; break;
        case 'malware': entryArray = appState.malware; break;
        case 'breach': entryArray = appState.breaches; break;
        case 'credential': entryArray = appState.credentials; break;
        case 'forum': entryArray = appState.forums; break;
        case 'vendor': entryArray = appState.vendors; break;
        case 'telegram': entryArray = appState.telegramChannels; break;
        case 'paste': entryArray = appState.pastes; break;
        case 'document': entryArray = appState.documents; break;
        case 'network': entryArray = appState.networks; break;
        case 'metadata': entryArray = appState.metadataEntries; break;
        case 'archive': entryArray = appState.archives; break;
        case 'messaging': entryArray = appState.messagingApps; break;
        case 'dating': entryArray = appState.datingProfiles; break;
        case 'audio': entryArray = appState.audioEntries; break;
        case 'facial': entryArray = appState.facialRecognition; break;
        case 'persona': entryArray = appState.personas; break;
        case 'vpn': entryArray = appState.vpns; break;
        case 'honeypot': entryArray = appState.honeypots; break;
        case 'exploit': entryArray = appState.exploits; break;
        case 'publicrecord': entryArray = appState.publicRecords; break;
        default:
            console.warn(`Unknown entry type for action: ${entryType}`);
            return;
    }

    if (entryArray) {
        entryToEdit = entryArray.find(t => t.id === entryId);
    }

    if (!entryToEdit) {
        showToast('Error: Entry not found for editing.', 'error');
        return;
    }

    // Collect custom metadata
    const customMetadata = [];
    document.querySelectorAll('#editCustomMetadataEntries .metadata-entry').forEach(row => {
        const keyInput = row.querySelector('.metadata-key');
        const valueInput = row.querySelector('.metadata-value');
        const key = keyInput ? keyInput.value.trim() : '';
        const value = valueInput ? valueInput.value.trim() : '';
        if (key && value) {
            customMetadata.push({ key, value });
        }
    });
    entryToEdit.metadata = customMetadata.length > 0 ? customMetadata : undefined;

    // Collect source (general source for all types)
    const entrySourceInput = document.getElementById('editEntrySource');
    entryToEdit.source = entrySourceInput ? entrySourceInput.value.trim() || undefined : undefined;


    switch (entryType) {
        case 'tool':
            entryToEdit.name = document.getElementById('editToolName').value.trim();
            entryToEdit.url = document.getElementById('editToolUrl').value.trim();
            let editToolCategory = document.getElementById('editToolCategory').value;
            const editNewCategoryInput = document.getElementById('editNewCategoryInput').value.trim();
            entryToEdit.description = document.getElementById('editToolDescription').value.trim();
            entryToEdit.tags = document.getElementById('editToolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.notes = document.getElementById('editToolInvestigationNotes').value.trim();

            const editedIntelligenceVaultCategories = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesEditTool input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            entryToEdit.intelligenceVaultCategories = editedIntelligenceVaultCategories;

            if (editToolCategory === 'custom') {
                if (!editNewCategoryInput) { showToast('Please enter a custom category name.', 'error'); return; }
                editToolCategory = editNewCategoryInput.toLowerCase();
            }
            entryToEdit.category = editToolCategory;
            entryToEdit.favicon = `https://www.google.com/s2/favicons?domain=${new URL(entryToEdit.url).hostname}`;
            break;
        case 'email':
            entryToEdit.email = document.getElementById('editEmailAddress').value.trim();
            entryToEdit.linkedPlatforms = document.getElementById('editEmailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p);
            entryToEdit.breachResults = document.getElementById('editEmailBreachResults').value.trim();
            entryToEdit.description = document.getElementById('editEmailDescription').value.trim();
            entryToEdit.notes = document.getElementById('editEmailNotes').value.trim();
            break;
        case 'phone':
            entryToEdit.number = document.getElementById('editPhoneNumber').value.trim();
            entryToEdit.phoneType = document.getElementById('editPhoneType').value;
            entryToEdit.location = document.getElementById('editPhoneLocation').value.trim();
            entryToEdit.description = document.getElementById('editPhoneDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPhoneNotes').value.trim();
            break;
        case 'crypto':
            entryToEdit.address = document.getElementById('editCryptoAddress').value.trim();
            entryToEdit.txid = document.getElementById('editCryptoTxid').value.trim();
            entryToEdit.amount = parseFloat(document.getElementById('editCryptoAmount').value);
            entryToEdit.source = document.getElementById('editCryptoSource').value.trim();
            entryToEdit.tags = document.getElementById('editCryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.description = document.getElementById('editCryptoDescription').value.trim();
            entryToEdit.notes = document.getElementById('editCryptoNotes').value.trim();
            break;
        case 'location':
            entryToEdit.name = document.getElementById('editLocationName').value.trim();
            entryToEdit.coordinates = document.getElementById('editLocationCoordinates').value.trim();
            entryToEdit.mapLink = document.getElementById('editLocationMapLink').value.trim();
            entryToEdit.ipGeoIntel = document.getElementById('editLocationIpGeoIntel').value.trim();
            entryToEdit.description = document.getElementById('editLocationDescription').value.trim();
            entryToEdit.notes = document.getElementById('editLocationNotes').value.trim();
            break;
        case 'link':
            entryToEdit.url = document.getElementById('editLinkUrl').value.trim();
            entryToEdit.platform = document.getElementById('editLinkPlatform').value.trim();
            entryToEdit.tags = document.getElementById('editLinkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.description = document.getElementById('editLinkDescription').value.trim();
            entryToEdit.notes = document.getElementById('editLinkNotes').value.trim();
            break;
        case 'media':
            entryToEdit.title = document.getElementById('editMediaTitle').value.trim();
            entryToEdit.mediaType = document.getElementById('editMediaType').value;
            const editMediaFile = document.getElementById('editMediaFile').files[0];
            if (editMediaFile) {
                entryToEdit.base64Data = await readFileAsBase64(editMediaFile);
            }
            entryToEdit.description = document.getElementById('editMediaDescription').value.trim();
            entryToEdit.notes = document.getElementById('editMediaNotes').value.trim();
            break;
        case 'password':
            entryToEdit.service = document.getElementById('editPasswordService').value.trim();
            entryToEdit.username = document.getElementById('editPasswordUsername').value.trim();
            entryToEdit.password = document.getElementById('editPasswordValue').value.trim();
            entryToEdit.strength = document.getElementById('editPasswordStrength').value.trim();
            entryToEdit.description = document.getElementById('editPasswordDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPasswordNotes').value.trim();
            break;
        case 'keyword':
            entryToEdit.value = document.getElementById('editKeywordValue').value.trim();
            entryToEdit.context = document.getElementById('editKeywordContext').value.trim();
            entryToEdit.description = document.getElementById('editKeywordDescription').value.trim();
            entryToEdit.notes = document.getElementById('editKeywordNotes').value.trim();
            break;
        case 'social':
            entryToEdit.platform = document.getElementById('editSocialPlatform').value.trim();
            entryToEdit.url = document.getElementById('editSocialUrl').value.trim();
            entryToEdit.username = document.getElementById('editSocialUsername').value.trim();
            entryToEdit.followCounts = document.getElementById('editSocialFollowCounts').value.trim();
            entryToEdit.description = document.getElementById('editSocialDescription').value.trim();
            entryToEdit.notes = document.getElementById('editSocialNotes').value.trim();
            break;
        case 'domain':
            entryToEdit.value = document.getElementById('editDomainValue').value.trim();
            entryToEdit.domainType = document.getElementById('editDomainType').value;
            entryToEdit.registrar = document.getElementById('editDomainRegistrar').value.trim();
            entryToEdit.location = document.getElementById('editDomainLocation').value.trim();
            entryToEdit.status = document.getElementById('editDomainStatus').value;
            entryToEdit.whois = document.getElementById('editDomainWhois').value.trim();
            entryToEdit.dns = document.getElementById('editDomainDns').value.trim();
            entryToEdit.tags = document.getElementById('editDomainTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.description = document.getElementById('editDomainDescription').value.trim();
            entryToEdit.notes = document.getElementById('editDomainNotes').value.trim();
            break;
        case 'username':
            entryToEdit.value = document.getElementById('editUsernameValue').value.trim();
            entryToEdit.platformsFound = document.getElementById('editUsernamePlatforms').value.trim();
            entryToEdit.emails = document.getElementById('editUsernameEmails').value.trim();
            entryToEdit.realName = document.getElementById('editUsernameRealName').value.trim();
            entryToEdit.activity = document.getElementById('editUsernameActivity').value;
            entryToEdit.description = document.getElementById('editUsernameDescription').value.trim();
            entryToEdit.notes = document.getElementById('editUsernameNotes').value.trim();
            break;
        case 'threat':
            entryToEdit.threatType = document.getElementById('editThreatType').value;
            entryToEdit.name = document.getElementById('editThreatName').value.trim();
            entryToEdit.severity = document.getElementById('editThreatSeverity').value;
            entryToEdit.iocs = document.getElementById('editThreatIocs').value.trim();
            entryToEdit.targets = document.getElementById('editThreatTargets').value.trim();
            entryToEdit.attribution = document.getElementById('editThreatAttribution').value.trim();
            entryToEdit.description = document.getElementById('editThreatDescription').value.trim();
            entryToEdit.source = document.getElementById('editThreatSource').value.trim();
            entryToEdit.notes = document.getElementById('editThreatNotes').value.trim();
            break;
        case 'vulnerability':
            entryToEdit.cve = document.getElementById('editVulnCve').value.trim();
            entryToEdit.cvss = parseFloat(document.getElementById('editVulnCvss').value);
            entryToEdit.software = document.getElementById('editVulnSoftware').value.trim();
            entryToEdit.vulnType = document.getElementById('editVulnType').value;
            entryToEdit.exploit = document.getElementById('editVulnExploit').value;
            entryToEdit.description = document.getElementById('editVulnDescription').value.trim();
            entryToEdit.mitigation = document.getElementById('editVulnMitigation').value.trim();
            entryToEdit.notes = document.getElementById('editVulnNotes').value.trim();
            break;
        case 'malware':
            entryToEdit.filename = document.getElementById('editMalwareFilename').value.trim();
            entryToEdit.hash = document.getElementById('editMalwareHash').value.trim();
            entryToEdit.fileType = document.getElementById('editMalwareType').value;
            entryToEdit.family = document.getElementById('editMalwareFamily').value.trim();
            entryToEdit.detection = document.getElementById('editMalwareDetection').value.trim();
            entryToEdit.behavior = document.getElementById('editMalwareBehavior').value.trim();
            entryToEdit.malwareSource = document.getElementById('editMalwareSource').value.trim();
            entryToEdit.tools = document.getElementById('editMalwareTools').value.trim();
            entryToEdit.notes = document.getElementById('editMalwareNotes').value.trim();
            break;
        case 'breach':
            entryToEdit.company = document.getElementById('editBreachCompany').value.trim();
            entryToEdit.date = document.getElementById('editBreachDate').value;
            entryToEdit.records = parseInt(document.getElementById('editBreachRecords').value);
            entryToEdit.dataTypes = document.getElementById('editBreachDataTypes').value.trim();
            entryToEdit.vector = document.getElementById('editBreachVector').value;
            entryToEdit.status = document.getElementById('editBreachStatus').value;
            entryToEdit.source = document.getElementById('editBreachSource').value.trim();
            entryToEdit.description = document.getElementById('editBreachDescription').value.trim();
            entryToEdit.notes = document.getElementById('editBreachNotes').value.trim();
            break;
        case 'credential':
            entryToEdit.credentialType = document.getElementById('editCredentialType').value;
            entryToEdit.credentialValue = document.getElementById('editCredentialValue').value.trim();
            entryToEdit.credentialService = document.getElementById('editCredentialService').value.trim();
            entryToEdit.breachSource = document.getElementById('editCredentialBreachSource').value.trim();
            entryToEdit.dateFound = document.getElementById('editCredentialDateFound').value;
            entryToEdit.description = document.getElementById('editCredentialDescription').value.trim();
            entryToEdit.notes = document.getElementById('editCredentialNotes').value.trim();
            break;
        case 'forum':
            entryToEdit.forumName = document.getElementById('editForumName').value.trim();
            entryToEdit.forumUrl = document.getElementById('editForumUrl').value.trim();
            entryToEdit.forumType = document.getElementById('editForumType').value;
            entryToEdit.forumStatus = document.getElementById('editForumStatus').value;
            entryToEdit.forumLanguage = document.getElementById('editForumLanguage').value.trim();
            entryToEdit.description = document.getElementById('editForumDescription').value.trim();
            entryToEdit.notes = document.getElementById('editForumNotes').value.trim();
            break;
        case 'vendor':
            entryToEdit.vendorAlias = document.getElementById('editVendorAlias').value.trim();
            entryToEdit.vendorPlatforms = document.getElementById('editVendorPlatforms').value.trim();
            entryToEdit.vendorProducts = document.getElementById('editVendorProducts').value.trim();
            entryToEdit.vendorReputation = document.getElementById('editVendorReputation').value.trim();
            entryToEdit.description = document.getElementById('editVendorDescription').value.trim();
            entryToEdit.notes = document.getElementById('editVendorNotes').value.trim();
            break;
        case 'telegram':
            entryToEdit.name = document.getElementById('editTelegramName').value.trim();
            entryToEdit.url = document.getElementById('editTelegramUrl').value.trim();
            entryToEdit.telegramType = document.getElementById('editTelegramType').value;
            entryToEdit.subscribers = parseInt(document.getElementById('editTelegramSubscribers').value);
            entryToEdit.language = document.getElementById('editTelegramLanguage').value.trim();
            entryToEdit.activity = document.getElementById('editTelegramActivity').value;
            entryToEdit.content = document.getElementById('editTelegramContent').value.trim();
            entryToEdit.admin = document.getElementById('editTelegramAdmin').value.trim();
            entryToEdit.tags = document.getElementById('editTelegramTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.notes = document.getElementById('editTelegramNotes').value.trim();
            break;
        case 'paste':
            entryToEdit.url = document.getElementById('editPasteUrl').value.trim();
            entryToEdit.sourceSite = document.getElementById('editPasteSourceSite').value.trim();
            entryToEdit.contentSummary = document.getElementById('editPasteContentSummary').value.trim();
            entryToEdit.keywords = document.getElementById('editPasteKeywords').value.trim();
            entryToEdit.description = document.getElementById('editPasteDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPasteNotes').value.trim();
            break;
        case 'document':
            entryToEdit.title = document.getElementById('editDocumentTitle').value.trim();
            entryToEdit.fileType = document.getElementById('editDocumentFileType').value.trim();
            entryToEdit.hash = document.getElementById('editDocumentHash').value.trim();
            entryToEdit.contentSummary = document.getElementById('editDocumentContentSummary').value.trim();
            entryToEdit.source = document.getElementById('editDocumentSource').value.trim();
            entryToEdit.description = document.getElementById('editDocumentDescription').value.trim();
            entryToEdit.notes = document.getElementById('editDocumentNotes').value.trim();
            break;
        case 'network':
            entryToEdit.subject = document.getElementById('editNetworkSubject').value.trim();
            entryToEdit.networkType = document.getElementById('editNetworkType').value;
            entryToEdit.findings = document.getElementById('editNetworkFindings').value.trim();
            entryToEdit.associatedIpsDomains = document.getElementById('editNetworkAssociated').value.trim();
            entryToEdit.toolsUsed = document.getElementById('editNetworkTools').value.trim();
            entryToEdit.description = document.getElementById('editNetworkDescription').value.trim();
            entryToEdit.notes = document.getElementById('editNetworkNotes').value.trim();
            break;
        case 'metadata':
            entryToEdit.title = document.getElementById('editMetadataTitle').value.trim();
            entryToEdit.description = document.getElementById('editMetadataDescription').value.trim();
            entryToEdit.fileSource = document.getElementById('editMetadataFileSource').value.trim();
            entryToEdit.notes = document.getElementById('editMetadataNotes').value.trim();
            break;
        case 'archive':
            entryToEdit.originalUrl = document.getElementById('editArchiveOriginalUrl').value.trim();
            entryToEdit.url = document.getElementById('editArchiveUrl').value.trim();
            entryToEdit.service = document.getElementById('editArchiveService').value.trim();
            entryToEdit.timestamp = document.getElementById('editArchiveTimestamp').value ? new Date(document.getElementById('editArchiveTimestamp').value).getTime() : null;
            entryToEdit.contentSummary = document.getElementById('editArchiveContentSummary').value.trim();
            entryToEdit.description = document.getElementById('editArchiveDescription').value.trim();
            entryToEdit.notes = document.getElementById('editArchiveNotes').value.trim();
            break;
        case 'messaging':
            entryToEdit.messagingApp = document.getElementById('editMessagingApp').value;
            entryToEdit.username = document.getElementById('editMessagingUsername').value.trim();
            entryToEdit.chatId = document.getElementById('editMessagingChatId').value.trim();
            entryToEdit.content = document.getElementById('editMessagingContent').value.trim();
            entryToEdit.description = document.getElementById('editMessagingDescription').value.trim();
            entryToEdit.notes = document.getElementById('editMessagingNotes').value.trim();
            break;
        case 'dating':
            entryToEdit.platform = document.getElementById('editDatingPlatform').value;
            entryToEdit.username = document.getElementById('editDatingUsername').value.trim();
            entryToEdit.displayName = document.getElementById('editDatingDisplayName').value.trim();
            entryToEdit.age = parseInt(document.getElementById('editDatingAge').value);
            entryToEdit.location = document.getElementById('editDatingLocation').value.trim();
            entryToEdit.photos = document.getElementById('editDatingPhotos').value.trim();
            entryToEdit.bio = document.getElementById('editDatingBio').value.trim();
            entryToEdit.verified = document.getElementById('editDatingVerified').value;
            entryToEdit.suspicious = document.getElementById('editDatingSuspicious').value.trim();
            entryToEdit.notes = document.getElementById('editDatingNotes').value.trim();
            break;
        case 'audio':
            entryToEdit.title = document.getElementById('editAudioTitle').value.trim();
            entryToEdit.format = document.getElementById('editAudioFormat').value;
            entryToEdit.duration = document.getElementById('editAudioDuration').value.trim();
            entryToEdit.quality = document.getElementById('editAudioQuality').value;
            entryToEdit.language = document.getElementById('editAudioLanguage').value.trim();
            entryToEdit.transcript = document.getElementById('editAudioTranscript').value.trim();
            entryToEdit.speakers = document.getElementById('editAudioSpeakers').value.trim();
            entryToEdit.background = document.getElementById('editAudioBackground').value.trim();
            entryToEdit.tools = document.getElementById('editAudioTools').value.trim();
            entryToEdit.description = document.getElementById('editAudioDescription').value.trim();
            entryToEdit.notes = document.getElementById('editAudioNotes').value.trim();
            const editAudioFile = document.getElementById('editAudioFile').files[0];
            if (editAudioFile) {
                entryToEdit.base64Data = await readFileAsBase64(editAudioFile);
            }
            break;
        case 'facial':
            entryToEdit.subject = document.getElementById('editFacialSubject').value.trim();
            entryToEdit.sourceDescription = document.getElementById('editFacialSourceDescription').value.trim();
            entryToEdit.identifiedProfiles = document.getElementById('editFacialIdentifiedProfiles').value.trim();
            entryToEdit.confidence = document.getElementById('editFacialConfidence').value.trim();
            entryToEdit.toolsUsed = document.getElementById('editFacialToolsUsed').value.trim();
            entryToEdit.description = document.getElementById('editFacialDescription').value.trim();
            entryToEdit.notes = document.getElementById('editFacialNotes').value.trim();
            break;
        case 'persona':
            entryToEdit.name = document.getElementById('editPersonaName').value.trim();
            entryToEdit.realName = document.getElementById('editPersonaRealName').value.trim();
            entryToEdit.associatedAccounts = document.getElementById('editPersonaAssociatedAccounts').value.trim();
            entryToEdit.bio = document.getElementById('editPersonaBio').value.trim();
            entryToEdit.platformsUsed = document.getElementById('editPersonaPlatforms').value.trim();
            entryToEdit.origin = document.getElementById('editPersonaOrigin').value.trim();
            entryToEdit.notes = document.getElementById('editPersonaNotes').value.trim();
            break;
        case 'vpn':
            entryToEdit.name = document.getElementById('editVpnName').value.trim();
            entryToEdit.vpnType = document.getElementById('editVpnType').value;
            entryToEdit.jurisdiction = document.getElementById('editVpnJurisdiction').value.trim();
            entryToEdit.logs = document.getElementById('editVpnLogs').value;
            entryToEdit.payment = document.getElementById('editVpnPayment').value.trim();
            entryToEdit.locations = document.getElementById('editVpnLocations').value.trim();
            entryToEdit.issues = document.getElementById('editVpnIssues').value.trim();
            entryToEdit.useCase = document.getElementById('editVpnUseCase').value;
            entryToEdit.description = document.getElementById('editVpnDescription').value.trim();
            entryToEdit.notes = document.getElementById('editVpnNotes').value.trim();
            break;
        case 'honeypot':
            entryToEdit.honeypotType = document.getElementById('editHoneypotType').value;
            entryToEdit.location = document.getElementById('editHoneypotLocation').value.trim();
            entryToEdit.purpose = document.getElementById('editHoneypotPurpose').value.trim();
            entryToEdit.dataSummary = document.getElementById('editHoneypotDataSummary').value.trim();
            entryToEdit.alerts = document.getElementById('editHoneypotAlerts').value.trim();
            entryToEdit.description = document.getElementById('editHoneypotDescription').value.trim();
            entryToEdit.notes = document.getElementById('editHoneypotNotes').value.trim();
            break;
        case 'exploit':
            entryToEdit.name = document.getElementById('editExploitName').value.trim();
            entryToEdit.targetVuln = document.getElementById('editExploitTargetVuln').value.trim();
            entryToEdit.exploitType = document.getElementById('editExploitType').value;
            entryToEdit.marketSource = document.getElementById('editExploitMarketSource').value.trim();
            entryToEdit.price = document.getElementById('editExploitPrice').value.trim();
            entryToEdit.description = document.getElementById('editExploitDescription').value.trim();
            entryToEdit.notes = document.getElementById('editExploitNotes').value.trim();
            break;
        case 'publicrecord':
            entryToEdit.recordType = document.getElementById('editPublicRecordType').value;
            entryToEdit.subjectName = document.getElementById('editPublicRecordSubjectName').value.trim();
            entryToEdit.refId = document.getElementById('editPublicRecordRefId').value.trim();
            entryToEdit.jurisdiction = document.getElementById('editPublicRecordJurisdiction').value.trim();
            entryToEdit.date = document.getElementById('editPublicRecordDate').value;
            entryToEdit.summary = document.getElementById('editPublicRecordSummary').value.trim();
            entryToEdit.sourceUrl = document.getElementById('editPublicRecordSourceUrl').value.trim();
            entryToEdit.description = document.getElementById('editPublicRecordDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPublicRecordNotes').value.trim();
            break;
    }

    // Update custom tab assignments for this entry
    const assignedCustomTabs = Array.from(document.querySelectorAll('#assignCustomTabsCheckboxes input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);

    // Clear existing custom tab assignments for this entry
    appState.customTabs.forEach(tab => {
        tab.toolIds = tab.toolIds.filter(id => id !== entryId);
    });
    entryToEdit.customTabs = []; // Reset the entry's customTabs array

    // Add back selected assignments
    assignedCustomTabs.forEach(tabId => {
        const tab = appState.customTabs.find(t => t.id === tabId);
        if (tab) {
            tab.toolIds.push(entryId);
            entryToEdit.customTabs.push(tabId); // Also update the entry itself
        }
    });

    hideModal('editEntryModal');
    showToast('Entry updated successfully!');
    updateStats();
    populateCategoryFilter();
    renderIntelligenceEntries();
    renderCustomTabs(); // Re-render custom tabs to update counts/content
    saveState();
}

// MODIFIED: openEditEntryModal function to handle all new entry types
function openEditEntryModal(entry) {
    if (appState.readOnlyMode) {
        showToast("Cannot edit entries in read-only shared view.", "warning");
        return;
    }

    document.getElementById('editEntryId').value = entry.id;
    document.getElementById('editEntryType').value = entry.type;

    // Hide all entry-specific field sets and remove their 'required' attributes
    document.querySelectorAll('#editEntryModal .entry-fields').forEach(fieldSet => {
        fieldSet.style.display = 'none';
        fieldSet.querySelectorAll('[required]').forEach(input => {
            input.removeAttribute('required');
        });
    });

    // Handle general source and metadata groups, ensuring they are always visible for edit if applicable
    const editEntrySourceGroup = document.getElementById('editEntrySourceGroup');
    const editEntrySource = document.getElementById('editEntrySource');
    if (editEntrySourceGroup) editEntrySourceGroup.style.display = 'block';
    if (editEntrySource) editEntrySource.value = entry.source || '';

    const editCustomMetadataEntries = document.getElementById('editCustomMetadataEntries');
    const editCustomMetadataGroup = document.getElementById('editCustomMetadataGroup');
    if (editCustomMetadataEntries) editCustomMetadataEntries.innerHTML = ''; // Clear previous entries
    if (entry.metadata && entry.metadata.length > 0) {
        entry.metadata.forEach(meta => addMetadataField('edit', meta.key, meta.value));
    }
    if (editCustomMetadataGroup) editCustomMetadataGroup.style.display = 'block';


    let fieldsToShow = [];
    // Centralized function to set field values safely
    const setFieldValue = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.value = value || '';
    };
    const setRequired = (id, isRequired) => {
        const element = document.getElementById(id);
        if (element) {
            if (isRequired) element.setAttribute('required', 'required');
            else element.removeAttribute('required');
        }
    };


    switch (entry.type) {
        case 'tool':
            fieldsToShow = ['editToolFields'];
            setFieldValue('editToolName', entry.name);
            setFieldValue('editToolUrl', entry.url);
            setFieldValue('editToolCategory', entry.category);
            setFieldValue('editToolDescription', entry.description);
            setFieldValue('editToolTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editToolInvestigationNotes', entry.notes); // Fix: Ensure this field exists and is correctly targeted

            const editVaultCategorySearchInput = document.getElementById('editIntelligenceVaultCategorySearch');
            if (editVaultCategorySearchInput) {
                editVaultCategorySearchInput.value = '';
            }
            populateIntelligenceVaultCategoriesCheckboxesEditTool(entry.intelligenceVaultCategories || [], '');

            const editNewCategoryInput = document.getElementById('editNewCategoryInput');
            const editToolCategorySelect = document.getElementById('editToolCategory');
            if (editToolCategorySelect && !editToolCategorySelect.querySelector(`option[value="${entry.category}"]`)) {
                editToolCategorySelect.value = 'custom';
                if (editNewCategoryInput) {
                    editNewCategoryInput.style.display = 'block';
                    editNewCategoryInput.value = entry.category;
                }
            } else if (editNewCategoryInput) {
                editNewCategoryInput.style.display = 'none';
                editNewCategoryInput.value = '';
            }

            setRequired('editToolName', true);
            setRequired('editToolUrl', true);
            setRequired('editToolCategory', true);
            if (editNewCategoryInput && editNewCategoryInput.style.display === 'block') {
                setRequired('editNewCategoryInput', true);
            }
            break;
        case 'email':
            fieldsToShow = ['editEmailFields']; // Source and metadata handled generically now
            setFieldValue('editEmailAddress', entry.email);
            setFieldValue('editEmailLinkedPlatforms', entry.linkedPlatforms ? entry.linkedPlatforms.join(', ') : '');
            setFieldValue('editEmailBreachResults', entry.breachResults);
            setFieldValue('editEmailDescription', entry.description); // Fix: Ensure this field exists and is correctly targeted
            setFieldValue('editEmailNotes', entry.notes);
            setRequired('editEmailAddress', true);
            break;
        case 'phone':
            fieldsToShow = ['editPhoneFields'];
            setFieldValue('editPhoneNumber', entry.number);
            setFieldValue('editPhoneType', entry.phoneType);
            setFieldValue('editPhoneLocation', entry.location);
            setFieldValue('editPhoneDescription', entry.description);
            setFieldValue('editPhoneNotes', entry.notes);
            setRequired('editPhoneNumber', true);
            break;
        case 'crypto':
            fieldsToShow = ['editCryptoFields'];
            setFieldValue('editCryptoAddress', entry.address);
            setFieldValue('editCryptoTxid', entry.txid);
            setFieldValue('editCryptoAmount', entry.amount);
            setFieldValue('editCryptoSource', entry.source);
            setFieldValue('editCryptoTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editCryptoDescription', entry.description);
            setFieldValue('editCryptoNotes', entry.notes);
            setRequired('editCryptoAddress', true);
            setRequired('editCryptoTxid', true);
            setRequired('editCryptoAmount', true);
            break;
        case 'location':
            fieldsToShow = ['editLocationFields'];
            setFieldValue('editLocationName', entry.name);
            setFieldValue('editLocationCoordinates', entry.coordinates);
            setFieldValue('editLocationMapLink', entry.mapLink);
            setFieldValue('editLocationIpGeoIntel', entry.ipGeoIntel);
            setFieldValue('editLocationDescription', entry.description);
            setFieldValue('editLocationNotes', entry.notes);
            setRequired('editLocationName', true);
            setRequired('editLocationCoordinates', true);
            break;
        case 'link':
            fieldsToShow = ['editLinkFields'];
            setFieldValue('editLinkUrl', entry.url);
            setFieldValue('editLinkPlatform', entry.platform);
            setFieldValue('editLinkTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editLinkDescription', entry.description);
            setFieldValue('editLinkNotes', entry.notes);
            setRequired('editLinkUrl', true);
            break;
        case 'media':
            fieldsToShow = ['editMediaFields'];
            setFieldValue('editMediaTitle', entry.title);
            setFieldValue('editMediaType', entry.mediaType);
            setFieldValue('editMediaBase64Data', entry.base64Data);
            setFieldValue('editMediaDescription', entry.description);
            setFieldValue('editMediaNotes', entry.notes);
            setRequired('editMediaTitle', true);
            break;
        case 'password':
            fieldsToShow = ['editPasswordFields'];
            setFieldValue('editPasswordService', entry.service);
            setFieldValue('editPasswordUsername', entry.username);
            setFieldValue('editPasswordValue', entry.password);
            setFieldValue('editPasswordStrength', entry.strength);
            setFieldValue('editPasswordDescription', entry.description); // Fix: Ensure this field exists and is correctly targeted
            setFieldValue('editPasswordNotes', entry.notes);
            setRequired('editPasswordService', true);
            setRequired('editPasswordValue', true);
            break;
        case 'keyword':
            fieldsToShow = ['editKeywordFields'];
            setFieldValue('editKeywordValue', entry.value);
            setFieldValue('editKeywordContext', entry.context);
            setFieldValue('editKeywordDescription', entry.description);
            setFieldValue('editKeywordNotes', entry.notes);
            setRequired('editKeywordValue', true);
            break;
        case 'social':
            fieldsToShow = ['editSocialFields'];
            setFieldValue('editSocialPlatform', entry.platform);
            setFieldValue('editSocialUrl', entry.url);
            setFieldValue('editSocialUsername', entry.username);
            setFieldValue('editSocialFollowCounts', entry.followCounts);
            setFieldValue('editSocialDescription', entry.description);
            setFieldValue('editSocialNotes', entry.notes);
            setRequired('editSocialPlatform', true);
            setRequired('editSocialUrl', true);
            setRequired('editSocialUsername', true);
            break;
        case 'domain':
            fieldsToShow = ['editDomainFields'];
            setFieldValue('editDomainValue', entry.value);
            setFieldValue('editDomainType', entry.domainType);
            setFieldValue('editDomainRegistrar', entry.registrar);
            setFieldValue('editDomainLocation', entry.location);
            setFieldValue('editDomainStatus', entry.status);
            setFieldValue('editDomainWhois', entry.whois);
            setFieldValue('editDomainDns', entry.dns);
            setFieldValue('editDomainTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editDomainDescription', entry.description);
            setFieldValue('editDomainNotes', entry.notes);
            setRequired('editDomainValue', true);
            setRequired('editDomainType', true);
            break;
        case 'username':
            fieldsToShow = ['editUsernameFields'];
            setFieldValue('editUsernameValue', entry.value);
            setFieldValue('editUsernamePlatforms', entry.platformsFound);
            setFieldValue('editUsernameEmails', entry.emails);
            setFieldValue('editUsernameRealName', entry.realName);
            setFieldValue('editUsernameActivity', entry.activity);
            setFieldValue('editUsernameDescription', entry.description);
            setFieldValue('editUsernameNotes', entry.notes);
            setRequired('editUsernameValue', true);
            break;
        case 'threat':
            fieldsToShow = ['editThreatFields'];
            setFieldValue('editThreatType', entry.threatType);
            setFieldValue('editThreatName', entry.name);
            setFieldValue('editThreatSeverity', entry.severity);
            setFieldValue('editThreatIocs', entry.iocs);
            setFieldValue('editThreatTargets', entry.targets);
            setFieldValue('editThreatAttribution', entry.attribution);
            setFieldValue('editThreatDescription', entry.description);
            setFieldValue('editThreatSource', entry.source);
            setFieldValue('editThreatNotes', entry.notes);
            setRequired('editThreatName', true);
            setRequired('editThreatType', true);
            break;
        case 'vulnerability':
            fieldsToShow = ['editVulnerabilityFields'];
            setFieldValue('editVulnCve', entry.cve);
            setFieldValue('editVulnCvss', entry.cvss);
            setFieldValue('editVulnSoftware', entry.software);
            setFieldValue('editVulnType', entry.vulnType);
            setFieldValue('editVulnExploit', entry.exploit);
            setFieldValue('editVulnDescription', entry.description);
            setFieldValue('editVulnMitigation', entry.mitigation);
            setFieldValue('editVulnNotes', entry.notes);
            setRequired('editVulnCve', true);
            break;
        case 'malware':
            fieldsToShow = ['editMalwareFields'];
            setFieldValue('editMalwareFilename', entry.filename);
            setFieldValue('editMalwareHash', entry.hash);
            setFieldValue('editMalwareType', entry.fileType);
            setFieldValue('editMalwareFamily', entry.family);
            setFieldValue('editMalwareDetection', entry.detection);
            setFieldValue('editMalwareBehavior', entry.behavior);
            setFieldValue('editMalwareSource', entry.malwareSource);
            setFieldValue('editMalwareTools', entry.tools);
            setFieldValue('editMalwareNotes', entry.notes);
            setRequired('editMalwareFilename', true);
            break;
        case 'breach':
            fieldsToShow = ['editBreachFields'];
            setFieldValue('editBreachCompany', entry.company);
            setFieldValue('editBreachDate', entry.date);
            setFieldValue('editBreachRecords', entry.records);
            setFieldValue('editBreachDataTypes', entry.dataTypes);
            setFieldValue('editBreachVector', entry.vector);
            setFieldValue('editBreachStatus', entry.status);
            setFieldValue('editBreachSource', entry.source);
            setFieldValue('editBreachDescription', entry.description);
            setFieldValue('editBreachNotes', entry.notes);
            setRequired('editBreachCompany', true);
            break;
        case 'credential':
            fieldsToShow = ['editCredentialFields'];
            setFieldValue('editCredentialType', entry.credentialType);
            setFieldValue('editCredentialValue', entry.credentialValue);
            setFieldValue('editCredentialService', entry.credentialService);
            setFieldValue('editCredentialBreachSource', entry.breachSource);
            setFieldValue('editCredentialDateFound', entry.dateFound);
            setFieldValue('editCredentialDescription', entry.description);
            setFieldValue('editCredentialNotes', entry.notes);
            setRequired('editCredentialValue', true);
            break;
        case 'forum':
            fieldsToShow = ['editForumFields'];
            setFieldValue('editForumName', entry.forumName);
            setFieldValue('editForumUrl', entry.forumUrl);
            setFieldValue('editForumType', entry.forumType);
            setFieldValue('editForumStatus', entry.forumStatus);
            setFieldValue('editForumLanguage', entry.forumLanguage);
            setFieldValue('editForumDescription', entry.description);
            setFieldValue('editForumNotes', entry.notes);
            setRequired('editForumName', true);
            setRequired('editForumUrl', true);
            break;
        case 'vendor':
            fieldsToShow = ['editVendorFields'];
            setFieldValue('editVendorAlias', entry.vendorAlias);
            setFieldValue('editVendorPlatforms', entry.vendorPlatforms);
            setFieldValue('editVendorProducts', entry.vendorProducts);
            setFieldValue('editVendorReputation', entry.vendorReputation);
            setFieldValue('editVendorDescription', entry.description);
            setFieldValue('editVendorNotes', entry.notes);
            setRequired('editVendorAlias', true);
            break;
        case 'telegram':
            fieldsToShow = ['editTelegramFields'];
            setFieldValue('editTelegramName', entry.name);
            setFieldValue('editTelegramUrl', entry.url);
            setFieldValue('editTelegramType', entry.telegramType);
            setFieldValue('editTelegramSubscribers', entry.subscribers);
            setFieldValue('editTelegramLanguage', entry.language);
            setFieldValue('editTelegramActivity', entry.activity);
            setFieldValue('editTelegramContent', entry.content);
            setFieldValue('editTelegramAdmin', entry.admin);
            setFieldValue('editTelegramTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editTelegramNotes', entry.notes);
            setRequired('editTelegramName', true);
            setRequired('editTelegramUrl', true);
            break;
        case 'paste':
            fieldsToShow = ['editPasteFields'];
            setFieldValue('editPasteUrl', entry.url);
            setFieldValue('editPasteSourceSite', entry.sourceSite);
            setFieldValue('editPasteContentSummary', entry.contentSummary);
            setFieldValue('editPasteKeywords', entry.keywords);
            setFieldValue('editPasteDescription', entry.description);
            setFieldValue('editPasteNotes', entry.notes);
            setRequired('editPasteUrl', true);
            break;
        case 'document':
            fieldsToShow = ['editDocumentFields'];
            setFieldValue('editDocumentTitle', entry.title);
            setFieldValue('editDocumentFileType', entry.fileType);
            setFieldValue('editDocumentHash', entry.hash);
            setFieldValue('editDocumentContentSummary', entry.contentSummary);
            setFieldValue('editDocumentSource', entry.source);
            setFieldValue('editDocumentDescription', entry.description);
            setFieldValue('editDocumentNotes', entry.notes);
            setRequired('editDocumentTitle', true);
            setRequired('editDocumentHash', true);
            break;
        case 'network':
            fieldsToShow = ['editNetworkFields'];
            setFieldValue('editNetworkSubject', entry.subject);
            setFieldValue('editNetworkType', entry.networkType);
            setFieldValue('editNetworkFindings', entry.findings);
            setFieldValue('editNetworkAssociated', entry.associatedIpsDomains);
            setFieldValue('editNetworkTools', entry.toolsUsed);
            setFieldValue('editNetworkDescription', entry.description);
            setFieldValue('editNetworkNotes', entry.notes);
            setRequired('editNetworkSubject', true);
            break;
        case 'metadata':
            fieldsToShow = ['editMetadataEntryFields'];
            setFieldValue('editMetadataTitle', entry.title);
            setFieldValue('editMetadataDescription', entry.description);
            setFieldValue('editMetadataFileSource', entry.fileSource);
            setFieldValue('editMetadataNotes', entry.notes);
            setRequired('editMetadataTitle', true);
            break;
        case 'archive':
            fieldsToShow = ['editArchiveFields'];
            setFieldValue('editArchiveOriginalUrl', entry.originalUrl);
            setFieldValue('editArchiveUrl', entry.url);
            setFieldValue('editArchiveService', entry.service);
            setFieldValue('editArchiveTimestamp', entry.timestamp ? new Date(entry.timestamp).toISOString().slice(0, 16) : '');
            setFieldValue('editArchiveContentSummary', entry.contentSummary);
            setFieldValue('editArchiveDescription', entry.description);
            setFieldValue('editArchiveNotes', entry.notes);
            setRequired('editArchiveOriginalUrl', true);
            setRequired('editArchiveUrl', true);
            break;
        case 'messaging':
            fieldsToShow = ['editMessagingFields'];
            setFieldValue('editMessagingApp', entry.messagingApp);
            setFieldValue('editMessagingUsername', entry.username);
            setFieldValue('editMessagingChatId', entry.chatId);
            setFieldValue('editMessagingContent', entry.content);
            setFieldValue('editMessagingDescription', entry.description);
            setFieldValue('editMessagingNotes', entry.notes);
            setRequired('editMessagingUsername', true);
            setRequired('editMessagingApp', true);
            break;
        case 'dating':
            fieldsToShow = ['editDatingFields'];
            setFieldValue('editDatingPlatform', entry.platform);
            setFieldValue('editDatingUsername', entry.username);
            setFieldValue('editDatingDisplayName', entry.displayName);
            setFieldValue('editDatingAge', entry.age);
            setFieldValue('editDatingLocation', entry.location);
            setFieldValue('editDatingPhotos', entry.photos);
            setFieldValue('editDatingBio', entry.bio);
            setFieldValue('editDatingVerified', entry.verified);
            setFieldValue('editDatingSuspicious', entry.suspicious);
            setFieldValue('editDatingNotes', entry.notes);
            setRequired('editDatingPlatform', true);
            setRequired('editDatingUsername', true);
            break;
        case 'audio':
            fieldsToShow = ['editAudioFields'];
            setFieldValue('editAudioTitle', entry.title);
            setFieldValue('editAudioFormat', entry.format);
            setFieldValue('editAudioDuration', entry.duration);
            setFieldValue('editAudioQuality', entry.quality);
            setFieldValue('editAudioLanguage', entry.language);
            setFieldValue('editAudioTranscript', entry.transcript);
            setFieldValue('editAudioSpeakers', entry.speakers);
            setFieldValue('editAudioBackground', entry.background);
            setFieldValue('editAudioTools', entry.tools);
            setFieldValue('editAudioDescription', entry.description);
            setFieldValue('editAudioNotes', entry.notes);
            setRequired('editAudioTitle', true);
            setRequired('editAudioFormat', true);
            break;
        case 'facial':
            fieldsToShow = ['editFacialFields'];
            setFieldValue('editFacialSubject', entry.subject);
            setFieldValue('editFacialSourceDescription', entry.sourceDescription);
            setFieldValue('editFacialIdentifiedProfiles', entry.identifiedProfiles);
            setFieldValue('editFacialConfidence', entry.confidence);
            setFieldValue('editFacialToolsUsed', entry.toolsUsed);
            setFieldValue('editFacialDescription', entry.description);
            setFieldValue('editFacialNotes', entry.notes);
            setRequired('editFacialSubject', true);
            break;
        case 'persona':
            fieldsToShow = ['editPersonaFields'];
            setFieldValue('editPersonaName', entry.name);
            setFieldValue('editPersonaRealName', entry.realName);
            setFieldValue('editPersonaAssociatedAccounts', entry.associatedAccounts);
            setFieldValue('editPersonaBio', entry.bio);
            setFieldValue('editPersonaPlatforms', entry.platformsUsed);
            setFieldValue('editPersonaOrigin', entry.origin);
            setFieldValue('editPersonaNotes', entry.notes);
            setRequired('editPersonaName', true);
            break;
        case 'vpn':
            fieldsToShow = ['editVpnFields'];
            setFieldValue('editVpnName', entry.name);
            setFieldValue('editVpnType', entry.vpnType);
            setFieldValue('editVpnJurisdiction', entry.jurisdiction);
            setFieldValue('editVpnLogs', entry.logs);
            setFieldValue('editVpnPayment', entry.payment);
            setFieldValue('editVpnLocations', entry.locations);
            setFieldValue('editVpnIssues', entry.issues);
            setFieldValue('editVpnUseCase', entry.useCase);
            setFieldValue('editVpnDescription', entry.description);
            setFieldValue('editVpnNotes', entry.notes);
            setRequired('editVpnName', true);
            break;
        case 'honeypot':
            fieldsToShow = ['editHoneypotFields'];
            setFieldValue('editHoneypotType', entry.honeypotType);
            setFieldValue('editHoneypotLocation', entry.location);
            setFieldValue('editHoneypotPurpose', entry.purpose);
            setFieldValue('editHoneypotDataSummary', entry.dataSummary);
            setFieldValue('editHoneypotAlerts', entry.alerts);
            setFieldValue('editHoneypotDescription', entry.description);
            setFieldValue('editHoneypotNotes', entry.notes);
            setRequired('editHoneypotType', true);
            break;
        case 'exploit':
            fieldsToShow = ['editExploitFields'];
            setFieldValue('editExploitName', entry.name);
            setFieldValue('editExploitTargetVuln', entry.targetVuln);
            setFieldValue('editExploitType', entry.exploitType);
            setFieldValue('editExploitMarketSource', entry.marketSource);
            setFieldValue('editExploitPrice', entry.price);
            setFieldValue('editExploitDescription', entry.description);
            setFieldValue('editExploitNotes', entry.notes);
            setRequired('editExploitName', true);
            break;
        case 'publicrecord':
            fieldsToShow = ['editPublicRecordFields'];
            setFieldValue('editPublicRecordType', entry.recordType);
            setFieldValue('editPublicRecordSubjectName', entry.subjectName);
            setFieldValue('editPublicRecordRefId', entry.refId);
            setFieldValue('editPublicRecordJurisdiction', entry.jurisdiction);
            setFieldValue('editPublicRecordDate', entry.date);
            setFieldValue('editPublicRecordSummary', entry.summary);
            setFieldValue('editPublicRecordSourceUrl', entry.sourceUrl);
            setFieldValue('editPublicRecordDescription', entry.description);
            setFieldValue('editPublicRecordNotes', entry.notes);
            setRequired('editPublicRecordSubjectName', true);
            setRequired('editPublicRecordType', true);
            break;
    }

    fieldsToShow.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'block';
        }
    });

    // Populate custom tab assignment checkboxes
    populateCustomTabAssignmentCheckboxes(entry.customTabs || []);

    showModal('editEntryModal');
}

        function populateIntelligenceVaultCategoriesCheckboxesEditTool(assignedCategories) {
            const container = document.getElementById('intelligenceVaultCategoriesAssignmentAddTool');
            container.style.display = 'block'; // Ensure it's visible in the edit modal

            const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesEditTool');
            checkboxesContainer.innerHTML = ''; // Clear previous checkboxes

            const intelligenceVaultCategories = [
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'emailTools', name: 'Email Tools', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Tools', icon: 'fas fa-phone' },
                { id: 'cryptoTools', name: 'Crypto Tools', icon: 'fas fa-coins' },
                { id: 'locationTools', name: 'Location Tools', icon: 'fas fa-map-marker-alt' },
                { id: 'linkTools', name: 'Link Tools', icon: 'fas fa-link' },
                { id: 'mediaTools', name: 'Media Tools', icon: 'fas fa-camera' },
                { id: 'passwordTools', name: 'Password Tools', icon: 'fas fa-key' },
                { id: 'keywordTools', name: 'Keyword Tools', icon: 'fas fa-font' },
                { id: 'socialTools', name: 'Social Tools', icon: 'fas fa-users' },
                { id: 'darkWebTools', name: 'DarkWeb Tools', icon: 'fas fa-mask' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Tools', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File/Malware Tools', icon: 'fas fa-file-code' },
                { id: 'threatIntelligenceTools', name: 'Threat Intelligence Tools', icon: 'fas fa-shield-alt' },
                { id: 'aiTools', name: 'AI Tools', icon: 'fas fa-brain' }
            ];

            intelligenceVaultCategories.forEach(category => {
                const isChecked = assignedCategories.includes(category.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) checkboxContainer.classList.add('checked');

                checkboxContainer.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="intelligence-vault-category-checkbox-edit-tool" 
                        value="${category.id}" 
                        ${isChecked ? 'checked' : ''}
                    >
                    <i class="${category.icon}" style="margin-right: 5px;"></i>
                    <span>${category.name}</span>
                `;
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Avoid attaching multiple listeners
            checkboxesContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('intelligence-vault-category-checkbox-edit-tool')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            }, 
        ); // Ensures this listener is attached only once
        }


        // Add a new metadata field row to the form
        function addMetadataField(formType, key = '', value = '') {
            const containerId = formType === 'add' ? 'customMetadataEntries' : 'editCustomMetadataEntries';
            const container = document.getElementById(containerId);
            const newRow = document.createElement('div');
            newRow.classList.add('form-group', 'metadata-entry');
            newRow.innerHTML = `
                <input type="text" class="metadata-key" name="${formType}_metadata_key_${Date.now()}" placeholder="Key" value="${key}" required>
                <input type="text" class="metadata-value" name="${formType}_metadata_value_${Date.now()}" placeholder="Value" value="${value}" required>
                <button type="button" class="remove-metadata-btn"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newRow);
        }


        // Generate a unique ID
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Show toast notifications - MODIFIED TO STACK
        function showToast(message, type = 'success', duration = 3000) {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.textContent = message;

            // Append to the container instead of body directly
            toastContainer.appendChild(toast);

            // Trigger reflow to ensure animation plays
            void toast.offsetWidth;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                // Remove toast from DOM after its exit animation
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        // Clear all filters
        function clearFilters() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot clear filters in read-only shared view.", "warning");
                return;
            }
            appState.filters.category = '';
            appState.filters.search = '';
            appState.filters.sort = 'name';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortFilter').value = 'name';
            renderIntelligenceEntries();
            showToast('Filters cleared!');
        }

        // Generate a report (mock function)
        function generateReport() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate reports in read-only shared view.", "warning");
                return;
            }
            showToast('Generating report... (Feature in development)', 'info');
            // In a real application, this would trigger a backend process or generate a downloadable file
        }

        // Export data as JSON
        function exportData() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export data in read-only shared view.", "warning");
                return;
            }
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'osintvault_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }

        // Toggle Grid/List View
        function toggleViewMode() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot change view mode in read-only shared view.", "warning");
                return;
            }
            appState.viewMode = appState.viewMode === 'grid' ? 'list' : 'grid';
            localStorage.setItem('viewMode', appState.viewMode); // Save view mode preference

            // Update text and icon for both toggle buttons
            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            const customVaultViewToggleButton = document.getElementById('customVaultViewToggle'); // NEW

            if (appState.viewMode === 'grid') {
                if (viewToggleButton) {
                    viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    viewToggleButton.title = 'Switch to List View';
                }
                if (vaultViewToggleButton) {
                    vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    vaultViewToggleButton.title = 'Switch to List View';
                }
                if (customVaultViewToggleButton) { // NEW
                    customVaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    customVaultViewToggleButton.title = 'Switch to List View';
                }
            } else {
                if (viewToggleButton) {
                    viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    viewToggleButton.title = 'Switch to Grid View';
                }
                if (vaultViewToggleButton) {
                    vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    vaultViewToggleButton.title = 'Switch to Grid View';
                }
                if (customVaultViewToggleButton) { // NEW
                    customVaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    customVaultViewToggleButton.title = 'Switch to Grid View';
                }
            }

            renderIntelligenceEntries(); // This function will now apply the correct view to the active tab's grid/list.
            showToast(`Switched to ${appState.viewMode} view.`);
        }

        // Theme Toggle
        function initTheme() {
            document.documentElement.setAttribute('data-theme', appState.theme);
            const themeToggleBtn = document.getElementById('themeToggle');
            if (appState.theme === 'dark') {
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggleBtn.title = 'Switch to Light Theme';
            } else {
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggleBtn.title = 'Switch to Dark Theme';
            }
        }

        function toggleTheme() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot change theme in read-only shared view.", "warning");
                return;
            }
            appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', appState.theme); // Save theme preference
            initTheme(); // Apply new theme
            showToast(`Switched to ${appState.theme} theme.`);
        }

        // Custom Tabs (Multi-Vault) Logic
        function renderCustomTabs() {
            const customSubTabsContainer = document.getElementById('customSubTabs');
            const createSubTabBtn = document.getElementById('createSubTabBtn');
            const editSubTabBtn = document.getElementById('editSubTabBtn');
            const deleteSubTabBtn = document.getElementById('deleteSubTabBtn');
            const exportSubTabBtn = document.getElementById('exportSubTabBtn');
            const addEntryBtnCustomVault = document.getElementById('addEntryBtnCustomVault'); // The "Add New Entry" button

            customSubTabsContainer.innerHTML = ''; // Clear existing tabs

            if (appState.customTabs.length === 0) {
                document.getElementById('emptyCustomTabState').style.display = 'block';
                document.getElementById('emptyCurrentCustomTabState').style.display = 'none';
                customSubTabsContainer.style.display = 'none';
                editSubTabBtn.style.display = 'none';
                deleteSubTabBtn.style.display = 'none';
                exportSubTabBtn.style.display = 'none';
                addEntryBtnCustomVault.style.display = 'none'; // Hide add entry button
                appState.currentCustomTab = null; // No custom tab selected
                renderIntelligenceEntries(); // Re-render to show empty state
                return;
            } else {
                document.getElementById('emptyCustomTabState').style.display = 'none';
                customSubTabsContainer.style.display = 'flex';
                editSubTabBtn.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
                deleteSubTabBtn.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
                exportSubTabBtn.style.display = 'inline-flex';
                addEntryBtnCustomVault.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
            }

            // Ensure a custom tab is selected if there are any
            if (!appState.currentCustomTab || !appState.customTabs.find(tab => tab.id === appState.currentCustomTab)) {
                appState.currentCustomTab = appState.customTabs[0].id;
            }

            appState.customTabs.forEach(tab => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('sub-nav-tab');
                if (tab.id === appState.currentCustomTab) {
                    tabButton.classList.add('active');
                    // Set active tab color
                    tabButton.style.backgroundColor = tab.color;
                    tabButton.style.color = 'white'; // Ensure text is white for contrast
                } else {
                    tabButton.style.color = 'var(--text-secondary)'; // Default text color for inactive
                }
                tabButton.dataset.subTabId = tab.id;
                tabButton.innerHTML = `<i class="${tab.icon}"></i> ${tab.name}`;
                customSubTabsContainer.appendChild(tabButton);
            });

            // Update the share options modal with custom tabs
            updateShareScopeSelect();

            renderIntelligenceEntries(); // Re-render content for the active custom tab
            saveState();
        }

        function switchCustomTab(tabId) {
            appState.currentCustomTab = tabId;

            // First, ensure parent and child entry tabs are always visible when a custom vault is selected.
            document.getElementById('customVaultEntryParentTabs').style.display = 'flex';
            document.getElementById('customVaultEntryChildTabs').style.display = 'flex'; // Assume children will be rendered

            // Re-render the vault selection tabs (the top row: My First Vault, New Vault, etc.)
            // This updates the 'active' class for the selected vault.
            renderCustomTabs();

            // Now, determine which content area should be active: the entry grid or the timeline.
            // We'll use a new appState property to remember the last active view within the custom vault.
            // Let's add `appState.customVaultViewMode: 'entries' | 'timeline'` to your appState.
            if (!appState.customVaultViewMode) {
                appState.customVaultViewMode = 'entries'; // Default view mode for custom vaults
            }

            // Hide both content areas initially
            document.getElementById('customTabToolsGrid').style.display = 'none';
            document.getElementById('customTabTimelineDisplay').style.display = 'none';

            // Hide entry-specific controls that might conflict with timeline view
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('customVaultViewToggle').style.display = 'none';
            document.getElementById('bulkActions').style.display = 'none';

            // Show appropriate content based on the stored view mode for the current vault
            if (appState.customVaultViewMode === 'timeline') {
                document.getElementById('customTabTimelineDisplay').style.display = 'block';
                document.getElementById('emptyCurrentCustomTabState').style.display = 'none'; // Ensure main empty state is off
                renderCustomVaultTimeline(); // Render timeline for the newly selected vault
            } else { // 'entries' view mode
                document.getElementById('customTabToolsGrid').style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                // Re-show relevant buttons for entry view
                if (!appState.readOnlyMode) { // Only show if not in read-only mode
                    document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                }
                document.getElementById('customVaultViewToggle').style.display = 'inline-flex';
                document.getElementById('bulkActions').style.display = appState.selectedEntries.size > 0 && !appState.readOnlyMode ? 'flex' : 'none';
                renderIntelligenceEntries(); // Re-render entries for the newly selected vault
            }

            // Ensure the parent and child tabs are rendered correctly for the new vault
            renderCustomVaultParentTabs();
            // Re-select the correct child tab based on currentCustomVaultEntrySubTab
            // This will implicitly call renderIntelligenceEntries() again, but it's safe and ensures correct filter.
            // If you always want to reset to 'tool' when switching vaults, change logic here.
            const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
            if (currentCustomParent) {
                const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                if (!currentCustomChild) {
                    appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                }
                // This will activate the correct sub-tab visually and trigger renderIntelligenceEntries if needed.
                switchCustomVaultEntrySubTab(appState.currentCustomVaultEntrySubTab);
            }


            saveState();
        }

        function showCreateSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom vaults in read-only shared view.", "warning");
                return;
            }
            document.getElementById('createSubTabForm').reset();
            document.getElementById('newSubTabIcon').value = '';
            document.getElementById('newSubTabColor').value = '';

            populateIconPicker('newSubTabIconPicker', 'newSubTabIcon');
            populateColorPicker('newSubTabColorPicker', 'newSubTabColor');
            populateNewCustomVaultToolSelection(); // Populate tools for initial assignment

            showModal('createSubTabModal');
        }

        function handleCreateSubTab(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom vaults in read-only shared view.", "warning");
                return;
            }

            const newSubTabName = document.getElementById('newSubTabName').value.trim();
            const newSubTabIcon = document.getElementById('newSubTabIcon').value.trim() || 'fas fa-folder'; // Default icon
            const newSubTabColor = document.getElementById('newSubTabColor').value.trim() || 'var(--tab-color-default)'; // Default color

            if (!newSubTabName) {
                showToast('Please enter a vault name.', 'error');
                return;
            }

            const selectedToolIds = Array.from(document.querySelectorAll('#newCustomVaultToolSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            const newCustomTab = {
                id: generateId(),
                name: newSubTabName,
                icon: newSubTabIcon,
                color: newSubTabColor,
                toolIds: selectedToolIds // Assign selected tools
            };
            appState.customTabs.push(newCustomTab);

            // Update the customTabs property of the tools themselves
            selectedToolIds.forEach(toolId => {
                const tool = appState.tools.find(t => t.id === toolId);
                if (tool && !tool.customTabs.includes(newCustomTab.id)) {
                    tool.customTabs.push(newCustomTab.id);
                }
            });

            appState.currentCustomTab = newCustomTab.id; // Switch to the newly created tab
            hideModal('createSubTabModal');
            showToast('Custom Vault created successfully!');
            renderCustomTabs();
            saveState();
        }

        function openEditSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom vaults in read-only shared view.", "warning");
                return;
            }

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to edit.', 'warning');
                return;
            }

            document.getElementById('editSubTabId').value = activeCustomTab.id;
            document.getElementById('editedSubTabName').value = activeCustomTab.name;
            document.getElementById('editedSubTabIcon').value = activeCustomTab.icon;
            document.getElementById('editedSubTabColor').value = activeCustomTab.color;

            populateIconPicker('editedSubTabIconPicker', 'editedSubTabIcon', activeCustomTab.icon);
            populateColorPicker('editedSubTabColorPicker', 'editedSubTabColor', activeCustomTab.color);
            populateEditCustomVaultToolSelection(activeCustomTab.toolIds);

            showModal('editSubTabModal');
        }

        function handleEditSubTab(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom vaults in read-only shared view.", "warning");
                return;
            }

            const editedSubTabId = document.getElementById('editSubTabId').value;
            const editedSubTabName = document.getElementById('editedSubTabName').value.trim();
            const editedSubTabIcon = document.getElementById('editedSubTabIcon').value.trim() || 'fas fa-folder';
            const editedSubTabColor = document.getElementById('editedSubTabColor').value.trim() || 'var(--tab-color-default)';

            if (!editedSubTabName) {
                showToast('Please enter a vault name.', 'error');
                return;
            }

            const tabToEdit = appState.customTabs.find(tab => tab.id === editedSubTabId);
            if (tabToEdit) {
                tabToEdit.name = editedSubTabName;
                tabToEdit.icon = editedSubTabIcon;
                tabToEdit.color = editedSubTabColor;

                const selectedToolIds = Array.from(document.querySelectorAll('#editCustomVaultToolSelection input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);

                // Update customTabs property on all entries
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    // Remove this tab's ID if it was previously assigned
                    entry.customTabs = (entry.customTabs || []).filter(tabId => tabId !== editedSubTabId);
                    // Add it back if it's currently selected for this entry
                    if (selectedToolIds.includes(entry.id)) {
                        entry.customTabs.push(editedSubTabId);
                    }
                });

                tabToEdit.toolIds = selectedToolIds; // Update the tab's toolIds array

                hideModal('editSubTabModal');
                showToast('Custom Vault updated successfully!');
                renderCustomTabs();
                saveState();
            } else {
                showToast('Error: Custom Vault not found.', 'error');
            }
        }

        function handleDeleteSubTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot delete custom vaults in read-only shared view.", "warning");
                return;
            }

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to delete.', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to delete the custom vault "${activeCustomTab.name}"? This will NOT delete the entries within it, only remove them from this vault.`)) {
                // Remove this tab's ID from all entries that had it assigned
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    entry.customTabs = (entry.customTabs || []).filter(tabId => tabId !== activeCustomTab.id);
                });

                appState.customTabs = appState.customTabs.filter(tab => tab.id !== activeCustomTab.id);
                appState.currentCustomTab = appState.customTabs.length > 0 ? appState.customTabs[0].id : null; // Select first tab or null

                showToast('Custom Vault deleted successfully!', 'error');
                renderCustomTabs();
                saveState();
            }
        }

        function exportCustomTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export custom vaults in read-only shared view.", "warning");
                return;
            }
            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to export.', 'warning');
                return;
            }

            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const entriesInCustomTab = allEntries.filter(entry => activeCustomTab.toolIds.includes(entry.id));

            const exportData = {
                vaultName: activeCustomTab.name,
                vaultIcon: activeCustomTab.icon,
                vaultColor: activeCustomTab.color,
                entries: entriesInCustomTab
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `osintvault_custom_vault_${activeCustomTab.name.replace(/\s/g, '_').toLowerCase()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Custom Vault "${activeCustomTab.name}" exported successfully!`, 'success');
        }

// Populate tool selection checkboxes for new custom vault
function populateNewCustomVaultToolSelection() {
    const container = document.getElementById('newCustomVaultToolSelection');
    container.innerHTML = ''; // Clear previous selections

    // Aggregate all entries from ALL appState arrays
    const allEntries = [
        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.audioEntries,
        ...appState.facialRecognition, ...appState.personas, ...appState.vpns, ...appState.honeypots,
        ...appState.exploits, ...appState.publicRecords
    ];

    if (allEntries.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No entries available to add.</p>';
        return;
    }

    allEntries.sort((a, b) => {
        // Use the getEntryName helper for consistent sorting
        const nameA = getEntryName(a);
        const nameB = getEntryName(b);
        return nameA.localeCompare(nameB);
    }).forEach(entry => {
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        checkboxContainer.innerHTML = `
            <input type="checkbox" class="custom-vault-tool-checkbox" value="${entry.id}">
            <i class="${getEntryIcon(entry.type)}" style="margin-right: 5px;"></i>
            <span>${getEntryName(entry)} (${entry.type})</span>
        `;
        container.appendChild(checkboxContainer);
    });
}

// Populate tool selection checkboxes for editing custom vault
function populateEditCustomVaultToolSelection(currentToolIds) {
    const container = document.getElementById('editCustomVaultToolSelection');
    container.innerHTML = ''; // Clear previous selections

    // Aggregate all entries from ALL appState arrays
    const allEntries = [
        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.audioEntries,
        ...appState.facialRecognition, ...appState.personas, ...appState.vpns, ...appState.honeypots,
        ...appState.exploits, ...appState.publicRecords
    ];

    if (allEntries.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No entries available to add.</p>';
        return;
    }

    allEntries.sort((a, b) => {
        const nameA = getEntryName(a);
        const nameB = getEntryName(b);
        return nameA.localeCompare(nameB);
    }).forEach(entry => {
        const isChecked = currentToolIds.includes(entry.id);
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        if (isChecked) {
            checkboxContainer.classList.add('checked');
        }
        checkboxContainer.innerHTML = `
            <input type="checkbox" class="custom-vault-tool-checkbox" value="${entry.id}" ${isChecked ? 'checked' : ''}>
            <i class="${getEntryIcon(entry.type)}" style="margin-right: 5px;"></i>
            <span>${getEntryName(entry)} (${entry.type})</span>
        `;
        container.appendChild(checkboxContainer);
    });
}

// NEW Helper function to get the primary display name for an entry, for sorting/listing
function getEntryName(entry) {
    switch (entry.type) {
        case 'tool': return entry.name;
        case 'email': return entry.email;
        case 'phone': return entry.number;
        case 'crypto': return entry.address;
        case 'location': return entry.name;
        case 'link': return entry.url;
        case 'media': return entry.title;
        case 'password': return entry.service;
        case 'keyword': return entry.value;
        case 'social': return entry.username;
        case 'domain': return entry.value;
        case 'username': return entry.value;
        case 'threat': return entry.name;
        case 'vulnerability': return entry.cve;
        case 'malware': return entry.filename;
        case 'breach': return entry.company;
        case 'credential': return entry.credentialService || entry.credentialValue;
        case 'forum': return entry.forumName;
        case 'vendor': return entry.vendorAlias;
        case 'telegram': return entry.name;
        case 'paste': return entry.url;
        case 'document': return entry.title;
        case 'network': return entry.subject;
        case 'metadata': return entry.title;
        case 'archive': return entry.originalUrl;
        case 'messaging': return entry.username;
        case 'dating': return entry.username;
        case 'audio': return entry.title;
        case 'facial': return entry.subject;
        case 'persona': return entry.name;
        case 'vpn': return entry.name;
        case 'honeypot': return entry.honeypotType;
        case 'exploit': return entry.name;
        case 'publicrecord': return entry.subjectName || entry.refId;
        default: return 'Unknown Entry';
    }
}

        // Populate custom tab assignment checkboxes in Edit Entry Modal
        function populateCustomTabAssignmentCheckboxes(assignedTabIds) {
            const container = document.getElementById('assignCustomTabsCheckboxes');
            container.innerHTML = ''; // Clear previous checkboxes

            if (appState.customTabs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No custom vaults created yet.</p>';
                document.getElementById('assignCustomTabs').style.display = 'none'; // Hide section if no custom tabs
                return;
            } else {
                document.getElementById('assignCustomTabs').style.display = 'block';
            }

            appState.customTabs.forEach(tab => {
                const isChecked = assignedTabIds.includes(tab.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) {
                    checkboxContainer.classList.add('checked');
                }
                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="custom-tab-assign-checkbox" value="${tab.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${tab.icon}" style="margin-right: 5px; color: ${tab.color};"></i>
                    <span>${tab.name}</span>
                `;
                container.appendChild(checkboxContainer);
            });
        }

// MODIFIED: Helper to get icon based on entry type
function getEntryIcon(type) {
    switch (type) {
        case 'tool': return 'fas fa-tools';
        case 'email': return 'fas fa-envelope';
        case 'phone': return 'fas fa-phone';
        case 'crypto': return 'fas fa-coins';
        case 'location': return 'fas fa-map-marker-alt';
        case 'link': return 'fas fa-link';
        case 'media': return 'fas fa-camera';
        case 'password': return 'fas fa-key';
        case 'keyword': return 'fas fa-font';
        case 'social': return 'fas fa-users';
        case 'domain': return 'fas fa-globe';
        case 'username': return 'fas fa-user';
        case 'threat': return 'fas fa-skull-crossbones';
        case 'vulnerability': return 'fas fa-bug';
        case 'malware': return 'fas fa-biohazard'; // Changed to biohazard for malware
        case 'breach': return 'fas fa-database';
        case 'credential': return 'fas fa-user-lock';
        case 'forum': return 'fas fa-comments';
        case 'vendor': return 'fas fa-store';
        case 'telegram': return 'fab fa-telegram-plane';
        case 'paste': return 'fas fa-paste';
        case 'document': return 'fas fa-file-alt';
        case 'network': return 'fas fa-network-wired';
        case 'metadata': return 'fas fa-info-circle';
        case 'archive': return 'fas fa-archive';
        case 'messaging': return 'fas fa-comment-dots';
        case 'dating': return 'fas fa-heart';
        case 'audio': return 'fas fa-volume-up';
        case 'facial': return 'fas fa-face-id-card';
        case 'persona': return 'fas fa-id-badge';
        case 'vpn': return 'fas fa-shield-alt';
        case 'honeypot': return 'fas fa-honey-pot';
        case 'exploit': return 'fas fa-bomb';
        case 'publicrecord': return 'fas fa-scale-balanced';
        default: return 'fas fa-question-circle';
    }
}

        // Populate icon picker grid
        function populateIconPicker(containerId, inputId, selectedIcon = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            availableIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.classList.add('icon-picker-item');
                iconItem.dataset.iconClass = iconClass;
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                if (iconClass === selectedIcon) {
                    iconItem.classList.add('selected');
                }
                container.appendChild(iconItem);
            });

            // If a selectedIcon is provided but not in availableIcons, add it as selected
            if (selectedIcon && !availableIcons.includes(selectedIcon)) {
                const customIconItem = document.createElement('div');
                customIconItem.classList.add('icon-picker-item', 'selected');
                customIconItem.dataset.iconClass = selectedIcon;
                customIconItem.innerHTML = `<i class="${selectedIcon}"></i>`;
                container.prepend(customIconItem); // Add to the beginning
            }
        }

        // Populate color picker grid
        function populateColorPicker(containerId, inputId, selectedColor = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            availableColors.forEach(colorValue => {
                const colorItem = document.createElement('div');
                colorItem.classList.add('color-picker-item');
                colorItem.dataset.colorValue = colorValue;
                colorItem.style.backgroundColor = colorValue;
                if (colorValue === selectedColor) {
                    colorItem.classList.add('selected');
                }
                container.appendChild(colorItem);
            });

            // If a selectedColor is provided but not in availableColors, add it as selected
            if (selectedColor && !availableColors.includes(selectedColor)) {
                const customColorItem = document.createElement('div');
                customColorItem.classList.add('color-picker-item', 'selected');
                customColorItem.dataset.colorValue = selectedColor;
                customColorItem.style.backgroundColor = selectedColor;
                container.prepend(customColorItem); // Add to the beginning
            }
        }

        // File reader for base64 encoding (for media entries)
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // NEW: Shareable Link Logic
        function parseShareableLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedScope = urlParams.get('scope');
            const sharedTab = urlParams.get('tab'); // Can be 'allVault', 'allData', or a custom tab ID
            const sharedIds = urlParams.get('ids'); // Comma-separated list of IDs

            if (sharedScope && sharedTab && sharedIds) {
                appState.readOnlyMode = true;
                appState.sharedTabId = sharedTab;
                appState.sharedEntryIds = sharedIds.split(',');

                showToast("You are viewing a shared, read-only version of OSINTVault. Functionality is limited.", "info", 10000);

                // Disable all input fields and buttons
                disableAllInputsAndButtons();

                // Automatically switch to the correct tab and sub-tab based on the shared link
                if (sharedTab === 'allVault' || sharedTab === 'allData') {
                    // These scopes are not direct tabs, but influence what's shown.
                    // We'll default to intelligence-vault and let renderIntelligenceEntries handle the scope.
                    switchTab('intelligence-vault');
                    appState.filters.searchScope = sharedTab; // Set the search scope
                } else if (sharedTab.startsWith('custom-')) { // Assuming custom tab IDs start with 'custom-'
                    switchTab('custom-tabs');
                    switchCustomTab(sharedTab);
                } else { // Assume it's an intelligence vault sub-tab
                    switchTab('intelligence-vault');
                    switchIntelligenceVaultSubTab(sharedTab);
                }
            }
        }

        function disableAllInputsAndButtons() {
            document.querySelectorAll('input, select, textarea, button').forEach(element => {
                if (element.id !== 'themeToggle' && element.id !== 'continueAnywayBtn' && element.id !== 'searchInput' && element.id !== 'searchScopeSelect' && !element.classList.contains('nav-tab')) {
                    element.disabled = true;
                    element.style.pointerEvents = 'none';
                    element.style.opacity = '0.7';
                }
            });
            // Specific overrides for search and main tabs
            document.getElementById('searchInput').disabled = false;
            document.getElementById('searchInput').style.pointerEvents = 'auto';
            document.getElementById('searchInput').style.opacity = '1';

            document.getElementById('searchScopeSelect').disabled = false;
            document.getElementById('searchScopeSelect').style.pointerEvents = 'auto';
            document.getElementById('searchScopeSelect').style.opacity = '1';

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.disabled = false;
                tab.style.pointerEvents = 'auto';
                tab.style.opacity = '1';
            });

            // Hide add/edit/delete buttons in custom tabs
            document.getElementById('createSubTabBtn').style.display = 'none';
            document.getElementById('editSubTabBtn').style.display = 'none';
            document.getElementById('deleteSubTabBtn').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
            document.getElementById('addToolBtnEmptyState').style.display = 'none';
            document.getElementById('new-note-btn').style.display = 'none'; // Hide new note button
            document.getElementById('edit-note-btn').style.display = 'none'; // Hide edit note button
            document.getElementById('save-note-btn').style.display = 'none'; // Hide save note button
            document.getElementById('cancel-edit-note-btn').style.display = 'none'; // Hide cancel edit note button
            document.getElementById('back-to-notes-btn').style.display = 'none'; // Hide back to notes button
            document.getElementById('formatting-toolbar').style.display = 'none'; // Hide notes formatting toolbar
            document.getElementById('tag-input-container').style.display = 'none'; // Hide notes tag input
            document.getElementById('notes-list').querySelectorAll('.note-action-btn').forEach(btn => btn.style.display = 'none'); // Hide note action buttons

            // Hide bulk actions
            document.getElementById('bulkActions').style.display = 'none';
            document.getElementById('reportBtn').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('exportSubTabBtn').style.display = 'none';
        }

        function applyReadOnlyMode() {
            if (appState.readOnlyMode) {
                disableAllInputsAndButtons();
                // Ensure specific elements are hidden or disabled if they are part of the UI but not directly covered
                document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
                document.getElementById('addEntryBtnCustomVault').style.display = 'none';
                document.getElementById('createSubTabBtn').style.display = 'none';
                document.getElementById('editSubTabBtn').style.display = 'none';
                document.getElementById('deleteSubTabBtn').style.display = 'none';
                document.getElementById('exportSubTabBtn').style.display = 'none';
                document.getElementById('bulkActions').style.display = 'none';
                document.getElementById('reportBtn').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
                document.getElementById('refreshThreatsBtn').style.display = 'none';
                document.getElementById('newRandomBtn').style.display = 'none'; // Hide random discovery button
                document.getElementById('clearFiltersBtn').style.display = 'none'; // Hide clear filters button
                document.getElementById('pinAllBtn').style.display = 'none'; // Hide pin all button
                document.getElementById('starAllBtn').style.display = 'none'; // Hide star all button
                document.getElementById('viewToggle').style.display = 'none'; // Hide view toggle
                document.getElementById('vaultViewToggle').style.display = 'none'; // Hide vault view toggle
                document.getElementById('new-note-btn').style.display = 'none'; // Hide new note button
                document.getElementById('noteSortFilter').style.display = 'none'; // Hide note sort filter
                document.getElementById('search-notes').style.display = 'none'; // Hide note search

                // Ensure notes editor is read-only
                const noteContentEditor = document.getElementById('note-content-editor');
                if (noteContentEditor) {
                    noteContentEditor.setAttribute('contenteditable', 'false');
                    noteContentEditor.style.cursor = 'default';
                }
                const noteTitleInput = document.getElementById('note-title-input');
                if (noteTitleInput) {
                    noteTitleInput.readOnly = true;
                    noteTitleInput.style.cursor = 'default';
                }
            }
        }


        function showShareOptionsModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate new shared links in read-only view.", "warning");
                return;
            }
            // Populate the dropdown with custom tabs
            updateShareScopeSelect();
            showModal('shareOptionsModal');
        }

        function updateShareScopeSelect() {
            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const selectCustomTabForSharing = document.getElementById('selectCustomTabForSharing'); // Secondary dropdown

            // Clear *only* dynamically added custom vault options from the main dropdown
            // The "Specific Custom Vault..." placeholder option should remain untouched in HTML
            for (let i = shareScopeSelect.options.length - 1; i >= 0; i--) {
                const option = shareScopeSelect.options[i];
                // Only remove options that are actual custom vault IDs, not the hardcoded ones or the placeholder
                if (option.value.startsWith('custom-')) {
                    shareScopeSelect.remove(i);
                }
            }

            // Populate the *secondary* dropdown (`selectCustomTabForSharing`)
            selectCustomTabForSharing.innerHTML = ''; // Clear existing options in the secondary dropdown

            if (appState.customTabs.length > 0) {
                // Add actual custom vaults to the secondary dropdown
                appState.customTabs.forEach(tab => {
                    const option = document.createElement('option');
                    option.value = tab.id;
                    option.textContent = `Custom Vault: ${tab.name}`;
                    selectCustomTabForSharing.appendChild(option);
                });
                selectCustomTabForSharing.disabled = false; // Enable if vaults exist
            } else {
                // If no custom vaults, add a placeholder option and disable the secondary dropdown
                const noVaultsOption = document.createElement('option');
                noVaultsOption.value = '';
                noVaultsOption.textContent = 'No custom vaults available';
                selectCustomTabForSharing.appendChild(noVaultsOption);
                selectCustomTabForSharing.disabled = true; // Disable if no vaults
            }

            // Ensure initial visibility of the secondary dropdown based on the default selected option
            handleShareScopeChange();
        }



        function handleShareScopeChange() {
            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const specificCustomTabSelectorDiv = document.getElementById('specificCustomTabSelector'); // The div containing the secondary dropdown

            // Only show the secondary dropdown if "Specific Custom Vault..." is selected
            if (shareScopeSelect.value === 'specificCustomTabPlaceholder') {
                specificCustomTabSelectorDiv.style.display = 'block';
            } else {
                specificCustomTabSelectorDiv.style.display = 'none';
            }
        }

        // Modify handleShareFormSubmit to correctly use the selected custom tab
        function handleShareFormSubmit(e) {
            e.preventDefault();
            if (appState.readOnlyMode) {
                showToast("Cannot generate new shared links in read-only view.", "warning");
                return;
            }

            const shareScope = document.getElementById('shareScopeSelect').value;
            let targetTabId = '';
            let sharedEntries = [];

            // This section needs to check the shareScopeSelect.value, NOT specificCustomTabPlaceholder
            if (shareScope === 'currentTab') {
                targetTabId = appState.currentTab;
                if (targetTabId === 'intelligence-vault') {
                    targetTabId = appState.currentIntelligenceVaultChildTab;
                    sharedEntries = filterEntries();
                } else if (targetTabId === 'custom-tabs') {
                    if (!appState.currentCustomTab) {
                        showToast('No custom vault selected in Multi-Vault to share.', 'error'); // More specific message
                        return;
                    }
                    targetTabId = appState.currentCustomTab;
                    sharedEntries = filterEntries();
                } else {
                    sharedEntries = filterEntries(); // Fallback for other tabs
                }
            } else if (shareScope === 'allVault') {
                targetTabId = 'allVault';
                // Collect all entries from Intelligence Vault
                sharedEntries = [...appState.tools]; // Only tools are in Intelligence Vault
            } else if (shareScope === 'allData') {
                targetTabId = 'allData';
                // Collect ALL entries from all appState arrays
                sharedEntries = [
                    ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
                    ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
                    ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
                    ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
                    ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
                    ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
                    ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
                    ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
                    ...appState.publicRecords
                ];
            } else if (shareScope === 'specificCustomTabPlaceholder') { // This is the trigger option for the secondary dropdown
                const selectedCustomVaultId = document.getElementById('selectCustomTabForSharing').value;
                if (!selectedCustomVaultId) {
                    showToast('Please select a specific custom vault to share.', 'error');
                    return;
                }
                targetTabId = selectedCustomVaultId;
                const customTab = appState.customTabs.find(tab => tab.id === targetTabId);
                if (customTab) {
                    // Collect all entries that belong to this specific custom tab
                    const allEntriesCombined = [
                        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
                        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
                        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
                        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
                        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
                        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
                        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
                        ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
                        ...appState.publicRecords
                    ];
                    sharedEntries = allEntriesCombined.filter(entry => (entry.customTabs || []).includes(customTab.id));
                }
            }
            // No 'else' block needed here, as the previous `else if (shareScope === 'specificCustomTab')`
            // was trying to directly use a custom tab ID as `shareScope`, which is not the intended flow.

            if (sharedEntries.length === 0) {
                showToast('No entries found to share in the selected scope. Please add entries to your vault(s).', 'warning');
                return;
            }

            const sharedIds = sharedEntries.map(entry => entry.id).join(',');
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('scope', shareScope === 'specificCustomTabPlaceholder' ? 'customTab' : shareScope); // Use 'customTab' as the scope type if the placeholder was selected
            currentUrl.searchParams.set('tab', targetTabId);
            currentUrl.searchParams.set('ids', sharedIds);

            const shareableLink = currentUrl.toString();

            // Display the link and offer to copy
            promptForCopyLink(shareableLink);
            hideModal('shareOptionsModal');
        }

        function promptForCopyLink(link) {
            const modalContent = `
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-share-alt"></i> Shareable Link Generated</h3>
                <p style="margin-bottom: 15px; color: var(--text-primary);">
                    Copy this link to share a read-only view of your selected intelligence:
                </p>
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border); word-break: break-all; margin-bottom: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;">
                    ${link}
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" id="closeShareLinkModal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyShareLinkBtn">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            `;
            const shareLinkModal = document.createElement('div');
            shareLinkModal.classList.add('modal');
            shareLinkModal.id = 'shareLinkDisplayModal';
            shareLinkModal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
            document.body.appendChild(shareLinkModal);
            showModal('shareLinkDisplayModal');

            document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
                copyToClipboard(link);
                showToast('Link copied to clipboard!');
                hideModal('shareLinkDisplayModal');
                shareLinkModal.remove();
            });

            document.getElementById('closeShareLinkModal').addEventListener('click', () => {
                hideModal('shareLinkDisplayModal');
                shareLinkModal.remove();
            });
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textarea);
        }

        // NEW: Desktop Recommendation Modal
        function checkAndShowDesktopRecommendation() {
            // Only show if not in read-only mode and hasn't been shown this session
            if (!appState.readOnlyMode && !sessionStorage.getItem('desktopRecommendationShown')) {
                if (window.innerWidth < 1024) { // Adjust breakpoint as needed
                    showModal('desktopRecommendationModal');
                }
            }
        }

        /* -------------------------------------------------------------------------- */
        /* OSINT Handbook & Notes JS                         */
        /* -------------------------------------------------------------------------- */

        // Initialize both handbook and notes
        function initHandbookAndNotes() {
            // Initialize the active subtab based on appState
            const activeSubtab = appState.currentHandbookSubTab || 'handbook';
            
            // Switch to the appropriate subtab
            switchHandbookSubtab(activeSubtab);
            
            // Initialize handbook functionality
            initHandbook();
            
            // Initialize notes functionality
            initNotes();
            }

        // Switch between Handbook and Notes subtabs
        function switchHandbookSubtab(subtabName) {
            // Store the current subtab in appState
            appState.currentHandbookSubTab = subtabName;
            
            // Update subtab buttons
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSubTabBtn = document.querySelector(`.handbook-subtab[data-subtab="${subtabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            
            // Update content containers
            document.querySelectorAll('.handbook-subtab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const targetContent = document.getElementById(`${subtabName}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // Save state
            saveState();
        }

        // Toggle mobile handbook sidebar
        function toggleHandbookSidebar() {
            const sidebar = document.getElementById('handbook-sidebar');
            const body = document.body; // Get the body element

            sidebar.classList.toggle('mobile-open');

            // Toggle a class on the body to prevent scrolling when sidebar is open
            body.classList.toggle('handbook-overlay-active', sidebar.classList.contains('mobile-open'));
            }


            // Initialize notes functionality
            function initNotes() {
            loadNotes();
            renderNotesList();
            setupNotesEventListeners();
        }

        // Load notes from localStorage
        function loadNotes() {
            const savedNotes = localStorage.getItem('osintNotes');
            if (savedNotes) {
                notesState.notes = JSON.parse(savedNotes);
                // Convert string dates back to Date objects and ensure 'pinned' exists
                notesState.notes.forEach(note => {
                note.createdAt = new Date(note.createdAt);
                note.updatedAt = new Date(note.updatedAt);
                // NEW: Ensure pinned property exists, default to false
                if (typeof note.pinned === 'undefined') {
                    note.pinned = false;
                }
                });

                // Sort notes with the new sorting logic
                sortNotes();
            }
            // NEW: Set initial value of the sort filter dropdown
            const noteSortFilterElement = document.getElementById('noteSortFilter');
            if (noteSortFilterElement) {
                noteSortFilterElement.value = notesState.noteSortFilter;
            }
        }

        // NEW/MODIFIED: Sort notes based on pinned status and selected filter
        function sortNotes() {
            const currentSort = notesState.noteSortFilter;

            notesState.notes.sort((a, b) => {
                // Pinned notes always come first
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;

                // Then apply the selected sort order
                switch (currentSort) {
                    case 'updated_desc':
                        return new Date(b.updatedAt) - new Date(a.updatedAt);
                    case 'updated_asc':
                        return new Date(a.updatedAt) - new Date(b.updatedAt);
                    case 'created_desc':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'created_asc':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'title_asc':
                        return a.title.localeCompare(b.title);
                    case 'title_desc':
                        return b.title.localeCompare(a.title);
                    default:
                        return 0; // Should not happen
                }
            });
            saveNotes(); // Save state after sorting
        }

        // Save notes to localStorage
        function saveNotes() {
            localStorage.setItem('osintNotes', JSON.stringify(notesState.notes));
        }


        // Render the notes list
        function renderNotesList() {
            const notesListContainer = document.getElementById('notes-list');
            if (!notesListContainer) return;

            if (notesState.notes.length === 0) {
                notesListContainer.innerHTML = `
                <div class="notes-empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Notes Yet</h3>
                    <p>Create your first note to get started!</p>
                </div>
                `;
                return;
            }

            // Create the grid layout for notes
            let notesHTML = '<div class="notes-grid">';

            // Notes are already sorted by sortNotes() before calling renderNotesList()
            notesState.notes.forEach(note => {
                // Get the first 5 lines of content or 150 characters, whichever is shorter
                let previewContent = note.content;

                // Remove HTML tags for the preview
                previewContent = previewContent.replace(/<[^>]*>/g, '');

                // Get the first 5 lines or 150 characters
                const lines = previewContent.split('\n').slice(0, 5).join('\n');
                previewContent = lines.length > 150 ? lines.substring(0, 147) + '...' : lines;

                const dateFormatted = formatDate(note.updatedAt);
                notesHTML += `
                        <div class="note-card ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}">
                            <div class="note-card-header">
                            <h3 class="note-title">${note.title}</h3>
                            <div class="note-actions">
                                <button class="note-action-btn pin-note ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}" title="${note.pinned ? 'Unpin Note' : 'Pin Note'}">
                                <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="note-action-btn edit-note" data-note-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete-note" data-note-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                            <div class="note-preview">${previewContent}</div>
                            <div class="note-footer">
                            <span class="note-date">Last updated: ${dateFormatted}</span>
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            </div>
                        </div>
                        `; // <--- Ensure this closing backtick is here!
                    });
                    
                    notesHTML += '</div>';
                    notesListContainer.innerHTML = notesHTML;
            // Add event listeners to note cards
            addNoteCardListeners();
        }

        // Format date in a human-readable way
        function formatDate(date) {
            const now = new Date();
            const noteDate = new Date(date);
            const diffTime = Math.abs(now - noteDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // Today, show time
                return `Today at ${noteDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (diffDays === 1) {
                // Yesterday
                return 'Yesterday';
            } else if (diffDays < 7) {
                // Within a week
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[noteDate.getDay()];
            } else {
                // Older than a week
                return noteDate.toLocaleDateString();
            }
        }


        // Add event listeners to note cards
        function addNoteCardListeners() {
            // Note card click (open note)
            document.querySelectorAll('.note-card').forEach(card => {
                card.addEventListener('click', (e) => {
                // Ignore clicks on action buttons
                if (!e.target.closest('.note-actions')) {
                    const noteId = card.dataset.noteId;
                    openNote(noteId);
                }
                });
            });

            // Edit button click (on note card in list view)
            document.querySelectorAll('.edit-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                editNote(noteId);
                });
            });

            // Delete button click (on note card in list view)
            document.querySelectorAll('.delete-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                deleteNote(noteId);
                });
            });

            // NEW: Pin button click (on note card in list view)
            document.querySelectorAll('.pin-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                togglePinNote(noteId);
                });
            });
        }

        // Setup event listeners for notes interface
        function setupNotesEventListeners() {
            // New note button
            const newNoteBtn = document.getElementById('new-note-btn');
            if (newNoteBtn) {
                newNoteBtn.addEventListener('click', createNewNote);
            }

            // Back button (from editor to list)
            const backToNotesBtn = document.getElementById('back-to-notes-btn');
            if (backToNotesBtn) {
                backToNotesBtn.addEventListener('click', () => {
                showNotesList();
                });
            }

            // Save note button
            const saveNoteBtn = document.getElementById('save-note-btn');
            if (saveNoteBtn) {
                saveNoteBtn.addEventListener('click', saveCurrentNote);
            }

            // Edit note button in editor view
            const editNoteInEditorBtn = document.getElementById('edit-note-btn');
            if (editNoteInEditorBtn) {
                editNoteInEditorBtn.addEventListener('click', () => {
                notesState.editMode = true;
                showNoteEditor();
                focusEditor();
                });
            }

            // NEW: Cancel edit button listener
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn');
            if (cancelEditNoteBtn) {
                cancelEditNoteBtn.addEventListener('click', () => {
                    // Discard changes by reverting editMode and re-showing editor (which loads original content)
                    notesState.editMode = false;
                    showNoteEditor();
                    showToast('Changes discarded.', 'info'); // Provide feedback
                });
            }

            // Search notes
            const searchNotesInput = document.getElementById('search-notes');
            if (searchNotesInput) {
                searchNotesInput.addEventListener('input', (e) => {
                searchNotes(e.target.value);
                });
            }

            // Sort notes dropdown listener
            const noteSortFilterElement = document.getElementById('noteSortFilter');
            if (noteSortFilterElement) {
                noteSortFilterElement.addEventListener('change', (e) => {
                    notesState.noteSortFilter = e.target.value;
                    localStorage.setItem('noteSortFilter', notesState.noteSortFilter);
                    sortNotes();
                    renderNotesList();
                });
            }

            // Tag input (add tags with Enter or comma)
            const tagInput = document.getElementById('note-tags-input');
            if (tagInput) {
                tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTagToCurrentNote();
                }
                });
            }

            // Add tag button
            const addTagBtn = document.getElementById('add-tag-btn');
            if (addTagBtn) {
                addTagBtn.addEventListener('click', addTagToCurrentNote);
            }
        }

        // NEW: Function to toggle pin status of a note
        function togglePinNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;

            note.pinned = !note.pinned; // Toggle the pinned status
            note.updatedAt = new Date(); // Update timestamp to re-sort if needed

            showToast(note.pinned ? 'Note pinned!' : 'Note unpinned!');

            sortNotes();      // Re-sort to bring pinned notes to top
            renderNotesList(); // Re-render to show updated pin status and order
        }


        // Create a new note
        function createNewNote() {
            const newNote = {
                id: generateNoteId(),
                title: 'Untitled Note',
                content: '',
                createdAt: new Date(),
                updatedAt: new Date(),
                tags: [],
                // NEW: Add pinned property
                pinned: false
            };

            notesState.notes.unshift(newNote);
            notesState.currentNote = newNote.id;
            notesState.editMode = true;

            saveNotes();
            showNoteEditor();
            focusEditor();
        }

        // Open a note
        function openNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesState.currentNote = noteId;
            notesState.editMode = false;
            
            showNoteEditor();
        }


        // Edit a note
        function editNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesState.currentNote = noteId;
            notesState.editMode = true;
            
            showNoteEditor();
            focusEditor();
        }

        // Delete a note
        function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            notesState.notes = notesState.notes.filter(note => note.id !== noteId);

            if (notesState.currentNote === noteId) {
                notesState.currentNote = null;
                // If current note is deleted, go back to list view which will re-render
                showNotesList(); 
            } else {
                // If a different note is deleted, just re-sort and re-render the list
                sortNotes();
                renderNotesList();
            }

            saveNotes(); // Ensure state is saved after deletion
        }

        // Show the notes list view
        function showNotesList() {
            document.getElementById('notes-list-view').style.display = 'block';
            document.getElementById('note-editor-view').style.display = 'none';
            
            renderNotesList();
        }

        // Show the note editor view
        function showNoteEditor() {
            document.getElementById('notes-list-view').style.display = 'none';
            document.getElementById('note-editor-view').style.display = 'block';

            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;

            // Set editor content
            document.getElementById('note-title-input').value = note.title;
            document.getElementById('note-content-editor').innerHTML = note.content;

            // Set read-only status based on edit mode
            document.getElementById('note-title-input').readOnly = !notesState.editMode;
            document.getElementById('note-content-editor').contentEditable = notesState.editMode;

            // Get button references
            const saveNoteBtn = document.getElementById('save-note-btn');
            const editNoteBtn = document.getElementById('edit-note-btn');
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn'); // NEW reference
            const tagInputContainer = document.getElementById('tag-input-container');
            const formattingToolbar = document.getElementById('formatting-toolbar');

            // Show/hide appropriate buttons and elements based on editMode
            if (notesState.editMode) {
                saveNoteBtn.style.display = 'inline-flex';
                cancelEditNoteBtn.style.display = 'inline-flex'; // NEW: Show cancel button in edit mode
                editNoteBtn.style.display = 'none';
                tagInputContainer.style.display = 'flex';
                formattingToolbar.style.display = 'flex';
            } else {
                saveNoteBtn.style.display = 'none';
                cancelEditNoteBtn.style.display = 'none'; // NEW: Hide cancel button in preview mode
                editNoteBtn.style.display = 'inline-flex';
                tagInputContainer.style.display = 'none';
                formattingToolbar.style.display = 'none';
            }

            // Render tags
            renderNoteTags();

            // If in edit mode, setup the rich text editor (only needed once, but safe to call)
            if (notesState.editMode) {
                setupRichTextEditor();
            }
        }


        // Render the tags for the current note
        function renderNoteTags() {
            const tagsContainer = document.getElementById('note-tags-container');
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            
            if (!note) return;
            
            tagsContainer.innerHTML = note.tags.map(tag => `
                <div class="note-tag">
                <span>${tag}</span>
                ${notesState.editMode ? `<button class="remove-tag-btn" data-tag="${tag}"><i class="fas fa-times"></i></button>` : ''}
                </div>
            `).join('');
            
            // Add event listeners to remove tag buttons
            if (notesState.editMode) {
                document.querySelectorAll('.remove-tag-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tagToRemove = btn.dataset.tag;
                    removeTagFromCurrentNote(tagToRemove);
                });
                });
            }
        }


        // Add a tag to the current note
        function addTagToCurrentNote() {
            const tagInput = document.getElementById('note-tags-input');
            const tagValue = tagInput.value.trim();
            
            if (!tagValue) return;
            
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;
            
            // Don't add duplicate tags
            if (!note.tags.includes(tagValue)) {
                note.tags.push(tagValue);
                note.updatedAt = new Date();
                saveNotes();
                renderNoteTags();
            }
            
            // Clear the input
            tagInput.value = '';
        }

        // Remove a tag from the current note
        function removeTagFromCurrentNote(tag) {
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;
            
            note.tags = note.tags.filter(t => t !== tag);
            note.updatedAt = new Date();
            saveNotes();
            renderNoteTags();
        }

        // Save the current note
        function saveCurrentNote() {
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;

            // NEW: Confirmation dialog
            if (!confirm('Are you sure you want to save changes to this note?')) {
                showToast('Save cancelled.', 'info'); // User clicked cancel
                return;
            }

            note.title = document.getElementById('note-title-input').value || 'Untitled Note';
            note.content = document.getElementById('note-content-editor').innerHTML;
            note.updatedAt = new Date(); // Update timestamp on save

            saveNotes();
            sortNotes(); // Re-sort notes after saving to reflect new updatedAt/pinned status

            // Switch to view mode
            notesState.editMode = false;
            showNoteEditor(); // Show editor in read-only mode

            // Show success message
            showToast('Note saved successfully!');
        }



        // Search notes by title, content, or tags
        function searchNotes(searchTerm) {
            searchTerm = searchTerm.toLowerCase();

            const filteredNotes = notesState.notes.filter(note => {
                const titleMatch = note.title.toLowerCase().includes(searchTerm);
                const contentMatch = note.content.toLowerCase().includes(searchTerm);
                const tagMatch = note.tags.some(tag => tag.toLowerCase().includes(searchTerm));

                return titleMatch || contentMatch || tagMatch;
            });

            const notesListContainer = document.getElementById('notes-list');

            // NEW: Apply sorting to filtered notes before rendering
            // Temporarily set notesState.notes to filteredNotes for sorting, then revert
            const originalNotes = notesState.notes;
            notesState.notes = filteredNotes;
            sortNotes(); // Sorts the (temporarily) filtered array
            const sortedFilteredNotes = notesState.notes;
            notesState.notes = originalNotes; // Revert to original full notes array

            if (sortedFilteredNotes.length === 0) {
                notesListContainer.innerHTML = `
                <div class="notes-empty-state">
                    <i class="fas fa-search"></i>
                    <h3>No matching notes found</h3>
                    <p>Try a different search term</p>
                </div>
                `;
                return;
            }

            // Create the grid layout for filtered notes
            let notesHTML = '<div class="notes-grid">';

            sortedFilteredNotes.forEach(note => {
                // Get the first 5 lines of content or 150 characters, whichever is shorter
                let previewContent = note.content;

                // Remove HTML tags for the preview
                previewContent = previewContent.replace(/<[^>]*>/g, '');

                // Get the first 5 lines or 150 characters
                const lines = previewContent.split('\n').slice(0, 5).join('\n');
                previewContent = lines.length > 150 ? lines.substring(0, 147) + '...' : lines;

                const dateFormatted = formatDate(note.updatedAt);

                notesHTML += `
                        <div class="note-card ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}">
                            <div class="note-card-header">
                            <h3 class="note-title">${note.title}</h3>
                            <div class="note-actions">
                                <button class="note-action-btn pin-note ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}" title="${note.pinned ? 'Unpin Note' : 'Pin Note'}">
                                <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="note-action-btn edit-note" data-note-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete-note" data-note-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                            <div class="note-preview">${previewContent}</div>
                            <div class="note-footer">
                            <span class="note-date">${dateFormatted}</span>
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            </div>
                        </div>
                        `; // <--- Ensure this closing backtick is here!
                    });
                    
                    notesHTML += '</div>';
                    notesListContainer.innerHTML = notesHTML;
            
            // Add event listeners to note cards (these will be for the filtered set)
            addNoteCardListeners();

            // If no search term, re-render full list with original sort
            if (!searchTerm) {
                renderNotesList();
            }
        }

        // Setup rich text editor
        function setupRichTextEditor() {
            const editor = document.getElementById('note-content-editor');
            const toolbar = document.getElementById('formatting-toolbar');
            
            // Make sure we have both elements
            if (!editor || !toolbar) return;
            
            // Add command handling for toolbar buttons
            toolbar.querySelectorAll('.formatting-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                const command = btn.dataset.command;
                const value = btn.dataset.value || null;
                
                if (command === 'createLink') {
                    const url = prompt('Enter the URL:');
                    if (url) {
                    document.execCommand(command, false, url);
                    }
                } else if (command === 'formatBlock') {
                    document.execCommand(command, false, value);
                } else {
                    document.execCommand(command, false, value);
                }
                
                editor.focus();
                });
            });
        }

        // Focus the editor
        function focusEditor() {
        setTimeout(() => {
            const titleInput = document.getElementById('note-title-input');
            if (titleInput) {
            titleInput.focus();
            titleInput.select();
            }
        }, 100);
        }



        // Render the handbook sidebar and initialize content
        function initHandbook() {
        const handbookSidebar = document.getElementById('handbook-sidebar');
        if (!handbookSidebar) return;

        // Render the sidebar
        renderHandbookSidebar();
        
        // Show the first section by default
        if (handbookData.sections.length > 0) {
            const firstSection = handbookData.sections[0];
            showHandbookSection(firstSection.id);
        }
        
        // Load saved user notes
        loadUserNotes();
        }

        // Render the handbook sidebar navigation
        function renderHandbookSidebar() {
        const sidebar = document.getElementById('handbook-sidebar');
        let sidebarHTML = '';
        
        handbookData.sections.forEach(section => {
            if (section.isCategory) {
            // This is a category with subcategories
            sidebarHTML += `
                <div class="handbook-category">
                <div class="handbook-category-header" data-category="${section.id}">
                    <i class="${section.icon}"></i>
                    <span>${section.title}</span>
                    <i class="fas fa-chevron-down category-toggle"></i>
                </div>
                <div class="handbook-subcategories" id="${section.id}-subcategories">
            `;
            
            section.subcategories.forEach(subcategory => {
                sidebarHTML += `
                <div class="handbook-nav-item" data-section="${subcategory.id}">
                    <i class="${subcategory.icon}"></i>
                    <span>${subcategory.title}</span>
                </div>
                `;
            });
            
            sidebarHTML += `
                </div>
                </div>
            `;
            } else {
            // This is a standalone section
            sidebarHTML += `
                <div class="handbook-nav-item" data-section="${section.id}">
                <i class="${section.icon}"></i>
                <span>${section.title}</span>
                </div>
            `;
            }
        });
        
        sidebar.innerHTML = sidebarHTML;
        
        // Add event listeners for sidebar navigation
        addHandbookSidebarListeners();
        }

        // Add event listeners to the handbook sidebar
        function addHandbookSidebarListeners() {
        // Category headers toggle
        document.querySelectorAll('.handbook-category-header').forEach(header => {
            header.addEventListener('click', () => {
            const categoryId = header.dataset.category;
            const subcategoriesEl = document.getElementById(`${categoryId}-subcategories`);
            
            // Toggle the subcategories visibility
            if (subcategoriesEl.style.maxHeight) {
                subcategoriesEl.style.maxHeight = null;
                header.querySelector('.category-toggle').classList.remove('rotate');
            } else {
                subcategoriesEl.style.maxHeight = subcategoriesEl.scrollHeight + "px";
                header.querySelector('.category-toggle').classList.add('rotate');
            }
            });
        });
        
        // Section item clicks
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            item.addEventListener('click', () => {
            const sectionId = item.dataset.section;
            showHandbookSection(sectionId);
            
            // Update active state
            document.querySelectorAll('.handbook-nav-item').forEach(i => {
                i.classList.remove('active');
            });
            item.classList.add('active');
            
            // If on mobile, close the sidebar
            if (window.innerWidth < 768) {
                document.getElementById('handbook-sidebar').classList.remove('mobile-open');
            }
            });
        });
        
        // Search input
        const searchInput = document.getElementById('handbook-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterHandbookSidebar(searchTerm);
            });
        }
        }

        // Filter the handbook sidebar based on search term
        function filterHandbookSidebar(searchTerm) {
        if (!searchTerm) {
            // Reset visibility
            document.querySelectorAll('.handbook-nav-item, .handbook-category').forEach(item => {
            item.style.display = 'flex';
            });
            document.querySelectorAll('.handbook-subcategories').forEach(sub => {
            sub.style.maxHeight = null;
            });
            return;
        }
        
        // Hide all items initially
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            const sectionId = item.dataset.section;
            
            // Find the matching section data
            let sectionData = null;
            handbookData.sections.forEach(section => {
            if (section.id === sectionId) {
                sectionData = section;
            } else if (section.isCategory && section.subcategories) {
                const subcat = section.subcategories.find(sub => sub.id === sectionId);
                if (subcat) sectionData = subcat;
            }
            });
            
            if (sectionData) {
            const titleMatch = sectionData.title.toLowerCase().includes(searchTerm);
            const contentMatch = sectionData.content && sectionData.content.toLowerCase().includes(searchTerm);
            
            if (titleMatch || contentMatch) {
                item.style.display = 'flex';
                
                // If it's in a subcategory, show the parent category and expand it
                const parentCategory = item.closest('.handbook-subcategories');
                if (parentCategory) {
                const categoryId = parentCategory.id.replace('-subcategories', '');
                const categoryHeader = document.querySelector(`.handbook-category-header[data-category="${categoryId}"]`);
                const categoryContainer = categoryHeader.closest('.handbook-category');
                
                categoryContainer.style.display = 'block';
                parentCategory.style.maxHeight = parentCategory.scrollHeight + "px";
                categoryHeader.querySelector('.category-toggle').classList.add('rotate');
                }
            } else {
                item.style.display = 'none';
            }
            }
        });
        
        // Hide empty categories
        document.querySelectorAll('.handbook-category').forEach(category => {
            const visibleItems = category.querySelectorAll('.handbook-nav-item[style="display: flex;"]');
            if (visibleItems.length === 0) {
            category.style.display = 'none';
            } else {
            category.style.display = 'block';
            }
        });
        }

        // Show a specific handbook section
        function showHandbookSection(sectionId) {
            const contentContainer = document.getElementById('handbook-article-area'); // Use the corrected unique ID
            if (!contentContainer) return;

            // Find the section data (this part of your code remains the same)
            let sectionData = null;
            handbookData.sections.forEach(section => {
                if (section.id === sectionId) {
                    sectionData = section;
                } else if (section.isCategory && section.subcategories) {
                    const subcat = section.subcategories.find(sub => sub.id === sectionId);
                    if (subcat) sectionData = subcat;
                }
            });

            if (!sectionData) return;

            // Set the content (this creates the new textarea elements)
            contentContainer.innerHTML = sectionData.content;

            // Add copy button functionality for code blocks (this part of your code remains the same)
            contentContainer.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const codeBlock = btn.parentElement.querySelector('code');
                    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                });
            });

            // Add event listeners for ALL user notes textareas within the newly added content
            contentContainer.querySelectorAll('textarea[id^="notes-"]').forEach(textarea => {
                // Load initial value from localStorage
                const savedNote = localStorage.getItem(textarea.id);
                if (savedNote) {
                    textarea.value = savedNote;
                }
                // Add listener for saving on input
                textarea.addEventListener('input', (e) => {
                    localStorage.setItem(e.target.id, e.target.value);
                });
            });
        }

        // Load user notes from localStorage
        function loadUserNotes() {
        document.querySelectorAll('textarea[id^="notes-"]').forEach(textarea => {
            const savedNote = localStorage.getItem(textarea.id);
            if (savedNote) {
            textarea.value = savedNote;
            }
        });
        }

        // Toggle the mobile sidebar
        function toggleHandbookSidebar() {
        const sidebar = document.getElementById('handbook-sidebar');
        sidebar.classList.toggle('mobile-open');
        }

        // Enhanced OSINT Handbook functionality
        document.addEventListener('DOMContentLoaded', () => {
        // Initialize handbook features when loaded
        initHandbookFeatures();
        });

        function initHandbookFeatures() {
        // Add section management buttons to handbook content container
        addHandbookControls();
        
        // Enhance search functionality
        enhanceHandbookSearch();
        
        // Initialize editor for section content
        initSectionEditor();
        }

        function addHandbookControls() {
        const handbookContent = document.querySelector('.handbook-content-container');
        if (!handbookContent) return;
        
        // Create handbook controls container
        const controlsHtml = `
            <div class="handbook-controls">
            <button id="add-section-btn" class="btn btn-primary handbook-btn">
                <i class="fas fa-plus"></i> Add New Section
            </button>
            <button id="edit-section-btn" class="btn btn-secondary handbook-btn" style="display: none;">
                <i class="fas fa-edit"></i> Edit Section
            </button>
            <button id="delete-section-btn" class="btn btn-danger handbook-btn" style="display: none;">
                <i class="fas fa-trash"></i> Delete Section
            </button>
            </div>
        `;
        
        // Insert controls before the content area
        handbookContent.insertAdjacentHTML('afterbegin', controlsHtml);
        
        // Add event listeners
        document.getElementById('add-section-btn').addEventListener('click', openAddSectionModal);
        document.getElementById('edit-section-btn').addEventListener('click', openEditSectionModal);
        document.getElementById('delete-section-btn').addEventListener('click', confirmDeleteSection);
        }

        function enhanceHandbookSearch() {
        const searchInput = document.getElementById('handbook-search');
        if (!searchInput) return;
        
        // Clear any existing listeners to avoid duplicates
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Add enhanced search functionality
        newSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
            // Reset search if term is too short
            document.querySelectorAll('.handbook-nav-item, .handbook-category').forEach(item => {
                item.style.display = 'flex';
            });
            document.querySelectorAll('.handbook-content mark').forEach(mark => {
                const text = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(text, mark);
            });
            return;
            }
            
            // Search both titles and content
            searchHandbookSections(searchTerm);
            
            // Highlight matches in current content
            highlightContentMatches(searchTerm);
        });
        
        // Add search icon click handler to clear search
        const searchIcon = document.querySelector('.handbook-search-icon');
        if (searchIcon) {
            searchIcon.style.cursor = 'pointer';
            searchIcon.addEventListener('click', () => {
            newSearchInput.value = '';
            newSearchInput.dispatchEvent(new Event('input'));
            newSearchInput.focus();
            });
        }
        }

        function searchHandbookSections(searchTerm) {
        let matchFound = false;
        
        // Search through all sections
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            const sectionId = item.dataset.section;
            let sectionData = findSectionById(sectionId);
            
            if (sectionData) {
            const titleMatch = sectionData.title.toLowerCase().includes(searchTerm);
            const contentMatch = sectionData.content && sectionData.content.toLowerCase().includes(searchTerm);
            
            if (titleMatch || contentMatch) {
                item.style.display = 'flex';
                matchFound = true;
                
                // Highlight the matching item
                item.classList.add('search-highlight');
                
                // Expand parent category if in a subcategory
                const parentSubcategories = item.closest('.handbook-subcategories');
                if (parentSubcategories) {
                const categoryId = parentSubcategories.id.replace('-subcategories', '');
                const categoryHeader = document.querySelector(`.handbook-category-header[data-category="${categoryId}"]`);
                
                if (categoryHeader) {
                    categoryHeader.closest('.handbook-category').style.display = 'block';
                    parentSubcategories.style.maxHeight = parentSubcategories.scrollHeight + "px";
                    categoryHeader.querySelector('.category-toggle').classList.add('rotate');
                }
                }
            } else {
                item.style.display = 'none';
                item.classList.remove('search-highlight');
            }
            }
        });
        
        // Show "no results" message if no matches
        const noResultsEl = document.getElementById('handbook-search-no-results');
        if (!matchFound) {
            if (!noResultsEl) {
            const searchContainer = document.querySelector('.handbook-search-container');
            if (searchContainer) {
                searchContainer.insertAdjacentHTML('afterend', `
                <div id="handbook-search-no-results" class="handbook-no-results">
                    <i class="fas fa-search"></i>
                    <p>No results found for "${searchTerm}"</p>
                </div>
                `);
            }
            } else {
            noResultsEl.style.display = 'block';
            noResultsEl.querySelector('p').textContent = `No results found for "${searchTerm}"`;
            }
        } else if (noResultsEl) {
            noResultsEl.style.display = 'none';
        }
        }

        function highlightContentMatches(searchTerm) {
        // Remove existing highlights
        const contentArea = document.getElementById('handbook-article-area');
        if (!contentArea) return;
        
        // First, remove existing highlights
        const highlighted = contentArea.innerHTML;
        const cleaned = highlighted.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
        contentArea.innerHTML = cleaned;
        
        // Don't highlight if search term is too short
        if (searchTerm.length < 2) return;
        
        // Then add new highlights
        const contentNodes = Array.from(contentArea.querySelectorAll('p, h2, h3, h4, li, code'));
        
        contentNodes.forEach(node => {
            const originalText = node.innerHTML;
            if (!originalText.includes('<mark class="search-highlight">')) {
            const newText = originalText.replace(
                new RegExp(searchTerm, 'gi'),
                match => `<mark class="search-highlight">${match}</mark>`
            );
            if (originalText !== newText) {
                node.innerHTML = newText;
            }
            }
        });
        }

        function findSectionById(sectionId) {
        // Look through handbookData to find the section
        let foundSection = null;
        
        handbookData.sections.forEach(section => {
            if (section.id === sectionId) {
            foundSection = section;
            } else if (section.isCategory && section.subcategories) {
            section.subcategories.forEach(subsection => {
                if (subsection.id === sectionId) {
                foundSection = subsection;
                }
            });
            }
        });
        
        return foundSection;
        }

        function openAddSectionModal() {
        // Check if modal already exists
        let modal = document.getElementById('section-editor-modal');
        if (!modal) {
            // Create modal if it doesn't exist
            modal = createSectionEditorModal();
            document.body.appendChild(modal);
        }
        
        // Reset form
        document.getElementById('section-editor-form').reset();
        document.getElementById('section-editor-title').textContent = 'Add New Section';
        document.getElementById('section-id').value = generateSectionId();
        document.getElementById('section-parent').value = '';
        document.getElementById('section-editor-content').innerHTML = '';
        
        // Show parent category selector and icon selector
        document.getElementById('section-parent-group').style.display = 'block';
        document.getElementById('section-icon-group').style.display = 'block';
        
        // Populate parent category select
        populateParentCategorySelect();
        
        // Show the modal
        modal.classList.add('show');
        }

        function openEditSectionModal() {
        // Get current section ID
        const currentSectionId = getCurrentSectionId();
        if (!currentSectionId) {
            showToast('Please select a section to edit', 'warning');
            return;
        }
        
        const sectionData = findSectionById(currentSectionId);
        if (!sectionData) {
            showToast('Section not found', 'error');
            return;
        }
        
        // Create or get modal
        let modal = document.getElementById('section-editor-modal');
        if (!modal) {
            modal = createSectionEditorModal();
            document.body.appendChild(modal);
        }
        
        // Set form values
        document.getElementById('section-editor-title').textContent = 'Edit Section';
        document.getElementById('section-id').value = sectionData.id;
        document.getElementById('section-title').value = sectionData.title;
        document.getElementById('section-icon').value = sectionData.icon || 'fas fa-book';
        document.getElementById('section-editor-content').innerHTML = sectionData.content;
        
        // Hide parent category selector for editing (can't change parent)
        document.getElementById('section-parent-group').style.display = 'none';
        
        // Show the modal
        modal.classList.add('show');
        }

        function confirmDeleteSection() {
        // Get current section ID
        const currentSectionId = getCurrentSectionId();
        if (!currentSectionId) {
            showToast('Please select a section to delete', 'warning');
            return;
        }
        
        const sectionData = findSectionById(currentSectionId);
        if (!sectionData) {
            showToast('Section not found', 'error');
            return;
        }
        
        // Ask for confirmation
        if (confirm(`Are you sure you want to delete the section "${sectionData.title}"?`)) {
            deleteSection(currentSectionId);
        }
        }

        function deleteSection(sectionId) {
        // Find and remove the section from handbookData
        let deleted = false;
        
        // Check top-level sections
        handbookData.sections = handbookData.sections.filter(section => {
            if (section.id === sectionId) {
            deleted = true;
            return false; // Remove this section
            }
            
            // Check subcategories if it's a category
            if (section.isCategory && section.subcategories) {
            section.subcategories = section.subcategories.filter(subsection => {
                if (subsection.id === sectionId) {
                deleted = true;
                return false; // Remove this subsection
                }
                return true;
            });
            }
            
            return true;
        });
        
        if (deleted) {
            // Re-render handbook sidebar and show first section
            renderHandbookSidebar();
            if (handbookData.sections.length > 0) {
            const firstSection = handbookData.sections[0];
            if (firstSection.isCategory && firstSection.subcategories && firstSection.subcategories.length > 0) {
                showHandbookSection(firstSection.subcategories[0].id);
            } else {
                showHandbookSection(firstSection.id);
            }
            }
            
            // Save to localStorage
            saveHandbookData();
            showToast('Section deleted successfully', 'success');
        } else {
            showToast('Failed to delete section', 'error');
        }
        }

        function createSectionEditorModal() {
        const modal = document.createElement('div');
        modal.id = 'section-editor-modal';
        modal.className = 'modal';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
            <h3 id="section-editor-title" style="margin-bottom: 20px; color: var(--primary);">Add New Section</h3>

            <form id="section-editor-form">
                <input type="hidden" id="section-id">

                <div class="form-group">
                <label for="section-title">Section Title</label>
                <input type="text" id="section-title" required placeholder="Enter section title">
                </div>

                <div class="form-group" id="section-parent-group">
                <label for="section-parent">Parent Category</label>
                <select id="section-parent">
                    <option value="">None (Top-level section)</option>
                </select>
                </div>

                <div class="form-group" id="section-icon-group">
                <label for="section-icon">Section Icon</label>
                <input type="text" id="section-icon" placeholder="e.g., fas fa-book" value="fas fa-book">
                <div class="icon-picker-grid" id="section-icon-picker"></div>
                </div>

                <div class="form-group">
                <label for="section-editor-content">Content</label>
                <div class="formatting-toolbar">
                    <button type="button" class="formatting-btn" data-command="bold" title="Bold">
                    <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="italic" title="Italic">
                    <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                    <i class="fas fa-heading"></i>2
                    </button>
                    <button type="button" class="formatting-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                    <i class="fas fa-heading"></i>3
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                    <i class="fas fa-list-ul"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                    <i class="fas fa-list-ol"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="createLink" title="Insert Link">
                    <i class="fas fa-link"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertHTML" data-value="code-block" title="Insert Code Block">
                    <i class="fas fa-code"></i>
                    </button>
                </div>
                <div id="section-editor-content" class="note-content-editor" contenteditable="true"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" id="cancel-section-edit">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Section</button>
                </div>
            </form>
            </div>
        `;

        document.body.appendChild(modal); // Append the modal to the DOM first

        // Now that the modal is in the DOM, you can safely populate the icon picker
        populateIconPicker('section-icon-picker');

        // Add event listeners
        modal.querySelector('#cancel-section-edit').addEventListener('click', () => {
            modal.classList.remove('show');
        });

        modal.querySelector('#section-editor-form').addEventListener('submit', (e) => {
            e.preventDefault();
            saveSection();
        });

        // Add click outside to close
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
            modal.classList.remove('show');
            }
        });

        return modal;
        }

        function populateParentCategorySelect() {
        const parentSelect = document.getElementById('section-parent');
        
        // Clear existing options except the first one
        while (parentSelect.options.length > 1) {
            parentSelect.remove(1);
        }
        
        // Add category options
        handbookData.sections.forEach(section => {
            if (section.isCategory) {
            const option = document.createElement('option');
            option.value = section.id;
            option.textContent = section.title;
            parentSelect.appendChild(option);
            }
        });
        }

        function initSectionEditor() {
        // Set up editor toolbar functionality
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.formatting-btn');
            if (!btn) return;
            
            const command = btn.dataset.command;
            const value = btn.dataset.value || null;
            const editor = document.getElementById('section-editor-content');
            
            if (!editor) return;
            
            if (command === 'createLink') {
            const url = prompt('Enter the URL:');
            if (url) {
                document.execCommand(command, false, url);
            }
            } else if (command === 'insertHTML' && value === 'code-block') {
            // Insert a code block
            const codeContent = prompt('Enter code content:');
            if (codeContent) {
                const codeBlockHtml = `
                <div class="code-block">
                    <pre><code>${escapeHtml(codeContent)}</code></pre>
                    <button class="copy-btn" data-clipboard-target="#code-${Date.now()}"><i class="fas fa-copy"></i></button>
                </div>
                `;
                document.execCommand('insertHTML', false, codeBlockHtml);
            }
            } else if (command === 'formatBlock') {
            document.execCommand(command, false, value);
            } else {
            document.execCommand(command, false, value);
            }
        });
        
        // Add icon picker functionality
        document.addEventListener('click', (e) => {
            const iconItem = e.target.closest('.icon-picker-item');
            if (!iconItem) return;
            
            const iconPicker = iconItem.closest('.icon-picker-grid');
            if (!iconPicker) return;
            
            // Remove selected class from all icons
            iconPicker.querySelectorAll('.icon-picker-item').forEach(item => {
            item.classList.remove('selected');
            });
            
            // Add selected class to clicked icon
            iconItem.classList.add('selected');
            
            // Update input value
            const iconInput = document.getElementById('section-icon');
            if (iconInput) {
            iconInput.value = iconItem.dataset.iconClass;
            }
        });
        }

        function saveSection() {
        const sectionId = document.getElementById('section-id').value;
        const sectionTitle = document.getElementById('section-title').value;
        const sectionParent = document.getElementById('section-parent').value;
        const sectionIcon = document.getElementById('section-icon').value;
        const sectionContent = document.getElementById('section-editor-content').innerHTML;
        
        // Validate required fields
        if (!sectionTitle) {
            showToast('Section title is required', 'error');
            return;
        }
        
        // Check if editing existing section or adding new one
        const existingSection = findSectionById(sectionId);
        
        if (existingSection) {
            // Update existing section
            existingSection.title = sectionTitle;
            existingSection.icon = sectionIcon;
            existingSection.content = sectionContent;
        } else {
            // Create new section
            const newSection = {
            id: sectionId,
            title: sectionTitle,
            icon: sectionIcon,
            content: sectionContent
            };
            
            if (sectionParent) {
            // Add as subcategory to parent
            const parentCategory = handbookData.sections.find(section => section.id === sectionParent);
            if (parentCategory) {
                // Ensure parent is a category with subcategories array
                if (!parentCategory.isCategory) {
                parentCategory.isCategory = true;
                }
                if (!parentCategory.subcategories) {
                parentCategory.subcategories = [];
                }
                parentCategory.subcategories.push(newSection);
            }
            } else {
            // Add as top-level section
            handbookData.sections.push(newSection);
            }
        }
        
        // Save changes and update UI
        saveHandbookData();
        renderHandbookSidebar();
        showHandbookSection(sectionId);
        
        // Hide modal
        const modal = document.getElementById('section-editor-modal');
        if (modal) {
            modal.classList.remove('show');
        }
        
        showToast('Section saved successfully', 'success');
        }

        function saveHandbookData() {
        // Save to localStorage
        localStorage.setItem('osintHandbookData', JSON.stringify(handbookData));
        }

        function getCurrentSectionId() {
        // Get the currently active section
        const activeNavItem = document.querySelector('.handbook-nav-item.active');
        return activeNavItem ? activeNavItem.dataset.section : null;
        }

        function generateSectionId() {
        // Generate a unique section ID
        return 'section-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
        }

        // Update the showHandbookSection function to handle section management buttons
        const originalShowHandbookSection = showHandbookSection;
        showHandbookSection = function(sectionId) {
        // Call the original function
        originalShowHandbookSection(sectionId);
        
        // Update edit/delete buttons visibility
        const editSectionBtn = document.getElementById('edit-section-btn');
        const deleteSectionBtn = document.getElementById('delete-section-btn');
        
        if (editSectionBtn && deleteSectionBtn) {
            const sectionData = findSectionById(sectionId);
            if (sectionData) {
            editSectionBtn.style.display = 'inline-flex';
            deleteSectionBtn.style.display = 'inline-flex';
            } else {
            editSectionBtn.style.display = 'none';
            deleteSectionBtn.style.display = 'none';
            }
        }
        };

        // Helper function to get week number (ISO week date standard)
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // Initialize handbook and notes functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize handbook functionality
            initHandbook();
            
            // Initialize notes functionality
            initNotes();
            
            // Add event listeners for handbook/notes subtabs
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const subtab = e.target.dataset.subtab;
                    switchHandbookSubtab(subtab);
                });
            });
        });

        /* -------------------------------------------------------------------------- */
        /* Dork Assistant JS                                                          */
        /* -------------------------------------------------------------------------- */

        const dorkAssistantState = {
            keywords: '',
            customInput: '',
            engine: 'google',
            previewQuery: '',
            convertedQuery: '',
            currentDorkSubTab: 'query-playground',
            savedQueries: [],
            savedQuerySearchTerm: '',
            currentTemplateCategory: 'All Templates', // New: Track active template category
            preTemplateSearchTerm: '',
            conversionJustPerformed: false  // New: Search term for pre-templates
        };

        const dorkTemplates = {
            "General OSINT": [{
                id: 'exposed_docs',
                name: 'Exposed Documents',
                description: 'Finds publicly accessible PDF, DOCX, or XLSX files containing sensitive terms.',
                keywords: '',
                custom: 'filetype:pdf OR filetype:docx OR filetype:xlsx confidential OR secret',
                engine: 'google'
            }, {
                id: 'login_pages',
                name: 'Admin Login Pages',
                description: 'Discovers common admin login interfaces.',
                keywords: '',
                custom: 'intitle:"Login" inurl:admin OR inurl:auth',
                engine: 'google'
            }, {
                id: 'sensitive_files',
                name: 'Sensitive Filetypes',
                description: 'Identifies configuration files, database backups, or environment files.',
                keywords: '',
                custom: 'inurl:config OR inurl:backup OR inurl:db filetype:sql OR filetype:env',
                engine: 'google'
            }, {
                id: 'pastebin_search',
                name: 'Pastebin Leaks',
                description: 'Searches Pastebin for common sensitive terms or patterns indicating leaks.',
                keywords: 'site:pastebin.com',
                custom: 'password OR "api key" OR "private key"',
                engine: 'google'
            }],
            "IoT / Devices": [{
                id: 'webcams',
                name: 'Open Webcams',
                description: 'Locates publicly accessible webcams and live streams.',
                keywords: '',
                custom: 'intitle:"webcamXP" OR intitle:"live view" inurl:viewerframe.html',
                engine: 'google'
            }, {
                id: 'printers',
                name: 'Network Printers',
                description: 'Finds network-connected printers accessible via web interfaces.',
                keywords: '',
                custom: 'intitle:"printer" inurl:web/guest/en/websys/status/view.htm',
                engine: 'google'
            }, {
                id: 'routers_modems',
                name: 'Router/Modem Interfaces',
                description: 'Discovers common router or modem login pages.',
                keywords: 'intitle:"router setup" OR intitle:"modem config"',
                custom: 'inurl:setup.cgi OR inurl:main.html',
                engine: 'google'
            }],
            "Social Media": [{
                id: 'linkedin_profiles',
                name: 'LinkedIn Profiles',
                description: 'Searches for LinkedIn profiles by job title or keywords within the profile.',
                keywords: '"site:linkedin.com/in"',
                custom: '',
                engine: 'google'
            }, {
                id: 'twitter_emails',
                name: 'Twitter User Emails',
                description: 'Attempts to find email addresses mentioned in public Twitter profiles or tweets.',
                keywords: '"site:twitter.com" "email"',
                custom: '',
                engine: 'google'
            }, {
                id: 'facebook_public',
                name: 'Facebook Public Posts',
                description: 'Searches public Facebook posts for specific terms (limited by Facebook privacy).',
                keywords: 'site:facebook.com/posts',
                custom: '',
                engine: 'google'
            }],
            "Database / Server": [{
                id: 'sql_errors',
                name: 'SQL Injection Errors',
                description: 'Detects common database error messages that may indicate SQL injection vulnerabilities.',
                keywords: '',
                custom: 'intext:"SQL syntax" OR intext:"mysql_fetch_array" OR intext:"Warning: mysql_connect()"',
                engine: 'google'
            }, {
                id: 'phpmyadmin',
                name: 'phpMyAdmin Panels',
                description: 'Discovers publicly accessible phpMyAdmin database management interfaces.',
                keywords: '',
                custom: 'inurl:phpmyadmin intitle:"phpMyAdmin"',
                engine: 'google'
            }, {
                id: 'database_config',
                name: 'Database Config Files',
                description: 'Finds exposed database configuration files that might contain credentials.',
                keywords: 'filetype:sql OR filetype:conf',
                custom: 'intext:"password" OR "username" "database"',
                engine: 'google'
            }],
             "Vulnerability Research": [{
                id: 'cve_poc',
                name: 'CVE PoC/Exploits',
                description: 'Searches for Proof-of-Concept code or exploits related to specific CVEs.',
                keywords: 'github.com',
                custom: 'CVE-202X-XXXXX "PoC" OR "exploit"',
                engine: 'google'
            }, {
                id: 'exploitdb_search',
                name: 'Exploit-DB Search',
                description: 'Finds exploits listed on Exploit-DB for specific software or versions.',
                keywords: 'site:exploit-db.com',
                custom: 'apache OR nginx',
                engine: 'google'
            }],
            "File / Document Analysis": [{
                id: 'git_config',
                name: 'Git Config Files',
                description: 'Discovers exposed Git configuration files that might contain sensitive information.',
                keywords: 'inurl:.git/config',
                custom: '',
                engine: 'google'
            }, {
                id: 'log_files',
                name: 'Exposed Log Files',
                description: 'Identifies publicly accessible server log files.',
                keywords: 'inurl:access.log OR inurl:error.log',
                custom: '',
                engine: 'google'
            }],
            "Network Intelligence": [{
                id: 'open_ports_shodan',
                name: 'Shodan: Open Ports',
                description: 'Shodan query to find hosts with specific open ports (e.g., 22, 80, 443).',
                keywords: '',
                custom: 'port:22 OR port:80 OR port:443',
                engine: 'shodan'
            }, {
                id: 'c2_servers_shodan',
                name: 'Shodan: C2 Servers',
                description: 'Shodan query to identify potential Command and Control servers.',
                keywords: '',
                custom: 'tag:c2 OR "command and control"',
                engine: 'shodan'
            }, {
                id: 'self_signed_certs_censys',
                name: 'Censys: Self-Signed Certs',
                description: 'Censys query to find hosts using self-signed SSL certificates, often found on internal systems.',
                keywords: '',
                custom: 'services.tls.certificates.leaf_data.basic_constraints.is_ca: true and services.tls.certificates.chain.length: 1',
                engine: 'censys'
            }]
        };

        function initDorkAssistant() {
            loadSavedQueries(); // Load saved queries at init
            bindDorkAssistantEvents();
            switchDorkSubTab(dorkAssistantState.currentDorkSubTab); // Show correct sub-tab on load
            updateDorkQueryPreview(); // Initial preview for Playground

        }

        // MODIFIED: bindDorkAssistantEvents
        function bindDorkAssistantEvents() {
            // Sub-tab navigation
            document.querySelectorAll('.dork-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchDorkSubTab(e.target.dataset.dorkSubtab);
                });
            });

            // Save Query Modal events - Use 'onclick' for direct assignment to avoid duplicates
            const cancelSaveDorkQueryBtn = document.getElementById('cancelSaveDorkQuery');
            if (cancelSaveDorkQueryBtn) {
                cancelSaveDorkQueryBtn.onclick = () => { // Directly assign onclick
                    hideModal('saveDorkQueryModal');
                };
            }
            const saveDorkQueryForm = document.getElementById('saveDorkQueryForm');
            if (saveDorkQueryForm) {
                saveDorkQueryForm.addEventListener('submit', handleSaveDorkQuery);
            }

            // Warning Modal Events - Attach these directly via ID for clarity and robustness.
            // They are assumed to be present in the HTML from the start, though hidden.
            const convertAndGoToPlaygroundBtn = document.getElementById('convertAndGoToPlayground');
            if (convertAndGoToPlaygroundBtn) {
                convertAndGoToPlaygroundBtn.onclick = () => { // Directly assign onclick
                    const currentQuery = document.getElementById('dorkWarningModal').dataset.tempQuery;
                    const targetEngine = document.getElementById('dorkWarningModal').dataset.tempEngine;

                    if (!currentQuery || !targetEngine) {
                        showToast('Error: Missing query or engine for conversion.', "error");
                        return;
                    }

                    const convertedQuery = convertToShodanCensys(currentQuery, targetEngine);

                    document.getElementById('editExecuteTemplateQuery').value = convertedQuery;
                    document.getElementById('editExecuteTemplateEngine').value = targetEngine;

                    // NEW: Set the flag when conversion is initiated from the warning modal
                    dorkAssistantState.conversionJustPerformed = true;
                    saveDorkAssistantState(); // Persist the flag

                    hideModal('dorkWarningModal');
                    showToast(`Query converted to ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)} in the editor!`, 'info', 3000);
                };
            }

            const cancelDorkWarningBtn = document.getElementById('cancelDorkWarning');
            if (cancelDorkWarningBtn) {
                cancelDorkWarningBtn.onclick = () => { // Directly assign onclick
                    hideModal('dorkWarningModal');
                    showToast('Execution cancelled by user.', 'info');
                    // Keep the edit modal open if user cancelled warning
                };
            }

            const continueDorkExecutionBtn = document.getElementById('continueDorkExecution');
            if (continueDorkExecutionBtn) {
                continueDorkExecutionBtn.onclick = () => { // Directly assign onclick
                    const query = document.getElementById('dorkWarningModal').dataset.tempQuery;
                    const engine = document.getElementById('dorkWarningModal').dataset.tempEngine;

                    if (!query || !engine) {
                        showToast('Error: Missing query or engine for execution.', 'error');
                        return;
                    }

                    hideModal('dorkWarningModal');     // Hide warning modal
                    hideModal('editExecuteTemplateModal'); // Hide edit modal (as we are now executing)
                    executeDorkQuery(query, engine); // Execute with stored values
                };
            }

            // Query Playground events
            document.getElementById('dorkKeywords').addEventListener('input', updateDorkAssistantState);
            document.getElementById('dorkCustomInput').addEventListener('input', updateDorkAssistantState);
            document.getElementById('dorkEngineSelect').addEventListener('change', updateDorkAssistantState);
            document.querySelectorAll('.dork-operator-btn').forEach(button => {
                button.addEventListener('click', handleOperatorButtonClick);
            });
            document.getElementById('executeDorkBtn').addEventListener('click', () => executeDorkQuery());
            document.getElementById('clearDorkBuilderBtn').addEventListener('click', clearDorkBuilder);

            const convertDorkBtn = document.getElementById('convertDorkBtn');
            if (convertDorkBtn) {
                convertDorkBtn.addEventListener('click', convertDorkQuery);
            }

            const executeConvertedDorkBtn = document.getElementById('executeConvertedDorkBtn');
            if (executeConvertedDorkBtn) {
                executeConvertedDorkBtn.addEventListener('click', () => {
                    const convertedQuery = document.getElementById('convertedDorkPreview').value;
                    const targetEngine = document.getElementById('conversionTarget').value;
                    if (convertedQuery && targetEngine) {
                        executeDorkQuery(convertedQuery, targetEngine);
                    } else {
                        showToast('No converted query or target engine selected.', "warning");
                    }
                });
            }

            const conversionTargetSelect = document.getElementById('conversionTarget');
            if (conversionTargetSelect) {
                conversionTargetSelect.addEventListener('change', () => {
                    const convertedDorkPreview = document.getElementById('convertedDorkPreview');
                    const executeConvertedDorkBtn = document.getElementById('executeConvertedDorkBtn');

                    if (convertedDorkPreview) convertedDorkPreview.value = ''; // Clear content
                    if (convertedDorkPreview) convertedDorkPreview.style.display = 'none'; // Hide preview
                    if (executeConvertedDorkBtn) executeConvertedDorkBtn.style.display = 'none'; // Hide button
                });
            }

            const saveCurrentDorkBtn = document.getElementById('saveCurrentDorkBtn');
            if (saveCurrentDorkBtn) {
                saveCurrentDorkBtn.addEventListener('click', openSaveDorkQueryModal);
            }

            // Pre-Templates events
            const preTemplateCategoriesList = document.getElementById('preTemplateCategoriesList');
            if (preTemplateCategoriesList) {
                preTemplateCategoriesList.addEventListener('click', (e) => {
                    const categoryItem = e.target.closest('.category-item');
                    if (categoryItem) {
                        dorkAssistantState.currentTemplateCategory = categoryItem.dataset.category;
                        renderPreTemplates(); // Re-render templates for new category
                    }
                });
            }

            const preTemplateSearchInput = document.getElementById('preTemplateSearchInput');
            if (preTemplateSearchInput) {
                let preTemplateSearchTimeout; // Declare this here
                preTemplateSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value;
                    clearTimeout(preTemplateSearchTimeout);
                    preTemplateSearchTimeout = setTimeout(() => {
                        dorkAssistantState.preTemplateSearchTerm = searchTerm;
                        renderPreTemplates();
                    }, 300);
                });
            }

            const clearPreTemplateSearchBtn = document.getElementById('clearPreTemplateSearch');
            if (clearPreTemplateSearchBtn) {
                clearPreTemplateSearchBtn.addEventListener('click', () => {
                    dorkAssistantState.preTemplateSearchTerm = '';
                    const preTemplateSearchInput = document.getElementById('preTemplateSearchInput');
                    if (preTemplateSearchInput) preTemplateSearchInput.value = '';
                    renderPreTemplates();
                });
            }

            const dorkTemplatesList = document.getElementById('dorkTemplatesList');
            if (dorkTemplatesList) {
                dorkTemplatesList.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;

                    const templateId = btn.dataset.templateId;
                    if (btn.classList.contains('apply-template-btn')) {
                        applySelectedTemplate(templateId);
                    } else if (btn.classList.contains('execute-template-btn')) {
                        executeTemplateQuery(templateId);
                    } else if (btn.classList.contains('edit-execute-template-btn')) {
                        openEditExecuteTemplateModal(templateId);
                    }
                });
            }

            const cancelEditExecuteTemplateBtn = document.getElementById('cancelEditExecuteTemplate');
            if (cancelEditExecuteTemplateBtn) {
                cancelEditExecuteTemplateBtn.addEventListener('click', () => hideModal('editExecuteTemplateModal'));
            }

            const editExecuteTemplateForm = document.getElementById('editExecuteTemplateForm');
            if (editExecuteTemplateForm) {
                editExecuteTemplateForm.addEventListener('submit', handleEditExecuteTemplate);
            }

            const editExecuteTemplateEngineSelect = document.getElementById('editExecuteTemplateEngine');
            if (editExecuteTemplateEngineSelect) {
                editExecuteTemplateEngineSelect.addEventListener('change', () => {
                    const selectedEngine = editExecuteTemplateEngineSelect.value;
                    const conversionSection = document.getElementById('editExecuteConversionSection');
                    const performConversionBtn = document.getElementById('performEditExecuteConversionBtn');

                    if (conversionSection) { // Ensure element exists
                        if (selectedEngine === 'shodan' || selectedEngine === 'censys') {
                            conversionSection.style.display = 'block';
                            if (performConversionBtn) { // Ensure button exists
                                performConversionBtn.textContent = `Convert to ${selectedEngine.charAt(0).toUpperCase() + selectedEngine.slice(1)}`;
                            }
                        } else {
                            conversionSection.style.display = 'none';
                        }
                    }
                });
            }

            const performEditExecuteConversionBtn = document.getElementById('performEditExecuteConversionBtn');
            if (performEditExecuteConversionBtn) {
                performEditExecuteConversionBtn.addEventListener('click', () => {
                    const currentQueryInput = document.getElementById('editExecuteTemplateQuery');
                    const currentQuery = currentQueryInput.value.trim();
                    const targetEngine = document.getElementById('editExecuteTemplateEngine').value;

                    if (!currentQuery) {
                        showToast('No query to convert.', "warning");
                        return;
                    }
                    if (!(targetEngine === 'shodan' || targetEngine === 'censys')) {
                        showToast('Select Shodan or Censys as the target engine to convert.', "warning");
                        return;
                    }

                    const convertedQuery = convertToShodanCensys(currentQuery, targetEngine);
                    currentQueryInput.value = convertedQuery;
                    showToast(`Query converted for ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)}!`, 'success');

                    // NEW: Set the flag here
                    dorkAssistantState.conversionJustPerformed = true;
                    saveDorkAssistantState(); // Persist the flag

                    // Hide the conversion section after conversion
                    const conversionSection = document.getElementById('editExecuteConversionSection');
                    if (conversionSection) conversionSection.style.display = 'none';
                });
            }

            // Saved Queries events
            const savedQueriesSearchInput = document.getElementById('savedQueriesSearch');
            if (savedQueriesSearchInput) {
                savedQueriesSearchInput.addEventListener('input', (e) => {
                    dorkAssistantState.savedQuerySearchTerm = e.target.value;
                    renderSavedQueries();
                });
            }

            const clearSavedQueriesSearchBtn = document.getElementById('clearSavedQueriesSearch');
            if (clearSavedQueriesSearchBtn) {
                clearSavedQueriesSearchBtn.addEventListener('click', () => {
                    document.getElementById('savedQueriesSearch').value = '';
                    dorkAssistantState.savedQuerySearchTerm = '';
                    renderSavedQueries();
                });
            }

            const savedQueriesList = document.getElementById('savedQueriesList');
            if (savedQueriesList) {
                savedQueriesList.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;

                    const queryId = btn.dataset.queryId;
                    if (btn.classList.contains('load-query-btn')) {
                        loadSavedQueryToPlayground(queryId);
                    } else if (btn.classList.contains('execute-saved-query-btn')) {
                        executeSavedQuery(queryId);
                    } else if (btn.classList.contains('delete-saved-query-btn')) {
                        deleteSavedQuery(queryId);
                    }
                });
            }
        }

        // MODIFIED: switchDorkSubTab (Reset flag if navigating away from query playground)
        function switchDorkSubTab(subtabName) {
            dorkAssistantState.currentDorkSubTab = subtabName;

            document.querySelectorAll('.dork-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.dork-subtab[data-dork-subtab="${subtabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }

            document.querySelectorAll('.dork-subtab-content').forEach(content => {
                content.style.display = 'none';
            });
            const targetContent = document.getElementById(`${subtabName}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }

            // NEW: Reset conversion flag if leaving 'query-playground'
            if (subtabName !== 'query-playground') {
                dorkAssistantState.conversionJustPerformed = false;
                saveDorkAssistantState();
            }

            // Render content specific to the sub-tab
            if (subtabName === 'pre-templates') {
                renderPreTemplates();
            } else if (subtabName === 'saved-queries') {
                renderSavedQueries();
            }
            saveDorkAssistantState();
        }

        function updateDorkAssistantState() {
            dorkAssistantState.keywords = document.getElementById('dorkKeywords').value.trim();
            dorkAssistantState.customInput = document.getElementById('dorkCustomInput').value.trim();
            dorkAssistantState.engine = document.getElementById('dorkEngineSelect').value;
            updateDorkQueryPreview();
            saveDorkAssistantState();
        }

        function handleOperatorButtonClick(event) {
            const operator = event.target.dataset.operator;
            const customInputEl = document.getElementById('dorkCustomInput');
            let currentInput = customInputEl.value.trim();

            if (currentInput && !currentInput.endsWith(' ') && !operator.startsWith(':') && !operator.startsWith('-') && operator !== 'OR' && operator !== 'AND') {
                currentInput += ' '; // Add space if not an affix operator or boolean
            }
            customInputEl.value = currentInput + operator;
            updateDorkAssistantState(); // Update and regenerate preview
        }

        function updateDorkQueryPreview() {
            let queryParts = [];

            // Add keywords
            const keywords = dorkAssistantState.keywords.split(',').map(k => k.trim()).filter(k => k);
            if (keywords.length > 0) {
                queryParts.push(keywords.map(k => {
                    // Automatically quote multi-word keywords unless already quoted
                    return k.includes(' ') && !k.startsWith('"') && !k.startsWith('site:') && !k.startsWith('filetype:') && !k.startsWith('intitle:') && !k.startsWith('inurl:') && !k.startsWith('intext:') && !k.startsWith('related:') && !k.startsWith('cache:') ? `"${k}"` : k;
                }).join(' '));
            }

            // Add custom input
            if (dorkAssistantState.customInput) {
                queryParts.push(dorkAssistantState.customInput);
            }

            let finalQuery = queryParts.join(' ').trim();

            document.getElementById('dorkQueryPreview').value = finalQuery;
            dorkAssistantState.previewQuery = finalQuery;
        }

        function executeDorkQuery(queryToExecute = null, engineToUse = null) {
            const query = queryToExecute || dorkAssistantState.previewQuery;
            const engine = engineToUse || dorkAssistantState.engine;

            if (!query) {
                showToast('Query is empty. Please build a query or select a template/saved query first.', 'warning');
                return;
            }

            let searchUrl = '';
            switch (engine) {
                case 'google':
                    searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    break;
                case 'duckduckgo':
                    searchUrl = `https://duckduckgo.com/?q=${encodeURIComponent(query)}`;
                    break;
                case 'bing':
                    searchUrl = `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
                    break;
                case 'yandex':
                    searchUrl = `https://yandex.com/search/?text=${encodeURIComponent(query)}`;
                    break;
                case 'shodan':
                    searchUrl = `https://www.shodan.io/search?query=${encodeURIComponent(query)}`;
                    break;
                case 'censys':
                    searchUrl = `https://search.censys.io/search?query=${encodeURIComponent(query)}&resource=hosts`;
                    break;
                default:
                    showToast('Unsupported search engine selected for execution.', 'error');
                    return;
            }

            window.open(searchUrl, '_blank');
            showToast(`Executing query on ${engine.charAt(0).toUpperCase() + engine.slice(1)}...`);
        }

        function clearDorkBuilder() {
            document.getElementById('dorkKeywords').value = '';
            document.getElementById('dorkCustomInput').value = '';
            document.getElementById('dorkEngineSelect').value = 'google';
            document.getElementById('convertedDorkPreview').style.display = 'none';
            dorkAssistantState.keywords = '';
            dorkAssistantState.customInput = '';
            dorkAssistantState.engine = 'google';
            updateDorkQueryPreview();
            showToast('Query Playground cleared!');
            saveDorkAssistantState();
        }

        function convertDorkQuery(targetEngineOverride = null) { // Modified signature
            const originalQuery = dorkAssistantState.previewQuery;
            const targetEngine = targetEngineOverride || document.getElementById('conversionTarget').value; // Use override if provided, else get from dropdown
            const convertedPreviewEl = document.getElementById('convertedDorkPreview');

            if (!originalQuery) {
                showToast('No query to convert. Please build a query first.', 'warning');
                return;
            }
            if (!targetEngine) { // This check should now rarely fail if override is used
                showToast('Please select a target engine for conversion.', 'warning');
                return;
            }

            const convertedQuery = convertToShodanCensys(originalQuery, targetEngine);
            convertedPreviewEl.value = convertedQuery;
            convertedPreviewEl.style.display = 'block'; // Ensure preview is shown
            document.getElementById('executeConvertedDorkBtn').style.display = 'block'; // Ensure button is shown
            dorkAssistantState.convertedQuery = convertedQuery; // Update state
            showToast(`Query converted for ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)}!`, 'success');
        }

        function convertToShodanCensys(query, targetEngine) {
            let converted = query;

            // Step 1: Normalize common Google-like operators to a intermediate format
            converted = converted.replace(/site:([^\s]+)/gi, 'HOST:$1');
            converted = converted.replace(/intitle:"([^"]+)"/gi, 'TITLE:"$1"');
            converted = converted.replace(/intitle:([^\s]+)/gi, 'TITLE:$1');
            converted = converted.replace(/inurl:([^\s]+)/gi, 'URL:$1');
            converted = converted.replace(/intext:"([^"]+)"/gi, 'BODY:"$1"');
            converted = converted.replace(/intext:([^\s]+)/gi, 'BODY:$1');
            converted = converted.replace(/filetype:([^\s]+)/gi, 'FILETYPE:$1');

            // Step 2: Convert intermediate format to target engine specific syntax
            if (targetEngine === 'shodan') {
                converted = converted.replace(/HOST:/gi, 'hostname:');
                converted = converted.replace(/TITLE:/gi, 'title:');
                converted = converted.replace(/URL:/gi, '443.url:'); // Common Shodan URL field
                converted = converted.replace(/BODY:/gi, 'http.html:'); // Basic Shodan HTTP body search
                converted = converted.replace(/FILETYPE:(pdf|docx|xlsx)/gi, 'http.content_type:$1'); // Basic Shodan content type
                // Add common Shodan filters based on keywords/patterns
                if (query.toLowerCase().includes('webcam') || query.toLowerCase().includes('camera')) {
                    converted += ' port:8080 OR port:80 OR port:443 webcam';
                }
                if (query.toLowerCase().includes('printer')) {
                    converted += ' product:printer';
                }
                if (query.toLowerCase().includes('apache')) {
                    converted += ' product:apache';
                }
                if (query.toLowerCase().includes('nginx')) {
                    converted += ' product:nginx';
                }
            } else if (targetEngine === 'censys') {
                converted = converted.replace(/HOST:/gi, 'services.dns.names:'); // More accurate for Censys
                converted = converted.replace(/TITLE:/gi, 'services.http.response.html.title:');
                converted = converted.replace(/URL:/gi, 'services.http.response.request.url:');
                converted = converted.replace(/BODY:/gi, 'services.http.response.html.body:');
                converted = converted.replace(/FILETYPE:(pdf|docx|xlsx)/gi, 'services.http.response.headers.content_type:$1');
                // Add common Censys filters based on keywords/patterns
                if (query.toLowerCase().includes('webcam') || query.toLowerCase().includes('camera')) {
                    converted += ' services.http.tags:webcam';
                }
                if (query.toLowerCase().includes('printer')) {
                    converted += ' services.fingerprint.product:printer';
                }
                if (query.toLowerCase().includes('apache')) {
                    converted += ' services.http.metadata.product:Apache';
                }
            }

            // Remove any leftover intermediate tags if no conversion was applicable
            converted = converted.replace(/HOST:/gi, '');
            converted = converted.replace(/TITLE:/gi, '');
            converted = converted.replace(/URL:/gi, '');
            converted = converted.replace(/BODY:/gi, '');
            converted = converted.replace(/FILETYPE:/gi, '');

            // Clean up multiple spaces and trim
            return converted.replace(/\s+/g, ' ').trim();
        }

        // MODIFIED: renderPreTemplates (to ensure event listeners are re-attached)
        function renderPreTemplates() {
            const templatesList = document.getElementById('dorkTemplatesList');
            const preTemplatesEmptyState = document.getElementById('preTemplatesEmptyState');
            const categoriesListContainer = document.getElementById('preTemplateCategoriesList');
            const categoriesEmptyState = document.getElementById('preTemplateCategoriesEmptyState');
            const currentTemplateCategoryTitle = document.getElementById('currentTemplateCategoryTitle');
            const preTemplateSearchInput = document.getElementById('preTemplateSearchInput');

            templatesList.innerHTML = ''; // Clear previous templates
            categoriesListContainer.innerHTML = ''; // Clear previous categories

            const categories = Object.keys(dorkTemplates);

            if (categories.length === 0) {
                categoriesEmptyState.style.display = 'block';
                templatesList.style.display = 'none';
                preTemplatesEmptyState.style.display = 'none';
                return;
            }

            categoriesEmptyState.style.display = 'none';
            templatesList.style.display = 'grid';
            preTemplatesEmptyState.style.display = 'none'; // Initially hide template empty state

            // Render Categories Sidebar
            let allTemplatesCount = 0;
            // Add "All Templates" category first
            const allCategoryItem = document.createElement('div');
            allCategoryItem.classList.add('category-item');
            allCategoryItem.dataset.category = 'All Templates';
            allCategoryItem.innerHTML = `<i class="fas fa-layer-group"></i> <span>All Templates</span> <span class="template-count">0</span>`;
            categoriesListContainer.appendChild(allCategoryItem);

            categories.forEach(categoryName => {
                const categoryTemplates = dorkTemplates[categoryName] || [];
                allTemplatesCount += categoryTemplates.length;

                const categoryItem = document.createElement('div');
                categoryItem.classList.add('category-item');
                categoryItem.dataset.category = categoryName;
                categoryItem.innerHTML = `<i class="fas fa-folder-open"></i> <span>${categoryName}</span> <span class="template-count">${categoryTemplates.length}</span>`;
                categoriesListContainer.appendChild(categoryItem);
            });

            // Update All Templates count
            const allCountSpan = allCategoryItem.querySelector('.template-count');
            if (allCountSpan) {
                allCountSpan.textContent = allTemplatesCount;
            }

            // Set active category in sidebar
            document.querySelectorAll('#preTemplateCategoriesList .category-item').forEach(item => {
                if (item.dataset.category === dorkAssistantState.currentTemplateCategory) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Set main content title
            currentTemplateCategoryTitle.textContent = dorkAssistantState.currentTemplateCategory;

            // Apply search term to input
            preTemplateSearchInput.value = dorkAssistantState.preTemplateSearchTerm;

            // Filter templates based on selected category and search term
            let templatesToRender = [];
            if (dorkAssistantState.currentTemplateCategory === 'All Templates') {
                Object.values(dorkTemplates).forEach(templateArray => {
                    templatesToRender = templatesToRender.concat(templateArray);
                });
            } else {
                templatesToRender = dorkTemplates[dorkAssistantState.currentTemplateCategory] || [];
            }

            if (dorkAssistantState.preTemplateSearchTerm) {
                const searchTerm = dorkAssistantState.preTemplateSearchTerm.toLowerCase();
                templatesToRender = templatesToRender.filter(template => {
                    const fullQuery = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`;
                    return template.name.toLowerCase().includes(searchTerm) ||
                           template.description.toLowerCase().includes(searchTerm) ||
                           fullQuery.toLowerCase().includes(searchTerm) ||
                           template.engine.toLowerCase().includes(searchTerm);
                });
            }

            // Sort templates alphabetically by name
            templatesToRender.sort((a, b) => a.name.localeCompare(b.name));

            if (templatesToRender.length === 0) {
                preTemplatesEmptyState.style.display = 'block';
                templatesList.style.display = 'none';
            } else {
                preTemplatesEmptyState.style.display = 'none';
                templatesList.style.display = 'grid';
                templatesToRender.forEach(template => {
                    const fullQuery = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`;
                    templatesList.innerHTML += `
                        <div class="dork-template-card" data-template-id="${template.id}">
                            <div class="template-header">
                                <span>${template.name}</span>
                                <span class="template-engine">${template.engine.charAt(0).toUpperCase() + template.engine.slice(1)}</span>
                            </div>
                            <div class="template-query">${fullQuery.trim()}</div>
                            <div class="template-description">${template.description}</div>
                            <div class="template-actions">
                                <button class="btn btn-primary btn-sm apply-template-btn" data-template-id="${template.id}">
                                    <i class="fas fa-magic"></i> Apply
                                </button>
                                <button class="btn btn-secondary btn-sm execute-template-btn" data-template-id="${template.id}">
                                    <i class="fas fa-play"></i> Execute
                                </button>
                                <button class="btn btn-secondary btn-sm edit-execute-template-btn" data-template-id="${template.id}">
                                    <i class="fas fa-edit"></i> Edit & Run
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            // NEW: Re-attach event listeners for dynamic buttons after rendering
            document.querySelectorAll('#preTemplateCategoriesList .category-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    dorkAssistantState.currentTemplateCategory = e.currentTarget.dataset.category;
                    renderPreTemplates(); // Re-render templates for new category
                });
            });

            // Debounce for pre-template search input
            let preTemplateSearchTimeout; // Declare this
            const preTemplateSearchInputElement = document.getElementById('preTemplateSearchInput'); // Get reference
            if (preTemplateSearchInputElement) { // Safety check
                preTemplateSearchInputElement.addEventListener('input', (e) => {
                    const searchTerm = e.target.value;
                    clearTimeout(preTemplateSearchTimeout);
                    preTemplateSearchTimeout = setTimeout(() => {
                        dorkAssistantState.preTemplateSearchTerm = searchTerm;
                        renderPreTemplates();
                    }, 300);
                });
            }


            const clearPreTemplateSearchButton = document.getElementById('clearPreTemplateSearch'); // Get reference
            if (clearPreTemplateSearchButton) { // Safety check
                clearPreTemplateSearchButton.addEventListener('click', () => {
                    dorkAssistantState.preTemplateSearchTerm = '';
                    const preTemplateSearchInputElement = document.getElementById('preTemplateSearchInput');
                    if (preTemplateSearchInputElement) { // Safety check
                        preTemplateSearchInputElement.value = '';
                    }
                    renderPreTemplates();
                });
            }


            // IMPORTANT: ATTACH LISTENERS TO THE NEWLY RENDERED BUTTONS
            document.querySelectorAll('.apply-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.dataset.templateId;
                    applySelectedTemplate(templateId);
                });
            });
            document.querySelectorAll('.execute-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.dataset.templateId;
                    executeTemplateQuery(templateId);
                });
            });
            document.querySelectorAll('.edit-execute-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.dataset.templateId;
                    openEditExecuteTemplateModal(templateId);
                });
            });

            // Edit/Execute Template Modal events
            document.getElementById('cancelEditExecuteTemplate').addEventListener('click', () => hideModal('editExecuteTemplateModal'));
            document.getElementById('editExecuteTemplateForm').addEventListener('submit', handleEditExecuteTemplate);

            const editExecuteTemplateEngineElement = document.getElementById('editExecuteTemplateEngine');
            if (editExecuteTemplateEngineElement) { // Safety check
                editExecuteTemplateEngineElement.addEventListener('change', () => {
                    const selectedEngine = editExecuteTemplateEngineElement.value;
                    const conversionSection = document.getElementById('editExecuteConversionSection');

                    if (conversionSection) { // Safety check for conversionSection
                        if (selectedEngine === 'shodan' || selectedEngine === 'censys') {
                            conversionSection.style.display = 'block';
                        } else {
                            conversionSection.style.display = 'none';
                        }
                    }
                });
            }

            const performEditExecuteConversionButton = document.getElementById('performEditExecuteConversionBtn');
            if (performEditExecuteConversionButton) { // Safety check
                performEditExecuteConversionButton.addEventListener('click', () => {
                    const currentQueryInput = document.getElementById('editExecuteTemplateQuery');
                    const currentQuery = currentQueryInput.value.trim();
                    const targetEngine = document.getElementById('editExecuteTemplateEngine').value;

                    if (!currentQuery) {
                        showToast('No query to convert.', 'warning');
                        return;
                    }
                    if (!(targetEngine === 'shodan' || targetEngine === 'censys')) {
                        showToast('Select Shodan or Censys as the target engine to convert.', 'warning');
                        return;
                    }

                    const convertedQuery = convertToShodanCensys(currentQuery, targetEngine);
                    currentQueryInput.value = convertedQuery;
                    showToast(`Query converted for ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)}!`, 'success');

                    const conversionSection = document.getElementById('editExecuteConversionSection');
                    if (conversionSection) {
                        conversionSection.style.display = 'none';
                    }
                });
            }
        }

        function applySelectedTemplate(templateId) {
            // Because dorkTemplates is now an object of objects, we need to iterate to find the template
            let template = null;
            for (const category in dorkTemplates) {
                template = dorkTemplates[category].find(t => t.id === templateId);
                if (template) break; // Found it, stop searching
            }

            if (template) {
                // Switch to Query Playground tab first
                switchDorkSubTab('query-playground');

                // Populate playground fields
                document.getElementById('dorkKeywords').value = template.keywords;
                document.getElementById('dorkCustomInput').value = template.custom;
                document.getElementById('dorkEngineSelect').value = template.engine;

                // Update state and preview
                updateDorkAssistantState();
                showToast(`Template "${template.name}" applied to playground!`, 'success');
            }
        }

        function executeTemplateQuery(templateId) {
            let template = null;
            for (const category in dorkTemplates) {
                template = dorkTemplates[category].find(t => t.id === templateId);
                if (template) break;
            }

            if (template) {
                const query = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`.trim();
                executeDorkQuery(query, template.engine);
            }
        }

        // MODIFIED: openEditExecuteTemplateModal (Reset flag when modal is opened)
        function openEditExecuteTemplateModal(templateId) {
            let template = null;
            for (const category in dorkTemplates) {
                template = dorkTemplates[category].find(t => t.id === templateId);
                if (template) break;
            }

            if (template) {
                // NEW: Reset the conversion flag when opening the modal for a new editing session
                dorkAssistantState.conversionJustPerformed = false;
                saveDorkAssistantState(); // Persist the reset

                document.getElementById('editExecuteTemplateId').value = template.id;
                document.getElementById('editExecuteTemplateName').value = template.name;
                const fullQuery = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`;
                document.getElementById('editExecuteTemplateQuery').value = fullQuery.trim();
                document.getElementById('editExecuteTemplateEngine').value = template.engine;

                const conversionSection = document.getElementById('editExecuteConversionSection');
                if (conversionSection) {
                    conversionSection.style.display = 'none';
                }

                showModal('editExecuteTemplateModal');
            } else {
                showToast('Template not found!', 'error');
            }
        }

        // MODIFIED: handleEditExecuteTemplate (Main logic to conditionally show warning)
        function handleEditExecuteTemplate(e) {
            e.preventDefault();
            const query = document.getElementById('editExecuteTemplateQuery').value.trim();
            const engine = document.getElementById('editExecuteTemplateEngine').value;

            if (!query) {
                showToast('Query cannot be empty.', 'warning');
                return;
            }

            // NEW LOGIC START
            // If a conversion was just performed and the current engine matches the converted one,
            // or if the conversion was from the warning modal, bypass the warning.
            if (dorkAssistantState.conversionJustPerformed) {
                // Reset the flag immediately after checking to prevent it from affecting future executions.
                dorkAssistantState.conversionJustPerformed = false;
                saveDorkAssistantState(); // Persist the reset
                hideModal('editExecuteTemplateModal');
                executeDorkQuery(query, engine);
                return; // Exit the function, no warning needed.
            }
            // NEW LOGIC END


            // Heuristics for checking if a query appears to be in a specific format
            // These are still useful for general templates/saved queries that might start in a specific format.
            const looksLikeShodan = (q) => {
                const lowerQ = q.toLowerCase();
                return lowerQ.includes('hostname:') || lowerQ.includes('product:') ||
                    lowerQ.includes('http.html:') || lowerQ.includes('ssl.cert.issuer.cn:') ||
                    lowerQ.includes('port:') || lowerQ.includes('org:') || lowerQ.includes('vuln:'); // Added vuln
            };

            const looksLikeCensys = (q) => {
                const lowerQ = q.toLowerCase();
                return lowerQ.includes('services.dns.names:') || lowerQ.includes('services.http.response.html.title:') ||
                    lowerQ.includes('services.http.response.request.url:') || lowerQ.includes('services.http.response.html.body:') ||
                    lowerQ.includes('services.tls.certificates.leaf_data.') || lowerQ.includes('services.http.tags:') ||
                    lowerQ.includes('vulnerability.id:'); // Added vulnerability.id
            };

            let showWarning = false;
            let warningMessage = '';

            // Case 1: Target engine is Shodan/Censys, but query doesn't look like it
            if (engine === 'shodan' && !looksLikeShodan(query)) {
                showWarning = true;
                warningMessage = `The selected engine is Shodan, but the query does not appear to be in Shodan format. ` +
                                `It might not work correctly. You can convert it now or continue execution anyway.`;
            } else if (engine === 'censys' && !looksLikeCensys(query)) {
                showWarning = true;
                warningMessage = `The selected engine is Censys, but the query does not appear to be in Censys format. ` +
                                `It might not work correctly. You can convert it now or continue execution anyway.`;
            }
            // Case 2: Target engine is a standard search engine, but query looks like Shodan/Censys
            else if ((engine === 'google' || engine === 'duckduckgo' || engine === 'bing' || engine === 'yandex') &&
                    (looksLikeShodan(query) || looksLikeCensys(query))) {
                showWarning = true;
                warningMessage = `This query appears to be in Shodan or Censys format, but the selected engine is '${engine}'. ` +
                                `It might not work correctly. You can convert it to a general search query or continue execution anyway.`;
            }

            if (showWarning) {
                document.getElementById('dorkWarningMessage').innerText = warningMessage;
                document.getElementById('dorkWarningModal').dataset.tempQuery = query;
                document.getElementById('dorkWarningModal').dataset.tempEngine = engine;

                showModal('dorkWarningModal');
            } else {
                hideModal('editExecuteTemplateModal');
                executeDorkQuery(query, engine);
            }
        }

        // --- Saved Queries Logic ---
        function loadSavedQueries() {
            const saved = localStorage.getItem('osintDorkSavedQueries');
            if (saved) {
                dorkAssistantState.savedQueries = JSON.parse(saved);
            }
        }

        function saveSavedQueries() {
            localStorage.setItem('osintDorkSavedQueries', JSON.stringify(dorkAssistantState.savedQueries));
        }

        function openSaveDorkQueryModal() {
            const currentQuery = dorkAssistantState.previewQuery;
            const currentEngine = dorkAssistantState.engine;

            if (!currentQuery) {
                showToast('No query in playground to save.', 'warning');
                return;
            }

            document.getElementById('saveDorkQueryForm').reset();
            document.getElementById('savedQueryGenerated').value = currentQuery;
            document.getElementById('savedQueryEngine').value = currentEngine.charAt(0).toUpperCase() + currentEngine.slice(1);
            showModal('saveDorkQueryModal');
        }

        // MODIFIED: handleSaveDorkQuery (Add call to renderSavedQueries)
        function handleSaveDorkQuery(e) {
            e.preventDefault();
            const queryName = document.getElementById('savedQueryName').value.trim();
            const queryDescription = document.getElementById('savedQueryDescription').value.trim();
            const queryTags = document.getElementById('savedQueryTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const generatedQuery = document.getElementById('savedQueryGenerated').value;
            const targetEngine = document.getElementById('savedQueryEngine').value.toLowerCase();

            if (!queryName) {
                showToast('Please enter a name for the query.', 'error');
                return;
            }

            const newSavedQuery = {
                id: `dork-${Date.now()}`,
                name: queryName,
                description: queryDescription,
                query: generatedQuery,
                engine: targetEngine,
                tags: queryTags,
                createdAt: new Date().toISOString()
            };

            dorkAssistantState.savedQueries.push(newSavedQuery);
            saveSavedQueries();
            hideModal('saveDorkQueryModal');
            showToast('Query saved successfully!', 'success');

            // NEW: Render the saved queries list to show the new entry
            renderSavedQueries();

            // Optional: Switch to the saved queries tab automatically
            switchDorkSubTab('saved-queries');
        }

        function renderSavedQueries() {
            const savedQueriesList = document.getElementById('savedQueriesList');
            const savedQueriesEmptyState = document.getElementById('savedQueriesEmptyState');
            savedQueriesList.innerHTML = ''; // Clear previous

            const searchTerm = dorkAssistantState.savedQuerySearchTerm.toLowerCase();
            const filteredQueries = dorkAssistantState.savedQueries.filter(q => {
                const nameMatch = q.name.toLowerCase().includes(searchTerm);
                const descMatch = q.description.toLowerCase().includes(searchTerm);
                const queryMatch = q.query.toLowerCase().includes(searchTerm);
                const tagMatch = q.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                return nameMatch || descMatch || queryMatch || tagMatch;
            });

            if (filteredQueries.length === 0) {
                savedQueriesEmptyState.style.display = 'block';
                savedQueriesList.style.display = 'none';
                if (searchTerm) {
                    savedQueriesEmptyState.innerHTML = `<i class="fas fa-search"></i><h3>No matching saved queries found</h3><p>Try a different search term.</p>`;
                } else {
                    savedQueriesEmptyState.innerHTML = `<i class="fas fa-bookmark"></i><h3>No Saved Queries Yet</h3><p>Save your favorite dork queries from the Query Playground!</p>`;
                }
                return;
            }

            savedQueriesEmptyState.style.display = 'none';
            savedQueriesList.style.display = 'grid'; // Ensure grid display

            filteredQueries.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(query => {
                savedQueriesList.innerHTML += `
                    <div class="saved-query-card" data-query-id="${query.id}">
                        <div class="query-header">
                            <span>${query.name}</span>
                            <span class="query-engine">${query.engine.charAt(0).toUpperCase() + query.engine.slice(1)}</span>
                        </div>
                        <div class="query-string">${query.query}</div>
                        <div class="query-description">${query.description || 'No description.'}</div>
                        <div class="saved-query-tags">
                            ${query.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div class="query-actions">
                            <button class="btn btn-primary btn-sm load-query-btn" data-query-id="${query.id}">
                                <i class="fas fa-file-import"></i> Load
                            </button>
                            <button class="btn btn-secondary btn-sm execute-saved-query-btn" data-query-id="${query.id}">
                                <i class="fas fa-play"></i> Execute
                            </button>
                            <button class="btn btn-danger btn-sm delete-saved-query-btn" data-query-id="${query.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            // Add event listeners for saved query actions
            document.querySelectorAll('.load-query-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const queryId = e.target.dataset.queryId;
                    loadSavedQueryToPlayground(queryId);
                });
            });
            document.querySelectorAll('.execute-saved-query-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const queryId = e.target.dataset.queryId;
                    executeSavedQuery(queryId);
                });
            });
            document.querySelectorAll('.delete-saved-query-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const queryId = e.target.dataset.queryId;
                    deleteSavedQuery(queryId);
                });
            });
        }

        function loadSavedQueryToPlayground(queryId) {
            const queryToLoad = dorkAssistantState.savedQueries.find(q => q.id === queryId);
            if (queryToLoad) {
                switchDorkSubTab('query-playground'); // Switch back to playground

                document.getElementById('dorkKeywords').value = ''; // Clear keywords as they are embedded in 'query'
                document.getElementById('dorkCustomInput').value = queryToLoad.query; // Load full query into custom input
                document.getElementById('dorkEngineSelect').value = queryToLoad.engine;

                updateDorkAssistantState(); // Update state and preview
                showToast(`Saved query "${queryToLoad.name}" loaded to playground!`, 'success');
            }
        }

        function executeSavedQuery(queryId) {
            const queryToExecute = dorkAssistantState.savedQueries.find(q => q.id === queryId);
            if (queryToExecute) {
                executeDorkQuery(queryToExecute.query, queryToExecute.engine);
            }
        }

        function deleteSavedQuery(queryId) {
            if (confirm('Are you sure you want to delete this saved query?')) {
                dorkAssistantState.savedQueries = dorkAssistantState.savedQueries.filter(q => q.id !== queryId);
                saveSavedQueries();
                showToast('Saved query deleted!', 'error');
                renderSavedQueries();
            }
        }

        function saveDorkAssistantState() {
            localStorage.setItem('osintDorkAssistantState', JSON.stringify(dorkAssistantState));
        }

        function loadDorkAssistantState() {
            const savedState = localStorage.getItem('osintDorkAssistantState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(dorkAssistantState, parsedState);
            }
        }

// Function to get a random item from a given array (utility)
function getRandomItem(array) {
    if (!array || array.length === 0) {
        return null;
    }
    return array[Math.floor(Math.random() * array.length)];
}

// Function to generate a single random content card HTML
function generateRandomContentCard(item, type) {
    let title, description, url, icon, faviconHtml = '', extraClass = '';

    if (!item) {
        // Placeholder card for when no item is available or a slot needs filling
        return `
            <div class="random-content-card placeholder">
                <i class="fas fa-question-circle"></i>
                <h4 class="card-title">No Discovery Available</h4>
                <p class="card-description">Add more tools, tips, or case studies to get a random discovery!</p>
            </div>
        `;
    }

    switch (type) {
        case 'tool':
            title = item.name;
            description = item.description;
            url = item.url;
            icon = 'fas fa-tools';
            // Attempt to get favicon, fallback to a generic image if error
            faviconHtml = `<img src="${item.favicon}" alt="" class="tool-favicon" onerror="this.onerror=null; this.src='https://www.google.com/s2/favicons?domain=${new URL(item.url).hostname}'; if (this.src.includes('google.com/s2/favicons')) this.onerror=function(){this.src='https://placehold.co/24x24/cccccc/000000?text=?';}">`;
            extraClass = 'random-tool-card';
            break;
        case 'tip':
            title = "OSINT Tip";
            description = item; // item itself is the tip string
            url = null;
            icon = 'fas fa-lightbulb';
            extraClass = 'random-tip-card';
            break;
        case 'case-study':
            title = item.title;
            description = item.summary;
            url = null; // Case studies typically don't have a direct URL to open from here
            icon = 'fas fa-microscope';
            extraClass = 'random-case-study-card';
            break;
        default:
            title = "Unknown Discovery";
            description = "Could not load content.";
            url = null;
            icon = 'fas fa-question-circle';
            break;
    }

    return `
        <div class="random-content-card ${extraClass}">
            <div class="card-header">
                ${faviconHtml || `<i class="${icon}"></i>`}
                <h4 class="card-title">${title}</h4>
            </div>
            <p class="card-description">${description}</p>
            ${url ? `<a href="${url}" target="_blank" class="card-link btn-sm btn-primary">Visit <i class="fas fa-external-link-alt"></i></a>` : ''}
        </div>
    `;
}

// Main function to show random discovery with dynamic layouts
function showRandomDiscovery() {
    // #randomDiscovery is the main container (the .random-display div)
    const randomDiscoverySection = document.getElementById('randomDiscovery');
    // #randomItemDisplay is the content wrapper inside it (the .random-content-wrapper div)
    const randomItemDisplay = document.getElementById('randomItemDisplay');
    const newRandomBtn = document.getElementById('newRandomBtn');

    if (!randomDiscoverySection || !randomItemDisplay || !newRandomBtn) {
        console.error("Random discovery elements not found. Ensure #randomDiscovery, #randomItemDisplay, and #newRandomBtn exist in HTML.");
        return;
    }

    // Handle read-only mode first
    if (appState.readOnlyMode) {
        newRandomBtn.style.display = 'none';
        randomItemDisplay.innerHTML = `
            <div class="random-content-card placeholder">
                <i class="fas fa-lock"></i>
                <h4 class="card-title">Read-Only Mode</h4>
                <p class="card-description">Discovery is disabled in shared view.</p>
            </div>
        `;
        randomDiscoverySection.classList.remove('two-rows', 'two-columns', 'single-centered'); // Clear layout classes
        randomDiscoverySection.classList.add('single-centered'); // Default to single view in read-only
        return;
    }

    newRandomBtn.disabled = true; // Disable button during loading
    // Display a loading spinner or message initially within the content area
    randomItemDisplay.innerHTML = `
        <div class="random-content-card placeholder">
            <div class="loading" style="margin-bottom: 10px;"></div>
            <p>Loading discovery...</p>
        </div>
    `;

    // Clear existing layout classes from the main section to apply new ones consistently
    randomDiscoverySection.classList.remove('single-centered', 'two-columns', 'two-rows');


    // Simulate API call delay or complex content generation
    setTimeout(() => {
        const allTools = appState.tools.filter(tool => tool.url); // Ensure tools have a URL
        const allTips = appState.osintTips;
        const allCaseStudies = appState.caseStudies;

        const availableContentTypes = [];
        if (allTools.length > 0) availableContentTypes.push('tool');
        if (allTips.length > 0) availableContentTypes.push('tip');
        if (allCaseStudies.length > 0) availableContentTypes.push('case-study');

        if (availableContentTypes.length === 0) {
            randomItemDisplay.innerHTML = `
                <div class="random-content-card placeholder">
                    <i class="fas fa-exclamation-circle"></i>
                    <h4 class="card-title">No Content Available</h4>
                    <p class="card-description">Add some tools, tips, or case studies to get amazing discoveries!</p>
                </div>
            `;
            // If no content, default to single column layout
            randomDiscoverySection.classList.add('single-centered');
            newRandomBtn.disabled = false;
            return;
        }

        // --- FIXED LAYOUT LOGIC: Always use 'two-rows' as requested ---
        const selectedLayout = 'two-rows'; // Force the 2-rows layout
        randomDiscoverySection.classList.add(selectedLayout); // Add layout class to the main #randomDiscovery container

        const numItems = 3; // Always generate 3 items for the 'two-rows' layout

        const generatedCards = [];
        for (let i = 0; i < numItems; i++) {
            const randomType = getRandomItem(availableContentTypes);
            let item;
            // Ensure we don't try to get an item from an empty array type
            if (randomType === 'tool' && allTools.length > 0) {
                item = getRandomItem(allTools);
            } else if (randomType === 'tip' && allTips.length > 0) {
                item = getRandomItem(allTips);
            } else if (randomType === 'case-study' && allCaseStudies.length > 0) {
                item = getRandomItem(allCaseStudies);
            }
            // If item is still null (e.g., specific type array was empty), generate a generic placeholder
            generatedCards.push(generateRandomContentCard(item, randomType));
        }

        // Construct the HTML for the content cards, explicitly placing the cards in their grid areas
        // The .layout-two-rows class should be applied to the .random-content-wrapper (which is #randomItemDisplay)
        const contentCardsHtml = `
            ${generatedCards[0] || generateRandomContentCard(null)}
            ${generatedCards[1] || generateRandomContentCard(null)}
            ${generatedCards[2] || generateRandomContentCard(null)}
        `;

        // Update the innerHTML of `randomItemDisplay` (the content wrapper) with the new cards
        randomItemDisplay.innerHTML = contentCardsHtml;
        
        // This ensures the layout is applied to the direct parent of cards, which is randomItemDisplay
        randomItemDisplay.classList.add(`layout-${selectedLayout}`);
        randomItemDisplay.classList.remove('layout-single', 'layout-two-columns'); // Clear other layout classes

        newRandomBtn.disabled = false; // Re-enable button
    }, 500); // Simulate network delay
}




        
        // Add loadDorkAssistantState to the very beginning of initApp
        const originalInitApp = initApp;
        initApp = function() {
            loadDorkAssistantState(); // Load the dork assistant state first
            originalInitApp(); // Call the original initApp
            initDorkAssistant(); // Initialize the new dork assistant
            // The switchDorkSubTab call in initDorkAssistant handles showing the correct tab
        };
        

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
    <script>
        // Auto-detect system theme preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('theme-icon').className = 'fas fa-moon';
        }
        // Tab functionality
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Optional: Add haptic feedback on mobile
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
        });
    </script>
    <script>
        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = window.innerWidth < 768 ? 15 : 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particle.style.width = particle.style.height = (Math.random() * 4 + 2) + 'px';
                particlesContainer.appendChild(particle);
            }
        }

        // Create connecting lines
        function createConnectingLines() {
            const linesContainer = document.getElementById('connecting-lines');
            const lineCount = window.innerWidth < 768 ? 3 : 6;
            
            for (let i = 0; i < lineCount; i++) {
                const line = document.createElement('div');
                line.className = 'connection-line';
                line.style.top = Math.random() * 100 + '%';
                line.style.left = Math.random() * 50 + '%';
                line.style.width = Math.random() * 200 + 100 + 'px';
                line.style.animationDelay = Math.random() * 4 + 's';
                line.style.animationDuration = (Math.random() * 2 + 3) + 's';
                linesContainer.appendChild(line);
            }
        }

        // Enhanced card hover effects
        document.querySelectorAll('.evidence-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.zIndex = '10';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.zIndex = '1';
            });
        });

        // Auto-detect system theme preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('theme-icon').className = 'fas fa-moon';
        }

        // Initialize animations
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            createConnectingLines();
            
            // Stagger card animations
            const cards = document.querySelectorAll('.evidence-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = (index * 0.1) + 's';
                card.style.animation = 'slideIn 0.8s ease forwards';
            });
        });

        // Add slide in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

        // Resize handler for responsive particles
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                document.getElementById('particles').innerHTML = '';
                document.getElementById('connecting-lines').innerHTML = '';
                createParticles();
                createConnectingLines();
            }, 250);
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>
