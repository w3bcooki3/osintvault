<!--Add New Tool Showing different form for each type instead of showing only 1 to all.-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINTVault - Carry your investigations everywhere</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./favicon.png" type="image/x-icon">
    <style>
        /* Refined Color Palette & Variables */
        :root {
            --primary: #007bff; /* Slightly less vibrant blue, more authoritative */
            --primary-dark: #0056b3;
            --secondary: #ff6b35; /* Strong accent for highlights */
            --accent: #28a745; /* Positive action/success */
            --danger: #dc3545;
            --warning: #ffaa00;
            --success: #28a745;

            /* Darker, more professional greyscale for dark theme */
            --bg-primary: #0C1017; /* Deeper primary background */
            --bg-secondary: #171E28; /* Slightly lighter card/section background */
            --bg-tertiary: #212B3B; /* Input/hover background */
            --bg-card: #1E2736;     /* Card background */

            --text-primary: #E0E6F0; /* Brighter text for contrast */
            --text-secondary: #9BAEC8; /* Muted text */
            --text-muted: #6A7F9D;    /* Even more muted text */

            --border: #3D4C61;      /* Stronger but still subtle border */
            --border-light: #526680; /* Lighter border for dividers */

            /* Softer, multi-layered shadow */
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.3), 0 16px 60px rgba(0, 0, 0, 0.2);

            --glow: 0 0 15px rgba(0, 123, 255, 0.4); /* Adjusted glow for new primary */
            --primary-shadow-color: rgba(0, 123, 255, 0.3); /* For primary button shadow */
            --primary-shadow-color-hover: rgba(0, 123, 255, 0.4);

            /* Very subtle gradient, mainly for active states or branding */
            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #1e8738);
            /* Softened background gradient */
            --gradient-bg: linear-gradient(135deg, #0C1017, #171E28);

            /* Default Tab Colors */
            --tab-color-default: var(--primary);
            --tab-color-red: #e74c3c;
            --tab-color-blue: #3498db;
            --tab-color-green: #2ecc71;
            --tab-color-yellow: #f1c40f;
            --tab-color-purple: #9b59b6;
            --tab-color-orange: #e67e22;
        }

        [data-theme="light"] {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --accent: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;

            /* Lighter, professional greyscale for light theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F9FC; /* Slightly off-white for sections */
            --bg-tertiary: #E8EEF5; /* Light grey for inputs/hovers */
            --bg-card: #FFFFFF;    /* White card background */

            --text-primary: #2C3E50; /* Darker text for readability */
            --text-secondary: #607D8B; /* Muted grey text */
            --text-muted: #95A5A6;    /* Even more muted */

            --border: #CFD8DC; /* Light grey border */
            --border-light: #ECEFF1; /* Very light border */

            --glow: 0 0 10px rgba(0, 123, 255, 0.2);
            --shadow: 0 1px 4px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08);

            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #218838);
            --gradient-bg: linear-gradient(135deg, #F7F9FC, #E8EEF5);

            /* Default Tab Colors (Light Theme) */
            --tab-color-default: var(--primary);
            --tab-color-red: #c0392b;
            --tab-color-blue: #2980b9;
            --tab-color-green: #27ae60;
            --tab-color-yellow: #f39c12;
            --tab-color-purple: #8e44ad;
            --tab-color-orange: #d35400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg); /* Use the softened gradient */
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            /* Add transition for background-image as well, if the gradient is applied as such */
            transition: background 0.5s ease, color 0.5s ease; /* Slightly longer transition for smoother theme change */
        }

        .container {
            width: 100%; /* Make it full screen */
            max-width: 100%; /* Ensure it spans fully */
            padding: 0; /* Remove horizontal padding at container level */
            margin: 0 auto; /* Center the container */
        }

        /* Header Styles */
        header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px 40px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Container for Logo and Title/Tagline Group */
        .logo-and-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0; /* Prevents this group from shrinking */
            min-width: 0;
            /* FIXED: Ensure it stays at the left */
            margin-right: auto; /* This pushes controls to the right */
        }

        /* Styles for the Logo */
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 65px;
            flex-shrink: 0;
        }

        .osintvault-logo-img {
            display: block;
            max-height: 100%;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(0, 123, 255, 0.4));
            transition: filter 0.3s ease;
        }

        .osintvault-logo-img:hover {
            filter: drop-shadow(0 0 15px rgba(0, 123, 255, 0.6));
        }

        /* Container for OSINTVault Title and Tagline */
        .header-text-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            flex-grow: 1;
            min-width: 0;
        }

        /* Style for OSINTVault Title */
        .header-title {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Style for the single Tagline */
        .header-tagline {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* Responsive adjustments for header-content padding */
        @media (max-width: 1200px) {
            .header-content {
                padding: 20px; /* Adjust padding for medium screens */
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column; /* Stack logo/text group and controls vertically */
                align-items: stretch; /* Stretch to full width */
                padding: 15px; /* Further adjust padding for smaller screens */
                gap: 15px; /* Space between stacked groups */
            }
            .logo-and-title-container {
                justify-content: center; /* Center logo and text group when stacked */
                width: 100%;
                gap: 10px; /* Reduced gap */
            }
            .header-logo {
                height: 55px; /* Smaller logo height on tablets */
            }
            .header-title {
                font-size: 1.8em; /* Smaller title font on tablets */
            }
            .header-tagline {
                font-size: 0.8rem; /* Smaller tagline font on tablets */
            }
            .controls {
                width: 100%; /* Ensure controls take full width */
                justify-content: center; /* Center buttons within controls */
                margin-left: 0; /* Reset margin to avoid pushing controls to the right */;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                padding: 10px; /* Minimal padding on very small screens */
                gap: 10px; /* Reduced gap */
            }
            .header-logo {
                height: 45px; /* Smallest logo height on phones */
            }
            .header-title {
                font-size: 1.5em; /* Smallest title font on phones */
            }
            .header-tagline {
                font-size: 0.7rem; /* Smallest tagline font on phones */
            }
            /* Ensure text truncation or wrapping for very small screens */
            .header-title, .header-tagline {
                white-space: normal; /* Allow text to wrap on very small screens */
                overflow: visible; /* Make overflow visible as wrapping is enabled */
                text-overflow: clip; /* No ellipsis needed if wrapping */
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0; /* Prevents controls from shrinking */
            min-width: 0;
            justify-content: flex-end;
            /* FIXED: Ensure it stays at the right */
            margin-left: auto; /* This ensures controls stay at the right */
        }

        .search-container {
            position: relative;
            min-width: 350px;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            flex-grow: 1;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.15);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        
        /* New: Search Scope Select */
        #searchScopeSelect {
            margin-left: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
            -webkit-appearance: none; /* Remove default dropdown arrow for better styling consistency */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%239BAEC8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H19a17.6%2017.6%200%200%200-13.6%206.4%2017.6%2017.6%200%200%200%200%2025.2l128%20128c6.9%206.9%2017.9%206.9%2024.7%200l128-128a17.6%2017.6%200%200%200%200-25.2z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
            padding-right: 30px; /* Make space for the custom arrow */
        }
        #searchScopeSelect:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 30px;
            align-items: center;
            padding: 15px 40px; /* Match header padding */
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            border-radius: 0; /* Remove rounded corners */
            margin: 0;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow to stats bar */
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-item i {
            color: var(--primary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Button Styles */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px; /* Slightly more rounded */
            font-size: 14px;
            font-weight: 600; /* Bolder text */
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.2px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .btn-primary:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow); /* Add shadow to secondary buttons */
        }

        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg); /* Increased shadow on hover */
        }

        .btn-danger {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 51, 102, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            margin: 20px 40px 0; /* Add horizontal padding for main tabs */
            /* Replaced border-bottom with a more integrated look */
            background: var(--bg-secondary);
            border-radius: 12px; /* Rounded container for tabs */
            padding: 8px; /* More padding around tabs */
            transition: background 0.3s ease, border-color 0.3s ease;
            flex-wrap: wrap;
            box-shadow: var(--shadow); /* Add shadow to tab container */
        }

        .nav-tab {
            padding: 14px 22px; /* Adjusted padding for a cleaner look */
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px; /* Match button border-radius */
            font-weight: 600;
            position: relative;
            flex-grow: 1;
            text-align: center;
        }

        .nav-tab.active {
            background: var(--gradient-primary); /* Keep gradient for active */
            color: white;
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Sub-tabs styling */
        .sub-nav-tabs {
            display: flex;
            gap: 0;
            margin-top: 20px;
            border: 1px solid var(--border-light); /* Lighter border */
            background: var(--bg-tertiary); /* Slightly different background for sub-tabs */
            border-radius: 8px; /* Slightly smaller radius than main tabs */
            padding: 4px; /* Less padding */
            flex-wrap: wrap;
            box-shadow: var(--shadow); /* Add shadow to sub-tab container */
        }

        .sub-nav-tab {
            padding: 10px 15px; /* Adjusted padding */
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85em; /* Slightly smaller font for sub-tabs */
            flex-grow: 1;
            text-align: center;
        }

        .sub-nav-tab.active {
            color: white;
            background-color: var(--tab-color-default); /* Use default tab color */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for active sub-tab */
        }

        .sub-nav-tab:hover:not(.active) {
            background: var(--border);
            color: var(--text-primary);
        }


        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin: 30px 40px; /* Add horizontal padding to dashboard */
            width: calc(100% - 80px); /* Adjust width for padding */
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            height: fit-content;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: sticky;
            top: 120px;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .sidebar h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        /* Refined Random Discovery Section */
        .random-display {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 12px; /* Increased border-radius for softer look */
            padding: 20px; /* More padding */
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px; /* Increased min-height for better visual balance */
            box-shadow: var(--shadow); /* Add a subtle shadow */
        }

        .random-display .random-content-wrapper {
            flex-grow: 1; /* Allows content to take available space */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            margin-bottom: 15px; /* Space between content and button */
        }

        /* Refined Random Discovery Section - Header specific styling */
        .random-display .random-display-header {
            display: flex;
            align-items: center; /* Vertically align items */
            justify-content: center; /* Center the entire header horizontally */
            gap: 12px; /* Increased gap between icon and text */
            margin-bottom: 20px; /* More space below the header */
            color: var(--text-primary); /* Use primary text color for better contrast */
            font-weight: 600; /* Keep it bold */
            padding-bottom: 10px; /* Add some padding at the bottom */
            border-bottom: 1px solid var(--border-light); /* Subtle separator line */
            width: 100%; /* Ensure it spans the width */
        }

        .random-display .random-display-header .header-icon {
            font-size: 1.8em; /* Slightly larger icon */
            color: var(--primary); /* Keep primary color for the icon */
            /* Add a subtle text-shadow for a soft glow effect */
            text-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        .random-display .random-display-header .header-text {
            font-size: 1.2em; /* Slightly larger font for the heading text */
            margin: 0; /* Remove default h3 margin */
            font-family: 'Outfit', sans-serif; /* Use the logo font for a premium feel */
            letter-spacing: -0.5px; /* Tighter spacing */
            background: var(--gradient-primary); /* Apply gradient for a premium look */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        .random-display .random-item-placeholder {
            min-height: 80px; /* Ensure content area has a minimum height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%; /* Take full width of wrapper */
        }

        .random-display .random-item-placeholder p {
            margin-bottom: 8px; /* Space between paragraphs */
            line-height: 1.4;
        }

        .random-display .random-item-placeholder strong {
            color: var(--text-primary); /* Make strong text more prominent */
        }

        .random-display .random-tool-link {
            font-size: 1.05em; /* Slightly larger link text for tools */
            font-weight: 600;
            text-decoration: none;
            color: var(--primary);
            display: flex; /* Keep flex for icon/text alignment */
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* NEW: Allow text to wrap within the link */
            flex-wrap: wrap; /* Allow items within the link to wrap (e.g., icon and text) */
            text-align: center; /* Center text lines if they wrap */
            word-break: break-word; /* Break long words if they don't fit */
            min-width: 0; /* Important for flex items to allow shrinking */
            overflow: hidden; /* Hide any content that still overflows after wrapping/breaking */
        }

        /* Further ensure the parent text container allows text to wrap */
        .random-display .random-item-placeholder p {
            margin-bottom: 8px; /* Space between paragraphs */
            line-height: 1.4;
            word-wrap: break-word; /* Ensure long words wrap */
            overflow-wrap: break-word; /* Modern equivalent */
            max-width: 100%; /* Ensure it doesn't overflow its parent */
        }

        .random-display .random-tool-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .random-display .tool-favicon {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .random-display .btn-sm {
            padding: 10px 18px; /* Slightly larger button for better clickability */
            font-size: 13px;
            width: auto;
            margin: 0 auto; /* Center the button */
            display: inline-flex; /* Use inline-flex for centering with margin auto on button */
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box; /* Crucial for responsive width calculations */
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .content-title {
            font-size: 28px; /* Slightly larger content title */
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tools Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border); /* Thinner border */
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease; /* Faster transition */
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow); /* Apply new softer shadow */
        }

        .tools-list .tool-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
        }

        .tools-list .tool-header {
            width: 100%;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }

        .tool-header > div:first-child { /* This targets the container holding tool-title and tool-url */
            flex-grow: 1; /* Allow it to grow and take available space */
            flex-shrink: 1; /* Allow it to shrink */
            min-width: 0; /* Crucial: Allows content to shrink below its intrinsic width */
            /* If titles are very long and you want them to truncate, you might add: */
            /* overflow: hidden; */
            /* text-overflow: ellipsis; */
            /* white-space: nowrap; */
            /* However, wrapping is generally preferred for readability. */
        }
        .tools-list .tool-title {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .tools-list .tool-url {
            font-size: 11px;
        }

        .tools-list .tool-actions {
            margin-left: auto;
            flex-shrink: 0;
        }

        .tools-list .tool-tags {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .tools-list .tool-tags .threat-level {
            margin-left: auto;
            float: none; /* Override float */
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px; /* Thicker accent line */
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-7px); /* More pronounced lift */
            box-shadow: var(--shadow-lg); /* Larger shadow on hover */
            border-color: var(--primary);
        }

        .tool-card:hover::before {
            opacity: 1;
        }

        .tool-card.starred {
            border-color: var(--secondary);
        }

        .tool-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .tool-card.selected {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.05), transparent);
        }
        /* Style for shared highlight */
        .tool-card.shared-highlight {
            border-color: var(--primary); /* Highlight with primary color */
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.08), transparent);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }


        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top */
            margin-bottom: 15px;
            width: 100%; /* Ensure it takes full width of the card */
            flex-wrap: wrap; /* Allow header content to wrap if needed */
            gap: 10px; /* Space between the title/URL part and actions */
        }

        .tool-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* NEW: Allow elements within the title (checkbox, favicon, text) to wrap */
            min-width: 0; /* Ensures the title itself can shrink if necessary */
            word-break: break-word; /* NEW: Ensure long words break */
        }

        .tool-favicon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .tool-url {
            font-size: 0.8rem; /* Slightly smaller URL */
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .external-link-icon {
            color: var(--primary);
            font-size: 10px;
            opacity: 0.7;
        }

        .tool-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px; /* Smaller padding for action buttons */
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9rem; /* Slightly smaller icon size */
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary); /* Hover color for actions */
            transform: scale(1.15); /* Slightly more prominent icon scaling */
        }

        .action-btn.starred {
            color: var(--secondary);
        }

        .action-btn.pinned {
            color: var(--accent);
        }


        /* Bulk Actions */
        .bulk-actions {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow); /* Add shadow to bulk actions */
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-checkbox {
            margin-right: 10px;
        }

        .threat-high {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px; /* More padding */
            text-align: center;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-value {
            font-size: 3rem; /* Larger font size */
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px; /* Tighter spacing for numbers */
        }

        .analytics-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .analytics-list {
            list-style: none;
            padding: 0;
        }

        .analytics-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
        }

        .analytics-list li:last-child {
            border-bottom: none;
        }

        .analytics-list li span:first-child {
            color: var(--text-primary);
            font-weight: 500;
        }

        .analytics-list li span:last-child {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }


        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Footer */
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            padding-bottom: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
                margin: 30px 20px; /* Adjust padding for medium screens */
                width: calc(100% - 40px);
            }
            
            .sidebar {
                position: static;
            }

            .header-content, .stats-bar, .nav-tabs, .footer-content {
                padding: 0 20px; /* Adjust padding for medium screens */
            }

            .nav-tabs {
                margin: 20px 20px 0;
            }

            .main-content {
                padding: 20px; /* Reduce padding for medium screens */
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 15px; /* Consistent padding for main content area */
            }
            .container {
                padding: 0;
            }
            
            .header-content {
                gap: 15px; /* Slightly reduce gap on smaller screens */
                padding: 0 15px; /* Ensure consistent padding on smaller screens */
            }
            
            .search-container {
                min-width: unset;
                width: 100%;
                flex-direction: column; /* Stack search input and select */
                align-items: stretch;
            }
            .search-input {
                margin-bottom: 10px;
            }
            #searchScopeSelect {
                margin-left: 0; /* Reset margin for stacking */
                margin-top: 10px; /* Add space above it when stacked */
                width: 100%; /* Ensure it takes full width when stacked */
            }
            .search-icon {
                right: 20px; /* Keep position relative to input */
            }

            .controls {
                width: 100%;
                justify-content: center;
            }

            .tools-grid, .tools-list {
                grid-template-columns: 1fr; /* Force single column on smaller screens */
                gap: 15px; /* Slightly reduce gap on mobile */
            }
            .tools-list .tool-header {
                flex-direction: column; /* Stack title/url and actions vertically */
                align-items: flex-start;
            }
            .tools-list .tool-actions {
                margin-left: 0; /* Remove auto-margin when stacked vertically */
                width: 100%; /* Take full width when stacked */
                justify-content: flex-start; /* Align buttons to the left when stacked */
            }
                    
            .nav-tab {
                flex-basis: calc(50% - 5px); /* Account for gap */
                margin-bottom: 10px;
                padding: 12px 15px; /* Slight adjustment if needed */
                font-size: 13px; /* Ensure font is appropriate */
            }
            .nav-tabs {
                padding: 6px; /* Reduce container padding */
                margin: 15px 10px 0; /* Adjust margin too */
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 10px 20px; /* Vertical gap, Horizontal gap */
                justify-content: center;
                padding: 15px;
                font-size: 13px; /* Slightly smaller font for stats */
            }
            .stat-item {
                flex-basis: auto; /* Allow items to determine their own width */
                margin: 0; /* Remove any default margins that might interfere */
                justify-content: center; /* Center content within each stat item */
            }

            .dashboard {
                margin: 20px 15px; /* Adjust margin for smaller screens */
                width: calc(100% - 30px);
            }

            .tips-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .footer {
                padding: 40px 15px 20px;
            }

            .notes-header {
                flex-direction: column; /* Stack elements vertically */
                align-items: stretch; /* Stretch items to full width */
                gap: 15px; /* Consistent gap */
            }
            .notes-search-container {
                margin-left: 0; /* Remove left margin when stacked */
                width: 100%; /* Ensure full width */
            }
            .new-note-btn {
                width: 100%; /* Make button full width */
                justify-content: center; /* Center button text */
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                margin: 15px 8px; /* Very tight margins for smallest screens */
                width: calc(100% - 16px);
            }

            .main-content {
                padding: 10px; /* Minimal padding for content on very small screens */
            }

            .modal.show {
                padding: 10px; /* Reduce padding for very small screens */
            }

            .modal-content {
                padding: 25px; /* Reduce internal padding for very small screens */
                border-radius: 12px; /* Slightly less rounded on small screens */
            }

            .form-group label {
                margin-bottom: 8px; /* Slightly less space below labels */
                font-size: 14px; /* Adjust label font size */
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px; /* Reduce input padding */
                font-size: 13px; /* Reduce input font size */
            }

            .logo {
                font-size: 24px; /* Adjust logo size */
            }

            .header-content {
                gap: 10px; /* Further reduce gap on very small screens */
                padding: 0 10px; /* Even tighter padding for very small screens */
            }

            .notes-header {
                gap: 10px; /* Reduce gap on very small screens */
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .search-input {
                padding: 12px 40px 12px 15px;
                font-size: 13px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
            }
            .sub-nav-tab {
                padding: 8px 10px;
                font-size: 12px;
            }

            .tool-card {
                padding: 15px;
            }

            .tools-list .tool-card {
                padding: 10px 15px;
            }

            .tool-title {
                font-size: 16px;
            }

            .tool-url {
                font-size: 11px;
            }

            .tag {
                font-size: 10px;
            }

            .stats-bar {
                padding: 10px;
                gap: 8px 15px; /* Even smaller gap on very small screens */
                font-size: 12px; /* Further reduce font size */
            }

            /* NEW/MODIFIED: Toast Notifications for small screens */
            .toast {
                left: 50%; /* Center horizontally */
                right: auto; /* Override existing 'right' property */
                transform: translateX(-50%); /* Adjust for horizontal centering */
                width: calc(100% - 40px); /* Take up most of the width with some padding */
                max-width: 350px; /* Limit maximum width on slightly larger phones */
                text-align: center; /* Center text within the toast */
            }
        }

        /* Modal and Form Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 15px; /* Add some padding to the modal container itself for small screens */
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 100%; /* Ensure it takes full width of allowed space within padding */
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px; /* More space below label */
            font-weight: 600; /* Bolder labels */
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px; /* Larger input fields */
            border: 1px solid var(--border);
            border-radius: 10px; /* Match button rounding */
            background: var(--bg-tertiary); /* Lighter background for inputs */
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Subtle inner shadow */
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 4px rgba(0,0,0,0.1);
        }
        .form-group.metadata-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px; /* Smaller margin for repeated entries */
        }

        .form-group.metadata-entry input {
            flex: 1; /* Key and value inputs take equal space */
        }

        .form-group.metadata-entry .remove-metadata-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s ease;
        }

        .form-group.metadata-entry .remove-metadata-btn:hover {
            background: var(--primary-dark);
        }

        .add-metadata-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 5px;
        }

        .add-metadata-btn:hover {
            background: var(--primary-dark);
        }


        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }
        .toast.info { /* For read-only banner */
            background: var(--primary-dark);
        }

        .toast-warning {
            background: var(--danger);
        }

        .toast-info { /* For read-only banner */
            background: var(--tab-color-yellow);
        }

        .toast-error {
            background: var(--warning);
        }

        @keyframes fadeIn { 
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px; /* More vertical padding */
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px dashed var(--border-light); /* Dashed border for a softer look */
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .empty-state i {
            font-size: 72px; /* Larger icon */
            margin-bottom: 20px;
            opacity: 0.2; /* Lighter opacity */
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tag {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 10px; /* More padding for tags */
            border-radius: 16px; /* More rounded */
            font-size: 0.75rem; /* Slightly smaller font */
            margin-right: 6px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .threat-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }
        
        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .threat-tags {
            margin-top: 10px;
        }

        .threat-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .threat-high {
            background: var(--danger);
            color: white;
        }
        .threat-medium {
            background: var(--warning);
            color: black;
        }
        .threat-low {
            background: var(--success);
            color: white;
        }

        .scan-progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .scan-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .scan-result:last-child {
            border-bottom: none;
        }

        .scan-result i {
            width: 20px;
        }

        /* Custom Tabs Tool Assignment */
        .custom-tab-assignment {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .custom-tab-assignment h4 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .custom-tab-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .custom-tab-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 8px; /* Slightly softer */
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid var(--border-light); /* More prominent default border */
            transition: all 0.2s ease;
        }

        .custom-tab-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .custom-tab-checkbox.checked {
            border-color: var(--primary);
            background: rgba(0, 123, 255, 0.15); /* Match new primary color */
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2);
        }

        /* Style for Icon picker */
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .icon-picker-item {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            border-radius: 6px; /* Slightly softer */
            cursor: pointer;
            border: 1px solid var(--border-light); /* Visible border */
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .icon-picker-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .icon-picker-item.selected {
            background: var(--primary); /* Use primary color */
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        /* Style for Color picker */
        .color-picker-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker-item {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-picker-item.selected {
            border-color: var(--text-primary); /* Border for selected color */
            box-shadow: 0 0 0 3px var(--primary-dark); /* Thicker, slightly darker glow */
        }

        /*calude_investigation  wall*/
        .investigation-wall {
            min-height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

/*background Image
        .investigation-wall {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            width: 100vw;
            background: var(--gradient-bg); 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .investigation-wall::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: url('./wall.png') center center / cover no-repeat;
            filter: blur(15px);
            z-index: -1;
            transform: scale(1.1); 
        }
*/

        .wall-texture {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.015) 1px, transparent 1px);
            background-size: 50px 50px, 75px 75px;
            animation: subtleShift 20s ease-in-out infinite;
        }

        @keyframes subtleShift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-2px, -2px); }
        }

        .evidence-grid {
            position: relative;
            max-width: 1600px;
            width: 100%;
            padding: 3rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 3rem;
            z-index: 2;
        }

        .evidence-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2.5rem;
            position: relative;
            transform: rotate(-1.5deg);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .evidence-card:nth-child(even) {
            transform: rotate(1.5deg);
        }

        .evidence-card:hover {
            transform: rotate(0deg) scale(1.02);
            background: var(--bg-tertiary);
            box-shadow: var(--shadow-lg), var(--glow);
            border-color: var(--border-light);
        }

        .evidence-card::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: var(--secondary);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .evidence-card::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 12px;
            background: var(--bg-primary);
            border-radius: 2px;
        }

        .card-header-wall {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon-wall {
            width: 24px;
            height: 24px;
            margin-right: 0.75rem;
            fill: currentColor;
        }

        .card-content-wall {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 1rem;
        }

        .highlight-wall {
            background: var(--gradient-primary);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .connecting-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .line {
            position: absolute;
            background: var(--gradient-primary);
            height: 2px;
            transform-origin: left center;
            animation: lineGlow 3s ease-in-out infinite alternate;
            opacity: 0.6;
        }

        @keyframes lineGlow {
            0% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }

        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: var(--primary);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        .section-title-wall {
            position: absolute;
            top: 3rem;
            color: var(--primary);
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            z-index: 4;
            text-shadow: var(--glow);
            border-bottom: 2px solid var(--tab-color-blue);
        }

        @media (max-width: 768px) {
            .evidence-grid {
                grid-template-columns: 1fr;
                padding: 2rem;
                gap: 2rem;
            }
            
            .evidence-card {
                padding: 2rem;
            }
            
            .section-title-wall {
                top: 2rem;
                left: 2rem;
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .evidence-grid {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            
            .evidence-card {
                padding: 1.5rem;
            }
            
            .section-title-wall {
                top: 1.5rem;
                left: 1.5rem;
                font-size: 1.5rem;
            }
        }
        /*-------- End of Investigation Wall Styles --------*/


        /* OSINT Handbook & Notes Styles */
        /* General Handbook Styles */
        .handbook-container {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 30px;
        height: 100%;
        position: relative;
        }

        /* Handbook Sidebar */
        .handbook-sidebar {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        transition: all 0.3s ease;
        position: sticky;
        top: 20px;
        }

        .handbook-search-container {
        position: relative;
        margin-bottom: 20px;
        }

        .handbook-search {
        width: 100%;
        padding: 12px 20px 12px 40px;
        border: 1px solid var(--border-light);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        }

        .handbook-search:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .handbook-search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 14px;
        }

        .handbook-nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 10px;
        margin-bottom: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .handbook-nav-item:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        }

        .handbook-nav-item.active {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow);
        }

        .handbook-category {
        margin-bottom: 10px;
        }

        .handbook-category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 10px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        }

        .handbook-category-header:hover {
        background: var(--bg-tertiary);
        }

        .handbook-category-header .category-toggle {
        margin-left: auto;
        transition: transform 0.3s ease;
        }

        .handbook-category-header .category-toggle.rotate {
        transform: rotate(180deg);
        }

        .handbook-subcategories {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        margin-left: 10px;
        }

        /* Handbook Content */
        .handbook-content-container {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 30px;
        height: 100%;
        overflow-y: auto;
        }

        .handbook-content {
            max-width: 800px;
            /* Changed: Align to the left instead of centering */
            margin: 0; /* Remove auto margins to prevent centering */
            margin-left: 0; /* Explicitly align to the left */
            margin-right: auto; /* Allow auto margin on right for remaining space, keeping left fixed */
            line-height: 1.7;
        }

        .handbook-content h2 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--primary);
        border-bottom: 2px solid var(--border-light);
        padding-bottom: 10px;
        }

        .handbook-content h3 {
        font-size: 22px;
        font-weight: 600;
        margin: 25px 0 15px;
        color: var(--text-primary);
        }

        .handbook-content p {
        margin-bottom: 15px;
        color: var(--text-secondary);
        }

        .handbook-content ul, 
        .handbook-content ol {
        margin-bottom: 20px;
        margin-left: 25px;
        color: var(--text-secondary);
        }

        .handbook-content ul li, 
        .handbook-content ol li {
        margin-bottom: 8px;
        }

        .handbook-content strong {
        color: var(--text-primary);
        font-weight: 600;
        }

        .code-block {
        position: relative;
        background: var(--bg-tertiary);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        overflow-x: auto;
        font-family: 'JetBrains Mono', monospace;
        font-size: 14px;
        line-height: 1.5;
        border-left: 4px solid var(--primary);
        }

        .code-block pre {
        margin: 0;
        padding-right: 40px; /* Space for copy button */
        }

        .code-block code {
        color: var(--text-primary);
        display: block;
        white-space: pre;
        }

        .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
        }

        .copy-btn:hover {
        background: var(--primary);
        color: white;
        }

        .tag-section {
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        }

        .handbook-content .tag {
        display: inline-block;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        }


        /* Mobile sidebar toggle */
        .handbook-mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px; /* Slightly larger for easier tap */
            height: 50px; /* Slightly larger for easier tap */
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            z-index: 1001; /* Ensure it's above other elements */
            cursor: pointer;
            display: flex; /* Always display as flex to properly center icon */
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        /* Add this new class at the top level of your CSS, not inside a media query */
        body.handbook-overlay-active {
            overflow: hidden; /* Prevent scrolling of content behind modal/sidebar */
        }

        .handbook-mobile-toggle:hover {
        transform: scale(1.05);
        }

        /* Notes Styles */
        .notes-container {
        height: 100%;
        position: relative;
        }

        .notes-list-view, .note-editor-view {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 25px;
        height: 100%;
        overflow-y: auto;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap; /* Allow items to wrap */
            gap: 15px; /* Add gap between items when wrapped */
        }

        .notes-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary);
        }

        .notes-search-container {
        position: relative;
        flex-grow: 1;
        max-width: 400px;
        margin-left: 20px;
        }

        .notes-search {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 1px solid var(--border-light);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        }

        .notes-search:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .notes-search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 14px;
        }

        .new-note-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .new-note-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
        }

        .note-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        }

        .note-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
        }

        .note-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
        }

        .note-card:hover::before {
        opacity: 1;
        }

        .note-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        }

        .note-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.3;
        }

        .note-actions {
        display: flex;
        gap: 8px;
        opacity: 0.2;
        transition: opacity 0.2s ease;
        }

        .note-card:hover .note-actions {
        opacity: 1;
        }

        /* NEW: Styling for pinned notes */
        .note-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
            order: -1; /* Pinned items appear first in flex/grid */
        }

        .note-action-btn.pinned {
            color: var(--accent); /* Color for active pin button */
        }

        .note-action-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
        transition: all 0.2s ease;
        }

        .note-action-btn:hover {
        background: var(--bg-tertiary);
        color: var(--primary);
        }

        .note-action-btn.delete-note:hover {
        color: var(--danger);
        }

        .note-preview {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 15px;
        line-height: 1.5;
        max-height: 120px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
        }

        .note-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-muted);
        }

        .note-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        }

        .note-footer .tag {
        padding: 2px 8px;
        font-size: 11px;
        }

        .notes-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px dashed var(--border-light);
        margin-top: 20px;
        }

        .notes-empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.3;
        }

        /* Note Editor View */
        .note-editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        }

        .note-editor-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary);
        }

        .note-editor-actions {
        display: flex;
        gap: 10px;
        }

        .back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .back-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        }

        .save-note-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .save-note-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--primary-shadow-color-hover);
        }

        .edit-note-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--bg-tertiary);
        color: var(--primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .edit-note-btn:hover {
        background: var(--primary);
        color: white;
        }

        .note-title-input {
        width: 100%;
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        }

        .note-title-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .note-title-input:read-only {
        border-color: transparent;
        background: transparent;
        padding-left: 0;
        padding-right: 0;
        }

        .formatting-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
        }

        .formatting-btn {
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .formatting-btn:hover {
        background: var(--primary);
        color: white;
        }

        .formatting-btn.has-dropdown {
        width: auto;
        padding: 0 12px;
        }

        .note-content-editor {
        min-height: 300px;
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 16px;
        line-height: 1.6;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        overflow-y: auto;
        }

        .note-content-editor:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .note-content-editor[contenteditable="false"] {
        border-color: transparent;
        background: transparent;
        padding-left: 0;
        padding-right: 0;
        }

        .note-content-editor h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 25px 0 15px;
        color: var(--text-primary);
        }

        .note-content-editor h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 20px 0 15px;
        color: var(--text-primary);
        }

        .note-content-editor h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 15px 0 10px;
        color: var(--text-primary);
        }

        .note-content-editor p {
        margin-bottom: 15px;
        }

        .note-content-editor ul, 
        .note-content-editor ol {
        margin-bottom: 15px;
        margin-left: 25px;
        }

        .note-content-editor li {
        margin-bottom: 5px;
        }

        .note-content-editor a {
        color: var(--primary);
        text-decoration: underline;
        }

        .note-tags-section {
        margin-top: 25px;
        }

        .note-tags-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-primary);
        }

        .note-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
        }

        .note-tag {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-radius: 20px;
        font-size: 14px;
        }

        .remove-tag-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        }

        .remove-tag-btn:hover {
        color: var(--danger);
        }

        .tag-input-container {
        display: flex;
        gap: 10px;
        }

        .note-tags-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        }

        .note-tags-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .add-tag-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 15px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .add-tag-btn:hover {
        background: var(--primary);
        color: white;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
        .handbook-container {
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }
        
        .handbook-content-container {
            padding: 20px;
        }
        }

        @media (max-width: 768px) {
        .handbook-container {
            grid-template-columns: 1fr;
        }
        
        .handbook-sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            bottom: 0;
            width: 320px;
            z-index: 1000;
            border-radius: 0;
            transition: left 0.3s ease;
        }
        
        .handbook-sidebar.mobile-open {
            left: 0;
            box-shadow: var(--shadow-lg); /* Add shadow to open sidebar */
        }
                
        .handbook-mobile-toggle {
            display: flex;
            z-index: 1001;
        }
        
        .notes-grid {
            grid-template-columns: 1fr;
        }
        }

        @media (max-width: 480px) {
        .handbook-content-container {
            padding: 15px;
        }
        
        .handbook-content h2 {
            font-size: 24px;
        }
        
        .handbook-content h3 {
            font-size: 20px;
        }
        
        .note-editor-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .formatting-toolbar {
            padding: 8px;
            gap: 3px;
        }
        
        .formatting-btn {
            width: 30px;
            height: 30px;
        }
        }
        /* Handbook Controls */
        .handbook-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
        border: 1px solid var(--border-light);
        }

        .handbook-btn {
        padding: 8px 15px;
        font-size: 14px;
        }

        /* Search Enhancements */
        .handbook-search-container {
        position: relative;
        }

        .handbook-search {
        padding-right: 40px; /* Space for the clear button/icon */
        }

        .handbook-search-icon {
        transition: all 0.2s ease;
        }

        .handbook-search-icon:hover {
        color: var(--primary);
        transform: scale(1.1);
        }

        .handbook-no-results {
        padding: 15px;
        text-align: center;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        }

        .handbook-no-results i {
        font-size: 24px;
        opacity: 0.5;
        }

        /* Search highlights */
        .search-highlight {
        background-color: rgba(255, 170, 0, 0.3);
        border-radius: 3px;
        padding: 2px 0;
        }

        mark.search-highlight {
        background-color: rgba(255, 170, 0, 0.3);
        color: inherit;
        }

        .handbook-nav-item.search-highlight {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid var(--primary);
        }

        /* Section Editor */
        #section-editor-modal .modal-content {
        max-width: 800px;
        }

        #section-editor-content {
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        }

        /* Icon picker tweaks */
        .icon-picker-grid {
        margin-top: 10px;
        max-height: 180px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
        .handbook-controls {
            flex-wrap: wrap;
        }
        
        .handbook-btn {
            flex-grow: 1;
        }
        }

        /* Animation for new/edit controls */
        @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
        }

        .handbook-controls {
        animation: fadeIn 0.3s ease-out;
        }

        /* NEW: Desktop Recommendation Modal Specific Styling */
        #desktopRecommendationModal .modal-content {
            max-width: 550px; /* Make this modal slightly narrower */
            text-align: center;
            padding: 30px; /* Adjust padding as needed */
        }

        #desktopRecommendationModal h3 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #desktopRecommendationModal p {
            font-size: 15px;
        }

        #desktopRecommendationModal .btn {
            margin-top: 10px;
            width: auto; /* Allow button to size itself */
            justify-content: center; /* Center content within the button */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-and-title-container">
                    <div class="header-logo">
                        <img src="./favicon.png" alt="OSINTVault Logo" class="osintvault-logo-img">
                    </div>
                    <div class="header-text-group">
                        <div class="header-title">
                            OSINTVault
                        </div>
                        <span class="header-tagline">Your OSINT tools, always with you.</span>
                    </div>
                </div>
                <div class="controls">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search intelligence tools, techniques, indicators...">
                        <i class="fas fa-search search-icon"></i>
                        <select id="searchScopeSelect">
                            <option value="currentTab">Current Tab</option>
                            <option value="allVault">All Intelligence Vault</option>
                            <option value="allData">All Data</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" id="exportBtn">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn btn-secondary" id="shareOptionsBtn">
                        <i class="fas fa-share-alt"></i>
                        Share
                    </button>
                    <button class="btn btn-secondary" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <i class="fas fa-tools"></i>
                <span>Tools:</span>
                <span class="stat-value" id="totalTools">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-folder"></i>
                <span>Categories:</span>
                <span class="stat-value" id="totalCategories">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-star"></i>
                <span>Starred:</span>
                <span class="stat-value" id="starredToolsCount">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-thumbtack"></i>
                <span>Pinned:</span>
                <span class="stat-value" id="pinnedToolsCount">0</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="sidebar">
                <div class="filter-section">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sort By</label>
                        <select id="sortFilter">
                            <option value="name">Name (A-Z)</option>
                            <option value="recent">Recently Added</option>
                            <option value="popular">Most Used</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <button class="btn btn-secondary" id="showAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-eye"></i>
                        Show All
                    </button>
                    <button class="btn btn-secondary" id="pinAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-thumbtack"></i>
                        Pinned Entries
                    </button>
                    <button class="btn btn-secondary" id="starAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-star"></i>
                        Starred Entries
                    </button>
                    <button class="btn btn-success" id="reportBtn" style="width: 100%;">
                        <i class="fas fa-file-alt"></i>
                        Generate Report
                    </button>
                </div>

                <div class="filter-section" style="margin-top: 25px;">
                    <h3><i class="fas fa-random"></i> Discovery</h3>
                    <div class="random-display" id="randomDiscovery">
                        <div class="random-content-wrapper">
                            <div class="random-display-header">
                                <span class="header-icon"><i class="fas fa-magic"></i></span>
                                <h3 class="header-text">Daily OSINT Discovery</h3>
                            </div>
                            <div class="random-item-placeholder" id="randomItemDisplay">
                                <div class="loading"></div> Loading discovery...
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" id="newRandomBtn">
                            <i class="fas fa-sync-alt"></i> New Discovery
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="intelligence-vault">
                        <i class="fas fa-tools"></i>
                        Intelligence Vault
                    </button>
                    <button class="nav-tab" data-tab="custom-tabs">
                        <i class="fas fa-layer-group"></i>
                        Multi-Vault
                    </button>
                    <button class="nav-tab" data-tab="analytics">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                    <button class="nav-tab" data-tab="threats">
                        <i class="fas fa-exclamation-triangle"></i>
                        Threat Intel
                    </button>
                    <button class="nav-tab" data-tab="handbook">
                        <i class="fas fa-book"></i> OSINT Handbook & Notes
                    </button>
                </div>

                <div class="bulk-actions" id="bulkActions">
                    <span>Selected: <span id="selectedCount">0</span> tools</span>
                    <button class="btn btn-secondary" id="bulkStarBtn">
                        <i class="fas fa-star"></i>
                        Star/Unstar Selected
                    </button>
                    <button class="btn btn-secondary" id="bulkPinBtn">
                        <i class="fas fa-thumbtack"></i>
                        Pin/Unpin Selected
                    </button>
                    <button class="btn btn-danger" id="bulkDeleteBtn">
                        <i class="fas fa-trash"></i>
                        Delete Selected
                    </button>
                </div>

                <div class="tab-content" id="toolsTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Tools Arsenal</h2>
                        <div class="controls">
                            <button class="btn btn-secondary" id="viewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                    
                    <div class="tools-grid" id="toolsGrid">
                        </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-search"></i>
                        <h3>No Tools Found</h3>
                        <p>No intelligence tools match your current search criteria.</p>
                        <button class="btn btn-primary" id="clearFiltersBtn">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <div class="tab-content" id="analyticsTab">
                    <div class="content-header">
                        <h2 class="content-title">Usage Analytics</h2>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="toolsUsed">0</div>
                            <div>Tools Used Today</div>
                        </div>
                    </div>

                    <div class="analytics-section">
                        <h4>Top 5 Most Used Tools</h4>
                        <ul class="analytics-list" id="mostUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noMostUsedTools" style="display:none; padding:20px;">
                            <p>No usage data available yet.</p>
                        </div>
                    </div>

                    <div class="analytics-section">
                        <h4>Tools Never Used</h4>
                        <ul class="analytics-list" id="neverUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noNeverUsedTools" style="display:none; padding:20px;">
                            <p>All tools have been used at least once!</p>
                        </div>
                    </div>

                     <div class="analytics-section">
                        <h4>Tools Added Per Week</h4>
                        <ul class="analytics-list" id="toolsAddedPerWeekList">
                            </ul>
                        <div class="empty-state" id="noToolsAdded" style="display:none; padding:20px;">
                            <p>No tools added recently.</p>
                        </div>
                    </div>

                </div>

                <div class="tab-content" id="threatsTab">
                    <div class="content-header">
                        <h2 class="content-title">Threat Intelligence Feed</h2>
                        <button class="btn btn-primary" id="refreshThreatsBtn">
                            <i class="fas fa-sync"></i>
                            Refresh Feed
                        </button>
                    </div>
                    
                    <div id="threatsList">
                        </div>
                </div>

                <div class="tab-content active" id="intelligence-vaultTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Vault (OSINT Tools)</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="addToolBtnIntelligenceVault">
                                <i class="fas fa-plus-circle"></i>
                                Add New Tool
                            </button>
                            <button class="btn btn-secondary" id="vaultViewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                
                    <div class="nav-tabs" id="intelligenceVaultParentTabs" style="margin-top: 20px;">
                        </div>
                
                    <div class="sub-nav-tabs" id="intelligenceVaultChildTabs" style="display: none; margin-top: 15px;">
                        </div>
                
                    <div class="tools-grid" id="intelligenceVaultEntries" style="margin-top: 20px;">
                        </div>
                
                    <div class="empty-state" id="emptyIntelligenceVaultState" style="display: none;">
                        <i class="fas fa-database"></i>
                        <h3>No Tools Found in This Category</h3>
                        <p>No OSINT tools match your current criteria in this category.</p>
                        <button class="btn btn-primary" id="addToolBtnEmptyState">
                            <i class="fas fa-plus-circle"></i>
                            Add New Tool
                        </button>
                    </div>
                </div>


                <div class="tab-content" id="custom-tabsTab">
                    <div class="content-header">
                        <h2 class="content-title">Multi-Vault: Your Investigations</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="createSubTabBtn">
                                <i class="fas fa-plus"></i>
                                Create Custom Vault
                            </button>
                            <button class="btn btn-secondary" id="editSubTabBtn" style="display: none;">
                                <i class="fas fa-edit"></i>
                                Edit Vault
                            </button>
                            <button class="btn btn-danger" id="deleteSubTabBtn" style="display: none;">
                                <i class="fas fa-trash"></i>
                                Delete Vault
                            </button>
                            <button class="btn btn-secondary" id="exportSubTabBtn" style="display: none;">
                                <i class="fas fa-download"></i>
                                Export Vault
                            </button>
                        </div>
                    </div>

                    <div class="sub-nav-tabs" id="customSubTabs">
                    </div>

                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-success" id="addEntryBtnCustomVault">
                            <i class="fas fa-plus-circle"></i>
                            Add New Entry
                        </button>
                        <button class="btn btn-secondary" id="customVaultViewToggle" title="Switch to List View">
                            <i class="fas fa-list"></i>
                            List View
                        </button>
                    </div>

                    <div class="nav-tabs" id="customVaultEntryParentTabs" style="margin-top: 20px; display: none;">
                        </div>
                
                    <div class="sub-nav-tabs" id="customVaultEntryChildTabs" style="margin-top: 15px; display: none;">
                        </div>

                    <div class="tools-grid" id="customTabToolsGrid" style="margin-top: 20px;">
                        </div>

                    <div class="empty-state" id="emptyCustomTabState" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Custom Vault Yet</h3>
                        <p>Create your first custom vault to organize your investigations!</p>
                        <button class="btn btn-primary" id="createSubTabBtnEmptyState">
                            <i class="fas fa-plus"></i>
                            Create Custom Vault
                        </button>
                    </div>
                    <div class="empty-state" id="emptyCurrentCustomTabState" style="display: none;">
                        <i class="fas fa-clipboard"></i>
                        <h3>No Entries in this Custom Vault</h3>
                        <p>Add tools or collected intelligence to this vault using the "Add New Entry" button.</p>
                    </div>
                </div>

                <div class="tab-content" id="handbookTab">

                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab handbook-subtab active" data-subtab="handbook">
                            <i class="fas fa-book"></i> OSINT Handbook
                        </button>
                        <button class="sub-nav-tab handbook-subtab" data-subtab="notes">
                            <i class="fas fa-sticky-note"></i> My Notes
                        </button>
                    </div>

                    <!-- Handbook Content -->
                    <div class="handbook-subtab-content" id="handbook-content" style="display: block;">
                        <div class="handbook-container">
                            <div class="handbook-sidebar" id="handbook-sidebar">
                                <div class="handbook-search-container">
                                    <input type="text" id="handbook-search" class="handbook-search" placeholder="Search handbook...">
                                    <i class="fas fa-search handbook-search-icon"></i>
                                </div>
                                <!-- Sidebar content will be populated by JS -->
                            </div>
                            
                            <div class="handbook-content-container">
                                <div class="handbook-content" id="handbook-article-area"> </div>
                            </div>
                        </div>
                        
                        <button id="handbook-mobile-toggle" class="handbook-mobile-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    
                    <!-- Notes Content -->
                    <div class="handbook-subtab-content" id="notes-content" style="display: none;">
                        <div class="notes-container">
                            <!-- Notes List View -->
                            <div id="notes-list-view" class="notes-list-view">
                                <div class="notes-header">
                                    <h2 class="notes-title">My Notes</h2>
                                    <div class="notes-search-container">
                                        <input type="text" id="search-notes" class="notes-search" placeholder="Search notes...">
                                        <i class="fas fa-search notes-search-icon"></i>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="noteSortFilter" class="sr-only">Sort Notes</label>
                                        <select id="noteSortFilter" style="padding: 10px 12px; border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);">
                                            <option value="updated_desc">Last Updated (Newest)</option>
                                            <option value="updated_asc">Last Updated (Oldest)</option>
                                            <option value="created_desc">Created (Newest)</option>
                                            <option value="created_asc">Created (Oldest)</option>
                                            <option value="title_asc">Title (A-Z)</option>
                                            <option value="title_desc">Title (Z-A)</option>
                                        </select>
                                    </div>
                                    <button id="new-note-btn" class="new-note-btn">
                                        <i class="fas fa-plus"></i> New Note
                                    </button>
                                </div>
                                
                                <div id="notes-list"></div>
                            </div>
                            
                            <!-- Note Editor View -->
                            <div id="note-editor-view" class="note-editor-view" style="display: none;">
                                <div class="note-editor-header">
                                    <h2 class="note-editor-title">Edit Note</h2>
                                    <div class="note-editor-actions">
                                        <button id="back-to-notes-btn" class="back-btn">
                                            <i class="fas fa-arrow-left"></i> Back to Notes
                                        </button>
                                        <button id="edit-note-btn" class="edit-note-btn" style="display: none;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button id="cancel-edit-note-btn" class="btn btn-secondary" style="display: none;">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                        <button id="save-note-btn" class="save-note-btn">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                    </div>
                                </div>
                                
                                <input type="text" id="note-title-input" class="note-title-input" placeholder="Note Title" maxlength="70">
                                
                                <div id="formatting-toolbar" class="formatting-toolbar">
                                    <button class="formatting-btn" data-command="bold" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="italic" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="underline" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="strikeThrough" title="Strikethrough">
                                        <i class="fas fa-strikethrough"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h1" title="Heading 1">
                                        <i class="fas fa-heading"></i>1
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                                        <i class="fas fa-heading"></i>2
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                                        <i class="fas fa-heading"></i>3
                                    </button>
                                    <button class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="createLink" title="Insert Link">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyLeft" title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyCenter" title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyRight" title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                                
                                <div id="note-content-editor" class="note-content-editor" contenteditable="true"></div>
                                
                                <div class="note-tags-section">
                                    <h3 class="note-tags-header">Tags</h3>
                                    <div id="note-tags-container" class="note-tags-container">
                                        <!-- Tags will be populated by JS -->
                                    </div>
                                    <div id="tag-input-container" class="tag-input-container">
                                        <input type="text" id="note-tags-input" class="note-tags-input" placeholder="Add a tag...">
                                        <button id="add-tag-btn" class="add-tag-btn">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <section class="investigation-wall">
            <div class="wall-texture"></div>
            <div class="floating-particles" id="particles"></div>
            <h2 class="section-title-wall"><i class="fas fa-clipboard-list"></i>Investigation Wall: OSINT Tips & Tricks</h2>
            
            <div class="connecting-lines" id="connecting-lines"></div>
            
            <div class="evidence-grid">
                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 13 15.5l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        Search Techniques
                    </div>
                    <div class="card-content-wall">
                        Use <span class="highlight-wall">Google Dorks</span> for advanced searches. Try operators like site:, filetype:, and intitle: to narrow results. Remember: <span class="highlight-wall">"" for exact phrases</span> and - to exclude terms.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Social Media Intel
                    </div>
                    <div class="card-content-wall">
                        Check <span class="highlight-wall">metadata</span> in images and posts. Use reverse image searches. Look for <span class="highlight-wall">connected accounts</span> across platforms using same usernames or profile pics.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        Documentation
                    </div>
                    <div class="card-content-wall">
                        Always <span class="highlight-wall">screenshot evidence</span> before it disappears. Use timestamps and archive tools like Wayback Machine. Document your <span class="highlight-wall">methodology</span> for legal purposes.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Digital Footprints
                    </div>
                    <div class="card-content-wall">
                        Check <span class="highlight-wall">WHOIS data</span> for domains. Look at DNS records, SSL certificates. Use tools like Shodan for IoT devices. Email headers reveal routing paths.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                        </svg>
                        Privacy & Security
                    </div>
                    <div class="card-content-wall">
                        Use <span class="highlight-wall">VPN and Tor</span> for anonymity. Create separate investigation personas. Never use personal accounts. Clear browser data and use <span class="highlight-wall">incognito mode</span>.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Verification
                    </div>
                    <div class="card-content-wall">
                        <span class="highlight-wall">Cross-reference</span> information from multiple sources. Use fact-checking sites. Verify timestamps and locations. Look for <span class="highlight-wall">digital inconsistencies</span> in manipulated content.
                    </div>
                </div>
            </div>
        </section>

        <div class="modal" id="desktopRecommendationModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: var(--warning);"><i class="fas fa-desktop"></i> Attention: Desktop Recommended</h3>
                <p style="margin-bottom: 15px; color: var(--text-primary);">
                    OSINTVault is primarily designed for desktop use to provide the best experience and access to all features. For optimal functionality, please access this tool on a larger screen.
                </p>
                <p style="margin-bottom: 25px; color: var(--text-secondary);">
                    You can still proceed, but some options may not be fully visible or functional on smaller screens.
                </p>
                <div style="display: flex; justify-content: flex-end;">
                    <button type="button" class="btn btn-primary" id="continueAnywayBtn">
                        <i class="fas fa-arrow-right"></i> Continue Anyway
                    </button>
                </div>
            </div>
        </div>


        <div class="modal" id="addToolOnlyModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Tool</h3>
                <form id="addToolOnlyForm">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolOnlyName" name="toolOnlyName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolOnlyUrl" name="toolOnlyUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolOnlyCategory" required>
                            <option value="">Select Category</option>
                            </select>
                        <input type="text" id="newToolOnlyCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolOnlyDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolOnlyTags" placeholder="osint, investigation, cybersecurity">
                    </div>

                    <div class="custom-tab-assignment" id="intelligenceVaultCategoriesAssignmentAddTool">
                        <h4>Add to Intelligence Vault Categories</h4>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">Select one or more intelligence categories for this tool.</p>
                    
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div style="position: relative;">
                                <input type="text" id="intelligenceVaultCategorySearch" class="search-input" placeholder="Search categories..." style="padding-right: 40px;">
                                <i class="fas fa-search search-icon" style="right: 15px;"></i>
                            </div>
                        </div>
                    
                        <div class="custom-tab-checkboxes-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                            <div class="custom-tab-checkboxes" id="intelligenceVaultCategoriesCheckboxesAddTool">
                                </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" id="cancelAddToolOnly">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Tool</button>
                    </div>
                </form>
            </div>
        </div>

        <footer class="footer-bottom">
            <p>&copy; 2025 OSINTVault. Built for cybersecurity professionals and researchers.</p>
            <p style="margin-top: 10px; font-size: 12px;">
                <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                Secure  Anonymous  Professional
            </p>
        </footer>
    </div>



    <div class="modal" id="addEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Entry</h3>
            <form id="addEntryForm">
                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="entryTypeSelect">
                        <option value="tool">Tool</option>
                        <option value="email">Email Address</option>
                        <option value="phone">Phone Number</option>
                        <option value="crypto">Crypto Transaction</option>
                        <option value="location">Location</option>
                        <option value="link">Social / Internet Link</option>
                        <option value="media">Image / Video</option>
                        <option value="password">Password</option>
                        <option value="keyword">Keyword</option>
                        <option value="social">Social Media Profile</option>
                    </select>
                </div>
                
                <div id="addToolFields" class="entry-fields">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolName" name="toolName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolUrl" name="toolUrl">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolCategory">
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="newCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                </div>
                
                <div id="addEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="emailAddress" name="emailAddress" maxlength="60"  >
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="emailNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="emailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="emailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                </div>
                
                <div id="addPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="phoneNumber" maxlength="15" name="phoneNumber" placeholder="e.g., +1-234-567-8901">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="phoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="phoneLocation" placeholder="e.g., City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="phoneNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="cryptoAddress" name="cryptoAddress" maxlength="120" placeholder="e.g., 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="cryptoTxid" name="cryptoTxid">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" id="cryptoAmount" name="cryptoAmount" placeholder="e.g., 0.005 BTC">
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="cryptoSource" placeholder="exchange, darkweb, personal" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="cryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                </div>
                
                <div id="addLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="locationName" name="locationName" placeholder="e.g., Target building, Suspect's residence" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="locationCoordinates" name="locationCoordinates" placeholder="e.g., 34.0522, -118.2437">
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="locationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="locationNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="locationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                </div>
                
                <div id="addLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="linkUrl" name="linkUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="linkPlatform" placeholder="twitter, reddit, pastebin, forum" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="linkNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="linkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                </div>
                
                <div id="addMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="mediaTitle" name="mediaTitle" maxlength="50" placeholder="e.g., Suspect Photo, Video Evidence">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="mediaNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="mediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload File (Local Only)</label>
                        <input type="file" id="mediaFile" accept="image/*,video/*">
                        <input type="hidden" id="mediaBase64Data"> <small style="color: var(--text-muted);">For local storage only. File will be base64 encoded.</small>
                    </div>
                </div>

                <div id="addPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="passwordService" name="passwordService" placeholder="e.g., Facebook, Gmail, Database">
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="passwordUsername" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="passwordValue" placeholder="e.g., P@ssw0rd123!" maxlength="120">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="passwordNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="passwordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                </div>

                <div id="addKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="keywordValue" name="keywordValue" placeholder="e.g., 'John Doe', 'Project X', 'Confidential'">
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="keywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="keywordNotes" rows="3"></textarea>
                    </div>
                </div>

                <div id="addSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="socialPlatform" name="socialPlatform" placeholder="e.g., Twitter, Instagram, TikTok">
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="socialUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="socialUsername" placeholder="e.g., @suspectprofile" maxlength="60">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="socialNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="socialFollowCounts" maxlength="50" placeholder="e.g., 12k followers, 500 following">
                    </div>
                </div>

                <div class="form-group" id="entrySourceGroup" style="display: none;">
                    <label>Source (Where was this info collected?)</label>
                    <input type="text" id="entrySource" name="entrySource" placeholder="e.g., public record, social media, dark web forum">
                </div>

                <div id="customMetadataGroup" style="display: none;">
                    <label>Custom Metadata</label>
                    <div id="customMetadataEntries">
                        </div>
                    <button type="button" class="btn btn-secondary btn-sm add-metadata-btn" id="addMetadataBtn">
                        <i class="fas fa-plus"></i> Add Metadata Field
                    </button>
                </div>


                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelAddEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-edit"></i> Edit Entry</h3>
            <form id="editEntryForm">
                <input type="hidden" id="editEntryId"> <input type="hidden" id="editEntryType">
                <div id="editToolFields" class="entry-fields">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="editToolName" name="editToolName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editToolUrl" name="editToolUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="editToolCategory" required>
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="editNewCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editToolDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editToolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
    
                    <div class="custom-tab-assignment" id="intelligenceVaultCategoriesAssignmentEditTool">
                        <h4>Add to Intelligence Vault Categories</h4>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">Select one or more intelligence categories for this tool.</p>
    
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div style="position: relative;">
                                <input type="text" id="editIntelligenceVaultCategorySearch" class="search-input" placeholder="Search categories..." style="padding-right: 40px;">
                                <i class="fas fa-search search-icon" style="right: 15px;"></i>
                            </div>
                        </div>
    
                        <div class="custom-tab-checkboxes-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                            <div class="custom-tab-checkboxes" id="intelligenceVaultCategoriesCheckboxesEditTool">
                                </div>
                        </div>
                    </div>
                    </div>
    
                <div id="editEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="editEmailAddress" name="editEmailAddress" maxlength="60" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editEmailNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="editEmailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="editEmailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                </div>
    
                <div id="editPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="editPhoneNumber" name="editPhoneNumber" maxlength="15" placeholder="e.g., +1-234-567-8901" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editPhoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="editPhoneLocation" placeholder="e.g., City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editPhoneNotes" rows="3"></textarea>
                    </div>
                </div>
    
                <div id="editCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="editCryptoAddress" name="editCryptoAddress" maxlength="120" placeholder="e.g., 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa" required>
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="editCryptoTxid" name="editCryptoTxid" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" name="editCryptoAmount" id="editCryptoAmount" placeholder="e.g., 0.005 BTC" required>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="editCryptoSource" placeholder="exchange, darkweb, personal" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editCryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                </div>
    
                <div id="editLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="editLocationName" name="editLocationName" maxlength="50" placeholder="e.g., Target building, Suspect's residence" required>
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="editLocationCoordinates" name="editLocationCoordinates" placeholder="e.g., 34.0522, -118.2437" required>
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="editLocationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editLocationNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="editLocationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                </div>
    
                <div id="editLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editLinkUrl" name="editLinkUrl" placeholder="e.g., https://twitter.com/suspectprofile" required>
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="editLinkPlatform" placeholder="twitter, reddit, pastebin, forum" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editLinkNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editLinkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                </div>
    
                <div id="editMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editMediaTitle" name="editMediaTitle" maxlength="50" placeholder="e.g., Suspect Photo, Video Evidence" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editMediaNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="editMediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload New File (Optional)</label>
                        <input type="file" id="editMediaFile" accept="image/*,video/*">
                        <input type="hidden" id="editMediaBase64Data"> <small style="color: var(--text-muted);">Upload a new file to replace the existing one.</small>
                    </div>
                </div>
    
                <div id="editPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="editPasswordService" name="editPasswordService" placeholder="e.g., Facebook, Gmail, Database">
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="editPasswordUsername" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="editPasswordValue" placeholder="e.g., P@ssw0rd123!" maxlength="120">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editPasswordNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="editPasswordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                </div>
    
                <div id="editKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="editKeywordValue" name="editKeywordValue" placeholder="e.g., 'John Doe', 'Project X', 'Confidential'">
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="editKeywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editKeywordNotes" rows="3"></textarea>
                    </div>
                </div>
    
                <div id="editSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="editSocialPlatform" name="editSocialPlatform" placeholder="e.g., Twitter, Instagram, TikTok">
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="editSocialUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="editSocialUsername" placeholder="e.g., @suspectprofile" maxlength="60">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editSocialNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="editSocialFollowCounts" maxlength="50" placeholder="e.g., 12k followers, 500 following">
                    </div>
                </div>
    
                <div class="form-group" id="editEntrySourceGroup" style="display: none;">
                    <label>Source (Where was this info collected?)</label>
                    <input type="text" id="editEntrySource" name="editEntrySource" placeholder="e.g., public record, social media, dark web forum">
                </div>
    
                <div id="editCustomMetadataGroup" style="display: none;">
                    <label>Custom Metadata</label>
                    <div id="editCustomMetadataEntries">
                        </div>
                    <button type="button" class="btn btn-secondary btn-sm add-metadata-btn" id="editAddMetadataBtn">
                        <i class="fas fa-plus"></i> Add Metadata Field
                    </button>
                </div>
    
    
                <div class="custom-tab-assignment" id="assignCustomTabs">
                    <h4>Assign to Custom Vault Tab(s)</h4>
                    <div class="custom-tab-checkboxes" id="assignCustomTabsCheckboxes">
                        </div>
                </div>
    
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-plus-circle"></i>
                Create New Custom Vault
            </h3>
            <form id="createSubTabForm">
                <div class="form-group">
                    <label>Vault Name</label>
                    <input type="text" id="newSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="newSubTabIcon" placeholder="fas fa-globe">
                    <div class="icon-picker-grid" id="newSubTabIconPicker"></div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="newSubTabColor">
                    <div class="color-picker-grid" id="newSubTabColorPicker"></div>
                </div>
                <div class="form-group">
                    <label>Add Tools to this Vault</label>
                    <div id="newCustomVaultToolSelection" class="custom-tab-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                        </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelCreateSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Vault</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-edit"></i>
                Edit Custom Vault
            </h3>
            <form id="editSubTabForm">
                <input type="hidden" id="editSubTabId">
                <div class="form-group">
                    <label>Vault Name</label>
                    <input type="text" id="editedSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="editedSubTabIcon" placeholder="fas fa-globe">
                     <div class="icon-picker-grid" id="editedSubTabIconPicker"></div>
                </div>
                 <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="editedSubTabColor">
                    <div class="color-picker-grid" id="editedSubTabColorPicker"></div>
                </div>
                <div class="form-group">
                    <label>Tools in this Vault</label>
                    <div id="editCustomVaultToolSelection" class="custom-tab-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                        </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="shareOptionsModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-share-alt"></i> Share Intelligence
            </h3>
            <form id="shareForm">
                <div class="form-group">
                    <label>What would you like to share?</label>
                    <select id="shareScopeSelect">
                        <option value="currentTab">Current Tab (Read-Only View)</option>
                        <option value="allVault">All Intelligence Vault (Read-Only View)</option>
                        <option value="allData">All Data (Read-Only View)</option>
                        <option value="specificCustomTab" style="display:none;">Specific Custom Tab...</option>
                        </select>
                </div>

                <div id="specificCustomTabSelector" class="form-group" style="display:none;">
                    <label>Select a Custom Tab to share:</label>
                    <select id="selectCustomTabForSharing">
                        </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelShareOptions">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Link</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        let appState = {
            tools: [],
            emails: [],
            phones: [],
            crypto: [],
            locations: [],
            links: [],
            media: [], // Stores objects for images/videos
            passwords: [],
            keywords: [],
            socials: [],
            selectedEntries: new Set(), // Now stores IDs of any selected entry type
            currentTab: 'intelligence-vault',
            currentIntelligenceVaultParentTab: 'generalAndCore', // Ensure this is a valid default ID from intelligenceVaultTabStructure
            currentIntelligenceVaultChildTab: 'tools', // Ensure this is a valid default ID from intelligenceVaultTabStructure
            currentCustomVaultEntrySubTab: 'tools', // Default child tab for custom vault entries
            currentCustomVaultParentTab: 'coreInvestigations', // NEW: Default parent tab for custom vault entries
            customTabs: [],
            filters: {
                category: '',
                search: '',
                sort: 'name',
                searchScope: 'currentTab' // New: 'currentTab', 'allVault', 'allData'
            },
            theme: localStorage.getItem('theme') || 'dark', // Load theme from localStorage
            viewMode: localStorage.getItem('viewMode') || 'grid', // 'grid' or 'list'
            usageStats: {
                toolsUsedToday: 0
            },
            // New: for random tips/tools
            osintTips: [
                "Always use a VPN for anonymity during investigations.",
                "Verify your sources: Cross-reference information from multiple independent channels.",
                "Analyze metadata: Hidden data in images and documents can reveal crucial clues.",
                "Utilize archived web pages with tools like the Wayback Machine.",
                "Be mindful of your digital footprint; everything you do online leaves a trace.",
                "Learn advanced search operators for targeted information retrieval.",
                "Understand your target's OPSEC (Operational Security) to anticipate their moves.",
                "Never compromise your own security for an investigation. Think OPSEC first."
            ],
            // New: for shareable tabs
            readOnlyMode: false,
            sharedTabId: null,
            sharedEntryIds: []
        };
        const availableIcons = [
            'fas fa-globe', 'fas fa-search', 'fas fa-fingerprint', 'fas fa-shield-alt',
            'fas fa-link', 'fas fa-network-wired', 'fas fa-envelope', 'fas fa-image',
            'fas fa-map-marker-alt', 'fas fa-book', 'fas fa-coins', 'fas fa-users',
            'fas fa-camera', 'fas fa-lock', 'fas fa-key', 'fas fa-bug', 'fas fa-cloud',
            'fas fa-mobile-alt', 'fas fa-server', 'fas fa-database', 'fas fa-code',
            'fas fa-chart-line', 'fas fa-user-secret', 'fas fa-lightbulb', 'fas fa-laptop-code',
            'fas fa-phone', 'fas fa-money-bill-wave', 'fas fa-video', 'fas fa-paste', 'fas fa-location-arrow',
            'fas fa-font' // For keywords
        ];

        const availableColors = [
            'var(--tab-color-default)', 'var(--tab-color-red)', 'var(--tab-color-blue)',
            'var(--tab-color-green)', 'var(--tab-color-yellow)', 'var(--tab-color-purple)',
            'var(--tab-color-orange)'
        ];

        const defaultTools = [
            {
                id: 'google-advanced-search',
                type: 'tool',
                name: 'Google Advanced Search',
                url: 'https://www.google.com/advanced_search',
                category: 'search engines',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Advanced search operators and techniques for comprehensive information gathering',
                tags: ['search', 'google', 'operators'],
                starred: false,
                pinned: false,
                favicon: 'https://www.google.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-01-15T10:00:00Z'),
                customTabs: [], // Initialize customTabs array
                origin: 'pre-added'
            },
            {
                id: 'shodan',
                type: 'tool',
                name: 'Shodan',
                url: 'https://www.shodan.io',
                category: 'network analysis',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Search engine for Internet-connected devices and systems',
                tags: ['iot', 'network', 'scanning', 'security'],
                starred: true,
                pinned: false,
                favicon: 'https://www.shodan.io/static/img/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-02-20T11:30:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'maltego',
                type: 'tool',
                name: 'Maltego',
                url: 'https://www.maltego.com',
                category: 'network analysis',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Link analysis and data mining application for gathering and connecting information',
                tags: ['analysis', 'visualization', 'mapping'],
                starred: false,
                pinned: true,
                favicon: 'https://www.maltego.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-03-01T14:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'have-i-been-pwned',
                type: 'tool',
                name: 'Have I Been Pwned',
                url: 'https://haveibeenpwned.com',
                category: 'email investigation',
                intelligenceVaultCategories: ['emailTools'], // Assign to 'Email Tools'
                description: 'Check if email addresses have been compromised in data breaches',
                tags: ['breach', 'email', 'security', 'compromise'],
                starred: true,
                pinned: false,
                favicon: 'https://haveibeenpwned.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-04-10T09:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'virustotal',
                type: 'tool',
                name: 'VirusTotal',
                url: 'https://www.virustotal.com',
                category: 'threat intelligence',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Analyze suspicious files and URLs to detect types of malware',
                tags: ['malware', 'analysis', 'threat', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.virustotal.com/gui/images/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-05-05T16:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'wayback-machine',
                type: 'tool',
                name: 'Wayback Machine',
                url: 'https://web.archive.org',
                category: 'archive',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Browse historical snapshots of websites',
                tags: ['archive', 'history', 'web', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://web.archive.org/static/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-06-01T08:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'whois-lookup',
                type: 'tool',
                name: 'WHOIS Lookup',
                url: 'https://whois.net',
                category: 'domain research',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Domain registration and ownership information',
                tags: ['domain', 'registration', 'ownership'],
                starred: false,
                pinned: false,
                favicon: 'https://whois.net/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-07-12T13:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'tineye',
                type: 'tool',
                name: 'TinEye',
                url: 'https://tineye.com',
                category: 'image analysis',
                intelligenceVaultCategories: ['mediaTools'], // Assign to 'Media Tools'
                description: 'Reverse image search engine',
                tags: ['image', 'reverse', 'search', 'verification'],
                starred: false,
                pinned: false,
                favicon: 'https://tineye.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-08-20T10:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },{
                id: 'tor-browser',
                type: 'tool',
                name: 'Tor Browser',
                url: 'https://www.torproject.org/',
                category: 'anonymity',
                intelligenceVaultCategories: ['darkWebTools'], // Assign to 'DarkWeb'
                description: 'Free and open-source software for enabling anonymous communication.',
                tags: ['anonymity', 'privacy', 'darkweb', 'browser'],
                starred: false,
                pinned: false,
                favicon: 'https://www.torproject.org/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-01T08:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'nmap',
                type: 'tool',
                name: 'Nmap (Network Mapper)',
                url: 'https://nmap.org/',
                category: 'network scanning',
                intelligenceVaultCategories: ['vulnerabilityTools'], // Assign to 'Vulnerability'
                description: 'Free and open-source utility for network discovery and security auditing.',
                tags: ['network', 'scanning', 'vulnerability', 'auditing'],
                starred: false,
                pinned: false,
                favicon: 'https://nmap.org/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-05T10:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'any-run',
                type: 'tool',
                name: 'Any.Run',
                url: 'https://any.run/',
                category: 'malware analysis',
                intelligenceVaultCategories: ['fileMalwareTools'], // Assign to 'File/Malware'
                description: 'Interactive malware analysis service for dynamic investigation of threats.',
                tags: ['malware', 'analysis', 'sandbox', 'threats'],
                starred: false,
                pinned: false,
                favicon: 'https://any.run/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-10T12:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'splunk-phantom',
                type: 'tool',
                name: 'Splunk SOAR (Phantom)',
                url: 'https://www.splunk.com/en_us/software/security-orchestration-automation-response-phantom.html',
                category: 'security orchestration',
                intelligenceVaultCategories: ['threatIntelligenceTools'], // Assign to 'Threat Intelligence'
                description: 'Security Orchestration, Automation, and Response platform.',
                tags: ['soar', 'automation', 'threat-intel', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.splunk.com/etc/designs/splunk-website/clientlibs-all/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-15T14:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'openai-chatgpt',
                type: 'tool',
                name: 'OpenAI ChatGPT',
                url: 'https://chat.openai.com/',
                category: 'ai assistant',
                intelligenceVaultCategories: ['aiTools'], // Assign to 'AI'
                description: 'AI-powered chatbot for various tasks including data summarization and idea generation.',
                tags: ['ai', 'chatbot', 'generative-ai', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://chat.openai.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-20T16:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            }
        ];

        const intelligenceVaultTabStructure = [
        {
            id: 'generalAndCore',
            name: 'General & Core',
            icon: 'fas fa-globe-americas',
            children: [
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
                { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
                { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' }, // NEW
                { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' }, // NEW
            ]
        },
        {
            id: 'identityAndSocial',
            name: 'Identity & Social',
            icon: 'fas fa-users',
            children: [
                { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
                { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' }, // NEW
                { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' }, // NEW
            ]
        },
        {
            id: 'technicalFootprints',
            name: 'Technical Footprints',
            icon: 'fas fa-fingerprint',
            children: [
                { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' }, // Name adjusted for clarity
                { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' }, // Name adjusted
                { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' }, // Name adjusted
                { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' }, // NEW
                { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' }, // NEW
            ]
        },
        {
            id: 'cybersecurityIntel',
            name: 'Cybersecurity Intel',
            icon: 'fas fa-shield-alt',
            children: [
                { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' }, // NEW (Font Awesome 6)
                { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' }, // NEW
            ]
        },
        {
            id: 'breachAndLeaks',
            name: 'Breach & Leaks',
            icon: 'fas fa-database',
            children: [
                { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' }, // Renamed from passwordTools
                { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' }, // Renamed from Dump Search Engines
                { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' }, // NEW (Font Awesome 6)
            ]
        },
        {
            id: 'undergroundSources',
            name: 'Underground Sources',
            icon: 'fas fa-user-ninja',
            children: [
                { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' }, // Name adjusted
                { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
                { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' }, // NEW (Font Awesome Brands)
                { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' }, // NEW
            ]
        },
        // NEW PARENT CATEGORY: Media Analysis
        {
            id: 'mediaAnalysis',
            name: 'Media Analysis',
            icon: 'fas fa-image',
            children: [
                { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' }, // Moved from Identity & Social
                { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' }, // NEW
                { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' }, // NEW
                { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' }, // NEW (Font Awesome 6)
                { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' }, // NEW
            ]
        },
        // NEW PARENT CATEGORY: Operational Security (OPSEC)
        {
            id: 'opsec',
            name: 'Operational Security',
            icon: 'fas fa-lock',
            children: [
                { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' }, // Broadening DarkWebTools concept
                { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' }, // NEW
                { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' }, // NEW
                { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' }, // NEW
            ]
        },
        ];

        const customVaultEntryStructure = [
            {
                id: 'coreInvestigations',
                name: 'Core Investigations',
                icon: 'fas fa-search',
                children: [
                    { id: 'tools', name: 'Tools', icon: 'fas fa-tools' },
                    { id: 'keywords', name: 'Keywords', icon: 'fas fa-font' },
                    { id: 'links', name: 'Domain/IP', icon: 'fas fa-globe' }
                ]
            },
            {
                id: 'identityCommunications',
                name: 'Identity & Communications',
                icon: 'fas fa-id-card',
                children: [
                    { id: 'emails', name: 'Emails', icon: 'fas fa-envelope' },
                    { id: 'phones', name: 'Phones', icon: 'fas fa-phone' },
                    { id: 'socials', name: 'Socials', icon: 'fas fa-users' }
                ]
            },
            {
                id: 'digitalTraces',
                name: 'Digital Traces',
                icon: 'fas fa-fingerprint',
                children: [
                    { id: 'media', name: 'Media', icon: 'fas fa-camera' },
                    { id: 'crypto', name: 'Crypto', icon: 'fas fa-coins' },
                    { id: 'locations', name: 'Locations', icon: 'fas fa-map-marker-alt' }
                ]
            },
            {
                id: 'sensitiveData',
                name: 'Sensitive Data',
                icon: 'fas fa-lock',
                children: [
                    { id: 'passwords', name: 'Passwords', icon: 'fas fa-key' }
                ]
            }
        ];



        let notesState = {
            notes: [],
            currentNote: null,
            editMode: false,
            // NEW: Add sort filter for notes
            noteSortFilter: localStorage.getItem('noteSortFilter') || 'updated_desc'
        };

        // OSINT Handbook main functionality
        const handbookData = {
        sections: [
            {
            id: "getting-started",
            title: "Getting Started",
            icon: "fas fa-rocket",
            content: `
                <h2>Getting Started with OSINT</h2>
                <p>Open Source Intelligence (OSINT) is the collection and analysis of information from publicly available sources. This handbook will guide you through essential techniques, tools, and methodologies.</p>
                
                <h3>Basic Principles</h3>
                <p>Remember these fundamental principles when conducting OSINT investigations:</p>
                <ul>
                <li>Use secure, anonymous connections (VPNs, Tor)</li>
                <li>Create separate research personas</li>
                <li>Document everything</li>
                <li>Verify information through multiple sources</li>
                <li>Follow legal and ethical guidelines</li>
                </ul>
            `,
            },
            {
            id: "osint-framework",
            title: "OSINT Framework Overview",
            icon: "fas fa-sitemap",
            content: `
                <h2>OSINT Framework Overview</h2>
                <p>The OSINT Framework provides a structured approach to gathering intelligence across various domains.</p>
                
                <h3>Key Components</h3>
                <ul>
                <li><strong>Reconnaissance</strong>: Initial information gathering</li>
                <li><strong>Identification</strong>: Pinpointing relevant data sources</li>
                <li><strong>Collection</strong>: Systematic gathering of intelligence</li>
                <li><strong>Processing</strong>: Organizing and filtering collected data</li>
                <li><strong>Analysis</strong>: Deriving insights and connections</li>
                <li><strong>Reporting</strong>: Documenting findings in a structured format</li>
                </ul>
                
                <h3>OSINT Cycle</h3>
                <p>The OSINT process is cyclical, with each phase informing the next. As new information is discovered, you may need to revisit earlier phases to refine your search parameters.</p>
                
                <div class="code-block">
                <pre><code>Planning  Collection  Processing  Analysis  Dissemination  Feedback  Planning</code></pre>
                <button class="copy-btn" data-clipboard-target="#osint-cycle-code"><i class="fas fa-copy"></i></button>
                </div>
            `,
            },
            {
            id: "tools-category",
            title: "Tools by Category",
            icon: "fas fa-tools",
            isCategory: true,
            subcategories: [
                {
                id: "people-search",
                title: "People Search",
                icon: "fas fa-user-secret",
                content: `
                    <h2>People Search Tools</h2>
                    <p>These tools help locate and gather information about individuals through public records, social media, and other sources.</p>
                    
                    <h3>Essential Tools</h3>
                    <ul>
                    <li><strong>Pipl</strong>: Comprehensive people search engine</li>
                    <li><strong>BeenVerified</strong>: Background check service</li>
                    <li><strong>Spokeo</strong>: People search and public records</li>
                    <li><strong>PeekYou</strong>: Searches across social networks</li>
                    <li><strong>WebMii</strong>: Person-centric web search</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Validate a phone number pattern */
        const validatePhone = (phone) => {
        const regex = /^(\+\d{1,2}\s)?\(?\d{3}\)?[\s.-]\d{3}[\s.-]\d{4}$/;
        return regex.test(phone);
        }</code></pre>
                    <button class="copy-btn" data-clipboard-target="#phone-validate-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">people</span>
                    <span class="tag">social</span>
                    <span class="tag">identity</span>
                    <span class="tag">background</span>
                    </div>
                `,
                },
                {
                id: "domain-whois",
                title: "Domain/WHOIS",
                icon: "fas fa-globe",
                content: `
                    <h2>Domain & WHOIS Investigation Tools</h2>
                    <p>These tools allow investigators to gather information about domain registrations, ownership, and infrastructure.</p>
                    
                    <h3>Key Tools</h3>
                    <ul>
                    <li><strong>WHOIS Lookup</strong>: Domain registration information</li>
                    <li><strong>DomainTools</strong>: Domain profile and history</li>
                    <li><strong>ViewDNS.info</strong>: Multiple DNS research tools</li>
                    <li><strong>Shodan</strong>: Internet-connected device search engine</li>
                    <li><strong>SecurityTrails</strong>: Historical DNS data</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Basic WHOIS lookup using command line */
        whois example.com

        /* Reverse IP lookup using host command */
        host example.com</code></pre>
                    <button class="copy-btn" data-clipboard-target="#whois-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">domain</span>
                    <span class="tag">dns</span>
                    <span class="tag">hosting</span>
                    <span class="tag">infrastructure</span>
                    </div>
                `,
                },
                {
                id: "crypto-tracking",
                title: "Crypto Tracking",
                icon: "fas fa-coins",
                content: `
                    <h2>Cryptocurrency Tracking Tools</h2>
                    <p>These tools help track and analyze cryptocurrency transactions, wallets, and entities across various blockchains.</p>
                    
                    <h3>Essential Tools</h3>
                    <ul>
                    <li><strong>Blockchain.com Explorer</strong>: Bitcoin blockchain analysis</li>
                    <li><strong>Etherscan</strong>: Ethereum blockchain explorer</li>
                    <li><strong>Chainalysis</strong>: Advanced cryptocurrency investigation</li>
                    <li><strong>CipherTrace</strong>: Financial crime tracking in crypto</li>
                    <li><strong>Crystal Blockchain</strong>: Crypto AML and analytics</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Example API call to get Bitcoin address information */
        curl -X GET "https://blockchain.info/rawaddr/1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"</code></pre>
                    <button class="copy-btn" data-clipboard-target="#crypto-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">crypto</span>
                    <span class="tag">blockchain</span>
                    <span class="tag">bitcoin</span>
                    <span class="tag">ethereum</span>
                    </div>
                `,
                }
            ]
            },
            {
            id: "techniques",
            title: "Techniques",
            icon: "fas fa-lightbulb",
            isCategory: true,
            subcategories: [
                {
                id: "pivoting",
                title: "Pivoting",
                icon: "fas fa-network-wired",
                content: `
                    <h2>Pivoting Techniques</h2>
                    <p>Pivoting is the process of using discovered information to find new leads and expand your investigation.</p>
                    
                    <h3>Key Pivoting Methods</h3>
                    <ul>
                    <li><strong>Email Pivoting</strong>: Use email addresses to discover accounts across platforms</li>
                    <li><strong>Username Pivoting</strong>: Track usernames across multiple services</li>
                    <li><strong>Image Pivoting</strong>: Use reverse image search to find related content</li>
                    <li><strong>Network Pivoting</strong>: Map connections between people and organizations</li>
                    <li><strong>Domain Pivoting</strong>: Find related websites and infrastructure</li>
                    </ul>
                    
                    <h3>Practical Example</h3>
                    <p>Starting with an email address, you might:</p>
                    <ol>
                    <li>Check email breach databases for password history</li>
                    <li>Search for the email in document metadata</li>
                    <li>Use the username portion to search social platforms</li>
                    <li>Look up the domain for related websites</li>
                    <li>Search for the email in forum posts and comments</li>
                    </ol>
                    
                    <div class="tag-section">
                    <span class="tag">pivoting</span>
                    <span class="tag">methodology</span>
                    <span class="tag">investigation</span>
                    </div>
                `,
                },
                {
                id: "sock-puppets",
                title: "Sock Puppet Accounts",
                icon: "fas fa-user-secret",
                content: `
                    <h2>Sock Puppet Accounts</h2>
                    <p>Sock puppets are alternate online identities created for research purposes to protect your real identity during investigations.</p>
                    
                    <h3>Creation Guidelines</h3>
                    <ul>
                    <li>Use a dedicated device or VM if possible</li>
                    <li>Always access through VPN/Tor</li>
                    <li>Create a complete, consistent backstory</li>
                    <li>Use generated photos for profiles (never your own)</li>
                    <li>Maintain regular activity to build history</li>
                    <li>Never connect to personal accounts or information</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* OPSEC checklist for sock puppets */
        1. Separate email account
        2. Unique username not used elsewhere
        3. Unique password not used elsewhere
        4. 2FA on a dedicated device
        5. Consistent profile details
        6. Regular login patterns
        7. No personal information leakage</code></pre>
                    <button class="copy-btn" data-clipboard-target="#sockpuppet-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">identity</span>
                    <span class="tag">opsec</span>
                    <span class="tag">anonymity</span>
                    </div>
                `,
                }
            ]
            },
            {
            id: "cheat-sheets",
            title: "Cheat Sheets",
            icon: "fas fa-file-alt",
            isCategory: true,
            subcategories: [
                {
                id: "command-line",
                title: "Command Line Tools",
                icon: "fas fa-terminal",
                content: `
                    <h2>Command Line OSINT Tools</h2>
                    <p>These command-line tools can significantly enhance your OSINT capabilities and automation.</p>
                    
                    <h3>Essential CLI Tools</h3>
                    <div class="code-block">
                    <pre><code># Recon-ng - Full-featured reconnaissance framework
        pip install recon-ng

        # TheHarvester - Email, subdomain and name harvester
        theHarvester -d example.com -b google,linkedin

        # Sherlock - Hunt down social media accounts by username
        python3 sherlock username

        # Amass - In-depth DNS enumeration
        amass enum -d example.com

        # Shodan CLI - Internet device search
        shodan search --fields ip_str,port,org,hostnames apache</code></pre>
                    <button class="copy-btn" data-clipboard-target="#cli-tools-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <h3>Quick Reference: Google Dorks</h3>
                    <div class="code-block">
                    <pre><code># Find specific file types
        filetype:pdf "confidential"

        # Search within a site
        site:example.com password

        # Find exposed directories
        intitle:"index of" "parent directory"

        # Find exposed cameras
        intitle:"webcamXP 5"

        # Find exposed databases
        intitle:"Index of" phpmyadmin</code></pre>
                    <button class="copy-btn" data-clipboard-target="#google-dorks-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">cli</span>
                    <span class="tag">terminal</span>
                    <span class="tag">automation</span>
                    <span class="tag">dorks</span>
                    </div>
                `,
                }
            ]
            }
        ]
        };

        // Initialize Application
        function initApp() {
            loadState();
            parseShareableLink();
            updateStats();
            // Bind events BEFORE calling switchTab to ensure listeners are ready
            bindEvents(); 
            initTheme();

            checkAndShowDesktopRecommendation();

            const validTabs = ['intelligence-vault', 'custom-tabs', 'analytics', 'threats', 'handbook'];
            if (!validTabs.includes(appState.currentTab)) {
                appState.currentTab = 'intelligence-vault'; // Default to intelligence-vault if invalid
            }

            // Call switchTab to set up the initial active tab and its content
            switchTab(appState.currentTab);

            // Re-render all necessary parts that depend on the initial state
            showRandomDiscovery();
            populateCategoryFilter();
            updateAnalytics(); // Ensure analytics are up to date
            applyReadOnlyMode(); // Apply read-only mode if shared link is active

            // Update view toggle buttons based on saved view mode
            const viewToggleButtons = document.querySelectorAll('#viewToggle, #vaultViewToggle, #customVaultViewToggle');
            viewToggleButtons.forEach(btn => {
                if (appState.viewMode === 'grid') {
                    btn.innerHTML = '<i class="fas fa-list"></i> List View';
                    btn.title = 'Switch to List View';
                } else {
                    btn.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    btn.title = 'Switch to Grid View';
                }
            });
        }

        // Switch main tabs
        function switchTab(tabName) {
            // Update main tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                 targetTabContent.classList.add('active');
            }

            // Update appState and clear filters for new tab
            appState.currentTab = tabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = '';
            document.getElementById('searchInput').value = '';

            // Hide all potential sub-tab containers and add entry buttons by default
            document.getElementById('intelligenceVaultParentTabs').style.display = 'none';
            document.getElementById('intelligenceVaultChildTabs').style.display = 'none';
            document.getElementById('customVaultEntryParentTabs').style.display = 'none';
            document.getElementById('customVaultEntryChildTabs').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none'; // Ensure this is handled too

            // Specific logic for each main tab
            if (tabName === 'intelligence-vault') {
                document.getElementById('intelligenceVaultParentTabs').style.display = 'flex'; // Show parent tabs
                renderIntelligenceVaultParentTabs(); // Render intelligence vault parent tabs

                // Ensure a valid parent is selected, default if current one is invalid
                const currentIntelParent = intelligenceVaultTabStructure.find(p => p.id === appState.currentIntelligenceVaultParentTab);
                if (!currentIntelParent) {
                    appState.currentIntelligenceVaultParentTab = intelligenceVaultTabStructure[0].id;
                }
                // Now, switch to the determined parent and then its child
                switchIntelligenceVaultParentTab(appState.currentIntelligenceVaultParentTab);

                // Show the "Add New Tool" button
                if (!appState.readOnlyMode) {
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'inline-flex';
                }

            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render main custom tabs (the list of custom vaults)

                // Only proceed to render/switch parent/child entry tabs if custom vaults exist
                if (appState.customTabs.length > 0) {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'flex'; // Show parent tabs for entries
                    renderCustomVaultParentTabs(); // Render custom vault entry parent tabs

                    // Ensure a valid parent is selected, default if current one is invalid
                    const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
                    if (!currentCustomParent) {
                        appState.currentCustomVaultParentTab = customVaultEntryStructure[0].id;
                    }
                    // Ensure a valid child is selected under the current parent, default if invalid
                    const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                    if (!currentCustomChild) {
                        appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                    }
                    // Now, switch to the determined parent and then its child
                    switchCustomVaultParentTab(appState.currentCustomVaultParentTab);

                    // Show the "Add New Entry" button for custom vaults
                    if (!appState.readOnlyMode) {
                        document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                    }
                }

            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'handbook') {
                initHandbookAndNotes(); // Ensure handbook and notes are initialized
            }

            renderIntelligenceEntries(); // Always re-render entries relevant to the currently active main tab
            saveState(); // Save state after tab switch
        }

        // NEW: Render Intelligence Vault Parent Tabs
        function renderIntelligenceVaultParentTabs() {
            const parentTabsContainer = document.getElementById('intelligenceVaultParentTabs');
            if (!parentTabsContainer) return;

            // Clear previous content to ensure new buttons are rendered clean
            parentTabsContainer.innerHTML = ''; 

            intelligenceVaultTabStructure.map(parentTab => {
                const button = document.createElement('button');
                button.classList.add('nav-tab', 'intelligence-vault-parent-tab');
                button.dataset.parentTab = parentTab.id;
                button.innerHTML = `<i class="${parentTab.icon}"></i> ${parentTab.name}`;
                parentTabsContainer.appendChild(button);
            });

            // Re-attach event listener using delegation to the container (if it exists, and not already done)
            // This listener is now only set up once in bindEvents to avoid duplicates.
            // When renderIntelligenceVaultParentTabs is called, it just re-populates the innerHTML.
            // The event listener is attached to the parentTabsContainer, which persists.

            // Activate the currently selected parent tab
            const activeParentBtn = parentTabsContainer.querySelector(`.intelligence-vault-parent-tab[data-parent-tab="${appState.currentIntelligenceVaultParentTab}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }
        }


        // NEW: Switch Intelligence Vault Parent Tab
        function switchIntelligenceVaultParentTab(parentId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all parent tabs
            document.querySelectorAll('#intelligenceVaultParentTabs .intelligence-vault-parent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked parent tab
            const activeParentBtn = document.querySelector(`#intelligenceVaultParentTabs .intelligence-vault-parent-tab[data-parent-tab="${parentId}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }

            appState.currentIntelligenceVaultParentTab = parentId;

            // Find the selected parent tab's children
            const selectedParent = intelligenceVaultTabStructure.find(p => p.id === parentId);
            const childTabsContainer = document.getElementById('intelligenceVaultChildTabs'); // Get the direct reference

            if (selectedParent && childTabsContainer) {
                childTabsContainer.style.display = 'flex'; // Show the child tabs container
                // Update the innerHTML of the existing container
                childTabsContainer.innerHTML = selectedParent.children.map(childTab => `
                    <button class="sub-nav-tab intelligence-vault-child-tab" data-child-tab="${childTab.id}">
                        <i class="${childTab.icon}"></i> ${childTab.name}
                    </button>
                `).join('');

                // The click listener for child tabs is already delegated to `intelligenceVaultChildTabsContainer`
                // in `bindEvents()`, so no need to re-add it here.

                // Automatically activate the first child tab or the previously selected child tab under this parent
                let childToActivate = appState.currentIntelligenceVaultChildTab;
                if (!selectedParent.children.some(c => c.id === childToActivate)) {
                    childToActivate = selectedParent.children[0]?.id; // Default to first child if current is not in this parent
                }
                if (childToActivate) {
                    switchIntelligenceVaultChildTab(childToActivate);
                } else {
                    // No child tabs for this parent, clear display
                    appState.currentIntelligenceVaultChildTab = null;
                    appState.filters.category = '';
                    renderIntelligenceEntries();
                }

            } else {
                childTabsContainer.style.display = 'none'; // Hide if no children or container not found
                appState.currentIntelligenceVaultChildTab = null;
                appState.filters.category = '';
                renderIntelligenceEntries();
            }

            saveState(); // Save the parent tab state
        }

        // MODIFIED: Switch Intelligence Vault Child Sub-tabs (now show tools)
        // This function now expects a 'childId' which maps directly to the `intelligenceVaultCategories` (tools, emailTools, etc.)
        function switchIntelligenceVaultChildTab(childId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all child tabs
            document.querySelectorAll('#intelligenceVaultChildTabs .intelligence-vault-child-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked child tab
            const targetChildTabBtn = document.querySelector(`#intelligenceVaultChildTabs .intelligence-vault-child-tab[data-child-tab="${childId}"]`);
            if (targetChildTabBtn) {
                targetChildTabBtn.classList.add('active');
            }

            appState.currentIntelligenceVaultChildTab = childId;
            appState.filters.category = ''; // Clear category filter when switching intel vault sub-tabs
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant tools
            saveState(); // Save the child tab state
        }

        // Load application state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('osintArsenalState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                // Correctly parse dates and ensure all new properties exist
                appState.tools = (parsedState.tools || []).map(entry => ({
                    ...entry,
                    addedDate: new Date(entry.addedDate), // Convert string back to Date object
                    lastUsed: entry.lastUsed || 0, // Ensure lastUsed is a number, default to 0
                    customTabs: entry.customTabs || [], // Ensure customTabs array exists
                    intelligenceVaultCategories: entry.intelligenceVaultCategories || [], // NEW: Initialize new property
                    origin: entry.origin || 'user-added' // <--- IMPORTANT: Default to 'user-added' for old saved data if origin is missing
                }));
                // Load new entry types
                appState.emails = parsedState.emails || [];
                appState.phones = parsedState.phones || [];
                appState.crypto = parsedState.crypto || [];
                appState.locations = parsedState.locations || [];
                appState.links = parsedState.links || [];
                appState.media = parsedState.media || [];
                appState.passwords = parsedState.passwords || [];
                appState.keywords = parsedState.keywords || [];
                appState.socials = parsedState.socials || [];

                appState.selectedEntries = new Set(Array.isArray(parsedState.selectedEntries) ? parsedState.selectedEntries : []);
                appState.filters = parsedState.filters || {
                    category: '',
                    search: '',
                    sort: 'name',
                    searchScope: 'currentTab'
                };
                appState.theme = parsedState.theme || 'dark';
                appState.viewMode = parsedState.viewMode || 'grid';
                appState.usageStats = parsedState.usageStats || {
                    toolsUsedToday: 0
                };
                appState.customTabs = parsedState.customTabs || [];
                appState.currentCustomTab = parsedState.currentCustomTab || (appState.customTabs.length > 0 ? appState.customTabs[0].id : null);

                // Ensure parent/child tabs exist and have valid defaults if needed
                // IMPORTANT: Ensure these default IDs exist in your respective structures
                appState.currentIntelligenceVaultParentTab = parsedState.currentIntelligenceVaultParentTab || 'generalAndCore';
                appState.currentIntelligenceVaultChildTab = parsedState.currentIntelligenceVaultChildTab || 'tools';
                appState.currentCustomVaultParentTab = parsedState.currentCustomVaultParentTab || 'coreInvestigations';
                appState.currentCustomVaultEntrySubTab = parsedState.currentCustomVaultEntrySubTab || 'tools';


                // *** CRUCIAL PART: Merge default tools after loading saved state ***
                defaultTools.forEach(defaultTool => {
                    // Check if a tool with this ID already exists in the loaded appState.tools
                    const exists = appState.tools.some(tool => tool.id === defaultTool.id);
                    if (!exists) {
                        // If it doesn't exist, add it. Ensure origin is 'pre-added' and date is parsed.
                        appState.tools.push({ ...defaultTool, addedDate: new Date(defaultTool.addedDate), origin: 'pre-added' });
                    }
                });

            } else {
                // If no saved state exists (first-time user), initialize with default tools
                appState.tools = defaultTools.map(tool => ({ ...tool, origin: 'pre-added' }));
                appState.customTabs = [{
                    id: generateId(),
                    name: 'Crypto',
                    toolIds: [],
                    icon: 'fas fa-coins',
                    color: 'var(--tab-color-yellow)'
                }, {
                    id: generateId(),
                    name: 'Social Media Analysis',
                    toolIds: [],
                    icon: 'fas fa-users',
                    color: 'var(--tab-color-blue)'
                }];
                appState.currentCustomTab = appState.customTabs[0]?.id || null;

                // Set initial default parent/child tabs for first-time users
                appState.currentIntelligenceVaultParentTab = 'generalAndCore';
                appState.currentIntelligenceVaultChildTab = 'tools';
                appState.currentCustomVaultParentTab = 'coreInvestigations';
                appState.currentCustomVaultEntrySubTab = 'tools';

                // Initialize empty arrays for new types if starting fresh
                appState.emails = [];
                appState.phones = [];
                appState.crypto = [];
                appState.locations = [];
                appState.links = [];
                appState.media = [];
                appState.passwords = [];
                appState.keywords = [];
                appState.socials = [];
            }
        }

        

        // Save application state to localStorage
        function saveState() {
            localStorage.setItem('osintArsenalState', JSON.stringify(appState));
        }

        // Update statistics
        function updateStats() {
            // Include new types in allEntries
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const categories = new Set(appState.tools.map(tool => tool.category)); // Only tools have categories for now
            document.getElementById('totalTools').textContent = allEntries.length; // Count all entries, not just tools
            document.getElementById('totalCategories').textContent = categories.size;
            document.getElementById('starredToolsCount').textContent = allEntries.filter(entry => entry.starred).length;
            document.getElementById('pinnedToolsCount').textContent = allEntries.filter(entry => entry.pinned).length;
        }

        // Populate category filter and Add Tool modal
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const toolCategorySelect = document.getElementById('toolCategory');
            const editToolCategorySelect = document.getElementById('editToolCategory');
            const toolOnlyCategorySelect = document.getElementById('toolOnlyCategory'); // For Add Tool Only Modal

            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));

            // Add static options
            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation',
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...Array.from(existingCategories)]);

            // Clear existing options
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            editToolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            toolOnlyCategorySelect.innerHTML = '<option value="">Select Category</option>';


            // Sort categories alphabetically for dropdowns
            const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));

            sortedCategories.forEach(category => {
                // Filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(filterOption);

                // Add Tool dropdown
                const toolOption = document.createElement('option');
                toolOption.value = category;
                toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolCategorySelect.appendChild(toolOption);

                // Edit Tool dropdown
                const editToolOption = document.createElement('option');
                editToolOption.value = category;
                editToolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                editToolCategorySelect.appendChild(editToolOption);

                // Add Tool Only dropdown
                const toolOnlyOption = document.createElement('option');
                toolOnlyOption.value = category;
                toolOnlyOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolOnlyCategorySelect.appendChild(toolOnlyOption);
            });

            // Add "Custom" option to tool category select
            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);

            // Add "Custom" option to toolOnlyCategorySelect
            const customOptionAddToolOnly = document.createElement('option');
            customOptionAddToolOnly.value = 'custom';
            customOptionAddToolOnly.textContent = 'Custom Category';
            toolOnlyCategorySelect.appendChild(customOptionAddToolOnly);

            const customOptionEdit = document.createElement('option');
            customOptionEdit.value = 'custom';
            customOptionEdit.textContent = 'Custom Category';
            editToolCategorySelect.appendChild(customOptionEdit);


            // Set selected values for filters
            categoryFilter.value = appState.filters.category;
            document.getElementById('sortFilter').value = appState.filters.sort;
        }

        function renderIntelligenceEntries() {
            const toolsContainer = document.getElementById('toolsGrid');
            const customTabToolsContainer = document.getElementById('customTabToolsGrid');
            const intelligenceVaultEntriesContainer = document.getElementById('intelligenceVaultEntries');
            const emptyState = document.getElementById('emptyState');
            const emptyCustomTabState = document.getElementById('emptyCustomTabState');
            const emptyCurrentCustomTabState = document.getElementById('emptyCurrentCustomTabState');
            const emptyIntelligenceVaultState = document.getElementById('emptyIntelligenceVaultState');

            // References for parent/child tabs
            const intelligenceVaultParentTabs = document.getElementById('intelligenceVaultParentTabs');
            const intelligenceVaultChildTabs = document.getElementById('intelligenceVaultChildTabs');
            const customVaultEntryParentTabs = document.getElementById('customVaultEntryParentTabs');
            const customVaultEntryChildTabs = document.getElementById('customVaultEntryChildTabs');


            // Hide all empty states and containers initially
            toolsContainer.style.display = 'none';
            customTabToolsContainer.style.display = 'none';
            intelligenceVaultEntriesContainer.style.display = 'none';
            emptyState.style.display = 'none';
            emptyCustomTabState.style.display = 'none';
            emptyCurrentCustomTabState.style.display = 'none';
            emptyIntelligenceVaultState.style.display = 'none';

            // Also hide all tab containers by default, they will be explicitly shown below
            if (intelligenceVaultParentTabs) intelligenceVaultParentTabs.style.display = 'none';
            if (intelligenceVaultChildTabs) intelligenceVaultChildTabs.style.display = 'none';
            if (customVaultEntryParentTabs) customVaultEntryParentTabs.style.display = 'none';
            if (customVaultEntryChildTabs) customVaultEntryChildTabs.style.display = 'none';


            let filteredEntries = filterEntries(); 

            let targetContainer = null;
            let currentEmptyState = null;

            if (appState.currentTab === 'intelligence-vault') {
                targetContainer = intelligenceVaultEntriesContainer;
                currentEmptyState = emptyIntelligenceVaultState;

                // Ensure intelligence vault parent and child tabs are visible
                if (intelligenceVaultParentTabs) intelligenceVaultParentTabs.style.display = 'flex';
                if (appState.currentIntelligenceVaultChildTab && intelligenceVaultChildTabs) {
                     intelligenceVaultChildTabs.style.display = 'flex';
                }

                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                } else {
                    currentEmptyState.style.display = 'none';
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                }

            } else if (appState.currentTab === 'custom-tabs') {
                targetContainer = customTabToolsContainer;

                // Only show parent/child entry tabs if there's an active custom vault selected
                if (appState.customTabs.length === 0) {
                    emptyCustomTabState.style.display = 'block';
                    document.getElementById('addEntryBtnCustomVault').style.display = 'none'; // Hide add entry button if no custom tabs
                    return;
                } else {
                    emptyCustomTabState.style.display = 'none'; // Hide global empty state if custom tabs exist
                }

                if (appState.currentCustomTab) { // If a specific custom vault is selected
                    if (customVaultEntryParentTabs) customVaultEntryParentTabs.style.display = 'flex';
                    if (appState.currentCustomVaultEntrySubTab && customVaultEntryChildTabs) {
                        customVaultEntryChildTabs.style.display = 'flex';
                    }
                     document.getElementById('addEntryBtnCustomVault').style.display = appState.readOnlyMode ? 'none' : 'inline-flex';


                    if (filteredEntries.length === 0) {
                        emptyCurrentCustomTabState.style.display = 'block'; // Show empty state for selected custom tab
                        targetContainer.style.display = 'none';
                    } else {
                        emptyCurrentCustomTabState.style.display = 'none';
                        targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                    }
                } else { // No specific custom vault selected, but custom tabs exist
                    emptyCurrentCustomTabState.style.display = 'block'; // Show empty state for selected custom tab
                    targetContainer.style.display = 'none';
                }


            } else if (appState.currentTab === 'tools') { // This `toolsTab` might be obsolete if `intelligence-vault` replaces it
                targetContainer = toolsContainer;
                currentEmptyState = emptyState;
                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                } else {
                    currentEmptyState.style.display = 'none';
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                }
            }
            // For other tabs (analytics, threats, handbook), no entries are rendered in this function.

            // Set the appropriate class based on viewMode
            if (targetContainer) { // Only apply if a container is actually being targeted
                if (appState.viewMode === 'grid') {
                    targetContainer.classList.remove('tools-list');
                    targetContainer.classList.add('tools-grid');
                } else {
                    targetContainer.classList.remove('tools-grid');
                    targetContainer.classList.add('tools-list');
                }
                targetContainer.innerHTML = filteredEntries.map(entry => createEntryCard(entry)).join('');
            }

            // Update view toggle button text based on appState.viewMode
            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            const customVaultViewToggleButton = document.getElementById('customVaultViewToggle'); // This was fixed to exist

            if (appState.viewMode === 'grid') {
                if (viewToggleButton) viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                if (vaultViewToggleButton) vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                if (customVaultViewToggleButton) customVaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View'; // Use the correct ID here
            } else {
                if (viewToggleButton) viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                if (vaultViewToggleButton) vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                if (customVaultViewToggleButton) customVaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View'; // Use the correct ID here
            }
            
            // New: Apply shared-highlight if in read-only mode and relevant entries are found
            if (appState.readOnlyMode && appState.sharedEntryIds.length > 0) {
                // Determine if the current view corresponds to the shared scope
                let shouldHighlight = false;
                if (appState.sharedTabId === 'allData' || appState.sharedTabId === 'allVault') {
                    shouldHighlight = true; // Always highlight all if allData/allVault shared
                } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared custom tab
                } else if (appState.currentTab === 'intelligence-vault' && appState.currentIntelligenceVaultChildTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared intel vault child tab
                }

                if (shouldHighlight) {
                    appState.sharedEntryIds.forEach(id => {
                        const entryCard = document.querySelector(`.tool-card[data-entry-id="${id}"]`);
                        if (entryCard) {
                            entryCard.classList.add('shared-highlight');
                        }
                    });
                }
            }

            saveState(); // Save state after rendering entries
        }


        function filterEntries() {
        let entriesToSearch = [];

        // Determine the base set of entries based on searchScope and currentTab
        if (appState.filters.searchScope === 'allData') {
            entriesToSearch = [
                ...appState.tools,
                ...appState.emails,
                ...appState.phones,
                ...appState.crypto,
                ...appState.locations,
                ...appState.links,
                ...appState.media,
                ...appState.passwords,
                ...appState.keywords,
                ...appState.socials
            ];
        } else if (appState.filters.searchScope === 'allVault') {
            // Combine all entries from the Intelligence Vault (excluding Custom Tabs)
            entriesToSearch = [
                ...appState.tools,
                ...appState.emails,
                ...appState.phones,
                ...appState.crypto,
                ...appState.locations,
                ...appState.links,
                ...appState.media,
                ...appState.passwords,
                ...appState.keywords,
                ...appState.socials
            ];
        } else {
            // For 'currentTab' scope
            if (appState.currentTab === 'tools') { // This tab might be obsolete if intelligence-vault fully replaces it
                entriesToSearch = [...appState.tools];
            } else if (appState.currentTab === 'intelligence-vault') {
                // Filter tools based on the active intelligence vault child tab
                entriesToSearch = appState.tools.filter(tool =>
                    (tool.intelligenceVaultCategories || []).includes(appState.currentIntelligenceVaultChildTab)
                );
            } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
                const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
                if (activeCustomTab) {
                    // Combine all entries from all types
                    const allEntriesCombined = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

                    // First, filter entries that belong to the currently active custom tab
                    let entriesInActiveCustomTab = allEntriesCombined.filter(entry =>
                        (entry.customTabs || []).includes(activeCustomTab.id)
                    );

                    // Then, filter these entries based on the currently selected child sub-tab (Tools, Emails, etc.)
                    // This is where appState.currentCustomVaultEntrySubTab is used
                    if (appState.currentCustomVaultEntrySubTab) {
                        entriesToSearch = entriesInActiveCustomTab.filter(entry =>
                            entry.type === appState.currentCustomVaultEntrySubTab
                        );
                    } else {
                        entriesToSearch = []; // No child sub-tab selected for custom vault entries
                    }

                } else {
                    entriesToSearch = [];
                }
            } else {
                entriesToSearch = []; // No specific entries to filter for other tabs like analytics, threats, handbook
            }
        }

        let filtered = [...entriesToSearch]; // Start filtering from this base set

        // Apply search filter
        if (appState.filters.search) {
            const searchTerm = appState.filters.search.toLowerCase();
            filtered = filtered.filter(entry => {
                const searchableFields = [
                    entry.name,
                    entry.description,
                    entry.category, // For tools
                    entry.email, entry.number, entry.address, entry.txid, entry.locationName, entry.url, entry.title, // For other entry types
                    entry.service, entry.username, entry.password, entry.strength, // For passwords
                    entry.value, entry.context, // For keywords
                    entry.platform, entry.socialUsername, entry.followCounts, // For socials
                    // Include source and custom metadata in search
                    entry.source,
                    ...(entry.metadata || []).flatMap(meta => [meta.key, meta.value])
                ].map(field => String(field || '').toLowerCase()); // Ensure all fields are strings or empty strings

                if (entry.tags) {
                    searchableFields.push(...entry.tags.map(tag => tag.toLowerCase()));
                }

                return searchableFields.some(field => field.includes(searchTerm));
            });
        }

        // Apply universal "category" filters for pinned/starred
        if (appState.filters.category === 'pinned') {
            filtered = filtered.filter(entry => entry.pinned);
        } else if (appState.filters.category === 'starred') {
            filtered = filtered.filter(entry => entry.starred);
        } else if (appState.filters.category) {
            // This 'else if' block handles actual categories, only apply if the current view is for tools
            // Now, only filter by category if we are explicitly on an 'Intelligence Vault' tab that displays tools,
            // or if we are on the 'tools' sub-tab within a custom vault.
            if (appState.currentTab === 'intelligence-vault' || (appState.currentTab === 'custom-tabs' && appState.currentCustomVaultEntrySubTab === 'tools')) {
                filtered = filtered.filter(entry => entry.type === 'tool' && entry.category === appState.filters.category);
            } else {
                // If a category filter is applied while not on a 'tools' tab, clear it visually.
                document.getElementById('categoryFilter').value = '';
                appState.filters.category = ''; // Ensure state is reset too
            }
        }

        // Apply sorting
        filtered.sort((a, b) => {
            switch (appState.filters.sort) {
                case 'recent':
                    return new Date(b.addedDate || 0) - new Date(a.addedDate || 0);
                case 'popular': // Sort by lastUsed (most recent first)
                    return (b.lastUsed || 0) - (a.lastUsed || 0);
                default: // 'name' (or primary identifier)
                    const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                    const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                    return nameA.localeCompare(nameB);
            }
        });

        return filtered;
    }

            // Create a generic entry card HTML
            function createEntryCard(entry) {
                const isSelected = appState.selectedEntries.has(entry.id);
                let title, subtitle, description, icon, faviconHtml = '', extraContent = '';

                // Determine the origin tag HTML
                let originTagHtml = '';
                if (entry.origin === 'pre-added') {
                    originTagHtml = `<span class="tag" style="background-color: var(--primary); color: white; margin-left: 10px;">Pre-added</span>`;
                } else if (entry.origin === 'user-added') {
                    originTagHtml = `<span class="tag" style="background-color: var(--accent); color: white; margin-left: 10px;">User-added</span>`;
                }


                switch (entry.type) {
                    case 'tool':
                        title = entry.name;
                        subtitle = entry.url;
                        description = entry.description;
                        icon = 'fas fa-tools';
                        // CORRECTED: Ensure faviconHtml is built correctly with an actual img tag
                        faviconHtml = `<img src="${entry.favicon}" alt="" class="tool-favicon" onerror="this.src='https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}'">`;
                        break;
                    case 'email':
                        title = entry.email;
                        subtitle = entry.linkedPlatforms.join(', ') || 'No linked platforms';
                        description = entry.notes;
                        icon = 'fas fa-envelope';
                        extraContent = entry.breachResults ? `<p style="color: var(--danger); font-size: 12px; margin-top: 5px;"><i class="fas fa-exclamation-triangle"></i> Breach: ${entry.breachResults}</p>` : '';
                        break;
                    case 'phone':
                        title = entry.number;
                        subtitle = `Type: ${entry.phoneType}`;
                        description = entry.notes;
                        icon = 'fas fa-phone';
                        extraContent = entry.location ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${entry.location}</p>` : '';
                        break;
                    case 'crypto':
                        title = entry.address;
                        subtitle = `TXID: ${entry.txid}`;
                        description = `Amount: ${entry.amount} | Source: ${entry.source}`;
                        icon = 'fas fa-coins';
                        break;
                    case 'location':
                        title = entry.name;
                        subtitle = `Coordinates: ${entry.coordinates}`;
                        description = entry.notes;
                        icon = 'fas fa-map-marker-alt';
                        extraContent = entry.mapLink ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.mapLink}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> View Map</a></p>` : '';
                        extraContent += entry.ipGeoIntel ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">IP/Geo: ${entry.ipGeoIntel}</p>` : '';
                        break;
                    case 'link':
                        title = entry.url;
                        subtitle = entry.platform || 'General Link';
                        description = entry.notes;
                        icon = 'fas fa-link';
                        try {
                            faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
                        } catch (e) {
                            faviconHtml = '';
                        }
                        break;
                    case 'media':
                        title = entry.title;
                        subtitle = entry.mediaType === 'image' ? 'Image' : 'Video';
                        description = entry.notes;
                        icon = entry.mediaType === 'image' ? 'fas fa-image' : 'fas fa-video';
                        extraContent = entry.base64Data ? (entry.mediaType === 'image' ? `<img src="${entry.base64Data}" alt="Media thumbnail" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">` : `<video controls style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;"><source src="${entry.base64Data}" type="video/mp4"></video>`) : '';
                        break;
                    case 'password':
                        title = entry.service;
                        subtitle = `Username: ${entry.username || 'N/A'}`;
                        description = `Password: ${entry.password} | Strength: ${entry.strength || 'N/A'}\nNotes: ${entry.notes || 'N/A'}`;
                        icon = 'fas fa-key';
                        break;
                    case 'keyword':
                        title = entry.value;
                        subtitle = `Context: ${entry.context || 'General'}`;
                        description = entry.notes;
                        icon = 'fas fa-font';
                        break;
                    case 'social':
                        title = entry.username;
                        subtitle = `Platform: ${entry.platform}`;
                        description = `URL: ${entry.url}\nFollowers/Following: ${entry.followCounts || 'N/A'}\nNotes: ${entry.notes || 'N/A'}`;
                        icon = 'fas fa-users';
                        try {
                            faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
                        } catch (e) {
                            faviconHtml = '';
                        }
                        break;
                    default:
                        title = entry.name || 'Unknown Entry';
                        subtitle = '';
                        description = '';
                        icon = 'fas fa-question-circle';
                }

                // NEW: Add source and metadata to card if they exist
                if (entry.source && entry.type !== 'tool') { // Only show source for non-tool entries
                    extraContent += `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-satellite-dish"></i> Source: ${entry.source}</p>`;
                }
                if (entry.metadata && entry.metadata.length > 0) {
                    extraContent += `<div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Metadata:</strong>`;
                    entry.metadata.forEach(meta => {
                        extraContent += `<p style="margin-left: 10px;">- ${meta.key}: ${meta.value}</p>`;
                    });
                    extraContent += `</div>`;
                }

                return `
                    <div class="tool-card ${entry.starred ? 'starred' : ''} ${entry.pinned ? 'pinned' : ''} ${isSelected ? 'selected' : ''}"
                    data-entry-id="${entry.id}" data-entry-type="${entry.type}">
                        <div class="tool-header">
                            <div>
                                <div class="tool-title">
                                    <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''}>
                                    ${faviconHtml} <i class="${icon}" style="margin-right: 5px;"></i> <span>${title}</span>
                                    ${originTagHtml} </div>
                                <div class="tool-url">
                                    <span>${subtitle}</span> ${entry.url && entry.type === 'tool' ? '<i class="fas fa-external-link-alt external-link-icon"></i>' : ''}
                                </div>
                            </div>
                            <div class="tool-actions">
                                <button class="action-btn" data-action="edit" title="Edit Entry">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn ${entry.starred ? 'starred' : ''}" data-action="star" title="Star Entry">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="action-btn ${entry.pinned ? 'pinned' : ''}" data-action="pin" title="Pin Entry">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                ${entry.url && entry.type === 'tool' ? `<button class="action-btn" data-action="visit" title="Visit Link">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>` : ''}
                                <button class="action-btn" data-action="delete" title="Delete Entry">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                            ${description}
                        </p>
                        ${extraContent}
                        <div class="tool-tags">
                            ${entry.tags ? entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                        </div>
                    </div>
                `;
            }

// Bind event listeners
function bindEvents() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                appState.filters.search = e.target.value;
                renderIntelligenceEntries();
            });

            // Search Scope Select
            document.getElementById('searchScopeSelect').addEventListener('change', (e) => {
                appState.filters.searchScope = e.target.value;
                renderIntelligenceEntries(); // Re-render with new scope
            });

            // NEW: Event listener for Desktop Recommendation Modal's "Continue Anyway" button
            const continueAnywayBtn = document.getElementById('continueAnywayBtn');
            if (continueAnywayBtn) {
                continueAnywayBtn.addEventListener('click', () => {
                    hideModal('desktopRecommendationModal');
                    sessionStorage.setItem('desktopRecommendationShown', 'true'); // Mark as shown for this session
                });
            }

            // Filter controls
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                appState.filters.category = e.target.value;
                renderIntelligenceEntries();
            });

            document.getElementById('sortFilter').addEventListener('change', (e) => {
                appState.filters.sort = e.target.value;
                renderIntelligenceEntries();
            });
            
            // Handbook and Notes subtab events (should be handled here if they exist)
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const subtab = e.target.dataset.subtab;
                    switchHandbookSubtab(subtab);
                });
            });

            document.getElementById('addToolBtnEmptyState').addEventListener('click', () => {
                openAddToolOnlyModal();
            });

            document.getElementById('addToolBtnIntelligenceVault').addEventListener('click', () => {
                openAddToolOnlyModal(); // Call a new function to handle this modal
            });

            // Add event listeners for the new modal (inside bindEvents)
            document.getElementById('cancelAddToolOnly').addEventListener('click', () => hideModal('addToolOnlyModal'));
            document.getElementById('addToolOnlyForm').addEventListener('submit', handleAddToolOnly);

            // Add custom category input for the new modal
            document.getElementById('toolOnlyCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newToolOnlyCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = ''; // Clear input if not custom
                }
            });

            // Main tab navigation (Delegated as they are always present)
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });


            // Custom Vault Entry Parent Tabs (Delegation)
            const customVaultEntryParentTabsContainer = document.getElementById('customVaultEntryParentTabs');
            if (customVaultEntryParentTabsContainer) {
                customVaultEntryParentTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.custom-vault-entry-parent-tab');
                    if (tabBtn && tabBtn.dataset.parentTab) {
                        switchCustomVaultParentTab(tabBtn.dataset.parentTab);
                    }
                });
            }

            // Intelligence Vault Parent Tabs (Delegation)
            const intelligenceVaultParentTabsContainer = document.getElementById('intelligenceVaultParentTabs');
            if (intelligenceVaultParentTabsContainer) { // Ensure element exists
                intelligenceVaultParentTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.intelligence-vault-parent-tab');
                    if (tabBtn && tabBtn.dataset.parentTab) {
                        switchIntelligenceVaultParentTab(tabBtn.dataset.parentTab);
                    }
                });
            }

            // --- ADD THIS MISSING BLOCK ---
            // Intelligence Vault Child Tabs (Delegation - IMPORTANT!)
            const intelligenceVaultChildTabsContainer = document.getElementById('intelligenceVaultChildTabs');
            if (intelligenceVaultChildTabsContainer) { // Ensure element exists
                intelligenceVaultChildTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.intelligence-vault-child-tab');
                    if (tabBtn && tabBtn.dataset.childTab) {
                        switchIntelligenceVaultChildTab(tabBtn.dataset.childTab);
                    }
                });
            }
            // --- END MISSING BLOCK ---

            // Custom Vault Entry Child Tabs (Delegation)
            const customVaultEntryChildTabsContainer = document.getElementById('customVaultEntryChildTabs');
            if (customVaultEntryChildTabsContainer) { // Ensure element exists
                customVaultEntryChildTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.custom-vault-entry-child-tab');
                    if (tabBtn && tabBtn.dataset.childTab) {
                        switchCustomVaultEntrySubTab(tabBtn.dataset.childTab);
                    }
                });
            }


            // Tool actions (now generic for all entries) - Event delegation on the main content containers
            document.getElementById('toolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('customTabToolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('intelligenceVaultEntries').addEventListener('click', handleEntryAction);
            
            // Event delegation for bulk selection checkboxes
            document.getElementById('toolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('customTabToolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('intelligenceVaultEntries').addEventListener('change', handleBulkSelection);

            // Modal controls (Add New Entry) - specific to Multi-Vault now
            document.getElementById('addEntryBtnCustomVault').addEventListener('click', () => {
                // Set the default entry type to 'tool' for the Multi-Vault "Add New Entry" modal
                document.getElementById('entryTypeSelect').value = 'tool'; 
                displayEntryForm();
                showModal('addEntryModal');
            });
            document.getElementById('cancelAddEntry').addEventListener('click', () => hideModal('addEntryModal'));

            // Dynamic form display for Add Entry modal
            document.getElementById('entryTypeSelect').addEventListener('change', displayEntryForm);
            
            // Custom category input (Add Tool)
            document.getElementById('toolCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = ''; // Clear input if not custom
                }
            });
            
            // Intelligence Vault Category Search (for Add Tool modal)
            const intelligenceVaultCategorySearchInputAdd = document.getElementById('intelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInputAdd) {
                intelligenceVaultCategorySearchInputAdd.addEventListener('input', (e) => {
                    const currentSelections = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked')).map(cb => cb.value);
                    populateIntelligenceVaultCategoriesCheckboxesAddTool(currentSelections, e.target.value);
                });
            }

            // Intelligence Vault Category Search (for EDIT Tool modal, using unique ID)
            const intelligenceVaultCategorySearchInputEdit = document.getElementById('editIntelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInputEdit) {
                intelligenceVaultCategorySearchInputEdit.addEventListener('input', (e) => {
                    // Get the tool ID from the hidden input in the edit modal
                    const currentToolId = document.getElementById('editEntryId').value;
                    const toolToEdit = appState.tools.find(t => t.id === currentToolId);
                    if (toolToEdit) {
                        // Pass the tool's original categories (before filtering) and the current search term
                        populateIntelligenceVaultCategoriesCheckboxesEditTool(toolToEdit.intelligenceVaultCategories || [], e.target.value);
                    }
                });
            }

            // Form submission (Add Entry)
            document.getElementById('addEntryForm').addEventListener('submit', handleAddEntry);

            // Modal controls (Edit Entry)
            document.getElementById('cancelEditEntry').addEventListener('click', () => hideModal('editEntryModal'));
            // Custom category input (Edit Tool)
            document.getElementById('editToolCategory').addEventListener('change', (e) => {
                const editNewCategoryInput = document.getElementById('editNewCategoryInput');
                if (e.target.value === 'custom') {
                    editNewCategoryInput.style.display = 'block';
                    editNewCategoryInput.setAttribute('required', 'required');
                } else {
                    editNewCategoryInput.style.display = 'none';
                    editNewCategoryInput.removeAttribute('required');
                    editNewCategoryInput.value = ''; // Clear input if not custom
                }
            });
            // Form submission (Edit Entry)
            document.getElementById('editEntryForm').addEventListener('submit', handleEditEntry);

            // NEW: Add/Remove Metadata buttons in Add/Edit Entry forms
            document.getElementById('addMetadataBtn').addEventListener('click', () => addMetadataField('add'));
            document.getElementById('customMetadataEntries').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-metadata-btn')) {
                    e.target.closest('.form-group.metadata-entry').remove();
                }
            });
            document.getElementById('editAddMetadataBtn').addEventListener('click', () => addMetadataField('edit'));
            document.getElementById('editCustomMetadataEntries').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-metadata-btn')) {
                    e.target.closest('.form-group.metadata-entry').remove();
                }
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Quick actions
            document.getElementById('pinAllBtn').addEventListener('click', togglePinFilter);
            document.getElementById('starAllBtn').addEventListener('click', toggleStarFilter);
            document.getElementById('showAllBtn').addEventListener('click', clearFilters);
            document.getElementById('reportBtn').addEventListener('click', generateReport);

            // Clear filters (from empty state button)
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

            // Bulk actions
            document.getElementById('bulkStarBtn').addEventListener('click', () => bulkAction('star'));
            document.getElementById('bulkPinBtn').addEventListener('click', () => bulkAction('pin'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', () => bulkAction('delete'));

            // Export
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // View toggle (Grid/List)
            document.getElementById('viewToggle').addEventListener('click', toggleViewMode);
            // Intelligence Vault View Toggle
            document.getElementById('vaultViewToggle').addEventListener('click', toggleViewMode); // Both can use the same toggle
            //Multi Vault View Toggle
            document.getElementById('customVaultViewToggle').addEventListener('click', toggleViewMode);

            // Refresh Threats button
            document.getElementById('refreshThreatsBtn').addEventListener('click', loadThreats);

            // Custom Sub-tab buttons
            document.getElementById('createSubTabBtn').addEventListener('click', () => showCreateSubTabModal());
            document.getElementById('createSubTabBtnEmptyState').addEventListener('click', () => showCreateSubTabModal()); // For empty state button
            document.getElementById('cancelCreateSubTab').addEventListener('click', () => hideModal('createSubTabModal'));
            document.getElementById('createSubTabForm').addEventListener('submit', handleCreateSubTab);

            document.getElementById('editSubTabBtn').addEventListener('click', () => openEditSubTabModal());
            document.getElementById('cancelEditSubTab').addEventListener('click', () => hideModal('editSubTabModal'));
            document.getElementById('editSubTabForm').addEventListener('submit', handleEditSubTab);

            document.getElementById('deleteSubTabBtn').addEventListener('click', handleDeleteSubTab);
            document.getElementById('exportSubTabBtn').addEventListener('click', exportCustomTab);
            document.getElementById('newRandomBtn').addEventListener('click', showRandomDiscovery); // New: Random Tool/Tip button
            
            // New: Share options button and modal events
            document.getElementById('shareOptionsBtn').addEventListener('click', showShareOptionsModal);
            document.getElementById('cancelShareOptions').addEventListener('click', () => hideModal('shareOptionsModal'));
            document.getElementById('shareScopeSelect').addEventListener('change', handleShareScopeChange);
            document.getElementById('shareForm').addEventListener('submit', handleShareFormSubmit);


            // Click listener for custom sub-tabs (delegated)
            document.getElementById('customSubTabs').addEventListener('click', (e) => {
                const tabBtn = e.target.closest('.sub-nav-tab');
                if (tabBtn && tabBtn.dataset.subTabId) {
                    switchCustomTab(tabBtn.dataset.subTabId);
                }
            });

            // Event listener for custom tab checkboxes in Edit Tool Modal
            document.getElementById('assignCustomTabsCheckboxes').addEventListener('change', (e) => {
                if (e.target.classList.contains('custom-tab-assign-checkbox')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            });

            // Icon picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#newSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('newSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Icon picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#editedSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('editedSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Color picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#newSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('newSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

            // Color picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#editedSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('editedSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

        }



        // MODIFIED: Function to open the Add Tool Only Modal
        function openAddToolOnlyModal() {
            if (appState.readOnlyMode) {
                showToast("Cannot add tools in read-only shared view.", "warning");
                return;
            }
            document.getElementById('addToolOnlyForm').reset();
            populateCategoryFilterForAddToolOnly();

            // Clear search input and populate with no search term
            const intelligenceVaultCategorySearchInput = document.getElementById('intelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInput) { // Safety check
                intelligenceVaultCategorySearchInput.value = '';
            }
            populateIntelligenceVaultCategoriesCheckboxesAddTool([], ''); // Pass empty array for selections, empty string for search

            // Pre-select the current Intelligence Vault child tab, if applicable
            const checkboxes = document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === appState.currentIntelligenceVaultChildTab) {
                    checkbox.checked = true;
                    // Manually add 'checked' class to the label for visual feedback
                    checkbox.closest('.custom-tab-checkbox').classList.add('checked');
                } else {
                    checkbox.checked = false;
                    checkbox.closest('.custom-tab-checkbox').classList.remove('checked');
                }
            });

            document.getElementById('newToolOnlyCategoryInput').style.display = 'none';
            showModal('addToolOnlyModal');
        }

        // NEW: Populate Category dropdown for the Add Tool Only Modal
        function populateCategoryFilterForAddToolOnly() {
            const toolCategorySelect = document.getElementById('toolOnlyCategory');
            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));

            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation',
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other',
                'Phone Investigation', 'Telecom', 'Cryptocurrency Analysis', 'Geospatial Intelligence',
                'OSINT Mapping', 'Link Analysis', 'URL Analysis', 'Media Analysis', 'Video Analysis',
                'Password Analysis', 'Credential Analysis', 'Keyword Analysis', 'Text Analysis',
                'Social Media Analysis', 'Social Engineering'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...existingCategories]);

            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';

            Array.from(allCategories)
                .sort((a, b) => a.localeCompare(b))
                .forEach(category => {
                    const toolOption = document.createElement('option');
                    toolOption.value = category;
                    toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    toolCategorySelect.appendChild(toolOption);
                });

            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);
        }

        // MODIFIED: Populate "Where to add" checkboxes for the Add Tool Only Modal
        function populateIntelligenceVaultCategoriesCheckboxesAddTool(assignedCategories = [], searchTerm = '') {
            // Correct ID for ADD modal's checkboxes container
            const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesAddTool');
            if (!checkboxesContainer) return; // Safety check
            checkboxesContainer.innerHTML = '';

            // IMPORTANT: This array must contain ALL child tabs from your intelligenceVaultTabStructure
            const intelligenceVaultCategories = [
                // From General & Core
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
                { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
                { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' },
                { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' },

                // From Identity & Social
                { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
                { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
                { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' },

                // From Technical Footprints
                { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
                { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
                { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
                { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
                { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' },

                // From Cybersecurity Intel
                { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
                { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' },

                // From Breach & Leaks
                { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' },
                { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' },
                { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },

                // From Underground Sources
                { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' },
                { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
                { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
                { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },

                // From Media Analysis
                { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' },
                { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' },
                { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
                { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
                { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' },

                // From Operational Security (OPSEC)
                { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
                { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' },
                { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' },
                { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' },
            ];

            const filteredCategories = intelligenceVaultCategories.filter(category =>
                category.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredCategories.length === 0) {
                checkboxesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No matching categories.</p>';
                return;
            }

            filteredCategories.forEach(category => {
                const isChecked = assignedCategories.includes(category.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) checkboxContainer.classList.add('checked');

                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="intelligence-vault-category-checkbox-add-tool" value="${category.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${category.icon}" style="margin-right: 5px;"></i>
                    <span>${category.name}</span>
                `;
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Add event listener only once, if it hasn't been added yet to the wrapper
            const containerWrapper = document.getElementById('intelligenceVaultCategoriesAssignmentAddTool'); // Correct ID for ADD modal wrapper
            if (containerWrapper && !containerWrapper.dataset.listenerAdded) {
                containerWrapper.addEventListener('change', (e) => {
                    if (e.target.classList.contains('intelligence-vault-category-checkbox-add-tool')) {
                        const checkbox = e.target;
                        const label = checkbox.closest('.custom-tab-checkbox');
                        if (label) {
                            label.classList.toggle('checked', checkbox.checked);
                        }
                    }
                });
                containerWrapper.dataset.listenerAdded = 'true'; // Mark as added
            }
        }
// MODIFIED: populateIntelligenceVaultCategoriesCheckboxesEditTool (simplified listener attachment)
function populateIntelligenceVaultCategoriesCheckboxesEditTool(assignedCategories = [], searchTerm = '') {
    const container = document.getElementById('intelligenceVaultCategoriesAssignmentEditTool');
    if (!container) return;
    container.style.display = 'block';

    const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesEditTool');
    if (!checkboxesContainer) return;
    checkboxesContainer.innerHTML = ''; // Clear previous checkboxes

    // IMPORTANT: This array must contain ALL child tabs from your intelligenceVaultTabStructure
    const intelligenceVaultCategories = [
        // From General & Core
        { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
        { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
        { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
        { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' },
        { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' },

        // From Identity & Social
        { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
        { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
        { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
        { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
        { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
        { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
        { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' },

        // From Technical Footprints
        { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
        { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
        { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
        { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
        { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
        { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
        { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' },

        // From Cybersecurity Intel
        { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
        { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
        { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
        { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
        { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' },

        // From Breach & Leaks
        { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' },
        { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
        { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
        { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' },
        { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },

        // From Underground Sources
        { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' },
        { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
        { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
        { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
        { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },

        // From Media Analysis
        { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' },
        { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' },
        { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
        { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
        { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' },

        // From Operational Security (OPSEC)
        { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
        { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' },
        { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' },
        { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' },
    ];

    const filteredCategories = intelligenceVaultCategories.filter(category =>
        category.name.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (filteredCategories.length === 0) {
        checkboxesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No matching categories.</p>';
        return;
    }

    filteredCategories.forEach(category => {
        const isChecked = assignedCategories.includes(category.id);
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        if (isChecked) checkboxContainer.classList.add('checked');

        checkboxContainer.innerHTML = `
            <input
                type="checkbox"
                class="intelligence-vault-category-checkbox-edit-tool"
                value="${category.id}"
                ${isChecked ? 'checked' : ''}
            >
            <i class="${category.icon}" style="margin-right: 5px;"></i>
            <span>${category.name}</span>
        `;
        checkboxesContainer.appendChild(checkboxContainer);
    });

    // Attach event listener directly to the checkboxesContainer.
    // This will replace the existing elements, so the old listeners are implicitly removed.
    checkboxesContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('intelligence-vault-category-checkbox-edit-tool')) {
            const checkbox = e.target;
            const label = checkbox.closest('.custom-tab-checkbox');
            if (label) {
                label.classList.toggle('checked', checkbox.checked);
            }
        }
    });
}
// NEW: Handle adding a new tool from the dedicated Intelligence Vault modal
    async function handleAddToolOnly(e) {
        e.preventDefault();
        if (appState.readOnlyMode) {
            showToast("Cannot add tools in read-only shared view.", "warning");
            return;
        }

        const toolName = document.getElementById('toolOnlyName').value.trim();
        const toolUrl = document.getElementById('toolOnlyUrl').value.trim();
        let toolCategory = document.getElementById('toolOnlyCategory').value;
        const newCategoryInput = document.getElementById('newToolOnlyCategoryInput').value.trim();
        const toolDescription = document.getElementById('toolOnlyDescription').value.trim();
        const toolTags = document.getElementById('toolOnlyTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

        const selectedIntelligenceVaultCategories = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);

        if (!toolName || !toolUrl || !toolCategory) {
            showToast('Please fill in all required tool fields (Name, URL, Category).', 'error');
            return;
        }

        if (toolCategory === 'custom') {
            if (!newCategoryInput) {
                showToast('Please enter a custom category name.', 'error');
                return;
            }
            toolCategory = newCategoryInput.toLowerCase();
        }

        if (selectedIntelligenceVaultCategories.length === 0) {
            showToast('Please select at least one Intelligence Vault category for the tool.', 'error');
            return;
        }

        const newTool = {
            id: generateId(),
            type: 'tool',
            name: toolName,
            url: toolUrl,
            category: toolCategory,
            description: toolDescription,
            tags: toolTags,
            starred: false,
            pinned: false,
            favicon: `https://www.google.com/s2/favicons?domain=${new URL(toolUrl).hostname}`,
            lastUsed: 0,
            addedDate: new Date(),
            customTabs: [],
            intelligenceVaultCategories: selectedIntelligenceVaultCategories
        };

        appState.tools.push(newTool);
        hideModal('addToolOnlyModal');
        document.getElementById('addToolOnlyForm').reset();
        showToast('Tool added successfully!');
        updateStats();
        populateCategoryFilter();
        renderIntelligenceEntries();
        saveState();
    }



        // Handle generic entry actions
        function handleEntryAction(e) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot perform actions in read-only shared view.", "warning");
                return;
            }

            const targetBtn = e.target.closest('.action-btn');
            if (!targetBtn) return;
            
            e.preventDefault();
            const action = targetBtn.dataset.action;
            const entryCard = e.target.closest('.tool-card'); // Still using tool-card class for styling
            const entryId = entryCard.dataset.entryId;
            const entryType = entryCard.dataset.entryType;

            let entry = null;
            let entryArray = null;

            switch (entryType) {
                case 'tool': entryArray = appState.tools; break;
                case 'email': entryArray = appState.emails; break;
                case 'phone': entryArray = appState.phones; break;
                case 'crypto': entryArray = appState.crypto; break;
                case 'location': entryArray = appState.locations; break;
                case 'link': entryArray = appState.links; break;
                case 'media': entryArray = appState.media; break;
                case 'password': entryArray = appState.passwords; break; // New
                case 'keyword': entryArray = appState.keywords; break; // New
                case 'social': entryArray = appState.socials; break; // New
            }

            if (entryArray) {
                entry = entryArray.find(t => t.id === entryId);
            }
            
            if (!entry) return;

            switch (action) {
                case 'edit':
                    openEditEntryModal(entry);
                    break;
                case 'star':
                    entry.starred = !entry.starred;
                    showToast(entry.starred ? 'Entry starred!' : 'Entry unstarred!');
                    break;
                case 'pin':
                    entry.pinned = !entry.pinned;
                    showToast(entry.pinned ? 'Entry pinned!' : 'Entry unpinned!');
                    break;
                case 'visit':
                    // Only tools have external links to visit
                    if (entry.type === 'tool' && entry.url) {
                        entry.lastUsed = Date.now(); // Update lastUsed timestamp
                        appState.usageStats.toolsUsedToday++; // Increment usage stat (generic for now)
                        updateAnalytics(); // Update analytics display
                        window.open(entry.url, '_blank');
                        showToast('Opening link...');
                    }
                    break;
                case 'delete':
                    if (confirm('Are you sure you want to delete this entry?')) {
                        // Remove entry from any custom tabs it belongs to
                        appState.customTabs.forEach(tab => {
                            tab.toolIds = tab.toolIds.filter(id => id !== entryId);
                        });

                        if (entryArray) {
                            // Find index and remove
                            const index = entryArray.findIndex(e => e.id === entryId);
                            if (index > -1) {
                                entryArray.splice(index, 1);
                            }
                        }
                        appState.selectedEntries.delete(entryId); // Remove from selected if deleted
                        showToast('Entry deleted!', 'error');
                        updateStats();
                        populateCategoryFilter(); // Recalculate categories (if a tool was deleted)
                        renderCustomTabs(); // Re-render custom tabs to update counts/content
                    }
                    break;
            }
            
            renderIntelligenceEntries();
            updateStats(); // Also update stats bar after individual entry action
            saveState(); // Save state after any action
        }

        // Handle bulk selection checkbox
        function handleBulkSelection(e) {
            if (appState.readOnlyMode) { // New: Prevent bulk selection in read-only mode
                e.target.checked = !e.target.checked; // Revert checkbox state
                showToast("Cannot select entries in read-only shared view.", "warning");
                return;
            }

            if (!e.target.classList.contains('bulk-checkbox')) return;
            
            const entryCard = e.target.closest('.tool-card');
            const entryId = entryCard.dataset.entryId;
            
            if (e.target.checked) {
                appState.selectedEntries.add(entryId);
            } else {
                appState.selectedEntries.delete(entryId);
            }
            
            updateBulkActions();
            entryCard.classList.toggle('selected', e.target.checked); // Visually mark selected
        }

        // Update bulk actions visibility and count
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (appState.readOnlyMode) { // New: Always hide bulk actions in read-only
                bulkActions.classList.remove('active');
                return;
            }

            if (appState.selectedEntries.size > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = appState.selectedEntries.size;
            } else {
                bulkActions.classList.remove('active');
            }
        }

        // Bulk actions (star, pin, delete selected)
        function bulkAction(action) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot perform bulk actions in read-only shared view.", "warning");
                return;
            }

            const selectedIds = Array.from(appState.selectedEntries);
            
            if (selectedIds.length === 0) {
                showToast(`No entries selected for ${action} action.`, 'warning');
                return;
            }

            if (action === 'delete' && !confirm('Are you sure you want to delete all selected entries?')) {
                return;
            }
            
            // Determine if all selected are already starred/pinned for toggling
            let allStarred = true;
            let allPinned = true;
            
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const selectedEntriesArray = allEntries.filter(entry => selectedIds.includes(entry.id));

            if (action === 'star' || action === 'pin') {
                allStarred = selectedEntriesArray.every(entry => entry.starred);
                allPinned = selectedEntriesArray.every(entry => entry.pinned);
            }

            selectedIds.forEach(id => {
                const entry = allEntries.find(e => e.id === id);
                if (!entry) return;
                
                switch (action) {
                    case 'star':
                        entry.starred = !allStarred; // Toggle based on current state of all
                        break;
                    case 'pin':
                        entry.pinned = !allPinned; // Toggle based on current state of all
                        break;
                    case 'delete':
                        // Remove entry from any custom tabs it belongs to before deleting
                        appState.customTabs.forEach(tab => {
                            tab.toolIds = tab.toolIds.filter(entryIdInTab => entryIdInTab !== id);
                        });
                        // Remove from respective appState array
                        ['tools', 'emails', 'phones', 'crypto', 'locations', 'links', 'media', 'passwords', 'keywords', 'socials'].forEach(key => {
                            appState[key] = appState[key].filter(e => e.id !== id);
                        });
                        break;
                }
            });
            
            appState.selectedEntries.clear();
            updateBulkActions();
            renderIntelligenceEntries();
            updateStats();
            populateCategoryFilter();
            renderCustomTabs(); // Update custom tabs if entries were deleted
            showToast(`Bulk ${action} completed!`);
            saveState();
        }

        // Quick actions (UPDATED)
        function togglePinFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'pinned') { // If already filtering by pinned, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'pinned'; // Set filter to show only pinned
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'pinned' ? 'Showing only pinned entries!' : 'Cleared pinned entries filter!');
        }

        function toggleStarFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'starred') { // If already filtering by starred, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'starred'; // Set filter to show only starred
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'starred' ? 'Showing only starred entries!' : 'Cleared starred entries filter!');
        }


        // Switch main tabs
        function switchTab(tabName) {
            // Update main tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                 targetTabContent.classList.add('active');
            }

            // Update appState and clear filters for new tab
            appState.currentTab = tabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = '';
            document.getElementById('searchInput').value = '';

            // Hide all potential sub-tab containers and add entry buttons by default
            // This ensures a clean slate before showing relevant ones
            document.getElementById('intelligenceVaultParentTabs').style.display = 'none';
            document.getElementById('intelligenceVaultChildTabs').style.display = 'none';
            document.getElementById('customVaultEntryParentTabs').style.display = 'none';
            document.getElementById('customVaultEntryChildTabs').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none'; 

            // Specific logic for each main tab
            if (tabName === 'intelligence-vault') {
                document.getElementById('intelligenceVaultParentTabs').style.display = 'flex'; // Show parent tabs
                renderIntelligenceVaultParentTabs(); // This will populate parent tabs and activate current one

                // This will then call switchIntelligenceVaultParentTab which will render and activate children
                // and switchIntelligenceVaultChildTab will be called from there.
                // Ensure a valid parent is selected, default if current one is invalid
                const currentIntelParent = intelligenceVaultTabStructure.find(p => p.id === appState.currentIntelligenceVaultParentTab);
                if (!currentIntelParent) {
                    appState.currentIntelligenceVaultParentTab = intelligenceVaultTabStructure[0].id;
                }
                // Call switchIntelligenceVaultParentTab to trigger child tab rendering and activation
                switchIntelligenceVaultParentTab(appState.currentIntelligenceVaultParentTab);


                // Show the "Add New Tool" button
                if (!appState.readOnlyMode) {
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'inline-flex';
                }

            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render main custom tabs (the list of custom vaults)

                // Only proceed to render/switch parent/child entry tabs if custom vaults exist
                if (appState.customTabs.length > 0) {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'flex'; // Show parent tabs for entries
                    renderCustomVaultParentTabs(); // Render custom vault entry parent tabs

                    // Ensure a valid parent is selected, default if current one is invalid
                    const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
                    if (!currentCustomParent) {
                        appState.currentCustomVaultParentTab = customVaultEntryStructure[0].id;
                    }
                    // Ensure a valid child is selected under the current parent, default if invalid
                    const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                    if (!currentCustomChild) {
                        appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                    }
                    // Now, switch to the determined parent and then its child
                    switchCustomVaultParentTab(appState.currentCustomVaultParentTab);

                    // Show the "Add New Entry" button for custom vaults
                    if (!appState.readOnlyMode) {
                        document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                    }
                }

            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'handbook') {
                initHandbookAndNotes(); // Ensure handbook and notes are initialized
            }

            renderIntelligenceEntries(); // Always re-render entries relevant to the currently active main tab
            saveState(); // Save state after tab switch
        }

        // Switch Intelligence Vault Sub-tabs (now show tools)
        function switchIntelligenceVaultSubTab(subTabName) {
            document.querySelectorAll('.intelligence-vault-sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.intelligence-vault-sub-tab[data-sub-tab="${subTabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            appState.currentIntelligenceVaultSubTab = subTabName;
            appState.filters.category = ''; // Clear category filter when switching intel vault sub-tabs
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant tools
            saveState();
        }

        // MODIFIED: Switch Custom Vault Entry Child Sub-tabs (now show collected evidence)
        function switchCustomVaultEntrySubTab(childTabName) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all child tabs
            document.querySelectorAll('.custom-vault-entry-child-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked child tab
            const targetChildTabBtn = document.querySelector(`.custom-vault-entry-child-tab[data-child-tab="${childTabName}"]`);
            if (targetChildTabBtn) {
                targetChildTabBtn.classList.add('active');
            }

            appState.currentCustomVaultEntrySubTab = childTabName;
            // When switching entry sub-tabs in a custom vault, clear tool category filter as it's not applicable
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant entries
            saveState();
        }

        
        // NEW: Render Custom Vault Parent Tabs
        function renderCustomVaultParentTabs() {
            const parentTabsContainer = document.getElementById('customVaultEntryParentTabs');
            if (!parentTabsContainer) return;

            parentTabsContainer.innerHTML = customVaultEntryStructure.map(parentTab => `
                <button class="nav-tab custom-vault-entry-parent-tab" data-parent-tab="${parentTab.id}">
                    <i class="${parentTab.icon}"></i>
                    ${parentTab.name}
                </button>
            `).join('');

            // Add event listeners for parent tabs (delegation handled in bindEvents)

            // Activate the currently selected parent tab
            const activeParentBtn = document.querySelector(`.custom-vault-entry-parent-tab[data-parent-tab="${appState.currentCustomVaultParentTab}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }
        }

        // NEW: Switch Custom Vault Parent Tab
        function switchCustomVaultParentTab(parentId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all parent tabs
            document.querySelectorAll('.custom-vault-entry-parent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked parent tab
            const activeParentBtn = document.querySelector(`.custom-vault-entry-parent-tab[data-parent-tab="${parentId}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }

            appState.currentCustomVaultParentTab = parentId;

            // Find the selected parent tab's children
            const selectedParent = customVaultEntryStructure.find(p => p.id === parentId);
            const childTabsContainer = document.getElementById('customVaultEntryChildTabs');

            if (selectedParent && childTabsContainer) {
                childTabsContainer.style.display = 'flex'; // Show the child tabs container
                childTabsContainer.innerHTML = selectedParent.children.map(childTab => `
                    <button class="sub-nav-tab custom-vault-entry-child-tab" data-child-tab="${childTab.id}">
                        <i class="${childTab.icon}"></i> ${childTab.name}
                    </button>
                `).join('');

                // Remove existing child tab listeners (already handled by bindEvents delegation)

                // Automatically activate the first child tab or the previously selected child tab under this parent
                let childToActivate = appState.currentCustomVaultEntrySubTab;
                if (!selectedParent.children.some(c => c.id === childToActivate)) {
                    childToActivate = selectedParent.children[0]?.id; // Default to first child if current is not in this parent
                }
                if (childToActivate) {
                    switchCustomVaultEntrySubTab(childToActivate);
                } else {
                    // No child tabs for this parent, clear display
                    appState.currentCustomVaultEntrySubTab = null;
                    appState.filters.category = '';
                    renderIntelligenceEntries();
                }

            } else {
                childTabsContainer.style.display = 'none'; // Hide if no children or container not found
                appState.currentCustomVaultEntrySubTab = null;
                appState.filters.category = '';
                renderIntelligenceEntries();
            }

            saveState(); // Save the parent tab state
        }


        // Load threat intelligence
        function loadThreats() {
            const threatsList = document.getElementById('threatsList');
            const mockThreats = [
                {
                    id: 1,
                    title: 'New Phishing Campaign Detected',
                    description: 'Targeting financial institutions with COVID-19 themed lures. Be cautious of emails resembling official health advisories.',
                    severity: 'high',
                    tags: ['phishing', 'covid-19', 'financial', 'email'],
                    timestamp: new Date(Date.now() - 3600000)
                },
                {
                    id: 2,
                    title: 'Malware Sample Analysis: Xylos Variant',
                    description: 'New variant of banking trojan "Xylos" discovered in the wild. It employs obfuscation techniques and targets online banking portals. Update your antivirus signatures immediately.',
                    severity: 'medium',
                    tags: ['malware', 'banking', 'trojan', 'xylos', 'analysis'],
                    timestamp: new Date(Date.now() - 7200000)
                },
                {
                    id: 3,
                    title: 'Data Breach Alert: Gaming Platform',
                    description: 'Credentials leak detected on underground forums originating from a popular gaming platform. Users are advised to change passwords and enable multi-factor authentication.',
                    severity: 'high',
                    tags: ['breach', 'credentials', 'darkweb', 'gaming'],
                    timestamp: new Date(Date.now() - 10800000)
                },
                {
                    id: 4,
                    title: 'Ransomware Attack on Healthcare Provider',
                    description: 'A critical ransomware attack impacted a regional healthcare provider, compromising patient data. Incident response teams are engaged, and data recovery efforts are underway. Backups are crucial!',
                    severity: 'high',
                    tags: ['ransomware', 'healthcare', 'data-loss', 'cyberattack'],
                    timestamp: new Date(Date.now() - 86400000 * 2) // 2 days ago
                },
                {
                    id: 5,
                    title: 'Zero-Day Exploit in Popular Web Server',
                    description: 'A zero-day vulnerability has been identified in a widely used web server software. Patches are not yet available. Organizations are advised to implement temporary mitigation strategies and monitor their logs closely.',
                    severity: 'medium',
                    tags: ['zero-day', 'vulnerability', 'web-server', 'exploit'],
                    timestamp: new Date(Date.now() - 86400000 * 5) // 5 days ago
                }
            ];

            // Sort threats by timestamp (most recent first)
            mockThreats.sort((a, b) => b.timestamp - a.timestamp);

            threatsList.innerHTML = mockThreats.map(threat => `
                <div class="threat-item">
                    <div class="threat-header">
                        <h4>${threat.title}</h4> <div class="threat-level threat-${threat.severity}">${threat.severity}</div> </div>
                    <p>${threat.description}</p> <div class="threat-tags">
                        ${threat.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="threat-time">${formatTime(threat.timestamp)}</div>
                </div>
            `).join('');

        }

        // Update analytics data (display)
        function updateAnalytics() {
            document.getElementById('toolsUsed').textContent = appState.usageStats.toolsUsedToday;
            renderMostUsedTools();
            renderNeverUsedTools();
            renderToolsAddedPerWeek();

            saveState();
        }

        function renderMostUsedTools() {
            const mostUsedToolsList = document.getElementById('mostUsedToolsList');
            const noMostUsedTools = document.getElementById('noMostUsedTools');
            
            // Combine all entry types that have lastUsed property and filter
            const allUsedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials]
                                    .filter(entry => entry.lastUsed > 0);

            const usedTools = allUsedEntries.sort((a, b) => b.lastUsed - a.lastUsed)
                                            .slice(0, 5); //
                  mostUsedToolsList.innerHTML = '';
            if (usedTools.length === 0) {
                noMostUsedTools.style.display = 'block';
            } else {
                noMostUsedTools.style.display = 'none';
                usedTools.forEach(entry => {
                    const listItem = document.createElement('li');
                    let name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    listItem.innerHTML = `<span>${name}</span><span>${formatTime(entry.lastUsed)}</span>`;
                    mostUsedToolsList.appendChild(listItem);
                });
            }
        }

        function renderNeverUsedTools() {
            const neverUsedToolsList = document.getElementById('neverUsedToolsList');
            const noNeverUsedTools = document.getElementById('noNeverUsedTools');

            // Combine all entry types
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            const neverUsed = allEntries.filter(entry => !entry.lastUsed || entry.lastUsed === 0)
                                        .sort((a, b) => {
                                            const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                                            const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                                            return nameA.localeCompare(nameB);
                                        });

            neverUsedToolsList.innerHTML = '';
            if (neverUsed.length === 0) {
                noNeverUsedTools.style.display = 'block';
            } else {
                noNeverUsedTools.style.display = 'none';
                neverUsed.forEach(entry => {
                    const listItem = document.createElement('li');
                    let name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    listItem.innerHTML = `<span>${name}</span><span>Never Used</span>`;
                    neverUsedToolsList.appendChild(listItem);
                });
            }
        }

        function renderToolsAddedPerWeek() {
            const toolsAddedPerWeekList = document.getElementById('toolsAddedPerWeekList');
            const noToolsAdded = document.getElementById('noToolsAdded');

            // Combine all entries that have an addedDate
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            const weeklyStats = {};
            allEntries.forEach(entry => {
                if (entry.addedDate) {
                    const date = new Date(entry.addedDate);
                    // Get the start of the week (e.g., Monday)
                    const day = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
                    const startOfWeek = new Date(date.setDate(diff));
                    startOfWeek.setHours(0, 0, 0, 0); // Normalize to start of day

                    const weekKey = startOfWeek.toISOString().split('T')[0]; // YYYY-MM-DD for week start
                    weeklyStats[weekKey] = (weeklyStats[weekKey] || 0) + 1;
                }
            });

            const sortedWeeks = Object.keys(weeklyStats).sort((a, b) => new Date(b) - new Date(a));

            toolsAddedPerWeekList.innerHTML = '';
            if (sortedWeeks.length === 0) {
                noToolsAdded.style.display = 'block';
            } else {
                noToolsAdded.style.display = 'none';
                sortedWeeks.forEach(weekKey => {
                    const count = weeklyStats[weekKey];
                    const weekStartDate = new Date(weekKey);
                    const options = {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    };
                    const formattedWeek = weekStartDate.toLocaleDateString(undefined, options);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>Week of ${formattedWeek}</span><span>${count} entries</span>`;
                    toolsAddedPerWeekList.appendChild(listItem);
                });
            }
        }


        // Format time for display
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp; // Difference in milliseconds

            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30.44); // Average days in a month
            const years = Math.floor(days / 365.25); // Average days in a year

            if (seconds < 60) {
                return seconds === 0 ? 'Just now' : `${seconds} second${seconds === 1 ? '' : 's'} ago`;
            } else if (minutes < 60) {
                return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
            } else if (hours < 24) {
                return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            } else if (days < 7) {
                return `${days} day${days === 1 ? '' : 's'} ago`;
            } else if (weeks < 4) {
                return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
            } else if (months < 12) {
                return `${months} month${months === 1 ? '' : 's'} ago`;
            } else {
                return `${years} year${years === 1 ? '' : 's'} ago`;
            }
        }


        // Universal Modal Functions
        function showModal(id) {
            document.getElementById(id).classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent scrolling background
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Display appropriate form fields based on selected entry type
        function displayEntryForm() {
            const entryType = document.getElementById('entryTypeSelect').value;
            document.querySelectorAll('.entry-fields').forEach(fieldSet => {
                fieldSet.style.display = 'none';
            });
            document.getElementById('entrySourceGroup').style.display = 'none'; // Hide by default
            document.getElementById('customMetadataGroup').style.display = 'none'; // Hide by default

            let fieldsToShow = [];
            switch (entryType) {
                case 'tool':
                    fieldsToShow = ['addToolFields'];
                    break;
                case 'email':
                    fieldsToShow = ['addEmailFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'phone':
                    fieldsToShow = ['addPhoneFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'crypto':
                    fieldsToShow = ['addCryptoFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'location':
                    fieldsToShow = ['addLocationFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'link':
                    fieldsToShow = ['addLinkFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'media':
                    fieldsToShow = ['addMediaFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'password':
                    fieldsToShow = ['addPasswordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'keyword':
                    fieldsToShow = ['addKeywordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'social':
                    fieldsToShow = ['addSocialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
            }

            fieldsToShow.forEach(id => {
                document.getElementById(id).style.display = 'block';
            });

            // Populate category dropdown for tools (if 'tool' is selected)
            if (entryType === 'tool') {
                populateCategoryFilter(); // Re-populate to ensure it's up-to-date
            }
        }

    // Handle adding a new entry (tool, email, etc.)
    async function handleAddEntry(e) {
        e.preventDefault();
        if (appState.readOnlyMode) {
            showToast("Cannot add entries in read-only shared view.", "warning");
            return;
        }

        const entryType = document.getElementById('entryTypeSelect').value;
        let newEntry = {
            id: generateId(),
            type: entryType,
            starred: false,
            pinned: false,
            lastUsed: 0,
            addedDate: new Date(),
            customTabs: [], // Initialize with empty array
            origin: 'user-added' // <--- Set this for user-added tools
        };

        // Collect custom metadata
        const customMetadata = [];
        document.querySelectorAll('#customMetadataEntries .metadata-entry').forEach(row => {
            const key = row.querySelector('.metadata-key').value.trim();
            const value = row.querySelector('.metadata-value').value.trim();
            if (key && value) {
                customMetadata.push({
                    key,
                    value
                });
            }
        });
        if (customMetadata.length > 0) {
            newEntry.metadata = customMetadata;
        }

        // Collect source
        const entrySource = document.getElementById('entrySource').value.trim();
        if (entrySource) {
            newEntry.source = entrySource;
        }


        switch (entryType) {
            case 'tool':
                const toolName = document.getElementById('toolName').value.trim();
                const toolUrl = document.getElementById('toolUrl').value.trim();
                let toolCategory = document.getElementById('toolCategory').value;
                const newCategoryInput = document.getElementById('newCategoryInput').value.trim();
                const toolDescription = document.getElementById('toolDescription').value.trim();
                const toolTags = document.getElementById('toolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

                if (!toolName || !toolUrl || !toolCategory) {
                    showToast('Please fill in all required tool fields (Name, URL, Category).', 'error');
                    return;
                }

                if (toolCategory === 'custom') {
                    if (!newCategoryInput) {
                        showToast('Please enter a custom category name.', 'error');
                        return;
                    }
                    toolCategory = newCategoryInput.toLowerCase();
                }

                newEntry = {
                    ...newEntry,
                    name: toolName,
                    url: toolUrl,
                    category: toolCategory,
                    description: toolDescription,
                    tags: toolTags,
                    favicon: `https://www.google.com/s2/favicons?domain=${new URL(toolUrl).hostname}`
                };
                appState.tools.push(newEntry);
                break;
            case 'email':
                const emailAddress = document.getElementById('emailAddress').value.trim();
                const emailNotes = document.getElementById('emailNotes').value.trim();
                const emailLinkedPlatforms = document.getElementById('emailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p);
                const emailBreachResults = document.getElementById('emailBreachResults').value.trim();

                if (!emailAddress) {
                    showToast('Please enter an email address.', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    email: emailAddress,
                    notes: emailNotes,
                    linkedPlatforms: emailLinkedPlatforms,
                    breachResults: emailBreachResults
                };
                appState.emails.push(newEntry);
                break;
            case 'phone':
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const phoneType = document.getElementById('phoneType').value;
                const phoneLocation = document.getElementById('phoneLocation').value.trim();
                const phoneNotes = document.getElementById('phoneNotes').value.trim();

                if (!phoneNumber) {
                    showToast('Please enter a phone number.', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    number: phoneNumber,
                    phoneType: phoneType,
                    location: phoneLocation,
                    notes: phoneNotes
                };
                appState.phones.push(newEntry);
                break;
            case 'crypto':
                const cryptoAddress = document.getElementById('cryptoAddress').value.trim();
                const cryptoTxid = document.getElementById('cryptoTxid').value.trim();
                const cryptoAmount = parseFloat(document.getElementById('cryptoAmount').value);
                const cryptoSource = document.getElementById('cryptoSource').value.trim();
                const cryptoTags = document.getElementById('cryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

                if (!cryptoAddress || !cryptoTxid || isNaN(cryptoAmount)) {
                    showToast('Please fill in all required crypto fields (Address, TXID, Amount).', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    address: cryptoAddress,
                    txid: cryptoTxid,
                    amount: cryptoAmount,
                    source: cryptoSource,
                    tags: cryptoTags
                };
                appState.crypto.push(newEntry);
                break;
            case 'location':
                const locationName = document.getElementById('locationName').value.trim();
                const locationCoordinates = document.getElementById('locationCoordinates').value.trim();
                const locationMapLink = document.getElementById('locationMapLink').value.trim();
                const locationNotes = document.getElementById('locationNotes').value.trim();
                const locationIpGeoIntel = document.getElementById('locationIpGeoIntel').value.trim();

                if (!locationName || !locationCoordinates) {
                    showToast('Please fill in all required location fields (Name, Coordinates).', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    name: locationName,
                    coordinates: locationCoordinates,
                    mapLink: locationMapLink,
                    notes: locationNotes,
                    ipGeoIntel: locationIpGeoIntel
                };
                appState.locations.push(newEntry);
                break;
            case 'link':
                const linkUrl = document.getElementById('linkUrl').value.trim();
                const linkPlatform = document.getElementById('linkPlatform').value.trim();
                const linkNotes = document.getElementById('linkNotes').value.trim();
                const linkTags = document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

                if (!linkUrl) {
                    showToast('Please enter a URL.', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    url: linkUrl,
                    platform: linkPlatform,
                    notes: linkNotes,
                    tags: linkTags
                };
                appState.links.push(newEntry);
                break;
            case 'media':
                const mediaTitle = document.getElementById('mediaTitle').value.trim();
                const mediaNotes = document.getElementById('mediaNotes').value.trim();
                const mediaType = document.getElementById('mediaType').value;
                const mediaFile = document.getElementById('mediaFile').files[0];
                let base64Data = '';

                if (!mediaTitle) {
                    showToast('Please enter a title for the media.', 'error');
                    return;
                }

                if (mediaFile) {
                    base64Data = await readFileAsBase64(mediaFile);
                    newEntry.base64Data = base64Data;
                } else if (document.getElementById('mediaBase64Data').value) {
                    // If there's existing base64 data (e.g., from an edit where file wasn't changed)
                    base64Data = document.getElementById('mediaBase64Data').value;
                    newEntry.base64Data = base64Data;
                } else {
                    showToast('Please upload a file for media entry.', 'error');
                    return;
                }

                newEntry = {
                    ...newEntry,
                    title: mediaTitle,
                    notes: mediaNotes,
                    mediaType: mediaType,
                    base64Data: base64Data // Storing base64 for local persistence
                };
                appState.media.push(newEntry);
                break;
            case 'password': // New
                const passwordService = document.getElementById('passwordService').value.trim();
                const passwordUsername = document.getElementById('passwordUsername').value.trim();
                const passwordValue = document.getElementById('passwordValue').value.trim();
                const passwordNotes = document.getElementById('passwordNotes').value.trim();
                const passwordStrength = document.getElementById('passwordStrength').value.trim();

                if (!passwordService || !passwordValue) {
                    showToast('Please fill in all required password fields (Service, Password).', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    service: passwordService,
                    username: passwordUsername,
                    password: passwordValue,
                    notes: passwordNotes,
                    strength: passwordStrength,
                    tags: [] // Passwords don't have tags in the form, but keep the property
                };
                appState.passwords.push(newEntry);
                break;
            case 'keyword': // New
                const keywordValue = document.getElementById('keywordValue').value.trim();
                const keywordContext = document.getElementById('keywordContext').value.trim();
                const keywordNotes = document.getElementById('keywordNotes').value.trim();

                if (!keywordValue) {
                    showToast('Please enter a keyword/phrase.', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    value: keywordValue,
                    context: keywordContext,
                    notes: keywordNotes,
                    tags: [] // Keywords don't have tags in the form, but keep the property
                };
                appState.keywords.push(newEntry);
                break;
            case 'social': // New
                const socialPlatform = document.getElementById('socialPlatform').value.trim();
                const socialUrl = document.getElementById('socialUrl').value.trim();
                const socialUsername = document.getElementById('socialUsername').value.trim();
                const socialNotes = document.getElementById('socialNotes').value.trim();
                const socialFollowCounts = document.getElementById('socialFollowCounts').value.trim();

                if (!socialPlatform || !socialUrl || !socialUsername) {
                    showToast('Please fill in all required social profile fields (Platform, URL, Username).', 'error');
                    return;
                }
                newEntry = {
                    ...newEntry,
                    platform: socialPlatform,
                    url: socialUrl,
                    username: socialUsername,
                    notes: socialNotes,
                    followCounts: socialFollowCounts,
                    tags: [] // Socials don't have tags in the form, but keep the property
                };
                appState.socials.push(newEntry);
                break;
        }

        // If in a custom tab, automatically assign the new entry to it
        if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (activeCustomTab && !activeCustomTab.toolIds.includes(newEntry.id)) {
                activeCustomTab.toolIds.push(newEntry.id);
                newEntry.customTabs.push(activeCustomTab.id); // Also update the entry itself
            }
        }

        hideModal('addEntryModal');
        document.getElementById('addEntryForm').reset(); // Reset form fields
        document.getElementById('customMetadataEntries').innerHTML = ''; // Clear metadata fields
        showToast('Entry added successfully!');
        updateStats();
        populateCategoryFilter(); // Update categories if a new tool category was added
        renderIntelligenceEntries(); // Re-render to show new entry
        renderCustomTabs(); // Re-render custom tabs to update counts/content
        saveState();
    }

            // Handle editing an existing entry
            async function handleEditEntry(e) {
                e.preventDefault();
                if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                    showToast("Cannot edit entries in read-only shared view.", "warning");
                    return;
                }

                const entryId = document.getElementById('editEntryId').value;
                const entryType = document.getElementById('editEntryType').value;

                let entryToEdit = null;
                let entryArray = null;

                switch (entryType) {
                    case 'tool':
                        entryArray = appState.tools;
                        break;
                    case 'email':
                        entryArray = appState.emails;
                        break;
                    case 'phone':
                        entryArray = appState.phones;
                        break;
                    case 'crypto':
                        entryArray = appState.crypto;
                        break;
                    case 'location':
                        entryArray = appState.locations;
                        break;
                    case 'link':
                        entryArray = appState.links;
                        break;
                    case 'media':
                        entryArray = appState.media;
                        break;
                    case 'password':
                        entryArray = appState.passwords;
                        break;
                    case 'keyword':
                        entryArray = appState.keywords;
                        break;
                    case 'social':
                        entryArray = appState.socials;
                        break;
                }

                if (entryArray) {
                    entryToEdit = entryArray.find(t => t.id === entryId);
                }

                if (!entryToEdit) {
                    showToast('Error: Entry not found for editing.', 'error');
                    return;
                }

                // Collect custom metadata
                const customMetadata = [];
                document.querySelectorAll('#editCustomMetadataEntries .metadata-entry').forEach(row => {
                    const key = row.querySelector('.metadata-key').value.trim();
                    const value = row.querySelector('.metadata-value').value.trim();
                    if (key && value) {
                        customMetadata.push({
                            key,
                            value
                        });
                    }
                });
                entryToEdit.metadata = customMetadata.length > 0 ? customMetadata : undefined; // Set to undefined if empty

                // Collect source
                const entrySource = document.getElementById('editEntrySource').value.trim();
                entryToEdit.source = entrySource || undefined; // Set to undefined if empty


                switch (entryType) {
                    case 'tool':
                        const editToolName = document.getElementById('editToolName').value.trim();
                        const editToolUrl = document.getElementById('editToolUrl').value.trim();
                        let editToolCategory = document.getElementById('editToolCategory').value;
                        const editNewCategoryInput = document.getElementById('editNewCategoryInput').value.trim();
                        const editToolDescription = document.getElementById('editToolDescription').value.trim();
                        const editToolTags = document.getElementById('editToolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
                        // MODIFIED: Get selected intelligence vault categories for tool being edited
                        const editedIntelligenceVaultCategories = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked'))
                            .map(checkbox => checkbox.value);
                        entryToEdit.intelligenceVaultCategories = editedIntelligenceVaultCategories;

                        if (!editToolName || !editToolUrl || !editToolCategory) {
                            showToast('Please fill in all required tool fields (Name, URL, Category).', 'error');
                            return;
                        }

                        if (editToolCategory === 'custom') {
                            if (!editNewCategoryInput) {
                                showToast('Please enter a custom category name.', 'error');
                                return;
                            }
                            editToolCategory = editNewCategoryInput.toLowerCase();
                        }

                        entryToEdit.name = editToolName;
                        entryToEdit.url = editToolUrl;
                        entryToEdit.category = editToolCategory;
                        entryToEdit.description = editToolDescription;
                        entryToEdit.tags = editToolTags;
                        entryToEdit.favicon = `https://www.google.com/s2/favicons?domain=${new URL(editToolUrl).hostname}`;
                        break;
                    case 'email':
                        entryToEdit.email = document.getElementById('editEmailAddress').value.trim();
                        entryToEdit.notes = document.getElementById('editEmailNotes').value.trim();
                        entryToEdit.linkedPlatforms = document.getElementById('editEmailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p);
                        entryToEdit.breachResults = document.getElementById('editEmailBreachResults').value.trim();
                        break;
                    case 'phone':
                        entryToEdit.number = document.getElementById('editPhoneNumber').value.trim();
                        entryToEdit.phoneType = document.getElementById('editPhoneType').value;
                        entryToEdit.location = document.getElementById('editPhoneLocation').value.trim();
                        entryToEdit.notes = document.getElementById('editPhoneNotes').value.trim();
                        break;
                    case 'crypto':
                        entryToEdit.address = document.getElementById('editCryptoAddress').value.trim();
                        entryToEdit.txid = document.getElementById('editCryptoTxid').value.trim();
                        entryToEdit.amount = parseFloat(document.getElementById('editCryptoAmount').value);
                        entryToEdit.source = document.getElementById('editCryptoSource').value.trim();
                        entryToEdit.tags = document.getElementById('editCryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
                        break;
                    case 'location':
                        entryToEdit.name = document.getElementById('editLocationName').value.trim();
                        entryToEdit.coordinates = document.getElementById('editLocationCoordinates').value.trim();
                        entryToEdit.mapLink = document.getElementById('editLocationMapLink').value.trim();
                        entryToEdit.notes = document.getElementById('editLocationNotes').value.trim();
                        entryToEdit.ipGeoIntel = document.getElementById('editLocationIpGeoIntel').value.trim();
                        break;
                    case 'link':
                        entryToEdit.url = document.getElementById('editLinkUrl').value.trim();
                        entryToEdit.platform = document.getElementById('editLinkPlatform').value.trim();
                        entryToEdit.notes = document.getElementById('editLinkNotes').value.trim();
                        entryToEdit.tags = document.getElementById('editLinkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
                        break;
                    case 'media':
                        entryToEdit.title = document.getElementById('editMediaTitle').value.trim();
                        entryToEdit.notes = document.getElementById('editMediaNotes').value.trim();
                        entryToEdit.mediaType = document.getElementById('editMediaType').value;

                        const editMediaFile = document.getElementById('editMediaFile').files[0];
                        if (editMediaFile) {
                            entryToEdit.base64Data = await readFileAsBase64(editMediaFile);
                        }
                        break;
                    case 'password':
                        entryToEdit.service = document.getElementById('editPasswordService').value.trim();
                        entryToEdit.username = document.getElementById('editPasswordUsername').value.trim();
                        entryToEdit.password = document.getElementById('editPasswordValue').value.trim();
                        entryToEdit.notes = document.getElementById('editPasswordNotes').value.trim();
                        entryToEdit.strength = document.getElementById('editPasswordStrength').value.trim();
                        break;
                    case 'keyword':
                        entryToEdit.value = document.getElementById('editKeywordValue').value.trim();
                        entryToEdit.context = document.getElementById('editKeywordContext').value.trim();
                        entryToEdit.notes = document.getElementById('editKeywordNotes').value.trim();
                        break;
                    case 'social':
                        entryToEdit.platform = document.getElementById('editSocialPlatform').value.trim();
                        entryToEdit.url = document.getElementById('editSocialUrl').value.trim();
                        entryToEdit.username = document.getElementById('editSocialUsername').value.trim();
                        entryToEdit.notes = document.getElementById('editSocialNotes').value.trim();
                        entryToEdit.followCounts = document.getElementById('editSocialFollowCounts').value.trim();
                        break;
                }

                // Update custom tab assignments for this entry
                const assignedCustomTabs = Array.from(document.querySelectorAll('#assignCustomTabsCheckboxes input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);

                // Clear existing custom tab assignments for this entry
                appState.customTabs.forEach(tab => {
                    tab.toolIds = tab.toolIds.filter(id => id !== entryId);
                });
                entryToEdit.customTabs = []; // Reset the entry's customTabs array

                // Add back selected assignments
                assignedCustomTabs.forEach(tabId => {
                    const tab = appState.customTabs.find(t => t.id === tabId);
                    if (tab) {
                        tab.toolIds.push(entryId);
                        entryToEdit.customTabs.push(tabId); // Also update the entry itself
                    }
                });


                hideModal('editEntryModal');
                showToast('Entry updated successfully!');
                updateStats();
                populateCategoryFilter();
                renderIntelligenceEntries();
                renderCustomTabs(); // Re-render custom tabs to update counts/content
                saveState();
            }

        // MODIFIED: Open the Edit Entry Modal and populate fields
        function openEditEntryModal(entry) {
            if (appState.readOnlyMode) {
                showToast("Cannot edit entries in read-only shared view.", "warning");
                return;
            }

            document.getElementById('editEntryId').value = entry.id;
            document.getElementById('editEntryType').value = entry.type;

            // Hide all entry-specific field sets and remove their 'required' attributes
            document.querySelectorAll('#editEntryModal .entry-fields').forEach(fieldSet => {
                fieldSet.style.display = 'none';
                fieldSet.querySelectorAll('[required]').forEach(input => {
                    input.removeAttribute('required');
                });
            });
            document.getElementById('editEntrySourceGroup').style.display = 'none';
            document.getElementById('editEntrySource').removeAttribute('required'); // Ensure source is also handled
            document.getElementById('editCustomMetadataGroup').style.display = 'none';


            // Populate custom metadata fields
            const editCustomMetadataEntries = document.getElementById('editCustomMetadataEntries');
            editCustomMetadataEntries.innerHTML = ''; // Clear previous entries
            if (entry.metadata && entry.metadata.length > 0) {
                entry.metadata.forEach(meta => addMetadataField('edit', meta.key, meta.value));
            }

            // Populate source field
            document.getElementById('editEntrySource').value = entry.source || '';

            let fieldsToShow = [];
            switch (entry.type) {
                case 'tool':
                    fieldsToShow = ['editToolFields'];
                    document.getElementById('editToolName').value = entry.name;
                    document.getElementById('editToolUrl').value = entry.url;
                    document.getElementById('editToolCategory').value = entry.category;
                    document.getElementById('editToolDescription').value = entry.description;
                    document.getElementById('editToolTags').value = entry.tags ? entry.tags.join(', ') : '';

                    // NEW: Clear EDIT modal's search input and populate its checkboxes
                    const editVaultCategorySearchInput = document.getElementById('editIntelligenceVaultCategorySearch');
                    if (editVaultCategorySearchInput) { // Safety check
                        editVaultCategorySearchInput.value = ''; // Clear search input
                    }
                    // Pass the tool's current assigned categories to populate the checkboxes
                    populateIntelligenceVaultCategoriesCheckboxesEditTool(entry.intelligenceVaultCategories || [], '');

                    // Handle custom category selection
                    const editNewCategoryInput = document.getElementById('editNewCategoryInput');
                    if (!document.getElementById('editToolCategory').value) { // If category is not in dropdown, it's custom
                        document.getElementById('editToolCategory').value = 'custom';
                        editNewCategoryInput.style.display = 'block';
                        editNewCategoryInput.value = entry.category;
                    } else {
                        editNewCategoryInput.style.display = 'none';
                        editNewCategoryInput.value = '';
                    }
                    // Add required attributes for visible tool fields
                    document.getElementById('editToolName').setAttribute('required', 'required');
                    document.getElementById('editToolUrl').setAttribute('required', 'required');
                    document.getElementById('editToolCategory').setAttribute('required', 'required');
                    if (editNewCategoryInput.style.display === 'block') { // If custom category is shown
                        editNewCategoryInput.setAttribute('required', 'required');
                    }
                    break;
                case 'email':
                    fieldsToShow = ['editEmailFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editEmailAddress').value = entry.email;
                    document.getElementById('editEmailNotes').value = entry.notes;
                    document.getElementById('editEmailLinkedPlatforms').value = entry.linkedPlatforms ? entry.linkedPlatforms.join(', ') : '';
                    document.getElementById('editEmailBreachResults').value = entry.breachResults;
                    // Add required attributes for visible email fields
                    document.getElementById('editEmailAddress').setAttribute('required', 'required');
                    break;
                case 'phone':
                    fieldsToShow = ['editPhoneFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editPhoneNumber').value = entry.number;
                    document.getElementById('editPhoneType').value = entry.phoneType;
                    document.getElementById('editPhoneLocation').value = entry.location;
                    document.getElementById('editPhoneNotes').value = entry.notes;
                    // Add required attributes for visible phone fields
                    document.getElementById('editPhoneNumber').setAttribute('required', 'required');
                    break;
                case 'crypto':
                    fieldsToShow = ['editCryptoFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editCryptoAddress').value = entry.address;
                    document.getElementById('editCryptoTxid').value = entry.txid;
                    document.getElementById('editCryptoAmount').value = entry.amount;
                    document.getElementById('editCryptoSource').value = entry.source;
                    document.getElementById('editCryptoTags').value = entry.tags ? entry.tags.join(', ') : '';
                    // Add required attributes for visible crypto fields
                    document.getElementById('editCryptoAddress').setAttribute('required', 'required');
                    document.getElementById('editCryptoTxid').setAttribute('required', 'required');
                    document.getElementById('editCryptoAmount').setAttribute('required', 'required');
                    break;
                case 'location':
                    fieldsToShow = ['editLocationFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editLocationName').value = entry.name;
                    document.getElementById('editLocationCoordinates').value = entry.coordinates;
                    document.getElementById('editLocationMapLink').value = entry.mapLink;
                    document.getElementById('editLocationNotes').value = entry.notes;
                    document.getElementById('editLocationIpGeoIntel').value = entry.ipGeoIntel;
                    // Add required attributes for visible location fields
                    document.getElementById('editLocationName').setAttribute('required', 'required');
                    document.getElementById('editLocationCoordinates').setAttribute('required', 'required');
                    break;
                case 'link':
                    fieldsToShow = ['editLinkFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editLinkUrl').value = entry.url;
                    document.getElementById('editLinkPlatform').value = entry.platform;
                    document.getElementById('editLinkNotes').value = entry.notes;
                    document.getElementById('editLinkTags').value = entry.tags ? entry.tags.join(', ') : '';
                    // Add required attributes for visible link fields
                    document.getElementById('editLinkUrl').setAttribute('required', 'required');
                    break;
                case 'media':
                    fieldsToShow = ['editMediaFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editMediaTitle').value = entry.title;
                    document.getElementById('editMediaNotes').value = entry.notes;
                    document.getElementById('editMediaType').value = entry.mediaType;
                    document.getElementById('editMediaBase64Data').value = entry.base64Data || ''; // Store existing base64
                    // Add required attributes for visible media fields
                    document.getElementById('editMediaTitle').setAttribute('required', 'required');
                    break;
                case 'password':
                    fieldsToShow = ['editPasswordFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editPasswordService').value = entry.service;
                    document.getElementById('editPasswordUsername').value = entry.username;
                    document.getElementById('editPasswordValue').value = entry.password;
                    document.getElementById('editPasswordNotes').value = entry.notes;
                    document.getElementById('editPasswordStrength').value = entry.strength;
                    // Add required attributes for visible password fields
                    document.getElementById('editPasswordService').setAttribute('required', 'required');
                    document.getElementById('editPasswordValue').setAttribute('required', 'required');
                    break;
                case 'keyword':
                    fieldsToShow = ['editKeywordFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editKeywordValue').value = entry.value;
                    document.getElementById('editKeywordContext').value = entry.context;
                    document.getElementById('editKeywordNotes').value = entry.notes;
                    // Add required attributes for visible keyword fields
                    document.getElementById('editKeywordValue').setAttribute('required', 'required');
                    break;
                case 'social':
                    fieldsToShow = ['editSocialFields', 'editEntrySourceGroup', 'editCustomMetadataGroup'];
                    document.getElementById('editSocialPlatform').value = entry.platform;
                    document.getElementById('editSocialUrl').value = entry.url;
                    document.getElementById('editSocialUsername').value = entry.username;
                    document.getElementById('editSocialNotes').value = entry.notes;
                    document.getElementById('editSocialFollowCounts').value = entry.followCounts;
                    // Add required attributes for visible social fields
                    document.getElementById('editSocialPlatform').setAttribute('required', 'required');
                    document.getElementById('editSocialUrl').setAttribute('required', 'required');
                    document.getElementById('editSocialUsername').setAttribute('required', 'required');
                    break;
            }

            fieldsToShow.forEach(id => {
                document.getElementById(id).style.display = 'block';
            });

            // Ensure source field is marked required if it's visible and needs to be
            if (fieldsToShow.includes('editEntrySourceGroup')) {
                // You can uncomment and adjust this if you want source to be required for specific types
                // document.getElementById('editEntrySource').setAttribute('required', 'required');
            }

            // Ensure metadata fields are marked required if they are visible
            if (fieldsToShow.includes('editCustomMetadataGroup')) {
                document.querySelectorAll('#editCustomMetadataEntries .metadata-entry').forEach(row => {
                    row.querySelector('.metadata-key').setAttribute('required', 'required');
                    row.querySelector('.metadata-value').setAttribute('required', 'required');
                });
            }

            // Populate custom tab assignment checkboxes
            populateCustomTabAssignmentCheckboxes(entry.customTabs || []);

            showModal('editEntryModal');
        }


        function populateIntelligenceVaultCategoriesCheckboxesEditTool(assignedCategories) {
            const container = document.getElementById('intelligenceVaultCategoriesAssignmentAddTool');
            container.style.display = 'block'; // Ensure it's visible in the edit modal

            const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesEditTool');
            checkboxesContainer.innerHTML = ''; // Clear previous checkboxes

            const intelligenceVaultCategories = [
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'emailTools', name: 'Email Tools', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Tools', icon: 'fas fa-phone' },
                { id: 'cryptoTools', name: 'Crypto Tools', icon: 'fas fa-coins' },
                { id: 'locationTools', name: 'Location Tools', icon: 'fas fa-map-marker-alt' },
                { id: 'linkTools', name: 'Link Tools', icon: 'fas fa-link' },
                { id: 'mediaTools', name: 'Media Tools', icon: 'fas fa-camera' },
                { id: 'passwordTools', name: 'Password Tools', icon: 'fas fa-key' },
                { id: 'keywordTools', name: 'Keyword Tools', icon: 'fas fa-font' },
                { id: 'socialTools', name: 'Social Tools', icon: 'fas fa-users' },
                { id: 'darkWebTools', name: 'DarkWeb Tools', icon: 'fas fa-mask' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Tools', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File/Malware Tools', icon: 'fas fa-file-code' },
                { id: 'threatIntelligenceTools', name: 'Threat Intelligence Tools', icon: 'fas fa-shield-alt' },
                { id: 'aiTools', name: 'AI Tools', icon: 'fas fa-brain' }
            ];

            intelligenceVaultCategories.forEach(category => {
                const isChecked = assignedCategories.includes(category.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) checkboxContainer.classList.add('checked');

                checkboxContainer.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="intelligence-vault-category-checkbox-edit-tool" 
                        value="${category.id}" 
                        ${isChecked ? 'checked' : ''}
                    >
                    <i class="${category.icon}" style="margin-right: 5px;"></i>
                    <span>${category.name}</span>
                `;
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Avoid attaching multiple listeners
            checkboxesContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('intelligence-vault-category-checkbox-edit-tool')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            }, 
        ); // Ensures this listener is attached only once
        }


        // Add a new metadata field row to the form
        function addMetadataField(formType, key = '', value = '') {
            const containerId = formType === 'add' ? 'customMetadataEntries' : 'editCustomMetadataEntries';
            const container = document.getElementById(containerId);
            const newRow = document.createElement('div');
            newRow.classList.add('form-group', 'metadata-entry');
            newRow.innerHTML = `
                <input type="text" class="metadata-key" name="${formType}_metadata_key_${Date.now()}" placeholder="Key" value="${key}" required>
                <input type="text" class="metadata-value" name="${formType}_metadata_value_${Date.now()}" placeholder="Value" value="${value}" required>
                <button type="button" class="remove-metadata-btn"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newRow);
        }


        // Generate a unique ID
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Show toast notifications
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger reflow to ensure animation plays
            void toast.offsetWidth;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), {
                    once: true
                });
            }, duration);
        }

        // Clear all filters
        function clearFilters() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot clear filters in read-only shared view.", "warning");
                return;
            }
            appState.filters.category = '';
            appState.filters.search = '';
            appState.filters.sort = 'name';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortFilter').value = 'name';
            renderIntelligenceEntries();
            showToast('Filters cleared!');
        }

        // Generate a report (mock function)
        function generateReport() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate reports in read-only shared view.", "warning");
                return;
            }
            showToast('Generating report... (Feature in development)', 'info');
            // In a real application, this would trigger a backend process or generate a downloadable file
        }

        // Export data as JSON
        function exportData() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export data in read-only shared view.", "warning");
                return;
            }
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'osintvault_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }

        // Toggle Grid/List View
        function toggleViewMode() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot change view mode in read-only shared view.", "warning");
                return;
            }
            appState.viewMode = appState.viewMode === 'grid' ? 'list' : 'grid';
            localStorage.setItem('viewMode', appState.viewMode); // Save view mode preference

            // Update text and icon for both toggle buttons
            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            const customVaultViewToggleButton = document.getElementById('customVaultViewToggle'); // NEW

            if (appState.viewMode === 'grid') {
                if (viewToggleButton) {
                    viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    viewToggleButton.title = 'Switch to List View';
                }
                if (vaultViewToggleButton) {
                    vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    vaultViewToggleButton.title = 'Switch to List View';
                }
                if (customVaultViewToggleButton) { // NEW
                    customVaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    customVaultViewToggleButton.title = 'Switch to List View';
                }
            } else {
                if (viewToggleButton) {
                    viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    viewToggleButton.title = 'Switch to Grid View';
                }
                if (vaultViewToggleButton) {
                    vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    vaultViewToggleButton.title = 'Switch to Grid View';
                }
                if (customVaultViewToggleButton) { // NEW
                    customVaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    customVaultViewToggleButton.title = 'Switch to Grid View';
                }
            }

            renderIntelligenceEntries(); // This function will now apply the correct view to the active tab's grid/list.
            showToast(`Switched to ${appState.viewMode} view.`);
        }

        // Theme Toggle
        function initTheme() {
            document.documentElement.setAttribute('data-theme', appState.theme);
            const themeToggleBtn = document.getElementById('themeToggle');
            if (appState.theme === 'dark') {
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggleBtn.title = 'Switch to Light Theme';
            } else {
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggleBtn.title = 'Switch to Dark Theme';
            }
        }

        function toggleTheme() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot change theme in read-only shared view.", "warning");
                return;
            }
            appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', appState.theme); // Save theme preference
            initTheme(); // Apply new theme
            showToast(`Switched to ${appState.theme} theme.`);
        }

        // Random Discovery (Tool or Tip)
        function showRandomDiscovery() {
            const randomItemDisplay = document.getElementById('randomItemDisplay');
            const randomBtn = document.getElementById('newRandomBtn');
            randomBtn.disabled = true; // Disable button during loading
            randomItemDisplay.innerHTML = '<div class="loading"></div> Loading discovery...';

            // Simulate API call delay
            setTimeout(() => {
                const allTools = appState.tools;
                const allTips = appState.osintTips;

                const hasTools = allTools.length > 0;
                const hasTips = allTips.length > 0;

                let content = '';

                if (hasTools && (!hasTips || Math.random() < 0.7)) { // Prioritize tools if available
                    const randomTool = allTools[Math.floor(Math.random() * allTools.length)];
                    const favicon = `https://www.google.com/s2/favicons?domain=${new URL(randomTool.url).hostname}`;
                    content = `
                        <p style="font-size: 1.1em; color: var(--text-primary); font-weight: 500;">Tool Recommendation:</p>
                        <a href="${randomTool.url}" target="_blank" class="random-tool-link" title="Visit ${randomTool.name}">
                            <img src="${favicon}" alt="" class="tool-favicon" onerror="this.src='https://placehold.co/18x18/cccccc/000000?text=?'">
                            <span>${randomTool.name}</span>
                            <i class="fas fa-external-link-alt" style="font-size: 0.7em; margin-left: 5px;"></i>
                        </a>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">${randomTool.description}</p>
                    `;
                } else if (hasTips) {
                    const randomTip = allTips[Math.floor(Math.random() * allTips.length)];
                    content = `
                        <p style="font-size: 1.1em; color: var(--text-primary); font-weight: 500;">OSINT Tip of the Day:</p>
                        <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 10px;">"${randomTip}"</p>
                    `;
                } else {
                    content = `
                        <p style="font-size: 0.9em; color: var(--text-secondary);">No tools or tips available yet. Add some to get started!</p>
                    `;
                }

                randomItemDisplay.innerHTML = content;
                randomBtn.disabled = false; // Re-enable button
            }, 500); // Simulate network delay
        }


        // Custom Tabs (Multi-Vault) Logic
        function renderCustomTabs() {
            const customSubTabsContainer = document.getElementById('customSubTabs');
            const createSubTabBtn = document.getElementById('createSubTabBtn');
            const editSubTabBtn = document.getElementById('editSubTabBtn');
            const deleteSubTabBtn = document.getElementById('deleteSubTabBtn');
            const exportSubTabBtn = document.getElementById('exportSubTabBtn');
            const addEntryBtnCustomVault = document.getElementById('addEntryBtnCustomVault'); // The "Add New Entry" button

            customSubTabsContainer.innerHTML = ''; // Clear existing tabs

            if (appState.customTabs.length === 0) {
                document.getElementById('emptyCustomTabState').style.display = 'block';
                document.getElementById('emptyCurrentCustomTabState').style.display = 'none';
                customSubTabsContainer.style.display = 'none';
                editSubTabBtn.style.display = 'none';
                deleteSubTabBtn.style.display = 'none';
                exportSubTabBtn.style.display = 'none';
                addEntryBtnCustomVault.style.display = 'none'; // Hide add entry button
                appState.currentCustomTab = null; // No custom tab selected
                renderIntelligenceEntries(); // Re-render to show empty state
                return;
            } else {
                document.getElementById('emptyCustomTabState').style.display = 'none';
                customSubTabsContainer.style.display = 'flex';
                editSubTabBtn.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
                deleteSubTabBtn.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
                exportSubTabBtn.style.display = 'inline-flex';
                addEntryBtnCustomVault.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
            }

            // Ensure a custom tab is selected if there are any
            if (!appState.currentCustomTab || !appState.customTabs.find(tab => tab.id === appState.currentCustomTab)) {
                appState.currentCustomTab = appState.customTabs[0].id;
            }

            appState.customTabs.forEach(tab => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('sub-nav-tab');
                if (tab.id === appState.currentCustomTab) {
                    tabButton.classList.add('active');
                    // Set active tab color
                    tabButton.style.backgroundColor = tab.color;
                    tabButton.style.color = 'white'; // Ensure text is white for contrast
                } else {
                    tabButton.style.color = 'var(--text-secondary)'; // Default text color for inactive
                }
                tabButton.dataset.subTabId = tab.id;
                tabButton.innerHTML = `<i class="${tab.icon}"></i> ${tab.name}`;
                customSubTabsContainer.appendChild(tabButton);
            });

            // Update the share options modal with custom tabs
            updateShareScopeSelect();

            renderIntelligenceEntries(); // Re-render content for the active custom tab
            saveState();
        }

        function switchCustomTab(tabId) {
            appState.currentCustomTab = tabId;
            renderCustomTabs(); // Re-render tabs to update active state
            renderIntelligenceEntries(); // Re-render entries for the newly active tab
            saveState();
        }

        function showCreateSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom vaults in read-only shared view.", "warning");
                return;
            }
            document.getElementById('createSubTabForm').reset();
            document.getElementById('newSubTabIcon').value = '';
            document.getElementById('newSubTabColor').value = '';

            populateIconPicker('newSubTabIconPicker', 'newSubTabIcon');
            populateColorPicker('newSubTabColorPicker', 'newSubTabColor');
            populateNewCustomVaultToolSelection(); // Populate tools for initial assignment

            showModal('createSubTabModal');
        }

        function handleCreateSubTab(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom vaults in read-only shared view.", "warning");
                return;
            }

            const newSubTabName = document.getElementById('newSubTabName').value.trim();
            const newSubTabIcon = document.getElementById('newSubTabIcon').value.trim() || 'fas fa-folder'; // Default icon
            const newSubTabColor = document.getElementById('newSubTabColor').value.trim() || 'var(--tab-color-default)'; // Default color

            if (!newSubTabName) {
                showToast('Please enter a vault name.', 'error');
                return;
            }

            const selectedToolIds = Array.from(document.querySelectorAll('#newCustomVaultToolSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            const newCustomTab = {
                id: generateId(),
                name: newSubTabName,
                icon: newSubTabIcon,
                color: newSubTabColor,
                toolIds: selectedToolIds // Assign selected tools
            };
            appState.customTabs.push(newCustomTab);

            // Update the customTabs property of the tools themselves
            selectedToolIds.forEach(toolId => {
                const tool = appState.tools.find(t => t.id === toolId);
                if (tool && !tool.customTabs.includes(newCustomTab.id)) {
                    tool.customTabs.push(newCustomTab.id);
                }
            });

            appState.currentCustomTab = newCustomTab.id; // Switch to the newly created tab
            hideModal('createSubTabModal');
            showToast('Custom Vault created successfully!');
            renderCustomTabs();
            saveState();
        }

        function openEditSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom vaults in read-only shared view.", "warning");
                return;
            }

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to edit.', 'warning');
                return;
            }

            document.getElementById('editSubTabId').value = activeCustomTab.id;
            document.getElementById('editedSubTabName').value = activeCustomTab.name;
            document.getElementById('editedSubTabIcon').value = activeCustomTab.icon;
            document.getElementById('editedSubTabColor').value = activeCustomTab.color;

            populateIconPicker('editedSubTabIconPicker', 'editedSubTabIcon', activeCustomTab.icon);
            populateColorPicker('editedSubTabColorPicker', 'editedSubTabColor', activeCustomTab.color);
            populateEditCustomVaultToolSelection(activeCustomTab.toolIds);

            showModal('editSubTabModal');
        }

        function handleEditSubTab(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom vaults in read-only shared view.", "warning");
                return;
            }

            const editedSubTabId = document.getElementById('editSubTabId').value;
            const editedSubTabName = document.getElementById('editedSubTabName').value.trim();
            const editedSubTabIcon = document.getElementById('editedSubTabIcon').value.trim() || 'fas fa-folder';
            const editedSubTabColor = document.getElementById('editedSubTabColor').value.trim() || 'var(--tab-color-default)';

            if (!editedSubTabName) {
                showToast('Please enter a vault name.', 'error');
                return;
            }

            const tabToEdit = appState.customTabs.find(tab => tab.id === editedSubTabId);
            if (tabToEdit) {
                tabToEdit.name = editedSubTabName;
                tabToEdit.icon = editedSubTabIcon;
                tabToEdit.color = editedSubTabColor;

                const selectedToolIds = Array.from(document.querySelectorAll('#editCustomVaultToolSelection input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);

                // Update customTabs property on all entries
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    // Remove this tab's ID if it was previously assigned
                    entry.customTabs = (entry.customTabs || []).filter(tabId => tabId !== editedSubTabId);
                    // Add it back if it's currently selected for this entry
                    if (selectedToolIds.includes(entry.id)) {
                        entry.customTabs.push(editedSubTabId);
                    }
                });

                tabToEdit.toolIds = selectedToolIds; // Update the tab's toolIds array

                hideModal('editSubTabModal');
                showToast('Custom Vault updated successfully!');
                renderCustomTabs();
                saveState();
            } else {
                showToast('Error: Custom Vault not found.', 'error');
            }
        }

        function handleDeleteSubTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot delete custom vaults in read-only shared view.", "warning");
                return;
            }

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to delete.', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to delete the custom vault "${activeCustomTab.name}"? This will NOT delete the entries within it, only remove them from this vault.`)) {
                // Remove this tab's ID from all entries that had it assigned
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    entry.customTabs = (entry.customTabs || []).filter(tabId => tabId !== activeCustomTab.id);
                });

                appState.customTabs = appState.customTabs.filter(tab => tab.id !== activeCustomTab.id);
                appState.currentCustomTab = appState.customTabs.length > 0 ? appState.customTabs[0].id : null; // Select first tab or null

                showToast('Custom Vault deleted successfully!', 'error');
                renderCustomTabs();
                saveState();
            }
        }

        function exportCustomTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export custom vaults in read-only shared view.", "warning");
                return;
            }
            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to export.', 'warning');
                return;
            }

            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const entriesInCustomTab = allEntries.filter(entry => activeCustomTab.toolIds.includes(entry.id));

            const exportData = {
                vaultName: activeCustomTab.name,
                vaultIcon: activeCustomTab.icon,
                vaultColor: activeCustomTab.color,
                entries: entriesInCustomTab
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `osintvault_custom_vault_${activeCustomTab.name.replace(/\s/g, '_').toLowerCase()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Custom Vault "${activeCustomTab.name}" exported successfully!`, 'success');
        }

        // Populate tool selection checkboxes for new custom vault
        function populateNewCustomVaultToolSelection() {
            const container = document.getElementById('newCustomVaultToolSelection');
            container.innerHTML = ''; // Clear previous selections

            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            if (allEntries.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No entries available to add.</p>';
                return;
            }

            allEntries.sort((a, b) => {
                const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                return nameA.localeCompare(nameB);
            }).forEach(entry => {
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="custom-vault-tool-checkbox" value="${entry.id}">
                    <i class="${getEntryIcon(entry.type)}" style="margin-right: 5px;"></i>
                    <span>${entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username}</span>
                `;
                container.appendChild(checkboxContainer);
            });
        }

        // Populate tool selection checkboxes for editing custom vault
        function populateEditCustomVaultToolSelection(currentToolIds) {
            const container = document.getElementById('editCustomVaultToolSelection');
            container.innerHTML = ''; // Clear previous selections

            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            if (allEntries.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No entries available to add.</p>';
                return;
            }

            allEntries.sort((a, b) => {
                const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                return nameA.localeCompare(nameB);
            }).forEach(entry => {
                const isChecked = currentToolIds.includes(entry.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) {
                    checkboxContainer.classList.add('checked');
                }
                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="custom-vault-tool-checkbox" value="${entry.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${getEntryIcon(entry.type)}" style="margin-right: 5px;"></i>
                    <span>${entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username}</span>
                `;
                container.appendChild(checkboxContainer);
            });
        }

        // Populate custom tab assignment checkboxes in Edit Entry Modal
        function populateCustomTabAssignmentCheckboxes(assignedTabIds) {
            const container = document.getElementById('assignCustomTabsCheckboxes');
            container.innerHTML = ''; // Clear previous checkboxes

            if (appState.customTabs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No custom vaults created yet.</p>';
                document.getElementById('assignCustomTabs').style.display = 'none'; // Hide section if no custom tabs
                return;
            } else {
                document.getElementById('assignCustomTabs').style.display = 'block';
            }

            appState.customTabs.forEach(tab => {
                const isChecked = assignedTabIds.includes(tab.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) {
                    checkboxContainer.classList.add('checked');
                }
                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="custom-tab-assign-checkbox" value="${tab.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${tab.icon}" style="margin-right: 5px; color: ${tab.color};"></i>
                    <span>${tab.name}</span>
                `;
                container.appendChild(checkboxContainer);
            });
        }

        // Helper to get icon based on entry type
        function getEntryIcon(type) {
            switch (type) {
                case 'tool':
                    return 'fas fa-tools';
                case 'email':
                    return 'fas fa-envelope';
                case 'phone':
                    return 'fas fa-phone';
                case 'crypto':
                    return 'fas fa-coins';
                case 'location':
                    return 'fas fa-map-marker-alt';
                case 'link':
                    return 'fas fa-link';
                case 'media':
                    return 'fas fa-camera';
                case 'password':
                    return 'fas fa-key';
                case 'keyword':
                    return 'fas fa-font';
                case 'social':
                    return 'fas fa-users';
                default:
                    return 'fas fa-question-circle';
            }
        }

        // Populate icon picker grid
        function populateIconPicker(containerId, inputId, selectedIcon = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            availableIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.classList.add('icon-picker-item');
                iconItem.dataset.iconClass = iconClass;
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                if (iconClass === selectedIcon) {
                    iconItem.classList.add('selected');
                }
                container.appendChild(iconItem);
            });

            // If a selectedIcon is provided but not in availableIcons, add it as selected
            if (selectedIcon && !availableIcons.includes(selectedIcon)) {
                const customIconItem = document.createElement('div');
                customIconItem.classList.add('icon-picker-item', 'selected');
                customIconItem.dataset.iconClass = selectedIcon;
                customIconItem.innerHTML = `<i class="${selectedIcon}"></i>`;
                container.prepend(customIconItem); // Add to the beginning
            }
        }

        // Populate color picker grid
        function populateColorPicker(containerId, inputId, selectedColor = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            availableColors.forEach(colorValue => {
                const colorItem = document.createElement('div');
                colorItem.classList.add('color-picker-item');
                colorItem.dataset.colorValue = colorValue;
                colorItem.style.backgroundColor = colorValue;
                if (colorValue === selectedColor) {
                    colorItem.classList.add('selected');
                }
                container.appendChild(colorItem);
            });

            // If a selectedColor is provided but not in availableColors, add it as selected
            if (selectedColor && !availableColors.includes(selectedColor)) {
                const customColorItem = document.createElement('div');
                customColorItem.classList.add('color-picker-item', 'selected');
                customColorItem.dataset.colorValue = selectedColor;
                customColorItem.style.backgroundColor = selectedColor;
                container.prepend(customColorItem); // Add to the beginning
            }
        }

        // File reader for base64 encoding (for media entries)
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // NEW: Shareable Link Logic
        function parseShareableLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedScope = urlParams.get('scope');
            const sharedTab = urlParams.get('tab'); // Can be 'allVault', 'allData', or a custom tab ID
            const sharedIds = urlParams.get('ids'); // Comma-separated list of IDs

            if (sharedScope && sharedTab && sharedIds) {
                appState.readOnlyMode = true;
                appState.sharedTabId = sharedTab;
                appState.sharedEntryIds = sharedIds.split(',');

                showToast("You are viewing a shared, read-only version of OSINTVault. Functionality is limited.", "info", 10000);

                // Disable all input fields and buttons
                disableAllInputsAndButtons();

                // Automatically switch to the correct tab and sub-tab based on the shared link
                if (sharedTab === 'allVault' || sharedTab === 'allData') {
                    // These scopes are not direct tabs, but influence what's shown.
                    // We'll default to intelligence-vault and let renderIntelligenceEntries handle the scope.
                    switchTab('intelligence-vault');
                    appState.filters.searchScope = sharedTab; // Set the search scope
                } else if (sharedTab.startsWith('custom-')) { // Assuming custom tab IDs start with 'custom-'
                    switchTab('custom-tabs');
                    switchCustomTab(sharedTab);
                } else { // Assume it's an intelligence vault sub-tab
                    switchTab('intelligence-vault');
                    switchIntelligenceVaultSubTab(sharedTab);
                }
            }
        }

        function disableAllInputsAndButtons() {
            document.querySelectorAll('input, select, textarea, button').forEach(element => {
                if (element.id !== 'themeToggle' && element.id !== 'continueAnywayBtn' && element.id !== 'searchInput' && element.id !== 'searchScopeSelect' && !element.classList.contains('nav-tab')) {
                    element.disabled = true;
                    element.style.pointerEvents = 'none';
                    element.style.opacity = '0.7';
                }
            });
            // Specific overrides for search and main tabs
            document.getElementById('searchInput').disabled = false;
            document.getElementById('searchInput').style.pointerEvents = 'auto';
            document.getElementById('searchInput').style.opacity = '1';

            document.getElementById('searchScopeSelect').disabled = false;
            document.getElementById('searchScopeSelect').style.pointerEvents = 'auto';
            document.getElementById('searchScopeSelect').style.opacity = '1';

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.disabled = false;
                tab.style.pointerEvents = 'auto';
                tab.style.opacity = '1';
            });

            // Hide add/edit/delete buttons in custom tabs
            document.getElementById('createSubTabBtn').style.display = 'none';
            document.getElementById('editSubTabBtn').style.display = 'none';
            document.getElementById('deleteSubTabBtn').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
            document.getElementById('addToolBtnEmptyState').style.display = 'none';
            document.getElementById('new-note-btn').style.display = 'none'; // Hide new note button
            document.getElementById('edit-note-btn').style.display = 'none'; // Hide edit note button
            document.getElementById('save-note-btn').style.display = 'none'; // Hide save note button
            document.getElementById('cancel-edit-note-btn').style.display = 'none'; // Hide cancel edit note button
            document.getElementById('back-to-notes-btn').style.display = 'none'; // Hide back to notes button
            document.getElementById('formatting-toolbar').style.display = 'none'; // Hide notes formatting toolbar
            document.getElementById('tag-input-container').style.display = 'none'; // Hide notes tag input
            document.getElementById('notes-list').querySelectorAll('.note-action-btn').forEach(btn => btn.style.display = 'none'); // Hide note action buttons

            // Hide bulk actions
            document.getElementById('bulkActions').style.display = 'none';
            document.getElementById('reportBtn').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('exportSubTabBtn').style.display = 'none';
        }

        function applyReadOnlyMode() {
            if (appState.readOnlyMode) {
                disableAllInputsAndButtons();
                // Ensure specific elements are hidden or disabled if they are part of the UI but not directly covered
                document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
                document.getElementById('addEntryBtnCustomVault').style.display = 'none';
                document.getElementById('createSubTabBtn').style.display = 'none';
                document.getElementById('editSubTabBtn').style.display = 'none';
                document.getElementById('deleteSubTabBtn').style.display = 'none';
                document.getElementById('exportSubTabBtn').style.display = 'none';
                document.getElementById('bulkActions').style.display = 'none';
                document.getElementById('reportBtn').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
                document.getElementById('refreshThreatsBtn').style.display = 'none';
                document.getElementById('newRandomBtn').style.display = 'none'; // Hide random discovery button
                document.getElementById('clearFiltersBtn').style.display = 'none'; // Hide clear filters button
                document.getElementById('pinAllBtn').style.display = 'none'; // Hide pin all button
                document.getElementById('starAllBtn').style.display = 'none'; // Hide star all button
                document.getElementById('viewToggle').style.display = 'none'; // Hide view toggle
                document.getElementById('vaultViewToggle').style.display = 'none'; // Hide vault view toggle
                document.getElementById('new-note-btn').style.display = 'none'; // Hide new note button
                document.getElementById('noteSortFilter').style.display = 'none'; // Hide note sort filter
                document.getElementById('search-notes').style.display = 'none'; // Hide note search

                // Ensure notes editor is read-only
                const noteContentEditor = document.getElementById('note-content-editor');
                if (noteContentEditor) {
                    noteContentEditor.setAttribute('contenteditable', 'false');
                    noteContentEditor.style.cursor = 'default';
                }
                const noteTitleInput = document.getElementById('note-title-input');
                if (noteTitleInput) {
                    noteTitleInput.readOnly = true;
                    noteTitleInput.style.cursor = 'default';
                }
            }
        }


        function showShareOptionsModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate new shared links in read-only view.", "warning");
                return;
            }
            // Populate the dropdown with custom tabs
            updateShareScopeSelect();
            showModal('shareOptionsModal');
        }

        function updateShareScopeSelect() {
            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const specificCustomTabOption = shareScopeSelect.querySelector('option[value="specificCustomTab"]');

            // Remove existing custom tab options
            Array.from(shareScopeSelect.options).forEach(option => {
                if (option.value.startsWith('custom-')) {
                    option.remove();
                }
            });

            // Add custom tabs as options
            if (appState.customTabs.length > 0) {
                specificCustomTabOption.style.display = 'block'; // Show the "Specific Custom Tab..." option
                appState.customTabs.forEach(tab => {
                    const option = document.createElement('option');
                    option.value = tab.id;
                    option.textContent = `Custom Vault: ${tab.name}`;
                    shareScopeSelect.appendChild(option);
                });
            } else {
                specificCustomTabOption.style.display = 'none'; // Hide if no custom tabs
            }

            // Also populate the specific custom tab selector if needed
            const selectCustomTabForSharing = document.getElementById('selectCustomTabForSharing');
            selectCustomTabForSharing.innerHTML = '';
            appState.customTabs.forEach(tab => {
                const option = document.createElement('option');
                option.value = tab.id;
                option.textContent = tab.name;
                selectCustomTabForSharing.appendChild(option);
            });

            // Ensure correct visibility of the specific custom tab selector
            handleShareScopeChange();
        }

        function handleShareScopeChange() {
            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const specificCustomTabSelector = document.getElementById('specificCustomTabSelector');
            if (shareScopeSelect.value === 'specificCustomTab') {
                specificCustomTabSelector.style.display = 'block';
            } else {
                specificCustomTabSelector.style.display = 'none';
            }
        }

        function handleShareFormSubmit(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate new shared links in read-only view.", "warning");
                return;
            }

            const shareScope = document.getElementById('shareScopeSelect').value;
            let targetTabId = '';
            let sharedEntries = [];

            if (shareScope === 'currentTab') {
                targetTabId = appState.currentTab;
                if (targetTabId === 'intelligence-vault') {
                    targetTabId = appState.currentIntelligenceVaultSubTab; // Use sub-tab ID for intel vault
                    sharedEntries = filterEntries(); // Filtered entries for current intel vault sub-tab
                } else if (targetTabId === 'custom-tabs') {
                    if (!appState.currentCustomTab) {
                        showToast('No custom vault selected to share.', 'error');
                        return;
                    }
                    targetTabId = appState.currentCustomTab; // Use custom tab ID
                    sharedEntries = filterEntries(); // Filtered entries for current custom tab
                } else {
                    // For other tabs like analytics or threats, we might not have 'entries' in the same way
                    // For now, let's assume 'currentTab' means the currently displayed entries.
                    // If no specific entries are filtered, it will be empty.
                    sharedEntries = filterEntries();
                }
            } else if (shareScope === 'allVault') {
                targetTabId = 'allVault';
                sharedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            } else if (shareScope === 'allData') {
                targetTabId = 'allData';
                sharedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            } else if (shareScope === 'specificCustomTab') {
                targetTabId = document.getElementById('selectCustomTabForSharing').value;
                if (!targetTabId) {
                    showToast('Please select a custom vault to share.', 'error');
                    return;
                }
                const customTab = appState.customTabs.find(tab => tab.id === targetTabId);
                if (customTab) {
                    const allEntriesCombined = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                    sharedEntries = allEntriesCombined.filter(entry => (entry.customTabs || []).includes(customTab.id));
                }
            } else { // A specific custom tab ID selected directly
                targetTabId = shareScope;
                const customTab = appState.customTabs.find(tab => tab.id === targetTabId);
                if (customTab) {
                    const allEntriesCombined = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                    sharedEntries = allEntriesCombined.filter(entry => (entry.customTabs || []).includes(customTab.id));
                }
            }

            if (sharedEntries.length === 0) {
                showToast('No entries found to share in the selected scope.', 'warning');
                return;
            }

            const sharedIds = sharedEntries.map(entry => entry.id).join(',');
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('scope', shareScope);
            currentUrl.searchParams.set('tab', targetTabId);
            currentUrl.searchParams.set('ids', sharedIds);

            const shareableLink = currentUrl.toString();

            // Display the link and offer to copy
            promptForCopyLink(shareableLink);
            hideModal('shareOptionsModal');
        }

        function promptForCopyLink(link) {
            const modalContent = `
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-share-alt"></i> Shareable Link Generated</h3>
                <p style="margin-bottom: 15px; color: var(--text-primary);">
                    Copy this link to share a read-only view of your selected intelligence:
                </p>
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border); word-break: break-all; margin-bottom: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;">
                    ${link}
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" id="closeShareLinkModal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyShareLinkBtn">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            `;
            const shareLinkModal = document.createElement('div');
            shareLinkModal.classList.add('modal');
            shareLinkModal.id = 'shareLinkDisplayModal';
            shareLinkModal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
            document.body.appendChild(shareLinkModal);
            showModal('shareLinkDisplayModal');

            document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
                copyToClipboard(link);
                showToast('Link copied to clipboard!');
                hideModal('shareLinkDisplayModal');
                shareLinkModal.remove();
            });

            document.getElementById('closeShareLinkModal').addEventListener('click', () => {
                hideModal('shareLinkDisplayModal');
                shareLinkModal.remove();
            });
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textarea);
        }

        // NEW: Desktop Recommendation Modal
        function checkAndShowDesktopRecommendation() {
            // Only show if not in read-only mode and hasn't been shown this session
            if (!appState.readOnlyMode && !sessionStorage.getItem('desktopRecommendationShown')) {
                if (window.innerWidth < 1024) { // Adjust breakpoint as needed
                    showModal('desktopRecommendationModal');
                }
            }
        }

        /* -------------------------------------------------------------------------- */
        /* OSINT Handbook & Notes JS                         */
        /* -------------------------------------------------------------------------- */

        // Initialize both handbook and notes
        function initHandbookAndNotes() {
            // Initialize the active subtab based on appState
            const activeSubtab = appState.currentHandbookSubTab || 'handbook';
            
            // Switch to the appropriate subtab
            switchHandbookSubtab(activeSubtab);
            
            // Initialize handbook functionality
            initHandbook();
            
            // Initialize notes functionality
            initNotes();
            }

        // Switch between Handbook and Notes subtabs
        function switchHandbookSubtab(subtabName) {
            // Store the current subtab in appState
            appState.currentHandbookSubTab = subtabName;
            
            // Update subtab buttons
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSubTabBtn = document.querySelector(`.handbook-subtab[data-subtab="${subtabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            
            // Update content containers
            document.querySelectorAll('.handbook-subtab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const targetContent = document.getElementById(`${subtabName}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // Save state
            saveState();
        }

        // Toggle mobile handbook sidebar
        function toggleHandbookSidebar() {
            const sidebar = document.getElementById('handbook-sidebar');
            const body = document.body; // Get the body element

            sidebar.classList.toggle('mobile-open');

            // Toggle a class on the body to prevent scrolling when sidebar is open
            body.classList.toggle('handbook-overlay-active', sidebar.classList.contains('mobile-open'));
            }


            // Initialize notes functionality
            function initNotes() {
            loadNotes();
            renderNotesList();
            setupNotesEventListeners();
        }

        // Load notes from localStorage
        function loadNotes() {
            const savedNotes = localStorage.getItem('osintNotes');
            if (savedNotes) {
                notesState.notes = JSON.parse(savedNotes);
                // Convert string dates back to Date objects and ensure 'pinned' exists
                notesState.notes.forEach(note => {
                note.createdAt = new Date(note.createdAt);
                note.updatedAt = new Date(note.updatedAt);
                // NEW: Ensure pinned property exists, default to false
                if (typeof note.pinned === 'undefined') {
                    note.pinned = false;
                }
                });

                // Sort notes with the new sorting logic
                sortNotes();
            }
            // NEW: Set initial value of the sort filter dropdown
            const noteSortFilterElement = document.getElementById('noteSortFilter');
            if (noteSortFilterElement) {
                noteSortFilterElement.value = notesState.noteSortFilter;
            }
        }

        // NEW/MODIFIED: Sort notes based on pinned status and selected filter
        function sortNotes() {
            const currentSort = notesState.noteSortFilter;

            notesState.notes.sort((a, b) => {
                // Pinned notes always come first
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;

                // Then apply the selected sort order
                switch (currentSort) {
                    case 'updated_desc':
                        return new Date(b.updatedAt) - new Date(a.updatedAt);
                    case 'updated_asc':
                        return new Date(a.updatedAt) - new Date(b.updatedAt);
                    case 'created_desc':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'created_asc':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'title_asc':
                        return a.title.localeCompare(b.title);
                    case 'title_desc':
                        return b.title.localeCompare(a.title);
                    default:
                        return 0; // Should not happen
                }
            });
            saveNotes(); // Save state after sorting
        }

        // Save notes to localStorage
        function saveNotes() {
            localStorage.setItem('osintNotes', JSON.stringify(notesState.notes));
        }


        // Render the notes list
        function renderNotesList() {
            const notesListContainer = document.getElementById('notes-list');
            if (!notesListContainer) return;

            if (notesState.notes.length === 0) {
                notesListContainer.innerHTML = `
                <div class="notes-empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Notes Yet</h3>
                    <p>Create your first note to get started!</p>
                </div>
                `;
                return;
            }

            // Create the grid layout for notes
            let notesHTML = '<div class="notes-grid">';

            // Notes are already sorted by sortNotes() before calling renderNotesList()
            notesState.notes.forEach(note => {
                // Get the first 5 lines of content or 150 characters, whichever is shorter
                let previewContent = note.content;

                // Remove HTML tags for the preview
                previewContent = previewContent.replace(/<[^>]*>/g, '');

                // Get the first 5 lines or 150 characters
                const lines = previewContent.split('\n').slice(0, 5).join('\n');
                previewContent = lines.length > 150 ? lines.substring(0, 147) + '...' : lines;

                const dateFormatted = formatDate(note.updatedAt);
                notesHTML += `
                        <div class="note-card ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}">
                            <div class="note-card-header">
                            <h3 class="note-title">${note.title}</h3>
                            <div class="note-actions">
                                <button class="note-action-btn pin-note ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}" title="${note.pinned ? 'Unpin Note' : 'Pin Note'}">
                                <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="note-action-btn edit-note" data-note-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete-note" data-note-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                            <div class="note-preview">${previewContent}</div>
                            <div class="note-footer">
                            <span class="note-date">Last updated: ${dateFormatted}</span>
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            </div>
                        </div>
                        `; // <--- Ensure this closing backtick is here!
                    });
                    
                    notesHTML += '</div>';
                    notesListContainer.innerHTML = notesHTML;
            // Add event listeners to note cards
            addNoteCardListeners();
        }

        // Format date in a human-readable way
        function formatDate(date) {
            const now = new Date();
            const noteDate = new Date(date);
            const diffTime = Math.abs(now - noteDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // Today, show time
                return `Today at ${noteDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (diffDays === 1) {
                // Yesterday
                return 'Yesterday';
            } else if (diffDays < 7) {
                // Within a week
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[noteDate.getDay()];
            } else {
                // Older than a week
                return noteDate.toLocaleDateString();
            }
        }


        // Add event listeners to note cards
        function addNoteCardListeners() {
            // Note card click (open note)
            document.querySelectorAll('.note-card').forEach(card => {
                card.addEventListener('click', (e) => {
                // Ignore clicks on action buttons
                if (!e.target.closest('.note-actions')) {
                    const noteId = card.dataset.noteId;
                    openNote(noteId);
                }
                });
            });

            // Edit button click (on note card in list view)
            document.querySelectorAll('.edit-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                editNote(noteId);
                });
            });

            // Delete button click (on note card in list view)
            document.querySelectorAll('.delete-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                deleteNote(noteId);
                });
            });

            // NEW: Pin button click (on note card in list view)
            document.querySelectorAll('.pin-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                togglePinNote(noteId);
                });
            });
        }

        // Setup event listeners for notes interface
        function setupNotesEventListeners() {
            // New note button
            const newNoteBtn = document.getElementById('new-note-btn');
            if (newNoteBtn) {
                newNoteBtn.addEventListener('click', createNewNote);
            }

            // Back button (from editor to list)
            const backToNotesBtn = document.getElementById('back-to-notes-btn');
            if (backToNotesBtn) {
                backToNotesBtn.addEventListener('click', () => {
                showNotesList();
                });
            }

            // Save note button
            const saveNoteBtn = document.getElementById('save-note-btn');
            if (saveNoteBtn) {
                saveNoteBtn.addEventListener('click', saveCurrentNote);
            }

            // Edit note button in editor view
            const editNoteInEditorBtn = document.getElementById('edit-note-btn');
            if (editNoteInEditorBtn) {
                editNoteInEditorBtn.addEventListener('click', () => {
                notesState.editMode = true;
                showNoteEditor();
                focusEditor();
                });
            }

            // NEW: Cancel edit button listener
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn');
            if (cancelEditNoteBtn) {
                cancelEditNoteBtn.addEventListener('click', () => {
                    // Discard changes by reverting editMode and re-showing editor (which loads original content)
                    notesState.editMode = false;
                    showNoteEditor();
                    showToast('Changes discarded.', 'info'); // Provide feedback
                });
            }

            // Search notes
            const searchNotesInput = document.getElementById('search-notes');
            if (searchNotesInput) {
                searchNotesInput.addEventListener('input', (e) => {
                searchNotes(e.target.value);
                });
            }

            // Sort notes dropdown listener
            const noteSortFilterElement = document.getElementById('noteSortFilter');
            if (noteSortFilterElement) {
                noteSortFilterElement.addEventListener('change', (e) => {
                    notesState.noteSortFilter = e.target.value;
                    localStorage.setItem('noteSortFilter', notesState.noteSortFilter);
                    sortNotes();
                    renderNotesList();
                });
            }

            // Tag input (add tags with Enter or comma)
            const tagInput = document.getElementById('note-tags-input');
            if (tagInput) {
                tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTagToCurrentNote();
                }
                });
            }

            // Add tag button
            const addTagBtn = document.getElementById('add-tag-btn');
            if (addTagBtn) {
                addTagBtn.addEventListener('click', addTagToCurrentNote);
            }
        }

        // NEW: Function to toggle pin status of a note
        function togglePinNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;

            note.pinned = !note.pinned; // Toggle the pinned status
            note.updatedAt = new Date(); // Update timestamp to re-sort if needed

            showToast(note.pinned ? 'Note pinned!' : 'Note unpinned!');

            sortNotes();      // Re-sort to bring pinned notes to top
            renderNotesList(); // Re-render to show updated pin status and order
        }


        // Create a new note
        function createNewNote() {
            const newNote = {
                id: generateNoteId(),
                title: 'Untitled Note',
                content: '',
                createdAt: new Date(),
                updatedAt: new Date(),
                tags: [],
                // NEW: Add pinned property
                pinned: false
            };

            notesState.notes.unshift(newNote);
            notesState.currentNote = newNote.id;
            notesState.editMode = true;

            saveNotes();
            showNoteEditor();
            focusEditor();
        }

        // Generate a unique ID for a note
        function generateNoteId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // Open a note
        function openNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesState.currentNote = noteId;
            notesState.editMode = false;
            
            showNoteEditor();
        }


        // Edit a note
        function editNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesState.currentNote = noteId;
            notesState.editMode = true;
            
            showNoteEditor();
            focusEditor();
        }

        // Delete a note
        function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            notesState.notes = notesState.notes.filter(note => note.id !== noteId);

            if (notesState.currentNote === noteId) {
                notesState.currentNote = null;
                // If current note is deleted, go back to list view which will re-render
                showNotesList(); 
            } else {
                // If a different note is deleted, just re-sort and re-render the list
                sortNotes();
                renderNotesList();
            }

            saveNotes(); // Ensure state is saved after deletion
        }

        // Show the notes list view
        function showNotesList() {
            document.getElementById('notes-list-view').style.display = 'block';
            document.getElementById('note-editor-view').style.display = 'none';
            
            renderNotesList();
        }

        // Show the note editor view
        function showNoteEditor() {
            document.getElementById('notes-list-view').style.display = 'none';
            document.getElementById('note-editor-view').style.display = 'block';

            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;

            // Set editor content
            document.getElementById('note-title-input').value = note.title;
            document.getElementById('note-content-editor').innerHTML = note.content;

            // Set read-only status based on edit mode
            document.getElementById('note-title-input').readOnly = !notesState.editMode;
            document.getElementById('note-content-editor').contentEditable = notesState.editMode;

            // Get button references
            const saveNoteBtn = document.getElementById('save-note-btn');
            const editNoteBtn = document.getElementById('edit-note-btn');
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn'); // NEW reference
            const tagInputContainer = document.getElementById('tag-input-container');
            const formattingToolbar = document.getElementById('formatting-toolbar');

            // Show/hide appropriate buttons and elements based on editMode
            if (notesState.editMode) {
                saveNoteBtn.style.display = 'inline-flex';
                cancelEditNoteBtn.style.display = 'inline-flex'; // NEW: Show cancel button in edit mode
                editNoteBtn.style.display = 'none';
                tagInputContainer.style.display = 'flex';
                formattingToolbar.style.display = 'flex';
            } else {
                saveNoteBtn.style.display = 'none';
                cancelEditNoteBtn.style.display = 'none'; // NEW: Hide cancel button in preview mode
                editNoteBtn.style.display = 'inline-flex';
                tagInputContainer.style.display = 'none';
                formattingToolbar.style.display = 'none';
            }

            // Render tags
            renderNoteTags();

            // If in edit mode, setup the rich text editor (only needed once, but safe to call)
            if (notesState.editMode) {
                setupRichTextEditor();
            }
        }


        // Render the tags for the current note
        function renderNoteTags() {
            const tagsContainer = document.getElementById('note-tags-container');
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            
            if (!note) return;
            
            tagsContainer.innerHTML = note.tags.map(tag => `
                <div class="note-tag">
                <span>${tag}</span>
                ${notesState.editMode ? `<button class="remove-tag-btn" data-tag="${tag}"><i class="fas fa-times"></i></button>` : ''}
                </div>
            `).join('');
            
            // Add event listeners to remove tag buttons
            if (notesState.editMode) {
                document.querySelectorAll('.remove-tag-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tagToRemove = btn.dataset.tag;
                    removeTagFromCurrentNote(tagToRemove);
                });
                });
            }
        }


        // Add a tag to the current note
        function addTagToCurrentNote() {
            const tagInput = document.getElementById('note-tags-input');
            const tagValue = tagInput.value.trim();
            
            if (!tagValue) return;
            
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;
            
            // Don't add duplicate tags
            if (!note.tags.includes(tagValue)) {
                note.tags.push(tagValue);
                note.updatedAt = new Date();
                saveNotes();
                renderNoteTags();
            }
            
            // Clear the input
            tagInput.value = '';
        }

        // Remove a tag from the current note
        function removeTagFromCurrentNote(tag) {
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;
            
            note.tags = note.tags.filter(t => t !== tag);
            note.updatedAt = new Date();
            saveNotes();
            renderNoteTags();
        }

        // Save the current note
        function saveCurrentNote() {
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;

            // NEW: Confirmation dialog
            if (!confirm('Are you sure you want to save changes to this note?')) {
                showToast('Save cancelled.', 'info'); // User clicked cancel
                return;
            }

            note.title = document.getElementById('note-title-input').value || 'Untitled Note';
            note.content = document.getElementById('note-content-editor').innerHTML;
            note.updatedAt = new Date(); // Update timestamp on save

            saveNotes();
            sortNotes(); // Re-sort notes after saving to reflect new updatedAt/pinned status

            // Switch to view mode
            notesState.editMode = false;
            showNoteEditor(); // Show editor in read-only mode

            // Show success message
            showToast('Note saved successfully!');
        }



        // Search notes by title, content, or tags
        function searchNotes(searchTerm) {
            searchTerm = searchTerm.toLowerCase();

            const filteredNotes = notesState.notes.filter(note => {
                const titleMatch = note.title.toLowerCase().includes(searchTerm);
                const contentMatch = note.content.toLowerCase().includes(searchTerm);
                const tagMatch = note.tags.some(tag => tag.toLowerCase().includes(searchTerm));

                return titleMatch || contentMatch || tagMatch;
            });

            const notesListContainer = document.getElementById('notes-list');

            // NEW: Apply sorting to filtered notes before rendering
            // Temporarily set notesState.notes to filteredNotes for sorting, then revert
            const originalNotes = notesState.notes;
            notesState.notes = filteredNotes;
            sortNotes(); // Sorts the (temporarily) filtered array
            const sortedFilteredNotes = notesState.notes;
            notesState.notes = originalNotes; // Revert to original full notes array

            if (sortedFilteredNotes.length === 0) {
                notesListContainer.innerHTML = `
                <div class="notes-empty-state">
                    <i class="fas fa-search"></i>
                    <h3>No matching notes found</h3>
                    <p>Try a different search term</p>
                </div>
                `;
                return;
            }

            // Create the grid layout for filtered notes
            let notesHTML = '<div class="notes-grid">';

            sortedFilteredNotes.forEach(note => {
                // Get the first 5 lines of content or 150 characters, whichever is shorter
                let previewContent = note.content;

                // Remove HTML tags for the preview
                previewContent = previewContent.replace(/<[^>]*>/g, '');

                // Get the first 5 lines or 150 characters
                const lines = previewContent.split('\n').slice(0, 5).join('\n');
                previewContent = lines.length > 150 ? lines.substring(0, 147) + '...' : lines;

                const dateFormatted = formatDate(note.updatedAt);

                notesHTML += `
                        <div class="note-card ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}">
                            <div class="note-card-header">
                            <h3 class="note-title">${note.title}</h3>
                            <div class="note-actions">
                                <button class="note-action-btn pin-note ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}" title="${note.pinned ? 'Unpin Note' : 'Pin Note'}">
                                <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="note-action-btn edit-note" data-note-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete-note" data-note-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                            <div class="note-preview">${previewContent}</div>
                            <div class="note-footer">
                            <span class="note-date">${dateFormatted}</span>
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            </div>
                        </div>
                        `; // <--- Ensure this closing backtick is here!
                    });
                    
                    notesHTML += '</div>';
                    notesListContainer.innerHTML = notesHTML;
            
            // Add event listeners to note cards (these will be for the filtered set)
            addNoteCardListeners();

            // If no search term, re-render full list with original sort
            if (!searchTerm) {
                renderNotesList();
            }
        }

        // Setup rich text editor
        function setupRichTextEditor() {
            const editor = document.getElementById('note-content-editor');
            const toolbar = document.getElementById('formatting-toolbar');
            
            // Make sure we have both elements
            if (!editor || !toolbar) return;
            
            // Add command handling for toolbar buttons
            toolbar.querySelectorAll('.formatting-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                const command = btn.dataset.command;
                const value = btn.dataset.value || null;
                
                if (command === 'createLink') {
                    const url = prompt('Enter the URL:');
                    if (url) {
                    document.execCommand(command, false, url);
                    }
                } else if (command === 'formatBlock') {
                    document.execCommand(command, false, value);
                } else {
                    document.execCommand(command, false, value);
                }
                
                editor.focus();
                });
            });
        }

        // Focus the editor
        function focusEditor() {
        setTimeout(() => {
            const titleInput = document.getElementById('note-title-input');
            if (titleInput) {
            titleInput.focus();
            titleInput.select();
            }
        }, 100);
        }

        // Show a toast notification
        function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'error' ? 'times-circle' : 'exclamation-circle')}"></i>
            ${message}
        `;
        
        document.body.appendChild(toast);
        
        // Force reflow to ensure animation plays
        void toast.offsetWidth; 
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
            document.body.removeChild(toast);
            }, 300); // Wait for fade out animation
        }, 3000);
        }


        // Render the handbook sidebar and initialize content
        function initHandbook() {
        const handbookSidebar = document.getElementById('handbook-sidebar');
        if (!handbookSidebar) return;

        // Render the sidebar
        renderHandbookSidebar();
        
        // Show the first section by default
        if (handbookData.sections.length > 0) {
            const firstSection = handbookData.sections[0];
            showHandbookSection(firstSection.id);
        }
        
        // Load saved user notes
        loadUserNotes();
        }

        // Render the handbook sidebar navigation
        function renderHandbookSidebar() {
        const sidebar = document.getElementById('handbook-sidebar');
        let sidebarHTML = '';
        
        handbookData.sections.forEach(section => {
            if (section.isCategory) {
            // This is a category with subcategories
            sidebarHTML += `
                <div class="handbook-category">
                <div class="handbook-category-header" data-category="${section.id}">
                    <i class="${section.icon}"></i>
                    <span>${section.title}</span>
                    <i class="fas fa-chevron-down category-toggle"></i>
                </div>
                <div class="handbook-subcategories" id="${section.id}-subcategories">
            `;
            
            section.subcategories.forEach(subcategory => {
                sidebarHTML += `
                <div class="handbook-nav-item" data-section="${subcategory.id}">
                    <i class="${subcategory.icon}"></i>
                    <span>${subcategory.title}</span>
                </div>
                `;
            });
            
            sidebarHTML += `
                </div>
                </div>
            `;
            } else {
            // This is a standalone section
            sidebarHTML += `
                <div class="handbook-nav-item" data-section="${section.id}">
                <i class="${section.icon}"></i>
                <span>${section.title}</span>
                </div>
            `;
            }
        });
        
        sidebar.innerHTML = sidebarHTML;
        
        // Add event listeners for sidebar navigation
        addHandbookSidebarListeners();
        }

        // Add event listeners to the handbook sidebar
        function addHandbookSidebarListeners() {
        // Category headers toggle
        document.querySelectorAll('.handbook-category-header').forEach(header => {
            header.addEventListener('click', () => {
            const categoryId = header.dataset.category;
            const subcategoriesEl = document.getElementById(`${categoryId}-subcategories`);
            
            // Toggle the subcategories visibility
            if (subcategoriesEl.style.maxHeight) {
                subcategoriesEl.style.maxHeight = null;
                header.querySelector('.category-toggle').classList.remove('rotate');
            } else {
                subcategoriesEl.style.maxHeight = subcategoriesEl.scrollHeight + "px";
                header.querySelector('.category-toggle').classList.add('rotate');
            }
            });
        });
        
        // Section item clicks
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            item.addEventListener('click', () => {
            const sectionId = item.dataset.section;
            showHandbookSection(sectionId);
            
            // Update active state
            document.querySelectorAll('.handbook-nav-item').forEach(i => {
                i.classList.remove('active');
            });
            item.classList.add('active');
            
            // If on mobile, close the sidebar
            if (window.innerWidth < 768) {
                document.getElementById('handbook-sidebar').classList.remove('mobile-open');
            }
            });
        });
        
        // Search input
        const searchInput = document.getElementById('handbook-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterHandbookSidebar(searchTerm);
            });
        }
        }

        // Filter the handbook sidebar based on search term
        function filterHandbookSidebar(searchTerm) {
        if (!searchTerm) {
            // Reset visibility
            document.querySelectorAll('.handbook-nav-item, .handbook-category').forEach(item => {
            item.style.display = 'flex';
            });
            document.querySelectorAll('.handbook-subcategories').forEach(sub => {
            sub.style.maxHeight = null;
            });
            return;
        }
        
        // Hide all items initially
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            const sectionId = item.dataset.section;
            
            // Find the matching section data
            let sectionData = null;
            handbookData.sections.forEach(section => {
            if (section.id === sectionId) {
                sectionData = section;
            } else if (section.isCategory && section.subcategories) {
                const subcat = section.subcategories.find(sub => sub.id === sectionId);
                if (subcat) sectionData = subcat;
            }
            });
            
            if (sectionData) {
            const titleMatch = sectionData.title.toLowerCase().includes(searchTerm);
            const contentMatch = sectionData.content && sectionData.content.toLowerCase().includes(searchTerm);
            
            if (titleMatch || contentMatch) {
                item.style.display = 'flex';
                
                // If it's in a subcategory, show the parent category and expand it
                const parentCategory = item.closest('.handbook-subcategories');
                if (parentCategory) {
                const categoryId = parentCategory.id.replace('-subcategories', '');
                const categoryHeader = document.querySelector(`.handbook-category-header[data-category="${categoryId}"]`);
                const categoryContainer = categoryHeader.closest('.handbook-category');
                
                categoryContainer.style.display = 'block';
                parentCategory.style.maxHeight = parentCategory.scrollHeight + "px";
                categoryHeader.querySelector('.category-toggle').classList.add('rotate');
                }
            } else {
                item.style.display = 'none';
            }
            }
        });
        
        // Hide empty categories
        document.querySelectorAll('.handbook-category').forEach(category => {
            const visibleItems = category.querySelectorAll('.handbook-nav-item[style="display: flex;"]');
            if (visibleItems.length === 0) {
            category.style.display = 'none';
            } else {
            category.style.display = 'block';
            }
        });
        }

        // Show a specific handbook section
        function showHandbookSection(sectionId) {
            const contentContainer = document.getElementById('handbook-article-area'); // Use the corrected unique ID
            if (!contentContainer) return;

            // Find the section data (this part of your code remains the same)
            let sectionData = null;
            handbookData.sections.forEach(section => {
                if (section.id === sectionId) {
                    sectionData = section;
                } else if (section.isCategory && section.subcategories) {
                    const subcat = section.subcategories.find(sub => sub.id === sectionId);
                    if (subcat) sectionData = subcat;
                }
            });

            if (!sectionData) return;

            // Set the content (this creates the new textarea elements)
            contentContainer.innerHTML = sectionData.content;

            // Add copy button functionality for code blocks (this part of your code remains the same)
            contentContainer.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const codeBlock = btn.parentElement.querySelector('code');
                    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                });
            });

            // Add event listeners for ALL user notes textareas within the newly added content
            contentContainer.querySelectorAll('textarea[id^="notes-"]').forEach(textarea => {
                // Load initial value from localStorage
                const savedNote = localStorage.getItem(textarea.id);
                if (savedNote) {
                    textarea.value = savedNote;
                }
                // Add listener for saving on input
                textarea.addEventListener('input', (e) => {
                    localStorage.setItem(e.target.id, e.target.value);
                });
            });
        }

        // Load user notes from localStorage
        function loadUserNotes() {
        document.querySelectorAll('textarea[id^="notes-"]').forEach(textarea => {
            const savedNote = localStorage.getItem(textarea.id);
            if (savedNote) {
            textarea.value = savedNote;
            }
        });
        }

        // Toggle the mobile sidebar
        function toggleHandbookSidebar() {
        const sidebar = document.getElementById('handbook-sidebar');
        sidebar.classList.toggle('mobile-open');
        }

        // Enhanced OSINT Handbook functionality
        document.addEventListener('DOMContentLoaded', () => {
        // Initialize handbook features when loaded
        initHandbookFeatures();
        });

        function initHandbookFeatures() {
        // Add section management buttons to handbook content container
        addHandbookControls();
        
        // Enhance search functionality
        enhanceHandbookSearch();
        
        // Initialize editor for section content
        initSectionEditor();
        }

        function addHandbookControls() {
        const handbookContent = document.querySelector('.handbook-content-container');
        if (!handbookContent) return;
        
        // Create handbook controls container
        const controlsHtml = `
            <div class="handbook-controls">
            <button id="add-section-btn" class="btn btn-primary handbook-btn">
                <i class="fas fa-plus"></i> Add New Section
            </button>
            <button id="edit-section-btn" class="btn btn-secondary handbook-btn" style="display: none;">
                <i class="fas fa-edit"></i> Edit Section
            </button>
            <button id="delete-section-btn" class="btn btn-danger handbook-btn" style="display: none;">
                <i class="fas fa-trash"></i> Delete Section
            </button>
            </div>
        `;
        
        // Insert controls before the content area
        handbookContent.insertAdjacentHTML('afterbegin', controlsHtml);
        
        // Add event listeners
        document.getElementById('add-section-btn').addEventListener('click', openAddSectionModal);
        document.getElementById('edit-section-btn').addEventListener('click', openEditSectionModal);
        document.getElementById('delete-section-btn').addEventListener('click', confirmDeleteSection);
        }

        function enhanceHandbookSearch() {
        const searchInput = document.getElementById('handbook-search');
        if (!searchInput) return;
        
        // Clear any existing listeners to avoid duplicates
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Add enhanced search functionality
        newSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
            // Reset search if term is too short
            document.querySelectorAll('.handbook-nav-item, .handbook-category').forEach(item => {
                item.style.display = 'flex';
            });
            document.querySelectorAll('.handbook-content mark').forEach(mark => {
                const text = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(text, mark);
            });
            return;
            }
            
            // Search both titles and content
            searchHandbookSections(searchTerm);
            
            // Highlight matches in current content
            highlightContentMatches(searchTerm);
        });
        
        // Add search icon click handler to clear search
        const searchIcon = document.querySelector('.handbook-search-icon');
        if (searchIcon) {
            searchIcon.style.cursor = 'pointer';
            searchIcon.addEventListener('click', () => {
            newSearchInput.value = '';
            newSearchInput.dispatchEvent(new Event('input'));
            newSearchInput.focus();
            });
        }
        }

        function searchHandbookSections(searchTerm) {
        let matchFound = false;
        
        // Search through all sections
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            const sectionId = item.dataset.section;
            let sectionData = findSectionById(sectionId);
            
            if (sectionData) {
            const titleMatch = sectionData.title.toLowerCase().includes(searchTerm);
            const contentMatch = sectionData.content && sectionData.content.toLowerCase().includes(searchTerm);
            
            if (titleMatch || contentMatch) {
                item.style.display = 'flex';
                matchFound = true;
                
                // Highlight the matching item
                item.classList.add('search-highlight');
                
                // Expand parent category if in a subcategory
                const parentSubcategories = item.closest('.handbook-subcategories');
                if (parentSubcategories) {
                const categoryId = parentSubcategories.id.replace('-subcategories', '');
                const categoryHeader = document.querySelector(`.handbook-category-header[data-category="${categoryId}"]`);
                
                if (categoryHeader) {
                    categoryHeader.closest('.handbook-category').style.display = 'block';
                    parentSubcategories.style.maxHeight = parentSubcategories.scrollHeight + "px";
                    categoryHeader.querySelector('.category-toggle').classList.add('rotate');
                }
                }
            } else {
                item.style.display = 'none';
                item.classList.remove('search-highlight');
            }
            }
        });
        
        // Show "no results" message if no matches
        const noResultsEl = document.getElementById('handbook-search-no-results');
        if (!matchFound) {
            if (!noResultsEl) {
            const searchContainer = document.querySelector('.handbook-search-container');
            if (searchContainer) {
                searchContainer.insertAdjacentHTML('afterend', `
                <div id="handbook-search-no-results" class="handbook-no-results">
                    <i class="fas fa-search"></i>
                    <p>No results found for "${searchTerm}"</p>
                </div>
                `);
            }
            } else {
            noResultsEl.style.display = 'block';
            noResultsEl.querySelector('p').textContent = `No results found for "${searchTerm}"`;
            }
        } else if (noResultsEl) {
            noResultsEl.style.display = 'none';
        }
        }

        function highlightContentMatches(searchTerm) {
        // Remove existing highlights
        const contentArea = document.getElementById('handbook-article-area');
        if (!contentArea) return;
        
        // First, remove existing highlights
        const highlighted = contentArea.innerHTML;
        const cleaned = highlighted.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
        contentArea.innerHTML = cleaned;
        
        // Don't highlight if search term is too short
        if (searchTerm.length < 2) return;
        
        // Then add new highlights
        const contentNodes = Array.from(contentArea.querySelectorAll('p, h2, h3, h4, li, code'));
        
        contentNodes.forEach(node => {
            const originalText = node.innerHTML;
            if (!originalText.includes('<mark class="search-highlight">')) {
            const newText = originalText.replace(
                new RegExp(searchTerm, 'gi'),
                match => `<mark class="search-highlight">${match}</mark>`
            );
            if (originalText !== newText) {
                node.innerHTML = newText;
            }
            }
        });
        }

        function findSectionById(sectionId) {
        // Look through handbookData to find the section
        let foundSection = null;
        
        handbookData.sections.forEach(section => {
            if (section.id === sectionId) {
            foundSection = section;
            } else if (section.isCategory && section.subcategories) {
            section.subcategories.forEach(subsection => {
                if (subsection.id === sectionId) {
                foundSection = subsection;
                }
            });
            }
        });
        
        return foundSection;
        }

        function openAddSectionModal() {
        // Check if modal already exists
        let modal = document.getElementById('section-editor-modal');
        if (!modal) {
            // Create modal if it doesn't exist
            modal = createSectionEditorModal();
            document.body.appendChild(modal);
        }
        
        // Reset form
        document.getElementById('section-editor-form').reset();
        document.getElementById('section-editor-title').textContent = 'Add New Section';
        document.getElementById('section-id').value = generateSectionId();
        document.getElementById('section-parent').value = '';
        document.getElementById('section-editor-content').innerHTML = '';
        
        // Show parent category selector and icon selector
        document.getElementById('section-parent-group').style.display = 'block';
        document.getElementById('section-icon-group').style.display = 'block';
        
        // Populate parent category select
        populateParentCategorySelect();
        
        // Show the modal
        modal.classList.add('show');
        }

        function openEditSectionModal() {
        // Get current section ID
        const currentSectionId = getCurrentSectionId();
        if (!currentSectionId) {
            showToast('Please select a section to edit', 'warning');
            return;
        }
        
        const sectionData = findSectionById(currentSectionId);
        if (!sectionData) {
            showToast('Section not found', 'error');
            return;
        }
        
        // Create or get modal
        let modal = document.getElementById('section-editor-modal');
        if (!modal) {
            modal = createSectionEditorModal();
            document.body.appendChild(modal);
        }
        
        // Set form values
        document.getElementById('section-editor-title').textContent = 'Edit Section';
        document.getElementById('section-id').value = sectionData.id;
        document.getElementById('section-title').value = sectionData.title;
        document.getElementById('section-icon').value = sectionData.icon || 'fas fa-book';
        document.getElementById('section-editor-content').innerHTML = sectionData.content;
        
        // Hide parent category selector for editing (can't change parent)
        document.getElementById('section-parent-group').style.display = 'none';
        
        // Show the modal
        modal.classList.add('show');
        }

        function confirmDeleteSection() {
        // Get current section ID
        const currentSectionId = getCurrentSectionId();
        if (!currentSectionId) {
            showToast('Please select a section to delete', 'warning');
            return;
        }
        
        const sectionData = findSectionById(currentSectionId);
        if (!sectionData) {
            showToast('Section not found', 'error');
            return;
        }
        
        // Ask for confirmation
        if (confirm(`Are you sure you want to delete the section "${sectionData.title}"?`)) {
            deleteSection(currentSectionId);
        }
        }

        function deleteSection(sectionId) {
        // Find and remove the section from handbookData
        let deleted = false;
        
        // Check top-level sections
        handbookData.sections = handbookData.sections.filter(section => {
            if (section.id === sectionId) {
            deleted = true;
            return false; // Remove this section
            }
            
            // Check subcategories if it's a category
            if (section.isCategory && section.subcategories) {
            section.subcategories = section.subcategories.filter(subsection => {
                if (subsection.id === sectionId) {
                deleted = true;
                return false; // Remove this subsection
                }
                return true;
            });
            }
            
            return true;
        });
        
        if (deleted) {
            // Re-render handbook sidebar and show first section
            renderHandbookSidebar();
            if (handbookData.sections.length > 0) {
            const firstSection = handbookData.sections[0];
            if (firstSection.isCategory && firstSection.subcategories && firstSection.subcategories.length > 0) {
                showHandbookSection(firstSection.subcategories[0].id);
            } else {
                showHandbookSection(firstSection.id);
            }
            }
            
            // Save to localStorage
            saveHandbookData();
            showToast('Section deleted successfully', 'success');
        } else {
            showToast('Failed to delete section', 'error');
        }
        }

        function createSectionEditorModal() {
        const modal = document.createElement('div');
        modal.id = 'section-editor-modal';
        modal.className = 'modal';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
            <h3 id="section-editor-title" style="margin-bottom: 20px; color: var(--primary);">Add New Section</h3>

            <form id="section-editor-form">
                <input type="hidden" id="section-id">

                <div class="form-group">
                <label for="section-title">Section Title</label>
                <input type="text" id="section-title" required placeholder="Enter section title">
                </div>

                <div class="form-group" id="section-parent-group">
                <label for="section-parent">Parent Category</label>
                <select id="section-parent">
                    <option value="">None (Top-level section)</option>
                </select>
                </div>

                <div class="form-group" id="section-icon-group">
                <label for="section-icon">Section Icon</label>
                <input type="text" id="section-icon" placeholder="e.g., fas fa-book" value="fas fa-book">
                <div class="icon-picker-grid" id="section-icon-picker"></div>
                </div>

                <div class="form-group">
                <label for="section-editor-content">Content</label>
                <div class="formatting-toolbar">
                    <button type="button" class="formatting-btn" data-command="bold" title="Bold">
                    <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="italic" title="Italic">
                    <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                    <i class="fas fa-heading"></i>2
                    </button>
                    <button type="button" class="formatting-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                    <i class="fas fa-heading"></i>3
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                    <i class="fas fa-list-ul"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                    <i class="fas fa-list-ol"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="createLink" title="Insert Link">
                    <i class="fas fa-link"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertHTML" data-value="code-block" title="Insert Code Block">
                    <i class="fas fa-code"></i>
                    </button>
                </div>
                <div id="section-editor-content" class="note-content-editor" contenteditable="true"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" id="cancel-section-edit">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Section</button>
                </div>
            </form>
            </div>
        `;

        document.body.appendChild(modal); // Append the modal to the DOM first

        // Now that the modal is in the DOM, you can safely populate the icon picker
        populateIconPicker('section-icon-picker');

        // Add event listeners
        modal.querySelector('#cancel-section-edit').addEventListener('click', () => {
            modal.classList.remove('show');
        });

        modal.querySelector('#section-editor-form').addEventListener('submit', (e) => {
            e.preventDefault();
            saveSection();
        });

        // Add click outside to close
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
            modal.classList.remove('show');
            }
        });

        return modal;
        }

        function populateParentCategorySelect() {
        const parentSelect = document.getElementById('section-parent');
        
        // Clear existing options except the first one
        while (parentSelect.options.length > 1) {
            parentSelect.remove(1);
        }
        
        // Add category options
        handbookData.sections.forEach(section => {
            if (section.isCategory) {
            const option = document.createElement('option');
            option.value = section.id;
            option.textContent = section.title;
            parentSelect.appendChild(option);
            }
        });
        }

        function initSectionEditor() {
        // Set up editor toolbar functionality
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.formatting-btn');
            if (!btn) return;
            
            const command = btn.dataset.command;
            const value = btn.dataset.value || null;
            const editor = document.getElementById('section-editor-content');
            
            if (!editor) return;
            
            if (command === 'createLink') {
            const url = prompt('Enter the URL:');
            if (url) {
                document.execCommand(command, false, url);
            }
            } else if (command === 'insertHTML' && value === 'code-block') {
            // Insert a code block
            const codeContent = prompt('Enter code content:');
            if (codeContent) {
                const codeBlockHtml = `
                <div class="code-block">
                    <pre><code>${escapeHtml(codeContent)}</code></pre>
                    <button class="copy-btn" data-clipboard-target="#code-${Date.now()}"><i class="fas fa-copy"></i></button>
                </div>
                `;
                document.execCommand('insertHTML', false, codeBlockHtml);
            }
            } else if (command === 'formatBlock') {
            document.execCommand(command, false, value);
            } else {
            document.execCommand(command, false, value);
            }
        });
        
        // Add icon picker functionality
        document.addEventListener('click', (e) => {
            const iconItem = e.target.closest('.icon-picker-item');
            if (!iconItem) return;
            
            const iconPicker = iconItem.closest('.icon-picker-grid');
            if (!iconPicker) return;
            
            // Remove selected class from all icons
            iconPicker.querySelectorAll('.icon-picker-item').forEach(item => {
            item.classList.remove('selected');
            });
            
            // Add selected class to clicked icon
            iconItem.classList.add('selected');
            
            // Update input value
            const iconInput = document.getElementById('section-icon');
            if (iconInput) {
            iconInput.value = iconItem.dataset.iconClass;
            }
        });
        }

        function saveSection() {
        const sectionId = document.getElementById('section-id').value;
        const sectionTitle = document.getElementById('section-title').value;
        const sectionParent = document.getElementById('section-parent').value;
        const sectionIcon = document.getElementById('section-icon').value;
        const sectionContent = document.getElementById('section-editor-content').innerHTML;
        
        // Validate required fields
        if (!sectionTitle) {
            showToast('Section title is required', 'error');
            return;
        }
        
        // Check if editing existing section or adding new one
        const existingSection = findSectionById(sectionId);
        
        if (existingSection) {
            // Update existing section
            existingSection.title = sectionTitle;
            existingSection.icon = sectionIcon;
            existingSection.content = sectionContent;
        } else {
            // Create new section
            const newSection = {
            id: sectionId,
            title: sectionTitle,
            icon: sectionIcon,
            content: sectionContent
            };
            
            if (sectionParent) {
            // Add as subcategory to parent
            const parentCategory = handbookData.sections.find(section => section.id === sectionParent);
            if (parentCategory) {
                // Ensure parent is a category with subcategories array
                if (!parentCategory.isCategory) {
                parentCategory.isCategory = true;
                }
                if (!parentCategory.subcategories) {
                parentCategory.subcategories = [];
                }
                parentCategory.subcategories.push(newSection);
            }
            } else {
            // Add as top-level section
            handbookData.sections.push(newSection);
            }
        }
        
        // Save changes and update UI
        saveHandbookData();
        renderHandbookSidebar();
        showHandbookSection(sectionId);
        
        // Hide modal
        const modal = document.getElementById('section-editor-modal');
        if (modal) {
            modal.classList.remove('show');
        }
        
        showToast('Section saved successfully', 'success');
        }

        function saveHandbookData() {
        // Save to localStorage
        localStorage.setItem('osintHandbookData', JSON.stringify(handbookData));
        }

        function getCurrentSectionId() {
        // Get the currently active section
        const activeNavItem = document.querySelector('.handbook-nav-item.active');
        return activeNavItem ? activeNavItem.dataset.section : null;
        }

        function generateSectionId() {
        // Generate a unique section ID
        return 'section-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
        }

        // Update the showHandbookSection function to handle section management buttons
        const originalShowHandbookSection = showHandbookSection;
        showHandbookSection = function(sectionId) {
        // Call the original function
        originalShowHandbookSection(sectionId);
        
        // Update edit/delete buttons visibility
        const editSectionBtn = document.getElementById('edit-section-btn');
        const deleteSectionBtn = document.getElementById('delete-section-btn');
        
        if (editSectionBtn && deleteSectionBtn) {
            const sectionData = findSectionById(sectionId);
            if (sectionData) {
            editSectionBtn.style.display = 'inline-flex';
            deleteSectionBtn.style.display = 'inline-flex';
            } else {
            editSectionBtn.style.display = 'none';
            deleteSectionBtn.style.display = 'none';
            }
        }
        };

        // Helper function to get week number (ISO week date standard)
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // Initialize handbook and notes functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize handbook functionality
            initHandbook();
            
            // Initialize notes functionality
            initNotes();
            
            // Add event listeners for handbook/notes subtabs
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const subtab = e.target.dataset.subtab;
                    switchHandbookSubtab(subtab);
                });
            });
        });
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
