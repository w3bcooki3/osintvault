<!--Add New Tool Showing different form for each type instead of showing only 1 to all.-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINTVault - Carry your investigations everywhere</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./favicon.png" type="image/x-icon">
    <style>
        /* Refined Color Palette & Variables */
        :root {
            --primary: #007bff; /* Slightly less vibrant blue, more authoritative */
            --primary-dark: #0056b3;
            --secondary: #ff6b35; /* Strong accent for highlights */
            --accent: #28a745; /* Positive action/success */
            --danger: #dc3545;
            --warning: #ffaa00;
            --success: #28a745;

            /* Darker, more professional greyscale for dark theme */
            --bg-primary: #0C1017; /* Deeper primary background */
            --bg-secondary: #171E28; /* Slightly lighter card/section background */
            --bg-tertiary: #212B3B; /* Input/hover background */
            --bg-card: #1E2736;     /* Card background */

            --text-primary: #E0E6F0; /* Brighter text for contrast */
            --text-secondary: #9BAEC8; /* Muted text */
            --text-muted: #6A7F9D;    /* Even more muted text */

            --border: #3D4C61;      /* Stronger but still subtle border */
            --border-light: #526680; /* Lighter border for dividers */

            /* Softer, multi-layered shadow */
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.3), 0 16px 60px rgba(0, 0, 0, 0.2);

            --glow: 0 0 15px rgba(0, 123, 255, 0.4); /* Adjusted glow for new primary */
            --primary-shadow-color: rgba(0, 123, 255, 0.3); /* For primary button shadow */
            --primary-shadow-color-hover: rgba(0, 123, 255, 0.4);

            /* Very subtle gradient, mainly for active states or branding */
            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #1e8738);
            /* Softened background gradient */
            --gradient-bg: linear-gradient(135deg, #0C1017, #171E28);

            /* Default Tab Colors */
            --tab-color-default: var(--primary);
            --tab-color-red: #e74c3c;
            --tab-color-blue: #3498db;
            --tab-color-green: #2ecc71;
            --tab-color-yellow: #f1c40f;
            --tab-color-purple: #9b59b6;
            --tab-color-orange: #e67e22;
        }

        [data-theme="light"] {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --accent: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;

            /* Lighter, professional greyscale for light theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F9FC; /* Slightly off-white for sections */
            --bg-tertiary: #E8EEF5; /* Light grey for inputs/hovers */
            --bg-card: #FFFFFF;    /* White card background */

            --text-primary: #2C3E50; /* Darker text for readability */
            --text-secondary: #607D8B; /* Muted grey text */
            --text-muted: #95A5A6;    /* Even more muted */

            --border: #CFD8DC; /* Light grey border */
            --border-light: #ECEFF1; /* Very light border */

            --glow: 0 0 10px rgba(0, 123, 255, 0.2);
            --shadow: 0 1px 4px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08);

            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #218838);
            --gradient-bg: linear-gradient(135deg, #F7F9FC, #E8EEF5);

            /* Default Tab Colors (Light Theme) */
            --tab-color-default: var(--primary);
            --tab-color-red: #c0392b;
            --tab-color-blue: #2980b9;
            --tab-color-green: #27ae60;
            --tab-color-yellow: #f39c12;
            --tab-color-purple: #8e44ad;
            --tab-color-orange: #d35400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg); /* Use the softened gradient */
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            /* Add transition for background-image as well, if the gradient is applied as such */
            transition: background 0.5s ease, color 0.5s ease; /* Slightly longer transition for smoother theme change */
        }

        .container {
            width: 100%; /* Make it full screen */
            max-width: 100%; /* Ensure it spans fully */
            padding: 0; /* Remove horizontal padding at container level */
            margin: 0 auto; /* Center the container */
        }

        /* Header Styles */
        header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px 40px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Container for Logo and Title/Tagline Group */
        .logo-and-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0; /* Prevents this group from shrinking */
            min-width: 0;
            /* FIXED: Ensure it stays at the left */
            margin-right: auto; /* This pushes controls to the right */
        }

        /* Styles for the Logo */
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 65px;
            flex-shrink: 0;
        }

        .osintvault-logo-img {
            display: block;
            max-height: 100%;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(0, 123, 255, 0.4));
            transition: filter 0.3s ease;
        }

        .osintvault-logo-img:hover {
            filter: drop-shadow(0 0 15px rgba(0, 123, 255, 0.6));
        }

        /* Container for OSINTVault Title and Tagline */
        .header-text-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            flex-grow: 1;
            min-width: 0;
        }

        /* Style for OSINTVault Title */
        .header-title {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Style for the single Tagline */
        .header-tagline {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* Responsive adjustments for header-content padding */
        @media (max-width: 1200px) {
            .header-content {
                padding: 20px; /* Adjust padding for medium screens */
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column; /* Stack logo/text group and controls vertically */
                align-items: stretch; /* Stretch to full width */
                padding: 15px; /* Further adjust padding for smaller screens */
                gap: 15px; /* Space between stacked groups */
            }
            .logo-and-title-container {
                justify-content: center; /* Center logo and text group when stacked */
                width: 100%;
                gap: 10px; /* Reduced gap */
            }
            .header-logo {
                height: 55px; /* Smaller logo height on tablets */
            }
            .header-title {
                font-size: 1.8em; /* Smaller title font on tablets */
            }
            .header-tagline {
                font-size: 0.8rem; /* Smaller tagline font on tablets */
            }
            .controls {
                width: 100%; /* Ensure controls take full width */
                justify-content: center; /* Center buttons within controls */
                margin-left: 0; /* Reset margin to avoid pushing controls to the right */;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                padding: 10px; /* Minimal padding on very small screens */
                gap: 10px; /* Reduced gap */
            }
            .header-logo {
                height: 45px; /* Smallest logo height on phones */
            }
            .header-title {
                font-size: 1.5em; /* Smallest title font on phones */
            }
            .header-tagline {
                font-size: 0.7rem; /* Smallest tagline font on phones */
            }
            /* Ensure text truncation or wrapping for very small screens */
            .header-title, .header-tagline {
                white-space: normal; /* Allow text to wrap on very small screens */
                overflow: visible; /* Make overflow visible as wrapping is enabled */
                text-overflow: clip; /* No ellipsis needed if wrapping */
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0; /* Prevents controls from shrinking */
            min-width: 0;
            justify-content: flex-end;
            /* FIXED: Ensure it stays at the right */
            margin-left: auto; /* This ensures controls stay at the right */
        }

        .search-container {
            position: relative;
            min-width: 350px;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            flex-grow: 1;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.15);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        
        /* New: Search Scope Select */
        #searchScopeSelect {
            margin-left: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
            -webkit-appearance: none; /* Remove default dropdown arrow for better styling consistency */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%239BAEC8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H19a17.6%2017.6%200%200%200-13.6%206.4%2017.6%2017.6%200%200%200%200%2025.2l128%20128c6.9%206.9%2017.9%206.9%2024.7%200l128-128a17.6%2017.6%200%200%200%200-25.2z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
            padding-right: 30px; /* Make space for the custom arrow */
        }
        #searchScopeSelect:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 30px;
            align-items: center;
            padding: 15px 40px; /* Match header padding */
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            border-radius: 0; /* Remove rounded corners */
            margin: 0;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow to stats bar */
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-item i {
            color: var(--primary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Button Styles */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px; /* Slightly more rounded */
            font-size: 14px;
            font-weight: 600; /* Bolder text */
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.2px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .btn-primary:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow); /* Add shadow to secondary buttons */
        }

        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg); /* Increased shadow on hover */
        }

        .btn-danger {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 51, 102, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            margin: 20px 40px 0; /* Add horizontal padding for main tabs */
            /* Replaced border-bottom with a more integrated look */
            background: var(--bg-secondary);
            border-radius: 12px; /* Rounded container for tabs */
            padding: 8px; /* More padding around tabs */
            transition: background 0.3s ease, border-color 0.3s ease;
            flex-wrap: wrap;
            box-shadow: var(--shadow); /* Add shadow to tab container */
        }

        .nav-tab {
            padding: 14px 22px; /* Adjusted padding for a cleaner look */
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px; /* Match button border-radius */
            font-weight: 600;
            position: relative;
            flex-grow: 1;
            text-align: center;
        }

        .nav-tab.active {
            background: var(--gradient-primary); /* Keep gradient for active */
            color: white;
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Sub-tabs styling */
        .sub-nav-tabs {
            display: flex;
            gap: 0;
            margin-top: 20px;
            border: 1px solid var(--border-light); /* Lighter border */
            background: var(--bg-tertiary); /* Slightly different background for sub-tabs */
            border-radius: 8px; /* Slightly smaller radius than main tabs */
            padding: 4px; /* Less padding */
            flex-wrap: wrap;
            box-shadow: var(--shadow); /* Add shadow to sub-tab container */
        }

        .sub-nav-tab {
            padding: 10px 15px; /* Adjusted padding */
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85em; /* Slightly smaller font for sub-tabs */
            flex-grow: 1;
            text-align: center;
        }

        .sub-nav-tab.active {
            color: white;
            background-color: var(--tab-color-default); /* Use default tab color */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for active sub-tab */
        }

        .sub-nav-tab:hover:not(.active) {
            background: var(--border);
            color: var(--text-primary);
        }


        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin: 30px 40px; /* Add horizontal padding to dashboard */
            width: calc(100% - 80px); /* Adjust width for padding */
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            height: fit-content;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: sticky;
            top: 120px;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .sidebar h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        /* Refined Random Discovery Section */
        .random-display {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 12px; /* Increased border-radius for softer look */
            padding: 20px; /* More padding */
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px; /* Increased min-height for better visual balance */
            box-shadow: var(--shadow); /* Add a subtle shadow */
        }

        .random-display .random-content-wrapper {
            flex-grow: 1; /* Allows content to take available space */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            margin-bottom: 15px; /* Space between content and button */
        }

        /* Refined Random Discovery Section - Header specific styling */
        .random-display .random-display-header {
            display: flex;
            align-items: center; /* Vertically align items */
            justify-content: center; /* Center the entire header horizontally */
            gap: 12px; /* Increased gap between icon and text */
            margin-bottom: 20px; /* More space below the header */
            color: var(--text-primary); /* Use primary text color for better contrast */
            font-weight: 600; /* Keep it bold */
            padding-bottom: 10px; /* Add some padding at the bottom */
            border-bottom: 1px solid var(--border-light); /* Subtle separator line */
            width: 100%; /* Ensure it spans the width */
        }

        .random-display .random-display-header .header-icon {
            font-size: 1.8em; /* Slightly larger icon */
            color: var(--primary); /* Keep primary color for the icon */
            /* Add a subtle text-shadow for a soft glow effect */
            text-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        .random-display .random-display-header .header-text {
            font-size: 1.2em; /* Slightly larger font for the heading text */
            margin: 0; /* Remove default h3 margin */
            font-family: 'Outfit', sans-serif; /* Use the logo font for a premium feel */
            letter-spacing: -0.5px; /* Tighter spacing */
            background: var(--gradient-primary); /* Apply gradient for a premium look */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        .random-display .random-item-placeholder {
            min-height: 80px; /* Ensure content area has a minimum height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%; /* Take full width of wrapper */
        }

        .random-display .random-item-placeholder p {
            margin-bottom: 8px; /* Space between paragraphs */
            line-height: 1.4;
        }

        .random-display .random-item-placeholder strong {
            color: var(--text-primary); /* Make strong text more prominent */
        }

        .random-display .random-tool-link {
            font-size: 1.05em; /* Slightly larger link text for tools */
            font-weight: 600;
            text-decoration: none;
            color: var(--primary);
            display: flex; /* Keep flex for icon/text alignment */
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* NEW: Allow text to wrap within the link */
            flex-wrap: wrap; /* Allow items within the link to wrap (e.g., icon and text) */
            text-align: center; /* Center text lines if they wrap */
            word-break: break-word; /* Break long words if they don't fit */
            min-width: 0; /* Important for flex items to allow shrinking */
            overflow: hidden; /* Hide any content that still overflows after wrapping/breaking */
        }

        /* Further ensure the parent text container allows text to wrap */
        .random-display .random-item-placeholder p {
            margin-bottom: 8px; /* Space between paragraphs */
            line-height: 1.4;
            word-wrap: break-word; /* Ensure long words wrap */
            overflow-wrap: break-word; /* Modern equivalent */
            max-width: 100%; /* Ensure it doesn't overflow its parent */
        }

        .random-display .random-tool-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .random-display .tool-favicon {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .random-display .btn-sm {
            padding: 10px 18px; /* Slightly larger button for better clickability */
            font-size: 13px;
            width: auto;
            margin: 0 auto; /* Center the button */
            display: inline-flex; /* Use inline-flex for centering with margin auto on button */
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box; /* Crucial for responsive width calculations */
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .content-title {
            font-size: 28px; /* Slightly larger content title */
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tools Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border); /* Thinner border */
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease; /* Faster transition */
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow); /* Apply new softer shadow */
        }

        .tools-list .tool-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
        }

        .tools-list .tool-header {
            width: 100%;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }

        .tool-header > div:first-child { /* This targets the container holding tool-title and tool-url */
            flex-grow: 1; /* Allow it to grow and take available space */
            flex-shrink: 1; /* Allow it to shrink */
            min-width: 0; /* Crucial: Allows content to shrink below its intrinsic width */
            /* If titles are very long and you want them to truncate, you might add: */
            /* overflow: hidden; */
            /* text-overflow: ellipsis; */
            /* white-space: nowrap; */
            /* However, wrapping is generally preferred for readability. */
        }
        .tools-list .tool-title {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .tools-list .tool-url {
            font-size: 11px;
        }

        .tools-list .tool-actions {
            margin-left: auto;
            flex-shrink: 0;
        }

        .tools-list .tool-tags {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .tools-list .tool-tags .threat-level {
            margin-left: auto;
            float: none; /* Override float */
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px; /* Thicker accent line */
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-7px); /* More pronounced lift */
            box-shadow: var(--shadow-lg); /* Larger shadow on hover */
            border-color: var(--primary);
        }

        .tool-card:hover::before {
            opacity: 1;
        }

        .tool-card.starred {
            border-color: var(--secondary);
        }

        .tool-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .tool-card.selected {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.05), transparent);
        }
        /* Style for shared highlight */
        .tool-card.shared-highlight {
            border-color: var(--primary); /* Highlight with primary color */
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.08), transparent);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }


        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top */
            margin-bottom: 15px;
            width: 100%; /* Ensure it takes full width of the card */
            flex-wrap: wrap; /* Allow header content to wrap if needed */
            gap: 10px; /* Space between the title/URL part and actions */
        }

        .tool-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* NEW: Allow elements within the title (checkbox, favicon, text) to wrap */
            min-width: 0; /* Ensures the title itself can shrink if necessary */
            word-break: break-word; /* NEW: Ensure long words break */
        }

        .tool-favicon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .tool-url {
            font-size: 0.8rem; /* Slightly smaller URL */
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .external-link-icon {
            color: var(--primary);
            font-size: 10px;
            opacity: 0.7;
        }

        .tool-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px; /* Smaller padding for action buttons */
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9rem; /* Slightly smaller icon size */
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary); /* Hover color for actions */
            transform: scale(1.15); /* Slightly more prominent icon scaling */
        }

        .action-btn.starred {
            color: var(--secondary);
        }

        .action-btn.pinned {
            color: var(--accent);
        }


        /* Bulk Actions */
        .bulk-actions {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow); /* Add shadow to bulk actions */
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-checkbox {
            margin-right: 10px;
        }

        .threat-high {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px; /* More padding */
            text-align: center;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-value {
            font-size: 3rem; /* Larger font size */
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px; /* Tighter spacing for numbers */
        }

        .analytics-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .analytics-list {
            list-style: none;
            padding: 0;
        }

        .analytics-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
        }

        .analytics-list li:last-child {
            border-bottom: none;
        }

        .analytics-list li span:first-child {
            color: var(--text-primary);
            font-weight: 500;
        }

        .analytics-list li span:last-child {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }


        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Footer */
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            padding-bottom: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
                margin: 30px 20px; /* Adjust padding for medium screens */
                width: calc(100% - 40px);
            }
            
            .sidebar {
                position: static;
            }

            .header-content, .stats-bar, .nav-tabs, .footer-content {
                padding: 0 20px; /* Adjust padding for medium screens */
            }

            .nav-tabs {
                margin: 20px 20px 0;
            }

            .main-content {
                padding: 20px; /* Reduce padding for medium screens */
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 15px; /* Consistent padding for main content area */
            }
            .container {
                padding: 0;
            }
            
            .header-content {
                gap: 15px; /* Slightly reduce gap on smaller screens */
                padding: 0 15px; /* Ensure consistent padding on smaller screens */
            }
            
            .search-container {
                min-width: unset;
                width: 100%;
                flex-direction: column; /* Stack search input and select */
                align-items: stretch;
            }
            .search-input {
                margin-bottom: 10px;
            }
            #searchScopeSelect {
                margin-left: 0; /* Reset margin for stacking */
                margin-top: 10px; /* Add space above it when stacked */
                width: 100%; /* Ensure it takes full width when stacked */
            }
            .search-icon {
                right: 20px; /* Keep position relative to input */
            }

            .controls {
                width: 100%;
                justify-content: center;
            }

            .tools-grid, .tools-list {
                grid-template-columns: 1fr; /* Force single column on smaller screens */
                gap: 15px; /* Slightly reduce gap on mobile */
            }
            .tools-list .tool-header {
                flex-direction: column; /* Stack title/url and actions vertically */
                align-items: flex-start;
            }
            .tools-list .tool-actions {
                margin-left: 0; /* Remove auto-margin when stacked vertically */
                width: 100%; /* Take full width when stacked */
                justify-content: flex-start; /* Align buttons to the left when stacked */
            }
                    
            .nav-tab {
                flex-basis: calc(50% - 5px); /* Account for gap */
                margin-bottom: 10px;
                padding: 12px 15px; /* Slight adjustment if needed */
                font-size: 13px; /* Ensure font is appropriate */
            }
            .nav-tabs {
                padding: 6px; /* Reduce container padding */
                margin: 15px 10px 0; /* Adjust margin too */
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 10px 20px; /* Vertical gap, Horizontal gap */
                justify-content: center;
                padding: 15px;
                font-size: 13px; /* Slightly smaller font for stats */
            }
            .stat-item {
                flex-basis: auto; /* Allow items to determine their own width */
                margin: 0; /* Remove any default margins that might interfere */
                justify-content: center; /* Center content within each stat item */
            }

            .dashboard {
                margin: 20px 15px; /* Adjust margin for smaller screens */
                width: calc(100% - 30px);
            }

            .tips-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .footer {
                padding: 40px 15px 20px;
            }

            .notes-header {
                flex-direction: column; /* Stack elements vertically */
                align-items: stretch; /* Stretch items to full width */
                gap: 15px; /* Consistent gap */
            }
            .notes-search-container {
                margin-left: 0; /* Remove left margin when stacked */
                width: 100%; /* Ensure full width */
            }
            .new-note-btn {
                width: 100%; /* Make button full width */
                justify-content: center; /* Center button text */
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                margin: 15px 8px; /* Very tight margins for smallest screens */
                width: calc(100% - 16px);
            }

            .main-content {
                padding: 10px; /* Minimal padding for content on very small screens */
            }

            .modal.show {
                padding: 10px; /* Reduce padding for very small screens */
            }

            .modal-content {
                padding: 25px; /* Reduce internal padding for very small screens */
                border-radius: 12px; /* Slightly less rounded on small screens */
            }

            .form-group label {
                margin-bottom: 8px; /* Slightly less space below labels */
                font-size: 14px; /* Adjust label font size */
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px; /* Reduce input padding */
                font-size: 13px; /* Reduce input font size */
            }

            .logo {
                font-size: 24px; /* Adjust logo size */
            }

            .header-content {
                gap: 10px; /* Further reduce gap on very small screens */
                padding: 0 10px; /* Even tighter padding for very small screens */
            }

            .notes-header {
                gap: 10px; /* Reduce gap on very small screens */
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .search-input {
                padding: 12px 40px 12px 15px;
                font-size: 13px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
            }
            .sub-nav-tab {
                padding: 8px 10px;
                font-size: 12px;
            }

            .tool-card {
                padding: 15px;
            }

            .tools-list .tool-card {
                padding: 10px 15px;
            }

            .tool-title {
                font-size: 16px;
            }

            .tool-url {
                font-size: 11px;
            }

            .tag {
                font-size: 10px;
            }

            .stats-bar {
                padding: 10px;
                gap: 8px 15px; /* Even smaller gap on very small screens */
                font-size: 12px; /* Further reduce font size */
            }

            /* NEW/MODIFIED: Toast Notifications for small screens */
            .toast {
                left: 50%; /* Center horizontally */
                right: auto; /* Override existing 'right' property */
                transform: translateX(-50%); /* Adjust for horizontal centering */
                width: calc(100% - 40px); /* Take up most of the width with some padding */
                max-width: 350px; /* Limit maximum width on slightly larger phones */
                text-align: center; /* Center text within the toast */
            }
        }

        /* Modal and Form Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 15px; /* Add some padding to the modal container itself for small screens */
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 100%; /* Ensure it takes full width of allowed space within padding */
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px; /* More space below label */
            font-weight: 600; /* Bolder labels */
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px; /* Larger input fields */
            border: 1px solid var(--border);
            border-radius: 10px; /* Match button rounding */
            background: var(--bg-tertiary); /* Lighter background for inputs */
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Subtle inner shadow */
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 4px rgba(0,0,0,0.1);
        }
        .form-group.metadata-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px; /* Smaller margin for repeated entries */
        }

        .form-group.metadata-entry input {
            flex: 1; /* Key and value inputs take equal space */
        }

        .form-group.metadata-entry .remove-metadata-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s ease;
        }

        .form-group.metadata-entry .remove-metadata-btn:hover {
            background: var(--primary-dark);
        }

        .add-metadata-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 5px;
        }

        .add-metadata-btn:hover {
            background: var(--primary-dark);
        }


        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }
        .toast.info { /* For read-only banner */
            background: var(--primary-dark);
        }

        .toast-warning {
            background: var(--danger);
        }

        .toast-info { /* For read-only banner */
            background: var(--tab-color-yellow);
        }

        .toast-error {
            background: var(--warning);
        }

        @keyframes fadeIn { 
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px; /* More vertical padding */
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px dashed var(--border-light); /* Dashed border for a softer look */
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .empty-state i {
            font-size: 72px; /* Larger icon */
            margin-bottom: 20px;
            opacity: 0.2; /* Lighter opacity */
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tag {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 10px; /* More padding for tags */
            border-radius: 16px; /* More rounded */
            font-size: 0.75rem; /* Slightly smaller font */
            margin-right: 6px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .threat-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }
        
        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .threat-tags {
            margin-top: 10px;
        }

        .threat-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .threat-high {
            background: var(--danger);
            color: white;
        }
        .threat-medium {
            background: var(--warning);
            color: black;
        }
        .threat-low {
            background: var(--success);
            color: white;
        }

        .scan-progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .scan-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .scan-result:last-child {
            border-bottom: none;
        }

        .scan-result i {
            width: 20px;
        }

        /* Custom Tabs Tool Assignment */
        .custom-tab-assignment {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .custom-tab-assignment h4 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .custom-tab-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .custom-tab-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 8px; /* Slightly softer */
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid var(--border-light); /* More prominent default border */
            transition: all 0.2s ease;
        }

        .custom-tab-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .custom-tab-checkbox.checked {
            border-color: var(--primary);
            background: rgba(0, 123, 255, 0.15); /* Match new primary color */
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2);
        }

        /* Style for Icon picker */
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .icon-picker-item {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            border-radius: 6px; /* Slightly softer */
            cursor: pointer;
            border: 1px solid var(--border-light); /* Visible border */
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .icon-picker-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .icon-picker-item.selected {
            background: var(--primary); /* Use primary color */
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        /* Style for Color picker */
        .color-picker-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker-item {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-picker-item.selected {
            border-color: var(--text-primary); /* Border for selected color */
            box-shadow: 0 0 0 3px var(--primary-dark); /* Thicker, slightly darker glow */
        }

        /*calude_investigation  wall*/
        .investigation-wall {
            min-height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

/*background Image
        .investigation-wall {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            width: 100vw;
            background: var(--gradient-bg); 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .investigation-wall::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: url('./wall.png') center center / cover no-repeat;
            filter: blur(15px);
            z-index: -1;
            transform: scale(1.1); 
        }
*/

        .wall-texture {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.015) 1px, transparent 1px);
            background-size: 50px 50px, 75px 75px;
            animation: subtleShift 20s ease-in-out infinite;
        }

        @keyframes subtleShift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-2px, -2px); }
        }

        .evidence-grid {
            position: relative;
            max-width: 1600px;
            width: 100%;
            padding: 3rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 3rem;
            z-index: 2;
        }

        .evidence-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2.5rem;
            position: relative;
            transform: rotate(-1.5deg);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .evidence-card:nth-child(even) {
            transform: rotate(1.5deg);
        }

        .evidence-card:hover {
            transform: rotate(0deg) scale(1.02);
            background: var(--bg-tertiary);
            box-shadow: var(--shadow-lg), var(--glow);
            border-color: var(--border-light);
        }

        .evidence-card::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: var(--secondary);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .evidence-card::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 12px;
            background: var(--bg-primary);
            border-radius: 2px;
        }

        .card-header-wall {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon-wall {
            width: 24px;
            height: 24px;
            margin-right: 0.75rem;
            fill: currentColor;
        }

        .card-content-wall {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 1rem;
        }

        .highlight-wall {
            background: var(--gradient-primary);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .connecting-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .line {
            position: absolute;
            background: var(--gradient-primary);
            height: 2px;
            transform-origin: left center;
            animation: lineGlow 3s ease-in-out infinite alternate;
            opacity: 0.6;
        }

        @keyframes lineGlow {
            0% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }

        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: var(--primary);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        .section-title-wall {
            position: absolute;
            top: 3rem;
            color: var(--primary);
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            z-index: 4;
            text-shadow: var(--glow);
            border-bottom: 2px solid var(--tab-color-blue);
        }

        @media (max-width: 768px) {
            .evidence-grid {
                grid-template-columns: 1fr;
                padding: 2rem;
                gap: 2rem;
            }
            
            .evidence-card {
                padding: 2rem;
            }
            
            .section-title-wall {
                top: 2rem;
                left: 2rem;
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .evidence-grid {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            
            .evidence-card {
                padding: 1.5rem;
            }
            
            .section-title-wall {
                top: 1.5rem;
                left: 1.5rem;
                font-size: 1.5rem;
            }
        }
        /*-------- End of Investigation Wall Styles --------*/


        /* Dork Assistant Styles */

        .dork-subtab-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
        }
        .dork-subtab-content .content-title {
            margin-top: 0; /* Adjust for subtab content header */
        }
        .dork-template-card, .saved-query-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dork-template-card:hover, .saved-query-card:hover {
            border-color: var(--primary);
        }
        .dork-template-card .template-header, .saved-query-card .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .dork-template-card .template-query, .saved-query-card .query-string {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
            word-break: break-all; /* Ensure long queries wrap */
        }
        .dork-template-card .template-description, .saved-query-card .query-description {
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .dork-template-card .template-actions, .saved-query-card .query-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .dork-template-card .template-engine, .saved-query-card .query-engine {
            font-size: 0.8em;
            background: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }
        .saved-query-tags .tag {
            font-size: 0.7em;
            padding: 2px 6px;
        }
        .pre-templates-container {
            display: grid;
            grid-template-columns: 280px 1fr; /* Fixed sidebar width, flexible main content */
            gap: 20px;
            height: 100%; /* Take full height of parent */
        }

        .pre-templates-sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            height: fit-content; /* Adjusts to content, but stays sticky */
            position: sticky; /* Makes it scroll with the main content */
            top: 120px; /* Adjust based on your header height */
            transition: all 0.3s ease;
        }

        .pre-templates-sidebar .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .pre-templates-sidebar .category-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .pre-templates-sidebar .category-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }
        .pre-templates-sidebar .category-item i {
            font-size: 1.1em;
        }
        .pre-templates-sidebar .category-item span {
            flex-grow: 1;
        }
        .pre-templates-sidebar .category-item .template-count {
            font-size: 0.8em;
            background: rgba(0,0,0,0.2); /* Darker background for contrast on active */
            padding: 3px 8px;
            border-radius: 10px;
        }
        .pre-templates-sidebar .category-item.active .template-count {
            background: rgba(255,255,255,0.2); /* Lighter for contrast on active */
        }

        .pre-templates-main {
            background: var(--bg-card); /* Match other main content areas */
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            box-sizing: border-box;
        }

        /* Responsive adjustments for pre-templates */
        @media (max-width: 992px) {
            .pre-templates-container {
                grid-template-columns: 1fr; /* Stack on smaller screens */
            }
            .pre-templates-sidebar {
                position: static; /* Remove sticky behavior when stacked */
                margin-bottom: 20px;
            }
        }
        
        .form-group-input { /* Reusing your existing input styles, but explicitly for select elements */
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }

        .form-group-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 4px rgba(0,0,0,0.1);
        }

        .dork-operator-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .dork-operator-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .dork-operator-btn:active {
            transform: translateY(0);
        }

        /* Adjustments for responsive layout */
        @media (max-width: 992px) {
            #dork-assistantTab > div {
                flex-direction: column;
            }
            #dork-assistantTab > div > div {
                flex: none;
                width: 100%;
            }
        }



        /* OSINT Handbook & Notes Styles */
        /* General Handbook Styles */
        .handbook-container {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 30px;
        height: 100%;
        position: relative;
        }

        /* Handbook Sidebar */
        .handbook-sidebar {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        transition: all 0.3s ease;
        position: sticky;
        top: 20px;
        }

        .handbook-search-container {
        position: relative;
        margin-bottom: 20px;
        }

        .handbook-search {
        width: 100%;
        padding: 12px 20px 12px 40px;
        border: 1px solid var(--border-light);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        }

        .handbook-search:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .handbook-search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 14px;
        }

        .handbook-nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 10px;
        margin-bottom: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .handbook-nav-item:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        }

        .handbook-nav-item.active {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow);
        }

        .handbook-category {
        margin-bottom: 10px;
        }

        .handbook-category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 10px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        }

        .handbook-category-header:hover {
        background: var(--bg-tertiary);
        }

        .handbook-category-header .category-toggle {
        margin-left: auto;
        transition: transform 0.3s ease;
        }

        .handbook-category-header .category-toggle.rotate {
        transform: rotate(180deg);
        }

        .handbook-subcategories {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        margin-left: 10px;
        }

        /* Handbook Content */
        .handbook-content-container {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 30px;
        height: 100%;
        overflow-y: auto;
        }

        .handbook-content {
            max-width: 800px;
            /* Changed: Align to the left instead of centering */
            margin: 0; /* Remove auto margins to prevent centering */
            margin-left: 0; /* Explicitly align to the left */
            margin-right: auto; /* Allow auto margin on right for remaining space, keeping left fixed */
            line-height: 1.7;
        }

        .handbook-content h2 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--primary);
        border-bottom: 2px solid var(--border-light);
        padding-bottom: 10px;
        }

        .handbook-content h3 {
        font-size: 22px;
        font-weight: 600;
        margin: 25px 0 15px;
        color: var(--text-primary);
        }

        .handbook-content p {
        margin-bottom: 15px;
        color: var(--text-secondary);
        }

        .handbook-content ul, 
        .handbook-content ol {
        margin-bottom: 20px;
        margin-left: 25px;
        color: var(--text-secondary);
        }

        .handbook-content ul li, 
        .handbook-content ol li {
        margin-bottom: 8px;
        }

        .handbook-content strong {
        color: var(--text-primary);
        font-weight: 600;
        }

        .code-block {
        position: relative;
        background: var(--bg-tertiary);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        overflow-x: auto;
        font-family: 'JetBrains Mono', monospace;
        font-size: 14px;
        line-height: 1.5;
        border-left: 4px solid var(--primary);
        }

        .code-block pre {
        margin: 0;
        padding-right: 40px; /* Space for copy button */
        }

        .code-block code {
        color: var(--text-primary);
        display: block;
        white-space: pre;
        }

        .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
        }

        .copy-btn:hover {
        background: var(--primary);
        color: white;
        }

        .tag-section {
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        }

        .handbook-content .tag {
        display: inline-block;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        }


        /* Mobile sidebar toggle */
        .handbook-mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px; /* Slightly larger for easier tap */
            height: 50px; /* Slightly larger for easier tap */
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            z-index: 1001; /* Ensure it's above other elements */
            cursor: pointer;
            display: flex; /* Always display as flex to properly center icon */
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        /* Add this new class at the top level of your CSS, not inside a media query */
        body.handbook-overlay-active {
            overflow: hidden; /* Prevent scrolling of content behind modal/sidebar */
        }

        .handbook-mobile-toggle:hover {
        transform: scale(1.05);
        }

        /* Notes Styles */
        .notes-container {
        height: 100%;
        position: relative;
        }

        .notes-list-view, .note-editor-view {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 25px;
        height: 100%;
        overflow-y: auto;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap; /* Allow items to wrap */
            gap: 15px; /* Add gap between items when wrapped */
        }

        .notes-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary);
        }

        .notes-search-container {
        position: relative;
        flex-grow: 1;
        max-width: 400px;
        margin-left: 20px;
        }

        .notes-search {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 1px solid var(--border-light);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        }

        .notes-search:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .notes-search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 14px;
        }

        .new-note-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .new-note-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
        }

        .note-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        }

        .note-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
        }

        .note-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
        }

        .note-card:hover::before {
        opacity: 1;
        }

        .note-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        }

        .note-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.3;
        }

        .note-actions {
        display: flex;
        gap: 8px;
        opacity: 0.2;
        transition: opacity 0.2s ease;
        }

        .note-card:hover .note-actions {
        opacity: 1;
        }

        /* NEW: Styling for pinned notes */
        .note-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
            order: -1; /* Pinned items appear first in flex/grid */
        }

        .note-action-btn.pinned {
            color: var(--accent); /* Color for active pin button */
        }

        .note-action-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
        transition: all 0.2s ease;
        }

        .note-action-btn:hover {
        background: var(--bg-tertiary);
        color: var(--primary);
        }

        .note-action-btn.delete-note:hover {
        color: var(--danger);
        }

        .note-preview {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 15px;
        line-height: 1.5;
        max-height: 120px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
        }

        .note-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-muted);
        }

        .note-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        }

        .note-footer .tag {
        padding: 2px 8px;
        font-size: 11px;
        }

        .notes-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px dashed var(--border-light);
        margin-top: 20px;
        }

        .notes-empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.3;
        }

        /* Note Editor View */
        .note-editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        }

        .note-editor-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary);
        }

        .note-editor-actions {
        display: flex;
        gap: 10px;
        }

        .back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .back-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        }

        .save-note-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .save-note-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--primary-shadow-color-hover);
        }

        .edit-note-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--bg-tertiary);
        color: var(--primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .edit-note-btn:hover {
        background: var(--primary);
        color: white;
        }

        .note-title-input {
        width: 100%;
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        }

        .note-title-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .note-title-input:read-only {
        border-color: transparent;
        background: transparent;
        padding-left: 0;
        padding-right: 0;
        }

        .formatting-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
        }

        .formatting-btn {
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .formatting-btn:hover {
        background: var(--primary);
        color: white;
        }

        .formatting-btn.has-dropdown {
        width: auto;
        padding: 0 12px;
        }

        .note-content-editor {
        min-height: 300px;
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 16px;
        line-height: 1.6;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        overflow-y: auto;
        }

        .note-content-editor:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .note-content-editor[contenteditable="false"] {
        border-color: transparent;
        background: transparent;
        padding-left: 0;
        padding-right: 0;
        }

        .note-content-editor h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 25px 0 15px;
        color: var(--text-primary);
        }

        .note-content-editor h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 20px 0 15px;
        color: var(--text-primary);
        }

        .note-content-editor h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 15px 0 10px;
        color: var(--text-primary);
        }

        .note-content-editor p {
        margin-bottom: 15px;
        }

        .note-content-editor ul, 
        .note-content-editor ol {
        margin-bottom: 15px;
        margin-left: 25px;
        }

        .note-content-editor li {
        margin-bottom: 5px;
        }

        .note-content-editor a {
        color: var(--primary);
        text-decoration: underline;
        }

        .note-tags-section {
        margin-top: 25px;
        }

        .note-tags-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-primary);
        }

        .note-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
        }

        .note-tag {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-radius: 20px;
        font-size: 14px;
        }

        .remove-tag-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        }

        .remove-tag-btn:hover {
        color: var(--danger);
        }

        .tag-input-container {
        display: flex;
        gap: 10px;
        }

        .note-tags-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        }

        .note-tags-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--glow);
        }

        .add-tag-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 15px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        }

        .add-tag-btn:hover {
        background: var(--primary);
        color: white;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
        .handbook-container {
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }
        
        .handbook-content-container {
            padding: 20px;
        }
        }

        @media (max-width: 768px) {
        .handbook-container {
            grid-template-columns: 1fr;
        }
        
        .handbook-sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            bottom: 0;
            width: 320px;
            z-index: 1000;
            border-radius: 0;
            transition: left 0.3s ease;
        }
        
        .handbook-sidebar.mobile-open {
            left: 0;
            box-shadow: var(--shadow-lg); /* Add shadow to open sidebar */
        }
                
        .handbook-mobile-toggle {
            display: flex;
            z-index: 1001;
        }
        
        .notes-grid {
            grid-template-columns: 1fr;
        }
        }

        @media (max-width: 480px) {
        .handbook-content-container {
            padding: 15px;
        }
        
        .handbook-content h2 {
            font-size: 24px;
        }
        
        .handbook-content h3 {
            font-size: 20px;
        }
        
        .note-editor-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .formatting-toolbar {
            padding: 8px;
            gap: 3px;
        }
        
        .formatting-btn {
            width: 30px;
            height: 30px;
        }
        }
        /* Handbook Controls */
        .handbook-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
        border: 1px solid var(--border-light);
        }

        .handbook-btn {
        padding: 8px 15px;
        font-size: 14px;
        }

        /* Search Enhancements */
        .handbook-search-container {
        position: relative;
        }

        .handbook-search {
        padding-right: 40px; /* Space for the clear button/icon */
        }

        .handbook-search-icon {
        transition: all 0.2s ease;
        }

        .handbook-search-icon:hover {
        color: var(--primary);
        transform: scale(1.1);
        }

        .handbook-no-results {
        padding: 15px;
        text-align: center;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        }

        .handbook-no-results i {
        font-size: 24px;
        opacity: 0.5;
        }

        /* Search highlights */
        .search-highlight {
        background-color: rgba(255, 170, 0, 0.3);
        border-radius: 3px;
        padding: 2px 0;
        }

        mark.search-highlight {
        background-color: rgba(255, 170, 0, 0.3);
        color: inherit;
        }

        .handbook-nav-item.search-highlight {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid var(--primary);
        }

        /* Section Editor */
        #section-editor-modal .modal-content {
        max-width: 800px;
        }

        #section-editor-content {
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        }

        /* Icon picker tweaks */
        .icon-picker-grid {
        margin-top: 10px;
        max-height: 180px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
        .handbook-controls {
            flex-wrap: wrap;
        }
        
        .handbook-btn {
            flex-grow: 1;
        }
        }

        /* Animation for new/edit controls */
        @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
        }

        .handbook-controls {
        animation: fadeIn 0.3s ease-out;
        }

        /* NEW: Desktop Recommendation Modal Specific Styling */
        #desktopRecommendationModal .modal-content {
            max-width: 550px; /* Make this modal slightly narrower */
            text-align: center;
            padding: 30px; /* Adjust padding as needed */
        }

        #desktopRecommendationModal h3 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #desktopRecommendationModal p {
            font-size: 15px;
        }

        #desktopRecommendationModal .btn {
            margin-top: 10px;
            width: auto; /* Allow button to size itself */
            justify-content: center; /* Center content within the button */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-and-title-container">
                    <div class="header-logo">
                        <img src="./favicon.png" alt="OSINTVault Logo" class="osintvault-logo-img">
                    </div>
                    <div class="header-text-group">
                        <div class="header-title">
                            OSINTVault
                        </div>
                        <span class="header-tagline">Your OSINT tools, always with you.</span>
                    </div>
                </div>
                <div class="controls">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search intelligence tools, techniques, indicators...">
                        <i class="fas fa-search search-icon"></i>
                        <select id="searchScopeSelect">
                            <option value="currentTab">Current Tab</option>
                            <option value="allVault">All Intelligence Vault</option>
                            <option value="allData">All Data</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" id="exportBtn">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn btn-secondary" id="shareOptionsBtn">
                        <i class="fas fa-share-alt"></i>
                        Share
                    </button>
                    <button class="btn btn-secondary" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <i class="fas fa-tools"></i>
                <span>Tools:</span>
                <span class="stat-value" id="totalTools">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-folder"></i>
                <span>Categories:</span>
                <span class="stat-value" id="totalCategories">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-star"></i>
                <span>Starred:</span>
                <span class="stat-value" id="starredToolsCount">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-thumbtack"></i>
                <span>Pinned:</span>
                <span class="stat-value" id="pinnedToolsCount">0</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="sidebar">
                <div class="filter-section">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sort By</label>
                        <select id="sortFilter">
                            <option value="name">Name (A-Z)</option>
                            <option value="recent">Recently Added</option>
                            <option value="popular">Most Used</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <button class="btn btn-secondary" id="showAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-eye"></i>
                        Show All
                    </button>
                    <button class="btn btn-secondary" id="pinAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-thumbtack"></i>
                        Pinned Entries
                    </button>
                    <button class="btn btn-secondary" id="starAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-star"></i>
                        Starred Entries
                    </button>
                    <button class="btn btn-success" id="reportBtn" style="width: 100%;">
                        <i class="fas fa-file-alt"></i>
                        Generate Report
                    </button>
                </div>

                <div class="filter-section" style="margin-top: 25px;">
                    <h3><i class="fas fa-random"></i> Discovery</h3>
                    <div class="random-display" id="randomDiscovery">
                        <div class="random-content-wrapper">
                            <div class="random-display-header">
                                <span class="header-icon"><i class="fas fa-magic"></i></span>
                                <h3 class="header-text">Daily OSINT Discovery</h3>
                            </div>
                            <div class="random-item-placeholder" id="randomItemDisplay">
                                <div class="loading"></div> Loading discovery...
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" id="newRandomBtn">
                            <i class="fas fa-sync-alt"></i> New Discovery
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="intelligence-vault">
                        <i class="fas fa-tools"></i>
                        Intelligence Vault
                    </button>
                    <button class="nav-tab" data-tab="custom-tabs">
                        <i class="fas fa-layer-group"></i>
                        Multi-Vault
                    </button>
                    <button class="nav-tab" data-tab="analytics">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                    <button class="nav-tab" data-tab="threats">
                        <i class="fas fa-exclamation-triangle"></i>
                        Threat Intel
                    </button>
                    <button class="nav-tab" data-tab="dork-assistant">
                        <i class="fas fa-terminal"></i> Dork Assistant
                    </button>
                    <button class="nav-tab" data-tab="handbook">
                        <i class="fas fa-book"></i> OSINT Handbook & Notes
                    </button>
                </div>

                <div class="bulk-actions" id="bulkActions">
                    <span>Selected: <span id="selectedCount">0</span> tools</span>
                    <button class="btn btn-secondary" id="bulkStarBtn">
                        <i class="fas fa-star"></i>
                        Star/Unstar Selected
                    </button>
                    <button class="btn btn-secondary" id="bulkPinBtn">
                        <i class="fas fa-thumbtack"></i>
                        Pin/Unpin Selected
                    </button>
                    <button class="btn btn-danger" id="bulkDeleteBtn">
                        <i class="fas fa-trash"></i>
                        Delete Selected
                    </button>
                </div>

                <div class="tab-content" id="toolsTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Tools Arsenal</h2>
                        <div class="controls">
                            <button class="btn btn-secondary" id="viewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                    
                    <div class="tools-grid" id="toolsGrid">
                        </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-search"></i>
                        <h3>No Tools Found</h3>
                        <p>No intelligence tools match your current search criteria.</p>
                        <button class="btn btn-primary" id="clearFiltersBtn">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <div class="tab-content" id="analyticsTab">
                    <div class="content-header">
                        <h2 class="content-title">Usage Analytics</h2>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="toolsUsed">0</div>
                            <div>Tools Used Today</div>
                        </div>
                    </div>

                    <div class="analytics-section">
                        <h4>Top 5 Most Used Tools</h4>
                        <ul class="analytics-list" id="mostUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noMostUsedTools" style="display:none; padding:20px;">
                            <p>No usage data available yet.</p>
                        </div>
                    </div>

                    <div class="analytics-section">
                        <h4>Tools Never Used</h4>
                        <ul class="analytics-list" id="neverUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noNeverUsedTools" style="display:none; padding:20px;">
                            <p>All tools have been used at least once!</p>
                        </div>
                    </div>

                     <div class="analytics-section">
                        <h4>Tools Added Per Week</h4>
                        <ul class="analytics-list" id="toolsAddedPerWeekList">
                            </ul>
                        <div class="empty-state" id="noToolsAdded" style="display:none; padding:20px;">
                            <p>No tools added recently.</p>
                        </div>
                    </div>

                </div>

                <div class="tab-content" id="threatsTab">
                    <div class="content-header">
                        <h2 class="content-title">Threat Intelligence Feed</h2>
                        <button class="btn btn-primary" id="refreshThreatsBtn">
                            <i class="fas fa-sync"></i>
                            Refresh Feed
                        </button>
                    </div>
                    
                    <div id="threatsList">
                        </div>
                </div>

                <div class="tab-content active" id="intelligence-vaultTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Vault (OSINT Tools)</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="addToolBtnIntelligenceVault">
                                <i class="fas fa-plus-circle"></i>
                                Add New Tool
                            </button>
                            <button class="btn btn-secondary" id="vaultViewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                
                    <div class="nav-tabs" id="intelligenceVaultParentTabs" style="margin-top: 20px;">
                        </div>
                
                    <div class="sub-nav-tabs" id="intelligenceVaultChildTabs" style="display: none; margin-top: 15px;">
                        </div>
                
                    <div class="tools-grid" id="intelligenceVaultEntries" style="margin-top: 20px;">
                        </div>
                
                    <div class="empty-state" id="emptyIntelligenceVaultState" style="display: none;">
                        <i class="fas fa-database"></i>
                        <h3>No Tools Found in This Category</h3>
                        <p>No OSINT tools match your current criteria in this category.</p>
                        <button class="btn btn-primary" id="addToolBtnEmptyState">
                            <i class="fas fa-plus-circle"></i>
                            Add New Tool
                        </button>
                    </div>
                </div>


                <div class="tab-content" id="custom-tabsTab">
                    <div class="content-header">
                        <h2 class="content-title">Multi-Vault: Your Investigations</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="createSubTabBtn">
                                <i class="fas fa-plus"></i>
                                Create Custom Vault
                            </button>
                            <button class="btn btn-secondary" id="editSubTabBtn" style="display: none;">
                                <i class="fas fa-edit"></i>
                                Edit Vault
                            </button>
                            <button class="btn btn-danger" id="deleteSubTabBtn" style="display: none;">
                                <i class="fas fa-trash"></i>
                                Delete Vault
                            </button>
                            <button class="btn btn-secondary" id="exportSubTabBtn" style="display: none;">
                                <i class="fas fa-download"></i>
                                Export Vault
                            </button>
                        </div>
                    </div>

                    <div class="sub-nav-tabs" id="customSubTabs">
                    </div>

                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-success" id="addEntryBtnCustomVault">
                            <i class="fas fa-plus-circle"></i>
                            Add New Entry
                        </button>
                        <button class="btn btn-secondary" id="customVaultViewToggle" title="Switch to List View">
                            <i class="fas fa-list"></i>
                            List View
                        </button>
                    </div>

                    <div class="nav-tabs" id="customVaultEntryParentTabs" style="margin-top: 20px; display: none;">
                        </div>
                
                    <div class="sub-nav-tabs" id="customVaultEntryChildTabs" style="margin-top: 15px; display: none;">
                        </div>

                    <div class="tools-grid" id="customTabToolsGrid" style="margin-top: 20px;">
                        </div>

                    <div class="empty-state" id="emptyCustomTabState" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Custom Vault Yet</h3>
                        <p>Create your first custom vault to organize your investigations!</p>
                        <button class="btn btn-primary" id="createSubTabBtnEmptyState">
                            <i class="fas fa-plus"></i>
                            Create Custom Vault
                        </button>
                    </div>
                    <div class="empty-state" id="emptyCurrentCustomTabState" style="display: none;">
                        <i class="fas fa-clipboard"></i>
                        <h3>No Entries in this Custom Vault</h3>
                        <p>Add tools or collected intelligence to this vault using the "Add New Entry" button.</p>
                    </div>
                </div>

                <div class="tab-content" id="handbookTab">

                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab handbook-subtab active" data-subtab="handbook">
                            <i class="fas fa-book"></i> OSINT Handbook
                        </button>
                        <button class="sub-nav-tab handbook-subtab" data-subtab="notes">
                            <i class="fas fa-sticky-note"></i> My Notes
                        </button>
                    </div>

                    <!-- Handbook Content -->
                    <div class="handbook-subtab-content" id="handbook-content" style="display: block;">
                        <div class="handbook-container">
                            <div class="handbook-sidebar" id="handbook-sidebar">
                                <div class="handbook-search-container">
                                    <input type="text" id="handbook-search" class="handbook-search" placeholder="Search handbook...">
                                    <i class="fas fa-search handbook-search-icon"></i>
                                </div>
                                <!-- Sidebar content will be populated by JS -->
                            </div>
                            
                            <div class="handbook-content-container">
                                <div class="handbook-content" id="handbook-article-area"> </div>
                            </div>
                        </div>
                        
                        <button id="handbook-mobile-toggle" class="handbook-mobile-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    
                    <!-- Notes Content -->
                    <div class="handbook-subtab-content" id="notes-content" style="display: none;">
                        <div class="notes-container">
                            <!-- Notes List View -->
                            <div id="notes-list-view" class="notes-list-view">
                                <div class="notes-header">
                                    <h2 class="notes-title">My Notes</h2>
                                    <div class="notes-search-container">
                                        <input type="text" id="search-notes" class="notes-search" placeholder="Search notes...">
                                        <i class="fas fa-search notes-search-icon"></i>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="noteSortFilter" class="sr-only">Sort Notes</label>
                                        <select id="noteSortFilter" style="padding: 10px 12px; border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);">
                                            <option value="updated_desc">Last Updated (Newest)</option>
                                            <option value="updated_asc">Last Updated (Oldest)</option>
                                            <option value="created_desc">Created (Newest)</option>
                                            <option value="created_asc">Created (Oldest)</option>
                                            <option value="title_asc">Title (A-Z)</option>
                                            <option value="title_desc">Title (Z-A)</option>
                                        </select>
                                    </div>
                                    <button id="new-note-btn" class="new-note-btn">
                                        <i class="fas fa-plus"></i> New Note
                                    </button>
                                </div>
                                
                                <div id="notes-list"></div>
                            </div>
                            
                            <!-- Note Editor View -->
                            <div id="note-editor-view" class="note-editor-view" style="display: none;">
                                <div class="note-editor-header">
                                    <h2 class="note-editor-title">Edit Note</h2>
                                    <div class="note-editor-actions">
                                        <button id="back-to-notes-btn" class="back-btn">
                                            <i class="fas fa-arrow-left"></i> Back to Notes
                                        </button>
                                        <button id="edit-note-btn" class="edit-note-btn" style="display: none;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button id="cancel-edit-note-btn" class="btn btn-secondary" style="display: none;">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                        <button id="save-note-btn" class="save-note-btn">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                    </div>
                                </div>
                                
                                <input type="text" id="note-title-input" class="note-title-input" placeholder="Note Title" maxlength="70">
                                
                                <div id="formatting-toolbar" class="formatting-toolbar">
                                    <button class="formatting-btn" data-command="bold" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="italic" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="underline" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="strikeThrough" title="Strikethrough">
                                        <i class="fas fa-strikethrough"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h1" title="Heading 1">
                                        <i class="fas fa-heading"></i>1
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                                        <i class="fas fa-heading"></i>2
                                    </button>
                                    <button class="formatting-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                                        <i class="fas fa-heading"></i>3
                                    </button>
                                    <button class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="createLink" title="Insert Link">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyLeft" title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyCenter" title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button class="formatting-btn" data-command="justifyRight" title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                                
                                <div id="note-content-editor" class="note-content-editor" contenteditable="true"></div>
                                
                                <div class="note-tags-section">
                                    <h3 class="note-tags-header">Tags</h3>
                                    <div id="note-tags-container" class="note-tags-container">
                                        <!-- Tags will be populated by JS -->
                                    </div>
                                    <div id="tag-input-container" class="tag-input-container">
                                        <input type="text" id="note-tags-input" class="note-tags-input" placeholder="Add a tag...">
                                        <button id="add-tag-btn" class="add-tag-btn">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="dork-assistantTab">
                    <div class="sub-nav-tabs">
                        <button class="sub-nav-tab dork-subtab active" data-dork-subtab="query-playground">
                            <i class="fas fa-hammer"></i> Query Playground
                        </button>
                        <button class="sub-nav-tab dork-subtab" data-dork-subtab="pre-templates">
                            <i class="fas fa-list-alt"></i> Pre-Templates
                        </button>
                        <button class="sub-nav-tab dork-subtab" data-dork-subtab="saved-queries">
                            <i class="fas fa-save"></i> Saved Queries
                        </button>
                    </div>

                    <div class="dork-subtab-content" id="query-playground-content" style="display: block; margin-top: 20px;">
                        <div class="content-header">
                            <h2 class="content-title">Query Playground</h2>
                            <div class="controls">
                                <button class="btn btn-secondary" id="clearDorkBuilderBtn">
                                    <i class="fas fa-eraser"></i> Clear Builder
                                </button>
                                <button class="btn btn-primary" id="executeDorkBtn">
                                    <i class="fas fa-play"></i> Execute Query
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: var(--shadow);">
                                <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-cogs"></i> Builder Options</h4>
                                <div class="form-group">
                                    <label for="dorkEngineSelect">Target Search Engine</label>
                                    <select id="dorkEngineSelect" class="form-group-input">
                                        <option value="google">Google</option>
                                        <option value="duckduckgo">DuckDuckGo</option>
                                        <option value="bing">Bing</option>
                                        <option value="yandex">Yandex</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Keywords / Phrases (separated by comma)</label>
                                    <input type="text" id="dorkKeywords" placeholder="e.g., 'john doe', 'confidential report'">
                                </div>

                                <div style="margin-top: 20px;">
                                    <h5 style="color: var(--text-primary); margin-bottom: 10px;">Operators</h5>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="site:" title="Search within a specific website.">site:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="filetype:" title="Search for specific file types (e.g., pdf, docx, xls).">filetype:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="intitle:" title="Search for terms in the page title.">intitle:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="inurl:" title="Search for terms in the URL.">inurl:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="intext:" title="Search for terms within the page text.">intext:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="related:" title="Find sites related to a given URL.">related:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="cache:" title="Show the cached version of a page.">cache:</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="AROUND()" title="Find terms within a certain proximity (e.g., term1 AROUND(5) term2).">AROUND()</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="OR" title="Boolean OR operator.">OR</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="AND" title="Boolean AND operator.">AND</button>
                                        <button class="btn btn-secondary btn-sm dork-operator-btn" data-operator="-" title="Exclude a term.">-</button>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-top: 20px;">
                                    <label>Additional Custom Operators / Terms</label>
                                    <textarea id="dorkCustomInput" rows="4" placeholder="Add custom operators or full dork segments here. Example: inurl:/admin/ &quot;login&quot;"></textarea>
                                </div>
                                <button class="btn btn-success" id="saveCurrentDorkBtn" style="width: 100%; margin-top: 20px;">
                                    <i class="fas fa-save"></i> Save Current Query
                                </button>
                            </div>

                            <div style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: var(--shadow);">
                                <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-eye"></i> Live Query Preview</h4>
                                <textarea id="dorkQueryPreview" rows="12" readonly style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: vertical;"></textarea>

                                <div style="margin-top: 20px;">
                                    <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-exchange-alt"></i> Convert Query</h4>
                                    <div class="form-group">
                                        <label for="conversionTarget">Convert to (Shodan/Censys)</label>
                                        <select id="conversionTarget" class="form-group-input">
                                            <option value="">Select Target</option>
                                            <option value="shodan">Shodan</option>
                                            <option value="censys">Censys</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-secondary" id="convertDorkBtn" style="width: 100%; margin-bottom: 10px;">Convert & Preview</button>
                                    <textarea id="convertedDorkPreview" rows="4" readonly style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: vertical; display: none;"></textarea>
                                    <button class="btn btn-primary" id="executeConvertedDorkBtn" style="width: 100%; margin-top: 10px; display: none;">
                                        <i class="fas fa-play"></i> Execute Converted Query
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dork-subtab-content" id="pre-templates-content" style="display: none; margin-top: 20px;">
                        <div class="pre-templates-container">
                            <div class="pre-templates-sidebar">
                                <h3 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-folder-open"></i> Categories</h3>
                                <div id="preTemplateCategoriesList">
                                    </div>
                                <div class="empty-state" id="preTemplateCategoriesEmptyState" style="display: none; padding: 15px; margin-top: 15px;">
                                    <i class="fas fa-info-circle" style="font-size: 24px;"></i>
                                    <p style="font-size: 0.9em;">No categories available.</p>
                                </div>
                            </div>

                            <div class="pre-templates-main">
                                <div class="content-header">
                                    <h2 class="content-title" id="currentTemplateCategoryTitle">All Templates</h2>
                                    <div class="controls">
                                        <input type="text" id="preTemplateSearchInput" class="search-input" placeholder="Search templates..." style="max-width: 300px; margin-right: 10px;">
                                        <button class="btn btn-secondary" id="clearPreTemplateSearch">
                                            <i class="fas fa-times"></i> Clear Search
                                        </button>
                                    </div>
                                </div>
                                <div id="dorkTemplatesList" class="tools-grid">
                                    </div>
                                <div class="empty-state" id="preTemplatesEmptyState" style="display: none;">
                                    <i class="fas fa-clipboard-list"></i>
                                    <h3>No Templates Found</h3>
                                    <p>Adjust your search or select another category.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dork-subtab-content" id="saved-queries-content" style="display: none; margin-top: 20px;">
                        <div class="content-header">
                            <h2 class="content-title">My Saved Dork Queries</h2>
                            <div class="controls">
                                <input type="text" id="savedQueriesSearch" class="search-input" placeholder="Search saved queries..." style="max-width: 300px; margin-right: 10px;">
                                <button class="btn btn-secondary" id="clearSavedQueriesSearch">
                                    <i class="fas fa-times"></i> Clear Search
                                </button>
                            </div>
                        </div>
                        <div id="savedQueriesList" class="tools-grid">
                            </div>
                        <div class="empty-state" id="savedQueriesEmptyState" style="display: block;">
                            <i class="fas fa-bookmark"></i>
                            <h3>No Saved Queries Yet</h3>
                            <p>Save your favorite dork queries from the Query Playground!</p>
                        </div>
                    </div>

                    <div class="modal" id="saveDorkQueryModal">
                        <div class="modal-content">
                            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-save"></i> Save Dork Query</h3>
                            <form id="saveDorkQueryForm">
                                <div class="form-group">
                                    <label for="savedQueryName">Query Name</label>
                                    <input type="text" id="savedQueryName" required placeholder="e.g., Exposed PDF Reports for Acme Corp">
                                </div>
                                <div class="form-group">
                                    <label for="savedQueryDescription">Description (Optional)</label>
                                    <textarea id="savedQueryDescription" rows="3" placeholder="Brief description of what this query targets or finds."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="savedQueryTags">Tags (comma separated)</label>
                                    <input type="text" id="savedQueryTags" placeholder="e.g., recon, filetype, google">
                                </div>
                                <div class="form-group">
                                    <label>Generated Query</label>
                                    <textarea id="savedQueryGenerated" rows="4" readonly style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="savedQueryEngine">Target Engine</label>
                                    <input type="text" id="savedQueryEngine" readonly class="form-group-input" style="background: var(--bg-tertiary); color: var(--text-primary);">
                                </div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                    <button type="button" class="btn btn-secondary" id="cancelSaveDorkQuery">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Query</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal" id="editExecuteTemplateModal">
                        <div class="modal-content">
                            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-edit"></i> Edit & Execute Template</h3>
                            <form id="editExecuteTemplateForm">
                                <input type="hidden" id="editExecuteTemplateId">
                                <div class="form-group">
                                    <label for="editExecuteTemplateName">Template Name</label>
                                    <input type="text" id="editExecuteTemplateName" readonly style="background: var(--bg-tertiary); color: var(--text-primary);">
                                </div>
                                <div class="form-group">
                                    <label for="editExecuteTemplateQuery">Query to Edit</label>
                                    <textarea id="editExecuteTemplateQuery" rows="6" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; resize: vertical;" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editExecuteTemplateEngine">Target Engine</label>
                                    <select id="editExecuteTemplateEngine" class="form-group-input">
                                        <option value="google">Google</option>
                                        <option value="duckduckgo">DuckDuckGo</option>
                                        <option value="bing">Bing</option>
                                        <option value="yandex">Yandex</option>
                                        <option value="shodan">Shodan</option>
                                        <option value="censys">Censys</option>
                                    </select>
                                </div>

                                <div id="editExecuteConversionSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-light); display: none;">
                                    <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-exchange-alt"></i> Convert Query to Target Engine</h4>
                                    <button type="button" class="btn btn-warning" id="performEditExecuteConversionBtn" style="width: 100%;">
                                        <i class="fas fa-magic"></i> Convert Query
                                    </button>
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                    <button type="button" class="btn btn-secondary" id="cancelEditExecuteTemplate">Cancel</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-play"></i> Execute Query
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal" id="dorkWarningModal">
                        <div class="modal-content">
                            <h3 style="margin-bottom: 20px; color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Query Engine Mismatch Warning</h3>
                            <p id="dorkWarningMessage" style="margin-bottom: 25px; color: var(--text-primary); line-height: 1.6;">
                                </p>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" id="cancelDorkWarning">Cancel</button>
                                <button type="button" class="btn btn-warning" id="convertAndGoToPlayground">
                                    <i class="fas fa-magic"></i> Convert Query Here
                                </button>
                                <button type="button" class="btn btn-primary" id="continueDorkExecution">
                                    <i class="fas fa-play"></i> Continue Anyway
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <section class="investigation-wall">
            <div class="wall-texture"></div>
            <div class="floating-particles" id="particles"></div>
            <h2 class="section-title-wall"><i class="fas fa-clipboard-list"></i>Investigation Wall: OSINT Tips & Tricks</h2>
            
            <div class="connecting-lines" id="connecting-lines"></div>
            
            <div class="evidence-grid">
                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 13 15.5l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        Search Techniques
                    </div>
                    <div class="card-content-wall">
                        Use <span class="highlight-wall">Google Dorks</span> for advanced searches. Try operators like site:, filetype:, and intitle: to narrow results. Remember: <span class="highlight-wall">"" for exact phrases</span> and - to exclude terms.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Social Media Intel
                    </div>
                    <div class="card-content-wall">
                        Check <span class="highlight-wall">metadata</span> in images and posts. Use reverse image searches. Look for <span class="highlight-wall">connected accounts</span> across platforms using same usernames or profile pics.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        Documentation
                    </div>
                    <div class="card-content-wall">
                        Always <span class="highlight-wall">screenshot evidence</span> before it disappears. Use timestamps and archive tools like Wayback Machine. Document your <span class="highlight-wall">methodology</span> for legal purposes.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Digital Footprints
                    </div>
                    <div class="card-content-wall">
                        Check <span class="highlight-wall">WHOIS data</span> for domains. Look at DNS records, SSL certificates. Use tools like Shodan for IoT devices. Email headers reveal routing paths.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                        </svg>
                        Privacy & Security
                    </div>
                    <div class="card-content-wall">
                        Use <span class="highlight-wall">VPN and Tor</span> for anonymity. Create separate investigation personas. Never use personal accounts. Clear browser data and use <span class="highlight-wall">incognito mode</span>.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Verification
                    </div>
                    <div class="card-content-wall">
                        <span class="highlight-wall">Cross-reference</span> information from multiple sources. Use fact-checking sites. Verify timestamps and locations. Look for <span class="highlight-wall">digital inconsistencies</span> in manipulated content.
                    </div>
                </div>
            </div>
        </section>

        <div class="modal" id="desktopRecommendationModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: var(--warning);"><i class="fas fa-desktop"></i> Attention: Desktop Recommended</h3>
                <p style="margin-bottom: 15px; color: var(--text-primary);">
                    OSINTVault is primarily designed for desktop use to provide the best experience and access to all features. For optimal functionality, please access this tool on a larger screen.
                </p>
                <p style="margin-bottom: 25px; color: var(--text-secondary);">
                    You can still proceed, but some options may not be fully visible or functional on smaller screens.
                </p>
                <div style="display: flex; justify-content: flex-end;">
                    <button type="button" class="btn btn-primary" id="continueAnywayBtn">
                        <i class="fas fa-arrow-right"></i> Continue Anyway
                    </button>
                </div>
            </div>
        </div>


        <div class="modal" id="addToolOnlyModal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Tool</h3>
                <form id="addToolOnlyForm">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolOnlyName" name="toolOnlyName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolOnlyUrl" name="toolOnlyUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolOnlyCategory" required>
                            <option value="">Select Category</option>
                            </select>
                        <input type="text" id="newToolOnlyCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolOnlyDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolOnlyTags" placeholder="osint, investigation, cybersecurity">
                    </div>

                    <div class="custom-tab-assignment" id="intelligenceVaultCategoriesAssignmentAddTool">
                        <h4>Add to Intelligence Vault Categories</h4>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">Select one or more intelligence categories for this tool.</p>
                    
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div style="position: relative;">
                                <input type="text" id="intelligenceVaultCategorySearch" class="search-input" placeholder="Search categories..." style="padding-right: 40px;">
                                <i class="fas fa-search search-icon" style="right: 15px;"></i>
                            </div>
                        </div>
                    
                        <div class="custom-tab-checkboxes-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                            <div class="custom-tab-checkboxes" id="intelligenceVaultCategoriesCheckboxesAddTool">
                                </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" id="cancelAddToolOnly">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Tool</button>
                    </div>
                </form>
            </div>
        </div>

        <footer class="footer-bottom">
            <p>&copy; 2025 OSINTVault. Built for cybersecurity professionals and researchers.</p>
            <p style="margin-top: 10px; font-size: 12px;">
                <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                Secure  Anonymous  Professional
            </p>
        </footer>
    </div>



    <div class="modal" id="addEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Entry</h3>
            <form id="addEntryForm">
                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="entryTypeSelect">
                        <option value="tool">Tool</option>
                        <option value="email">Email Address</option>
                        <option value="phone">Phone Number</option>
                        <option value="crypto">Crypto Transaction</option>
                        <option value="location">Location</option>
                        <option value="link">Social / Internet Link</option>
                        <option value="media">Image / Video</option>
                        <option value="password">Password</option>
                        <option value="keyword">Keyword</option>
                        <option value="social">Social Media Profile</option>

                        <option value="domain">Domain/IP/URL</option>
                        <option value="username">Username/Handle</option>
                        <option value="threat">Threat Intelligence</option>
                        <option value="vulnerability">Vulnerability</option>
                        <option value="malware">Malware/File</option>
                        <option value="breach">Data Breach</option>
                        <option value="credential">Credential Dump</option>
                        <option value="forum">Forum/Market</option>
                        <option value="vendor">Underground Vendor</option>
                        <option value="telegram">Telegram Channel</option>
                        <option value="paste">Paste Site</option>
                        <option value="document">Document</option>
                        <option value="network">Network Analysis</option>
                        <option value="metadata">Metadata</option>
                        <option value="archive">Archive/Cache</option>
                        <option value="messaging">Messaging App</option>
                        <option value="dating">Dating Profile</option>
                        <option value="audio">Audio File</option>
                        <option value="facial">Facial Recognition</option>
                        <option value="persona">Persona/Identity</option>
                        <option value="vpn">VPN/Anonymity</option>
                        <option value="honeypot">Honeypot</option>
                        <option value="exploit">Exploit/Market</option>
                        <option value="publicrecord">Public Record</option>
                    </select>
                </div>
                
                <div id="addToolFields" class="entry-fields">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolName" name="toolName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolUrl" name="toolUrl">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolCategory">
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="newCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="toolInvestigationNotes" rows="3" placeholder="Any specific notes or observations about this tool in your investigation."></textarea>
                    </div>
                </div>
                
                <div id="addEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="emailAddress" name="emailAddress" maxlength="60">
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="emailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="emailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="emailDescription" rows="3" placeholder="Brief description of the email's context or significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="emailNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="phoneNumber" maxlength="15" name="phoneNumber" placeholder="e.g., +1-234-567-8901">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="phoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="phoneLocation" placeholder="e.g., City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="phoneDescription" rows="3" placeholder="Brief description of the phone number's context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="phoneNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="cryptoAddress" name="cryptoAddress" maxlength="120" placeholder="e.g., 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="cryptoTxid" name="cryptoTxid">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" id="cryptoAmount" name="cryptoAmount" placeholder="e.g., 0.005 BTC">
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="cryptoSource" placeholder="exchange, darkweb, personal" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="cryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="cryptoDescription" rows="3" placeholder="Brief description of the transaction or address's significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="cryptoNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="locationName" name="locationName" placeholder="e.g., Target building, Suspect's residence" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="locationCoordinates" name="locationCoordinates" placeholder="e.g., 34.0522, -118.2437">
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="locationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="locationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="locationDescription" rows="3" placeholder="Brief description of the location's relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="locationNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="linkUrl" name="linkUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="linkPlatform" placeholder="twitter, reddit, pastebin, forum" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="linkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="linkDescription" rows="3" placeholder="Brief description of what the link contains or its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="linkNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="mediaTitle" name="mediaTitle" maxlength="50" placeholder="e.g., Suspect Photo, Video Evidence">
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="mediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload File (Local Only)</label>
                        <input type="file" id="mediaFile" accept="image/*,video/*">
                        <input type="hidden" id="mediaBase64Data"> <small style="color: var(--text-muted);">For local storage only. File will be base64 encoded.</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="mediaDescription" rows="3" placeholder="Brief description of the media content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="mediaNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="passwordService" name="passwordService" placeholder="e.g., Facebook, Gmail, Database">
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="passwordUsername" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="passwordValue" placeholder="e.g., P@ssw0rd123!" maxlength="120">
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="passwordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="passwordDescription" rows="3" placeholder="Context or relevance of this password."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="passwordNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="keywordValue" name="keywordValue" placeholder="e.g., 'John Doe', 'Project X', 'Confidential'">
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="keywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="keywordDescription" rows="3" placeholder="Elaborate on why this keyword is important."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="keywordNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="socialPlatform" name="socialPlatform" placeholder="e.g., Twitter, Instagram, TikTok">
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="socialUrl" placeholder="e.g., https://twitter.com/suspectprofile">
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="socialUsername" placeholder="e.g., @suspectprofile" maxlength="60">
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="socialFollowCounts" maxlength="50" placeholder="e.g., 12k followers, 500 following">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="socialDescription" rows="3" placeholder="Overview of the profile's content and activity."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="socialNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addDomainFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Domain/IP/URL</label>
                        <input type="text" id="domainValue" name="domainValue" placeholder="e.g., example.com, 192.168.1.1, https://suspicious-site.com">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="domainType">
                            <option value="domain">Domain</option>
                            <option value="ip">IP Address</option>
                            <option value="url">URL</option>
                            <option value="subdomain">Subdomain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Registrar/ISP</label>
                        <input type="text" id="domainRegistrar" placeholder="e.g., GoDaddy, Cloudflare, Comcast">
                    </div>
                    <div class="form-group">
                        <label>Country/Location</label>
                        <input type="text" id="domainLocation" placeholder="e.g., United States, Russia">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="domainStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspicious">Suspicious</option>
                            <option value="malicious">Malicious</option>
                            <option value="parked">Parked</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>WHOIS Info</label>
                        <textarea id="domainWhois" rows="3" placeholder="WHOIS registration details"></textarea>
                    </div>
                    <div class="form-group">
                        <label>DNS Records</label>
                        <textarea id="domainDns" rows="3" placeholder="A, MX, NS, TXT records"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="domainTags" placeholder="phishing, c2, malware, suspicious">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="domainNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addUsernameFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="usernameValue" name="usernameValue" placeholder="e.g., darkweb_trader, john_doe123" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Platforms Found</label>
                        <textarea id="usernamePlatforms" rows="3" placeholder="List platforms where this username was found"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated Email(s)</label>
                        <input type="text" id="usernameEmails" placeholder="email1@domain.com, email2@domain.com">
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="usernameRealName" placeholder="e.g., John Doe" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="usernameActivity">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="usernameDescription" rows="3" placeholder="Elaborate on the significance of this username."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="usernameNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addThreatFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Threat Type</label>
                        <select id="threatType">
                            <option value="malware">Malware</option>
                            <option value="apt">APT Group</option>
                            <option value="ioc">IOC (Indicator of Compromise)</option>
                            <option value="ttp">TTP (Tactics, Techniques, Procedures)</option>
                            <option value="campaign">Campaign</option>
                            <option value="actor">Threat Actor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Threat Name/ID</label>
                        <input type="text" id="threatName" name="threatName" placeholder="e.g., APT29, WannaCry, Emotet" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Severity Level</label>
                        <select id="threatSeverity">
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="info">Informational</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>IOCs (comma separated)</label>
                        <textarea id="threatIocs" rows="3" placeholder="IP addresses, domains, file hashes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Sectors</label>
                        <input type="text" id="threatTargets" placeholder="e.g., Government, Healthcare, Finance">
                    </div>
                    <div class="form-group">
                        <label>Attribution</label>
                        <input type="text" id="threatAttribution" placeholder="e.g., Nation-state, Criminal group, Unknown">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="threatDescription" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="threatSource" placeholder="e.g., MISP, AlienVault OTX, Internal">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="threatNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addVulnerabilityFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>CVE ID</label>
                        <input type="text" id="vulnCve" name="vulnCve" placeholder="e.g., CVE-2023-12345" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>CVSS Score</label>
                        <input type="number" step="0.1" min="0" max="10" id="vulnCvss" placeholder="e.g., 9.8">
                    </div>
                    <div class="form-group">
                        <label>Affected Software</label>
                        <input type="text" id="vulnSoftware" placeholder="e.g., Apache HTTP Server 2.4.x">
                    </div>
                    <div class="form-group">
                        <label>Vulnerability Type</label>
                        <select id="vulnType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="sqli">SQL Injection</option>
                            <option value="xss">Cross-Site Scripting</option>
                            <option value="privilege">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="info">Information Disclosure</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exploit Available</label>
                        <select id="vulnExploit">
                            <option value="no">No</option>
                            <option value="poc">PoC Available</option>
                            <option value="public">Public Exploit</option>
                            <option value="weaponized">Weaponized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="vulnDescription" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Mitigation</label>
                        <textarea id="vulnMitigation" rows="3" placeholder="Patches, workarounds, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="vulnNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMalwareFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>File Name</label>
                        <input type="text" id="malwareFilename" name="malwareFilename" placeholder="e.g., suspicious.exe, document.pdf" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA1/SHA256)</label>
                        <input type="text" id="malwareHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <select id="malwareType">
                            <option value="executable">Executable (.exe, .dll)</option>
                            <option value="document">Document (.pdf, .doc, .xls)</option>
                            <option value="script">Script (.js, .vbs, .ps1)</option>
                            <option value="archive">Archive (.zip, .rar)</option>
                            <option value="image">Image (.jpg, .png)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Malware Family</label>
                        <input type="text" id="malwareFamily" placeholder="e.g., Emotet, TrickBot, Ransomware">
                    </div>
                    <div class="form-group">
                        <label>Detection Ratio</label>
                        <input type="text" id="malwareDetection" placeholder="e.g., 45/70 (VirusTotal)">
                    </div>
                    <div class="form-group">
                        <label>Behavior</label>
                        <textarea id="malwareBehavior" rows="4" placeholder="File behavior, network connections, registry changes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="malwareSource" placeholder="e.g., Email attachment, Drive-by download">
                    </div>
                    <div class="form-group">
                        <label>Analysis Tools Used</label>
                        <input type="text" id="malwareTools" placeholder="e.g., VirusTotal, Hybrid Analysis, Cuckoo">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="malwareNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addBreachFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Company/Organization</label>
                        <input type="text" id="breachCompany" name="breachCompany" placeholder="e.g., Equifax, Target, LinkedIn" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Breach Date</label>
                        <input type="date" id="breachDate">
                    </div>
                    <div class="form-group">
                        <label>Records Affected</label>
                        <input type="number" id="breachRecords" placeholder="e.g., 147000000">
                    </div>
                    <div class="form-group">
                        <label>Data Types Compromised</label>
                        <textarea id="breachDataTypes" rows="3" placeholder="e.g., Names, SSNs, Credit card numbers, Passwords"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Attack Vector</label>
                        <select id="breachVector">
                            <option value="hacking">Hacking/Intrusion</option>
                            <option value="insider">Insider Threat</option>
                            <option value="physical">Physical</option>
                            <option value="malware">Malware</option>
                            <option value="social">Social Engineering</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="breachStatus">
                            <option value="confirmed">Confirmed</option>
                            <option value="suspected">Suspected</option>
                            <option value="investigating">Under Investigation</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source/Reference</label>
                        <input type="url" id="breachSource" placeholder="News article, official statement, etc.">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="breachDescription" rows="3" placeholder="Detailed description of the breach incident."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="breachNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addCredentialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Credential Type</label>
                        <select id="credentialType">
                            <option value="email_password">Email & Password</option>
                            <option value="username_password">Username & Password</option>
                            <option value="api_key">API Key</option>
                            <option value="ssh_key">SSH Key</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <textarea id="credentialValue" rows="3" placeholder="e.g., user@example.com:password123, username:password"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Service/Platform</label>
                        <input type="text" id="credentialService" placeholder="e.g., Company X Database, Internal System">
                    </div>
                    <div class="form-group">
                        <label>Breach/Source</label>
                        <input type="text" id="credentialBreachSource" placeholder="e.g., Pastebin, Dark Web Forum, Company Breach">
                    </div>
                    <div class="form-group">
                        <label>Date Found</label>
                        <input type="date" id="credentialDateFound">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="credentialDescription" rows="3" placeholder="Context or relevance of this credential dump."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="credentialNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addForumFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Forum/Market Name</label>
                        <input type="text" id="forumName" name="forumName" placeholder="e.g., BreachForums, Hydra Market" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="forumUrl" placeholder="e.g., http://xyz.onion/forum">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="forumType">
                            <option value="forum">Forum</option>
                            <option value="market">Marketplace</option>
                            <option value="carding">Carding Forum</option>
                            <option value="hacking">Hacking Forum</option>
                            <option value="ransomware">Ransomware Group</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="forumStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="down">Down/Seized</option>
                            <option value="scam">Scam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Primary Language</label>
                        <input type="text" id="forumLanguage" placeholder="e.g., English, Russian">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="forumDescription" rows="3" placeholder="Brief description of the forum/market and its primary focus."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="forumNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addVendorFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Vendor Name/Alias</label>
                        <input type="text" id="vendorAlias" name="vendorAlias" placeholder="e.g., 'DarkWebSupply', 'CredsMaster'" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Associated Platforms</label>
                        <textarea id="vendorPlatforms" rows="3" placeholder="e.g., Dark Web Market A, Telegram Channel B, Forum C"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Products/Services</label>
                        <input type="text" id="vendorProducts" placeholder="e.g., Stolen Credentials, Malware, Drugs">
                    </div>
                    <div class="form-group">
                        <label>Reputation Score</label>
                        <input type="text" id="vendorReputation" placeholder="e.g., 4.5/5, High Trust, Scammer">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="vendorDescription" rows="3" placeholder="Detailed description of the vendor's activities and offerings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="vendorNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addTelegramFields" class="entry-fields">
                    <div class="form-group">
                        <label>Channel Name</label>
                        <input type="text" id="telegramName" name="telegramName" placeholder="e.g., @darkweb_market" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Channel URL</label>
                        <input type="url" id="telegramUrl" placeholder="https://t.me/channelname">
                    </div>
                    <div class="form-group">
                        <label>Channel Type</label>
                        <select id="telegramType">
                            <option value="market">Marketplace</option>
                            <option value="news">News/Info</option>
                            <option value="leak">Data Leaks</option>
                            <option value="hacking">Hacking/Security</option>
                            <option value="crypto">Cryptocurrency</option>
                            <option value="social">Social/Chat</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subscriber Count</label>
                        <input type="number" id="telegramSubscribers" placeholder="e.g., 15000">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <input type="text" id="telegramLanguage" placeholder="e.g., English, Russian, Spanish" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="telegramActivity">
                            <option value="high">High (Daily posts)</option>
                            <option value="medium">Medium (Weekly posts)</option>
                            <option value="low">Low (Occasional posts)</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Content Description</label>
                        <textarea id="telegramContent" rows="3" placeholder="Description of typical content shared"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Admin/Owner Info</label>
                        <input type="text" id="telegramAdmin" placeholder="Known admin usernames or info">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="telegramTags" placeholder="darkweb, marketplace, leaks, cybercrime">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="telegramNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPasteFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Paste URL</label>
                        <input type="url" id="pasteUrl" name="pasteUrl" placeholder="e.g., https://pastebin.com/xyz123">
                    </div>
                    <div class="form-group">
                        <label>Source Site</label>
                        <input type="text" id="pasteSourceSite" placeholder="e.g., Pastebin, Pastie, Ghostbin">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="pasteContentSummary" rows="3" placeholder="Brief summary of leaked data or text"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Keywords/Indicators</label>
                        <input type="text" id="pasteKeywords" placeholder="e.g., email list, database dump, exploit code">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="pasteDescription" rows="3" placeholder="Detailed description of the paste's content and its relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="pasteNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addDocumentFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Document Title/Name</label>
                        <input type="text" id="documentTitle" name="documentTitle" placeholder="e.g., Project Proposal, Leaked Memo" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <input type="text" id="documentFileType" placeholder="e.g., PDF, DOCX, XLSX, TXT">
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA256)</label>
                        <input type="text" id="documentHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="documentContentSummary" rows="4" placeholder="Brief summary of document content, key findings"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="documentSource" placeholder="e.g., Email attachment, Public server, Data breach">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="documentDescription" rows="3" placeholder="Detailed description of the document's content and context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="documentNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addNetworkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Analysis Subject</label>
                        <input type="text" id="networkSubject" name="networkSubject" placeholder="e.g., 'Target Network Scan', 'Suspect's IP Traffic'" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Type of Analysis</label>
                        <select id="networkType">
                            <option value="scan">Port Scan</option>
                            <option value="traffic">Network Traffic Analysis</option>
                            <option value="dns">DNS Analysis</option>
                            <option value="whois">WHOIS Lookup</option>
                            <option value="fingerprint">Device Fingerprinting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Findings</label>
                        <textarea id="networkFindings" rows="4" placeholder="Open ports, suspicious traffic, identified services, vulnerabilities"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated IPs/Domains</label>
                        <textarea id="networkAssociated" rows="3" placeholder="Comma-separated list of IPs, domains, or URLs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="networkTools" placeholder="e.g., Nmap, Wireshark, Shodan">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="networkDescription" rows="3" placeholder="Overall description of the network analysis conducted."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="networkNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMetadataEntryFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Metadata Title/Context</label>
                        <input type="text" id="metadataTitle" placeholder="e.g., EXIF Data from Image, PDF Creation Info">
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">Use the 'Custom Metadata' section below to add key-value pairs for this entry.</p>
                    <div class="form-group">
                        <label>Metadata Description</label>
                        <textarea id="metadataDescription" rows="3" placeholder="A general description of the metadata collected or its context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>File/Source</label>
                        <input type="text" id="metadataFileSource" placeholder="e.g., image.jpg, document.pdf, website header">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="metadataNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addArchiveFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Original URL</label>
                        <input type="url" id="archiveOriginalUrl" name="archiveOriginalUrl" placeholder="e.g., https://example.com/old-page">
                    </div>
                    <div class="form-group">
                        <label>Archived URL/Link</label>
                        <input type="url" id="archiveUrl" name="archiveUrl" placeholder="e.g., https://web.archive.org/web/...">
                    </div>
                    <div class="form-group">
                        <label>Archiving Service</label>
                        <input type="text" id="archiveService" placeholder="e.g., Wayback Machine, Archive.is, Google Cache">
                    </div>
                    <div class="form-group">
                        <label>Timestamp</label>
                        <input type="datetime-local" id="archiveTimestamp">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="archiveContentSummary" rows="4" placeholder="Brief summary of the archived content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="archiveDescription" rows="3" placeholder="Context or relevance of this archived page/content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="archiveNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addMessagingFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Messaging App</label>
                        <select id="messagingApp">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="telegram">Telegram</option>
                            <option value="signal">Signal</option>
                            <option value="discord">Discord</option>
                            <option value="irc">IRC</option>
                            <option value="matrix">Matrix</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Username/ID</label>
                        <input type="text" id="messagingUsername" name="messagingUsername" placeholder="e.g., @userhandle, +1234567890">
                    </div>
                    <div class="form-group">
                        <label>Channel/Group/Chat ID</label>
                        <input type="text" id="messagingChatId" placeholder="e.g., Group Name, Channel ID">
                    </div>
                    <div class="form-group">
                        <label>Relevant Content</label>
                        <textarea id="messagingContent" rows="4" placeholder="Summary of conversations, key messages, shared files"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="messagingDescription" rows="3" placeholder="Context or relevance of this messaging app entry."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="messagingNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addDatingFields" class="entry-fields">
                    <div class="form-group">
                        <label>Platform</label>
                        <select id="datingPlatform">
                            <option value="tinder">Tinder</option>
                            <option value="bumble">Bumble</option>
                            <option value="match">Match.com</option>
                            <option value="pof">Plenty of Fish</option>
                            <option value="okcupid">OkCupid</option>
                            <option value="hinge">Hinge</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Profile Name/Username</label>
                        <input type="text" id="datingUsername" name="datingUsername" placeholder="e.g., John_D_NYC" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="datingDisplayName" placeholder="e.g., John, 28" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" min="18" max="99" id="datingAge" placeholder="e.g., 28">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="datingLocation" placeholder="e.g., New York, NY" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Profile Photos</label>
                        <textarea id="datingPhotos" rows="3" placeholder="Description of photos, reverse image search results, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bio/Description</label>
                        <textarea id="datingBio" rows="3" placeholder="Profile bio or description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Verification Status</label>
                        <select id="datingVerified">
                            <option value="verified">Verified</option>
                            <option value="unverified">Unverified</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Suspicious Flags</label>
                        <textarea id="datingSuspicious" rows="3" placeholder="Any red flags or suspicious indicators"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="datingNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addAudioFields" class="entry-fields">
                    <div class="form-group">
                        <label>Audio Title</label>
                        <input type="text" id="audioTitle" name="audioTitle" placeholder="e.g., Phone call recording, Voice message" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>File Format</label>
                        <select id="audioFormat">
                            <option value="mp3">MP3</option>
                            <option value="wav">WAV</option>
                            <option value="m4a">M4A</option>
                            <option value="ogg">OGG</option>
                            <option value="flac">FLAC</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <input type="text" id="audioDuration" placeholder="e.g., 2:30, 45 seconds">
                    </div>
                    <div class="form-group">
                        <label>Quality</label>
                        <select id="audioQuality">
                            <option value="high">High Quality</option>
                            <option value="medium">Medium Quality</option>
                            <option value="low">Low Quality</option>
                            <option value="poor">Poor Quality</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Language(s)</label>
                        <input type="text" id="audioLanguage" placeholder="e.g., English, Spanish, Multiple">
                    </div>
                    <div class="form-group">
                        <label>Transcript</label>
                        <textarea id="audioTranscript" rows="5" placeholder="Transcription of audio content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Speaker Analysis</label>
                        <textarea id="audioSpeakers" rows="3" placeholder="Number of speakers, gender, accents, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Background Noise</label>
                        <input type="text" id="audioBackground" placeholder="e.g., Traffic, music, office sounds">
                    </div>
                    <div class="form-group">
                        <label>Analysis Tools Used</label>
                        <input type="text" id="audioTools" placeholder="e.g., Audacity, Adobe Audition, Forensic tools">
                    </div>
                    <div class="form-group">
                        <label>Upload File (Local Only)</label>
                        <input type="file" id="audioFile" accept="audio/*">
                        <small>For local storage only. File will be base64 encoded.</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="audioDescription" rows="3" placeholder="Detailed description of the audio content and its relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="audioNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addFacialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Subject/Person Identified</label>
                        <input type="text" id="facialSubject" name="facialSubject" placeholder="e.g., John Doe, Suspect 1" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Source Image/Video Description</label>
                        <textarea id="facialSourceDescription" rows="3" placeholder="Where was the image/video found?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Identified Profiles/Platforms</label>
                        <textarea id="facialIdentifiedProfiles" rows="3" placeholder="e.g., Facebook Profile URL, Instagram Username"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Confidence Score</label>
                        <input type="text" id="facialConfidence" placeholder="e.g., High, 85%">
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="facialToolsUsed" placeholder="e.g., PimEyes, Google Images, Facial Recognition Software">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="facialDescription" rows="3" placeholder="Overall description of the facial recognition finding."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="facialNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPersonaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Persona Name/Alias</label>
                        <input type="text" id="personaName" name="personaName" placeholder="e.g., 'Online Gamer X', 'Business Account Y'" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="personaRealName" placeholder="e.g., John Doe" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Associated Usernames/Emails</label>
                        <textarea id="personaAssociatedAccounts" rows="3" placeholder="List all linked usernames, emails, phone numbers"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bio/Description</label>
                        <textarea id="personaBio" rows="4" placeholder="Profile bio or description of the persona."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Platforms Used</label>
                        <input type="text" id="personaPlatforms" placeholder="e.g., Twitter, Discord, Dark Web Forums">
                    </div>
                    <div class="form-group">
                        <label>Origin/Purpose</label>
                        <input type="text" id="personaOrigin" placeholder="e.g., Scammer, Investigator, Activist">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="personaNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addVpnFields" class="entry-fields">
                    <div class="form-group">
                        <label>Service Name</label>
                        <input type="text" id="vpnName" name="vpnName" placeholder="e.g., NordVPN, Tor Browser, ProtonVPN" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="vpnType">
                            <option value="vpn">VPN Service</option>
                            <option value="proxy">Proxy</option>
                            <option value="tor">Tor Network</option>
                            <option value="browser">Anonymous Browser</option>
                            <option value="os">Anonymous OS</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction</label>
                        <input type="text" id="vpnJurisdiction" placeholder="e.g., Panama, Switzerland, No logs">
                    </div>
                    <div class="form-group">
                        <label>Logging Policy</label>
                        <select id="vpnLogs">
                            <option value="no-logs">No Logs</option>
                            <option value="minimal">Minimal Logs</option>
                            <option value="connection">Connection Logs</option>
                            <option value="full">Full Logs</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Methods</label>
                        <input type="text" id="vpnPayment" placeholder="e.g., Bitcoin, Cash, Credit Card">
                    </div>
                    <div class="form-group">
                        <label>Server Locations</label>
                        <input type="text" id="vpnLocations" placeholder="e.g., 60+ countries, Europe only">
                    </div>
                    <div class="form-group">
                        <label>Known Issues/Leaks</label>
                        <textarea id="vpnIssues" rows="3" placeholder="DNS leaks, IP leaks, law enforcement cooperation, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Use Case</label>
                        <select id="vpnUseCase">
                            <option value="investigation">Investigation</option>
                            <option value="target">Used by Target</option>
                            <option value="opsec">Operational Security</option>
                            <option value="testing">Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="vpnDescription" rows="3" placeholder="General description of the VPN service or anonymity tool."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="vpnNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addHoneypotFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Honeypot Type</label>
                        <select id="honeypotType">
                            <option value="low-interaction">Low Interaction</option>
                            <option value="high-interaction">High Interaction</option>
                            <option value="data">Data Honeypot</option>
                            <option value="network">Network Honeypot</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deployment Location/IP</label>
                        <input type="text" id="honeypotLocation" placeholder="e.g., Public Cloud, 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label>Purpose</label>
                        <input type="text" id="honeypotPurpose" placeholder="e.g., Malware Analysis, Threat Actor Tracking">
                    </div>
                    <div class="form-group">
                        <label>Captured Data Summary</label>
                        <textarea id="honeypotDataSummary" rows="4" placeholder="Summary of captured attacks, malware, IPs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Alerts/Indicators</label>
                        <textarea id="honeypotAlerts" rows="3" placeholder="Key indicators or alerts generated"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="honeypotDescription" rows="3" placeholder="Detailed description of the honeypot setup and findings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="honeypotNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addExploitFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Exploit Name/ID</label>
                        <input type="text" id="exploitName" name="exploitName" placeholder="e.g., EternalBlue, CVE-2023-XXXX" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Target Vulnerability</label>
                        <input type="text" id="exploitTargetVuln" placeholder="e.g., MS17-010, Adobe Flash Zero-Day">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="exploitType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="privesc">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="zero-day">Zero-Day</option>
                            <option value="poc">PoC</option>
                            <option value="weaponized">Weaponized</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Market/Source</label>
                        <input type="text" id="exploitMarketSource" placeholder="e.g., Exploit-DB, Underground Market, Private Sale">
                    </div>
                    <div class="form-group">
                        <label>Price/Value</label>
                        <input type="text" id="exploitPrice" placeholder="e.g., $10,000, 2 BTC">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="exploitDescription" rows="3" placeholder="Technical description of the exploit and its capabilities."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="exploitNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addPublicRecordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Record Type</label>
                        <select id="publicRecordType">
                            <option value="court">Court Record</option>
                            <option value="property">Property Record</option>
                            <option value="business">Business Registration</option>
                            <option value="voter">Voter Registration</option>
                            <option value="license">License/Permit</option>
                            <option value="tax">Tax Record</option>
                            <option value="marriage">Marriage/Divorce</option>
                            <option value="birth_death">Birth/Death Certificate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject Name</label>
                        <input type="text" id="publicRecordSubjectName" name="publicRecordSubjectName" placeholder="e.g., John Doe" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Case/Reference ID</label>
                        <input type="text" id="publicRecordRefId" placeholder="e.g., Case #12345, Doc-XYZ">
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction/Location</label>
                        <input type="text" id="publicRecordJurisdiction" placeholder="e.g., New York, NY; Federal Court">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="publicRecordDate">
                    </div>
                    <div class="form-group">
                        <label>Summary/Key Details</label>
                        <textarea id="publicRecordSummary" rows="4" placeholder="Summary of record content and relevance"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source URL/Location</label>
                        <input type="url" id="publicRecordSourceUrl" placeholder="e.g., official website link">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="publicRecordDescription" rows="3" placeholder="General description of the public record and its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="publicRecordNotes" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group" id="entrySourceGroup" style="display: none;">
                    <label>Source (Where was this info collected?)</label>
                    <input type="text" id="entrySource" name="entrySource" placeholder="e.g., public record, social media, dark web forum">
                </div>

                <div id="customMetadataGroup" style="display: none;">
                    <label>Custom Metadata</label>
                    <div id="customMetadataEntries">
                        </div>
                    <button type="button" class="btn btn-secondary btn-sm add-metadata-btn" id="addMetadataBtn">
                        <i class="fas fa-plus"></i> Add Metadata Field
                    </button>
                </div>


                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelAddEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-edit"></i> Edit Entry</h3>
            <form id="editEntryForm">
                <input type="hidden" id="editEntryId">
                <input type="hidden" id="editEntryType">
    
                <div id="editToolFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="editToolName" name="editToolName" maxlength="50" placeholder="e.g., Maltego, Shodan, Recon-NG" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editToolUrl" name="editToolUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="editToolCategory" required>
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="editNewCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editToolDescription" rows="3" placeholder="Brief description of the tool."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editToolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editToolInvestigationNotes" rows="3" placeholder="Any specific notes or observations about this tool in your investigation."></textarea>
                    </div>
                    <div class="custom-tab-assignment" id="intelligenceVaultCategoriesAssignmentEditTool">
                        <h4>Add to Intelligence Vault Categories</h4>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">Select one or more intelligence categories for this tool.</p>
    
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div style="position: relative;">
                                <input type="text" id="editIntelligenceVaultCategorySearch" class="search-input" placeholder="Search categories..." style="padding-right: 40px;">
                                <i class="fas fa-search search-icon" style="right: 15px;"></i>
                            </div>
                        </div>
    
                        <div class="custom-tab-checkboxes-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                            <div class="custom-tab-checkboxes" id="intelligenceVaultCategoriesCheckboxesEditTool">
                            </div>
                        </div>
                    </div>
                </div>
    
                <div id="editEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="editEmailAddress" name="editEmailAddress" maxlength="60" required>
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="editEmailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="editEmailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editEmailDescription" rows="3" placeholder="Brief description of the email's context or significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editEmailNotes" rows="3" placeholder="Any specific notes or observations about this email."></textarea>
                    </div>
                </div>
    
                <div id="editPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="editPhoneNumber" maxlength="15" name="editPhoneNumber" placeholder="e.g., +1-234-567-8901" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editPhoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="editPhoneLocation" placeholder="e.g., City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPhoneDescription" rows="3" placeholder="Brief description of the phone number's context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPhoneNotes" rows="3" placeholder="Any specific notes or observations about this phone number."></textarea>
                    </div>
                </div>
    
                <div id="editCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="editCryptoAddress" name="editCryptoAddress" maxlength="120" placeholder="e.g., 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa" required>
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="editCryptoTxid" name="editCryptoTxid" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" name="editCryptoAmount" id="editCryptoAmount" placeholder="e.g., 0.005 BTC" required>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="editCryptoSource" placeholder="exchange, darkweb, personal" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editCryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editCryptoDescription" rows="3" placeholder="Brief description of the transaction or address's significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editCryptoNotes" rows="3" placeholder="Any specific notes or observations about this crypto entry."></textarea>
                    </div>
                </div>
    
                <div id="editLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="editLocationName" name="editLocationName" maxlength="50" placeholder="e.g., Target building, Suspect's residence" required>
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="editLocationCoordinates" name="editLocationCoordinates" placeholder="e.g., 34.0522, -118.2437" required>
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="editLocationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="editLocationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editLocationDescription" rows="3" placeholder="Brief description of the location's relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editLocationNotes" rows="3" placeholder="Any specific notes or observations about this location."></textarea>
                    </div>
                </div>
    
                <div id="editLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editLinkUrl" name="editLinkUrl" placeholder="e.g., https://twitter.com/suspectprofile" required>
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="editLinkPlatform" placeholder="twitter, reddit, pastebin, forum" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editLinkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editLinkDescription" rows="3" placeholder="Brief description of what the link contains or its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editLinkNotes" rows="3" placeholder="Any specific notes or observations about this link."></textarea>
                    </div>
                </div>
    
                <div id="editMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editMediaTitle" name="editMediaTitle" maxlength="50" placeholder="e.g., Suspect Photo, Video Evidence" required>
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="editMediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload New File (Optional)</label>
                        <input type="file" id="editMediaFile" accept="image/*,video/*">
                        <input type="hidden" id="editMediaBase64Data"> <small style="color: var(--text-muted);">Upload a new file to replace the existing one.</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editMediaDescription" rows="3" placeholder="Brief description of the media content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMediaNotes" rows="3" placeholder="Any specific notes or observations about this media file."></textarea>
                    </div>
                </div>
    
                <div id="editPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="editPasswordService" name="editPasswordService" placeholder="e.g., Facebook, Gmail, Database" required>
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="editPasswordUsername" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="editPasswordValue" placeholder="e.g., P@ssw0rd123!" maxlength="120" required>
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="editPasswordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPasswordDescription" rows="3" placeholder="Context or relevance of this password."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPasswordNotes" rows="3" placeholder="Any specific notes or observations about this password."></textarea>
                    </div>
                </div>
    
                <div id="editKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="editKeywordValue" name="editKeywordValue" placeholder="e.g., 'John Doe', 'Project X', 'Confidential'" required>
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="editKeywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editKeywordDescription" rows="3" placeholder="Elaborate on why this keyword is important."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editKeywordNotes" rows="3" placeholder="Any specific notes or observations about this keyword."></textarea>
                    </div>
                </div>
    
                <div id="editSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="editSocialPlatform" name="editSocialPlatform" placeholder="e.g., Twitter, Instagram, TikTok" required>
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="editSocialUrl" placeholder="e.g., https://twitter.com/suspectprofile" required>
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="editSocialUsername" placeholder="e.g., @suspectprofile" maxlength="60" required>
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="editSocialFollowCounts" maxlength="50" placeholder="e.g., 12k followers, 500 following">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editSocialDescription" rows="3" placeholder="Overview of the profile's content and activity."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editSocialNotes" rows="3" placeholder="Any specific notes or observations about this social profile."></textarea>
                    </div>
                </div>
    
                <div id="editDomainFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Domain/IP/URL</label>
                        <input type="text" id="editDomainValue" name="editDomainValue" placeholder="e.g., example.com, 192.168.1.1, https://suspicious-site.com" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editDomainType" required>
                            <option value="domain">Domain</option>
                            <option value="ip">IP Address</option>
                            <option value="url">URL</option>
                            <option value="subdomain">Subdomain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Registrar/ISP</label>
                        <input type="text" id="editDomainRegistrar" placeholder="e.g., GoDaddy, Cloudflare, Comcast">
                    </div>
                    <div class="form-group">
                        <label>Country/Location</label>
                        <input type="text" id="editDomainLocation" placeholder="e.g., United States, Russia">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editDomainStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspicious">Suspicious</option>
                            <option value="malicious">Malicious</option>
                            <option value="parked">Parked</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>WHOIS Info</label>
                        <textarea id="editDomainWhois" rows="3" placeholder="WHOIS registration details"></textarea>
                    </div>
                    <div class="form-group">
                        <label>DNS Records</label>
                        <textarea id="editDomainDns" rows="3" placeholder="A, MX, NS, TXT records"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editDomainTags" placeholder="phishing, c2, malware, suspicious">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDomainDescription" rows="3" placeholder="Brief description of the domain/IP/URL's relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editDomainNotes" rows="3" placeholder="Any specific notes or observations about this domain/IP/URL."></textarea>
                    </div>
                </div>
    
                <div id="editUsernameFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="editUsernameValue" name="editUsernameValue" placeholder="e.g., darkweb_trader, john_doe123" maxlength="50" required>
                    </div>
                    <div class="form-group">
                        <label>Platforms Found</label>
                        <textarea id="editUsernamePlatforms" rows="3" placeholder="List platforms where this username was found"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated Email(s)</label>
                        <input type="text" id="editUsernameEmails" placeholder="email1@domain.com, email2@domain.com">
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="editUsernameRealName" placeholder="e.g., John Doe" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="editUsernameActivity">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editUsernameDescription" rows="3" placeholder="Elaborate on the significance of this username."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editUsernameNotes" rows="3" placeholder="Any specific notes or observations about this username."></textarea>
                    </div>
                </div>
    
                <div id="editThreatFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Threat Type</label>
                        <select id="editThreatType" required>
                            <option value="malware">Malware</option>
                            <option value="apt">APT Group</option>
                            <option value="ioc">IOC (Indicator of Compromise)</option>
                            <option value="ttp">TTP (Tactics, Techniques, Procedures)</option>
                            <option value="campaign">Campaign</option>
                            <option value="actor">Threat Actor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Threat Name/ID</label>
                        <input type="text" id="editThreatName" name="editThreatName" placeholder="e.g., APT29, WannaCry, Emotet" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Severity Level</label>
                        <select id="editThreatSeverity">
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="info">Informational</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>IOCs (comma separated)</label>
                        <textarea id="editThreatIocs" rows="3" placeholder="IP addresses, domains, file hashes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Sectors</label>
                        <input type="text" id="editThreatTargets" placeholder="e.g., Government, Healthcare, Finance">
                    </div>
                    <div class="form-group">
                        <label>Attribution</label>
                        <input type="text" id="editThreatAttribution" placeholder="e.g., Nation-state, Criminal group, Unknown">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editThreatDescription" rows="4" placeholder="Detailed description of the threat."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="editThreatSource" placeholder="e.g., MISP, AlienVault OTX, Internal">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editThreatNotes" rows="3" placeholder="Any specific notes or observations about this threat intelligence."></textarea>
                    </div>
                </div>
    
                <div id="editVulnerabilityFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>CVE ID</label>
                        <input type="text" id="editVulnCve" name="editVulnCve" placeholder="e.g., CVE-2023-12345" maxlength="20" required>
                    </div>
                    <div class="form-group">
                        <label>CVSS Score</label>
                        <input type="number" step="0.1" min="0" max="10" id="editVulnCvss" placeholder="e.g., 9.8">
                    </div>
                    <div class="form-group">
                        <label>Affected Software</label>
                        <input type="text" id="editVulnSoftware" placeholder="e.g., Apache HTTP Server 2.4.x">
                    </div>
                    <div class="form-group">
                        <label>Vulnerability Type</label>
                        <select id="editVulnType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="sqli">SQL Injection</option>
                            <option value="xss">Cross-Site Scripting</option>
                            <option value="privilege">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="info">Information Disclosure</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Exploit Available</label>
                        <select id="editVulnExploit">
                            <option value="no">No</option>
                            <option value="poc">PoC Available</option>
                            <option value="public">Public Exploit</option>
                            <option value="weaponized">Weaponized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editVulnDescription" rows="4" placeholder="Detailed description of the vulnerability."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Mitigation</label>
                        <textarea id="editVulnMitigation" rows="3" placeholder="Patches, workarounds, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editVulnNotes" rows="3" placeholder="Any specific notes or observations about this vulnerability."></textarea>
                    </div>
                </div>
    
                <div id="editMalwareFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>File Name</label>
                        <input type="text" id="editMalwareFilename" name="editMalwareFilename" placeholder="e.g., suspicious.exe, document.pdf" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA1/SHA256)</label>
                        <input type="text" id="editMalwareHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <select id="editMalwareType">
                            <option value="executable">Executable (.exe, .dll)</option>
                            <option value="document">Document (.pdf, .doc, .xls)</option>
                            <option value="script">Script (.js, .vbs, .ps1)</option>
                            <option value="archive">Archive (.zip, .rar)</option>
                            <option value="image">Image (.jpg, .png)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Malware Family</label>
                        <input type="text" id="editMalwareFamily" placeholder="e.g., Emotet, TrickBot, Ransomware">
                    </div>
                    <div class="form-group">
                        <label>Detection Ratio</label>
                        <input type="text" id="editMalwareDetection" placeholder="e.g., 45/70 (VirusTotal)">
                    </div>
                    <div class="form-group">
                        <label>Behavior</label>
                        <textarea id="editMalwareBehavior" rows="4" placeholder="File behavior, network connections, registry changes, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="editMalwareSource" placeholder="e.g., Email attachment, Drive-by download">
                    </div>
                    <div class="form-group">
                        <label>Analysis Tools Used</label>
                        <input type="text" id="editMalwareTools" placeholder="e.g., VirusTotal, Hybrid Analysis, Cuckoo">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMalwareNotes" rows="3" placeholder="Any specific notes or observations about this malware."></textarea>
                    </div>
                </div>
    
                <div id="editBreachFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Company/Organization</label>
                        <input type="text" id="editBreachCompany" name="editBreachCompany" placeholder="e.g., Equifax, Target, LinkedIn" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Breach Date</label>
                        <input type="date" id="editBreachDate" required>
                    </div>
                    <div class="form-group">
                        <label>Records Affected</label>
                        <input type="number" id="editBreachRecords" placeholder="e.g., 147000000">
                    </div>
                    <div class="form-group">
                        <label>Data Types Compromised</label>
                        <textarea id="editBreachDataTypes" rows="3" placeholder="e.g., Names, SSNs, Credit card numbers, Passwords"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Attack Vector</label>
                        <select id="editBreachVector">
                            <option value="hacking">Hacking/Intrusion</option>
                            <option value="insider">Insider Threat</option>
                            <option value="physical">Physical</option>
                            <option value="malware">Malware</option>
                            <option value="social">Social Engineering</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editBreachStatus">
                            <option value="confirmed">Confirmed</option>
                            <option value="suspected">Suspected</option>
                            <option value="investigating">Under Investigation</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source/Reference</label>
                        <input type="url" id="editBreachSource" placeholder="News article, official statement, etc.">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editBreachDescription" rows="3" placeholder="Detailed description of the breach incident."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editBreachNotes" rows="3" placeholder="Any specific notes or observations about this data breach."></textarea>
                    </div>
                </div>
    
                <div id="editCredentialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Credential Type</label>
                        <select id="editCredentialType">
                            <option value="email_password">Email & Password</option>
                            <option value="username_password">Username & Password</option>
                            <option value="api_key">API Key</option>
                            <option value="ssh_key">SSH Key</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <textarea id="editCredentialValue" rows="3" placeholder="e.g., user@example.com:password123, username:password" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Service/Platform</label>
                        <input type="text" id="editCredentialService" placeholder="e.g., Company X Database, Internal System">
                    </div>
                    <div class="form-group">
                        <label>Breach/Source</label>
                        <input type="text" id="editCredentialBreachSource" placeholder="e.g., Pastebin, Dark Web Forum, Company Breach">
                    </div>
                    <div class="form-group">
                        <label>Date Found</label>
                        <input type="date" id="editCredentialDateFound">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editCredentialDescription" rows="3" placeholder="Context or relevance of this credential dump."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editCredentialNotes" rows="3" placeholder="Any specific notes or observations about this credential."></textarea>
                    </div>
                </div>
    
                <div id="editForumFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Forum/Market Name</label>
                        <input type="text" id="editForumName" name="editForumName" placeholder="e.g., BreachForums, Hydra Market" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editForumUrl" placeholder="e.g., http://xyz.onion/forum" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editForumType">
                            <option value="forum">Forum</option>
                            <option value="market">Marketplace</option>
                            <option value="carding">Carding Forum</option>
                            <option value="hacking">Hacking Forum</option>
                            <option value="ransomware">Ransomware Group</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editForumStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="down">Down/Seized</option>
                            <option value="scam">Scam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Primary Language</label>
                        <input type="text" id="editForumLanguage" placeholder="e.g., English, Russian">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editForumDescription" rows="3" placeholder="Brief description of the forum/market and its primary focus."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editForumNotes" rows="3" placeholder="Any specific notes or observations about this forum/market."></textarea>
                    </div>
                </div>
    
                <div id="editVendorFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Vendor Name/Alias</label>
                        <input type="text" id="editVendorAlias" name="editVendorAlias" placeholder="e.g., 'DarkWebSupply', 'CredsMaster'" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Associated Platforms</label>
                        <textarea id="editVendorPlatforms" rows="3" placeholder="e.g., Dark Web Market A, Telegram Channel B, Forum C"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Products/Services</label>
                        <input type="text" id="editVendorProducts" placeholder="e.g., Stolen Credentials, Malware, Drugs">
                    </div>
                    <div class="form-group">
                        <label>Reputation Score</label>
                        <input type="text" id="editVendorReputation" placeholder="e.g., 4.5/5, High Trust, Scammer">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editVendorDescription" rows="3" placeholder="Detailed description of the vendor's activities and offerings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editVendorNotes" rows="3" placeholder="Any specific notes or observations about this vendor."></textarea>
                    </div>
                </div>
    
                <div id="editPasteFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Paste URL</label>
                        <input type="url" id="editPasteUrl" name="editPasteUrl" placeholder="e.g., https://pastebin.com/xyz123" required>
                    </div>
                    <div class="form-group">
                        <label>Source Site</label>
                        <input type="text" id="editPasteSourceSite" placeholder="e.g., Pastebin, Pastie, Ghostbin">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="editPasteContentSummary" rows="3" placeholder="Brief summary of leaked data or text"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Keywords/Indicators</label>
                        <input type="text" id="editPasteKeywords" placeholder="e.g., email list, database dump, exploit code">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPasteDescription" rows="3" placeholder="Detailed description of the paste's content and its relevance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPasteNotes" rows="3" placeholder="Any specific notes or observations about this paste."></textarea>
                    </div>
                </div>
    
                <div id="editDocumentFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Document Title/Name</label>
                        <input type="text" id="editDocumentTitle" name="editDocumentTitle" placeholder="e.g., Project Proposal, Leaked Memo" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>File Type</label>
                        <input type="text" id="editDocumentFileType" placeholder="e.g., PDF, DOCX, XLSX, TXT">
                    </div>
                    <div class="form-group">
                        <label>File Hash (MD5/SHA256)</label>
                        <input type="text" id="editDocumentHash" placeholder="e.g., d41d8cd98f00b204e9800998ecf8427e">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="editDocumentContentSummary" rows="4" placeholder="Brief summary of document content, key findings"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source/Origin</label>
                        <input type="text" id="editDocumentSource" placeholder="e.g., Email attachment, Public server, Data breach">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDocumentDescription" rows="3" placeholder="Detailed description of the document's content and context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editDocumentNotes" rows="3" placeholder="Any specific notes or observations about this document."></textarea>
                    </div>
                </div>
    
                <div id="editNetworkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Analysis Subject</label>
                        <input type="text" id="editNetworkSubject" name="editNetworkSubject" placeholder="e.g., 'Target Network Scan', 'Suspect's IP Traffic'" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Type of Analysis</label>
                        <select id="editNetworkType">
                            <option value="scan">Port Scan</option>
                            <option value="traffic">Network Traffic Analysis</option>
                            <option value="dns">DNS Analysis</option>
                            <option value="whois">WHOIS Lookup</option>
                            <option value="fingerprint">Device Fingerprinting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Findings</label>
                        <textarea id="editNetworkFindings" rows="4" placeholder="Open ports, suspicious traffic, identified services, vulnerabilities"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Associated IPs/Domains</label>
                        <textarea id="editNetworkAssociated" rows="3" placeholder="Comma-separated list of IPs, domains, or URLs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="editNetworkTools" placeholder="e.g., Nmap, Wireshark, Shodan">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editNetworkDescription" rows="3" placeholder="Overall description of the network analysis conducted."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editNetworkNotes" rows="3" placeholder="Any specific notes or observations about this network analysis."></textarea>
                    </div>
                </div>
    
                <div id="editMetadataEntryFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Metadata Title/Context</label>
                        <input type="text" id="editMetadataTitle" placeholder="e.g., EXIF Data from Image, PDF Creation Info" required>
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">Use the 'Custom Metadata' section below to add key-value pairs for this entry.</p>
                    <div class="form-group">
                        <label>Metadata Description</label>
                        <textarea id="editMetadataDescription" rows="3" placeholder="A general description of the metadata collected or its context."></textarea>
                    </div>
                    <div class="form-group">
                        <label>File/Source</label>
                        <input type="text" id="editMetadataFileSource" placeholder="e.g., image.jpg, document.pdf, website header">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMetadataNotes" rows="3" placeholder="Any specific notes or observations about this metadata."></textarea>
                    </div>
                </div>
    
                <div id="editArchiveFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Original URL</label>
                        <input type="url" id="editArchiveOriginalUrl" name="editArchiveOriginalUrl" placeholder="e.g., https://example.com/old-page" required>
                    </div>
                    <div class="form-group">
                        <label>Archived URL/Link</label>
                        <input type="url" id="editArchiveUrl" name="editArchiveUrl" placeholder="e.g., https://web.archive.org/web/..." required>
                    </div>
                    <div class="form-group">
                        <label>Archiving Service</label>
                        <input type="text" id="editArchiveService" placeholder="e.g., Wayback Machine, Archive.is, Google Cache">
                    </div>
                    <div class="form-group">
                        <label>Timestamp</label>
                        <input type="datetime-local" id="editArchiveTimestamp">
                    </div>
                    <div class="form-group">
                        <label>Content Summary</label>
                        <textarea id="editArchiveContentSummary" rows="4" placeholder="Brief summary of the archived content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editArchiveDescription" rows="3" placeholder="Context or relevance of this archived page/content."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editArchiveNotes" rows="3" placeholder="Any specific notes or observations about this archived content."></textarea>
                    </div>
                </div>
    
                <div id="editMessagingFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Messaging App</label>
                        <select id="editMessagingApp" required>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="telegram">Telegram</textareareadonly>
                            <option value="signal">Signal</option>
                            <option value="discord">Discord</option>
                            <option value="irc">IRC</option>
                            <option value="matrix">Matrix</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Username/ID</label>
                        <input type="text" id="editMessagingUsername" name="editMessagingUsername" placeholder="e.g., @userhandle, +1234567890" required>
                    </div>
                    <div class="form-group">
                        <label>Channel/Group/Chat ID</label>
                        <input type="text" id="editMessagingChatId" placeholder="e.g., Group Name, Channel ID">
                    </div>
                    <div class="form-group">
                        <label>Relevant Content</label>
                        <textarea id="editMessagingContent" rows="4" placeholder="Summary of conversations, key messages, shared files"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editMessagingDescription" rows="3" placeholder="Context or relevance of this messaging app entry."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editMessagingNotes" rows="3" placeholder="Any specific notes or observations about this messaging app entry."></textarea>
                    </div>
                </div>
    
                <div id="editFacialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Subject/Person Identified</label>
                        <input type="text" id="editFacialSubject" name="editFacialSubject" placeholder="e.g., John Doe, Suspect 1" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Source Image/Video Description</label>
                        <textarea id="editFacialSourceDescription" rows="3" placeholder="Where was the image/video found?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Identified Profiles/Platforms</label>
                        <textarea id="editFacialIdentifiedProfiles" rows="3" placeholder="e.g., Facebook Profile URL, Instagram Username"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Confidence Score</label>
                        <input type="text" id="editFacialConfidence" placeholder="e.g., High, 85%">
                    </div>
                    <div class="form-group">
                        <label>Tools Used</label>
                        <input type="text" id="editFacialToolsUsed" placeholder="e.g., PimEyes, Google Images, Facial Recognition Software">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editFacialDescription" rows="3" placeholder="Overall description of the facial recognition finding."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editFacialNotes" rows="3" placeholder="Any specific notes or observations about this facial recognition entry."></textarea>
                    </div>
                </div>
    
                <div id="editPersonaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Persona Name/Alias</label>
                        <input type="text" id="editPersonaName" name="editPersonaName" placeholder="e.g., 'Online Gamer X', 'Business Account Y'" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Real Name (if known)</label>
                        <input type="text" id="editPersonaRealName" placeholder="e.g., John Doe" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Associated Usernames/Emails</label>
                        <textarea id="editPersonaAssociatedAccounts" rows="3" placeholder="List all linked usernames, emails, phone numbers"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bio/Description</label>
                        <textarea id="editPersonaBio" rows="4" placeholder="Profile bio or description of the persona."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Platforms Used</label>
                        <input type="text" id="editPersonaPlatforms" placeholder="e.g., Twitter, Discord, Dark Web Forums">
                    </div>
                    <div class="form-group">
                        <label>Origin/Purpose</label>
                        <input type="text" id="editPersonaOrigin" placeholder="e.g., Scammer, Investigator, Activist">
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPersonaNotes" rows="3" placeholder="Any specific notes or observations about this persona."></textarea>
                    </div>
                </div>
    
                <div id="editHoneypotFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Honeypot Type</label>
                        <select id="editHoneypotType" required>
                            <option value="low-interaction">Low Interaction</option>
                            <option value="high-interaction">High Interaction</option>
                            <option value="data">Data Honeypot</option>
                            <option value="network">Network Honeypot</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deployment Location/IP</label>
                        <input type="text" id="editHoneypotLocation" placeholder="e.g., Public Cloud, 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label>Purpose</label>
                        <input type="text" id="editHoneypotPurpose" placeholder="e.g., Malware Analysis, Threat Actor Tracking">
                    </div>
                    <div class="form-group">
                        <label>Captured Data Summary</label>
                        <textarea id="editHoneypotDataSummary" rows="4" placeholder="Summary of captured attacks, malware, IPs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Alerts/Indicators</label>
                        <textarea id="editHoneypotAlerts" rows="3" placeholder="Key indicators or alerts generated"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editHoneypotDescription" rows="3" placeholder="Detailed description of the honeypot setup and findings."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editHoneypotNotes" rows="3" placeholder="Any specific notes or observations about this honeypot."></textarea>
                    </div>
                </div>
    
                <div id="editExploitFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Exploit Name/ID</label>
                        <input type="text" id="editExploitName" name="editExploitName" placeholder="e.g., EternalBlue, CVE-2023-XXXX" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Target Vulnerability</label>
                        <input type="text" id="editExploitTargetVuln" placeholder="e.g., MS17-010, Adobe Flash Zero-Day">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editExploitType">
                            <option value="rce">Remote Code Execution</option>
                            <option value="privesc">Privilege Escalation</option>
                            <option value="dos">Denial of Service</option>
                            <option value="zero-day">Zero-Day</option>
                            <option value="poc">PoC</option>
                            <option value="weaponized">Weaponized</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Market/Source</label>
                        <input type="text" id="editExploitMarketSource" placeholder="e.g., Exploit-DB, Underground Market, Private Sale">
                    </div>
                    <div class="form-group">
                        <label>Price/Value</label>
                        <input type="text" id="editExploitPrice" placeholder="e.g., $10,000, 2 BTC">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editExploitDescription" rows="3" placeholder="Technical description of the exploit and its capabilities."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editExploitNotes" rows="3" placeholder="Any specific notes or observations about this exploit."></textarea>
                    </div>
                </div>
    
                <div id="editPublicRecordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Record Type</label>
                        <select id="editPublicRecordType" required>
                            <option value="court">Court Record</option>
                            <option value="property">Property Record</option>
                            <option value="business">Business Registration</option>
                            <option value="voter">Voter Registration</option>
                            <option value="license">License/Permit</option>
                            <option value="tax">Tax Record</option>
                            <option value="marriage">Marriage/Divorce</option>
                            <option value="birth_death">Birth/Death Certificate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject Name</label>
                        <input type="text" id="editPublicRecordSubjectName" name="editPublicRecordSubjectName" placeholder="e.g., John Doe" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>Case/Reference ID</label>
                        <input type="text" id="editPublicRecordRefId" placeholder="e.g., Case #12345, Doc-XYZ">
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction/Location</label>
                        <input type="text" id="editPublicRecordJurisdiction" placeholder="e.g., New York, NY; Federal Court">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="editPublicRecordDate">
                    </div>
                    <div class="form-group">
                        <label>Summary/Key Details</label>
                        <textarea id="editPublicRecordSummary" rows="4" placeholder="Summary of record content and relevance"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source URL/Location</label>
                        <input type="url" id="editPublicRecordSourceUrl" placeholder="e.g., official website link">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editPublicRecordDescription" rows="3" placeholder="General description of the public record and its significance."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Investigation Notes</label>
                        <textarea id="editPublicRecordNotes" rows="3" placeholder="Any specific notes or observations about this public record."></textarea>
                    </div>
                </div>
    
                <div class="form-group" id="editEntrySourceGroup">
                    <label>Source (Where was this info collected?)</label>
                    <input type="text" id="editEntrySource" name="editEntrySource" placeholder="e.g., public record, social media, dark web forum">
                </div>
    
                <div id="editCustomMetadataGroup">
                    <label>Custom Metadata</label>
                    <div id="editCustomMetadataEntries">
                        </div>
                    <button type="button" class="btn btn-secondary btn-sm add-metadata-btn" id="editAddMetadataBtn">
                        <i class="fas fa-plus"></i> Add Metadata Field
                    </button>
                </div>
    
                <div class="custom-tab-assignment" id="assignCustomTabs">
                    <h4>Assign to Custom Vault Tab(s)</h4>
                    <div class="custom-tab-checkboxes" id="assignCustomTabsCheckboxes">
                    </div>
                </div>
    
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-plus-circle"></i>
                Create New Custom Vault
            </h3>
            <form id="createSubTabForm">
                <div class="form-group">
                    <label>Vault Name</label>
                    <input type="text" id="newSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="newSubTabIcon" placeholder="fas fa-globe">
                    <div class="icon-picker-grid" id="newSubTabIconPicker"></div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="newSubTabColor">
                    <div class="color-picker-grid" id="newSubTabColorPicker"></div>
                </div>
                <div class="form-group">
                    <label>Add Tools to this Vault</label>
                    <div id="newCustomVaultToolSelection" class="custom-tab-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                        </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelCreateSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Vault</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-edit"></i>
                Edit Custom Vault
            </h3>
            <form id="editSubTabForm">
                <input type="hidden" id="editSubTabId">
                <div class="form-group">
                    <label>Vault Name</label>
                    <input type="text" id="editedSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="editedSubTabIcon" placeholder="fas fa-globe">
                     <div class="icon-picker-grid" id="editedSubTabIconPicker"></div>
                </div>
                 <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="editedSubTabColor">
                    <div class="color-picker-grid" id="editedSubTabColorPicker"></div>
                </div>
                <div class="form-group">
                    <label>Tools in this Vault</label>
                    <div id="editCustomVaultToolSelection" class="custom-tab-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; background: var(--bg-secondary);">
                        </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="shareOptionsModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-share-alt"></i> Share Intelligence
            </h3>
            <form id="shareForm">
                <div class="form-group">
                    <label>What would you like to share?</label>
                    <select id="shareScopeSelect">
                        <option value="currentTab">Current Tab (Read-Only View)</option>
                        <option value="allVault">All Intelligence Vault (Read-Only View)</option>
                        <option value="allData">All Data (Read-Only View)</option>
                        <option value="specificCustomTab" style="display:none;">Specific Custom Tab...</option>
                        </select>
                </div>

                <div id="specificCustomTabSelector" class="form-group" style="display:none;">
                    <label>Select a Custom Tab to share:</label>
                    <select id="selectCustomTabForSharing">
                        </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelShareOptions">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Link</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        let appState = {
            tools: [],
            emails: [],
            phones: [],
            crypto: [],
            locations: [],
            links: [],
            media: [],
            passwords: [],
            keywords: [],
            socials: [],
            domains: [], // Added
            usernames: [], // Added
            threats: [], // Added
            vulnerabilities: [], // Added
            malware: [], // Added
            breaches: [], // Added
            credentials: [], // Added
            forums: [], // Added
            vendors: [], // Added
            telegramChannels: [], // Renamed for consistency
            pastes: [], // Added
            documents: [], // Added
            networks: [], // Added
            metadataEntries: [], // Renamed to avoid conflict with generic 'metadata' property on entries
            archives: [], // Added
            messagingApps: [], // Renamed for consistency
            datingProfiles: [], // Renamed for consistency
            audioEntries: [], // Added (assuming you store audio files here)
            facialRecognition: [], // Renamed for consistency
            personas: [], // Renamed for consistency
            vpns: [], // Renamed for consistency
            honeypots: [], // Added
            exploits: [], // Added
            publicRecords: [], // Added
            selectedEntries: new Set(),
            currentTab: 'intelligence-vault',
            currentIntelligenceVaultParentTab: 'generalAndCore', // Ensure this is a valid default ID from intelligenceVaultTabStructure
            currentIntelligenceVaultChildTab: 'tools', // Ensure this is a valid default ID from intelligenceVaultTabStructure
            currentCustomVaultEntrySubTab: 'tool', // Changed to singular 'tool' for custom vault entry types
            currentCustomVaultParentTab: 'coreInvestigation', // Updated to singular if that's the ID
            customTabs: [],
            filters: {
                category: '',
                search: '',
                sort: 'name',
                searchScope: 'currentTab'
            },
            theme: localStorage.getItem('theme') || 'dark',
            viewMode: localStorage.getItem('viewMode') || 'grid',
            usageStats: {
                toolsUsedToday: 0
            },
            osintTips: [
                "Always use a VPN for anonymity during investigations.",
                "Verify your sources: Cross-reference information from multiple independent channels.",
                "Analyze metadata: Hidden data in images and documents can reveal crucial clues.",
                "Utilize archived web pages with tools like the Wayback Machine.",
                "Be mindful of your digital footprint; everything you do online leaves a trace.",
                "Learn advanced search operators for targeted information retrieval.",
                "Understand your target's OPSEC (Operational Security) to anticipate their moves.",
                "Never compromise your own security for an investigation. Think OPSEC first."
            ],
            readOnlyMode: false,
            sharedTabId: null,
            sharedEntryIds: []
        };

        const availableIcons = [
            'fas fa-globe', 'fas fa-search', 'fas fa-fingerprint', 'fas fa-shield-alt',
            'fas fa-link', 'fas fa-network-wired', 'fas fa-envelope', 'fas fa-image',
            'fas fa-map-marker-alt', 'fas fa-book', 'fas fa-coins', 'fas fa-users',
            'fas fa-camera', 'fas fa-lock', 'fas fa-key', 'fas fa-bug', 'fas fa-cloud',
            'fas fa-mobile-alt', 'fas fa-server', 'fas fa-database', 'fas fa-code',
            'fas fa-chart-line', 'fas fa-user-secret', 'fas fa-lightbulb', 'fas fa-laptop-code',
            'fas fa-phone', 'fas fa-money-bill-wave', 'fas fa-video', 'fas fa-paste', 'fas fa-location-arrow',
            'fas fa-font' // For keywords
        ];

        const availableColors = [
            'var(--tab-color-default)', 'var(--tab-color-red)', 'var(--tab-color-blue)',
            'var(--tab-color-green)', 'var(--tab-color-yellow)', 'var(--tab-color-purple)',
            'var(--tab-color-orange)'
        ];

        const defaultTools = [
            {
                id: 'google-advanced-search',
                type: 'tool',
                name: 'Google Advanced Search',
                url: 'https://www.google.com/advanced_search',
                category: 'search engines',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Advanced search operators and techniques for comprehensive information gathering',
                tags: ['search', 'google', 'operators'],
                starred: false,
                pinned: false,
                favicon: 'https://www.google.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-01-15T10:00:00Z'),
                customTabs: [], // Initialize customTabs array
                origin: 'pre-added'
            },
            {
                id: 'shodan',
                type: 'tool',
                name: 'Shodan',
                url: 'https://www.shodan.io',
                category: 'network analysis',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Search engine for Internet-connected devices and systems',
                tags: ['iot', 'network', 'scanning', 'security'],
                starred: true,
                pinned: false,
                favicon: 'https://www.shodan.io/static/img/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-02-20T11:30:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'maltego',
                type: 'tool',
                name: 'Maltego',
                url: 'https://www.maltego.com',
                category: 'network analysis',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Link analysis and data mining application for gathering and connecting information',
                tags: ['analysis', 'visualization', 'mapping'],
                starred: false,
                pinned: true,
                favicon: 'https://www.maltego.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-03-01T14:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'have-i-been-pwned',
                type: 'tool',
                name: 'Have I Been Pwned',
                url: 'https://haveibeenpwned.com',
                category: 'email investigation',
                intelligenceVaultCategories: ['emailTools'], // Assign to 'Email Tools'
                description: 'Check if email addresses have been compromised in data breaches',
                tags: ['breach', 'email', 'security', 'compromise'],
                starred: true,
                pinned: false,
                favicon: 'https://haveibeenpwned.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-04-10T09:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'virustotal',
                type: 'tool',
                name: 'VirusTotal',
                url: 'https://www.virustotal.com',
                category: 'threat intelligence',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Analyze suspicious files and URLs to detect types of malware',
                tags: ['malware', 'analysis', 'threat', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.virustotal.com/gui/images/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-05-05T16:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'wayback-machine',
                type: 'tool',
                name: 'Wayback Machine',
                url: 'https://web.archive.org',
                category: 'archive',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Browse historical snapshots of websites',
                tags: ['archive', 'history', 'web', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://web.archive.org/static/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-06-01T08:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'whois-lookup',
                type: 'tool',
                name: 'WHOIS Lookup',
                url: 'https://whois.net',
                category: 'domain research',
                intelligenceVaultCategories: ['tools'], // Assign to 'General Tools'
                description: 'Domain registration and ownership information',
                tags: ['domain', 'registration', 'ownership'],
                starred: false,
                pinned: false,
                favicon: 'https://whois.net/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-07-12T13:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'tineye',
                type: 'tool',
                name: 'TinEye',
                url: 'https://tineye.com',
                category: 'image analysis',
                intelligenceVaultCategories: ['mediaTools'], // Assign to 'Media Tools'
                description: 'Reverse image search engine',
                tags: ['image', 'reverse', 'search', 'verification'],
                starred: false,
                pinned: false,
                favicon: 'https://tineye.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-08-20T10:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },{
                id: 'tor-browser',
                type: 'tool',
                name: 'Tor Browser',
                url: 'https://www.torproject.org/',
                category: 'anonymity',
                intelligenceVaultCategories: ['darkWebTools'], // Assign to 'DarkWeb'
                description: 'Free and open-source software for enabling anonymous communication.',
                tags: ['anonymity', 'privacy', 'darkweb', 'browser'],
                starred: false,
                pinned: false,
                favicon: 'https://www.torproject.org/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-01T08:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'nmap',
                type: 'tool',
                name: 'Nmap (Network Mapper)',
                url: 'https://nmap.org/',
                category: 'network scanning',
                intelligenceVaultCategories: ['vulnerabilityTools'], // Assign to 'Vulnerability'
                description: 'Free and open-source utility for network discovery and security auditing.',
                tags: ['network', 'scanning', 'vulnerability', 'auditing'],
                starred: false,
                pinned: false,
                favicon: 'https://nmap.org/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-05T10:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'any-run',
                type: 'tool',
                name: 'Any.Run',
                url: 'https://any.run/',
                category: 'malware analysis',
                intelligenceVaultCategories: ['fileMalwareTools'], // Assign to 'File/Malware'
                description: 'Interactive malware analysis service for dynamic investigation of threats.',
                tags: ['malware', 'analysis', 'sandbox', 'threats'],
                starred: false,
                pinned: false,
                favicon: 'https://any.run/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-10T12:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'splunk-phantom',
                type: 'tool',
                name: 'Splunk SOAR (Phantom)',
                url: 'https://www.splunk.com/en_us/software/security-orchestration-automation-response-phantom.html',
                category: 'security orchestration',
                intelligenceVaultCategories: ['threatIntelligenceTools'], // Assign to 'Threat Intelligence'
                description: 'Security Orchestration, Automation, and Response platform.',
                tags: ['soar', 'automation', 'threat-intel', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.splunk.com/etc/designs/splunk-website/clientlibs-all/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-15T14:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            },
            {
                id: 'openai-chatgpt',
                type: 'tool',
                name: 'OpenAI ChatGPT',
                url: 'https://chat.openai.com/',
                category: 'ai assistant',
                intelligenceVaultCategories: ['aiTools'], // Assign to 'AI'
                description: 'AI-powered chatbot for various tasks including data summarization and idea generation.',
                tags: ['ai', 'chatbot', 'generative-ai', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://chat.openai.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2024-01-20T16:00:00Z'),
                customTabs: [],
                origin: 'pre-added'
            }
        ];

        const intelligenceVaultTabStructure = [
        {
            id: 'generalAndCore',
            name: 'General',
            icon: 'fas fa-globe-americas',
            children: [
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
                { id: 'aiTools', name: 'AI & Generative', icon: 'fas fa-brain' },
                { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' }, // NEW
                { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' }, // NEW
            ]
        },
        {
            id: 'identityAndSocial',
            name: 'Identity/Social',
            icon: 'fas fa-users',
            children: [
                { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
                { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' }, // NEW
                { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' }, // NEW
            ]
        },
        {
            id: 'technicalFootprints',
            name: 'Footprints',
            icon: 'fas fa-fingerprint',
            children: [
                { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' }, // Name adjusted for clarity
                { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' }, // Name adjusted
                { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' }, // Name adjusted
                { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' }, // NEW
                { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' }, // NEW
            ]
        },
        {
            id: 'cybersecurityIntel',
            name: 'Threat Intel',
            icon: 'fas fa-shield-alt',
            children: [
                { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' }, // NEW (Font Awesome 6)
                { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' }, // NEW
            ]
        },
        {
            id: 'breachAndLeaks',
            name: 'Breach/Leaks',
            icon: 'fas fa-database',
            children: [
                { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' }, // Renamed from passwordTools
                { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' }, // Renamed from Dump Search Engines
                { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' }, // NEW (Font Awesome 6)
            ]
        },
        {
            id: 'undergroundSources',
            name: 'Forums/Markets',
            icon: 'fas fa-user-ninja',
            children: [
                { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' }, // Name adjusted
                { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
                { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' }, // NEW (Font Awesome Brands)
                { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' }, // NEW
            ]
        },
        // NEW PARENT CATEGORY: Media Analysis
        {
            id: 'mediaAnalysis',
            name: 'Media',
            icon: 'fas fa-image',
            children: [
                { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' }, // Moved from Identity & Social
                { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' }, // NEW
                { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' }, // NEW
                { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' }, // NEW (Font Awesome 6)
                { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' }, // NEW
            ]
        },
        // NEW PARENT CATEGORY: Operational Security (OPSEC)
        {
            id: 'opsec',
            name: 'OpSec',
            icon: 'fas fa-lock',
            children: [
                { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' }, // Broadening DarkWebTools concept
                { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' }, // NEW
                { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' }, // NEW
                { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' }, // NEW
            ]
        },
        ];

        const customVaultEntryStructure = [{
            id: 'coreInvestigation',
            name: 'General',
            icon: 'fas fa-globe-americas',
            children: [
                { id: 'tool', name: 'General Tools', icon: 'fas fa-tools' }, // Matches entry.type 'tool'
                { id: 'keyword', name: 'Keyword & Text Analysis', icon: 'fas fa-font' }, // Matches entry.type 'keyword'
                // Assuming 'ai', 'osintSearch', 'archive' refer to tool types if you have forms for them.
                { id: 'ai', name: 'AI & Generative', icon: 'fas fa-brain' }, // Placeholder, needs actual entry.type if not 'tool'
                { id: 'osintSearch', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' }, // Placeholder
                { id: 'archive', name: 'Archiving & Cache', icon: 'fas fa-archive' }, // Matches entry.type 'archive'
            ]
        }, {
            id: 'identityCommunication',
            name: 'Identity/Social',
            icon: 'fas fa-users',
            children: [
                // Ensure these IDs match the 'type' property of your entries
                { id: 'username', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'social', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'email', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phone', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messaging', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
                { id: 'dating', name: 'Dating Apps', icon: 'fas fa-heart' },
                { id: 'persona', name: 'Persona Management', icon: 'fas fa-id-badge' },
                { id: 'facial', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
            ]
        }, {
            id: 'digitalTrace',
            name: 'Footprints',
            icon: 'fas fa-fingerprint',
            children: [
                { id: 'domain', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
                { id: 'location', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'crypto', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
                // 'darkWeb' might be a category, not a specific entry type, consider if this should be a tool type or a general grouping
                { id: 'darkWeb', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' }, // Placeholder if not a direct entry.type
                { id: 'metadata', name: 'Metadata Extractors', icon: 'fas fa-info' }, // Matches entry.type 'metadata'
                { id: 'network', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
                { id: 'document', name: 'Document Analysis', icon: 'fas fa-file-alt' },
                { id: 'link', name: 'General Links', icon: 'fas fa-external-link-alt' },
            ]
        }, {
            id: 'cyberIntel',
            name: 'Threat Intel',
            icon: 'fas fa-shield-alt',
            children: [
                { id: 'threat', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerability', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'malware', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypot', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
                { id: 'exploit', name: 'Exploit/Market', icon: 'fas fa-bomb' },
            ]
        }, {
            id: 'breachAndLeak',
            name: 'Breach/Leaks',
            icon: 'fas fa-database',
            children: [
                { id: 'password', name: 'Password Leaks', icon: 'fas fa-key' },
                { id: 'credential', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'breach', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'publicrecord', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },
            ]
        }, {
            id: 'undergroundSource',
            name: 'Forums/Markets',
            icon: 'fas fa-user-ninja',
            children: [
                { id: 'forum', name: 'Hacking & Security Forums', icon: 'fas fa-comments' },
                { id: 'vendor', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegram', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
                { id: 'paste', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },
            ]
        }, {
            id: 'mediaAnalysis',
            name: 'Media',
            icon: 'fas fa-image',
            children: [
                { id: 'media', name: 'Image & Video Analysis', icon: 'fas fa-camera' }, // This ID is already 'media' in entry.type
                { id: 'audio', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
            ]
        }, {
            id: 'opsecurity',
            name: 'OpSec',
            icon: 'fas fa-lock',
            children: [
                { id: 'vpn', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
                // Placeholder for 'secureComm' and 'personaManage' if they don't map to existing entry.types
                { id: 'secureComm', name: 'Secure Communication', icon: 'fas fa-lock-open' },
                { id: 'persona', name: 'Persona Management', icon: 'fas fa-id-badge' }, // Matches entry.type 'persona'
            ]
        }, ];



        let notesState = {
            notes: [],
            currentNote: null,
            editMode: false,
            // NEW: Add sort filter for notes
            noteSortFilter: localStorage.getItem('noteSortFilter') || 'updated_desc'
        };

        // OSINT Handbook main functionality
        const handbookData = {
        sections: [
            {
            id: "getting-started",
            title: "Getting Started",
            icon: "fas fa-rocket",
            content: `
                <h2>Getting Started with OSINT</h2>
                <p>Open Source Intelligence (OSINT) is the collection and analysis of information from publicly available sources. This handbook will guide you through essential techniques, tools, and methodologies.</p>
                
                <h3>Basic Principles</h3>
                <p>Remember these fundamental principles when conducting OSINT investigations:</p>
                <ul>
                <li>Use secure, anonymous connections (VPNs, Tor)</li>
                <li>Create separate research personas</li>
                <li>Document everything</li>
                <li>Verify information through multiple sources</li>
                <li>Follow legal and ethical guidelines</li>
                </ul>
            `,
            },
            {
            id: "osint-framework",
            title: "OSINT Framework Overview",
            icon: "fas fa-sitemap",
            content: `
                <h2>OSINT Framework Overview</h2>
                <p>The OSINT Framework provides a structured approach to gathering intelligence across various domains.</p>
                
                <h3>Key Components</h3>
                <ul>
                <li><strong>Reconnaissance</strong>: Initial information gathering</li>
                <li><strong>Identification</strong>: Pinpointing relevant data sources</li>
                <li><strong>Collection</strong>: Systematic gathering of intelligence</li>
                <li><strong>Processing</strong>: Organizing and filtering collected data</li>
                <li><strong>Analysis</strong>: Deriving insights and connections</li>
                <li><strong>Reporting</strong>: Documenting findings in a structured format</li>
                </ul>
                
                <h3>OSINT Cycle</h3>
                <p>The OSINT process is cyclical, with each phase informing the next. As new information is discovered, you may need to revisit earlier phases to refine your search parameters.</p>
                
                <div class="code-block">
                <pre><code>Planning  Collection  Processing  Analysis  Dissemination  Feedback  Planning</code></pre>
                <button class="copy-btn" data-clipboard-target="#osint-cycle-code"><i class="fas fa-copy"></i></button>
                </div>
            `,
            },
            {
            id: "tools-category",
            title: "Tools by Category",
            icon: "fas fa-tools",
            isCategory: true,
            subcategories: [
                {
                id: "people-search",
                title: "People Search",
                icon: "fas fa-user-secret",
                content: `
                    <h2>People Search Tools</h2>
                    <p>These tools help locate and gather information about individuals through public records, social media, and other sources.</p>
                    
                    <h3>Essential Tools</h3>
                    <ul>
                    <li><strong>Pipl</strong>: Comprehensive people search engine</li>
                    <li><strong>BeenVerified</strong>: Background check service</li>
                    <li><strong>Spokeo</strong>: People search and public records</li>
                    <li><strong>PeekYou</strong>: Searches across social networks</li>
                    <li><strong>WebMii</strong>: Person-centric web search</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Validate a phone number pattern */
        const validatePhone = (phone) => {
        const regex = /^(\+\d{1,2}\s)?\(?\d{3}\)?[\s.-]\d{3}[\s.-]\d{4}$/;
        return regex.test(phone);
        }</code></pre>
                    <button class="copy-btn" data-clipboard-target="#phone-validate-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">people</span>
                    <span class="tag">social</span>
                    <span class="tag">identity</span>
                    <span class="tag">background</span>
                    </div>
                `,
                },
                {
                id: "domain-whois",
                title: "Domain/WHOIS",
                icon: "fas fa-globe",
                content: `
                    <h2>Domain & WHOIS Investigation Tools</h2>
                    <p>These tools allow investigators to gather information about domain registrations, ownership, and infrastructure.</p>
                    
                    <h3>Key Tools</h3>
                    <ul>
                    <li><strong>WHOIS Lookup</strong>: Domain registration information</li>
                    <li><strong>DomainTools</strong>: Domain profile and history</li>
                    <li><strong>ViewDNS.info</strong>: Multiple DNS research tools</li>
                    <li><strong>Shodan</strong>: Internet-connected device search engine</li>
                    <li><strong>SecurityTrails</strong>: Historical DNS data</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Basic WHOIS lookup using command line */
        whois example.com

        /* Reverse IP lookup using host command */
        host example.com</code></pre>
                    <button class="copy-btn" data-clipboard-target="#whois-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">domain</span>
                    <span class="tag">dns</span>
                    <span class="tag">hosting</span>
                    <span class="tag">infrastructure</span>
                    </div>
                `,
                },
                {
                id: "crypto-tracking",
                title: "Crypto Tracking",
                icon: "fas fa-coins",
                content: `
                    <h2>Cryptocurrency Tracking Tools</h2>
                    <p>These tools help track and analyze cryptocurrency transactions, wallets, and entities across various blockchains.</p>
                    
                    <h3>Essential Tools</h3>
                    <ul>
                    <li><strong>Blockchain.com Explorer</strong>: Bitcoin blockchain analysis</li>
                    <li><strong>Etherscan</strong>: Ethereum blockchain explorer</li>
                    <li><strong>Chainalysis</strong>: Advanced cryptocurrency investigation</li>
                    <li><strong>CipherTrace</strong>: Financial crime tracking in crypto</li>
                    <li><strong>Crystal Blockchain</strong>: Crypto AML and analytics</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* Example API call to get Bitcoin address information */
        curl -X GET "https://blockchain.info/rawaddr/1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"</code></pre>
                    <button class="copy-btn" data-clipboard-target="#crypto-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">crypto</span>
                    <span class="tag">blockchain</span>
                    <span class="tag">bitcoin</span>
                    <span class="tag">ethereum</span>
                    </div>
                `,
                }
            ]
            },
            {
            id: "techniques",
            title: "Techniques",
            icon: "fas fa-lightbulb",
            isCategory: true,
            subcategories: [
                {
                id: "pivoting",
                title: "Pivoting",
                icon: "fas fa-network-wired",
                content: `
                    <h2>Pivoting Techniques</h2>
                    <p>Pivoting is the process of using discovered information to find new leads and expand your investigation.</p>
                    
                    <h3>Key Pivoting Methods</h3>
                    <ul>
                    <li><strong>Email Pivoting</strong>: Use email addresses to discover accounts across platforms</li>
                    <li><strong>Username Pivoting</strong>: Track usernames across multiple services</li>
                    <li><strong>Image Pivoting</strong>: Use reverse image search to find related content</li>
                    <li><strong>Network Pivoting</strong>: Map connections between people and organizations</li>
                    <li><strong>Domain Pivoting</strong>: Find related websites and infrastructure</li>
                    </ul>
                    
                    <h3>Practical Example</h3>
                    <p>Starting with an email address, you might:</p>
                    <ol>
                    <li>Check email breach databases for password history</li>
                    <li>Search for the email in document metadata</li>
                    <li>Use the username portion to search social platforms</li>
                    <li>Look up the domain for related websites</li>
                    <li>Search for the email in forum posts and comments</li>
                    </ol>
                    
                    <div class="tag-section">
                    <span class="tag">pivoting</span>
                    <span class="tag">methodology</span>
                    <span class="tag">investigation</span>
                    </div>
                `,
                },
                {
                id: "sock-puppets",
                title: "Sock Puppet Accounts",
                icon: "fas fa-user-secret",
                content: `
                    <h2>Sock Puppet Accounts</h2>
                    <p>Sock puppets are alternate online identities created for research purposes to protect your real identity during investigations.</p>
                    
                    <h3>Creation Guidelines</h3>
                    <ul>
                    <li>Use a dedicated device or VM if possible</li>
                    <li>Always access through VPN/Tor</li>
                    <li>Create a complete, consistent backstory</li>
                    <li>Use generated photos for profiles (never your own)</li>
                    <li>Maintain regular activity to build history</li>
                    <li>Never connect to personal accounts or information</li>
                    </ul>
                    
                    <div class="code-block">
                    <pre><code>/* OPSEC checklist for sock puppets */
        1. Separate email account
        2. Unique username not used elsewhere
        3. Unique password not used elsewhere
        4. 2FA on a dedicated device
        5. Consistent profile details
        6. Regular login patterns
        7. No personal information leakage</code></pre>
                    <button class="copy-btn" data-clipboard-target="#sockpuppet-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">identity</span>
                    <span class="tag">opsec</span>
                    <span class="tag">anonymity</span>
                    </div>
                `,
                }
            ]
            },
            {
            id: "cheat-sheets",
            title: "Cheat Sheets",
            icon: "fas fa-file-alt",
            isCategory: true,
            subcategories: [
                {
                id: "command-line",
                title: "Command Line Tools",
                icon: "fas fa-terminal",
                content: `
                    <h2>Command Line OSINT Tools</h2>
                    <p>These command-line tools can significantly enhance your OSINT capabilities and automation.</p>
                    
                    <h3>Essential CLI Tools</h3>
                    <div class="code-block">
                    <pre><code># Recon-ng - Full-featured reconnaissance framework
        pip install recon-ng

        # TheHarvester - Email, subdomain and name harvester
        theHarvester -d example.com -b google,linkedin

        # Sherlock - Hunt down social media accounts by username
        python3 sherlock username

        # Amass - In-depth DNS enumeration
        amass enum -d example.com

        # Shodan CLI - Internet device search
        shodan search --fields ip_str,port,org,hostnames apache</code></pre>
                    <button class="copy-btn" data-clipboard-target="#cli-tools-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <h3>Quick Reference: Google Dorks</h3>
                    <div class="code-block">
                    <pre><code># Find specific file types
        filetype:pdf "confidential"

        # Search within a site
        site:example.com password

        # Find exposed directories
        intitle:"index of" "parent directory"

        # Find exposed cameras
        intitle:"webcamXP 5"

        # Find exposed databases
        intitle:"Index of" phpmyadmin</code></pre>
                    <button class="copy-btn" data-clipboard-target="#google-dorks-code"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <div class="tag-section">
                    <span class="tag">cli</span>
                    <span class="tag">terminal</span>
                    <span class="tag">automation</span>
                    <span class="tag">dorks</span>
                    </div>
                `,
                }
            ]
            }
        ]
        };

        // Initialize Application
        function initApp() {
            loadState();
            parseShareableLink();
            updateStats();
            // Bind events BEFORE calling switchTab to ensure listeners are ready
            bindEvents(); 
            initTheme();

            checkAndShowDesktopRecommendation();

            const validTabs = ['intelligence-vault', 'custom-tabs', 'analytics', 'threats', 'handbook'];
            if (!validTabs.includes(appState.currentTab)) {
                appState.currentTab = 'intelligence-vault'; // Default to intelligence-vault if invalid
            }

            // Call switchTab to set up the initial active tab and its content
            switchTab(appState.currentTab);

            // Re-render all necessary parts that depend on the initial state
            showRandomDiscovery();
            populateCategoryFilter();
            updateAnalytics(); // Ensure analytics are up to date
            applyReadOnlyMode(); // Apply read-only mode if shared link is active

            // Update view toggle buttons based on saved view mode
            const viewToggleButtons = document.querySelectorAll('#viewToggle, #vaultViewToggle, #customVaultViewToggle');
            viewToggleButtons.forEach(btn => {
                if (appState.viewMode === 'grid') {
                    btn.innerHTML = '<i class="fas fa-list"></i> List View';
                    btn.title = 'Switch to List View';
                } else {
                    btn.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    btn.title = 'Switch to Grid View';
                }
            });
        }

        // Switch main tabs
        function switchTab(tabName) {
            // Update main tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                 targetTabContent.classList.add('active');
            }

            // Update appState and clear filters for new tab
            appState.currentTab = tabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = '';
            document.getElementById('searchInput').value = '';

            // Hide all potential sub-tab containers and add entry buttons by default
            document.getElementById('intelligenceVaultParentTabs').style.display = 'none';
            document.getElementById('intelligenceVaultChildTabs').style.display = 'none';
            document.getElementById('customVaultEntryParentTabs').style.display = 'none';
            document.getElementById('customVaultEntryChildTabs').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none'; // Ensure this is handled too

            // Specific logic for each main tab
            if (tabName === 'intelligence-vault') {
                document.getElementById('intelligenceVaultParentTabs').style.display = 'flex'; // Show parent tabs
                renderIntelligenceVaultParentTabs(); // Render intelligence vault parent tabs

                // Ensure a valid parent is selected, default if current one is invalid
                const currentIntelParent = intelligenceVaultTabStructure.find(p => p.id === appState.currentIntelligenceVaultParentTab);
                if (!currentIntelParent) {
                    appState.currentIntelligenceVaultParentTab = intelligenceVaultTabStructure[0].id;
                }
                // Now, switch to the determined parent and then its child
                switchIntelligenceVaultParentTab(appState.currentIntelligenceVaultParentTab);

                // Show the "Add New Tool" button
                if (!appState.readOnlyMode) {
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'inline-flex';
                }

            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render main custom tabs (the list of custom vaults)

                // Only proceed to render/switch parent/child entry tabs if custom vaults exist
                if (appState.customTabs.length > 0) {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'flex'; // Show parent tabs for entries
                    renderCustomVaultParentTabs(); // Render custom vault entry parent tabs

                    // Ensure a valid parent is selected, default if current one is invalid
                    const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
                    if (!currentCustomParent) {
                        appState.currentCustomVaultParentTab = customVaultEntryStructure[0].id;
                    }
                    // Ensure a valid child is selected under the current parent, default if invalid
                    const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                    if (!currentCustomChild) {
                        appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                    }
                    // Now, switch to the determined parent and then its child
                    switchCustomVaultParentTab(appState.currentCustomVaultParentTab);

                    // Show the "Add New Entry" button for custom vaults
                    if (!appState.readOnlyMode) {
                        document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                    }
                }

            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'handbook') {
                initHandbookAndNotes(); // Ensure handbook and notes are initialized
            }

            renderIntelligenceEntries(); // Always re-render entries relevant to the currently active main tab
            saveState(); // Save state after tab switch
        }

        // NEW: Render Intelligence Vault Parent Tabs
        function renderIntelligenceVaultParentTabs() {
            const parentTabsContainer = document.getElementById('intelligenceVaultParentTabs');
            if (!parentTabsContainer) return;

            // Clear previous content to ensure new buttons are rendered clean
            parentTabsContainer.innerHTML = ''; 

            intelligenceVaultTabStructure.map(parentTab => {
                const button = document.createElement('button');
                button.classList.add('nav-tab', 'intelligence-vault-parent-tab');
                button.dataset.parentTab = parentTab.id;
                button.innerHTML = `<i class="${parentTab.icon}"></i> ${parentTab.name}`;
                parentTabsContainer.appendChild(button);
            });

            // Re-attach event listener using delegation to the container (if it exists, and not already done)
            // This listener is now only set up once in bindEvents to avoid duplicates.
            // When renderIntelligenceVaultParentTabs is called, it just re-populates the innerHTML.
            // The event listener is attached to the parentTabsContainer, which persists.

            // Activate the currently selected parent tab
            const activeParentBtn = parentTabsContainer.querySelector(`.intelligence-vault-parent-tab[data-parent-tab="${appState.currentIntelligenceVaultParentTab}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }
        }


        // NEW: Switch Intelligence Vault Parent Tab
        function switchIntelligenceVaultParentTab(parentId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all parent tabs
            document.querySelectorAll('#intelligenceVaultParentTabs .intelligence-vault-parent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked parent tab
            const activeParentBtn = document.querySelector(`#intelligenceVaultParentTabs .intelligence-vault-parent-tab[data-parent-tab="${parentId}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }

            appState.currentIntelligenceVaultParentTab = parentId;

            // Find the selected parent tab's children
            const selectedParent = intelligenceVaultTabStructure.find(p => p.id === parentId);
            const childTabsContainer = document.getElementById('intelligenceVaultChildTabs'); // Get the direct reference

            if (selectedParent && childTabsContainer) {
                childTabsContainer.style.display = 'flex'; // Show the child tabs container
                // Update the innerHTML of the existing container
                childTabsContainer.innerHTML = selectedParent.children.map(childTab => `
                    <button class="sub-nav-tab intelligence-vault-child-tab" data-child-tab="${childTab.id}">
                        <i class="${childTab.icon}"></i> ${childTab.name}
                    </button>
                `).join('');

                // The click listener for child tabs is already delegated to `intelligenceVaultChildTabsContainer`
                // in `bindEvents()`, so no need to re-add it here.

                // Automatically activate the first child tab or the previously selected child tab under this parent
                let childToActivate = appState.currentIntelligenceVaultChildTab;
                if (!selectedParent.children.some(c => c.id === childToActivate)) {
                    childToActivate = selectedParent.children[0]?.id; // Default to first child if current is not in this parent
                }
                if (childToActivate) {
                    switchIntelligenceVaultChildTab(childToActivate);
                } else {
                    // No child tabs for this parent, clear display
                    appState.currentIntelligenceVaultChildTab = null;
                    appState.filters.category = '';
                    renderIntelligenceEntries();
                }

            } else {
                childTabsContainer.style.display = 'none'; // Hide if no children or container not found
                appState.currentIntelligenceVaultChildTab = null;
                appState.filters.category = '';
                renderIntelligenceEntries();
            }

            saveState(); // Save the parent tab state
        }

        // MODIFIED: Switch Intelligence Vault Child Sub-tabs (now show tools)
        // This function now expects a 'childId' which maps directly to the `intelligenceVaultCategories` (tools, emailTools, etc.)
        function switchIntelligenceVaultChildTab(childId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all child tabs
            document.querySelectorAll('#intelligenceVaultChildTabs .intelligence-vault-child-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked child tab
            const targetChildTabBtn = document.querySelector(`#intelligenceVaultChildTabs .intelligence-vault-child-tab[data-child-tab="${childId}"]`);
            if (targetChildTabBtn) {
                targetChildTabBtn.classList.add('active');
            }

            appState.currentIntelligenceVaultChildTab = childId;
            appState.filters.category = ''; // Clear category filter when switching intel vault sub-tabs
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant tools
            saveState(); // Save the child tab state
        }

// MODIFIED: loadState function to correctly parse all new entry types
function loadState() {
    const savedState = localStorage.getItem('osintArsenalState');
    if (savedState) {
        const parsedState = JSON.parse(savedState);

        // Map and ensure Date objects and default values for all existing types
        appState.tools = (parsedState.tools || []).map(entry => ({
            ...entry,
            addedDate: new Date(entry.addedDate),
            lastUsed: entry.lastUsed || 0,
            customTabs: entry.customTabs || [],
            intelligenceVaultCategories: entry.intelligenceVaultCategories || [],
            origin: entry.origin || 'user-added'
        }));
        appState.emails = (parsedState.emails || []).map(entry => ({ ...entry, linkedPlatforms: entry.linkedPlatforms || [] }));
        appState.phones = parsedState.phones || [];
        appState.crypto = (parsedState.crypto || []).map(entry => ({ ...entry, amount: parseFloat(entry.amount) || 0 }));
        appState.locations = parsedState.locations || [];
        appState.links = parsedState.links || [];
        appState.media = (parsedState.media || []).map(entry => ({ ...entry, base64Data: entry.base64Data || '' }));
        appState.passwords = parsedState.passwords || [];
        appState.keywords = parsedState.keywords || [];
        appState.socials = parsedState.socials || [];

        // Add all new entry types here, ensuring they are initialized as arrays and correctly parsed
        appState.domains = parsedState.domains || [];
        appState.usernames = parsedState.usernames || [];
        appState.threats = parsedState.threats || [];
        appState.vulnerabilities = (parsedState.vulnerabilities || []).map(entry => ({ ...entry, cvss: parseFloat(entry.cvss) || 0 }));
        appState.malware = parsedState.malware || [];
        appState.breaches = (parsedState.breaches || []).map(entry => ({ ...entry, records: parseInt(entry.records) || 0 }));
        appState.credentials = parsedState.credentials || [];
        appState.forums = parsedState.forums || [];
        appState.vendors = parsedState.vendors || [];
        appState.telegramChannels = (parsedState.telegramChannels || []).map(entry => ({ ...entry, subscribers: parseInt(entry.subscribers) || 0 }));
        appState.pastes = parsedState.pastes || [];
        appState.documents = parsedState.documents || [];
        appState.networks = parsedState.networks || [];
        appState.metadataEntries = parsedState.metadataEntries || [];
        appState.archives = (parsedState.archives || []).map(entry => ({ ...entry, timestamp: entry.timestamp ? new Date(entry.timestamp).getTime() : null }));
        appState.messagingApps = parsedState.messagingApps || [];
        appState.datingProfiles = (parsedState.datingProfiles || []).map(entry => ({ ...entry, age: parseInt(entry.age) || null }));
        appState.audioEntries = (parsedState.audioEntries || []).map(entry => ({ ...entry, base64Data: entry.base64Data || '' }));
        appState.facialRecognition = parsedState.facialRecognition || [];
        appState.personas = parsedState.personas || [];
        appState.vpns = parsedState.vpns || [];
        appState.honeypots = parsedState.honeypots || [];
        appState.exploits = parsedState.exploits || [];
        appState.publicRecords = parsedState.publicRecords || [];

        appState.selectedEntries = new Set(Array.isArray(parsedState.selectedEntries) ? parsedState.selectedEntries : []);
        appState.filters = parsedState.filters || {
            category: '',
            search: '',
            sort: 'name',
            searchScope: 'currentTab'
        };
        appState.theme = parsedState.theme || 'dark';
        appState.viewMode = parsedState.viewMode || 'grid';
        appState.usageStats = parsedState.usageStats || {
            toolsUsedToday: 0
        };
        appState.customTabs = parsedState.customTabs || [];
        // Ensure currentCustomTab points to a valid tab if customTabs exist
        appState.currentCustomTab = parsedState.currentCustomTab && appState.customTabs.some(t => t.id === parsedState.currentCustomTab) ? parsedState.currentCustomTab : (appState.customTabs.length > 0 ? appState.customTabs[0].id : null);

        // Ensure parent/child tabs exist and have valid defaults if needed
        appState.currentIntelligenceVaultParentTab = parsedState.currentIntelligenceVaultParentTab || 'generalAndCore';
        appState.currentIntelligenceVaultChildTab = parsedState.currentIntelligenceVaultChildTab || 'tools';
        appState.currentCustomVaultParentTab = parsedState.currentCustomVaultParentTab || 'coreInvestigation';
        appState.currentCustomVaultEntrySubTab = parsedState.currentCustomVaultEntrySubTab || 'tool'; // Changed to 'tool' (singular)

        // CRUCIAL PART: Merge default tools after loading saved state
        defaultTools.forEach(defaultTool => {
            const exists = appState.tools.some(tool => tool.id === defaultTool.id);
            if (!exists) {
                appState.tools.push({ ...defaultTool, addedDate: new Date(defaultTool.addedDate), origin: 'pre-added' });
            }
        });

    } else {
        // If no saved state exists (first-time user), initialize with default tools and empty new arrays
        appState.tools = defaultTools.map(tool => ({ ...tool, origin: 'pre-added' }));
        appState.customTabs = [{
            id: generateId(),
            name: 'My First Vault',
            toolIds: [],
            icon: 'fas fa-folder',
            color: 'var(--tab-color-default)'
        }];
        appState.currentCustomTab = appState.customTabs[0]?.id || null;

        appState.currentIntelligenceVaultParentTab = 'generalAndCore';
        appState.currentIntelligenceVaultChildTab = 'tools';
        appState.currentCustomVaultParentTab = 'coreInvestigation';
        appState.currentCustomVaultEntrySubTab = 'tool';

        // Initialize all new arrays as empty if no saved state
        appState.emails = [];
        appState.phones = [];
        appState.crypto = [];
        appState.locations = [];
        appState.links = [];
        appState.media = [];
        appState.passwords = [];
        appState.keywords = [];
        appState.socials = [];
        appState.domains = [];
        appState.usernames = [];
        appState.threats = [];
        appState.vulnerabilities = [];
        appState.malware = [];
        appState.breaches = [];
        appState.credentials = [];
        appState.forums = [];
        appState.vendors = [];
        appState.telegramChannels = [];
        appState.pastes = [];
        appState.documents = [];
        appState.networks = [];
        appState.metadataEntries = [];
        appState.archives = [];
        appState.messagingApps = [];
        appState.datingProfiles = [];
        appState.audioEntries = [];
        appState.facialRecognition = [];
        appState.personas = [];
        appState.vpns = [];
        appState.honeypots = [];
        appState.exploits = [];
        appState.publicRecords = [];
    }
}

        

        // Save application state to localStorage
        function saveState() {
            localStorage.setItem('osintArsenalState', JSON.stringify(appState));
        }

        // Update statistics
        function updateStats() {
            // Include new types in allEntries
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const categories = new Set(appState.tools.map(tool => tool.category)); // Only tools have categories for now
            document.getElementById('totalTools').textContent = allEntries.length; // Count all entries, not just tools
            document.getElementById('totalCategories').textContent = categories.size;
            document.getElementById('starredToolsCount').textContent = allEntries.filter(entry => entry.starred).length;
            document.getElementById('pinnedToolsCount').textContent = allEntries.filter(entry => entry.pinned).length;
        }

        // Populate category filter and Add Tool modal
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const toolCategorySelect = document.getElementById('toolCategory');
            const editToolCategorySelect = document.getElementById('editToolCategory');
            const toolOnlyCategorySelect = document.getElementById('toolOnlyCategory'); // For Add Tool Only Modal

            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));

            // Add static options
            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation',
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...Array.from(existingCategories)]);

            // Clear existing options
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            editToolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            toolOnlyCategorySelect.innerHTML = '<option value="">Select Category</option>';


            // Sort categories alphabetically for dropdowns
            const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));

            sortedCategories.forEach(category => {
                // Filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(filterOption);

                // Add Tool dropdown
                const toolOption = document.createElement('option');
                toolOption.value = category;
                toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolCategorySelect.appendChild(toolOption);

                // Edit Tool dropdown
                const editToolOption = document.createElement('option');
                editToolOption.value = category;
                editToolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                editToolCategorySelect.appendChild(editToolOption);

                // Add Tool Only dropdown
                const toolOnlyOption = document.createElement('option');
                toolOnlyOption.value = category;
                toolOnlyOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolOnlyCategorySelect.appendChild(toolOnlyOption);
            });

            // Add "Custom" option to tool category select
            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);

            // Add "Custom" option to toolOnlyCategorySelect
            const customOptionAddToolOnly = document.createElement('option');
            customOptionAddToolOnly.value = 'custom';
            customOptionAddToolOnly.textContent = 'Custom Category';
            toolOnlyCategorySelect.appendChild(customOptionAddToolOnly);

            const customOptionEdit = document.createElement('option');
            customOptionEdit.value = 'custom';
            customOptionEdit.textContent = 'Custom Category';
            editToolCategorySelect.appendChild(customOptionEdit);


            // Set selected values for filters
            categoryFilter.value = appState.filters.category;
            document.getElementById('sortFilter').value = appState.filters.sort;
        }

        function renderIntelligenceEntries() {
            const toolsContainer = document.getElementById('toolsGrid');
            const customTabToolsContainer = document.getElementById('customTabToolsGrid');
            const intelligenceVaultEntriesContainer = document.getElementById('intelligenceVaultEntries');
            const emptyState = document.getElementById('emptyState');
            const emptyCustomTabState = document.getElementById('emptyCustomTabState');
            const emptyCurrentCustomTabState = document.getElementById('emptyCurrentCustomTabState');
            const emptyIntelligenceVaultState = document.getElementById('emptyIntelligenceVaultState');

            // References for parent/child tabs
            const intelligenceVaultParentTabs = document.getElementById('intelligenceVaultParentTabs');
            const intelligenceVaultChildTabs = document.getElementById('intelligenceVaultChildTabs');
            const customVaultEntryParentTabs = document.getElementById('customVaultEntryParentTabs');
            const customVaultEntryChildTabs = document.getElementById('customVaultEntryChildTabs');


            // Hide all empty states and containers initially
            toolsContainer.style.display = 'none';
            customTabToolsContainer.style.display = 'none';
            intelligenceVaultEntriesContainer.style.display = 'none';
            emptyState.style.display = 'none';
            emptyCustomTabState.style.display = 'none';
            emptyCurrentCustomTabState.style.display = 'none';
            emptyIntelligenceVaultState.style.display = 'none';

            // Also hide all tab containers by default, they will be explicitly shown below
            if (intelligenceVaultParentTabs) intelligenceVaultParentTabs.style.display = 'none';
            if (intelligenceVaultChildTabs) intelligenceVaultChildTabs.style.display = 'none';
            if (customVaultEntryParentTabs) customVaultEntryParentTabs.style.display = 'none';
            if (customVaultEntryChildTabs) customVaultEntryChildTabs.style.display = 'none';


            let filteredEntries = filterEntries(); 

            let targetContainer = null;
            let currentEmptyState = null;

            if (appState.currentTab === 'intelligence-vault') {
                targetContainer = intelligenceVaultEntriesContainer;
                currentEmptyState = emptyIntelligenceVaultState;

                // Ensure intelligence vault parent and child tabs are visible
                if (intelligenceVaultParentTabs) intelligenceVaultParentTabs.style.display = 'flex';
                if (appState.currentIntelligenceVaultChildTab && intelligenceVaultChildTabs) {
                     intelligenceVaultChildTabs.style.display = 'flex';
                }

                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                } else {
                    currentEmptyState.style.display = 'none';
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                }

            } else if (appState.currentTab === 'custom-tabs') {
                targetContainer = customTabToolsContainer;

                // Only show parent/child entry tabs if there's an active custom vault selected
                if (appState.customTabs.length === 0) {
                    emptyCustomTabState.style.display = 'block';
                    document.getElementById('addEntryBtnCustomVault').style.display = 'none'; // Hide add entry button if no custom tabs
                    return;
                } else {
                    emptyCustomTabState.style.display = 'none'; // Hide global empty state if custom tabs exist
                }

                if (appState.currentCustomTab) { // If a specific custom vault is selected
                    if (customVaultEntryParentTabs) customVaultEntryParentTabs.style.display = 'flex';
                    if (appState.currentCustomVaultEntrySubTab && customVaultEntryChildTabs) {
                        customVaultEntryChildTabs.style.display = 'flex';
                    }
                     document.getElementById('addEntryBtnCustomVault').style.display = appState.readOnlyMode ? 'none' : 'inline-flex';


                    if (filteredEntries.length === 0) {
                        emptyCurrentCustomTabState.style.display = 'block'; // Show empty state for selected custom tab
                        targetContainer.style.display = 'none';
                    } else {
                        emptyCurrentCustomTabState.style.display = 'none';
                        targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                    }
                } else { // No specific custom vault selected, but custom tabs exist
                    emptyCurrentCustomTabState.style.display = 'block'; // Show empty state for selected custom tab
                    targetContainer.style.display = 'none';
                }


            } else if (appState.currentTab === 'tools') { // This `toolsTab` might be obsolete if `intelligence-vault` replaces it
                targetContainer = toolsContainer;
                currentEmptyState = emptyState;
                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                } else {
                    currentEmptyState.style.display = 'none';
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                }
            }
            // For other tabs (analytics, threats, handbook), no entries are rendered in this function.

            // Set the appropriate class based on viewMode
            if (targetContainer) { // Only apply if a container is actually being targeted
                if (appState.viewMode === 'grid') {
                    targetContainer.classList.remove('tools-list');
                    targetContainer.classList.add('tools-grid');
                } else {
                    targetContainer.classList.remove('tools-grid');
                    targetContainer.classList.add('tools-list');
                }
                targetContainer.innerHTML = filteredEntries.map(entry => createEntryCard(entry)).join('');
            }

            // Update view toggle button text based on appState.viewMode
            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            const customVaultViewToggleButton = document.getElementById('customVaultViewToggle'); // This was fixed to exist

            if (appState.viewMode === 'grid') {
                if (viewToggleButton) viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                if (vaultViewToggleButton) vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                if (customVaultViewToggleButton) customVaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View'; // Use the correct ID here
            } else {
                if (viewToggleButton) viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                if (vaultViewToggleButton) vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                if (customVaultViewToggleButton) customVaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View'; // Use the correct ID here
            }
            
            // New: Apply shared-highlight if in read-only mode and relevant entries are found
            if (appState.readOnlyMode && appState.sharedEntryIds.length > 0) {
                // Determine if the current view corresponds to the shared scope
                let shouldHighlight = false;
                if (appState.sharedTabId === 'allData' || appState.sharedTabId === 'allVault') {
                    shouldHighlight = true; // Always highlight all if allData/allVault shared
                } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared custom tab
                } else if (appState.currentTab === 'intelligence-vault' && appState.currentIntelligenceVaultChildTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared intel vault child tab
                }

                if (shouldHighlight) {
                    appState.sharedEntryIds.forEach(id => {
                        const entryCard = document.querySelector(`.tool-card[data-entry-id="${id}"]`);
                        if (entryCard) {
                            entryCard.classList.add('shared-highlight');
                        }
                    });
                }
            }

            saveState(); // Save state after rendering entries
        }

// MODIFIED: filterEntries function to include all new entry types
function filterEntries() {
    let entriesToSearch = [];

    // Combine all entries from all types for the base set
    const allKnownEntries = [
        ...appState.tools,
        ...appState.emails,
        ...appState.phones,
        ...appState.crypto,
        ...appState.locations,
        ...appState.links,
        ...appState.media,
        ...appState.passwords,
        ...appState.keywords,
        ...appState.socials,
        ...appState.domains,
        ...appState.usernames,
        ...appState.threats,
        ...appState.vulnerabilities,
        ...appState.malware,
        ...appState.breaches,
        ...appState.credentials,
        ...appState.forums,
        ...appState.vendors,
        ...appState.telegramChannels,
        ...appState.pastes,
        ...appState.documents,
        ...appState.networks,
        ...appState.metadataEntries,
        ...appState.archives,
        ...appState.messagingApps,
        ...appState.datingProfiles,
        ...appState.audioEntries,
        ...appState.facialRecognition,
        ...appState.personas,
        ...appState.vpns,
        ...appState.honeypots,
        ...appState.exploits,
        ...appState.publicRecords
    ];

    if (appState.filters.searchScope === 'allData' || appState.filters.searchScope === 'allVault') {
        entriesToSearch = allKnownEntries;
    } else {
        // For 'currentTab' scope within intelligence-vault or custom-tabs
        if (appState.currentTab === 'intelligence-vault') {
            // Filter tools based on the active intelligence vault child tab
            entriesToSearch = appState.tools.filter(tool =>
                (tool.intelligenceVaultCategories || []).includes(appState.currentIntelligenceVaultChildTab)
            );
        } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (activeCustomTab) {
                // First, filter entries that belong to the currently active custom tab
                let entriesInActiveCustomTab = allKnownEntries.filter(entry =>
                    (entry.customTabs || []).includes(activeCustomTab.id)
                );

                // Then, filter these entries based on the currently selected child sub-tab (Tools, Emails, etc.)
                if (appState.currentCustomVaultEntrySubTab) {
                    entriesToSearch = entriesInActiveCustomTab.filter(entry =>
                        entry.type === appState.currentCustomVaultEntrySubTab
                    );
                } else {
                    entriesToSearch = entriesInActiveCustomTab; // Show all entries in the custom tab if no specific sub-type selected
                }

            } else {
                entriesToSearch = [];
            }
        } else {
            entriesToSearch = []; // No specific entries to filter for other tabs like analytics, threats, handbook
        }
    }

    let filtered = [...entriesToSearch]; // Start filtering from this base set

    // Apply search filter
    if (appState.filters.search) {
        const searchTerm = appState.filters.search.toLowerCase();
        filtered = filtered.filter(entry => {
            const searchableFields = [
                // Core fields common across many types
                entry.name, entry.title, entry.description, entry.notes, entry.url, entry.value,
                entry.category, // Only for tools
                entry.source,

                // Specific fields for each type (check for existence to prevent errors)
                entry.email, entry.number, entry.address, entry.txid,
                entry.linkedPlatforms, entry.breachResults,
                entry.phoneType, entry.location, entry.mapLink, entry.ipGeoIntel,
                entry.mediaType,
                entry.service, entry.username, entry.password, entry.strength,
                entry.context,
                entry.platform, entry.followCounts,

                // New fields for all the added types
                entry.domainType, entry.registrar, entry.status, entry.whois, entry.dns,
                entry.platformsFound, entry.emails, entry.realName, entry.activity,
                entry.threatType, entry.threatName, entry.severity, entry.iocs, entry.targets, entry.attribution, entry.threatSource,
                entry.cve, entry.cvss, entry.software, entry.vulnType, entry.exploit, entry.mitigation,
                entry.filename, entry.hash, entry.fileType, entry.family, entry.detection, entry.behavior, entry.malwareSource, entry.tools,
                entry.company, entry.date, entry.records, entry.dataTypes, entry.vector, entry.breachStatus, entry.breachSource,
                entry.credentialType, entry.credentialValue, entry.credentialService, entry.dateFound,
                entry.forumName, entry.forumUrl, entry.forumType, entry.forumStatus, entry.forumLanguage,
                entry.vendorAlias, entry.vendorPlatforms, entry.vendorProducts, entry.vendorReputation,
                entry.telegramName, entry.telegramUrl, entry.telegramType, entry.subscribers, entry.language, entry.telegramActivity, entry.content, entry.admin,
                entry.pasteUrl, entry.sourceSite, entry.contentSummary, entry.keywords,
                entry.documentTitle, entry.documentFileType, entry.documentHash, entry.documentContentSummary, entry.documentSource,
                entry.networkSubject, entry.networkType, entry.networkFindings, entry.associatedIpsDomains, entry.toolsUsed,
                entry.metadataTitle, entry.fileSource, // For metadata entry type itself
                entry.originalUrl, entry.archiveUrl, entry.service, entry.timestamp, // For archives
                entry.messagingApp, entry.chatId, // For messaging
                entry.datingPlatform, entry.displayName, entry.age, entry.photos, entry.bio, entry.verified, entry.suspicious,
                entry.format, entry.duration, entry.quality, entry.audioLanguage, entry.transcript, entry.speakers, entry.background,
                entry.subject, entry.sourceDescription, entry.identifiedProfiles, entry.confidence, entry.facialToolsUsed,
                entry.realName, entry.associatedAccounts, entry.platformsUsed, entry.origin, // For persona
                entry.vpnName, entry.vpnType, entry.jurisdiction, entry.logs, entry.payment, entry.locations, entry.issues, entry.useCase, // For VPN
                entry.honeypotType, entry.honeypotLocation, entry.honeypotPurpose, entry.honeypotDataSummary, entry.honeypotAlerts,
                entry.exploitName, entry.targetVuln, entry.exploitType, entry.marketSource, entry.price,
                entry.recordType, entry.subjectName, entry.refId, entry.jurisdiction, entry.date, entry.summary, entry.sourceUrl
            ].map(field => String(field || '').toLowerCase());

            if (entry.tags) {
                searchableFields.push(...entry.tags.map(tag => tag.toLowerCase()));
            }

            if (entry.metadata) {
                searchableFields.push(...entry.metadata.flatMap(meta => [String(meta.key || '').toLowerCase(), String(meta.value || '').toLowerCase()]));
            }

            return searchableFields.some(field => field.includes(searchTerm));
        });
    }

    // Apply universal "category" filters for pinned/starred
    if (appState.filters.category === 'pinned') {
        filtered = filtered.filter(entry => entry.pinned);
    } else if (appState.filters.category === 'starred') {
        filtered = filtered.filter(entry => entry.starred);
    } else if (appState.filters.category) {
        // This 'else if' block handles actual categories, only apply if the current view is for tools
        // Now, only filter by category if we are explicitly on an 'Intelligence Vault' tab that displays tools,
        // or if we are on the 'tools' sub-tab within a custom vault.
        if (appState.currentTab === 'intelligence-vault' || (appState.currentTab === 'custom-tabs' && appState.currentCustomVaultEntrySubTab === 'tool')) { // Changed to 'tool'
            filtered = filtered.filter(entry => entry.type === 'tool' && entry.category === appState.filters.category);
        } else {
            // If a category filter is applied while not on a 'tools' tab, clear it visually.
            document.getElementById('categoryFilter').value = '';
            appState.filters.category = ''; // Ensure state is reset too
        }
    }

    // Apply sorting
    filtered.sort((a, b) => {
        switch (appState.filters.sort) {
            case 'recent':
                return new Date(b.addedDate || 0) - new Date(a.addedDate || 0);
            case 'popular': // Sort by lastUsed (most recent first)
                return (b.lastUsed || 0) - (a.lastUsed || 0);
            default: // 'name' (or primary identifier, which is often the first significant field)
                // Use a more comprehensive list of potential name fields
                const nameA = a.name || a.title || a.email || a.number || a.address || a.value || a.username || a.filename || a.company || a.credentialValue || a.forumName || a.vendorAlias || a.telegramName || a.pasteUrl || a.documentTitle || a.networkSubject || a.metadataTitle || a.originalUrl || a.messagingUsername || a.facialSubject || a.personaName || a.vpnName || a.exploitName || a.publicRecordSubjectName || '';
                const nameB = b.name || b.title || b.email || b.number || b.address || b.value || b.username || b.filename || b.company || b.credentialValue || b.forumName || b.vendorAlias || b.telegramName || b.pasteUrl || b.documentTitle || b.networkSubject || b.metadataTitle || b.originalUrl || b.messagingUsername || b.facialSubject || b.personaName || b.vpnName || b.exploitName || b.publicRecordSubjectName || '';
                return nameA.localeCompare(nameB);
        }
    });

    return filtered;
}

            // Create a generic entry card HTML
// MODIFIED: createEntryCard function to include all new entry types
function createEntryCard(entry) {
    const isSelected = appState.selectedEntries.has(entry.id);
    let title, subtitle, description, icon, faviconHtml = '', extraContent = '';

    // Determine the origin tag HTML
    let originTagHtml = '';
    if (entry.origin === 'pre-added') {
        originTagHtml = `<span class="tag" style="background-color: var(--primary); color: white; margin-left: 10px;">Pre-added</span>`;
    } else if (entry.origin === 'user-added') {
        originTagHtml = `<span class="tag" style="background-color: var(--accent); color: white; margin-left: 10px;">User-added</span>`;
    }

    // Default notes if not specified for a type
    const investigationNotes = entry.notes ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Notes:</strong> ${entry.notes}</p>` : '';

    switch (entry.type) {
        case 'tool':
            title = entry.name;
            subtitle = entry.url;
            description = entry.description;
            icon = 'fas fa-tools';
            faviconHtml = `<img src="${entry.favicon}" alt="" class="tool-favicon" onerror="this.src='https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}'">`;
            extraContent += investigationNotes;
            break;
        case 'email':
            title = entry.email;
            subtitle = entry.linkedPlatforms.join(', ') || 'No linked platforms';
            description = entry.description || entry.notes;
            icon = 'fas fa-envelope';
            extraContent = entry.breachResults ? `<p style="color: var(--danger); font-size: 12px; margin-top: 5px;"><i class="fas fa-exclamation-triangle"></i> Breach: ${entry.breachResults}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'phone':
            title = entry.number;
            subtitle = `Type: ${entry.phoneType}`;
            description = entry.description || entry.notes;
            icon = 'fas fa-phone';
            extraContent = entry.location ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${entry.location}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'crypto':
            title = entry.address;
            subtitle = `TXID: ${entry.txid}`;
            description = entry.description || `Amount: ${entry.amount} | Source: ${entry.source}`;
            icon = 'fas fa-coins';
            extraContent += investigationNotes;
            break;
        case 'location':
            title = entry.name;
            subtitle = `Coordinates: ${entry.coordinates}`;
            description = entry.description || entry.notes;
            icon = 'fas fa-map-marker-alt';
            extraContent = entry.mapLink ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.mapLink}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> View Map</a></p>` : '';
            extraContent += entry.ipGeoIntel ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">IP/Geo: ${entry.ipGeoIntel}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'link':
            title = entry.url;
            subtitle = entry.platform || 'General Link';
            description = entry.description || entry.notes;
            icon = 'fas fa-link';
            try {
                faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
            } catch (e) {
                faviconHtml = '';
            }
            extraContent += investigationNotes;
            break;
        case 'media':
            title = entry.title;
            subtitle = entry.mediaType === 'image' ? 'Image' : 'Video';
            description = entry.description || entry.notes;
            icon = entry.mediaType === 'image' ? 'fas fa-image' : 'fas fa-video';
            extraContent = entry.base64Data ? (entry.mediaType === 'image' ? `<img src="${entry.base64Data}" alt="Media thumbnail" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">` : `<video controls style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;"><source src="${entry.base64Data}" type="video/mp4"></video>`) : '';
            extraContent += investigationNotes;
            break;
        case 'password':
            title = entry.service;
            subtitle = `Username: ${entry.username || 'N/A'}`;
            description = entry.description || `Password: ${entry.password} | Strength: ${entry.strength || 'N/A'}`;
            icon = 'fas fa-key';
            extraContent += investigationNotes;
            break;
        case 'keyword':
            title = entry.value;
            subtitle = `Context: ${entry.context || 'General'}`;
            description = entry.description || entry.notes;
            icon = 'fas fa-font';
            extraContent += investigationNotes;
            break;
        case 'social':
            title = entry.username;
            subtitle = `Platform: ${entry.platform}`;
            description = entry.description || `URL: ${entry.url}\nFollowers/Following: ${entry.followCounts || 'N/A'}`;
            icon = 'fas fa-users';
            try {
                faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
            } catch (e) {
                faviconHtml = '';
            }
            extraContent += investigationNotes;
            break;
        case 'domain':
            title = entry.value;
            subtitle = `Type: ${entry.domainType} | Status: ${entry.status || 'N/A'}`;
            description = entry.description || `Registrar: ${entry.registrar || 'N/A'}\nLocation: ${entry.location || 'N/A'}`;
            icon = 'fas fa-globe';
            extraContent = entry.whois ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>WHOIS:</strong> ${entry.whois}</p>` : '';
            extraContent += entry.dns ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>DNS:</strong> ${entry.dns}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'username':
            title = entry.value;
            subtitle = `Real Name: ${entry.realName || 'N/A'}`;
            description = entry.description || `Platforms: ${entry.platformsFound || 'N/A'}\nEmails: ${entry.emails || 'N/A'}\nActivity: ${entry.activity || 'N/A'}`;
            icon = 'fas fa-user';
            extraContent += investigationNotes;
            break;
        case 'threat':
            title = entry.name;
            subtitle = `Type: ${entry.threatType} | Severity: ${entry.severity}`;
            description = entry.description;
            icon = 'fas fa-skull-crossbones';
            extraContent = entry.iocs ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>IOCs:</strong> ${entry.iocs}</p>` : '';
            extraContent += entry.targets ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Targets:</strong> ${entry.targets}</p>` : '';
            extraContent += entry.attribution ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Attribution:</strong> ${entry.attribution}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'vulnerability':
            title = entry.cve;
            subtitle = `CVSS: ${entry.cvss} | Type: ${entry.vulnType}`;
            description = entry.description || `Affected: ${entry.software || 'N/A'}\nExploit: ${entry.exploit || 'N/A'}`;
            icon = 'fas fa-bug';
            extraContent = entry.mitigation ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Mitigation:</strong> ${entry.mitigation}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'malware':
            title = entry.filename;
            subtitle = `Type: ${entry.fileType} | Hash: ${entry.hash}`;
            description = entry.behavior || `Family: ${entry.family || 'N/A'}\nDetection: ${entry.detection || 'N/A'}`;
            icon = 'fas fa-biohazard'; // More distinct malware icon
            extraContent = entry.malwareSource ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Source:</strong> ${entry.malwareSource}</p>` : '';
            extraContent += entry.tools ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Tools:</strong> ${entry.tools}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'breach':
            title = entry.company;
            subtitle = `Date: ${entry.date || 'N/A'} | Records: ${entry.records || 'N/A'}`;
            description = entry.description || `Data Types: ${entry.dataTypes || 'N/A'}\nVector: ${entry.vector || 'N/A'}\nStatus: ${entry.status || 'N/A'}`;
            icon = 'fas fa-database';
            extraContent = entry.source ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.source}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> Source</a></p>` : '';
            extraContent += investigationNotes;
            break;
        case 'credential':
            title = entry.credentialService || 'N/A';
            subtitle = `Type: ${entry.credentialType}`;
            description = entry.description || `Value: ${entry.credentialValue.substring(0, 50)}${entry.credentialValue.length > 50 ? '...' : ''}\nBreach Source: ${entry.breachSource || 'N/A'}`;
            icon = 'fas fa-user-lock'; // Specific for credentials
            extraContent += investigationNotes;
            break;
        case 'forum':
            title = entry.forumName;
            subtitle = `Type: ${entry.forumType} | Status: ${entry.forumStatus}`;
            description = entry.description || `URL: ${entry.forumUrl}\nLanguage: ${entry.forumLanguage || 'N/A'}`;
            icon = 'fas fa-comments';
            try {
                faviconHtml = entry.forumUrl ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.forumUrl).hostname}" alt="" class="tool-favicon">` : '';
            } catch (e) {
                faviconHtml = '';
            }
            extraContent += investigationNotes;
            break;
        case 'vendor':
            title = entry.vendorAlias;
            subtitle = `Reputation: ${entry.vendorReputation || 'N/A'}`;
            description = entry.description || `Products: ${entry.vendorProducts || 'N/A'}\nPlatforms: ${entry.vendorPlatforms || 'N/A'}`;
            icon = 'fas fa-store';
            extraContent += investigationNotes;
            break;
        case 'telegram':
            title = entry.name;
            subtitle = `Type: ${entry.telegramType} | Subs: ${entry.subscribers || 'N/A'}`;
            description = entry.content || `URL: ${entry.url}\nLanguage: ${entry.language || 'N/A'}\nActivity: ${entry.activity || 'N/A'}\nAdmin: ${entry.admin || 'N/A'}`;
            icon = 'fab fa-telegram-plane';
            try {
                faviconHtml = entry.url ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">` : '';
            } catch (e) {
                faviconHtml = '';
            }
            extraContent += investigationNotes;
            break;
        case 'paste':
            title = entry.url;
            subtitle = `Source: ${entry.sourceSite || 'N/A'}`;
            description = entry.contentSummary || entry.description || `Keywords: ${entry.keywords || 'N/A'}`;
            icon = 'fas fa-paste';
            try {
                faviconHtml = entry.url ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">` : '';
            } catch (e) {
                faviconHtml = '';
            }
            extraContent += investigationNotes;
            break;
        case 'document':
            title = entry.title;
            subtitle = `Type: ${entry.fileType} | Hash: ${entry.hash || 'N/A'}`;
            description = entry.contentSummary || entry.description;
            icon = 'fas fa-file-alt';
            extraContent = entry.source ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Source:</strong> ${entry.source}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'network':
            title = entry.subject;
            subtitle = `Analysis Type: ${entry.networkType}`;
            description = entry.findings || entry.description;
            icon = 'fas fa-network-wired';
            extraContent = entry.associatedIpsDomains ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Associated:</strong> ${entry.associatedIpsDomains}</p>` : '';
            extraContent += entry.toolsUsed ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Tools:</strong> ${entry.toolsUsed}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'metadata':
            title = entry.title;
            subtitle = `File/Source: ${entry.fileSource || 'N/A'}`;
            description = entry.description; // Description specifically for metadata entry
            icon = 'fas fa-info-circle'; // General info icon
            extraContent += investigationNotes;
            break;
        case 'archive':
            title = `Archived: ${entry.originalUrl}`;
            subtitle = `Service: ${entry.service || 'N/A'} | Timestamp: ${entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'N/A'}`;
            description = entry.contentSummary || entry.description;
            icon = 'fas fa-archive';
            try {
                faviconHtml = entry.url ? `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">` : '';
            } catch (e) {
                faviconHtml = '';
            }
            extraContent += investigationNotes;
            break;
        case 'messaging':
            title = entry.username;
            subtitle = `App: ${entry.messagingApp} | Chat: ${entry.chatId || 'N/A'}`;
            description = entry.content || entry.description;
            icon = 'fas fa-comment-dots';
            extraContent += investigationNotes;
            break;
        case 'dating':
            title = entry.username;
            subtitle = `Platform: ${entry.platform} | Age: ${entry.age || 'N/A'}`;
            description = entry.bio || entry.description || `Location: ${entry.location || 'N/A'}\nVerified: ${entry.verified || 'N/A'}\nSuspicious: ${entry.suspicious || 'N/A'}`;
            icon = 'fas fa-heart';
            extraContent = entry.photos ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Photos:</strong> ${entry.photos}</p>` : '';
            extraContent += investigationNotes;
            break;
        case 'audio':
            title = entry.title;
            subtitle = `Format: ${entry.format} | Duration: ${entry.duration || 'N/A'}`;
            description = entry.description || `Quality: ${entry.quality || 'N/A'}\nLanguage: ${entry.language || 'N/A'}\nTranscript: ${entry.transcript || 'N/A'}`;
            icon = 'fas fa-volume-up';
            extraContent = entry.base64Data ? `<audio controls style="max-width: 100%; margin-top: 10px;"><source src="${entry.base64Data}" type="audio/${entry.format}"></audio>` : '';
            extraContent += `Speakers: ${entry.speakers || 'N/A'}<br>Background Noise: ${entry.background || 'N/A'}<br>Tools: ${entry.tools || 'N/A'}`;
            extraContent += investigationNotes;
            break;
        case 'facial':
            title = entry.subject;
            subtitle = `Confidence: ${entry.confidence || 'N/A'}`;
            description = entry.description || `Source: ${entry.sourceDescription || 'N/A'}\nProfiles: ${entry.identifiedProfiles || 'N/A'}\nTools: ${entry.toolsUsed || 'N/A'}`;
            icon = 'fas fa-face-id-card'; // Font Awesome 6
            extraContent += investigationNotes;
            break;
        case 'persona':
            title = entry.name;
            subtitle = `Real Name: ${entry.realName || 'N/A'}`;
            description = entry.bio || entry.description || `Accounts: ${entry.associatedAccounts || 'N/A'}\nPlatforms: ${entry.platformsUsed || 'N/A'}\nOrigin: ${entry.origin || 'N/A'}`;
            icon = 'fas fa-id-badge';
            extraContent += investigationNotes;
            break;
        case 'vpn':
            title = entry.name;
            subtitle = `Type: ${entry.vpnType} | Jurisdiction: ${entry.jurisdiction || 'N/A'}`;
            description = entry.description || `Logging: ${entry.logs || 'N/A'}\nPayment: ${entry.payment || 'N/A'}\nIssues: ${entry.issues || 'N/A'}`;
            icon = 'fas fa-shield-alt';
            extraContent += investigationNotes;
            break;
        case 'honeypot':
            title = `Honeypot: ${entry.honeypotType}`;
            subtitle = `Location: ${entry.location || 'N/A'}`;
            description = entry.dataSummary || entry.description || `Purpose: ${entry.purpose || 'N/A'}\nAlerts: ${entry.alerts || 'N/A'}`;
            icon = 'fas fa-honey-pot'; // Font Awesome 6
            extraContent += investigationNotes;
            break;
        case 'exploit':
            title = entry.name;
            subtitle = `Target: ${entry.targetVuln} | Type: ${entry.exploitType}`;
            description = entry.description || `Source: ${entry.marketSource || 'N/A'}\nPrice: ${entry.price || 'N/A'}`;
            icon = 'fas fa-bomb';
            extraContent += investigationNotes;
            break;
        case 'publicrecord':
            title = `Record: ${entry.recordType}`;
            subtitle = `Subject: ${entry.subjectName} | ID: ${entry.refId || 'N/A'}`;
            description = entry.summary || entry.description || `Jurisdiction: ${entry.jurisdiction || 'N/A'}\nDate: ${entry.date || 'N/A'}`;
            icon = 'fas fa-scale-balanced'; // Font Awesome 6
            extraContent = entry.sourceUrl ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.sourceUrl}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> Source</a></p>` : '';
            extraContent += investigationNotes;
            break;
        default:
            title = entry.name || entry.title || entry.value || 'Unknown Entry';
            subtitle = `Type: ${entry.type}`;
            description = entry.description || entry.notes || 'No description available.';
            icon = 'fas fa-question-circle';
            break;
    }

    // NEW: Add source and metadata to card if they exist
    if (entry.source) { // Apply to all entries
        extraContent += `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-satellite-dish"></i> Source: ${entry.source}</p>`;
    }
    if (entry.metadata && entry.metadata.length > 0) {
        extraContent += `<div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><strong>Metadata:</strong>`;
        entry.metadata.forEach(meta => {
            extraContent += `<p style="margin-left: 10px;">- ${meta.key}: ${meta.value}</p>`;
        });
        extraContent += `</div>`;
    }

    return `
        <div class="tool-card ${entry.starred ? 'starred' : ''} ${entry.pinned ? 'pinned' : ''} ${isSelected ? 'selected' : ''}"
        data-entry-id="${entry.id}" data-entry-type="${entry.type}">
            <div class="tool-header">
                <div>
                    <div class="tool-title">
                        <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''}>
                        ${faviconHtml} <i class="${icon}" style="margin-right: 5px;"></i> <span>${title}</span>
                        ${originTagHtml} </div>
                    <div class="tool-url">
                        <span>${subtitle}</span> ${entry.url ? '<i class="fas fa-external-link-alt external-link-icon"></i>' : ''}
                    </div>
                </div>
                <div class="tool-actions">
                    <button class="action-btn" data-action="edit" title="Edit Entry">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn ${entry.starred ? 'starred' : ''}" data-action="star" title="Star Entry">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="action-btn ${entry.pinned ? 'pinned' : ''}" data-action="pin" title="Pin Entry">
                        <i class="fas fa-thumbtack"></i>
                    </button>
                    ${entry.url ? `<button class="action-btn" data-action="visit" title="Visit Link">
                        <i class="fas fa-external-link-alt"></i>
                    </button>` : ''}
                    <button class="action-btn" data-action="delete" title="Delete Entry">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                ${description}
            </p>
            ${extraContent}
            <div class="tool-tags">
                ${entry.tags ? entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
            </div>
        </div>
    `;
}

        // Bind event listeners
        function bindEvents() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                appState.filters.search = e.target.value;
                renderIntelligenceEntries();
            });

            // Search Scope Select
            document.getElementById('searchScopeSelect').addEventListener('change', (e) => {
                appState.filters.searchScope = e.target.value;
                renderIntelligenceEntries(); // Re-render with new scope
            });

            // NEW: Event listener for Desktop Recommendation Modal's "Continue Anyway" button
            const continueAnywayBtn = document.getElementById('continueAnywayBtn');
            if (continueAnywayBtn) {
                continueAnywayBtn.addEventListener('click', () => {
                    hideModal('desktopRecommendationModal');
                    sessionStorage.setItem('desktopRecommendationShown', 'true'); // Mark as shown for this session
                });
            }

            // Filter controls
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                appState.filters.category = e.target.value;
                renderIntelligenceEntries();
            });

            document.getElementById('sortFilter').addEventListener('change', (e) => {
                appState.filters.sort = e.target.value;
                renderIntelligenceEntries();
            });
            
            // Handbook and Notes subtab events (should be handled here if they exist)
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const subtab = e.target.dataset.subtab;
                    switchHandbookSubtab(subtab);
                });
            });

            document.getElementById('addToolBtnEmptyState').addEventListener('click', () => {
                openAddToolOnlyModal();
            });

            document.getElementById('addToolBtnIntelligenceVault').addEventListener('click', () => {
                openAddToolOnlyModal(); // Call a new function to handle this modal
            });

            // Add event listeners for the new modal (inside bindEvents)
            document.getElementById('cancelAddToolOnly').addEventListener('click', () => hideModal('addToolOnlyModal'));
            document.getElementById('addToolOnlyForm').addEventListener('submit', handleAddToolOnly);

            // Add custom category input for the new modal
            document.getElementById('toolOnlyCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newToolOnlyCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = ''; // Clear input if not custom
                }
            });

            // Main tab navigation (Delegated as they are always present)
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });


            // Custom Vault Entry Parent Tabs (Delegation)
            const customVaultEntryParentTabsContainer = document.getElementById('customVaultEntryParentTabs');
            if (customVaultEntryParentTabsContainer) {
                customVaultEntryParentTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.custom-vault-entry-parent-tab');
                    if (tabBtn && tabBtn.dataset.parentTab) {
                        switchCustomVaultParentTab(tabBtn.dataset.parentTab);
                    }
                });
            }

            // Intelligence Vault Parent Tabs (Delegation)
            const intelligenceVaultParentTabsContainer = document.getElementById('intelligenceVaultParentTabs');
            if (intelligenceVaultParentTabsContainer) { // Ensure element exists
                intelligenceVaultParentTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.intelligence-vault-parent-tab');
                    if (tabBtn && tabBtn.dataset.parentTab) {
                        switchIntelligenceVaultParentTab(tabBtn.dataset.parentTab);
                    }
                });
            }

            // --- ADD THIS MISSING BLOCK ---
            // Intelligence Vault Child Tabs (Delegation - IMPORTANT!)
            const intelligenceVaultChildTabsContainer = document.getElementById('intelligenceVaultChildTabs');
            if (intelligenceVaultChildTabsContainer) { // Ensure element exists
                intelligenceVaultChildTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.intelligence-vault-child-tab');
                    if (tabBtn && tabBtn.dataset.childTab) {
                        switchIntelligenceVaultChildTab(tabBtn.dataset.childTab);
                    }
                });
            }
            // --- END MISSING BLOCK ---

            // Custom Vault Entry Child Tabs (Delegation)
            const customVaultEntryChildTabsContainer = document.getElementById('customVaultEntryChildTabs');
            if (customVaultEntryChildTabsContainer) { // Ensure element exists
                customVaultEntryChildTabsContainer.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.custom-vault-entry-child-tab');
                    if (tabBtn && tabBtn.dataset.childTab) {
                        switchCustomVaultEntrySubTab(tabBtn.dataset.childTab);
                    }
                });
            }


            // Tool actions (now generic for all entries) - Event delegation on the main content containers
            document.getElementById('toolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('customTabToolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('intelligenceVaultEntries').addEventListener('click', handleEntryAction);
            
            // Event delegation for bulk selection checkboxes
            document.getElementById('toolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('customTabToolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('intelligenceVaultEntries').addEventListener('change', handleBulkSelection);

            // Modal controls (Add New Entry) - specific to Multi-Vault now
            document.getElementById('addEntryBtnCustomVault').addEventListener('click', () => {
                // Set the default entry type to 'tool' for the Multi-Vault "Add New Entry" modal
                document.getElementById('entryTypeSelect').value = 'tool'; 
                displayEntryForm();
                showModal('addEntryModal');
            });
            document.getElementById('cancelAddEntry').addEventListener('click', () => hideModal('addEntryModal'));

            // Dynamic form display for Add Entry modal
            document.getElementById('entryTypeSelect').addEventListener('change', displayEntryForm);
            
            // Custom category input (Add Tool)
            document.getElementById('toolCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = ''; // Clear input if not custom
                }
            });
            
            // Intelligence Vault Category Search (for Add Tool modal)
            const intelligenceVaultCategorySearchInputAdd = document.getElementById('intelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInputAdd) {
                intelligenceVaultCategorySearchInputAdd.addEventListener('input', (e) => {
                    const currentSelections = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked')).map(cb => cb.value);
                    populateIntelligenceVaultCategoriesCheckboxesAddTool(currentSelections, e.target.value);
                });
            }

            // Intelligence Vault Category Search (for EDIT Tool modal, using unique ID)
            const intelligenceVaultCategorySearchInputEdit = document.getElementById('editIntelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInputEdit) {
                intelligenceVaultCategorySearchInputEdit.addEventListener('input', (e) => {
                    // Get the tool ID from the hidden input in the edit modal
                    const currentToolId = document.getElementById('editEntryId').value;
                    const toolToEdit = appState.tools.find(t => t.id === currentToolId);
                    if (toolToEdit) {
                        // Pass the tool's original categories (before filtering) and the current search term
                        populateIntelligenceVaultCategoriesCheckboxesEditTool(toolToEdit.intelligenceVaultCategories || [], e.target.value);
                    }
                });
            }

            // Form submission (Add Entry)
            document.getElementById('addEntryForm').addEventListener('submit', handleAddEntry);

            // Modal controls (Edit Entry)
            document.getElementById('cancelEditEntry').addEventListener('click', () => hideModal('editEntryModal'));
            // Custom category input (Edit Tool)
            document.getElementById('editToolCategory').addEventListener('change', (e) => {
                const editNewCategoryInput = document.getElementById('editNewCategoryInput');
                if (e.target.value === 'custom') {
                    editNewCategoryInput.style.display = 'block';
                    editNewCategoryInput.setAttribute('required', 'required');
                } else {
                    editNewCategoryInput.style.display = 'none';
                    editNewCategoryInput.removeAttribute('required');
                    editNewCategoryInput.value = ''; // Clear input if not custom
                }
            });
            // Form submission (Edit Entry)
            document.getElementById('editEntryForm').addEventListener('submit', handleEditEntry);

            // NEW: Add/Remove Metadata buttons in Add/Edit Entry forms
            document.getElementById('addMetadataBtn').addEventListener('click', () => addMetadataField('add'));
            document.getElementById('customMetadataEntries').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-metadata-btn')) {
                    e.target.closest('.form-group.metadata-entry').remove();
                }
            });
            document.getElementById('editAddMetadataBtn').addEventListener('click', () => addMetadataField('edit'));
            document.getElementById('editCustomMetadataEntries').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-metadata-btn')) {
                    e.target.closest('.form-group.metadata-entry').remove();
                }
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Quick actions
            document.getElementById('pinAllBtn').addEventListener('click', togglePinFilter);
            document.getElementById('starAllBtn').addEventListener('click', toggleStarFilter);
            document.getElementById('showAllBtn').addEventListener('click', clearFilters);
            document.getElementById('reportBtn').addEventListener('click', generateReport);

            // Clear filters (from empty state button)
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

            // Bulk actions
            document.getElementById('bulkStarBtn').addEventListener('click', () => bulkAction('star'));
            document.getElementById('bulkPinBtn').addEventListener('click', () => bulkAction('pin'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', () => bulkAction('delete'));

            // Export
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // View toggle (Grid/List)
            document.getElementById('viewToggle').addEventListener('click', toggleViewMode);
            // Intelligence Vault View Toggle
            document.getElementById('vaultViewToggle').addEventListener('click', toggleViewMode); // Both can use the same toggle
            //Multi Vault View Toggle
            document.getElementById('customVaultViewToggle').addEventListener('click', toggleViewMode);

            // Refresh Threats button
            document.getElementById('refreshThreatsBtn').addEventListener('click', loadThreats);

            // Custom Sub-tab buttons
            document.getElementById('createSubTabBtn').addEventListener('click', () => showCreateSubTabModal());
            document.getElementById('createSubTabBtnEmptyState').addEventListener('click', () => showCreateSubTabModal()); // For empty state button
            document.getElementById('cancelCreateSubTab').addEventListener('click', () => hideModal('createSubTabModal'));
            document.getElementById('createSubTabForm').addEventListener('submit', handleCreateSubTab);

            document.getElementById('editSubTabBtn').addEventListener('click', () => openEditSubTabModal());
            document.getElementById('cancelEditSubTab').addEventListener('click', () => hideModal('editSubTabModal'));
            document.getElementById('editSubTabForm').addEventListener('submit', handleEditSubTab);

            document.getElementById('deleteSubTabBtn').addEventListener('click', handleDeleteSubTab);
            document.getElementById('exportSubTabBtn').addEventListener('click', exportCustomTab);
            document.getElementById('newRandomBtn').addEventListener('click', showRandomDiscovery); // New: Random Tool/Tip button
            
            // New: Share options button and modal events
            document.getElementById('shareOptionsBtn').addEventListener('click', showShareOptionsModal);
            document.getElementById('cancelShareOptions').addEventListener('click', () => hideModal('shareOptionsModal'));
            document.getElementById('shareScopeSelect').addEventListener('change', handleShareScopeChange);
            document.getElementById('shareForm').addEventListener('submit', handleShareFormSubmit);


            // Click listener for custom sub-tabs (delegated)
            document.getElementById('customSubTabs').addEventListener('click', (e) => {
                const tabBtn = e.target.closest('.sub-nav-tab');
                if (tabBtn && tabBtn.dataset.subTabId) {
                    switchCustomTab(tabBtn.dataset.subTabId);
                }
            });

            // Event listener for custom tab checkboxes in Edit Tool Modal
            document.getElementById('assignCustomTabsCheckboxes').addEventListener('change', (e) => {
                if (e.target.classList.contains('custom-tab-assign-checkbox')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            });

            // Icon picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#newSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('newSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Icon picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#editedSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('editedSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Color picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#newSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('newSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

            // Color picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#editedSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('editedSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

        }



        // MODIFIED: Function to open the Add Tool Only Modal
        function openAddToolOnlyModal() {
            if (appState.readOnlyMode) {
                showToast("Cannot add tools in read-only shared view.", "warning");
                return;
            }
            document.getElementById('addToolOnlyForm').reset();
            populateCategoryFilterForAddToolOnly();

            // Clear search input and populate with no search term
            const intelligenceVaultCategorySearchInput = document.getElementById('intelligenceVaultCategorySearch');
            if (intelligenceVaultCategorySearchInput) { // Safety check
                intelligenceVaultCategorySearchInput.value = '';
            }
            populateIntelligenceVaultCategoriesCheckboxesAddTool([], ''); // Pass empty array for selections, empty string for search

            // Pre-select the current Intelligence Vault child tab, if applicable
            const checkboxes = document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === appState.currentIntelligenceVaultChildTab) {
                    checkbox.checked = true;
                    // Manually add 'checked' class to the label for visual feedback
                    checkbox.closest('.custom-tab-checkbox').classList.add('checked');
                } else {
                    checkbox.checked = false;
                    checkbox.closest('.custom-tab-checkbox').classList.remove('checked');
                }
            });

            document.getElementById('newToolOnlyCategoryInput').style.display = 'none';
            showModal('addToolOnlyModal');
        }

        // NEW: Populate Category dropdown for the Add Tool Only Modal
        function populateCategoryFilterForAddToolOnly() {
            const toolCategorySelect = document.getElementById('toolOnlyCategory');
            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));

            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation',
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other',
                'Phone Investigation', 'Telecom', 'Cryptocurrency Analysis', 'Geospatial Intelligence',
                'OSINT Mapping', 'Link Analysis', 'URL Analysis', 'Media Analysis', 'Video Analysis',
                'Password Analysis', 'Credential Analysis', 'Keyword Analysis', 'Text Analysis',
                'Social Media Analysis', 'Social Engineering'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...existingCategories]);

            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';

            Array.from(allCategories)
                .sort((a, b) => a.localeCompare(b))
                .forEach(category => {
                    const toolOption = document.createElement('option');
                    toolOption.value = category;
                    toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    toolCategorySelect.appendChild(toolOption);
                });

            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);
        }

        // MODIFIED: Populate "Where to add" checkboxes for the Add Tool Only Modal
        function populateIntelligenceVaultCategoriesCheckboxesAddTool(assignedCategories = [], searchTerm = '') {
            // Correct ID for ADD modal's checkboxes container
            const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesAddTool');
            if (!checkboxesContainer) return; // Safety check
            checkboxesContainer.innerHTML = '';

            // IMPORTANT: This array must contain ALL child tabs from your intelligenceVaultTabStructure
            const intelligenceVaultCategories = [
                // From General & Core
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
                { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
                { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' },
                { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' },

                // From Identity & Social
                { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
                { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
                { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
                { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
                { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
                { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' },

                // From Technical Footprints
                { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
                { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
                { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
                { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
                { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
                { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
                { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' },

                // From Cybersecurity Intel
                { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
                { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
                { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' },

                // From Breach & Leaks
                { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' },
                { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
                { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
                { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' },
                { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },

                // From Underground Sources
                { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' },
                { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
                { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
                { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
                { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },

                // From Media Analysis
                { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' },
                { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' },
                { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
                { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
                { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' },

                // From Operational Security (OPSEC)
                { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
                { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' },
                { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' },
                { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' },
            ];

            const filteredCategories = intelligenceVaultCategories.filter(category =>
                category.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredCategories.length === 0) {
                checkboxesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No matching categories.</p>';
                return;
            }

            filteredCategories.forEach(category => {
                const isChecked = assignedCategories.includes(category.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) checkboxContainer.classList.add('checked');

                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="intelligence-vault-category-checkbox-add-tool" value="${category.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${category.icon}" style="margin-right: 5px;"></i>
                    <span>${category.name}</span>
                `;
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Add event listener only once, if it hasn't been added yet to the wrapper
            const containerWrapper = document.getElementById('intelligenceVaultCategoriesAssignmentAddTool'); // Correct ID for ADD modal wrapper
            if (containerWrapper && !containerWrapper.dataset.listenerAdded) {
                containerWrapper.addEventListener('change', (e) => {
                    if (e.target.classList.contains('intelligence-vault-category-checkbox-add-tool')) {
                        const checkbox = e.target;
                        const label = checkbox.closest('.custom-tab-checkbox');
                        if (label) {
                            label.classList.toggle('checked', checkbox.checked);
                        }
                    }
                });
                containerWrapper.dataset.listenerAdded = 'true'; // Mark as added
            }
        }
// MODIFIED: populateIntelligenceVaultCategoriesCheckboxesEditTool (simplified listener attachment)
function populateIntelligenceVaultCategoriesCheckboxesEditTool(assignedCategories = [], searchTerm = '') {
    const container = document.getElementById('intelligenceVaultCategoriesAssignmentEditTool');
    if (!container) return;
    container.style.display = 'block';

    const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesEditTool');
    if (!checkboxesContainer) return;
    checkboxesContainer.innerHTML = ''; // Clear previous checkboxes

    // IMPORTANT: This array must contain ALL child tabs from your intelligenceVaultTabStructure
    const intelligenceVaultCategories = [
        // From General & Core
        { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
        { id: 'keywordTools', name: 'Keyword & Text Analysis', icon: 'fas fa-font' },
        { id: 'aiTools', name: 'AI & Generative Tools', icon: 'fas fa-brain' },
        { id: 'osintSearchEngines', name: 'OSINT-Specific Search', icon: 'fas fa-search-dollar' },
        { id: 'archivingTools', name: 'Archiving & Cache', icon: 'fas fa-archive' },

        // From Identity & Social
        { id: 'peopleSearchTools', name: 'People Search', icon: 'fas fa-id-card' },
        { id: 'usernameTools', name: 'Usernames & Handles', icon: 'fas fa-at' },
        { id: 'socialTools', name: 'Social Media Profiles', icon: 'fas fa-users' },
        { id: 'emailTools', name: 'Email Investigations', icon: 'fas fa-envelope' },
        { id: 'phoneTools', name: 'Phone Number Analysis', icon: 'fas fa-phone' },
        { id: 'messagingApps', name: 'Messaging Apps & Comms', icon: 'fas fa-comment-dots' },
        { id: 'datingApps', name: 'Dating Apps', icon: 'fas fa-heart' },

        // From Technical Footprints
        { id: 'domainIpUrlTools', name: 'Domain/IP/URL Analysis', icon: 'fas fa-link' },
        { id: 'geoIntTools', name: 'GEOINT & Mapping', icon: 'fas fa-map-marker-alt' },
        { id: 'cryptoTools', name: 'Crypto Wallets & Transactions', icon: 'fas fa-coins' },
        { id: 'darkWebTools', name: 'DarkWeb & Hidden Services', icon: 'fas fa-mask' },
        { id: 'metadataTools', name: 'Metadata Extractors', icon: 'fas fa-info' },
        { id: 'networkAnalysis', name: 'Network & System Analysis', icon: 'fas fa-network-wired' },
        { id: 'documentAnalysis', name: 'Document Analysis', icon: 'fas fa-file-alt' },

        // From Cybersecurity Intel
        { id: 'threatIntelligenceTools', name: 'Threat Intel Platforms', icon: 'fas fa-hand-fist' },
        { id: 'vulnerabilityTools', name: 'Vulnerability Research', icon: 'fas fa-bug' },
        { id: 'fileMalwareTools', name: 'File & Malware Analysis', icon: 'fas fa-file-code' },
        { id: 'honeypotMonitoring', name: 'Honeypot Monitoring', icon: 'fas fa-honey-pot' },
        { id: 'reverseEngineering', name: 'Reverse Engineering', icon: 'fas fa-cogs' },

        // From Breach & Leaks
        { id: 'passwordLeakTools', name: 'Password Leaks', icon: 'fas fa-key' },
        { id: 'credentialLeakTools', name: 'Credential Dumps', icon: 'fas fa-cloud-download-alt' },
        { id: 'dataBreachTools', name: 'Breached Databases', icon: 'fas fa-shield-virus' },
        { id: 'dumpSearchTools', name: 'General Data Dumps', icon: 'fas fa-dumpster' },
        { id: 'publicRecords', name: 'Public Records & Legal', icon: 'fas fa-scale-balanced' },

        // From Underground Sources
        { id: 'hackingForums', name: 'Hacking & Security Forums', icon: 'fas fa-user-secret' },
        { id: 'exploitMarkets', name: 'Exploit & Malware Markets', icon: 'fas fa-store-alt' },
        { id: 'vendorTracking', name: 'Underground Vendor Tracking', icon: 'fas fa-user-tag' },
        { id: 'telegramChannels', name: 'Telegram Channels', icon: 'fab fa-telegram-plane' },
        { id: 'pasteSites', name: 'Paste Sites', icon: 'fas fa-clipboard-list' },

        // From Media Analysis
        { id: 'imageAnalysis', name: 'Image Analysis & Forensics', icon: 'fas fa-camera' },
        { id: 'videoAnalysis', name: 'Video Analysis', icon: 'fas fa-video' },
        { id: 'audioAnalysis', name: 'Audio Analysis', icon: 'fas fa-volume-up' },
        { id: 'facialRecognition', name: 'Facial Recognition', icon: 'fas fa-face-id-card' },
        { id: 'geolocationMedia', name: 'Geolocation from Media', icon: 'fas fa-map-pin' },

        // From Operational Security (OPSEC)
        { id: 'anonymityTools', name: 'Anonymity & VPNs', icon: 'fas fa-mask' },
        { id: 'privacyTools', name: 'Privacy Enhancing Tools', icon: 'fas fa-user-shield' },
        { id: 'secureCommunication', name: 'Secure Communication', icon: 'fas fa-lock-open' },
        { id: 'personaManagement', name: 'Persona Management', icon: 'fas fa-id-badge' },
    ];

    const filteredCategories = intelligenceVaultCategories.filter(category =>
        category.name.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (filteredCategories.length === 0) {
        checkboxesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No matching categories.</p>';
        return;
    }

    filteredCategories.forEach(category => {
        const isChecked = assignedCategories.includes(category.id);
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        if (isChecked) checkboxContainer.classList.add('checked');

        checkboxContainer.innerHTML = `
            <input
                type="checkbox"
                class="intelligence-vault-category-checkbox-edit-tool"
                value="${category.id}"
                ${isChecked ? 'checked' : ''}
            >
            <i class="${category.icon}" style="margin-right: 5px;"></i>
            <span>${category.name}</span>
        `;
        checkboxesContainer.appendChild(checkboxContainer);
    });

    // Attach event listener directly to the checkboxesContainer.
    // This will replace the existing elements, so the old listeners are implicitly removed.
    checkboxesContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('intelligence-vault-category-checkbox-edit-tool')) {
            const checkbox = e.target;
            const label = checkbox.closest('.custom-tab-checkbox');
            if (label) {
                label.classList.toggle('checked', checkbox.checked);
            }
        }
    });
}
// NEW: Handle adding a new tool from the dedicated Intelligence Vault modal
    async function handleAddToolOnly(e) {
        e.preventDefault();
        if (appState.readOnlyMode) {
            showToast("Cannot add tools in read-only shared view.", "warning");
            return;
        }

        const toolName = document.getElementById('toolOnlyName').value.trim();
        const toolUrl = document.getElementById('toolOnlyUrl').value.trim();
        let toolCategory = document.getElementById('toolOnlyCategory').value;
        const newCategoryInput = document.getElementById('newToolOnlyCategoryInput').value.trim();
        const toolDescription = document.getElementById('toolOnlyDescription').value.trim();
        const toolTags = document.getElementById('toolOnlyTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

        const selectedIntelligenceVaultCategories = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesAddTool input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);

        if (!toolName || !toolUrl || !toolCategory) {
            showToast('Please fill in all required tool fields (Name, URL, Category).', 'error');
            return;
        }

        if (toolCategory === 'custom') {
            if (!newCategoryInput) {
                showToast('Please enter a custom category name.', 'error');
                return;
            }
            toolCategory = newCategoryInput.toLowerCase();
        }

        if (selectedIntelligenceVaultCategories.length === 0) {
            showToast('Please select at least one Intelligence Vault category for the tool.', 'error');
            return;
        }

        const newTool = {
            id: generateId(),
            type: 'tool',
            name: toolName,
            url: toolUrl,
            category: toolCategory,
            description: toolDescription,
            tags: toolTags,
            starred: false,
            pinned: false,
            favicon: `https://www.google.com/s2/favicons?domain=${new URL(toolUrl).hostname}`,
            lastUsed: 0,
            addedDate: new Date(),
            customTabs: [],
            intelligenceVaultCategories: selectedIntelligenceVaultCategories
        };

        appState.tools.push(newTool);
        hideModal('addToolOnlyModal');
        document.getElementById('addToolOnlyForm').reset();
        showToast('Tool added successfully!');
        updateStats();
        populateCategoryFilter();
        renderIntelligenceEntries();
        saveState();
    }



// MODIFIED: handleEntryAction function to include all new entry types
function handleEntryAction(e) {
    if (appState.readOnlyMode) { // Prevent actions in read-only mode
        showToast("Cannot perform actions in read-only shared view.", "warning");
        return;
    }

    const targetBtn = e.target.closest('.action-btn');
    if (!targetBtn) return;

    e.preventDefault();
    const action = targetBtn.dataset.action;
    const entryCard = e.target.closest('.tool-card'); // Still using tool-card class for styling
    const entryId = entryCard.dataset.entryId;
    const entryType = entryCard.dataset.entryType;

    let entry = null;
    let entryArray = null;

    // Determine which array to look into based on entryType (ensure plural names are consistent)
    switch (entryType) {
        case 'tool': entryArray = appState.tools; break;
        case 'email': entryArray = appState.emails; break;
        case 'phone': entryArray = appState.phones; break;
        case 'crypto': entryArray = appState.crypto; break;
        case 'location': entryArray = appState.locations; break;
        case 'link': entryArray = appState.links; break;
        case 'media': entryArray = appState.media; break;
        case 'password': entryArray = appState.passwords; break;
        case 'keyword': entryArray = appState.keywords; break;
        case 'social': entryArray = appState.socials; break;
        case 'domain': entryArray = appState.domains; break;
        case 'username': entryArray = appState.usernames; break;
        case 'threat': entryArray = appState.threats; break;
        case 'vulnerability': entryArray = appState.vulnerabilities; break;
        case 'malware': entryArray = appState.malware; break;
        case 'breach': entryArray = appState.breaches; break;
        case 'credential': entryArray = appState.credentials; break;
        case 'forum': entryArray = appState.forums; break;
        case 'vendor': entryArray = appState.vendors; break;
        case 'telegram': entryArray = appState.telegramChannels; break; // Use the renamed array
        case 'paste': entryArray = appState.pastes; break;
        case 'document': entryArray = appState.documents; break;
        case 'network': entryArray = appState.networks; break;
        case 'metadata': entryArray = appState.metadataEntries; break; // Use the renamed array
        case 'archive': entryArray = appState.archives; break;
        case 'messaging': entryArray = appState.messagingApps; break; // Use the renamed array
        case 'dating': entryArray = appState.datingProfiles; break; // Use the renamed array
        case 'facial': entryArray = appState.facialRecognition; break; // Use the renamed array
        case 'persona': entryArray = appState.personas; break; // Use the renamed array
        case 'vpn': entryArray = appState.vpns; break; // Use the renamed array
        case 'honeypot': entryArray = appState.honeypots; break;
        case 'exploit': entryArray = appState.exploits; break;
        case 'publicrecord': entryArray = appState.publicRecords; break;
        default:
            console.warn(`Unknown entry type for action: ${entryType}`);
            return;
    }

    if (entryArray) {
        entry = entryArray.find(t => t.id === entryId);
    }

    if (!entry) return;

    switch (action) {
        case 'edit':
            openEditEntryModal(entry);
            break;
        case 'star':
            entry.starred = !entry.starred;
            showToast(entry.starred ? 'Entry starred!' : 'Entry unstarred!');
            break;
        case 'pin':
            entry.pinned = !entry.pinned;
            showToast(entry.pinned ? 'Entry pinned!' : 'Entry unpinned!');
            break;
        case 'visit':
            // Allow visiting URL for any entry type that has a 'url' property
            if (entry.url) { // Check for .url property instead of just entry.type === 'tool'
                entry.lastUsed = Date.now(); // Update lastUsed timestamp
                appState.usageStats.toolsUsedToday++; // Increment usage stat (generic for now)
                updateAnalytics(); // Update analytics display
                window.open(entry.url, '_blank');
                showToast('Opening link...');
            } else {
                showToast('No URL available for this entry type.', 'info');
            }
            break;
        case 'delete':
            if (confirm('Are you sure you want to delete this entry?')) {
                // Remove entry from any custom tabs it belongs to
                appState.customTabs.forEach(tab => {
                    tab.toolIds = tab.toolIds.filter(id => id !== entryId);
                });

                if (entryArray) {
                    // Find index and remove
                    const index = entryArray.findIndex(e => e.id === entryId);
                    if (index > -1) {
                        entryArray.splice(index, 1);
                    }
                }
                appState.selectedEntries.delete(entryId); // Remove from selected if deleted
                showToast('Entry deleted!', 'error');
                updateStats();
                populateCategoryFilter(); // Recalculate categories (if a tool was deleted)
                renderCustomTabs(); // Re-render custom tabs to update counts/content
            }
            break;
    }

    renderIntelligenceEntries();
    updateStats(); // Also update stats bar after individual entry action
    saveState(); // Save state after any action
}

        // Handle bulk selection checkbox
        function handleBulkSelection(e) {
            if (appState.readOnlyMode) { // New: Prevent bulk selection in read-only mode
                e.target.checked = !e.target.checked; // Revert checkbox state
                showToast("Cannot select entries in read-only shared view.", "warning");
                return;
            }

            if (!e.target.classList.contains('bulk-checkbox')) return;
            
            const entryCard = e.target.closest('.tool-card');
            const entryId = entryCard.dataset.entryId;
            
            if (e.target.checked) {
                appState.selectedEntries.add(entryId);
            } else {
                appState.selectedEntries.delete(entryId);
            }
            
            updateBulkActions();
            entryCard.classList.toggle('selected', e.target.checked); // Visually mark selected
        }

        // Update bulk actions visibility and count
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (appState.readOnlyMode) { // New: Always hide bulk actions in read-only
                bulkActions.classList.remove('active');
                return;
            }

            if (appState.selectedEntries.size > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = appState.selectedEntries.size;
            } else {
                bulkActions.classList.remove('active');
            }
        }

 // Bulk actions (star, pin, delete selected)
function bulkAction(action) {
    if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
        showToast("Cannot perform bulk actions in read-only shared view.", "warning");
        return;
    }

    const selectedIds = Array.from(appState.selectedEntries);

    if (selectedIds.length === 0) {
        showToast(`No entries selected for ${action} action.`, 'warning');
        return;
    }

    if (action === 'delete' && !confirm('Are you sure you want to delete all selected entries?')) {
        return;
    }

    // Determine if all selected are already starred/pinned for toggling
    let allStarred = true;
    let allPinned = true;

    // Aggregate all entries from ALL appState arrays
    const allEntries = [
        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.facialRecognition,
        ...appState.personas, ...appState.vpns, ...appState.honeypots, ...appState.exploits,
        ...appState.publicRecords
    ];
    const selectedEntriesArray = allEntries.filter(entry => selectedIds.includes(entry.id));

    if (action === 'star' || action === 'pin') {
        allStarred = selectedEntriesArray.every(entry => entry.starred);
        allPinned = selectedEntriesArray.every(entry => entry.pinned);
    }

    selectedIds.forEach(id => {
        const entry = allEntries.find(e => e.id === id); // Find the actual entry object
        if (!entry) return;

        switch (action) {
            case 'star':
                entry.starred = !allStarred; // Toggle based on current state of all
                break;
            case 'pin':
                entry.pinned = !allPinned; // Toggle based on current state of all
                break;
            case 'delete':
                // Remove entry from any custom tabs it belongs to before deleting
                appState.customTabs.forEach(tab => {
                    tab.toolIds = tab.toolIds.filter(entryIdInTab => entryIdInTab !== id);
                });

                // Remove from its respective appState array based on its type
                const targetArrayKey = Object.keys(appState).find(key => Array.isArray(appState[key]) && appState[key].some(e => e.id === id));
                if (targetArrayKey) {
                    appState[targetArrayKey] = appState[targetArrayKey].filter(e => e.id !== id);
                }
                break;
        }
    });

    appState.selectedEntries.clear();
    updateBulkActions();
    renderIntelligenceEntries();
    updateStats();
    populateCategoryFilter();
    renderCustomTabs(); // Update custom tabs if entries were deleted
    showToast(`Bulk ${action} completed!`);
    saveState();
}

        // Quick actions (UPDATED)
        function togglePinFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'pinned') { // If already filtering by pinned, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'pinned'; // Set filter to show only pinned
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'pinned' ? 'Showing only pinned entries!' : 'Cleared pinned entries filter!');
        }

        function toggleStarFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'starred') { // If already filtering by starred, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'starred'; // Set filter to show only starred
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'starred' ? 'Showing only starred entries!' : 'Cleared starred entries filter!');
        }


        // Switch main tabs
        function switchTab(tabName) {
            // Update main tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                 targetTabContent.classList.add('active');
            }

            // Update appState and clear filters for new tab
            appState.currentTab = tabName;
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = '';
            document.getElementById('searchInput').value = '';

            // Hide all potential sub-tab containers and add entry buttons by default
            // This ensures a clean slate before showing relevant ones
            document.getElementById('intelligenceVaultParentTabs').style.display = 'none';
            document.getElementById('intelligenceVaultChildTabs').style.display = 'none';
            document.getElementById('customVaultEntryParentTabs').style.display = 'none';
            document.getElementById('customVaultEntryChildTabs').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none'; 

            // Specific logic for each main tab
            if (tabName === 'intelligence-vault') {
                document.getElementById('intelligenceVaultParentTabs').style.display = 'flex'; // Show parent tabs
                renderIntelligenceVaultParentTabs(); // This will populate parent tabs and activate current one

                // This will then call switchIntelligenceVaultParentTab which will render and activate children
                // and switchIntelligenceVaultChildTab will be called from there.
                // Ensure a valid parent is selected, default if current one is invalid
                const currentIntelParent = intelligenceVaultTabStructure.find(p => p.id === appState.currentIntelligenceVaultParentTab);
                if (!currentIntelParent) {
                    appState.currentIntelligenceVaultParentTab = intelligenceVaultTabStructure[0].id;
                }
                // Call switchIntelligenceVaultParentTab to trigger child tab rendering and activation
                switchIntelligenceVaultParentTab(appState.currentIntelligenceVaultParentTab);


                // Show the "Add New Tool" button
                if (!appState.readOnlyMode) {
                    document.getElementById('addToolBtnIntelligenceVault').style.display = 'inline-flex';
                }

            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render main custom tabs (the list of custom vaults)

                // Only proceed to render/switch parent/child entry tabs if custom vaults exist
                if (appState.customTabs.length > 0) {
                    document.getElementById('customVaultEntryParentTabs').style.display = 'flex'; // Show parent tabs for entries
                    renderCustomVaultParentTabs(); // Render custom vault entry parent tabs

                    // Ensure a valid parent is selected, default if current one is invalid
                    const currentCustomParent = customVaultEntryStructure.find(p => p.id === appState.currentCustomVaultParentTab);
                    if (!currentCustomParent) {
                        appState.currentCustomVaultParentTab = customVaultEntryStructure[0].id;
                    }
                    // Ensure a valid child is selected under the current parent, default if invalid
                    const currentCustomChild = currentCustomParent.children.find(c => c.id === appState.currentCustomVaultEntrySubTab);
                    if (!currentCustomChild) {
                        appState.currentCustomVaultEntrySubTab = currentCustomParent.children[0]?.id;
                    }
                    // Now, switch to the determined parent and then its child
                    switchCustomVaultParentTab(appState.currentCustomVaultParentTab);

                    // Show the "Add New Entry" button for custom vaults
                    if (!appState.readOnlyMode) {
                        document.getElementById('addEntryBtnCustomVault').style.display = 'inline-flex';
                    }
                }

            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'handbook') {
                initHandbookAndNotes(); // Ensure handbook and notes are initialized
            }

            renderIntelligenceEntries(); // Always re-render entries relevant to the currently active main tab
            saveState(); // Save state after tab switch
        }

        // Switch Intelligence Vault Sub-tabs (now show tools)
        function switchIntelligenceVaultSubTab(subTabName) {
            document.querySelectorAll('.intelligence-vault-sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.intelligence-vault-sub-tab[data-sub-tab="${subTabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            appState.currentIntelligenceVaultSubTab = subTabName;
            appState.filters.category = ''; // Clear category filter when switching intel vault sub-tabs
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant tools
            saveState();
        }

        // MODIFIED: Switch Custom Vault Entry Child Sub-tabs (now show collected evidence)
        function switchCustomVaultEntrySubTab(childTabName) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all child tabs
            document.querySelectorAll('.custom-vault-entry-child-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked child tab
            const targetChildTabBtn = document.querySelector(`.custom-vault-entry-child-tab[data-child-tab="${childTabName}"]`);
            if (targetChildTabBtn) {
                targetChildTabBtn.classList.add('active');
            }

            appState.currentCustomVaultEntrySubTab = childTabName;
            // When switching entry sub-tabs in a custom vault, clear tool category filter as it's not applicable
            appState.filters.category = '';
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries(); // Rerender to show relevant entries
            saveState();
        }

        
        // NEW: Render Custom Vault Parent Tabs
        function renderCustomVaultParentTabs() {
            const parentTabsContainer = document.getElementById('customVaultEntryParentTabs');
            if (!parentTabsContainer) return;

            parentTabsContainer.innerHTML = customVaultEntryStructure.map(parentTab => `
                <button class="nav-tab custom-vault-entry-parent-tab" data-parent-tab="${parentTab.id}">
                    <i class="${parentTab.icon}"></i>
                    ${parentTab.name}
                </button>
            `).join('');

            // Add event listeners for parent tabs (delegation handled in bindEvents)

            // Activate the currently selected parent tab
            const activeParentBtn = document.querySelector(`.custom-vault-entry-parent-tab[data-parent-tab="${appState.currentCustomVaultParentTab}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }
        }

        // NEW: Switch Custom Vault Parent Tab
        function switchCustomVaultParentTab(parentId) {
            if (appState.readOnlyMode) {
                showToast("Cannot switch categories in read-only shared view.", "warning");
                return;
            }

            // Deactivate all parent tabs
            document.querySelectorAll('.custom-vault-entry-parent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activate the clicked parent tab
            const activeParentBtn = document.querySelector(`.custom-vault-entry-parent-tab[data-parent-tab="${parentId}"]`);
            if (activeParentBtn) {
                activeParentBtn.classList.add('active');
            }

            appState.currentCustomVaultParentTab = parentId;

            // Find the selected parent tab's children
            const selectedParent = customVaultEntryStructure.find(p => p.id === parentId);
            const childTabsContainer = document.getElementById('customVaultEntryChildTabs');

            if (selectedParent && childTabsContainer) {
                childTabsContainer.style.display = 'flex'; // Show the child tabs container
                childTabsContainer.innerHTML = selectedParent.children.map(childTab => `
                    <button class="sub-nav-tab custom-vault-entry-child-tab" data-child-tab="${childTab.id}">
                        <i class="${childTab.icon}"></i> ${childTab.name}
                    </button>
                `).join('');

                // Remove existing child tab listeners (already handled by bindEvents delegation)

                // Automatically activate the first child tab or the previously selected child tab under this parent
                let childToActivate = appState.currentCustomVaultEntrySubTab;
                if (!selectedParent.children.some(c => c.id === childToActivate)) {
                    childToActivate = selectedParent.children[0]?.id; // Default to first child if current is not in this parent
                }
                if (childToActivate) {
                    switchCustomVaultEntrySubTab(childToActivate);
                } else {
                    // No child tabs for this parent, clear display
                    appState.currentCustomVaultEntrySubTab = null;
                    appState.filters.category = '';
                    renderIntelligenceEntries();
                }

            } else {
                childTabsContainer.style.display = 'none'; // Hide if no children or container not found
                appState.currentCustomVaultEntrySubTab = null;
                appState.filters.category = '';
                renderIntelligenceEntries();
            }

            saveState(); // Save the parent tab state
        }


        // Load threat intelligence
        function loadThreats() {
            const threatsList = document.getElementById('threatsList');
            const mockThreats = [
                {
                    id: 1,
                    title: 'New Phishing Campaign Detected',
                    description: 'Targeting financial institutions with COVID-19 themed lures. Be cautious of emails resembling official health advisories.',
                    severity: 'high',
                    tags: ['phishing', 'covid-19', 'financial', 'email'],
                    timestamp: new Date(Date.now() - 3600000)
                },
                {
                    id: 2,
                    title: 'Malware Sample Analysis: Xylos Variant',
                    description: 'New variant of banking trojan "Xylos" discovered in the wild. It employs obfuscation techniques and targets online banking portals. Update your antivirus signatures immediately.',
                    severity: 'medium',
                    tags: ['malware', 'banking', 'trojan', 'xylos', 'analysis'],
                    timestamp: new Date(Date.now() - 7200000)
                },
                {
                    id: 3,
                    title: 'Data Breach Alert: Gaming Platform',
                    description: 'Credentials leak detected on underground forums originating from a popular gaming platform. Users are advised to change passwords and enable multi-factor authentication.',
                    severity: 'high',
                    tags: ['breach', 'credentials', 'darkweb', 'gaming'],
                    timestamp: new Date(Date.now() - 10800000)
                },
                {
                    id: 4,
                    title: 'Ransomware Attack on Healthcare Provider',
                    description: 'A critical ransomware attack impacted a regional healthcare provider, compromising patient data. Incident response teams are engaged, and data recovery efforts are underway. Backups are crucial!',
                    severity: 'high',
                    tags: ['ransomware', 'healthcare', 'data-loss', 'cyberattack'],
                    timestamp: new Date(Date.now() - 86400000 * 2) // 2 days ago
                },
                {
                    id: 5,
                    title: 'Zero-Day Exploit in Popular Web Server',
                    description: 'A zero-day vulnerability has been identified in a widely used web server software. Patches are not yet available. Organizations are advised to implement temporary mitigation strategies and monitor their logs closely.',
                    severity: 'medium',
                    tags: ['zero-day', 'vulnerability', 'web-server', 'exploit'],
                    timestamp: new Date(Date.now() - 86400000 * 5) // 5 days ago
                }
            ];

            // Sort threats by timestamp (most recent first)
            mockThreats.sort((a, b) => b.timestamp - a.timestamp);

            threatsList.innerHTML = mockThreats.map(threat => `
                <div class="threat-item">
                    <div class="threat-header">
                        <h4>${threat.title}</h4> <div class="threat-level threat-${threat.severity}">${threat.severity}</div> </div>
                    <p>${threat.description}</p> <div class="threat-tags">
                        ${threat.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="threat-time">${formatTime(threat.timestamp)}</div>
                </div>
            `).join('');

        }

        // Update analytics data (display)
        function updateAnalytics() {
            document.getElementById('toolsUsed').textContent = appState.usageStats.toolsUsedToday;
            renderMostUsedTools();
            renderNeverUsedTools();
            renderToolsAddedPerWeek();

            saveState();
        }

        function renderMostUsedTools() {
            const mostUsedToolsList = document.getElementById('mostUsedToolsList');
            const noMostUsedTools = document.getElementById('noMostUsedTools');
            
            // Combine all entry types that have lastUsed property and filter
            const allUsedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials]
                                    .filter(entry => entry.lastUsed > 0);

            const usedTools = allUsedEntries.sort((a, b) => b.lastUsed - a.lastUsed)
                                            .slice(0, 5); //
                  mostUsedToolsList.innerHTML = '';
            if (usedTools.length === 0) {
                noMostUsedTools.style.display = 'block';
            } else {
                noMostUsedTools.style.display = 'none';
                usedTools.forEach(entry => {
                    const listItem = document.createElement('li');
                    let name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    listItem.innerHTML = `<span>${name}</span><span>${formatTime(entry.lastUsed)}</span>`;
                    mostUsedToolsList.appendChild(listItem);
                });
            }
        }

        function renderNeverUsedTools() {
            const neverUsedToolsList = document.getElementById('neverUsedToolsList');
            const noNeverUsedTools = document.getElementById('noNeverUsedTools');

            // Combine all entry types
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            const neverUsed = allEntries.filter(entry => !entry.lastUsed || entry.lastUsed === 0)
                                        .sort((a, b) => {
                                            const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                                            const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                                            return nameA.localeCompare(nameB);
                                        });

            neverUsedToolsList.innerHTML = '';
            if (neverUsed.length === 0) {
                noNeverUsedTools.style.display = 'block';
            } else {
                noNeverUsedTools.style.display = 'none';
                neverUsed.forEach(entry => {
                    const listItem = document.createElement('li');
                    let name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    listItem.innerHTML = `<span>${name}</span><span>Never Used</span>`;
                    neverUsedToolsList.appendChild(listItem);
                });
            }
        }

        function renderToolsAddedPerWeek() {
            const toolsAddedPerWeekList = document.getElementById('toolsAddedPerWeekList');
            const noToolsAdded = document.getElementById('noToolsAdded');

            // Combine all entries that have an addedDate
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];

            const weeklyStats = {};
            allEntries.forEach(entry => {
                if (entry.addedDate) {
                    const date = new Date(entry.addedDate);
                    // Get the start of the week (e.g., Monday)
                    const day = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
                    const startOfWeek = new Date(date.setDate(diff));
                    startOfWeek.setHours(0, 0, 0, 0); // Normalize to start of day

                    const weekKey = startOfWeek.toISOString().split('T')[0]; // YYYY-MM-DD for week start
                    weeklyStats[weekKey] = (weeklyStats[weekKey] || 0) + 1;
                }
            });

            const sortedWeeks = Object.keys(weeklyStats).sort((a, b) => new Date(b) - new Date(a));

            toolsAddedPerWeekList.innerHTML = '';
            if (sortedWeeks.length === 0) {
                noToolsAdded.style.display = 'block';
            } else {
                noToolsAdded.style.display = 'none';
                sortedWeeks.forEach(weekKey => {
                    const count = weeklyStats[weekKey];
                    const weekStartDate = new Date(weekKey);
                    const options = {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    };
                    const formattedWeek = weekStartDate.toLocaleDateString(undefined, options);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>Week of ${formattedWeek}</span><span>${count} entries</span>`;
                    toolsAddedPerWeekList.appendChild(listItem);
                });
            }
        }


        // Format time for display
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp; // Difference in milliseconds

            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30.44); // Average days in a month
            const years = Math.floor(days / 365.25); // Average days in a year

            if (seconds < 60) {
                return seconds === 0 ? 'Just now' : `${seconds} second${seconds === 1 ? '' : 's'} ago`;
            } else if (minutes < 60) {
                return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
            } else if (hours < 24) {
                return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            } else if (days < 7) {
                return `${days} day${days === 1 ? '' : 's'} ago`;
            } else if (weeks < 4) {
                return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
            } else if (months < 12) {
                return `${months} month${months === 1 ? '' : 's'} ago`;
            } else {
                return `${years} year${years === 1 ? '' : 's'} ago`;
            }
        }


        // Universal Modal Functions
        function showModal(id) {
            document.getElementById(id).classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent scrolling background
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Display appropriate form fields based on selected entry type
        function displayEntryForm() {
            const entryType = document.getElementById('entryTypeSelect').value;
            document.querySelectorAll('.entry-fields').forEach(fieldSet => {
                fieldSet.style.display = 'none';
            });
            document.getElementById('entrySourceGroup').style.display = 'none'; // Hide by default
            document.getElementById('customMetadataGroup').style.display = 'none'; // Hide by default

            let fieldsToShow = [];
            switch (entryType) {
                case 'tool':
                    fieldsToShow = ['addToolFields'];
                    break;
                case 'email':
                    fieldsToShow = ['addEmailFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'phone':
                    fieldsToShow = ['addPhoneFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'crypto':
                    fieldsToShow = ['addCryptoFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'location':
                    fieldsToShow = ['addLocationFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'link':
                    fieldsToShow = ['addLinkFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'media':
                    fieldsToShow = ['addMediaFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'password':
                    fieldsToShow = ['addPasswordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'keyword':
                    fieldsToShow = ['addKeywordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'social':
                    fieldsToShow = ['addSocialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'domain':
                    fieldsToShow = ['addDomainFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'username':
                    fieldsToShow = ['addUsernameFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'threat':
                    fieldsToShow = ['addThreatFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'vulnerability':
                    fieldsToShow = ['addVulnerabilityFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'malware':
                    fieldsToShow = ['addMalwareFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'breach':
                    fieldsToShow = ['addBreachFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'credential':
                    fieldsToShow = ['addCredentialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'forum':
                    fieldsToShow = ['addForumFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'vendor':
                    fieldsToShow = ['addVendorFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'telegram':
                    fieldsToShow = ['addTelegramFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'paste':
                    fieldsToShow = ['addPasteFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'document':
                    fieldsToShow = ['addDocumentFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'network':
                    fieldsToShow = ['addNetworkFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'metadata':
                    fieldsToShow = ['addMetadataEntryFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'archive':
                    fieldsToShow = ['addArchiveFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'messaging':
                    fieldsToShow = ['addMessagingFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'dating':
                    fieldsToShow = ['addDatingFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'facial':
                    fieldsToShow = ['addFacialFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'persona':
                    fieldsToShow = ['addPersonaFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'vpn':
                    fieldsToShow = ['addVpnFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'honeypot':
                    fieldsToShow = ['addHoneypotFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'exploit':
                    fieldsToShow = ['addExploitFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                case 'publicrecord':
                    fieldsToShow = ['addPublicRecordFields', 'entrySourceGroup', 'customMetadataGroup'];
                    break;
                default:
                    // This case should ideally not be hit if all options are covered
                    console.warn(`No form fields defined for entry type: ${entryType}`);
                    break;
            }

            fieldsToShow.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'block';
                }
            });

            // Populate category dropdown for tools (if 'tool' is selected)
            if (entryType === 'tool') {
                populateCategoryFilter();
            }
        }

// MODIFIED: handleAddEntry (ensure new array names are used)
async function handleAddEntry(e) {
    e.preventDefault();
    if (appState.readOnlyMode) {
        showToast("Cannot add entries in read-only shared view.", "warning");
        return;
    }

    const entryType = document.getElementById('entryTypeSelect').value;
    let newEntry = {
        id: generateId(),
        type: entryType,
        starred: false,
        pinned: false,
        lastUsed: 0,
        addedDate: new Date(),
        customTabs: [],
        origin: 'user-added'
    };

    const customMetadata = [];
    document.querySelectorAll('#customMetadataEntries .metadata-entry').forEach(row => {
        const keyInput = row.querySelector('.metadata-key');
        const valueInput = row.querySelector('.metadata-value');
        const key = keyInput ? keyInput.value.trim() : '';
        const value = valueInput ? valueInput.value.trim() : '';
        if (key && value) {
            customMetadata.push({ key, value });
        }
    });
    if (customMetadata.length > 0) {
        newEntry.metadata = customMetadata;
    }

    const entrySourceInput = document.getElementById('entrySource');
    if (entrySourceInput && entrySourceInput.value.trim()) {
        newEntry.source = entrySourceInput.value.trim();
    }


    switch (entryType) {
        case 'tool':
            newEntry.name = document.getElementById('toolName').value.trim();
            newEntry.url = document.getElementById('toolUrl').value.trim();
            let toolCategory = document.getElementById('toolCategory').value;
            const newCategoryInput = document.getElementById('newCategoryInput').value.trim();
            newEntry.description = document.getElementById('toolDescription').value.trim();
            newEntry.tags = document.getElementById('toolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.notes = document.getElementById('toolInvestigationNotes').value.trim();

            if (!newEntry.name || !newEntry.url || !toolCategory) { showToast('Please fill in all required tool fields (Name, URL, Category).', 'error'); return; }
            if (toolCategory === 'custom') {
                if (!newCategoryInput) { showToast('Please enter a custom category name.', 'error'); return; }
                toolCategory = newCategoryInput.toLowerCase();
            }
            newEntry.category = toolCategory;
            newEntry.favicon = `https://www.google.com/s2/favicons?domain=${new URL(newEntry.url).hostname}`;
            appState.tools.push(newEntry);
            break;
        case 'email':
            newEntry.email = document.getElementById('emailAddress').value.trim();
            newEntry.linkedPlatforms = document.getElementById('emailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p);
            newEntry.breachResults = document.getElementById('emailBreachResults').value.trim();
            newEntry.description = document.getElementById('emailDescription').value.trim();
            newEntry.notes = document.getElementById('emailNotes').value.trim();
            if (!newEntry.email) { showToast('Please enter an email address.', 'error'); return; }
            appState.emails.push(newEntry);
            break;
        case 'phone':
            newEntry.number = document.getElementById('phoneNumber').value.trim();
            newEntry.phoneType = document.getElementById('phoneType').value;
            newEntry.location = document.getElementById('phoneLocation').value.trim();
            newEntry.description = document.getElementById('phoneDescription').value.trim();
            newEntry.notes = document.getElementById('phoneNotes').value.trim();
            if (!newEntry.number) { showToast('Please enter a phone number.', 'error'); return; }
            appState.phones.push(newEntry);
            break;
        case 'crypto':
            newEntry.address = document.getElementById('cryptoAddress').value.trim();
            newEntry.txid = document.getElementById('cryptoTxid').value.trim();
            newEntry.amount = parseFloat(document.getElementById('cryptoAmount').value);
            newEntry.source = document.getElementById('cryptoSource').value.trim();
            newEntry.tags = document.getElementById('cryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.description = document.getElementById('cryptoDescription').value.trim();
            newEntry.notes = document.getElementById('cryptoNotes').value.trim();
            if (!newEntry.address || !newEntry.txid || isNaN(newEntry.amount)) { showToast('Please fill in all required crypto fields (Address, TXID, Amount).', 'error'); return; }
            appState.crypto.push(newEntry);
            break;
        case 'location':
            newEntry.name = document.getElementById('locationName').value.trim();
            newEntry.coordinates = document.getElementById('locationCoordinates').value.trim();
            newEntry.mapLink = document.getElementById('locationMapLink').value.trim();
            newEntry.ipGeoIntel = document.getElementById('locationIpGeoIntel').value.trim();
            newEntry.description = document.getElementById('locationDescription').value.trim();
            newEntry.notes = document.getElementById('locationNotes').value.trim();
            if (!newEntry.name || !newEntry.coordinates) { showToast('Please fill in all required location fields (Name, Coordinates).', 'error'); return; }
            appState.locations.push(newEntry);
            break;
        case 'link':
            newEntry.url = document.getElementById('linkUrl').value.trim();
            newEntry.platform = document.getElementById('linkPlatform').value.trim();
            newEntry.tags = document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.description = document.getElementById('linkDescription').value.trim();
            newEntry.notes = document.getElementById('linkNotes').value.trim();
            if (!newEntry.url) { showToast('Please enter a URL.', 'error'); return; }
            appState.links.push(newEntry);
            break;
        case 'media':
            newEntry.title = document.getElementById('mediaTitle').value.trim();
            newEntry.mediaType = document.getElementById('mediaType').value;
            const mediaFile = document.getElementById('mediaFile').files[0];
            newEntry.description = document.getElementById('mediaDescription').value.trim();
            newEntry.notes = document.getElementById('mediaNotes').value.trim();
            
            if (!newEntry.title) { showToast('Please enter a title for the media.', 'error'); return; }
            if (mediaFile) {
                newEntry.base64Data = await readFileAsBase64(mediaFile);
            } else {
                showToast('Please upload a file for media entry.', 'error');
                return;
            }
            appState.media.push(newEntry);
            break;
        case 'password':
            newEntry.service = document.getElementById('passwordService').value.trim();
            newEntry.username = document.getElementById('passwordUsername').value.trim();
            newEntry.password = document.getElementById('passwordValue').value.trim();
            newEntry.strength = document.getElementById('passwordStrength').value.trim();
            newEntry.description = document.getElementById('passwordDescription').value.trim();
            newEntry.notes = document.getElementById('passwordNotes').value.trim();
            if (!newEntry.service || !newEntry.password) { showToast('Please fill in all required password fields (Service, Password).', 'error'); return; }
            appState.passwords.push(newEntry);
            break;
        case 'keyword':
            newEntry.value = document.getElementById('keywordValue').value.trim();
            newEntry.context = document.getElementById('keywordContext').value.trim();
            newEntry.description = document.getElementById('keywordDescription').value.trim();
            newEntry.notes = document.getElementById('keywordNotes').value.trim();
            if (!newEntry.value) { showToast('Please enter a keyword/phrase.', 'error'); return; }
            appState.keywords.push(newEntry);
            break;
        case 'social':
            newEntry.platform = document.getElementById('socialPlatform').value.trim();
            newEntry.url = document.getElementById('socialUrl').value.trim();
            newEntry.username = document.getElementById('socialUsername').value.trim();
            newEntry.followCounts = document.getElementById('socialFollowCounts').value.trim();
            newEntry.description = document.getElementById('socialDescription').value.trim();
            newEntry.notes = document.getElementById('socialNotes').value.trim();
            if (!newEntry.platform || !newEntry.url || !newEntry.username) { showToast('Please fill in all required social profile fields (Platform, URL, Username).', 'error'); return; }
            appState.socials.push(newEntry);
            break;
        case 'domain':
            newEntry.value = document.getElementById('domainValue').value.trim();
            newEntry.domainType = document.getElementById('domainType').value;
            newEntry.registrar = document.getElementById('domainRegistrar').value.trim();
            newEntry.location = document.getElementById('domainLocation').value.trim();
            newEntry.status = document.getElementById('domainStatus').value;
            newEntry.whois = document.getElementById('domainWhois').value.trim();
            newEntry.dns = document.getElementById('domainDns').value.trim();
            newEntry.tags = document.getElementById('domainTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.description = document.getElementById('domainDescription').value.trim();
            newEntry.notes = document.getElementById('domainNotes').value.trim();
            if (!newEntry.value || !newEntry.domainType) { showToast('Please fill in all required domain fields (Domain/IP/URL, Type).', 'error'); return; }
            appState.domains.push(newEntry);
            break;
        case 'username':
            newEntry.value = document.getElementById('usernameValue').value.trim();
            newEntry.platformsFound = document.getElementById('usernamePlatforms').value.trim();
            newEntry.emails = document.getElementById('usernameEmails').value.trim();
            newEntry.realName = document.getElementById('usernameRealName').value.trim();
            newEntry.activity = document.getElementById('usernameActivity').value;
            newEntry.description = document.getElementById('usernameDescription').value.trim();
            newEntry.notes = document.getElementById('usernameNotes').value.trim();
            if (!newEntry.value) { showToast('Please enter a username/handle.', 'error'); return; }
            appState.usernames.push(newEntry);
            break;
        case 'threat':
            newEntry.threatType = document.getElementById('threatType').value;
            newEntry.name = document.getElementById('threatName').value.trim();
            newEntry.severity = document.getElementById('threatSeverity').value;
            newEntry.iocs = document.getElementById('threatIocs').value.trim();
            newEntry.targets = document.getElementById('threatTargets').value.trim();
            newEntry.attribution = document.getElementById('threatAttribution').value.trim();
            newEntry.description = document.getElementById('threatDescription').value.trim();
            newEntry.source = document.getElementById('threatSource').value.trim();
            newEntry.notes = document.getElementById('threatNotes').value.trim();
            if (!newEntry.name || !newEntry.threatType) { showToast('Please fill in all required threat fields (Name/ID, Type).', 'error'); return; }
            appState.threats.push(newEntry);
            break;
        case 'vulnerability':
            newEntry.cve = document.getElementById('vulnCve').value.trim();
            newEntry.cvss = parseFloat(document.getElementById('vulnCvss').value);
            newEntry.software = document.getElementById('vulnSoftware').value.trim();
            newEntry.vulnType = document.getElementById('vulnType').value;
            newEntry.exploit = document.getElementById('vulnExploit').value;
            newEntry.description = document.getElementById('vulnDescription').value.trim();
            newEntry.mitigation = document.getElementById('vulnMitigation').value.trim();
            newEntry.notes = document.getElementById('vulnNotes').value.trim();
            if (!newEntry.cve) { showToast('Please enter a CVE ID.', 'error'); return; }
            appState.vulnerabilities.push(newEntry);
            break;
        case 'malware':
            newEntry.filename = document.getElementById('malwareFilename').value.trim();
            newEntry.hash = document.getElementById('malwareHash').value.trim();
            newEntry.fileType = document.getElementById('malwareType').value;
            newEntry.family = document.getElementById('malwareFamily').value.trim();
            newEntry.detection = document.getElementById('malwareDetection').value.trim();
            newEntry.behavior = document.getElementById('malwareBehavior').value.trim();
            newEntry.source = document.getElementById('malwareSource').value.trim();
            newEntry.tools = document.getElementById('malwareTools').value.trim();
            newEntry.notes = document.getElementById('malwareNotes').value.trim();
            if (!newEntry.filename || !newEntry.hash) { showToast('Please fill in all required malware fields (File Name, File Hash).', 'error'); return; }
            appState.malware.push(newEntry);
            break;
        case 'breach':
            newEntry.company = document.getElementById('breachCompany').value.trim();
            newEntry.date = document.getElementById('breachDate').value;
            newEntry.records = parseInt(document.getElementById('breachRecords').value);
            newEntry.dataTypes = document.getElementById('breachDataTypes').value.trim();
            newEntry.vector = document.getElementById('breachVector').value;
            newEntry.status = document.getElementById('breachStatus').value;
            newEntry.source = document.getElementById('breachSource').value.trim();
            newEntry.description = document.getElementById('breachDescription').value.trim();
            newEntry.notes = document.getElementById('breachNotes').value.trim();
            if (!newEntry.company || !newEntry.date) { showToast('Please fill in all required breach fields (Company/Organization, Breach Date).', 'error'); return; }
            appState.breaches.push(newEntry);
            break;
        case 'credential':
            newEntry.credentialType = document.getElementById('credentialType').value;
            newEntry.credentialValue = document.getElementById('credentialValue').value.trim();
            newEntry.credentialService = document.getElementById('credentialService').value.trim();
            newEntry.breachSource = document.getElementById('credentialBreachSource').value.trim();
            newEntry.dateFound = document.getElementById('credentialDateFound').value;
            newEntry.description = document.getElementById('credentialDescription').value.trim();
            newEntry.notes = document.getElementById('credentialNotes').value.trim();
            if (!newEntry.credentialValue) { showToast('Please enter the credential value.', 'error'); return; }
            appState.credentials.push(newEntry);
            break;
        case 'forum':
            newEntry.forumName = document.getElementById('forumName').value.trim();
            newEntry.forumUrl = document.getElementById('forumUrl').value.trim();
            newEntry.forumType = document.getElementById('forumType').value;
            newEntry.forumStatus = document.getElementById('forumStatus').value;
            newEntry.forumLanguage = document.getElementById('forumLanguage').value.trim();
            newEntry.description = document.getElementById('forumDescription').value.trim();
            newEntry.notes = document.getElementById('forumNotes').value.trim();
            if (!newEntry.forumName || !newEntry.forumUrl) { showToast('Please fill in all required forum fields (Name, URL).', 'error'); return; }
            appState.forums.push(newEntry);
            break;
        case 'vendor':
            newEntry.vendorAlias = document.getElementById('vendorAlias').value.trim();
            newEntry.vendorPlatforms = document.getElementById('vendorPlatforms').value.trim();
            newEntry.vendorProducts = document.getElementById('vendorProducts').value.trim();
            newEntry.vendorReputation = document.getElementById('vendorReputation').value.trim();
            newEntry.description = document.getElementById('vendorDescription').value.trim();
            newEntry.notes = document.getElementById('vendorNotes').value.trim();
            if (!newEntry.vendorAlias) { showToast('Please enter a vendor name/alias.', 'error'); return; }
            appState.vendors.push(newEntry);
            break;
        case 'telegram':
            newEntry.name = document.getElementById('telegramName').value.trim();
            newEntry.url = document.getElementById('telegramUrl').value.trim();
            newEntry.telegramType = document.getElementById('telegramType').value;
            newEntry.subscribers = parseInt(document.getElementById('telegramSubscribers').value);
            newEntry.language = document.getElementById('telegramLanguage').value.trim();
            newEntry.activity = document.getElementById('telegramActivity').value;
            newEntry.content = document.getElementById('telegramContent').value.trim();
            newEntry.admin = document.getElementById('telegramAdmin').value.trim();
            newEntry.tags = document.getElementById('telegramTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            newEntry.notes = document.getElementById('telegramNotes').value.trim();
            if (!newEntry.name || !newEntry.url) { showToast('Please fill in all required Telegram fields (Channel Name, URL).', 'error'); return; }
            appState.telegramChannels.push(newEntry);
            break;
        case 'paste':
            newEntry.url = document.getElementById('pasteUrl').value.trim();
            newEntry.sourceSite = document.getElementById('pasteSourceSite').value.trim();
            newEntry.contentSummary = document.getElementById('pasteContentSummary').value.trim();
            newEntry.keywords = document.getElementById('pasteKeywords').value.trim();
            newEntry.description = document.getElementById('pasteDescription').value.trim();
            newEntry.notes = document.getElementById('pasteNotes').value.trim();
            if (!newEntry.url) { showToast('Please enter a Paste URL.', 'error'); return; }
            appState.pastes.push(newEntry);
            break;
        case 'document':
            newEntry.title = document.getElementById('documentTitle').value.trim();
            newEntry.fileType = document.getElementById('documentFileType').value.trim();
            newEntry.hash = document.getElementById('documentHash').value.trim();
            newEntry.contentSummary = document.getElementById('documentContentSummary').value.trim();
            newEntry.source = document.getElementById('documentSource').value.trim();
            newEntry.description = document.getElementById('documentDescription').value.trim();
            newEntry.notes = document.getElementById('documentNotes').value.trim();
            if (!newEntry.title || !newEntry.hash) { showToast('Please fill in all required document fields (Title, File Hash).', 'error'); return; }
            appState.documents.push(newEntry);
            break;
        case 'network':
            newEntry.subject = document.getElementById('networkSubject').value.trim();
            newEntry.networkType = document.getElementById('networkType').value;
            newEntry.findings = document.getElementById('networkFindings').value.trim();
            newEntry.associatedIpsDomains = document.getElementById('networkAssociated').value.trim();
            newEntry.toolsUsed = document.getElementById('networkTools').value.trim();
            newEntry.description = document.getElementById('networkDescription').value.trim();
            newEntry.notes = document.getElementById('networkNotes').value.trim();
            if (!newEntry.subject || !newEntry.networkType) { showToast('Please fill in all required network fields (Analysis Subject, Type).', 'error'); return; }
            appState.networks.push(newEntry);
            break;
        case 'metadata':
            newEntry.title = document.getElementById('metadataTitle').value.trim();
            newEntry.description = document.getElementById('metadataDescription').value.trim();
            newEntry.fileSource = document.getElementById('metadataFileSource').value.trim();
            newEntry.notes = document.getElementById('metadataNotes').value.trim();
            if (!newEntry.title) { showToast('Please enter a Metadata Title/Context.', 'error'); return; }
            appState.metadataEntries.push(newEntry);
            break;
        case 'archive':
            newEntry.originalUrl = document.getElementById('archiveOriginalUrl').value.trim();
            newEntry.url = document.getElementById('archiveUrl').value.trim();
            newEntry.service = document.getElementById('archiveService').value.trim();
            newEntry.timestamp = document.getElementById('archiveTimestamp').value; // Keep as string or convert to Date/timestamp
            newEntry.contentSummary = document.getElementById('archiveContentSummary').value.trim();
            newEntry.description = document.getElementById('archiveDescription').value.trim();
            newEntry.notes = document.getElementById('archiveNotes').value.trim();
            if (!newEntry.originalUrl || !newEntry.url) { showToast('Please fill in all required archive fields (Original URL, Archived URL).', 'error'); return; }
            // Convert to timestamp if needed for consistency with other dates
            if (newEntry.timestamp) {
                newEntry.timestamp = new Date(newEntry.timestamp).getTime();
            }
            appState.archives.push(newEntry);
            break;
        case 'messaging':
            newEntry.messagingApp = document.getElementById('messagingApp').value;
            newEntry.username = document.getElementById('messagingUsername').value.trim();
            newEntry.chatId = document.getElementById('messagingChatId').value.trim();
            newEntry.content = document.getElementById('messagingContent').value.trim();
            newEntry.description = document.getElementById('messagingDescription').value.trim();
            newEntry.notes = document.getElementById('messagingNotes').value.trim();
            if (!newEntry.messagingApp || !newEntry.username) { showToast('Please fill in all required messaging fields (App, Username/ID).', 'error'); return; }
            appState.messagingApps.push(newEntry);
            break;
        case 'dating':
            newEntry.platform = document.getElementById('datingPlatform').value;
            newEntry.username = document.getElementById('datingUsername').value.trim();
            newEntry.displayName = document.getElementById('datingDisplayName').value.trim();
            newEntry.age = parseInt(document.getElementById('datingAge').value);
            newEntry.location = document.getElementById('datingLocation').value.trim();
            newEntry.photos = document.getElementById('datingPhotos').value.trim();
            newEntry.bio = document.getElementById('datingBio').value.trim();
            newEntry.verified = document.getElementById('datingVerified').value;
            newEntry.suspicious = document.getElementById('datingSuspicious').value.trim();
            newEntry.notes = document.getElementById('datingNotes').value.trim();
            if (!newEntry.platform || !newEntry.username) { showToast('Please fill in all required dating profile fields (Platform, Username).', 'error'); return; }
            appState.datingProfiles.push(newEntry);
            break;
        case 'audio':
            newEntry.title = document.getElementById('audioTitle').value.trim();
            newEntry.format = document.getElementById('audioFormat').value;
            newEntry.duration = document.getElementById('audioDuration').value.trim();
            newEntry.quality = document.getElementById('audioQuality').value;
            newEntry.language = document.getElementById('audioLanguage').value.trim();
            newEntry.transcript = document.getElementById('audioTranscript').value.trim();
            newEntry.speakers = document.getElementById('audioSpeakers').value.trim();
            newEntry.background = document.getElementById('audioBackground').value.trim();
            newEntry.tools = document.getElementById('audioTools').value.trim();
            newEntry.description = document.getElementById('audioDescription').value.trim();
            newEntry.notes = document.getElementById('audioNotes').value.trim();
            const audioFile = document.getElementById('audioFile').files[0];
            if (!newEntry.title || !newEntry.format) { showToast('Please fill in all required audio fields (Title, Format).', 'error'); return; }
            if (audioFile) {
                newEntry.base64Data = await readFileAsBase64(audioFile);
            } else {
                showToast('Please upload an audio file.', 'error');
                return;
            }
            appState.audioEntries.push(newEntry);
            break;
        case 'facial':
            newEntry.subject = document.getElementById('facialSubject').value.trim();
            newEntry.sourceDescription = document.getElementById('facialSourceDescription').value.trim();
            newEntry.identifiedProfiles = document.getElementById('facialIdentifiedProfiles').value.trim();
            newEntry.confidence = document.getElementById('facialConfidence').value.trim();
            newEntry.toolsUsed = document.getElementById('facialToolsUsed').value.trim();
            newEntry.description = document.getElementById('facialDescription').value.trim();
            newEntry.notes = document.getElementById('facialNotes').value.trim();
            if (!newEntry.subject) { showToast('Please enter a subject/person identified.', 'error'); return; }
            appState.facialRecognition.push(newEntry);
            break;
        case 'persona':
            newEntry.name = document.getElementById('personaName').value.trim();
            newEntry.realName = document.getElementById('personaRealName').value.trim();
            newEntry.associatedAccounts = document.getElementById('personaAssociatedAccounts').value.trim();
            newEntry.bio = document.getElementById('personaBio').value.trim();
            newEntry.platformsUsed = document.getElementById('personaPlatforms').value.trim();
            newEntry.origin = document.getElementById('personaOrigin').value.trim();
            newEntry.notes = document.getElementById('personaNotes').value.trim();
            if (!newEntry.name) { showToast('Please enter a persona name/alias.', 'error'); return; }
            appState.personas.push(newEntry);
            break;
        case 'vpn':
            newEntry.name = document.getElementById('vpnName').value.trim();
            newEntry.vpnType = document.getElementById('vpnType').value;
            newEntry.jurisdiction = document.getElementById('vpnJurisdiction').value.trim();
            newEntry.logs = document.getElementById('vpnLogs').value;
            newEntry.payment = document.getElementById('vpnPayment').value.trim();
            newEntry.locations = document.getElementById('vpnLocations').value.trim();
            newEntry.issues = document.getElementById('vpnIssues').value.trim();
            newEntry.useCase = document.getElementById('vpnUseCase').value;
            newEntry.description = document.getElementById('vpnDescription').value.trim();
            newEntry.notes = document.getElementById('vpnNotes').value.trim();
            if (!newEntry.name || !newEntry.vpnType) { showToast('Please fill in all required VPN fields (Service Name, Type).', 'error'); return; }
            appState.vpns.push(newEntry);
            break;
        case 'honeypot':
            newEntry.honeypotType = document.getElementById('honeypotType').value;
            newEntry.location = document.getElementById('honeypotLocation').value.trim();
            newEntry.purpose = document.getElementById('honeypotPurpose').value.trim();
            newEntry.dataSummary = document.getElementById('honeypotDataSummary').value.trim();
            newEntry.alerts = document.getElementById('honeypotAlerts').value.trim();
            newEntry.description = document.getElementById('honeypotDescription').value.trim();
            newEntry.notes = document.getElementById('honeypotNotes').value.trim();
            if (!newEntry.honeypotType || !newEntry.location) { showToast('Please fill in all required honeypot fields (Type, Deployment Location/IP).', 'error'); return; }
            appState.honeypots.push(newEntry);
            break;
        case 'exploit':
            newEntry.name = document.getElementById('exploitName').value.trim();
            newEntry.targetVuln = document.getElementById('exploitTargetVuln').value.trim();
            newEntry.exploitType = document.getElementById('exploitType').value;
            newEntry.marketSource = document.getElementById('exploitMarketSource').value.trim();
            newEntry.price = document.getElementById('exploitPrice').value.trim();
            newEntry.description = document.getElementById('exploitDescription').value.trim();
            newEntry.notes = document.getElementById('exploitNotes').value.trim();
            if (!newEntry.name || !newEntry.targetVuln) { showToast('Please fill in all required exploit fields (Name/ID, Target Vulnerability).', 'error'); return; }
            appState.exploits.push(newEntry);
            break;
        case 'publicrecord':
            newEntry.recordType = document.getElementById('publicRecordType').value;
            newEntry.subjectName = document.getElementById('publicRecordSubjectName').value.trim();
            newEntry.refId = document.getElementById('publicRecordRefId').value.trim();
            newEntry.jurisdiction = document.getElementById('publicRecordJurisdiction').value.trim();
            newEntry.date = document.getElementById('publicRecordDate').value;
            newEntry.summary = document.getElementById('publicRecordSummary').value.trim();
            newEntry.sourceUrl = document.getElementById('publicRecordSourceUrl').value.trim();
            newEntry.description = document.getElementById('publicRecordDescription').value.trim();
            newEntry.notes = document.getElementById('publicRecordNotes').value.trim();
            if (!newEntry.recordType || !newEntry.subjectName) { showToast('Please fill in all required public record fields (Record Type, Subject Name).', 'error'); return; }
            appState.publicRecords.push(newEntry);
            break;
    }

    if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
        const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
        if (activeCustomTab && !activeCustomTab.toolIds.includes(newEntry.id)) {
            activeCustomTab.toolIds.push(newEntry.id);
            newEntry.customTabs.push(activeCustomTab.id);
        }
    }

    hideModal('addEntryModal');
    document.getElementById('addEntryForm').reset();
    document.getElementById('customMetadataEntries').innerHTML = '';
    showToast('Entry added successfully!');
    updateStats();
    populateCategoryFilter();
    renderIntelligenceEntries();
    renderCustomTabs();
    saveState();
}

// MODIFIED: handleEditEntry function to include all new entry types
async function handleEditEntry(e) {
    e.preventDefault();
    if (appState.readOnlyMode) {
        showToast("Cannot edit entries in read-only shared view.", "warning");
        return;
    }

    const entryId = document.getElementById('editEntryId').value;
    const entryType = document.getElementById('editEntryType').value;

    let entryToEdit = null;
    let entryArray = null;

    // Determine which array to look into based on entryType
    switch (entryType) {
        case 'tool': entryArray = appState.tools; break;
        case 'email': entryArray = appState.emails; break;
        case 'phone': entryArray = appState.phones; break;
        case 'crypto': entryArray = appState.crypto; break;
        case 'location': entryArray = appState.locations; break;
        case 'link': entryArray = appState.links; break;
        case 'media': entryArray = appState.media; break;
        case 'password': entryArray = appState.passwords; break;
        case 'keyword': entryArray = appState.keywords; break;
        case 'social': entryArray = appState.socials; break;
        case 'domain': entryArray = appState.domains; break;
        case 'username': entryArray = appState.usernames; break;
        case 'threat': entryArray = appState.threats; break;
        case 'vulnerability': entryArray = appState.vulnerabilities; break;
        case 'malware': entryArray = appState.malware; break;
        case 'breach': entryArray = appState.breaches; break;
        case 'credential': entryArray = appState.credentials; break;
        case 'forum': entryArray = appState.forums; break;
        case 'vendor': entryArray = appState.vendors; break;
        case 'telegram': entryArray = appState.telegramChannels; break;
        case 'paste': entryArray = appState.pastes; break;
        case 'document': entryArray = appState.documents; break;
        case 'network': entryArray = appState.networks; break;
        case 'metadata': entryArray = appState.metadataEntries; break;
        case 'archive': entryArray = appState.archives; break;
        case 'messaging': entryArray = appState.messagingApps; break;
        case 'dating': entryArray = appState.datingProfiles; break;
        case 'audio': entryArray = appState.audioEntries; break;
        case 'facial': entryArray = appState.facialRecognition; break;
        case 'persona': entryArray = appState.personas; break;
        case 'vpn': entryArray = appState.vpns; break;
        case 'honeypot': entryArray = appState.honeypots; break;
        case 'exploit': entryArray = appState.exploits; break;
        case 'publicrecord': entryArray = appState.publicRecords; break;
        default:
            console.warn(`Unknown entry type for action: ${entryType}`);
            return;
    }

    if (entryArray) {
        entryToEdit = entryArray.find(t => t.id === entryId);
    }

    if (!entryToEdit) {
        showToast('Error: Entry not found for editing.', 'error');
        return;
    }

    // Collect custom metadata
    const customMetadata = [];
    document.querySelectorAll('#editCustomMetadataEntries .metadata-entry').forEach(row => {
        const keyInput = row.querySelector('.metadata-key');
        const valueInput = row.querySelector('.metadata-value');
        const key = keyInput ? keyInput.value.trim() : '';
        const value = valueInput ? valueInput.value.trim() : '';
        if (key && value) {
            customMetadata.push({ key, value });
        }
    });
    entryToEdit.metadata = customMetadata.length > 0 ? customMetadata : undefined;

    // Collect source (general source for all types)
    const entrySourceInput = document.getElementById('editEntrySource');
    entryToEdit.source = entrySourceInput ? entrySourceInput.value.trim() || undefined : undefined;


    switch (entryType) {
        case 'tool':
            entryToEdit.name = document.getElementById('editToolName').value.trim();
            entryToEdit.url = document.getElementById('editToolUrl').value.trim();
            let editToolCategory = document.getElementById('editToolCategory').value;
            const editNewCategoryInput = document.getElementById('editNewCategoryInput').value.trim();
            entryToEdit.description = document.getElementById('editToolDescription').value.trim();
            entryToEdit.tags = document.getElementById('editToolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.notes = document.getElementById('editToolInvestigationNotes').value.trim();

            const editedIntelligenceVaultCategories = Array.from(document.querySelectorAll('#intelligenceVaultCategoriesCheckboxesEditTool input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            entryToEdit.intelligenceVaultCategories = editedIntelligenceVaultCategories;

            if (editToolCategory === 'custom') {
                if (!editNewCategoryInput) { showToast('Please enter a custom category name.', 'error'); return; }
                editToolCategory = editNewCategoryInput.toLowerCase();
            }
            entryToEdit.category = editToolCategory;
            entryToEdit.favicon = `https://www.google.com/s2/favicons?domain=${new URL(entryToEdit.url).hostname}`;
            break;
        case 'email':
            entryToEdit.email = document.getElementById('editEmailAddress').value.trim();
            entryToEdit.linkedPlatforms = document.getElementById('editEmailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p);
            entryToEdit.breachResults = document.getElementById('editEmailBreachResults').value.trim();
            entryToEdit.description = document.getElementById('editEmailDescription').value.trim();
            entryToEdit.notes = document.getElementById('editEmailNotes').value.trim();
            break;
        case 'phone':
            entryToEdit.number = document.getElementById('editPhoneNumber').value.trim();
            entryToEdit.phoneType = document.getElementById('editPhoneType').value;
            entryToEdit.location = document.getElementById('editPhoneLocation').value.trim();
            entryToEdit.description = document.getElementById('editPhoneDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPhoneNotes').value.trim();
            break;
        case 'crypto':
            entryToEdit.address = document.getElementById('editCryptoAddress').value.trim();
            entryToEdit.txid = document.getElementById('editCryptoTxid').value.trim();
            entryToEdit.amount = parseFloat(document.getElementById('editCryptoAmount').value);
            entryToEdit.source = document.getElementById('editCryptoSource').value.trim();
            entryToEdit.tags = document.getElementById('editCryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.description = document.getElementById('editCryptoDescription').value.trim();
            entryToEdit.notes = document.getElementById('editCryptoNotes').value.trim();
            break;
        case 'location':
            entryToEdit.name = document.getElementById('editLocationName').value.trim();
            entryToEdit.coordinates = document.getElementById('editLocationCoordinates').value.trim();
            entryToEdit.mapLink = document.getElementById('editLocationMapLink').value.trim();
            entryToEdit.ipGeoIntel = document.getElementById('editLocationIpGeoIntel').value.trim();
            entryToEdit.description = document.getElementById('editLocationDescription').value.trim();
            entryToEdit.notes = document.getElementById('editLocationNotes').value.trim();
            break;
        case 'link':
            entryToEdit.url = document.getElementById('editLinkUrl').value.trim();
            entryToEdit.platform = document.getElementById('editLinkPlatform').value.trim();
            entryToEdit.tags = document.getElementById('editLinkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.description = document.getElementById('editLinkDescription').value.trim();
            entryToEdit.notes = document.getElementById('editLinkNotes').value.trim();
            break;
        case 'media':
            entryToEdit.title = document.getElementById('editMediaTitle').value.trim();
            entryToEdit.mediaType = document.getElementById('editMediaType').value;
            const editMediaFile = document.getElementById('editMediaFile').files[0];
            if (editMediaFile) {
                entryToEdit.base64Data = await readFileAsBase64(editMediaFile);
            }
            entryToEdit.description = document.getElementById('editMediaDescription').value.trim();
            entryToEdit.notes = document.getElementById('editMediaNotes').value.trim();
            break;
        case 'password':
            entryToEdit.service = document.getElementById('editPasswordService').value.trim();
            entryToEdit.username = document.getElementById('editPasswordUsername').value.trim();
            entryToEdit.password = document.getElementById('editPasswordValue').value.trim();
            entryToEdit.strength = document.getElementById('editPasswordStrength').value.trim();
            entryToEdit.description = document.getElementById('editPasswordDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPasswordNotes').value.trim();
            break;
        case 'keyword':
            entryToEdit.value = document.getElementById('editKeywordValue').value.trim();
            entryToEdit.context = document.getElementById('editKeywordContext').value.trim();
            entryToEdit.description = document.getElementById('editKeywordDescription').value.trim();
            entryToEdit.notes = document.getElementById('editKeywordNotes').value.trim();
            break;
        case 'social':
            entryToEdit.platform = document.getElementById('editSocialPlatform').value.trim();
            entryToEdit.url = document.getElementById('editSocialUrl').value.trim();
            entryToEdit.username = document.getElementById('editSocialUsername').value.trim();
            entryToEdit.followCounts = document.getElementById('editSocialFollowCounts').value.trim();
            entryToEdit.description = document.getElementById('editSocialDescription').value.trim();
            entryToEdit.notes = document.getElementById('editSocialNotes').value.trim();
            break;
        case 'domain':
            entryToEdit.value = document.getElementById('editDomainValue').value.trim();
            entryToEdit.domainType = document.getElementById('editDomainType').value;
            entryToEdit.registrar = document.getElementById('editDomainRegistrar').value.trim();
            entryToEdit.location = document.getElementById('editDomainLocation').value.trim();
            entryToEdit.status = document.getElementById('editDomainStatus').value;
            entryToEdit.whois = document.getElementById('editDomainWhois').value.trim();
            entryToEdit.dns = document.getElementById('editDomainDns').value.trim();
            entryToEdit.tags = document.getElementById('editDomainTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.description = document.getElementById('editDomainDescription').value.trim();
            entryToEdit.notes = document.getElementById('editDomainNotes').value.trim();
            break;
        case 'username':
            entryToEdit.value = document.getElementById('editUsernameValue').value.trim();
            entryToEdit.platformsFound = document.getElementById('editUsernamePlatforms').value.trim();
            entryToEdit.emails = document.getElementById('editUsernameEmails').value.trim();
            entryToEdit.realName = document.getElementById('editUsernameRealName').value.trim();
            entryToEdit.activity = document.getElementById('editUsernameActivity').value;
            entryToEdit.description = document.getElementById('editUsernameDescription').value.trim();
            entryToEdit.notes = document.getElementById('editUsernameNotes').value.trim();
            break;
        case 'threat':
            entryToEdit.threatType = document.getElementById('editThreatType').value;
            entryToEdit.name = document.getElementById('editThreatName').value.trim();
            entryToEdit.severity = document.getElementById('editThreatSeverity').value;
            entryToEdit.iocs = document.getElementById('editThreatIocs').value.trim();
            entryToEdit.targets = document.getElementById('editThreatTargets').value.trim();
            entryToEdit.attribution = document.getElementById('editThreatAttribution').value.trim();
            entryToEdit.description = document.getElementById('editThreatDescription').value.trim();
            entryToEdit.source = document.getElementById('editThreatSource').value.trim();
            entryToEdit.notes = document.getElementById('editThreatNotes').value.trim();
            break;
        case 'vulnerability':
            entryToEdit.cve = document.getElementById('editVulnCve').value.trim();
            entryToEdit.cvss = parseFloat(document.getElementById('editVulnCvss').value);
            entryToEdit.software = document.getElementById('editVulnSoftware').value.trim();
            entryToEdit.vulnType = document.getElementById('editVulnType').value;
            entryToEdit.exploit = document.getElementById('editVulnExploit').value;
            entryToEdit.description = document.getElementById('editVulnDescription').value.trim();
            entryToEdit.mitigation = document.getElementById('editVulnMitigation').value.trim();
            entryToEdit.notes = document.getElementById('editVulnNotes').value.trim();
            break;
        case 'malware':
            entryToEdit.filename = document.getElementById('editMalwareFilename').value.trim();
            entryToEdit.hash = document.getElementById('editMalwareHash').value.trim();
            entryToEdit.fileType = document.getElementById('editMalwareType').value;
            entryToEdit.family = document.getElementById('editMalwareFamily').value.trim();
            entryToEdit.detection = document.getElementById('editMalwareDetection').value.trim();
            entryToEdit.behavior = document.getElementById('editMalwareBehavior').value.trim();
            entryToEdit.malwareSource = document.getElementById('editMalwareSource').value.trim();
            entryToEdit.tools = document.getElementById('editMalwareTools').value.trim();
            entryToEdit.notes = document.getElementById('editMalwareNotes').value.trim();
            break;
        case 'breach':
            entryToEdit.company = document.getElementById('editBreachCompany').value.trim();
            entryToEdit.date = document.getElementById('editBreachDate').value;
            entryToEdit.records = parseInt(document.getElementById('editBreachRecords').value);
            entryToEdit.dataTypes = document.getElementById('editBreachDataTypes').value.trim();
            entryToEdit.vector = document.getElementById('editBreachVector').value;
            entryToEdit.status = document.getElementById('editBreachStatus').value;
            entryToEdit.source = document.getElementById('editBreachSource').value.trim();
            entryToEdit.description = document.getElementById('editBreachDescription').value.trim();
            entryToEdit.notes = document.getElementById('editBreachNotes').value.trim();
            break;
        case 'credential':
            entryToEdit.credentialType = document.getElementById('editCredentialType').value;
            entryToEdit.credentialValue = document.getElementById('editCredentialValue').value.trim();
            entryToEdit.credentialService = document.getElementById('editCredentialService').value.trim();
            entryToEdit.breachSource = document.getElementById('editCredentialBreachSource').value.trim();
            entryToEdit.dateFound = document.getElementById('editCredentialDateFound').value;
            entryToEdit.description = document.getElementById('editCredentialDescription').value.trim();
            entryToEdit.notes = document.getElementById('editCredentialNotes').value.trim();
            break;
        case 'forum':
            entryToEdit.forumName = document.getElementById('editForumName').value.trim();
            entryToEdit.forumUrl = document.getElementById('editForumUrl').value.trim();
            entryToEdit.forumType = document.getElementById('editForumType').value;
            entryToEdit.forumStatus = document.getElementById('editForumStatus').value;
            entryToEdit.forumLanguage = document.getElementById('editForumLanguage').value.trim();
            entryToEdit.description = document.getElementById('editForumDescription').value.trim();
            entryToEdit.notes = document.getElementById('editForumNotes').value.trim();
            break;
        case 'vendor':
            entryToEdit.vendorAlias = document.getElementById('editVendorAlias').value.trim();
            entryToEdit.vendorPlatforms = document.getElementById('editVendorPlatforms').value.trim();
            entryToEdit.vendorProducts = document.getElementById('editVendorProducts').value.trim();
            entryToEdit.vendorReputation = document.getElementById('editVendorReputation').value.trim();
            entryToEdit.description = document.getElementById('editVendorDescription').value.trim();
            entryToEdit.notes = document.getElementById('editVendorNotes').value.trim();
            break;
        case 'telegram':
            entryToEdit.name = document.getElementById('editTelegramName').value.trim();
            entryToEdit.url = document.getElementById('editTelegramUrl').value.trim();
            entryToEdit.telegramType = document.getElementById('editTelegramType').value;
            entryToEdit.subscribers = parseInt(document.getElementById('editTelegramSubscribers').value);
            entryToEdit.language = document.getElementById('editTelegramLanguage').value.trim();
            entryToEdit.activity = document.getElementById('editTelegramActivity').value;
            entryToEdit.content = document.getElementById('editTelegramContent').value.trim();
            entryToEdit.admin = document.getElementById('editTelegramAdmin').value.trim();
            entryToEdit.tags = document.getElementById('editTelegramTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            entryToEdit.notes = document.getElementById('editTelegramNotes').value.trim();
            break;
        case 'paste':
            entryToEdit.url = document.getElementById('editPasteUrl').value.trim();
            entryToEdit.sourceSite = document.getElementById('editPasteSourceSite').value.trim();
            entryToEdit.contentSummary = document.getElementById('editPasteContentSummary').value.trim();
            entryToEdit.keywords = document.getElementById('editPasteKeywords').value.trim();
            entryToEdit.description = document.getElementById('editPasteDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPasteNotes').value.trim();
            break;
        case 'document':
            entryToEdit.title = document.getElementById('editDocumentTitle').value.trim();
            entryToEdit.fileType = document.getElementById('editDocumentFileType').value.trim();
            entryToEdit.hash = document.getElementById('editDocumentHash').value.trim();
            entryToEdit.contentSummary = document.getElementById('editDocumentContentSummary').value.trim();
            entryToEdit.source = document.getElementById('editDocumentSource').value.trim();
            entryToEdit.description = document.getElementById('editDocumentDescription').value.trim();
            entryToEdit.notes = document.getElementById('editDocumentNotes').value.trim();
            break;
        case 'network':
            entryToEdit.subject = document.getElementById('editNetworkSubject').value.trim();
            entryToEdit.networkType = document.getElementById('editNetworkType').value;
            entryToEdit.findings = document.getElementById('editNetworkFindings').value.trim();
            entryToEdit.associatedIpsDomains = document.getElementById('editNetworkAssociated').value.trim();
            entryToEdit.toolsUsed = document.getElementById('editNetworkTools').value.trim();
            entryToEdit.description = document.getElementById('editNetworkDescription').value.trim();
            entryToEdit.notes = document.getElementById('editNetworkNotes').value.trim();
            break;
        case 'metadata':
            entryToEdit.title = document.getElementById('editMetadataTitle').value.trim();
            entryToEdit.description = document.getElementById('editMetadataDescription').value.trim();
            entryToEdit.fileSource = document.getElementById('editMetadataFileSource').value.trim();
            entryToEdit.notes = document.getElementById('editMetadataNotes').value.trim();
            break;
        case 'archive':
            entryToEdit.originalUrl = document.getElementById('editArchiveOriginalUrl').value.trim();
            entryToEdit.url = document.getElementById('editArchiveUrl').value.trim();
            entryToEdit.service = document.getElementById('editArchiveService').value.trim();
            entryToEdit.timestamp = document.getElementById('editArchiveTimestamp').value ? new Date(document.getElementById('editArchiveTimestamp').value).getTime() : null;
            entryToEdit.contentSummary = document.getElementById('editArchiveContentSummary').value.trim();
            entryToEdit.description = document.getElementById('editArchiveDescription').value.trim();
            entryToEdit.notes = document.getElementById('editArchiveNotes').value.trim();
            break;
        case 'messaging':
            entryToEdit.messagingApp = document.getElementById('editMessagingApp').value;
            entryToEdit.username = document.getElementById('editMessagingUsername').value.trim();
            entryToEdit.chatId = document.getElementById('editMessagingChatId').value.trim();
            entryToEdit.content = document.getElementById('editMessagingContent').value.trim();
            entryToEdit.description = document.getElementById('editMessagingDescription').value.trim();
            entryToEdit.notes = document.getElementById('editMessagingNotes').value.trim();
            break;
        case 'dating':
            entryToEdit.platform = document.getElementById('editDatingPlatform').value;
            entryToEdit.username = document.getElementById('editDatingUsername').value.trim();
            entryToEdit.displayName = document.getElementById('editDatingDisplayName').value.trim();
            entryToEdit.age = parseInt(document.getElementById('editDatingAge').value);
            entryToEdit.location = document.getElementById('editDatingLocation').value.trim();
            entryToEdit.photos = document.getElementById('editDatingPhotos').value.trim();
            entryToEdit.bio = document.getElementById('editDatingBio').value.trim();
            entryToEdit.verified = document.getElementById('editDatingVerified').value;
            entryToEdit.suspicious = document.getElementById('editDatingSuspicious').value.trim();
            entryToEdit.notes = document.getElementById('editDatingNotes').value.trim();
            break;
        case 'audio':
            entryToEdit.title = document.getElementById('editAudioTitle').value.trim();
            entryToEdit.format = document.getElementById('editAudioFormat').value;
            entryToEdit.duration = document.getElementById('editAudioDuration').value.trim();
            entryToEdit.quality = document.getElementById('editAudioQuality').value;
            entryToEdit.language = document.getElementById('editAudioLanguage').value.trim();
            entryToEdit.transcript = document.getElementById('editAudioTranscript').value.trim();
            entryToEdit.speakers = document.getElementById('editAudioSpeakers').value.trim();
            entryToEdit.background = document.getElementById('editAudioBackground').value.trim();
            entryToEdit.tools = document.getElementById('editAudioTools').value.trim();
            entryToEdit.description = document.getElementById('editAudioDescription').value.trim();
            entryToEdit.notes = document.getElementById('editAudioNotes').value.trim();
            const editAudioFile = document.getElementById('editAudioFile').files[0];
            if (editAudioFile) {
                entryToEdit.base64Data = await readFileAsBase64(editAudioFile);
            }
            break;
        case 'facial':
            entryToEdit.subject = document.getElementById('editFacialSubject').value.trim();
            entryToEdit.sourceDescription = document.getElementById('editFacialSourceDescription').value.trim();
            entryToEdit.identifiedProfiles = document.getElementById('editFacialIdentifiedProfiles').value.trim();
            entryToEdit.confidence = document.getElementById('editFacialConfidence').value.trim();
            entryToEdit.toolsUsed = document.getElementById('editFacialToolsUsed').value.trim();
            entryToEdit.description = document.getElementById('editFacialDescription').value.trim();
            entryToEdit.notes = document.getElementById('editFacialNotes').value.trim();
            break;
        case 'persona':
            entryToEdit.name = document.getElementById('editPersonaName').value.trim();
            entryToEdit.realName = document.getElementById('editPersonaRealName').value.trim();
            entryToEdit.associatedAccounts = document.getElementById('editPersonaAssociatedAccounts').value.trim();
            entryToEdit.bio = document.getElementById('editPersonaBio').value.trim();
            entryToEdit.platformsUsed = document.getElementById('editPersonaPlatforms').value.trim();
            entryToEdit.origin = document.getElementById('editPersonaOrigin').value.trim();
            entryToEdit.notes = document.getElementById('editPersonaNotes').value.trim();
            break;
        case 'vpn':
            entryToEdit.name = document.getElementById('editVpnName').value.trim();
            entryToEdit.vpnType = document.getElementById('editVpnType').value;
            entryToEdit.jurisdiction = document.getElementById('editVpnJurisdiction').value.trim();
            entryToEdit.logs = document.getElementById('editVpnLogs').value;
            entryToEdit.payment = document.getElementById('editVpnPayment').value.trim();
            entryToEdit.locations = document.getElementById('editVpnLocations').value.trim();
            entryToEdit.issues = document.getElementById('editVpnIssues').value.trim();
            entryToEdit.useCase = document.getElementById('editVpnUseCase').value;
            entryToEdit.description = document.getElementById('editVpnDescription').value.trim();
            entryToEdit.notes = document.getElementById('editVpnNotes').value.trim();
            break;
        case 'honeypot':
            entryToEdit.honeypotType = document.getElementById('editHoneypotType').value;
            entryToEdit.location = document.getElementById('editHoneypotLocation').value.trim();
            entryToEdit.purpose = document.getElementById('editHoneypotPurpose').value.trim();
            entryToEdit.dataSummary = document.getElementById('editHoneypotDataSummary').value.trim();
            entryToEdit.alerts = document.getElementById('editHoneypotAlerts').value.trim();
            entryToEdit.description = document.getElementById('editHoneypotDescription').value.trim();
            entryToEdit.notes = document.getElementById('editHoneypotNotes').value.trim();
            break;
        case 'exploit':
            entryToEdit.name = document.getElementById('editExploitName').value.trim();
            entryToEdit.targetVuln = document.getElementById('editExploitTargetVuln').value.trim();
            entryToEdit.exploitType = document.getElementById('editExploitType').value;
            entryToEdit.marketSource = document.getElementById('editExploitMarketSource').value.trim();
            entryToEdit.price = document.getElementById('editExploitPrice').value.trim();
            entryToEdit.description = document.getElementById('editExploitDescription').value.trim();
            entryToEdit.notes = document.getElementById('editExploitNotes').value.trim();
            break;
        case 'publicrecord':
            entryToEdit.recordType = document.getElementById('editPublicRecordType').value;
            entryToEdit.subjectName = document.getElementById('editPublicRecordSubjectName').value.trim();
            entryToEdit.refId = document.getElementById('editPublicRecordRefId').value.trim();
            entryToEdit.jurisdiction = document.getElementById('editPublicRecordJurisdiction').value.trim();
            entryToEdit.date = document.getElementById('editPublicRecordDate').value;
            entryToEdit.summary = document.getElementById('editPublicRecordSummary').value.trim();
            entryToEdit.sourceUrl = document.getElementById('editPublicRecordSourceUrl').value.trim();
            entryToEdit.description = document.getElementById('editPublicRecordDescription').value.trim();
            entryToEdit.notes = document.getElementById('editPublicRecordNotes').value.trim();
            break;
    }

    // Update custom tab assignments for this entry
    const assignedCustomTabs = Array.from(document.querySelectorAll('#assignCustomTabsCheckboxes input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);

    // Clear existing custom tab assignments for this entry
    appState.customTabs.forEach(tab => {
        tab.toolIds = tab.toolIds.filter(id => id !== entryId);
    });
    entryToEdit.customTabs = []; // Reset the entry's customTabs array

    // Add back selected assignments
    assignedCustomTabs.forEach(tabId => {
        const tab = appState.customTabs.find(t => t.id === tabId);
        if (tab) {
            tab.toolIds.push(entryId);
            entryToEdit.customTabs.push(tabId); // Also update the entry itself
        }
    });

    hideModal('editEntryModal');
    showToast('Entry updated successfully!');
    updateStats();
    populateCategoryFilter();
    renderIntelligenceEntries();
    renderCustomTabs(); // Re-render custom tabs to update counts/content
    saveState();
}

// MODIFIED: openEditEntryModal function to handle all new entry types
function openEditEntryModal(entry) {
    if (appState.readOnlyMode) {
        showToast("Cannot edit entries in read-only shared view.", "warning");
        return;
    }

    document.getElementById('editEntryId').value = entry.id;
    document.getElementById('editEntryType').value = entry.type;

    // Hide all entry-specific field sets and remove their 'required' attributes
    document.querySelectorAll('#editEntryModal .entry-fields').forEach(fieldSet => {
        fieldSet.style.display = 'none';
        fieldSet.querySelectorAll('[required]').forEach(input => {
            input.removeAttribute('required');
        });
    });

    // Handle general source and metadata groups, ensuring they are always visible for edit if applicable
    const editEntrySourceGroup = document.getElementById('editEntrySourceGroup');
    const editEntrySource = document.getElementById('editEntrySource');
    if (editEntrySourceGroup) editEntrySourceGroup.style.display = 'block';
    if (editEntrySource) editEntrySource.value = entry.source || '';

    const editCustomMetadataEntries = document.getElementById('editCustomMetadataEntries');
    const editCustomMetadataGroup = document.getElementById('editCustomMetadataGroup');
    if (editCustomMetadataEntries) editCustomMetadataEntries.innerHTML = ''; // Clear previous entries
    if (entry.metadata && entry.metadata.length > 0) {
        entry.metadata.forEach(meta => addMetadataField('edit', meta.key, meta.value));
    }
    if (editCustomMetadataGroup) editCustomMetadataGroup.style.display = 'block';


    let fieldsToShow = [];
    // Centralized function to set field values safely
    const setFieldValue = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.value = value || '';
    };
    const setRequired = (id, isRequired) => {
        const element = document.getElementById(id);
        if (element) {
            if (isRequired) element.setAttribute('required', 'required');
            else element.removeAttribute('required');
        }
    };


    switch (entry.type) {
        case 'tool':
            fieldsToShow = ['editToolFields'];
            setFieldValue('editToolName', entry.name);
            setFieldValue('editToolUrl', entry.url);
            setFieldValue('editToolCategory', entry.category);
            setFieldValue('editToolDescription', entry.description);
            setFieldValue('editToolTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editToolInvestigationNotes', entry.notes); // Fix: Ensure this field exists and is correctly targeted

            const editVaultCategorySearchInput = document.getElementById('editIntelligenceVaultCategorySearch');
            if (editVaultCategorySearchInput) {
                editVaultCategorySearchInput.value = '';
            }
            populateIntelligenceVaultCategoriesCheckboxesEditTool(entry.intelligenceVaultCategories || [], '');

            const editNewCategoryInput = document.getElementById('editNewCategoryInput');
            const editToolCategorySelect = document.getElementById('editToolCategory');
            if (editToolCategorySelect && !editToolCategorySelect.querySelector(`option[value="${entry.category}"]`)) {
                editToolCategorySelect.value = 'custom';
                if (editNewCategoryInput) {
                    editNewCategoryInput.style.display = 'block';
                    editNewCategoryInput.value = entry.category;
                }
            } else if (editNewCategoryInput) {
                editNewCategoryInput.style.display = 'none';
                editNewCategoryInput.value = '';
            }

            setRequired('editToolName', true);
            setRequired('editToolUrl', true);
            setRequired('editToolCategory', true);
            if (editNewCategoryInput && editNewCategoryInput.style.display === 'block') {
                setRequired('editNewCategoryInput', true);
            }
            break;
        case 'email':
            fieldsToShow = ['editEmailFields']; // Source and metadata handled generically now
            setFieldValue('editEmailAddress', entry.email);
            setFieldValue('editEmailLinkedPlatforms', entry.linkedPlatforms ? entry.linkedPlatforms.join(', ') : '');
            setFieldValue('editEmailBreachResults', entry.breachResults);
            setFieldValue('editEmailDescription', entry.description); // Fix: Ensure this field exists and is correctly targeted
            setFieldValue('editEmailNotes', entry.notes);
            setRequired('editEmailAddress', true);
            break;
        case 'phone':
            fieldsToShow = ['editPhoneFields'];
            setFieldValue('editPhoneNumber', entry.number);
            setFieldValue('editPhoneType', entry.phoneType);
            setFieldValue('editPhoneLocation', entry.location);
            setFieldValue('editPhoneDescription', entry.description);
            setFieldValue('editPhoneNotes', entry.notes);
            setRequired('editPhoneNumber', true);
            break;
        case 'crypto':
            fieldsToShow = ['editCryptoFields'];
            setFieldValue('editCryptoAddress', entry.address);
            setFieldValue('editCryptoTxid', entry.txid);
            setFieldValue('editCryptoAmount', entry.amount);
            setFieldValue('editCryptoSource', entry.source);
            setFieldValue('editCryptoTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editCryptoDescription', entry.description);
            setFieldValue('editCryptoNotes', entry.notes);
            setRequired('editCryptoAddress', true);
            setRequired('editCryptoTxid', true);
            setRequired('editCryptoAmount', true);
            break;
        case 'location':
            fieldsToShow = ['editLocationFields'];
            setFieldValue('editLocationName', entry.name);
            setFieldValue('editLocationCoordinates', entry.coordinates);
            setFieldValue('editLocationMapLink', entry.mapLink);
            setFieldValue('editLocationIpGeoIntel', entry.ipGeoIntel);
            setFieldValue('editLocationDescription', entry.description);
            setFieldValue('editLocationNotes', entry.notes);
            setRequired('editLocationName', true);
            setRequired('editLocationCoordinates', true);
            break;
        case 'link':
            fieldsToShow = ['editLinkFields'];
            setFieldValue('editLinkUrl', entry.url);
            setFieldValue('editLinkPlatform', entry.platform);
            setFieldValue('editLinkTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editLinkDescription', entry.description);
            setFieldValue('editLinkNotes', entry.notes);
            setRequired('editLinkUrl', true);
            break;
        case 'media':
            fieldsToShow = ['editMediaFields'];
            setFieldValue('editMediaTitle', entry.title);
            setFieldValue('editMediaType', entry.mediaType);
            setFieldValue('editMediaBase64Data', entry.base64Data);
            setFieldValue('editMediaDescription', entry.description);
            setFieldValue('editMediaNotes', entry.notes);
            setRequired('editMediaTitle', true);
            break;
        case 'password':
            fieldsToShow = ['editPasswordFields'];
            setFieldValue('editPasswordService', entry.service);
            setFieldValue('editPasswordUsername', entry.username);
            setFieldValue('editPasswordValue', entry.password);
            setFieldValue('editPasswordStrength', entry.strength);
            setFieldValue('editPasswordDescription', entry.description); // Fix: Ensure this field exists and is correctly targeted
            setFieldValue('editPasswordNotes', entry.notes);
            setRequired('editPasswordService', true);
            setRequired('editPasswordValue', true);
            break;
        case 'keyword':
            fieldsToShow = ['editKeywordFields'];
            setFieldValue('editKeywordValue', entry.value);
            setFieldValue('editKeywordContext', entry.context);
            setFieldValue('editKeywordDescription', entry.description);
            setFieldValue('editKeywordNotes', entry.notes);
            setRequired('editKeywordValue', true);
            break;
        case 'social':
            fieldsToShow = ['editSocialFields'];
            setFieldValue('editSocialPlatform', entry.platform);
            setFieldValue('editSocialUrl', entry.url);
            setFieldValue('editSocialUsername', entry.username);
            setFieldValue('editSocialFollowCounts', entry.followCounts);
            setFieldValue('editSocialDescription', entry.description);
            setFieldValue('editSocialNotes', entry.notes);
            setRequired('editSocialPlatform', true);
            setRequired('editSocialUrl', true);
            setRequired('editSocialUsername', true);
            break;
        case 'domain':
            fieldsToShow = ['editDomainFields'];
            setFieldValue('editDomainValue', entry.value);
            setFieldValue('editDomainType', entry.domainType);
            setFieldValue('editDomainRegistrar', entry.registrar);
            setFieldValue('editDomainLocation', entry.location);
            setFieldValue('editDomainStatus', entry.status);
            setFieldValue('editDomainWhois', entry.whois);
            setFieldValue('editDomainDns', entry.dns);
            setFieldValue('editDomainTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editDomainDescription', entry.description);
            setFieldValue('editDomainNotes', entry.notes);
            setRequired('editDomainValue', true);
            setRequired('editDomainType', true);
            break;
        case 'username':
            fieldsToShow = ['editUsernameFields'];
            setFieldValue('editUsernameValue', entry.value);
            setFieldValue('editUsernamePlatforms', entry.platformsFound);
            setFieldValue('editUsernameEmails', entry.emails);
            setFieldValue('editUsernameRealName', entry.realName);
            setFieldValue('editUsernameActivity', entry.activity);
            setFieldValue('editUsernameDescription', entry.description);
            setFieldValue('editUsernameNotes', entry.notes);
            setRequired('editUsernameValue', true);
            break;
        case 'threat':
            fieldsToShow = ['editThreatFields'];
            setFieldValue('editThreatType', entry.threatType);
            setFieldValue('editThreatName', entry.name);
            setFieldValue('editThreatSeverity', entry.severity);
            setFieldValue('editThreatIocs', entry.iocs);
            setFieldValue('editThreatTargets', entry.targets);
            setFieldValue('editThreatAttribution', entry.attribution);
            setFieldValue('editThreatDescription', entry.description);
            setFieldValue('editThreatSource', entry.source);
            setFieldValue('editThreatNotes', entry.notes);
            setRequired('editThreatName', true);
            setRequired('editThreatType', true);
            break;
        case 'vulnerability':
            fieldsToShow = ['editVulnerabilityFields'];
            setFieldValue('editVulnCve', entry.cve);
            setFieldValue('editVulnCvss', entry.cvss);
            setFieldValue('editVulnSoftware', entry.software);
            setFieldValue('editVulnType', entry.vulnType);
            setFieldValue('editVulnExploit', entry.exploit);
            setFieldValue('editVulnDescription', entry.description);
            setFieldValue('editVulnMitigation', entry.mitigation);
            setFieldValue('editVulnNotes', entry.notes);
            setRequired('editVulnCve', true);
            break;
        case 'malware':
            fieldsToShow = ['editMalwareFields'];
            setFieldValue('editMalwareFilename', entry.filename);
            setFieldValue('editMalwareHash', entry.hash);
            setFieldValue('editMalwareType', entry.fileType);
            setFieldValue('editMalwareFamily', entry.family);
            setFieldValue('editMalwareDetection', entry.detection);
            setFieldValue('editMalwareBehavior', entry.behavior);
            setFieldValue('editMalwareSource', entry.malwareSource);
            setFieldValue('editMalwareTools', entry.tools);
            setFieldValue('editMalwareNotes', entry.notes);
            setRequired('editMalwareFilename', true);
            break;
        case 'breach':
            fieldsToShow = ['editBreachFields'];
            setFieldValue('editBreachCompany', entry.company);
            setFieldValue('editBreachDate', entry.date);
            setFieldValue('editBreachRecords', entry.records);
            setFieldValue('editBreachDataTypes', entry.dataTypes);
            setFieldValue('editBreachVector', entry.vector);
            setFieldValue('editBreachStatus', entry.status);
            setFieldValue('editBreachSource', entry.source);
            setFieldValue('editBreachDescription', entry.description);
            setFieldValue('editBreachNotes', entry.notes);
            setRequired('editBreachCompany', true);
            break;
        case 'credential':
            fieldsToShow = ['editCredentialFields'];
            setFieldValue('editCredentialType', entry.credentialType);
            setFieldValue('editCredentialValue', entry.credentialValue);
            setFieldValue('editCredentialService', entry.credentialService);
            setFieldValue('editCredentialBreachSource', entry.breachSource);
            setFieldValue('editCredentialDateFound', entry.dateFound);
            setFieldValue('editCredentialDescription', entry.description);
            setFieldValue('editCredentialNotes', entry.notes);
            setRequired('editCredentialValue', true);
            break;
        case 'forum':
            fieldsToShow = ['editForumFields'];
            setFieldValue('editForumName', entry.forumName);
            setFieldValue('editForumUrl', entry.forumUrl);
            setFieldValue('editForumType', entry.forumType);
            setFieldValue('editForumStatus', entry.forumStatus);
            setFieldValue('editForumLanguage', entry.forumLanguage);
            setFieldValue('editForumDescription', entry.description);
            setFieldValue('editForumNotes', entry.notes);
            setRequired('editForumName', true);
            setRequired('editForumUrl', true);
            break;
        case 'vendor':
            fieldsToShow = ['editVendorFields'];
            setFieldValue('editVendorAlias', entry.vendorAlias);
            setFieldValue('editVendorPlatforms', entry.vendorPlatforms);
            setFieldValue('editVendorProducts', entry.vendorProducts);
            setFieldValue('editVendorReputation', entry.vendorReputation);
            setFieldValue('editVendorDescription', entry.description);
            setFieldValue('editVendorNotes', entry.notes);
            setRequired('editVendorAlias', true);
            break;
        case 'telegram':
            fieldsToShow = ['editTelegramFields'];
            setFieldValue('editTelegramName', entry.name);
            setFieldValue('editTelegramUrl', entry.url);
            setFieldValue('editTelegramType', entry.telegramType);
            setFieldValue('editTelegramSubscribers', entry.subscribers);
            setFieldValue('editTelegramLanguage', entry.language);
            setFieldValue('editTelegramActivity', entry.activity);
            setFieldValue('editTelegramContent', entry.content);
            setFieldValue('editTelegramAdmin', entry.admin);
            setFieldValue('editTelegramTags', entry.tags ? entry.tags.join(', ') : '');
            setFieldValue('editTelegramNotes', entry.notes);
            setRequired('editTelegramName', true);
            setRequired('editTelegramUrl', true);
            break;
        case 'paste':
            fieldsToShow = ['editPasteFields'];
            setFieldValue('editPasteUrl', entry.url);
            setFieldValue('editPasteSourceSite', entry.sourceSite);
            setFieldValue('editPasteContentSummary', entry.contentSummary);
            setFieldValue('editPasteKeywords', entry.keywords);
            setFieldValue('editPasteDescription', entry.description);
            setFieldValue('editPasteNotes', entry.notes);
            setRequired('editPasteUrl', true);
            break;
        case 'document':
            fieldsToShow = ['editDocumentFields'];
            setFieldValue('editDocumentTitle', entry.title);
            setFieldValue('editDocumentFileType', entry.fileType);
            setFieldValue('editDocumentHash', entry.hash);
            setFieldValue('editDocumentContentSummary', entry.contentSummary);
            setFieldValue('editDocumentSource', entry.source);
            setFieldValue('editDocumentDescription', entry.description);
            setFieldValue('editDocumentNotes', entry.notes);
            setRequired('editDocumentTitle', true);
            setRequired('editDocumentHash', true);
            break;
        case 'network':
            fieldsToShow = ['editNetworkFields'];
            setFieldValue('editNetworkSubject', entry.subject);
            setFieldValue('editNetworkType', entry.networkType);
            setFieldValue('editNetworkFindings', entry.findings);
            setFieldValue('editNetworkAssociated', entry.associatedIpsDomains);
            setFieldValue('editNetworkTools', entry.toolsUsed);
            setFieldValue('editNetworkDescription', entry.description);
            setFieldValue('editNetworkNotes', entry.notes);
            setRequired('editNetworkSubject', true);
            break;
        case 'metadata':
            fieldsToShow = ['editMetadataEntryFields'];
            setFieldValue('editMetadataTitle', entry.title);
            setFieldValue('editMetadataDescription', entry.description);
            setFieldValue('editMetadataFileSource', entry.fileSource);
            setFieldValue('editMetadataNotes', entry.notes);
            setRequired('editMetadataTitle', true);
            break;
        case 'archive':
            fieldsToShow = ['editArchiveFields'];
            setFieldValue('editArchiveOriginalUrl', entry.originalUrl);
            setFieldValue('editArchiveUrl', entry.url);
            setFieldValue('editArchiveService', entry.service);
            setFieldValue('editArchiveTimestamp', entry.timestamp ? new Date(entry.timestamp).toISOString().slice(0, 16) : '');
            setFieldValue('editArchiveContentSummary', entry.contentSummary);
            setFieldValue('editArchiveDescription', entry.description);
            setFieldValue('editArchiveNotes', entry.notes);
            setRequired('editArchiveOriginalUrl', true);
            setRequired('editArchiveUrl', true);
            break;
        case 'messaging':
            fieldsToShow = ['editMessagingFields'];
            setFieldValue('editMessagingApp', entry.messagingApp);
            setFieldValue('editMessagingUsername', entry.username);
            setFieldValue('editMessagingChatId', entry.chatId);
            setFieldValue('editMessagingContent', entry.content);
            setFieldValue('editMessagingDescription', entry.description);
            setFieldValue('editMessagingNotes', entry.notes);
            setRequired('editMessagingUsername', true);
            setRequired('editMessagingApp', true);
            break;
        case 'dating':
            fieldsToShow = ['editDatingFields'];
            setFieldValue('editDatingPlatform', entry.platform);
            setFieldValue('editDatingUsername', entry.username);
            setFieldValue('editDatingDisplayName', entry.displayName);
            setFieldValue('editDatingAge', entry.age);
            setFieldValue('editDatingLocation', entry.location);
            setFieldValue('editDatingPhotos', entry.photos);
            setFieldValue('editDatingBio', entry.bio);
            setFieldValue('editDatingVerified', entry.verified);
            setFieldValue('editDatingSuspicious', entry.suspicious);
            setFieldValue('editDatingNotes', entry.notes);
            setRequired('editDatingPlatform', true);
            setRequired('editDatingUsername', true);
            break;
        case 'audio':
            fieldsToShow = ['editAudioFields'];
            setFieldValue('editAudioTitle', entry.title);
            setFieldValue('editAudioFormat', entry.format);
            setFieldValue('editAudioDuration', entry.duration);
            setFieldValue('editAudioQuality', entry.quality);
            setFieldValue('editAudioLanguage', entry.language);
            setFieldValue('editAudioTranscript', entry.transcript);
            setFieldValue('editAudioSpeakers', entry.speakers);
            setFieldValue('editAudioBackground', entry.background);
            setFieldValue('editAudioTools', entry.tools);
            setFieldValue('editAudioDescription', entry.description);
            setFieldValue('editAudioNotes', entry.notes);
            setRequired('editAudioTitle', true);
            setRequired('editAudioFormat', true);
            break;
        case 'facial':
            fieldsToShow = ['editFacialFields'];
            setFieldValue('editFacialSubject', entry.subject);
            setFieldValue('editFacialSourceDescription', entry.sourceDescription);
            setFieldValue('editFacialIdentifiedProfiles', entry.identifiedProfiles);
            setFieldValue('editFacialConfidence', entry.confidence);
            setFieldValue('editFacialToolsUsed', entry.toolsUsed);
            setFieldValue('editFacialDescription', entry.description);
            setFieldValue('editFacialNotes', entry.notes);
            setRequired('editFacialSubject', true);
            break;
        case 'persona':
            fieldsToShow = ['editPersonaFields'];
            setFieldValue('editPersonaName', entry.name);
            setFieldValue('editPersonaRealName', entry.realName);
            setFieldValue('editPersonaAssociatedAccounts', entry.associatedAccounts);
            setFieldValue('editPersonaBio', entry.bio);
            setFieldValue('editPersonaPlatforms', entry.platformsUsed);
            setFieldValue('editPersonaOrigin', entry.origin);
            setFieldValue('editPersonaNotes', entry.notes);
            setRequired('editPersonaName', true);
            break;
        case 'vpn':
            fieldsToShow = ['editVpnFields'];
            setFieldValue('editVpnName', entry.name);
            setFieldValue('editVpnType', entry.vpnType);
            setFieldValue('editVpnJurisdiction', entry.jurisdiction);
            setFieldValue('editVpnLogs', entry.logs);
            setFieldValue('editVpnPayment', entry.payment);
            setFieldValue('editVpnLocations', entry.locations);
            setFieldValue('editVpnIssues', entry.issues);
            setFieldValue('editVpnUseCase', entry.useCase);
            setFieldValue('editVpnDescription', entry.description);
            setFieldValue('editVpnNotes', entry.notes);
            setRequired('editVpnName', true);
            break;
        case 'honeypot':
            fieldsToShow = ['editHoneypotFields'];
            setFieldValue('editHoneypotType', entry.honeypotType);
            setFieldValue('editHoneypotLocation', entry.location);
            setFieldValue('editHoneypotPurpose', entry.purpose);
            setFieldValue('editHoneypotDataSummary', entry.dataSummary);
            setFieldValue('editHoneypotAlerts', entry.alerts);
            setFieldValue('editHoneypotDescription', entry.description);
            setFieldValue('editHoneypotNotes', entry.notes);
            setRequired('editHoneypotType', true);
            break;
        case 'exploit':
            fieldsToShow = ['editExploitFields'];
            setFieldValue('editExploitName', entry.name);
            setFieldValue('editExploitTargetVuln', entry.targetVuln);
            setFieldValue('editExploitType', entry.exploitType);
            setFieldValue('editExploitMarketSource', entry.marketSource);
            setFieldValue('editExploitPrice', entry.price);
            setFieldValue('editExploitDescription', entry.description);
            setFieldValue('editExploitNotes', entry.notes);
            setRequired('editExploitName', true);
            break;
        case 'publicrecord':
            fieldsToShow = ['editPublicRecordFields'];
            setFieldValue('editPublicRecordType', entry.recordType);
            setFieldValue('editPublicRecordSubjectName', entry.subjectName);
            setFieldValue('editPublicRecordRefId', entry.refId);
            setFieldValue('editPublicRecordJurisdiction', entry.jurisdiction);
            setFieldValue('editPublicRecordDate', entry.date);
            setFieldValue('editPublicRecordSummary', entry.summary);
            setFieldValue('editPublicRecordSourceUrl', entry.sourceUrl);
            setFieldValue('editPublicRecordDescription', entry.description);
            setFieldValue('editPublicRecordNotes', entry.notes);
            setRequired('editPublicRecordSubjectName', true);
            setRequired('editPublicRecordType', true);
            break;
    }

    fieldsToShow.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'block';
        }
    });

    // Populate custom tab assignment checkboxes
    populateCustomTabAssignmentCheckboxes(entry.customTabs || []);

    showModal('editEntryModal');
}

        function populateIntelligenceVaultCategoriesCheckboxesEditTool(assignedCategories) {
            const container = document.getElementById('intelligenceVaultCategoriesAssignmentAddTool');
            container.style.display = 'block'; // Ensure it's visible in the edit modal

            const checkboxesContainer = document.getElementById('intelligenceVaultCategoriesCheckboxesEditTool');
            checkboxesContainer.innerHTML = ''; // Clear previous checkboxes

            const intelligenceVaultCategories = [
                { id: 'tools', name: 'General Tools', icon: 'fas fa-tools' },
                { id: 'emailTools', name: 'Email Tools', icon: 'fas fa-envelope' },
                { id: 'phoneTools', name: 'Phone Tools', icon: 'fas fa-phone' },
                { id: 'cryptoTools', name: 'Crypto Tools', icon: 'fas fa-coins' },
                { id: 'locationTools', name: 'Location Tools', icon: 'fas fa-map-marker-alt' },
                { id: 'linkTools', name: 'Link Tools', icon: 'fas fa-link' },
                { id: 'mediaTools', name: 'Media Tools', icon: 'fas fa-camera' },
                { id: 'passwordTools', name: 'Password Tools', icon: 'fas fa-key' },
                { id: 'keywordTools', name: 'Keyword Tools', icon: 'fas fa-font' },
                { id: 'socialTools', name: 'Social Tools', icon: 'fas fa-users' },
                { id: 'darkWebTools', name: 'DarkWeb Tools', icon: 'fas fa-mask' },
                { id: 'vulnerabilityTools', name: 'Vulnerability Tools', icon: 'fas fa-bug' },
                { id: 'fileMalwareTools', name: 'File/Malware Tools', icon: 'fas fa-file-code' },
                { id: 'threatIntelligenceTools', name: 'Threat Intelligence Tools', icon: 'fas fa-shield-alt' },
                { id: 'aiTools', name: 'AI Tools', icon: 'fas fa-brain' }
            ];

            intelligenceVaultCategories.forEach(category => {
                const isChecked = assignedCategories.includes(category.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) checkboxContainer.classList.add('checked');

                checkboxContainer.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="intelligence-vault-category-checkbox-edit-tool" 
                        value="${category.id}" 
                        ${isChecked ? 'checked' : ''}
                    >
                    <i class="${category.icon}" style="margin-right: 5px;"></i>
                    <span>${category.name}</span>
                `;
                checkboxesContainer.appendChild(checkboxContainer);
            });

            // Avoid attaching multiple listeners
            checkboxesContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('intelligence-vault-category-checkbox-edit-tool')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            }, 
        ); // Ensures this listener is attached only once
        }


        // Add a new metadata field row to the form
        function addMetadataField(formType, key = '', value = '') {
            const containerId = formType === 'add' ? 'customMetadataEntries' : 'editCustomMetadataEntries';
            const container = document.getElementById(containerId);
            const newRow = document.createElement('div');
            newRow.classList.add('form-group', 'metadata-entry');
            newRow.innerHTML = `
                <input type="text" class="metadata-key" name="${formType}_metadata_key_${Date.now()}" placeholder="Key" value="${key}" required>
                <input type="text" class="metadata-value" name="${formType}_metadata_value_${Date.now()}" placeholder="Value" value="${value}" required>
                <button type="button" class="remove-metadata-btn"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newRow);
        }


        // Generate a unique ID
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Show toast notifications
        function showToast(message, type = 'success', duration = 3000) { // Make sure it has 'duration' parameter
            const toast = document.createElement('div');
            toast.classList.add('toast', type); // Uses classList.add for 'type'
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger reflow to ensure animation plays
            void toast.offsetWidth;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), {
                    once: true
                });
            }, duration); // Uses the duration parameter
        }

        // Clear all filters
        function clearFilters() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot clear filters in read-only shared view.", "warning");
                return;
            }
            appState.filters.category = '';
            appState.filters.search = '';
            appState.filters.sort = 'name';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortFilter').value = 'name';
            renderIntelligenceEntries();
            showToast('Filters cleared!');
        }

        // Generate a report (mock function)
        function generateReport() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate reports in read-only shared view.", "warning");
                return;
            }
            showToast('Generating report... (Feature in development)', 'info');
            // In a real application, this would trigger a backend process or generate a downloadable file
        }

        // Export data as JSON
        function exportData() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export data in read-only shared view.", "warning");
                return;
            }
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'osintvault_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }

        // Toggle Grid/List View
        function toggleViewMode() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot change view mode in read-only shared view.", "warning");
                return;
            }
            appState.viewMode = appState.viewMode === 'grid' ? 'list' : 'grid';
            localStorage.setItem('viewMode', appState.viewMode); // Save view mode preference

            // Update text and icon for both toggle buttons
            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            const customVaultViewToggleButton = document.getElementById('customVaultViewToggle'); // NEW

            if (appState.viewMode === 'grid') {
                if (viewToggleButton) {
                    viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    viewToggleButton.title = 'Switch to List View';
                }
                if (vaultViewToggleButton) {
                    vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    vaultViewToggleButton.title = 'Switch to List View';
                }
                if (customVaultViewToggleButton) { // NEW
                    customVaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                    customVaultViewToggleButton.title = 'Switch to List View';
                }
            } else {
                if (viewToggleButton) {
                    viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    viewToggleButton.title = 'Switch to Grid View';
                }
                if (vaultViewToggleButton) {
                    vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    vaultViewToggleButton.title = 'Switch to Grid View';
                }
                if (customVaultViewToggleButton) { // NEW
                    customVaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                    customVaultViewToggleButton.title = 'Switch to Grid View';
                }
            }

            renderIntelligenceEntries(); // This function will now apply the correct view to the active tab's grid/list.
            showToast(`Switched to ${appState.viewMode} view.`);
        }

        // Theme Toggle
        function initTheme() {
            document.documentElement.setAttribute('data-theme', appState.theme);
            const themeToggleBtn = document.getElementById('themeToggle');
            if (appState.theme === 'dark') {
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggleBtn.title = 'Switch to Light Theme';
            } else {
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggleBtn.title = 'Switch to Dark Theme';
            }
        }

        function toggleTheme() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot change theme in read-only shared view.", "warning");
                return;
            }
            appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', appState.theme); // Save theme preference
            initTheme(); // Apply new theme
            showToast(`Switched to ${appState.theme} theme.`);
        }

        // Random Discovery (Tool or Tip)
        function showRandomDiscovery() {
            const randomItemDisplay = document.getElementById('randomItemDisplay');
            const randomBtn = document.getElementById('newRandomBtn');
            randomBtn.disabled = true; // Disable button during loading
            randomItemDisplay.innerHTML = '<div class="loading"></div> Loading discovery...';

            // Simulate API call delay
            setTimeout(() => {
                const allTools = appState.tools;
                const allTips = appState.osintTips;

                const hasTools = allTools.length > 0;
                const hasTips = allTips.length > 0;

                let content = '';

                if (hasTools && (!hasTips || Math.random() < 0.7)) { // Prioritize tools if available
                    const randomTool = allTools[Math.floor(Math.random() * allTools.length)];
                    const favicon = `https://www.google.com/s2/favicons?domain=${new URL(randomTool.url).hostname}`;
                    content = `
                        <p style="font-size: 1.1em; color: var(--text-primary); font-weight: 500;">Tool Recommendation:</p>
                        <a href="${randomTool.url}" target="_blank" class="random-tool-link" title="Visit ${randomTool.name}">
                            <img src="${favicon}" alt="" class="tool-favicon" onerror="this.src='https://placehold.co/18x18/cccccc/000000?text=?'">
                            <span>${randomTool.name}</span>
                            <i class="fas fa-external-link-alt" style="font-size: 0.7em; margin-left: 5px;"></i>
                        </a>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">${randomTool.description}</p>
                    `;
                } else if (hasTips) {
                    const randomTip = allTips[Math.floor(Math.random() * allTips.length)];
                    content = `
                        <p style="font-size: 1.1em; color: var(--text-primary); font-weight: 500;">OSINT Tip of the Day:</p>
                        <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 10px;">"${randomTip}"</p>
                    `;
                } else {
                    content = `
                        <p style="font-size: 0.9em; color: var(--text-secondary);">No tools or tips available yet. Add some to get started!</p>
                    `;
                }

                randomItemDisplay.innerHTML = content;
                randomBtn.disabled = false; // Re-enable button
            }, 500); // Simulate network delay
        }


        // Custom Tabs (Multi-Vault) Logic
        function renderCustomTabs() {
            const customSubTabsContainer = document.getElementById('customSubTabs');
            const createSubTabBtn = document.getElementById('createSubTabBtn');
            const editSubTabBtn = document.getElementById('editSubTabBtn');
            const deleteSubTabBtn = document.getElementById('deleteSubTabBtn');
            const exportSubTabBtn = document.getElementById('exportSubTabBtn');
            const addEntryBtnCustomVault = document.getElementById('addEntryBtnCustomVault'); // The "Add New Entry" button

            customSubTabsContainer.innerHTML = ''; // Clear existing tabs

            if (appState.customTabs.length === 0) {
                document.getElementById('emptyCustomTabState').style.display = 'block';
                document.getElementById('emptyCurrentCustomTabState').style.display = 'none';
                customSubTabsContainer.style.display = 'none';
                editSubTabBtn.style.display = 'none';
                deleteSubTabBtn.style.display = 'none';
                exportSubTabBtn.style.display = 'none';
                addEntryBtnCustomVault.style.display = 'none'; // Hide add entry button
                appState.currentCustomTab = null; // No custom tab selected
                renderIntelligenceEntries(); // Re-render to show empty state
                return;
            } else {
                document.getElementById('emptyCustomTabState').style.display = 'none';
                customSubTabsContainer.style.display = 'flex';
                editSubTabBtn.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
                deleteSubTabBtn.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
                exportSubTabBtn.style.display = 'inline-flex';
                addEntryBtnCustomVault.style.display = appState.readOnlyMode ? 'none' : 'inline-flex'; // New: Hide in read-only
            }

            // Ensure a custom tab is selected if there are any
            if (!appState.currentCustomTab || !appState.customTabs.find(tab => tab.id === appState.currentCustomTab)) {
                appState.currentCustomTab = appState.customTabs[0].id;
            }

            appState.customTabs.forEach(tab => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('sub-nav-tab');
                if (tab.id === appState.currentCustomTab) {
                    tabButton.classList.add('active');
                    // Set active tab color
                    tabButton.style.backgroundColor = tab.color;
                    tabButton.style.color = 'white'; // Ensure text is white for contrast
                } else {
                    tabButton.style.color = 'var(--text-secondary)'; // Default text color for inactive
                }
                tabButton.dataset.subTabId = tab.id;
                tabButton.innerHTML = `<i class="${tab.icon}"></i> ${tab.name}`;
                customSubTabsContainer.appendChild(tabButton);
            });

            // Update the share options modal with custom tabs
            updateShareScopeSelect();

            renderIntelligenceEntries(); // Re-render content for the active custom tab
            saveState();
        }

        function switchCustomTab(tabId) {
            appState.currentCustomTab = tabId;
            renderCustomTabs(); // Re-render tabs to update active state
            renderIntelligenceEntries(); // Re-render entries for the newly active tab
            saveState();
        }

        function showCreateSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom vaults in read-only shared view.", "warning");
                return;
            }
            document.getElementById('createSubTabForm').reset();
            document.getElementById('newSubTabIcon').value = '';
            document.getElementById('newSubTabColor').value = '';

            populateIconPicker('newSubTabIconPicker', 'newSubTabIcon');
            populateColorPicker('newSubTabColorPicker', 'newSubTabColor');
            populateNewCustomVaultToolSelection(); // Populate tools for initial assignment

            showModal('createSubTabModal');
        }

        function handleCreateSubTab(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom vaults in read-only shared view.", "warning");
                return;
            }

            const newSubTabName = document.getElementById('newSubTabName').value.trim();
            const newSubTabIcon = document.getElementById('newSubTabIcon').value.trim() || 'fas fa-folder'; // Default icon
            const newSubTabColor = document.getElementById('newSubTabColor').value.trim() || 'var(--tab-color-default)'; // Default color

            if (!newSubTabName) {
                showToast('Please enter a vault name.', 'error');
                return;
            }

            const selectedToolIds = Array.from(document.querySelectorAll('#newCustomVaultToolSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            const newCustomTab = {
                id: generateId(),
                name: newSubTabName,
                icon: newSubTabIcon,
                color: newSubTabColor,
                toolIds: selectedToolIds // Assign selected tools
            };
            appState.customTabs.push(newCustomTab);

            // Update the customTabs property of the tools themselves
            selectedToolIds.forEach(toolId => {
                const tool = appState.tools.find(t => t.id === toolId);
                if (tool && !tool.customTabs.includes(newCustomTab.id)) {
                    tool.customTabs.push(newCustomTab.id);
                }
            });

            appState.currentCustomTab = newCustomTab.id; // Switch to the newly created tab
            hideModal('createSubTabModal');
            showToast('Custom Vault created successfully!');
            renderCustomTabs();
            saveState();
        }

        function openEditSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom vaults in read-only shared view.", "warning");
                return;
            }

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to edit.', 'warning');
                return;
            }

            document.getElementById('editSubTabId').value = activeCustomTab.id;
            document.getElementById('editedSubTabName').value = activeCustomTab.name;
            document.getElementById('editedSubTabIcon').value = activeCustomTab.icon;
            document.getElementById('editedSubTabColor').value = activeCustomTab.color;

            populateIconPicker('editedSubTabIconPicker', 'editedSubTabIcon', activeCustomTab.icon);
            populateColorPicker('editedSubTabColorPicker', 'editedSubTabColor', activeCustomTab.color);
            populateEditCustomVaultToolSelection(activeCustomTab.toolIds);

            showModal('editSubTabModal');
        }

        function handleEditSubTab(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom vaults in read-only shared view.", "warning");
                return;
            }

            const editedSubTabId = document.getElementById('editSubTabId').value;
            const editedSubTabName = document.getElementById('editedSubTabName').value.trim();
            const editedSubTabIcon = document.getElementById('editedSubTabIcon').value.trim() || 'fas fa-folder';
            const editedSubTabColor = document.getElementById('editedSubTabColor').value.trim() || 'var(--tab-color-default)';

            if (!editedSubTabName) {
                showToast('Please enter a vault name.', 'error');
                return;
            }

            const tabToEdit = appState.customTabs.find(tab => tab.id === editedSubTabId);
            if (tabToEdit) {
                tabToEdit.name = editedSubTabName;
                tabToEdit.icon = editedSubTabIcon;
                tabToEdit.color = editedSubTabColor;

                const selectedToolIds = Array.from(document.querySelectorAll('#editCustomVaultToolSelection input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);

                // Update customTabs property on all entries
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    // Remove this tab's ID if it was previously assigned
                    entry.customTabs = (entry.customTabs || []).filter(tabId => tabId !== editedSubTabId);
                    // Add it back if it's currently selected for this entry
                    if (selectedToolIds.includes(entry.id)) {
                        entry.customTabs.push(editedSubTabId);
                    }
                });

                tabToEdit.toolIds = selectedToolIds; // Update the tab's toolIds array

                hideModal('editSubTabModal');
                showToast('Custom Vault updated successfully!');
                renderCustomTabs();
                saveState();
            } else {
                showToast('Error: Custom Vault not found.', 'error');
            }
        }

        function handleDeleteSubTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot delete custom vaults in read-only shared view.", "warning");
                return;
            }

            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to delete.', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to delete the custom vault "${activeCustomTab.name}"? This will NOT delete the entries within it, only remove them from this vault.`)) {
                // Remove this tab's ID from all entries that had it assigned
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    entry.customTabs = (entry.customTabs || []).filter(tabId => tabId !== activeCustomTab.id);
                });

                appState.customTabs = appState.customTabs.filter(tab => tab.id !== activeCustomTab.id);
                appState.currentCustomTab = appState.customTabs.length > 0 ? appState.customTabs[0].id : null; // Select first tab or null

                showToast('Custom Vault deleted successfully!', 'error');
                renderCustomTabs();
                saveState();
            }
        }

        function exportCustomTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export custom vaults in read-only shared view.", "warning");
                return;
            }
            const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!activeCustomTab) {
                showToast('No custom vault selected to export.', 'warning');
                return;
            }

            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const entriesInCustomTab = allEntries.filter(entry => activeCustomTab.toolIds.includes(entry.id));

            const exportData = {
                vaultName: activeCustomTab.name,
                vaultIcon: activeCustomTab.icon,
                vaultColor: activeCustomTab.color,
                entries: entriesInCustomTab
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `osintvault_custom_vault_${activeCustomTab.name.replace(/\s/g, '_').toLowerCase()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Custom Vault "${activeCustomTab.name}" exported successfully!`, 'success');
        }

// Populate tool selection checkboxes for new custom vault
function populateNewCustomVaultToolSelection() {
    const container = document.getElementById('newCustomVaultToolSelection');
    container.innerHTML = ''; // Clear previous selections

    // Aggregate all entries from ALL appState arrays
    const allEntries = [
        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.audioEntries,
        ...appState.facialRecognition, ...appState.personas, ...appState.vpns, ...appState.honeypots,
        ...appState.exploits, ...appState.publicRecords
    ];

    if (allEntries.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No entries available to add.</p>';
        return;
    }

    allEntries.sort((a, b) => {
        // Use the getEntryName helper for consistent sorting
        const nameA = getEntryName(a);
        const nameB = getEntryName(b);
        return nameA.localeCompare(nameB);
    }).forEach(entry => {
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        checkboxContainer.innerHTML = `
            <input type="checkbox" class="custom-vault-tool-checkbox" value="${entry.id}">
            <i class="${getEntryIcon(entry.type)}" style="margin-right: 5px;"></i>
            <span>${getEntryName(entry)} (${entry.type})</span>
        `;
        container.appendChild(checkboxContainer);
    });
}

// Populate tool selection checkboxes for editing custom vault
function populateEditCustomVaultToolSelection(currentToolIds) {
    const container = document.getElementById('editCustomVaultToolSelection');
    container.innerHTML = ''; // Clear previous selections

    // Aggregate all entries from ALL appState arrays
    const allEntries = [
        ...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto,
        ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords,
        ...appState.keywords, ...appState.socials, ...appState.domains, ...appState.usernames,
        ...appState.threats, ...appState.vulnerabilities, ...appState.malware, ...appState.breaches,
        ...appState.credentials, ...appState.forums, ...appState.vendors, ...appState.telegramChannels,
        ...appState.pastes, ...appState.documents, ...appState.networks, ...appState.metadataEntries,
        ...appState.archives, ...appState.messagingApps, ...appState.datingProfiles, ...appState.audioEntries,
        ...appState.facialRecognition, ...appState.personas, ...appState.vpns, ...appState.honeypots,
        ...appState.exploits, ...appState.publicRecords
    ];

    if (allEntries.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No entries available to add.</p>';
        return;
    }

    allEntries.sort((a, b) => {
        const nameA = getEntryName(a);
        const nameB = getEntryName(b);
        return nameA.localeCompare(nameB);
    }).forEach(entry => {
        const isChecked = currentToolIds.includes(entry.id);
        const checkboxContainer = document.createElement('label');
        checkboxContainer.classList.add('custom-tab-checkbox');
        if (isChecked) {
            checkboxContainer.classList.add('checked');
        }
        checkboxContainer.innerHTML = `
            <input type="checkbox" class="custom-vault-tool-checkbox" value="${entry.id}" ${isChecked ? 'checked' : ''}>
            <i class="${getEntryIcon(entry.type)}" style="margin-right: 5px;"></i>
            <span>${getEntryName(entry)} (${entry.type})</span>
        `;
        container.appendChild(checkboxContainer);
    });
}

// NEW Helper function to get the primary display name for an entry, for sorting/listing
function getEntryName(entry) {
    switch (entry.type) {
        case 'tool': return entry.name;
        case 'email': return entry.email;
        case 'phone': return entry.number;
        case 'crypto': return entry.address;
        case 'location': return entry.name;
        case 'link': return entry.url;
        case 'media': return entry.title;
        case 'password': return entry.service;
        case 'keyword': return entry.value;
        case 'social': return entry.username;
        case 'domain': return entry.value;
        case 'username': return entry.value;
        case 'threat': return entry.name;
        case 'vulnerability': return entry.cve;
        case 'malware': return entry.filename;
        case 'breach': return entry.company;
        case 'credential': return entry.credentialService || entry.credentialValue;
        case 'forum': return entry.forumName;
        case 'vendor': return entry.vendorAlias;
        case 'telegram': return entry.name;
        case 'paste': return entry.url;
        case 'document': return entry.title;
        case 'network': return entry.subject;
        case 'metadata': return entry.title;
        case 'archive': return entry.originalUrl;
        case 'messaging': return entry.username;
        case 'dating': return entry.username;
        case 'audio': return entry.title;
        case 'facial': return entry.subject;
        case 'persona': return entry.name;
        case 'vpn': return entry.name;
        case 'honeypot': return entry.honeypotType;
        case 'exploit': return entry.name;
        case 'publicrecord': return entry.subjectName || entry.refId;
        default: return 'Unknown Entry';
    }
}

        // Populate custom tab assignment checkboxes in Edit Entry Modal
        function populateCustomTabAssignmentCheckboxes(assignedTabIds) {
            const container = document.getElementById('assignCustomTabsCheckboxes');
            container.innerHTML = ''; // Clear previous checkboxes

            if (appState.customTabs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No custom vaults created yet.</p>';
                document.getElementById('assignCustomTabs').style.display = 'none'; // Hide section if no custom tabs
                return;
            } else {
                document.getElementById('assignCustomTabs').style.display = 'block';
            }

            appState.customTabs.forEach(tab => {
                const isChecked = assignedTabIds.includes(tab.id);
                const checkboxContainer = document.createElement('label');
                checkboxContainer.classList.add('custom-tab-checkbox');
                if (isChecked) {
                    checkboxContainer.classList.add('checked');
                }
                checkboxContainer.innerHTML = `
                    <input type="checkbox" class="custom-tab-assign-checkbox" value="${tab.id}" ${isChecked ? 'checked' : ''}>
                    <i class="${tab.icon}" style="margin-right: 5px; color: ${tab.color};"></i>
                    <span>${tab.name}</span>
                `;
                container.appendChild(checkboxContainer);
            });
        }

// MODIFIED: Helper to get icon based on entry type
function getEntryIcon(type) {
    switch (type) {
        case 'tool': return 'fas fa-tools';
        case 'email': return 'fas fa-envelope';
        case 'phone': return 'fas fa-phone';
        case 'crypto': return 'fas fa-coins';
        case 'location': return 'fas fa-map-marker-alt';
        case 'link': return 'fas fa-link';
        case 'media': return 'fas fa-camera';
        case 'password': return 'fas fa-key';
        case 'keyword': return 'fas fa-font';
        case 'social': return 'fas fa-users';
        case 'domain': return 'fas fa-globe';
        case 'username': return 'fas fa-user';
        case 'threat': return 'fas fa-skull-crossbones';
        case 'vulnerability': return 'fas fa-bug';
        case 'malware': return 'fas fa-biohazard'; // Changed to biohazard for malware
        case 'breach': return 'fas fa-database';
        case 'credential': return 'fas fa-user-lock';
        case 'forum': return 'fas fa-comments';
        case 'vendor': return 'fas fa-store';
        case 'telegram': return 'fab fa-telegram-plane';
        case 'paste': return 'fas fa-paste';
        case 'document': return 'fas fa-file-alt';
        case 'network': return 'fas fa-network-wired';
        case 'metadata': return 'fas fa-info-circle';
        case 'archive': return 'fas fa-archive';
        case 'messaging': return 'fas fa-comment-dots';
        case 'dating': return 'fas fa-heart';
        case 'audio': return 'fas fa-volume-up';
        case 'facial': return 'fas fa-face-id-card';
        case 'persona': return 'fas fa-id-badge';
        case 'vpn': return 'fas fa-shield-alt';
        case 'honeypot': return 'fas fa-honey-pot';
        case 'exploit': return 'fas fa-bomb';
        case 'publicrecord': return 'fas fa-scale-balanced';
        default: return 'fas fa-question-circle';
    }
}

        // Populate icon picker grid
        function populateIconPicker(containerId, inputId, selectedIcon = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            availableIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.classList.add('icon-picker-item');
                iconItem.dataset.iconClass = iconClass;
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                if (iconClass === selectedIcon) {
                    iconItem.classList.add('selected');
                }
                container.appendChild(iconItem);
            });

            // If a selectedIcon is provided but not in availableIcons, add it as selected
            if (selectedIcon && !availableIcons.includes(selectedIcon)) {
                const customIconItem = document.createElement('div');
                customIconItem.classList.add('icon-picker-item', 'selected');
                customIconItem.dataset.iconClass = selectedIcon;
                customIconItem.innerHTML = `<i class="${selectedIcon}"></i>`;
                container.prepend(customIconItem); // Add to the beginning
            }
        }

        // Populate color picker grid
        function populateColorPicker(containerId, inputId, selectedColor = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            availableColors.forEach(colorValue => {
                const colorItem = document.createElement('div');
                colorItem.classList.add('color-picker-item');
                colorItem.dataset.colorValue = colorValue;
                colorItem.style.backgroundColor = colorValue;
                if (colorValue === selectedColor) {
                    colorItem.classList.add('selected');
                }
                container.appendChild(colorItem);
            });

            // If a selectedColor is provided but not in availableColors, add it as selected
            if (selectedColor && !availableColors.includes(selectedColor)) {
                const customColorItem = document.createElement('div');
                customColorItem.classList.add('color-picker-item', 'selected');
                customColorItem.dataset.colorValue = selectedColor;
                customColorItem.style.backgroundColor = selectedColor;
                container.prepend(customColorItem); // Add to the beginning
            }
        }

        // File reader for base64 encoding (for media entries)
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // NEW: Shareable Link Logic
        function parseShareableLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedScope = urlParams.get('scope');
            const sharedTab = urlParams.get('tab'); // Can be 'allVault', 'allData', or a custom tab ID
            const sharedIds = urlParams.get('ids'); // Comma-separated list of IDs

            if (sharedScope && sharedTab && sharedIds) {
                appState.readOnlyMode = true;
                appState.sharedTabId = sharedTab;
                appState.sharedEntryIds = sharedIds.split(',');

                showToast("You are viewing a shared, read-only version of OSINTVault. Functionality is limited.", "info", 10000);

                // Disable all input fields and buttons
                disableAllInputsAndButtons();

                // Automatically switch to the correct tab and sub-tab based on the shared link
                if (sharedTab === 'allVault' || sharedTab === 'allData') {
                    // These scopes are not direct tabs, but influence what's shown.
                    // We'll default to intelligence-vault and let renderIntelligenceEntries handle the scope.
                    switchTab('intelligence-vault');
                    appState.filters.searchScope = sharedTab; // Set the search scope
                } else if (sharedTab.startsWith('custom-')) { // Assuming custom tab IDs start with 'custom-'
                    switchTab('custom-tabs');
                    switchCustomTab(sharedTab);
                } else { // Assume it's an intelligence vault sub-tab
                    switchTab('intelligence-vault');
                    switchIntelligenceVaultSubTab(sharedTab);
                }
            }
        }

        function disableAllInputsAndButtons() {
            document.querySelectorAll('input, select, textarea, button').forEach(element => {
                if (element.id !== 'themeToggle' && element.id !== 'continueAnywayBtn' && element.id !== 'searchInput' && element.id !== 'searchScopeSelect' && !element.classList.contains('nav-tab')) {
                    element.disabled = true;
                    element.style.pointerEvents = 'none';
                    element.style.opacity = '0.7';
                }
            });
            // Specific overrides for search and main tabs
            document.getElementById('searchInput').disabled = false;
            document.getElementById('searchInput').style.pointerEvents = 'auto';
            document.getElementById('searchInput').style.opacity = '1';

            document.getElementById('searchScopeSelect').disabled = false;
            document.getElementById('searchScopeSelect').style.pointerEvents = 'auto';
            document.getElementById('searchScopeSelect').style.opacity = '1';

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.disabled = false;
                tab.style.pointerEvents = 'auto';
                tab.style.opacity = '1';
            });

            // Hide add/edit/delete buttons in custom tabs
            document.getElementById('createSubTabBtn').style.display = 'none';
            document.getElementById('editSubTabBtn').style.display = 'none';
            document.getElementById('deleteSubTabBtn').style.display = 'none';
            document.getElementById('addEntryBtnCustomVault').style.display = 'none';
            document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
            document.getElementById('addToolBtnEmptyState').style.display = 'none';
            document.getElementById('new-note-btn').style.display = 'none'; // Hide new note button
            document.getElementById('edit-note-btn').style.display = 'none'; // Hide edit note button
            document.getElementById('save-note-btn').style.display = 'none'; // Hide save note button
            document.getElementById('cancel-edit-note-btn').style.display = 'none'; // Hide cancel edit note button
            document.getElementById('back-to-notes-btn').style.display = 'none'; // Hide back to notes button
            document.getElementById('formatting-toolbar').style.display = 'none'; // Hide notes formatting toolbar
            document.getElementById('tag-input-container').style.display = 'none'; // Hide notes tag input
            document.getElementById('notes-list').querySelectorAll('.note-action-btn').forEach(btn => btn.style.display = 'none'); // Hide note action buttons

            // Hide bulk actions
            document.getElementById('bulkActions').style.display = 'none';
            document.getElementById('reportBtn').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('exportSubTabBtn').style.display = 'none';
        }

        function applyReadOnlyMode() {
            if (appState.readOnlyMode) {
                disableAllInputsAndButtons();
                // Ensure specific elements are hidden or disabled if they are part of the UI but not directly covered
                document.getElementById('addToolBtnIntelligenceVault').style.display = 'none';
                document.getElementById('addEntryBtnCustomVault').style.display = 'none';
                document.getElementById('createSubTabBtn').style.display = 'none';
                document.getElementById('editSubTabBtn').style.display = 'none';
                document.getElementById('deleteSubTabBtn').style.display = 'none';
                document.getElementById('exportSubTabBtn').style.display = 'none';
                document.getElementById('bulkActions').style.display = 'none';
                document.getElementById('reportBtn').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
                document.getElementById('refreshThreatsBtn').style.display = 'none';
                document.getElementById('newRandomBtn').style.display = 'none'; // Hide random discovery button
                document.getElementById('clearFiltersBtn').style.display = 'none'; // Hide clear filters button
                document.getElementById('pinAllBtn').style.display = 'none'; // Hide pin all button
                document.getElementById('starAllBtn').style.display = 'none'; // Hide star all button
                document.getElementById('viewToggle').style.display = 'none'; // Hide view toggle
                document.getElementById('vaultViewToggle').style.display = 'none'; // Hide vault view toggle
                document.getElementById('new-note-btn').style.display = 'none'; // Hide new note button
                document.getElementById('noteSortFilter').style.display = 'none'; // Hide note sort filter
                document.getElementById('search-notes').style.display = 'none'; // Hide note search

                // Ensure notes editor is read-only
                const noteContentEditor = document.getElementById('note-content-editor');
                if (noteContentEditor) {
                    noteContentEditor.setAttribute('contenteditable', 'false');
                    noteContentEditor.style.cursor = 'default';
                }
                const noteTitleInput = document.getElementById('note-title-input');
                if (noteTitleInput) {
                    noteTitleInput.readOnly = true;
                    noteTitleInput.style.cursor = 'default';
                }
            }
        }


        function showShareOptionsModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate new shared links in read-only view.", "warning");
                return;
            }
            // Populate the dropdown with custom tabs
            updateShareScopeSelect();
            showModal('shareOptionsModal');
        }

        function updateShareScopeSelect() {
            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const specificCustomTabOption = shareScopeSelect.querySelector('option[value="specificCustomTab"]');

            // Remove existing custom tab options
            Array.from(shareScopeSelect.options).forEach(option => {
                if (option.value.startsWith('custom-')) {
                    option.remove();
                }
            });

            // Add custom tabs as options
            if (appState.customTabs.length > 0) {
                specificCustomTabOption.style.display = 'block'; // Show the "Specific Custom Tab..." option
                appState.customTabs.forEach(tab => {
                    const option = document.createElement('option');
                    option.value = tab.id;
                    option.textContent = `Custom Vault: ${tab.name}`;
                    shareScopeSelect.appendChild(option);
                });
            } else {
                specificCustomTabOption.style.display = 'none'; // Hide if no custom tabs
            }

            // Also populate the specific custom tab selector if needed
            const selectCustomTabForSharing = document.getElementById('selectCustomTabForSharing');
            selectCustomTabForSharing.innerHTML = '';
            appState.customTabs.forEach(tab => {
                const option = document.createElement('option');
                option.value = tab.id;
                option.textContent = tab.name;
                selectCustomTabForSharing.appendChild(option);
            });

            // Ensure correct visibility of the specific custom tab selector
            handleShareScopeChange();
        }

        function handleShareScopeChange() {
            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const specificCustomTabSelector = document.getElementById('specificCustomTabSelector');
            if (shareScopeSelect.value === 'specificCustomTab') {
                specificCustomTabSelector.style.display = 'block';
            } else {
                specificCustomTabSelector.style.display = 'none';
            }
        }

        function handleShareFormSubmit(e) {
            e.preventDefault();
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot generate new shared links in read-only view.", "warning");
                return;
            }

            const shareScope = document.getElementById('shareScopeSelect').value;
            let targetTabId = '';
            let sharedEntries = [];

            if (shareScope === 'currentTab') {
                targetTabId = appState.currentTab;
                if (targetTabId === 'intelligence-vault') {
                    targetTabId = appState.currentIntelligenceVaultSubTab; // Use sub-tab ID for intel vault
                    sharedEntries = filterEntries(); // Filtered entries for current intel vault sub-tab
                } else if (targetTabId === 'custom-tabs') {
                    if (!appState.currentCustomTab) {
                        showToast('No custom vault selected to share.', 'error');
                        return;
                    }
                    targetTabId = appState.currentCustomTab; // Use custom tab ID
                    sharedEntries = filterEntries(); // Filtered entries for current custom tab
                } else {
                    // For other tabs like analytics or threats, we might not have 'entries' in the same way
                    // For now, let's assume 'currentTab' means the currently displayed entries.
                    // If no specific entries are filtered, it will be empty.
                    sharedEntries = filterEntries();
                }
            } else if (shareScope === 'allVault') {
                targetTabId = 'allVault';
                sharedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            } else if (shareScope === 'allData') {
                targetTabId = 'allData';
                sharedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            } else if (shareScope === 'specificCustomTab') {
                targetTabId = document.getElementById('selectCustomTabForSharing').value;
                if (!targetTabId) {
                    showToast('Please select a custom vault to share.', 'error');
                    return;
                }
                const customTab = appState.customTabs.find(tab => tab.id === targetTabId);
                if (customTab) {
                    const allEntriesCombined = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                    sharedEntries = allEntriesCombined.filter(entry => (entry.customTabs || []).includes(customTab.id));
                }
            } else { // A specific custom tab ID selected directly
                targetTabId = shareScope;
                const customTab = appState.customTabs.find(tab => tab.id === targetTabId);
                if (customTab) {
                    const allEntriesCombined = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                    sharedEntries = allEntriesCombined.filter(entry => (entry.customTabs || []).includes(customTab.id));
                }
            }

            if (sharedEntries.length === 0) {
                showToast('No entries found to share in the selected scope.', 'warning');
                return;
            }

            const sharedIds = sharedEntries.map(entry => entry.id).join(',');
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('scope', shareScope);
            currentUrl.searchParams.set('tab', targetTabId);
            currentUrl.searchParams.set('ids', sharedIds);

            const shareableLink = currentUrl.toString();

            // Display the link and offer to copy
            promptForCopyLink(shareableLink);
            hideModal('shareOptionsModal');
        }

        function promptForCopyLink(link) {
            const modalContent = `
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-share-alt"></i> Shareable Link Generated</h3>
                <p style="margin-bottom: 15px; color: var(--text-primary);">
                    Copy this link to share a read-only view of your selected intelligence:
                </p>
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border); word-break: break-all; margin-bottom: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;">
                    ${link}
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" id="closeShareLinkModal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyShareLinkBtn">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            `;
            const shareLinkModal = document.createElement('div');
            shareLinkModal.classList.add('modal');
            shareLinkModal.id = 'shareLinkDisplayModal';
            shareLinkModal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
            document.body.appendChild(shareLinkModal);
            showModal('shareLinkDisplayModal');

            document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
                copyToClipboard(link);
                showToast('Link copied to clipboard!');
                hideModal('shareLinkDisplayModal');
                shareLinkModal.remove();
            });

            document.getElementById('closeShareLinkModal').addEventListener('click', () => {
                hideModal('shareLinkDisplayModal');
                shareLinkModal.remove();
            });
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textarea);
        }

        // NEW: Desktop Recommendation Modal
        function checkAndShowDesktopRecommendation() {
            // Only show if not in read-only mode and hasn't been shown this session
            if (!appState.readOnlyMode && !sessionStorage.getItem('desktopRecommendationShown')) {
                if (window.innerWidth < 1024) { // Adjust breakpoint as needed
                    showModal('desktopRecommendationModal');
                }
            }
        }

        /* -------------------------------------------------------------------------- */
        /* OSINT Handbook & Notes JS                         */
        /* -------------------------------------------------------------------------- */

        // Initialize both handbook and notes
        function initHandbookAndNotes() {
            // Initialize the active subtab based on appState
            const activeSubtab = appState.currentHandbookSubTab || 'handbook';
            
            // Switch to the appropriate subtab
            switchHandbookSubtab(activeSubtab);
            
            // Initialize handbook functionality
            initHandbook();
            
            // Initialize notes functionality
            initNotes();
            }

        // Switch between Handbook and Notes subtabs
        function switchHandbookSubtab(subtabName) {
            // Store the current subtab in appState
            appState.currentHandbookSubTab = subtabName;
            
            // Update subtab buttons
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSubTabBtn = document.querySelector(`.handbook-subtab[data-subtab="${subtabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            
            // Update content containers
            document.querySelectorAll('.handbook-subtab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const targetContent = document.getElementById(`${subtabName}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // Save state
            saveState();
        }

        // Toggle mobile handbook sidebar
        function toggleHandbookSidebar() {
            const sidebar = document.getElementById('handbook-sidebar');
            const body = document.body; // Get the body element

            sidebar.classList.toggle('mobile-open');

            // Toggle a class on the body to prevent scrolling when sidebar is open
            body.classList.toggle('handbook-overlay-active', sidebar.classList.contains('mobile-open'));
            }


            // Initialize notes functionality
            function initNotes() {
            loadNotes();
            renderNotesList();
            setupNotesEventListeners();
        }

        // Load notes from localStorage
        function loadNotes() {
            const savedNotes = localStorage.getItem('osintNotes');
            if (savedNotes) {
                notesState.notes = JSON.parse(savedNotes);
                // Convert string dates back to Date objects and ensure 'pinned' exists
                notesState.notes.forEach(note => {
                note.createdAt = new Date(note.createdAt);
                note.updatedAt = new Date(note.updatedAt);
                // NEW: Ensure pinned property exists, default to false
                if (typeof note.pinned === 'undefined') {
                    note.pinned = false;
                }
                });

                // Sort notes with the new sorting logic
                sortNotes();
            }
            // NEW: Set initial value of the sort filter dropdown
            const noteSortFilterElement = document.getElementById('noteSortFilter');
            if (noteSortFilterElement) {
                noteSortFilterElement.value = notesState.noteSortFilter;
            }
        }

        // NEW/MODIFIED: Sort notes based on pinned status and selected filter
        function sortNotes() {
            const currentSort = notesState.noteSortFilter;

            notesState.notes.sort((a, b) => {
                // Pinned notes always come first
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;

                // Then apply the selected sort order
                switch (currentSort) {
                    case 'updated_desc':
                        return new Date(b.updatedAt) - new Date(a.updatedAt);
                    case 'updated_asc':
                        return new Date(a.updatedAt) - new Date(b.updatedAt);
                    case 'created_desc':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'created_asc':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'title_asc':
                        return a.title.localeCompare(b.title);
                    case 'title_desc':
                        return b.title.localeCompare(a.title);
                    default:
                        return 0; // Should not happen
                }
            });
            saveNotes(); // Save state after sorting
        }

        // Save notes to localStorage
        function saveNotes() {
            localStorage.setItem('osintNotes', JSON.stringify(notesState.notes));
        }


        // Render the notes list
        function renderNotesList() {
            const notesListContainer = document.getElementById('notes-list');
            if (!notesListContainer) return;

            if (notesState.notes.length === 0) {
                notesListContainer.innerHTML = `
                <div class="notes-empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Notes Yet</h3>
                    <p>Create your first note to get started!</p>
                </div>
                `;
                return;
            }

            // Create the grid layout for notes
            let notesHTML = '<div class="notes-grid">';

            // Notes are already sorted by sortNotes() before calling renderNotesList()
            notesState.notes.forEach(note => {
                // Get the first 5 lines of content or 150 characters, whichever is shorter
                let previewContent = note.content;

                // Remove HTML tags for the preview
                previewContent = previewContent.replace(/<[^>]*>/g, '');

                // Get the first 5 lines or 150 characters
                const lines = previewContent.split('\n').slice(0, 5).join('\n');
                previewContent = lines.length > 150 ? lines.substring(0, 147) + '...' : lines;

                const dateFormatted = formatDate(note.updatedAt);
                notesHTML += `
                        <div class="note-card ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}">
                            <div class="note-card-header">
                            <h3 class="note-title">${note.title}</h3>
                            <div class="note-actions">
                                <button class="note-action-btn pin-note ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}" title="${note.pinned ? 'Unpin Note' : 'Pin Note'}">
                                <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="note-action-btn edit-note" data-note-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete-note" data-note-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                            <div class="note-preview">${previewContent}</div>
                            <div class="note-footer">
                            <span class="note-date">Last updated: ${dateFormatted}</span>
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            </div>
                        </div>
                        `; // <--- Ensure this closing backtick is here!
                    });
                    
                    notesHTML += '</div>';
                    notesListContainer.innerHTML = notesHTML;
            // Add event listeners to note cards
            addNoteCardListeners();
        }

        // Format date in a human-readable way
        function formatDate(date) {
            const now = new Date();
            const noteDate = new Date(date);
            const diffTime = Math.abs(now - noteDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // Today, show time
                return `Today at ${noteDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (diffDays === 1) {
                // Yesterday
                return 'Yesterday';
            } else if (diffDays < 7) {
                // Within a week
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[noteDate.getDay()];
            } else {
                // Older than a week
                return noteDate.toLocaleDateString();
            }
        }


        // Add event listeners to note cards
        function addNoteCardListeners() {
            // Note card click (open note)
            document.querySelectorAll('.note-card').forEach(card => {
                card.addEventListener('click', (e) => {
                // Ignore clicks on action buttons
                if (!e.target.closest('.note-actions')) {
                    const noteId = card.dataset.noteId;
                    openNote(noteId);
                }
                });
            });

            // Edit button click (on note card in list view)
            document.querySelectorAll('.edit-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                editNote(noteId);
                });
            });

            // Delete button click (on note card in list view)
            document.querySelectorAll('.delete-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                deleteNote(noteId);
                });
            });

            // NEW: Pin button click (on note card in list view)
            document.querySelectorAll('.pin-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the note if clicking the icon
                const noteId = btn.dataset.noteId;
                togglePinNote(noteId);
                });
            });
        }

        // Setup event listeners for notes interface
        function setupNotesEventListeners() {
            // New note button
            const newNoteBtn = document.getElementById('new-note-btn');
            if (newNoteBtn) {
                newNoteBtn.addEventListener('click', createNewNote);
            }

            // Back button (from editor to list)
            const backToNotesBtn = document.getElementById('back-to-notes-btn');
            if (backToNotesBtn) {
                backToNotesBtn.addEventListener('click', () => {
                showNotesList();
                });
            }

            // Save note button
            const saveNoteBtn = document.getElementById('save-note-btn');
            if (saveNoteBtn) {
                saveNoteBtn.addEventListener('click', saveCurrentNote);
            }

            // Edit note button in editor view
            const editNoteInEditorBtn = document.getElementById('edit-note-btn');
            if (editNoteInEditorBtn) {
                editNoteInEditorBtn.addEventListener('click', () => {
                notesState.editMode = true;
                showNoteEditor();
                focusEditor();
                });
            }

            // NEW: Cancel edit button listener
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn');
            if (cancelEditNoteBtn) {
                cancelEditNoteBtn.addEventListener('click', () => {
                    // Discard changes by reverting editMode and re-showing editor (which loads original content)
                    notesState.editMode = false;
                    showNoteEditor();
                    showToast('Changes discarded.', 'info'); // Provide feedback
                });
            }

            // Search notes
            const searchNotesInput = document.getElementById('search-notes');
            if (searchNotesInput) {
                searchNotesInput.addEventListener('input', (e) => {
                searchNotes(e.target.value);
                });
            }

            // Sort notes dropdown listener
            const noteSortFilterElement = document.getElementById('noteSortFilter');
            if (noteSortFilterElement) {
                noteSortFilterElement.addEventListener('change', (e) => {
                    notesState.noteSortFilter = e.target.value;
                    localStorage.setItem('noteSortFilter', notesState.noteSortFilter);
                    sortNotes();
                    renderNotesList();
                });
            }

            // Tag input (add tags with Enter or comma)
            const tagInput = document.getElementById('note-tags-input');
            if (tagInput) {
                tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTagToCurrentNote();
                }
                });
            }

            // Add tag button
            const addTagBtn = document.getElementById('add-tag-btn');
            if (addTagBtn) {
                addTagBtn.addEventListener('click', addTagToCurrentNote);
            }
        }

        // NEW: Function to toggle pin status of a note
        function togglePinNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;

            note.pinned = !note.pinned; // Toggle the pinned status
            note.updatedAt = new Date(); // Update timestamp to re-sort if needed

            showToast(note.pinned ? 'Note pinned!' : 'Note unpinned!');

            sortNotes();      // Re-sort to bring pinned notes to top
            renderNotesList(); // Re-render to show updated pin status and order
        }


        // Create a new note
        function createNewNote() {
            const newNote = {
                id: generateNoteId(),
                title: 'Untitled Note',
                content: '',
                createdAt: new Date(),
                updatedAt: new Date(),
                tags: [],
                // NEW: Add pinned property
                pinned: false
            };

            notesState.notes.unshift(newNote);
            notesState.currentNote = newNote.id;
            notesState.editMode = true;

            saveNotes();
            showNoteEditor();
            focusEditor();
        }

        // Generate a unique ID for a note
        function generateNoteId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // Open a note
        function openNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesState.currentNote = noteId;
            notesState.editMode = false;
            
            showNoteEditor();
        }


        // Edit a note
        function editNote(noteId) {
            const note = notesState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesState.currentNote = noteId;
            notesState.editMode = true;
            
            showNoteEditor();
            focusEditor();
        }

        // Delete a note
        function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            notesState.notes = notesState.notes.filter(note => note.id !== noteId);

            if (notesState.currentNote === noteId) {
                notesState.currentNote = null;
                // If current note is deleted, go back to list view which will re-render
                showNotesList(); 
            } else {
                // If a different note is deleted, just re-sort and re-render the list
                sortNotes();
                renderNotesList();
            }

            saveNotes(); // Ensure state is saved after deletion
        }

        // Show the notes list view
        function showNotesList() {
            document.getElementById('notes-list-view').style.display = 'block';
            document.getElementById('note-editor-view').style.display = 'none';
            
            renderNotesList();
        }

        // Show the note editor view
        function showNoteEditor() {
            document.getElementById('notes-list-view').style.display = 'none';
            document.getElementById('note-editor-view').style.display = 'block';

            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;

            // Set editor content
            document.getElementById('note-title-input').value = note.title;
            document.getElementById('note-content-editor').innerHTML = note.content;

            // Set read-only status based on edit mode
            document.getElementById('note-title-input').readOnly = !notesState.editMode;
            document.getElementById('note-content-editor').contentEditable = notesState.editMode;

            // Get button references
            const saveNoteBtn = document.getElementById('save-note-btn');
            const editNoteBtn = document.getElementById('edit-note-btn');
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn'); // NEW reference
            const tagInputContainer = document.getElementById('tag-input-container');
            const formattingToolbar = document.getElementById('formatting-toolbar');

            // Show/hide appropriate buttons and elements based on editMode
            if (notesState.editMode) {
                saveNoteBtn.style.display = 'inline-flex';
                cancelEditNoteBtn.style.display = 'inline-flex'; // NEW: Show cancel button in edit mode
                editNoteBtn.style.display = 'none';
                tagInputContainer.style.display = 'flex';
                formattingToolbar.style.display = 'flex';
            } else {
                saveNoteBtn.style.display = 'none';
                cancelEditNoteBtn.style.display = 'none'; // NEW: Hide cancel button in preview mode
                editNoteBtn.style.display = 'inline-flex';
                tagInputContainer.style.display = 'none';
                formattingToolbar.style.display = 'none';
            }

            // Render tags
            renderNoteTags();

            // If in edit mode, setup the rich text editor (only needed once, but safe to call)
            if (notesState.editMode) {
                setupRichTextEditor();
            }
        }


        // Render the tags for the current note
        function renderNoteTags() {
            const tagsContainer = document.getElementById('note-tags-container');
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            
            if (!note) return;
            
            tagsContainer.innerHTML = note.tags.map(tag => `
                <div class="note-tag">
                <span>${tag}</span>
                ${notesState.editMode ? `<button class="remove-tag-btn" data-tag="${tag}"><i class="fas fa-times"></i></button>` : ''}
                </div>
            `).join('');
            
            // Add event listeners to remove tag buttons
            if (notesState.editMode) {
                document.querySelectorAll('.remove-tag-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tagToRemove = btn.dataset.tag;
                    removeTagFromCurrentNote(tagToRemove);
                });
                });
            }
        }


        // Add a tag to the current note
        function addTagToCurrentNote() {
            const tagInput = document.getElementById('note-tags-input');
            const tagValue = tagInput.value.trim();
            
            if (!tagValue) return;
            
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;
            
            // Don't add duplicate tags
            if (!note.tags.includes(tagValue)) {
                note.tags.push(tagValue);
                note.updatedAt = new Date();
                saveNotes();
                renderNoteTags();
            }
            
            // Clear the input
            tagInput.value = '';
        }

        // Remove a tag from the current note
        function removeTagFromCurrentNote(tag) {
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;
            
            note.tags = note.tags.filter(t => t !== tag);
            note.updatedAt = new Date();
            saveNotes();
            renderNoteTags();
        }

        // Save the current note
        function saveCurrentNote() {
            const note = notesState.notes.find(n => n.id === notesState.currentNote);
            if (!note) return;

            // NEW: Confirmation dialog
            if (!confirm('Are you sure you want to save changes to this note?')) {
                showToast('Save cancelled.', 'info'); // User clicked cancel
                return;
            }

            note.title = document.getElementById('note-title-input').value || 'Untitled Note';
            note.content = document.getElementById('note-content-editor').innerHTML;
            note.updatedAt = new Date(); // Update timestamp on save

            saveNotes();
            sortNotes(); // Re-sort notes after saving to reflect new updatedAt/pinned status

            // Switch to view mode
            notesState.editMode = false;
            showNoteEditor(); // Show editor in read-only mode

            // Show success message
            showToast('Note saved successfully!');
        }



        // Search notes by title, content, or tags
        function searchNotes(searchTerm) {
            searchTerm = searchTerm.toLowerCase();

            const filteredNotes = notesState.notes.filter(note => {
                const titleMatch = note.title.toLowerCase().includes(searchTerm);
                const contentMatch = note.content.toLowerCase().includes(searchTerm);
                const tagMatch = note.tags.some(tag => tag.toLowerCase().includes(searchTerm));

                return titleMatch || contentMatch || tagMatch;
            });

            const notesListContainer = document.getElementById('notes-list');

            // NEW: Apply sorting to filtered notes before rendering
            // Temporarily set notesState.notes to filteredNotes for sorting, then revert
            const originalNotes = notesState.notes;
            notesState.notes = filteredNotes;
            sortNotes(); // Sorts the (temporarily) filtered array
            const sortedFilteredNotes = notesState.notes;
            notesState.notes = originalNotes; // Revert to original full notes array

            if (sortedFilteredNotes.length === 0) {
                notesListContainer.innerHTML = `
                <div class="notes-empty-state">
                    <i class="fas fa-search"></i>
                    <h3>No matching notes found</h3>
                    <p>Try a different search term</p>
                </div>
                `;
                return;
            }

            // Create the grid layout for filtered notes
            let notesHTML = '<div class="notes-grid">';

            sortedFilteredNotes.forEach(note => {
                // Get the first 5 lines of content or 150 characters, whichever is shorter
                let previewContent = note.content;

                // Remove HTML tags for the preview
                previewContent = previewContent.replace(/<[^>]*>/g, '');

                // Get the first 5 lines or 150 characters
                const lines = previewContent.split('\n').slice(0, 5).join('\n');
                previewContent = lines.length > 150 ? lines.substring(0, 147) + '...' : lines;

                const dateFormatted = formatDate(note.updatedAt);

                notesHTML += `
                        <div class="note-card ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}">
                            <div class="note-card-header">
                            <h3 class="note-title">${note.title}</h3>
                            <div class="note-actions">
                                <button class="note-action-btn pin-note ${note.pinned ? 'pinned' : ''}" data-note-id="${note.id}" title="${note.pinned ? 'Unpin Note' : 'Pin Note'}">
                                <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="note-action-btn edit-note" data-note-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-action-btn delete-note" data-note-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            </div>
                            <div class="note-preview">${previewContent}</div>
                            <div class="note-footer">
                            <span class="note-date">${dateFormatted}</span>
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            </div>
                        </div>
                        `; // <--- Ensure this closing backtick is here!
                    });
                    
                    notesHTML += '</div>';
                    notesListContainer.innerHTML = notesHTML;
            
            // Add event listeners to note cards (these will be for the filtered set)
            addNoteCardListeners();

            // If no search term, re-render full list with original sort
            if (!searchTerm) {
                renderNotesList();
            }
        }

        // Setup rich text editor
        function setupRichTextEditor() {
            const editor = document.getElementById('note-content-editor');
            const toolbar = document.getElementById('formatting-toolbar');
            
            // Make sure we have both elements
            if (!editor || !toolbar) return;
            
            // Add command handling for toolbar buttons
            toolbar.querySelectorAll('.formatting-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                const command = btn.dataset.command;
                const value = btn.dataset.value || null;
                
                if (command === 'createLink') {
                    const url = prompt('Enter the URL:');
                    if (url) {
                    document.execCommand(command, false, url);
                    }
                } else if (command === 'formatBlock') {
                    document.execCommand(command, false, value);
                } else {
                    document.execCommand(command, false, value);
                }
                
                editor.focus();
                });
            });
        }

        // Focus the editor
        function focusEditor() {
        setTimeout(() => {
            const titleInput = document.getElementById('note-title-input');
            if (titleInput) {
            titleInput.focus();
            titleInput.select();
            }
        }, 100);
        }



        // Render the handbook sidebar and initialize content
        function initHandbook() {
        const handbookSidebar = document.getElementById('handbook-sidebar');
        if (!handbookSidebar) return;

        // Render the sidebar
        renderHandbookSidebar();
        
        // Show the first section by default
        if (handbookData.sections.length > 0) {
            const firstSection = handbookData.sections[0];
            showHandbookSection(firstSection.id);
        }
        
        // Load saved user notes
        loadUserNotes();
        }

        // Render the handbook sidebar navigation
        function renderHandbookSidebar() {
        const sidebar = document.getElementById('handbook-sidebar');
        let sidebarHTML = '';
        
        handbookData.sections.forEach(section => {
            if (section.isCategory) {
            // This is a category with subcategories
            sidebarHTML += `
                <div class="handbook-category">
                <div class="handbook-category-header" data-category="${section.id}">
                    <i class="${section.icon}"></i>
                    <span>${section.title}</span>
                    <i class="fas fa-chevron-down category-toggle"></i>
                </div>
                <div class="handbook-subcategories" id="${section.id}-subcategories">
            `;
            
            section.subcategories.forEach(subcategory => {
                sidebarHTML += `
                <div class="handbook-nav-item" data-section="${subcategory.id}">
                    <i class="${subcategory.icon}"></i>
                    <span>${subcategory.title}</span>
                </div>
                `;
            });
            
            sidebarHTML += `
                </div>
                </div>
            `;
            } else {
            // This is a standalone section
            sidebarHTML += `
                <div class="handbook-nav-item" data-section="${section.id}">
                <i class="${section.icon}"></i>
                <span>${section.title}</span>
                </div>
            `;
            }
        });
        
        sidebar.innerHTML = sidebarHTML;
        
        // Add event listeners for sidebar navigation
        addHandbookSidebarListeners();
        }

        // Add event listeners to the handbook sidebar
        function addHandbookSidebarListeners() {
        // Category headers toggle
        document.querySelectorAll('.handbook-category-header').forEach(header => {
            header.addEventListener('click', () => {
            const categoryId = header.dataset.category;
            const subcategoriesEl = document.getElementById(`${categoryId}-subcategories`);
            
            // Toggle the subcategories visibility
            if (subcategoriesEl.style.maxHeight) {
                subcategoriesEl.style.maxHeight = null;
                header.querySelector('.category-toggle').classList.remove('rotate');
            } else {
                subcategoriesEl.style.maxHeight = subcategoriesEl.scrollHeight + "px";
                header.querySelector('.category-toggle').classList.add('rotate');
            }
            });
        });
        
        // Section item clicks
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            item.addEventListener('click', () => {
            const sectionId = item.dataset.section;
            showHandbookSection(sectionId);
            
            // Update active state
            document.querySelectorAll('.handbook-nav-item').forEach(i => {
                i.classList.remove('active');
            });
            item.classList.add('active');
            
            // If on mobile, close the sidebar
            if (window.innerWidth < 768) {
                document.getElementById('handbook-sidebar').classList.remove('mobile-open');
            }
            });
        });
        
        // Search input
        const searchInput = document.getElementById('handbook-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterHandbookSidebar(searchTerm);
            });
        }
        }

        // Filter the handbook sidebar based on search term
        function filterHandbookSidebar(searchTerm) {
        if (!searchTerm) {
            // Reset visibility
            document.querySelectorAll('.handbook-nav-item, .handbook-category').forEach(item => {
            item.style.display = 'flex';
            });
            document.querySelectorAll('.handbook-subcategories').forEach(sub => {
            sub.style.maxHeight = null;
            });
            return;
        }
        
        // Hide all items initially
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            const sectionId = item.dataset.section;
            
            // Find the matching section data
            let sectionData = null;
            handbookData.sections.forEach(section => {
            if (section.id === sectionId) {
                sectionData = section;
            } else if (section.isCategory && section.subcategories) {
                const subcat = section.subcategories.find(sub => sub.id === sectionId);
                if (subcat) sectionData = subcat;
            }
            });
            
            if (sectionData) {
            const titleMatch = sectionData.title.toLowerCase().includes(searchTerm);
            const contentMatch = sectionData.content && sectionData.content.toLowerCase().includes(searchTerm);
            
            if (titleMatch || contentMatch) {
                item.style.display = 'flex';
                
                // If it's in a subcategory, show the parent category and expand it
                const parentCategory = item.closest('.handbook-subcategories');
                if (parentCategory) {
                const categoryId = parentCategory.id.replace('-subcategories', '');
                const categoryHeader = document.querySelector(`.handbook-category-header[data-category="${categoryId}"]`);
                const categoryContainer = categoryHeader.closest('.handbook-category');
                
                categoryContainer.style.display = 'block';
                parentCategory.style.maxHeight = parentCategory.scrollHeight + "px";
                categoryHeader.querySelector('.category-toggle').classList.add('rotate');
                }
            } else {
                item.style.display = 'none';
            }
            }
        });
        
        // Hide empty categories
        document.querySelectorAll('.handbook-category').forEach(category => {
            const visibleItems = category.querySelectorAll('.handbook-nav-item[style="display: flex;"]');
            if (visibleItems.length === 0) {
            category.style.display = 'none';
            } else {
            category.style.display = 'block';
            }
        });
        }

        // Show a specific handbook section
        function showHandbookSection(sectionId) {
            const contentContainer = document.getElementById('handbook-article-area'); // Use the corrected unique ID
            if (!contentContainer) return;

            // Find the section data (this part of your code remains the same)
            let sectionData = null;
            handbookData.sections.forEach(section => {
                if (section.id === sectionId) {
                    sectionData = section;
                } else if (section.isCategory && section.subcategories) {
                    const subcat = section.subcategories.find(sub => sub.id === sectionId);
                    if (subcat) sectionData = subcat;
                }
            });

            if (!sectionData) return;

            // Set the content (this creates the new textarea elements)
            contentContainer.innerHTML = sectionData.content;

            // Add copy button functionality for code blocks (this part of your code remains the same)
            contentContainer.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const codeBlock = btn.parentElement.querySelector('code');
                    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                });
            });

            // Add event listeners for ALL user notes textareas within the newly added content
            contentContainer.querySelectorAll('textarea[id^="notes-"]').forEach(textarea => {
                // Load initial value from localStorage
                const savedNote = localStorage.getItem(textarea.id);
                if (savedNote) {
                    textarea.value = savedNote;
                }
                // Add listener for saving on input
                textarea.addEventListener('input', (e) => {
                    localStorage.setItem(e.target.id, e.target.value);
                });
            });
        }

        // Load user notes from localStorage
        function loadUserNotes() {
        document.querySelectorAll('textarea[id^="notes-"]').forEach(textarea => {
            const savedNote = localStorage.getItem(textarea.id);
            if (savedNote) {
            textarea.value = savedNote;
            }
        });
        }

        // Toggle the mobile sidebar
        function toggleHandbookSidebar() {
        const sidebar = document.getElementById('handbook-sidebar');
        sidebar.classList.toggle('mobile-open');
        }

        // Enhanced OSINT Handbook functionality
        document.addEventListener('DOMContentLoaded', () => {
        // Initialize handbook features when loaded
        initHandbookFeatures();
        });

        function initHandbookFeatures() {
        // Add section management buttons to handbook content container
        addHandbookControls();
        
        // Enhance search functionality
        enhanceHandbookSearch();
        
        // Initialize editor for section content
        initSectionEditor();
        }

        function addHandbookControls() {
        const handbookContent = document.querySelector('.handbook-content-container');
        if (!handbookContent) return;
        
        // Create handbook controls container
        const controlsHtml = `
            <div class="handbook-controls">
            <button id="add-section-btn" class="btn btn-primary handbook-btn">
                <i class="fas fa-plus"></i> Add New Section
            </button>
            <button id="edit-section-btn" class="btn btn-secondary handbook-btn" style="display: none;">
                <i class="fas fa-edit"></i> Edit Section
            </button>
            <button id="delete-section-btn" class="btn btn-danger handbook-btn" style="display: none;">
                <i class="fas fa-trash"></i> Delete Section
            </button>
            </div>
        `;
        
        // Insert controls before the content area
        handbookContent.insertAdjacentHTML('afterbegin', controlsHtml);
        
        // Add event listeners
        document.getElementById('add-section-btn').addEventListener('click', openAddSectionModal);
        document.getElementById('edit-section-btn').addEventListener('click', openEditSectionModal);
        document.getElementById('delete-section-btn').addEventListener('click', confirmDeleteSection);
        }

        function enhanceHandbookSearch() {
        const searchInput = document.getElementById('handbook-search');
        if (!searchInput) return;
        
        // Clear any existing listeners to avoid duplicates
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Add enhanced search functionality
        newSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
            // Reset search if term is too short
            document.querySelectorAll('.handbook-nav-item, .handbook-category').forEach(item => {
                item.style.display = 'flex';
            });
            document.querySelectorAll('.handbook-content mark').forEach(mark => {
                const text = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(text, mark);
            });
            return;
            }
            
            // Search both titles and content
            searchHandbookSections(searchTerm);
            
            // Highlight matches in current content
            highlightContentMatches(searchTerm);
        });
        
        // Add search icon click handler to clear search
        const searchIcon = document.querySelector('.handbook-search-icon');
        if (searchIcon) {
            searchIcon.style.cursor = 'pointer';
            searchIcon.addEventListener('click', () => {
            newSearchInput.value = '';
            newSearchInput.dispatchEvent(new Event('input'));
            newSearchInput.focus();
            });
        }
        }

        function searchHandbookSections(searchTerm) {
        let matchFound = false;
        
        // Search through all sections
        document.querySelectorAll('.handbook-nav-item').forEach(item => {
            const sectionId = item.dataset.section;
            let sectionData = findSectionById(sectionId);
            
            if (sectionData) {
            const titleMatch = sectionData.title.toLowerCase().includes(searchTerm);
            const contentMatch = sectionData.content && sectionData.content.toLowerCase().includes(searchTerm);
            
            if (titleMatch || contentMatch) {
                item.style.display = 'flex';
                matchFound = true;
                
                // Highlight the matching item
                item.classList.add('search-highlight');
                
                // Expand parent category if in a subcategory
                const parentSubcategories = item.closest('.handbook-subcategories');
                if (parentSubcategories) {
                const categoryId = parentSubcategories.id.replace('-subcategories', '');
                const categoryHeader = document.querySelector(`.handbook-category-header[data-category="${categoryId}"]`);
                
                if (categoryHeader) {
                    categoryHeader.closest('.handbook-category').style.display = 'block';
                    parentSubcategories.style.maxHeight = parentSubcategories.scrollHeight + "px";
                    categoryHeader.querySelector('.category-toggle').classList.add('rotate');
                }
                }
            } else {
                item.style.display = 'none';
                item.classList.remove('search-highlight');
            }
            }
        });
        
        // Show "no results" message if no matches
        const noResultsEl = document.getElementById('handbook-search-no-results');
        if (!matchFound) {
            if (!noResultsEl) {
            const searchContainer = document.querySelector('.handbook-search-container');
            if (searchContainer) {
                searchContainer.insertAdjacentHTML('afterend', `
                <div id="handbook-search-no-results" class="handbook-no-results">
                    <i class="fas fa-search"></i>
                    <p>No results found for "${searchTerm}"</p>
                </div>
                `);
            }
            } else {
            noResultsEl.style.display = 'block';
            noResultsEl.querySelector('p').textContent = `No results found for "${searchTerm}"`;
            }
        } else if (noResultsEl) {
            noResultsEl.style.display = 'none';
        }
        }

        function highlightContentMatches(searchTerm) {
        // Remove existing highlights
        const contentArea = document.getElementById('handbook-article-area');
        if (!contentArea) return;
        
        // First, remove existing highlights
        const highlighted = contentArea.innerHTML;
        const cleaned = highlighted.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
        contentArea.innerHTML = cleaned;
        
        // Don't highlight if search term is too short
        if (searchTerm.length < 2) return;
        
        // Then add new highlights
        const contentNodes = Array.from(contentArea.querySelectorAll('p, h2, h3, h4, li, code'));
        
        contentNodes.forEach(node => {
            const originalText = node.innerHTML;
            if (!originalText.includes('<mark class="search-highlight">')) {
            const newText = originalText.replace(
                new RegExp(searchTerm, 'gi'),
                match => `<mark class="search-highlight">${match}</mark>`
            );
            if (originalText !== newText) {
                node.innerHTML = newText;
            }
            }
        });
        }

        function findSectionById(sectionId) {
        // Look through handbookData to find the section
        let foundSection = null;
        
        handbookData.sections.forEach(section => {
            if (section.id === sectionId) {
            foundSection = section;
            } else if (section.isCategory && section.subcategories) {
            section.subcategories.forEach(subsection => {
                if (subsection.id === sectionId) {
                foundSection = subsection;
                }
            });
            }
        });
        
        return foundSection;
        }

        function openAddSectionModal() {
        // Check if modal already exists
        let modal = document.getElementById('section-editor-modal');
        if (!modal) {
            // Create modal if it doesn't exist
            modal = createSectionEditorModal();
            document.body.appendChild(modal);
        }
        
        // Reset form
        document.getElementById('section-editor-form').reset();
        document.getElementById('section-editor-title').textContent = 'Add New Section';
        document.getElementById('section-id').value = generateSectionId();
        document.getElementById('section-parent').value = '';
        document.getElementById('section-editor-content').innerHTML = '';
        
        // Show parent category selector and icon selector
        document.getElementById('section-parent-group').style.display = 'block';
        document.getElementById('section-icon-group').style.display = 'block';
        
        // Populate parent category select
        populateParentCategorySelect();
        
        // Show the modal
        modal.classList.add('show');
        }

        function openEditSectionModal() {
        // Get current section ID
        const currentSectionId = getCurrentSectionId();
        if (!currentSectionId) {
            showToast('Please select a section to edit', 'warning');
            return;
        }
        
        const sectionData = findSectionById(currentSectionId);
        if (!sectionData) {
            showToast('Section not found', 'error');
            return;
        }
        
        // Create or get modal
        let modal = document.getElementById('section-editor-modal');
        if (!modal) {
            modal = createSectionEditorModal();
            document.body.appendChild(modal);
        }
        
        // Set form values
        document.getElementById('section-editor-title').textContent = 'Edit Section';
        document.getElementById('section-id').value = sectionData.id;
        document.getElementById('section-title').value = sectionData.title;
        document.getElementById('section-icon').value = sectionData.icon || 'fas fa-book';
        document.getElementById('section-editor-content').innerHTML = sectionData.content;
        
        // Hide parent category selector for editing (can't change parent)
        document.getElementById('section-parent-group').style.display = 'none';
        
        // Show the modal
        modal.classList.add('show');
        }

        function confirmDeleteSection() {
        // Get current section ID
        const currentSectionId = getCurrentSectionId();
        if (!currentSectionId) {
            showToast('Please select a section to delete', 'warning');
            return;
        }
        
        const sectionData = findSectionById(currentSectionId);
        if (!sectionData) {
            showToast('Section not found', 'error');
            return;
        }
        
        // Ask for confirmation
        if (confirm(`Are you sure you want to delete the section "${sectionData.title}"?`)) {
            deleteSection(currentSectionId);
        }
        }

        function deleteSection(sectionId) {
        // Find and remove the section from handbookData
        let deleted = false;
        
        // Check top-level sections
        handbookData.sections = handbookData.sections.filter(section => {
            if (section.id === sectionId) {
            deleted = true;
            return false; // Remove this section
            }
            
            // Check subcategories if it's a category
            if (section.isCategory && section.subcategories) {
            section.subcategories = section.subcategories.filter(subsection => {
                if (subsection.id === sectionId) {
                deleted = true;
                return false; // Remove this subsection
                }
                return true;
            });
            }
            
            return true;
        });
        
        if (deleted) {
            // Re-render handbook sidebar and show first section
            renderHandbookSidebar();
            if (handbookData.sections.length > 0) {
            const firstSection = handbookData.sections[0];
            if (firstSection.isCategory && firstSection.subcategories && firstSection.subcategories.length > 0) {
                showHandbookSection(firstSection.subcategories[0].id);
            } else {
                showHandbookSection(firstSection.id);
            }
            }
            
            // Save to localStorage
            saveHandbookData();
            showToast('Section deleted successfully', 'success');
        } else {
            showToast('Failed to delete section', 'error');
        }
        }

        function createSectionEditorModal() {
        const modal = document.createElement('div');
        modal.id = 'section-editor-modal';
        modal.className = 'modal';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
            <h3 id="section-editor-title" style="margin-bottom: 20px; color: var(--primary);">Add New Section</h3>

            <form id="section-editor-form">
                <input type="hidden" id="section-id">

                <div class="form-group">
                <label for="section-title">Section Title</label>
                <input type="text" id="section-title" required placeholder="Enter section title">
                </div>

                <div class="form-group" id="section-parent-group">
                <label for="section-parent">Parent Category</label>
                <select id="section-parent">
                    <option value="">None (Top-level section)</option>
                </select>
                </div>

                <div class="form-group" id="section-icon-group">
                <label for="section-icon">Section Icon</label>
                <input type="text" id="section-icon" placeholder="e.g., fas fa-book" value="fas fa-book">
                <div class="icon-picker-grid" id="section-icon-picker"></div>
                </div>

                <div class="form-group">
                <label for="section-editor-content">Content</label>
                <div class="formatting-toolbar">
                    <button type="button" class="formatting-btn" data-command="bold" title="Bold">
                    <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="italic" title="Italic">
                    <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                    <i class="fas fa-heading"></i>2
                    </button>
                    <button type="button" class="formatting-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                    <i class="fas fa-heading"></i>3
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertUnorderedList" title="Bullet List">
                    <i class="fas fa-list-ul"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertOrderedList" title="Numbered List">
                    <i class="fas fa-list-ol"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="createLink" title="Insert Link">
                    <i class="fas fa-link"></i>
                    </button>
                    <button type="button" class="formatting-btn" data-command="insertHTML" data-value="code-block" title="Insert Code Block">
                    <i class="fas fa-code"></i>
                    </button>
                </div>
                <div id="section-editor-content" class="note-content-editor" contenteditable="true"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" id="cancel-section-edit">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Section</button>
                </div>
            </form>
            </div>
        `;

        document.body.appendChild(modal); // Append the modal to the DOM first

        // Now that the modal is in the DOM, you can safely populate the icon picker
        populateIconPicker('section-icon-picker');

        // Add event listeners
        modal.querySelector('#cancel-section-edit').addEventListener('click', () => {
            modal.classList.remove('show');
        });

        modal.querySelector('#section-editor-form').addEventListener('submit', (e) => {
            e.preventDefault();
            saveSection();
        });

        // Add click outside to close
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
            modal.classList.remove('show');
            }
        });

        return modal;
        }

        function populateParentCategorySelect() {
        const parentSelect = document.getElementById('section-parent');
        
        // Clear existing options except the first one
        while (parentSelect.options.length > 1) {
            parentSelect.remove(1);
        }
        
        // Add category options
        handbookData.sections.forEach(section => {
            if (section.isCategory) {
            const option = document.createElement('option');
            option.value = section.id;
            option.textContent = section.title;
            parentSelect.appendChild(option);
            }
        });
        }

        function initSectionEditor() {
        // Set up editor toolbar functionality
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.formatting-btn');
            if (!btn) return;
            
            const command = btn.dataset.command;
            const value = btn.dataset.value || null;
            const editor = document.getElementById('section-editor-content');
            
            if (!editor) return;
            
            if (command === 'createLink') {
            const url = prompt('Enter the URL:');
            if (url) {
                document.execCommand(command, false, url);
            }
            } else if (command === 'insertHTML' && value === 'code-block') {
            // Insert a code block
            const codeContent = prompt('Enter code content:');
            if (codeContent) {
                const codeBlockHtml = `
                <div class="code-block">
                    <pre><code>${escapeHtml(codeContent)}</code></pre>
                    <button class="copy-btn" data-clipboard-target="#code-${Date.now()}"><i class="fas fa-copy"></i></button>
                </div>
                `;
                document.execCommand('insertHTML', false, codeBlockHtml);
            }
            } else if (command === 'formatBlock') {
            document.execCommand(command, false, value);
            } else {
            document.execCommand(command, false, value);
            }
        });
        
        // Add icon picker functionality
        document.addEventListener('click', (e) => {
            const iconItem = e.target.closest('.icon-picker-item');
            if (!iconItem) return;
            
            const iconPicker = iconItem.closest('.icon-picker-grid');
            if (!iconPicker) return;
            
            // Remove selected class from all icons
            iconPicker.querySelectorAll('.icon-picker-item').forEach(item => {
            item.classList.remove('selected');
            });
            
            // Add selected class to clicked icon
            iconItem.classList.add('selected');
            
            // Update input value
            const iconInput = document.getElementById('section-icon');
            if (iconInput) {
            iconInput.value = iconItem.dataset.iconClass;
            }
        });
        }

        function saveSection() {
        const sectionId = document.getElementById('section-id').value;
        const sectionTitle = document.getElementById('section-title').value;
        const sectionParent = document.getElementById('section-parent').value;
        const sectionIcon = document.getElementById('section-icon').value;
        const sectionContent = document.getElementById('section-editor-content').innerHTML;
        
        // Validate required fields
        if (!sectionTitle) {
            showToast('Section title is required', 'error');
            return;
        }
        
        // Check if editing existing section or adding new one
        const existingSection = findSectionById(sectionId);
        
        if (existingSection) {
            // Update existing section
            existingSection.title = sectionTitle;
            existingSection.icon = sectionIcon;
            existingSection.content = sectionContent;
        } else {
            // Create new section
            const newSection = {
            id: sectionId,
            title: sectionTitle,
            icon: sectionIcon,
            content: sectionContent
            };
            
            if (sectionParent) {
            // Add as subcategory to parent
            const parentCategory = handbookData.sections.find(section => section.id === sectionParent);
            if (parentCategory) {
                // Ensure parent is a category with subcategories array
                if (!parentCategory.isCategory) {
                parentCategory.isCategory = true;
                }
                if (!parentCategory.subcategories) {
                parentCategory.subcategories = [];
                }
                parentCategory.subcategories.push(newSection);
            }
            } else {
            // Add as top-level section
            handbookData.sections.push(newSection);
            }
        }
        
        // Save changes and update UI
        saveHandbookData();
        renderHandbookSidebar();
        showHandbookSection(sectionId);
        
        // Hide modal
        const modal = document.getElementById('section-editor-modal');
        if (modal) {
            modal.classList.remove('show');
        }
        
        showToast('Section saved successfully', 'success');
        }

        function saveHandbookData() {
        // Save to localStorage
        localStorage.setItem('osintHandbookData', JSON.stringify(handbookData));
        }

        function getCurrentSectionId() {
        // Get the currently active section
        const activeNavItem = document.querySelector('.handbook-nav-item.active');
        return activeNavItem ? activeNavItem.dataset.section : null;
        }

        function generateSectionId() {
        // Generate a unique section ID
        return 'section-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
        }

        // Update the showHandbookSection function to handle section management buttons
        const originalShowHandbookSection = showHandbookSection;
        showHandbookSection = function(sectionId) {
        // Call the original function
        originalShowHandbookSection(sectionId);
        
        // Update edit/delete buttons visibility
        const editSectionBtn = document.getElementById('edit-section-btn');
        const deleteSectionBtn = document.getElementById('delete-section-btn');
        
        if (editSectionBtn && deleteSectionBtn) {
            const sectionData = findSectionById(sectionId);
            if (sectionData) {
            editSectionBtn.style.display = 'inline-flex';
            deleteSectionBtn.style.display = 'inline-flex';
            } else {
            editSectionBtn.style.display = 'none';
            deleteSectionBtn.style.display = 'none';
            }
        }
        };

        // Helper function to get week number (ISO week date standard)
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // Initialize handbook and notes functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize handbook functionality
            initHandbook();
            
            // Initialize notes functionality
            initNotes();
            
            // Add event listeners for handbook/notes subtabs
            document.querySelectorAll('.handbook-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const subtab = e.target.dataset.subtab;
                    switchHandbookSubtab(subtab);
                });
            });
        });

        /* -------------------------------------------------------------------------- */
        /* Dork Assistant JS                                                          */
        /* -------------------------------------------------------------------------- */

        const dorkAssistantState = {
            keywords: '',
            customInput: '',
            engine: 'google',
            previewQuery: '',
            convertedQuery: '',
            currentDorkSubTab: 'query-playground',
            savedQueries: [],
            savedQuerySearchTerm: '',
            currentTemplateCategory: 'All Templates', // New: Track active template category
            preTemplateSearchTerm: '' // New: Search term for pre-templates
        };

        const dorkTemplates = {
            "General OSINT": [{
                id: 'exposed_docs',
                name: 'Exposed Documents',
                description: 'Finds publicly accessible PDF, DOCX, or XLSX files containing sensitive terms.',
                keywords: '',
                custom: 'filetype:pdf OR filetype:docx OR filetype:xlsx confidential OR secret',
                engine: 'google'
            }, {
                id: 'login_pages',
                name: 'Admin Login Pages',
                description: 'Discovers common admin login interfaces.',
                keywords: '',
                custom: 'intitle:"Login" inurl:admin OR inurl:auth',
                engine: 'google'
            }, {
                id: 'sensitive_files',
                name: 'Sensitive Filetypes',
                description: 'Identifies configuration files, database backups, or environment files.',
                keywords: '',
                custom: 'inurl:config OR inurl:backup OR inurl:db filetype:sql OR filetype:env',
                engine: 'google'
            }, {
                id: 'pastebin_search',
                name: 'Pastebin Leaks',
                description: 'Searches Pastebin for common sensitive terms or patterns indicating leaks.',
                keywords: 'site:pastebin.com',
                custom: 'password OR "api key" OR "private key"',
                engine: 'google'
            }],
            "IoT / Devices": [{
                id: 'webcams',
                name: 'Open Webcams',
                description: 'Locates publicly accessible webcams and live streams.',
                keywords: '',
                custom: 'intitle:"webcamXP" OR intitle:"live view" inurl:viewerframe.html',
                engine: 'google'
            }, {
                id: 'printers',
                name: 'Network Printers',
                description: 'Finds network-connected printers accessible via web interfaces.',
                keywords: '',
                custom: 'intitle:"printer" inurl:web/guest/en/websys/status/view.htm',
                engine: 'google'
            }, {
                id: 'routers_modems',
                name: 'Router/Modem Interfaces',
                description: 'Discovers common router or modem login pages.',
                keywords: 'intitle:"router setup" OR intitle:"modem config"',
                custom: 'inurl:setup.cgi OR inurl:main.html',
                engine: 'google'
            }],
            "Social Media": [{
                id: 'linkedin_profiles',
                name: 'LinkedIn Profiles',
                description: 'Searches for LinkedIn profiles by job title or keywords within the profile.',
                keywords: '"site:linkedin.com/in"',
                custom: '',
                engine: 'google'
            }, {
                id: 'twitter_emails',
                name: 'Twitter User Emails',
                description: 'Attempts to find email addresses mentioned in public Twitter profiles or tweets.',
                keywords: '"site:twitter.com" "email"',
                custom: '',
                engine: 'google'
            }, {
                id: 'facebook_public',
                name: 'Facebook Public Posts',
                description: 'Searches public Facebook posts for specific terms (limited by Facebook privacy).',
                keywords: 'site:facebook.com/posts',
                custom: '',
                engine: 'google'
            }],
            "Database / Server": [{
                id: 'sql_errors',
                name: 'SQL Injection Errors',
                description: 'Detects common database error messages that may indicate SQL injection vulnerabilities.',
                keywords: '',
                custom: 'intext:"SQL syntax" OR intext:"mysql_fetch_array" OR intext:"Warning: mysql_connect()"',
                engine: 'google'
            }, {
                id: 'phpmyadmin',
                name: 'phpMyAdmin Panels',
                description: 'Discovers publicly accessible phpMyAdmin database management interfaces.',
                keywords: '',
                custom: 'inurl:phpmyadmin intitle:"phpMyAdmin"',
                engine: 'google'
            }, {
                id: 'database_config',
                name: 'Database Config Files',
                description: 'Finds exposed database configuration files that might contain credentials.',
                keywords: 'filetype:sql OR filetype:conf',
                custom: 'intext:"password" OR "username" "database"',
                engine: 'google'
            }],
             "Vulnerability Research": [{
                id: 'cve_poc',
                name: 'CVE PoC/Exploits',
                description: 'Searches for Proof-of-Concept code or exploits related to specific CVEs.',
                keywords: 'github.com',
                custom: 'CVE-202X-XXXXX "PoC" OR "exploit"',
                engine: 'google'
            }, {
                id: 'exploitdb_search',
                name: 'Exploit-DB Search',
                description: 'Finds exploits listed on Exploit-DB for specific software or versions.',
                keywords: 'site:exploit-db.com',
                custom: 'apache OR nginx',
                engine: 'google'
            }],
            "File / Document Analysis": [{
                id: 'git_config',
                name: 'Git Config Files',
                description: 'Discovers exposed Git configuration files that might contain sensitive information.',
                keywords: 'inurl:.git/config',
                custom: '',
                engine: 'google'
            }, {
                id: 'log_files',
                name: 'Exposed Log Files',
                description: 'Identifies publicly accessible server log files.',
                keywords: 'inurl:access.log OR inurl:error.log',
                custom: '',
                engine: 'google'
            }],
            "Network Intelligence": [{
                id: 'open_ports_shodan',
                name: 'Shodan: Open Ports',
                description: 'Shodan query to find hosts with specific open ports (e.g., 22, 80, 443).',
                keywords: '',
                custom: 'port:22 OR port:80 OR port:443',
                engine: 'shodan'
            }, {
                id: 'c2_servers_shodan',
                name: 'Shodan: C2 Servers',
                description: 'Shodan query to identify potential Command and Control servers.',
                keywords: '',
                custom: 'tag:c2 OR "command and control"',
                engine: 'shodan'
            }, {
                id: 'self_signed_certs_censys',
                name: 'Censys: Self-Signed Certs',
                description: 'Censys query to find hosts using self-signed SSL certificates, often found on internal systems.',
                keywords: '',
                custom: 'services.tls.certificates.leaf_data.basic_constraints.is_ca: true and services.tls.certificates.chain.length: 1',
                engine: 'censys'
            }]
        };

        function initDorkAssistant() {
            loadSavedQueries(); // Load saved queries at init
            bindDorkAssistantEvents();
            switchDorkSubTab(dorkAssistantState.currentDorkSubTab); // Show correct sub-tab on load
            updateDorkQueryPreview(); // Initial preview for Playground

        }

        function bindDorkAssistantEvents() {
            // Sub-tab navigation
            document.querySelectorAll('.dork-subtab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchDorkSubTab(e.target.dataset.dorkSubtab);
                });
            });
            document.getElementById('convertAndGoToPlayground').addEventListener('click', () => {
                const currentQuery = document.getElementById('dorkWarningModal').dataset.tempQuery;
                const targetEngine = document.getElementById('dorkWarningModal').dataset.tempEngine; // This is the engine we want to convert TO

                const convertedQuery = convertToShodanCensys(currentQuery, targetEngine);

                document.getElementById('editExecuteTemplateQuery').value = convertedQuery;
                document.getElementById('editExecuteTemplateEngine').value = targetEngine;

                hideModal('dorkWarningModal');
                showToast(`Query converted to ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)} in the editor!`, 'info', 3000);
            });

            // Edit/Execute Template Modal - Perform Conversion Button
            document.getElementById('performEditExecuteConversionBtn').addEventListener('click', () => {
                const currentQueryInput = document.getElementById('editExecuteTemplateQuery');
                const currentQuery = currentQueryInput.value.trim();
                const targetEngine = document.getElementById('editExecuteTemplateEngine').value;

                if (!currentQuery) {
                    showToast('No query to convert.', 'warning');
                    return;
                }
                if (!(targetEngine === 'shodan' || targetEngine === 'censys')) {
                    showToast('Select Shodan or Censys as the target engine to convert.', 'warning');
                    return;
                }

                // Perform the conversion using the existing function
                const convertedQuery = convertToShodanCensys(currentQuery, targetEngine);
                currentQueryInput.value = convertedQuery; // Update the textarea with the converted query
                showToast(`Query converted for ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)}!`, 'success');

                // After conversion, hide the conversion section (optional, but clean)
                document.getElementById('editExecuteConversionSection').style.display = 'none';
            });

            // Query Playground events
            document.getElementById('dorkKeywords').addEventListener('input', updateDorkAssistantState);
            document.getElementById('dorkCustomInput').addEventListener('input', updateDorkAssistantState);
            document.getElementById('dorkEngineSelect').addEventListener('change', updateDorkAssistantState);
            document.querySelectorAll('.dork-operator-btn').forEach(button => {
                button.addEventListener('click', handleOperatorButtonClick);
            });
            document.getElementById('executeDorkBtn').addEventListener('click', () => executeDorkQuery()); // Corrected to call with no arguments
            document.getElementById('clearDorkBuilderBtn').addEventListener('click', clearDorkBuilder);
            document.getElementById('convertDorkBtn').addEventListener('click', convertDorkQuery);
            document.getElementById('executeConvertedDorkBtn').addEventListener('click', () => {
                const convertedQuery = document.getElementById('convertedDorkPreview').value;
                const targetEngine = document.getElementById('conversionTarget').value; // Get the engine selected for conversion
                if (convertedQuery && targetEngine) {
                    executeDorkQuery(convertedQuery, targetEngine);
                } else {
                    showToast('No converted query or target engine selected.', 'warning');
                }
            });
            document.getElementById('conversionTarget').addEventListener('change', () => {
                // When the target engine changes, clear the converted preview and hide the execute button.
                // The convertDorkQuery function will handle showing it again if conversion is performed.
                document.getElementById('convertedDorkPreview').value = ''; // Clear content
                document.getElementById('convertedDorkPreview').style.display = 'none'; // Hide preview
                document.getElementById('executeConvertedDorkBtn').style.display = 'none'; // Hide button
            });
            document.getElementById('executeConvertedDorkBtn').style.display = 'none';
            document.getElementById('saveCurrentDorkBtn').addEventListener('click', openSaveDorkQueryModal);

            // Pre-Templates events
            // No specific events for dorkTemplateSelect and applyDorkTemplateBtn are needed in the playground tab anymore
            // They are only used for the pre-templates list now.

            // Saved Queries events
            document.getElementById('savedQueriesSearch').addEventListener('input', (e) => {
                dorkAssistantState.savedQuerySearchTerm = e.target.value;
                renderSavedQueries();
            });
            document.getElementById('clearSavedQueriesSearch').addEventListener('click', () => {
                document.getElementById('savedQueriesSearch').value = '';
                dorkAssistantState.savedQuerySearchTerm = '';
                renderSavedQueries();
            });

            // Save Query Modal events
            document.getElementById('cancelSaveDorkQuery').addEventListener('click', () => hideModal('saveDorkQueryModal'));
            document.getElementById('saveDorkQueryForm').addEventListener('submit', handleSaveDorkQuery);
            // Dork Warning Modal events
            document.getElementById('cancelDorkWarning').addEventListener('click', () => {
                hideModal('dorkWarningModal');
                showToast('Execution cancelled by user.', 'info');
                // Keep the edit modal open if user cancelled warning
            });

            document.getElementById('continueDorkExecution').addEventListener('click', () => {
                const query = document.getElementById('dorkWarningModal').dataset.tempQuery;
                const engine = document.getElementById('dorkWarningModal').dataset.tempEngine;

                hideModal('dorkWarningModal');     // Hide warning modal
                hideModal('editExecuteTemplateModal'); // Hide edit modal
                executeDorkQuery(query, engine); // Execute with stored values
            });
        }

        function switchDorkSubTab(subtabName) {
            dorkAssistantState.currentDorkSubTab = subtabName;

            document.querySelectorAll('.dork-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.dork-subtab[data-dork-subtab="${subtabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }

            document.querySelectorAll('.dork-subtab-content').forEach(content => {
                content.style.display = 'none';
            });
            const targetContent = document.getElementById(`${subtabName}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }

            // Render content specific to the sub-tab
            if (subtabName === 'pre-templates') {
                renderPreTemplates();
            } else if (subtabName === 'saved-queries') {
                renderSavedQueries();
            }
            saveDorkAssistantState();
        }

        function updateDorkAssistantState() {
            dorkAssistantState.keywords = document.getElementById('dorkKeywords').value.trim();
            dorkAssistantState.customInput = document.getElementById('dorkCustomInput').value.trim();
            dorkAssistantState.engine = document.getElementById('dorkEngineSelect').value;
            updateDorkQueryPreview();
            saveDorkAssistantState();
        }

        function handleOperatorButtonClick(event) {
            const operator = event.target.dataset.operator;
            const customInputEl = document.getElementById('dorkCustomInput');
            let currentInput = customInputEl.value.trim();

            if (currentInput && !currentInput.endsWith(' ') && !operator.startsWith(':') && !operator.startsWith('-') && operator !== 'OR' && operator !== 'AND') {
                currentInput += ' '; // Add space if not an affix operator or boolean
            }
            customInputEl.value = currentInput + operator;
            updateDorkAssistantState(); // Update and regenerate preview
        }

        function updateDorkQueryPreview() {
            let queryParts = [];

            // Add keywords
            const keywords = dorkAssistantState.keywords.split(',').map(k => k.trim()).filter(k => k);
            if (keywords.length > 0) {
                queryParts.push(keywords.map(k => {
                    // Automatically quote multi-word keywords unless already quoted
                    return k.includes(' ') && !k.startsWith('"') && !k.startsWith('site:') && !k.startsWith('filetype:') && !k.startsWith('intitle:') && !k.startsWith('inurl:') && !k.startsWith('intext:') && !k.startsWith('related:') && !k.startsWith('cache:') ? `"${k}"` : k;
                }).join(' '));
            }

            // Add custom input
            if (dorkAssistantState.customInput) {
                queryParts.push(dorkAssistantState.customInput);
            }

            let finalQuery = queryParts.join(' ').trim();

            document.getElementById('dorkQueryPreview').value = finalQuery;
            dorkAssistantState.previewQuery = finalQuery;
        }

        function executeDorkQuery(queryToExecute = null, engineToUse = null) {
            const query = queryToExecute || dorkAssistantState.previewQuery;
            const engine = engineToUse || dorkAssistantState.engine;

            if (!query) {
                showToast('Query is empty. Please build a query or select a template/saved query first.', 'warning');
                return;
            }

            let searchUrl = '';
            switch (engine) {
                case 'google':
                    searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    break;
                case 'duckduckgo':
                    searchUrl = `https://duckduckgo.com/?q=${encodeURIComponent(query)}`;
                    break;
                case 'bing':
                    searchUrl = `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
                    break;
                case 'yandex':
                    searchUrl = `https://yandex.com/search/?text=${encodeURIComponent(query)}`;
                    break;
                case 'shodan':
                    searchUrl = `https://www.shodan.io/search?query=${encodeURIComponent(query)}`;
                    break;
                case 'censys':
                    searchUrl = `https://search.censys.io/search?query=${encodeURIComponent(query)}&resource=hosts`;
                    break;
                default:
                    showToast('Unsupported search engine selected for execution.', 'error');
                    return;
            }

            window.open(searchUrl, '_blank');
            showToast(`Executing query on ${engine.charAt(0).toUpperCase() + engine.slice(1)}...`);
        }

        function clearDorkBuilder() {
            document.getElementById('dorkKeywords').value = '';
            document.getElementById('dorkCustomInput').value = '';
            document.getElementById('dorkEngineSelect').value = 'google';
            document.getElementById('convertedDorkPreview').style.display = 'none';
            dorkAssistantState.keywords = '';
            dorkAssistantState.customInput = '';
            dorkAssistantState.engine = 'google';
            updateDorkQueryPreview();
            showToast('Query Playground cleared!');
            saveDorkAssistantState();
        }

        function convertDorkQuery(targetEngineOverride = null) { // Modified signature
            const originalQuery = dorkAssistantState.previewQuery;
            const targetEngine = targetEngineOverride || document.getElementById('conversionTarget').value; // Use override if provided, else get from dropdown
            const convertedPreviewEl = document.getElementById('convertedDorkPreview');

            if (!originalQuery) {
                showToast('No query to convert. Please build a query first.', 'warning');
                return;
            }
            if (!targetEngine) { // This check should now rarely fail if override is used
                showToast('Please select a target engine for conversion.', 'warning');
                return;
            }

            const convertedQuery = convertToShodanCensys(originalQuery, targetEngine);
            convertedPreviewEl.value = convertedQuery;
            convertedPreviewEl.style.display = 'block'; // Ensure preview is shown
            document.getElementById('executeConvertedDorkBtn').style.display = 'block'; // Ensure button is shown
            dorkAssistantState.convertedQuery = convertedQuery; // Update state
            showToast(`Query converted for ${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)}!`, 'success');
        }

        function convertToShodanCensys(query, targetEngine) {
            let converted = query;

            // Step 1: Normalize common Google-like operators to a intermediate format
            converted = converted.replace(/site:([^\s]+)/gi, 'HOST:$1');
            converted = converted.replace(/intitle:"([^"]+)"/gi, 'TITLE:"$1"');
            converted = converted.replace(/intitle:([^\s]+)/gi, 'TITLE:$1');
            converted = converted.replace(/inurl:([^\s]+)/gi, 'URL:$1');
            converted = converted.replace(/intext:"([^"]+)"/gi, 'BODY:"$1"');
            converted = converted.replace(/intext:([^\s]+)/gi, 'BODY:$1');
            converted = converted.replace(/filetype:([^\s]+)/gi, 'FILETYPE:$1');

            // Step 2: Convert intermediate format to target engine specific syntax
            if (targetEngine === 'shodan') {
                converted = converted.replace(/HOST:/gi, 'hostname:');
                converted = converted.replace(/TITLE:/gi, 'title:');
                converted = converted.replace(/URL:/gi, '443.url:'); // Common Shodan URL field
                converted = converted.replace(/BODY:/gi, 'http.html:'); // Basic Shodan HTTP body search
                converted = converted.replace(/FILETYPE:(pdf|docx|xlsx)/gi, 'http.content_type:$1'); // Basic Shodan content type
                // Add common Shodan filters based on keywords/patterns
                if (query.toLowerCase().includes('webcam') || query.toLowerCase().includes('camera')) {
                    converted += ' port:8080 OR port:80 OR port:443 webcam';
                }
                if (query.toLowerCase().includes('printer')) {
                    converted += ' product:printer';
                }
                if (query.toLowerCase().includes('apache')) {
                    converted += ' product:apache';
                }
                if (query.toLowerCase().includes('nginx')) {
                    converted += ' product:nginx';
                }
            } else if (targetEngine === 'censys') {
                converted = converted.replace(/HOST:/gi, 'services.dns.names:'); // More accurate for Censys
                converted = converted.replace(/TITLE:/gi, 'services.http.response.html.title:');
                converted = converted.replace(/URL:/gi, 'services.http.response.request.url:');
                converted = converted.replace(/BODY:/gi, 'services.http.response.html.body:');
                converted = converted.replace(/FILETYPE:(pdf|docx|xlsx)/gi, 'services.http.response.headers.content_type:$1');
                // Add common Censys filters based on keywords/patterns
                if (query.toLowerCase().includes('webcam') || query.toLowerCase().includes('camera')) {
                    converted += ' services.http.tags:webcam';
                }
                if (query.toLowerCase().includes('printer')) {
                    converted += ' services.fingerprint.product:printer';
                }
                if (query.toLowerCase().includes('apache')) {
                    converted += ' services.http.metadata.product:Apache';
                }
            }

            // Remove any leftover intermediate tags if no conversion was applicable
            converted = converted.replace(/HOST:/gi, '');
            converted = converted.replace(/TITLE:/gi, '');
            converted = converted.replace(/URL:/gi, '');
            converted = converted.replace(/BODY:/gi, '');
            converted = converted.replace(/FILETYPE:/gi, '');

            // Clean up multiple spaces and trim
            return converted.replace(/\s+/g, ' ').trim();
        }

        // --- Pre-Templates Logic ---
        function renderPreTemplates() {
            const templatesList = document.getElementById('dorkTemplatesList');
            const preTemplatesEmptyState = document.getElementById('preTemplatesEmptyState');
            const categoriesListContainer = document.getElementById('preTemplateCategoriesList');
            const categoriesEmptyState = document.getElementById('preTemplateCategoriesEmptyState');
            const currentTemplateCategoryTitle = document.getElementById('currentTemplateCategoryTitle');
            const preTemplateSearchInput = document.getElementById('preTemplateSearchInput');

            templatesList.innerHTML = ''; // Clear previous templates
            categoriesListContainer.innerHTML = ''; // Clear previous categories

            const categories = Object.keys(dorkTemplates);

            if (categories.length === 0) {
                categoriesEmptyState.style.display = 'block';
                templatesList.style.display = 'none';
                preTemplatesEmptyState.style.display = 'none';
                return;
            }

            categoriesEmptyState.style.display = 'none';
            templatesList.style.display = 'grid';
            preTemplatesEmptyState.style.display = 'none'; // Initially hide template empty state

            // Render Categories Sidebar
            let allTemplatesCount = 0;
            // Add "All Templates" category first
            const allCategoryItem = document.createElement('div');
            allCategoryItem.classList.add('category-item');
            allCategoryItem.dataset.category = 'All Templates';
            allCategoryItem.innerHTML = `<i class="fas fa-layer-group"></i> <span>All Templates</span> <span class="template-count">0</span>`;
            categoriesListContainer.appendChild(allCategoryItem);

            categories.forEach(categoryName => {
                const categoryTemplates = dorkTemplates[categoryName] || [];
                allTemplatesCount += categoryTemplates.length;

                const categoryItem = document.createElement('div');
                categoryItem.classList.add('category-item');
                categoryItem.dataset.category = categoryName;
                categoryItem.innerHTML = `<i class="fas fa-folder-open"></i> <span>${categoryName}</span> <span class="template-count">${categoryTemplates.length}</span>`;
                categoriesListContainer.appendChild(categoryItem);
            });

            // Update All Templates count
            const allCountSpan = allCategoryItem.querySelector('.template-count');
            if (allCountSpan) {
                allCountSpan.textContent = allTemplatesCount;
            }

            // Set active category in sidebar
            document.querySelectorAll('#preTemplateCategoriesList .category-item').forEach(item => {
                if (item.dataset.category === dorkAssistantState.currentTemplateCategory) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Set main content title
            currentTemplateCategoryTitle.textContent = dorkAssistantState.currentTemplateCategory;

            // Apply search term to input
            preTemplateSearchInput.value = dorkAssistantState.preTemplateSearchTerm;

            // Filter templates based on selected category and search term
            let templatesToRender = [];
            if (dorkAssistantState.currentTemplateCategory === 'All Templates') {
                Object.values(dorkTemplates).forEach(templateArray => {
                    templatesToRender = templatesToRender.concat(templateArray);
                });
            } else {
                templatesToRender = dorkTemplates[dorkAssistantState.currentTemplateCategory] || [];
            }

            if (dorkAssistantState.preTemplateSearchTerm) {
                const searchTerm = dorkAssistantState.preTemplateSearchTerm.toLowerCase();
                templatesToRender = templatesToRender.filter(template => {
                    const fullQuery = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`;
                    return template.name.toLowerCase().includes(searchTerm) ||
                           template.description.toLowerCase().includes(searchTerm) ||
                           fullQuery.toLowerCase().includes(searchTerm) ||
                           template.engine.toLowerCase().includes(searchTerm);
                });
            }

            // Sort templates alphabetically by name
            templatesToRender.sort((a, b) => a.name.localeCompare(b.name));

            if (templatesToRender.length === 0) {
                preTemplatesEmptyState.style.display = 'block';
                templatesList.style.display = 'none';
            } else {
                preTemplatesEmptyState.style.display = 'none';
                templatesList.style.display = 'grid';
                templatesToRender.forEach(template => {
                    const fullQuery = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`;
                    templatesList.innerHTML += `
                        <div class="dork-template-card" data-template-id="${template.id}">
                            <div class="template-header">
                                <span>${template.name}</span>
                                <span class="template-engine">${template.engine.charAt(0).toUpperCase() + template.engine.slice(1)}</span>
                            </div>
                            <div class="template-query">${fullQuery.trim()}</div>
                            <div class="template-description">${template.description}</div>
                            <div class="template-actions">
                                <button class="btn btn-primary btn-sm apply-template-btn" data-template-id="${template.id}">
                                    <i class="fas fa-magic"></i> Apply
                                </button>
                                <button class="btn btn-secondary btn-sm execute-template-btn" data-template-id="${template.id}">
                                    <i class="fas fa-play"></i> Execute
                                </button>
                                <button class="btn btn-secondary btn-sm edit-execute-template-btn" data-template-id="${template.id}">
                                    <i class="fas fa-edit"></i> Edit & Run
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            // Add event listeners for new elements
            document.querySelectorAll('#preTemplateCategoriesList .category-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    dorkAssistantState.currentTemplateCategory = e.currentTarget.dataset.category;
                    renderPreTemplates(); // Re-render templates for new category
                });
            });

            // Debounce for pre-template search input
            let preTemplateSearchTimeout;
            document.getElementById('preTemplateSearchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                clearTimeout(preTemplateSearchTimeout); // Clear previous timeout
                preTemplateSearchTimeout = setTimeout(() => {
                    dorkAssistantState.preTemplateSearchTerm = searchTerm;
                    renderPreTemplates(); // Only call render after a delay
                }, 300); // 300ms delay after last keystroke
            });

            let clearPreTemplateSearchTimeout; // Declare this outside the event listener but within the function
            document.getElementById('clearPreTemplateSearch').addEventListener('click', () => {
                clearTimeout(clearPreTemplateSearchTimeout); // Clear any previous timeout
                clearPreTemplateSearchTimeout = setTimeout(() => {
                    dorkAssistantState.preTemplateSearchTerm = '';
                    document.getElementById('preTemplateSearchInput').value = '';
                    renderPreTemplates(); // Only call render after a delay
                }, 100); // A shorter delay for a button click might be acceptable, or keep it at 300ms if desired.
            });

            // Re-attach event listeners for template buttons as they are re-rendered
            document.querySelectorAll('.apply-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.dataset.templateId;
                    applySelectedTemplate(templateId);
                });
            });
            document.querySelectorAll('.execute-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.dataset.templateId;
                    executeTemplateQuery(templateId);
                });
            });
            // Add event listeners for new elements
            document.querySelectorAll('.edit-execute-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.dataset.templateId;
                    openEditExecuteTemplateModal(templateId);
                });
            });

            // Edit/Execute Template Modal events
            document.getElementById('cancelEditExecuteTemplate').addEventListener('click', () => hideModal('editExecuteTemplateModal'));
            document.getElementById('editExecuteTemplateForm').addEventListener('submit', handleEditExecuteTemplate);
            // Edit/Execute Template Modal - Engine Change Listener
            document.getElementById('editExecuteTemplateEngine').addEventListener('change', () => {
                const selectedEngine = document.getElementById('editExecuteTemplateEngine').value;
                const conversionSection = document.getElementById('editExecuteConversionSection');

                if (selectedEngine === 'shodan' || selectedEngine === 'censys') {
                    conversionSection.style.display = 'block';
                } else {
                    conversionSection.style.display = 'none';
                    // Optionally, reset query here if you converted and switched back
                    // document.getElementById('editExecuteTemplateQuery').value = originalTemplateQuery; // Need to store original
                }
            });
        }

        function applySelectedTemplate(templateId) {
            // Because dorkTemplates is now an object of objects, we need to iterate to find the template
            let template = null;
            for (const category in dorkTemplates) {
                template = dorkTemplates[category].find(t => t.id === templateId);
                if (template) break; // Found it, stop searching
            }

            if (template) {
                // Switch to Query Playground tab first
                switchDorkSubTab('query-playground');

                // Populate playground fields
                document.getElementById('dorkKeywords').value = template.keywords;
                document.getElementById('dorkCustomInput').value = template.custom;
                document.getElementById('dorkEngineSelect').value = template.engine;

                // Update state and preview
                updateDorkAssistantState();
                showToast(`Template "${template.name}" applied to playground!`, 'success');
            }
        }

        function executeTemplateQuery(templateId) {
            let template = null;
            for (const category in dorkTemplates) {
                template = dorkTemplates[category].find(t => t.id === templateId);
                if (template) break;
            }

            if (template) {
                const query = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`.trim();
                executeDorkQuery(query, template.engine);
            }
        }

        function openEditExecuteTemplateModal(templateId) {
            let template = null;
            for (const category in dorkTemplates) {
                template = dorkTemplates[category].find(t => t.id === templateId);
                if (template) break;
            }

            if (template) {
                document.getElementById('editExecuteTemplateId').value = template.id;
                document.getElementById('editExecuteTemplateName').value = template.name;
                const fullQuery = `${template.keywords ? template.keywords + ' ' : ''}${template.custom}`;
                document.getElementById('editExecuteTemplateQuery').value = fullQuery.trim();
                document.getElementById('editExecuteTemplateEngine').value = template.engine;
                showModal('editExecuteTemplateModal');
            } else {
                showToast('Template not found!', 'error');
            }
            // NEW: Hide conversion section initially
            document.getElementById('editExecuteConversionSection').style.display = 'none';
        }

        function handleEditExecuteTemplate(e) {
            e.preventDefault();
            const query = document.getElementById('editExecuteTemplateQuery').value.trim();
            const engine = document.getElementById('editExecuteTemplateEngine').value;

            if (!query) {
                showToast('Query cannot be empty.', 'warning');
                return;
            }

            const templateId = document.getElementById('editExecuteTemplateId').value;
            let originalTemplate = null;
            for (const category in dorkTemplates) {
                originalTemplate = dorkTemplates[category].find(t => t.id === templateId);
                if (originalTemplate) break;
            }

            let showWarning = false;
            let warningMessage = '';

            if (originalTemplate) {
                const originalEngine = originalTemplate.engine;

                if ((engine === 'shodan' || engine === 'censys') && !(originalEngine === 'shodan' || originalEngine === 'censys')) {
                    const isLikelyConverted = query.includes('hostname:') || query.includes('product:') || query.includes('services.') || query.includes('http.html:') || query.includes('ssl.cert.');

                    if (!isLikelyConverted) {
                        showWarning = true;
                        warningMessage = `This query was designed for '${originalEngine}' and the current query ` +
                                         `does not appear to be in '${engine}' format. It might not work correctly. ` +
                                         `You can choose to convert it to a '${engine}' query or continue execution anyway.`;
                    }
                }
            }

            if (showWarning) {
                document.getElementById('dorkWarningMessage').innerText = warningMessage;
                // Store the current query and engine temporarily for the modal's buttons
                document.getElementById('dorkWarningModal').dataset.tempQuery = query;
                document.getElementById('dorkWarningModal').dataset.tempEngine = engine; // The selected target engine for execution

                showModal('dorkWarningModal'); // Show the custom warning modal
            } else {
                // No warning needed, proceed directly
                hideModal('editExecuteTemplateModal');
                executeDorkQuery(query, engine);
            }
        }

        // --- Saved Queries Logic ---
        function loadSavedQueries() {
            const saved = localStorage.getItem('osintDorkSavedQueries');
            if (saved) {
                dorkAssistantState.savedQueries = JSON.parse(saved);
            }
        }

        function saveSavedQueries() {
            localStorage.setItem('osintDorkSavedQueries', JSON.stringify(dorkAssistantState.savedQueries));
        }

        function openSaveDorkQueryModal() {
            const currentQuery = dorkAssistantState.previewQuery;
            const currentEngine = dorkAssistantState.engine;

            if (!currentQuery) {
                showToast('No query in playground to save.', 'warning');
                return;
            }

            document.getElementById('saveDorkQueryForm').reset();
            document.getElementById('savedQueryGenerated').value = currentQuery;
            document.getElementById('savedQueryEngine').value = currentEngine.charAt(0).toUpperCase() + currentEngine.slice(1);
            showModal('saveDorkQueryModal');
        }

        function handleSaveDorkQuery(e) {
            e.preventDefault();
            const queryName = document.getElementById('savedQueryName').value.trim();
            const queryDescription = document.getElementById('savedQueryDescription').value.trim();
            const queryTags = document.getElementById('savedQueryTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const generatedQuery = document.getElementById('savedQueryGenerated').value;
            const targetEngine = document.getElementById('savedQueryEngine').value.toLowerCase(); // Convert back to lower case for consistency

            if (!queryName) {
                showToast('Please enter a name for the query.', 'error');
                return;
            }

            const newSavedQuery = {
                id: `dork-${Date.now()}`,
                name: queryName,
                description: queryDescription,
                query: generatedQuery,
                engine: targetEngine,
                tags: queryTags,
                createdAt: new Date().toISOString()
            };

            dorkAssistantState.savedQueries.push(newSavedQuery);
            saveSavedQueries();
            hideModal('saveDorkQueryModal');
            showToast('Query saved successfully!', 'success');
            renderSavedQueries(); // Update the saved queries list
        }

        function renderSavedQueries() {
            const savedQueriesList = document.getElementById('savedQueriesList');
            const savedQueriesEmptyState = document.getElementById('savedQueriesEmptyState');
            savedQueriesList.innerHTML = ''; // Clear previous

            const searchTerm = dorkAssistantState.savedQuerySearchTerm.toLowerCase();
            const filteredQueries = dorkAssistantState.savedQueries.filter(q => {
                const nameMatch = q.name.toLowerCase().includes(searchTerm);
                const descMatch = q.description.toLowerCase().includes(searchTerm);
                const queryMatch = q.query.toLowerCase().includes(searchTerm);
                const tagMatch = q.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                return nameMatch || descMatch || queryMatch || tagMatch;
            });

            if (filteredQueries.length === 0) {
                savedQueriesEmptyState.style.display = 'block';
                savedQueriesList.style.display = 'none';
                if (searchTerm) {
                    savedQueriesEmptyState.innerHTML = `<i class="fas fa-search"></i><h3>No matching saved queries found</h3><p>Try a different search term.</p>`;
                } else {
                    savedQueriesEmptyState.innerHTML = `<i class="fas fa-bookmark"></i><h3>No Saved Queries Yet</h3><p>Save your favorite dork queries from the Query Playground!</p>`;
                }
                return;
            }

            savedQueriesEmptyState.style.display = 'none';
            savedQueriesList.style.display = 'grid'; // Ensure grid display

            filteredQueries.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(query => {
                savedQueriesList.innerHTML += `
                    <div class="saved-query-card" data-query-id="${query.id}">
                        <div class="query-header">
                            <span>${query.name}</span>
                            <span class="query-engine">${query.engine.charAt(0).toUpperCase() + query.engine.slice(1)}</span>
                        </div>
                        <div class="query-string">${query.query}</div>
                        <div class="query-description">${query.description || 'No description.'}</div>
                        <div class="saved-query-tags">
                            ${query.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div class="query-actions">
                            <button class="btn btn-primary btn-sm load-query-btn" data-query-id="${query.id}">
                                <i class="fas fa-file-import"></i> Load
                            </button>
                            <button class="btn btn-secondary btn-sm execute-saved-query-btn" data-query-id="${query.id}">
                                <i class="fas fa-play"></i> Execute
                            </button>
                            <button class="btn btn-danger btn-sm delete-saved-query-btn" data-query-id="${query.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            // Add event listeners for saved query actions
            document.querySelectorAll('.load-query-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const queryId = e.target.dataset.queryId;
                    loadSavedQueryToPlayground(queryId);
                });
            });
            document.querySelectorAll('.execute-saved-query-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const queryId = e.target.dataset.queryId;
                    executeSavedQuery(queryId);
                });
            });
            document.querySelectorAll('.delete-saved-query-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const queryId = e.target.dataset.queryId;
                    deleteSavedQuery(queryId);
                });
            });
        }

        function loadSavedQueryToPlayground(queryId) {
            const queryToLoad = dorkAssistantState.savedQueries.find(q => q.id === queryId);
            if (queryToLoad) {
                switchDorkSubTab('query-playground'); // Switch back to playground

                document.getElementById('dorkKeywords').value = ''; // Clear keywords as they are embedded in 'query'
                document.getElementById('dorkCustomInput').value = queryToLoad.query; // Load full query into custom input
                document.getElementById('dorkEngineSelect').value = queryToLoad.engine;

                updateDorkAssistantState(); // Update state and preview
                showToast(`Saved query "${queryToLoad.name}" loaded to playground!`, 'success');
            }
        }

        function executeSavedQuery(queryId) {
            const queryToExecute = dorkAssistantState.savedQueries.find(q => q.id === queryId);
            if (queryToExecute) {
                executeDorkQuery(queryToExecute.query, queryToExecute.engine);
            }
        }

        function deleteSavedQuery(queryId) {
            if (confirm('Are you sure you want to delete this saved query?')) {
                dorkAssistantState.savedQueries = dorkAssistantState.savedQueries.filter(q => q.id !== queryId);
                saveSavedQueries();
                showToast('Saved query deleted!', 'error');
                renderSavedQueries();
            }
        }

        function saveDorkAssistantState() {
            localStorage.setItem('osintDorkAssistantState', JSON.stringify(dorkAssistantState));
        }

        function loadDorkAssistantState() {
            const savedState = localStorage.getItem('osintDorkAssistantState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(dorkAssistantState, parsedState);
            }
        }

        // Add loadDorkAssistantState to the very beginning of initApp
        const originalInitApp = initApp;
        initApp = function() {
            loadDorkAssistantState(); // Load the dork assistant state first
            originalInitApp(); // Call the original initApp
            initDorkAssistant(); // Initialize the new dork assistant
            // The switchDorkSubTab call in initDorkAssistant handles showing the correct tab
        };
        

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
