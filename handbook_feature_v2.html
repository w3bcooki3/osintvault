<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINTVault - Your OSINT tools, always with you</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./favicon.png" type="image/x-icon">
    <style>
        /* Refined Color Palette & Variables */
        :root {
            --primary: #007bff; /* Slightly less vibrant blue, more authoritative */
            --primary-dark: #0056b3;
            --secondary: #ff6b35; /* Strong accent for highlights */
            --accent: #28a745; /* Positive action/success */
            --danger: #dc3545;
            --warning: #ffaa00;
            --success: #28a745;

            /* Darker, more professional greyscale for dark theme */
            --bg-primary: #0C1017; /* Deeper primary background */
            --bg-secondary: #171E28; /* Slightly lighter card/section background */
            --bg-tertiary: #212B3B; /* Input/hover background */
            --bg-card: #1E2736;     /* Card background */

            --text-primary: #E0E6F0; /* Brighter text for contrast */
            --text-secondary: #9BAEC8; /* Muted text */
            --text-muted: #6A7F9D;    /* Even more muted text */

            --border: #3D4C61;      /* Stronger but still subtle border */
            --border-light: #526680; /* Lighter border for dividers */

            /* Softer, multi-layered shadow */
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.3), 0 16px 60px rgba(0, 0, 0, 0.2);

            --glow: 0 0 15px rgba(0, 123, 255, 0.4); /* Adjusted glow for new primary */
            --primary-shadow-color: rgba(0, 123, 255, 0.3); /* For primary button shadow */
            --primary-shadow-color-hover: rgba(0, 123, 255, 0.4);

            /* Very subtle gradient, mainly for active states or branding */
            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #1e8738);
            /* Softened background gradient */
            --gradient-bg: linear-gradient(135deg, #0C1017, #171E28);

            /* Default Tab Colors */
            --tab-color-default: var(--primary);
            --tab-color-red: #e74c3c;
            --tab-color-blue: #3498db;
            --tab-color-green: #2ecc71;
            --tab-color-yellow: #f1c40f;
            --tab-color-purple: #9b59b6;
            --tab-color-orange: #e67e22;
        }

        [data-theme="light"] {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --accent: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;

            /* Lighter, professional greyscale for light theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F9FC; /* Slightly off-white for sections */
            --bg-tertiary: #E8EEF5; /* Light grey for inputs/hovers */
            --bg-card: #FFFFFF;    /* White card background */

            --text-primary: #2C3E50; /* Darker text for readability */
            --text-secondary: #607D8B; /* Muted grey text */
            --text-muted: #95A5A6;    /* Even more muted */

            --border: #CFD8DC; /* Light grey border */
            --border-light: #ECEFF1; /* Very light border */

            --glow: 0 0 10px rgba(0, 123, 255, 0.2);
            --shadow: 0 1px 4px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08);

            --gradient-primary: linear-gradient(135deg, #007bff, #0056b3);
            --gradient-secondary: linear-gradient(135deg, #dc3545, #b02a37);
            --gradient-accent: linear-gradient(135deg, #28a745, #218838);
            --gradient-bg: linear-gradient(135deg, #F7F9FC, #E8EEF5);

            /* Default Tab Colors (Light Theme) */
            --tab-color-default: var(--primary);
            --tab-color-red: #c0392b;
            --tab-color-blue: #2980b9;
            --tab-color-green: #27ae60;
            --tab-color-yellow: #f39c12;
            --tab-color-purple: #8e44ad;
            --tab-color-orange: #d35400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg); /* Use the softened gradient */
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            width: 100%; /* Make it full screen */
            max-width: 100%; /* Ensure it spans fully */
            padding: 0; /* Remove horizontal padding at container level */
            margin: 0 auto; /* Center the container */
        }

        /* Header Styles */
        header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow); /* Use the new softer shadow */
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1800px; /* Constrain content width within header */
            margin: 0 auto; /* Center header content */
            padding: 0 40px; /* Generous padding for header content */
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 28px; /* Slightly larger logo text */
            font-weight: 700;
            color: var(--primary);
            font-family: 'Outfit', sans-serif; /* New font for logo */
            letter-spacing: -0.5px; /* Tighter letter spacing */
            cursor: default; /* Indicate not clickable */
        }

        .logo i {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
            transition: transform 0.2s ease-out, filter 0.2s ease-out; /* Smooth transition */
        }
        .logo:hover i {
            transform: scale(1.05); /* Subtle scale on hover */
            filter: drop-shadow(0 0 15px rgba(0, 212, 255, 0.7));
        }

        .tagline {
            font-size: 0.8rem; /* Slightly smaller, more refined tagline */
            color: var(--text-muted);
            margin-top: 5px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-container {
            position: relative;
            min-width: 350px;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 1px solid var(--border-light); /* Thinner, lighter border */
            border-radius: 12px;
            font-size: 14px;
            background: var(--bg-tertiary); /* Lighter background for inputs */
            color: var(--text-primary);
            transition: all 0.3s ease;
            flex-grow: 1;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Inner shadow for depth */
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.15);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        /* New: Search Scope Select */
        #searchScopeSelect {
            margin-left: 10px;
            padding: 10px 12px; /* Adjusted padding */
            border-radius: 8px;
            background: var(--bg-tertiary); /* Lighter background */
            color: var(--text-primary);
            border: 1px solid var(--border-light); /* Lighter border */
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        #searchScopeSelect:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.1);
        }


        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 30px;
            align-items: center;
            padding: 15px 40px; /* Match header padding */
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            border-radius: 0; /* Remove rounded corners */
            margin: 0;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow to stats bar */
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-item i {
            color: var(--primary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Button Styles */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px; /* Slightly more rounded */
            font-size: 14px;
            font-weight: 600; /* Bolder text */
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.2px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-shadow-color);
        }

        .btn-primary:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 25px var(--primary-shadow-color-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow); /* Add shadow to secondary buttons */
        }

        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg); /* Increased shadow on hover */
        }

        .btn-danger {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 51, 102, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            margin: 20px 40px 0; /* Add horizontal padding for main tabs */
            /* Replaced border-bottom with a more integrated look */
            background: var(--bg-secondary);
            border-radius: 12px; /* Rounded container for tabs */
            padding: 8px; /* More padding around tabs */
            transition: background 0.3s ease, border-color 0.3s ease;
            flex-wrap: wrap;
            box-shadow: var(--shadow); /* Add shadow to tab container */
        }

        .nav-tab {
            padding: 14px 22px; /* Adjusted padding for a cleaner look */
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px; /* Match button border-radius */
            font-weight: 600;
            position: relative;
            flex-grow: 1;
            text-align: center;
        }

        .nav-tab.active {
            background: var(--gradient-primary); /* Keep gradient for active */
            color: white;
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Sub-tabs styling */
        .sub-nav-tabs {
            display: flex;
            gap: 0;
            margin-top: 20px;
            border: 1px solid var(--border-light); /* Lighter border */
            background: var(--bg-tertiary); /* Slightly different background for sub-tabs */
            border-radius: 8px; /* Slightly smaller radius than main tabs */
            padding: 4px; /* Less padding */
            flex-wrap: wrap;
            box-shadow: var(--shadow); /* Add shadow to sub-tab container */
        }

        .sub-nav-tab {
            padding: 10px 15px; /* Adjusted padding */
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85em; /* Slightly smaller font for sub-tabs */
            flex-grow: 1;
            text-align: center;
        }

        .sub-nav-tab.active {
            color: white;
            background-color: var(--tab-color-default); /* Use default tab color */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for active sub-tab */
        }

        .sub-nav-tab:hover:not(.active) {
            background: var(--border);
            color: var(--text-primary);
        }


        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin: 30px 40px; /* Add horizontal padding to dashboard */
            width: calc(100% - 80px); /* Adjust width for padding */
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            height: fit-content;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: sticky;
            top: 120px;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .sidebar h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        /* Refined Random Discovery Section */
        .random-display {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 12px; /* Increased border-radius for softer look */
            padding: 20px; /* More padding */
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px; /* Increased min-height for better visual balance */
            box-shadow: var(--shadow); /* Add a subtle shadow */
        }

        .random-display .random-content-wrapper {
            flex-grow: 1; /* Allows content to take available space */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            margin-bottom: 15px; /* Space between content and button */
        }

        /* Refined Random Discovery Section - Header specific styling */
        .random-display .random-display-header {
            display: flex;
            align-items: center; /* Vertically align items */
            justify-content: center; /* Center the entire header horizontally */
            gap: 12px; /* Increased gap between icon and text */
            margin-bottom: 20px; /* More space below the header */
            color: var(--text-primary); /* Use primary text color for better contrast */
            font-weight: 600; /* Keep it bold */
            padding-bottom: 10px; /* Add some padding at the bottom */
            border-bottom: 1px solid var(--border-light); /* Subtle separator line */
            width: 100%; /* Ensure it spans the width */
        }

        .random-display .random-display-header .header-icon {
            font-size: 1.8em; /* Slightly larger icon */
            color: var(--primary); /* Keep primary color for the icon */
            /* Add a subtle text-shadow for a soft glow effect */
            text-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        .random-display .random-display-header .header-text {
            font-size: 1.2em; /* Slightly larger font for the heading text */
            margin: 0; /* Remove default h3 margin */
            font-family: 'Outfit', sans-serif; /* Use the logo font for a premium feel */
            letter-spacing: -0.5px; /* Tighter spacing */
            background: var(--gradient-primary); /* Apply gradient for a premium look */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        .random-display .random-item-placeholder {
            min-height: 80px; /* Ensure content area has a minimum height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%; /* Take full width of wrapper */
        }

        .random-display .random-item-placeholder p {
            margin-bottom: 8px; /* Space between paragraphs */
            line-height: 1.4;
        }

        .random-display .random-item-placeholder strong {
            color: var(--text-primary); /* Make strong text more prominent */
        }

        .random-display .random-tool-link {
            font-size: 1.05em; /* Slightly larger link text for tools */
            font-weight: 600;
            text-decoration: none;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center; /* Center the tool link */
            gap: 8px; /* Space between favicon/icon and text */
        }

        .random-display .random-tool-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .random-display .tool-favicon {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .random-display .btn-sm {
            padding: 10px 18px; /* Slightly larger button for better clickability */
            font-size: 13px;
            width: auto;
            margin: 0 auto; /* Center the button */
            display: inline-flex; /* Use inline-flex for centering with margin auto on button */
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .content-title {
            font-size: 28px; /* Slightly larger content title */
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tools Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border); /* Thinner border */
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease; /* Faster transition */
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow); /* Apply new softer shadow */
        }

        .tools-list .tool-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
        }

        .tools-list .tool-header {
            width: 100%;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }

        .tools-list .tool-header > div:first-child {
            flex-grow: 1;
        }

        .tools-list .tool-title {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .tools-list .tool-url {
            font-size: 11px;
        }

        .tools-list .tool-actions {
            margin-left: auto;
            flex-shrink: 0;
        }

        .tools-list .tool-tags {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .tools-list .tool-tags .threat-level {
            margin-left: auto;
            float: none; /* Override float */
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px; /* Thicker accent line */
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-7px); /* More pronounced lift */
            box-shadow: var(--shadow-lg); /* Larger shadow on hover */
            border-color: var(--primary);
        }

        .tool-card:hover::before {
            opacity: 1;
        }

        .tool-card.starred {
            border-color: var(--secondary);
        }

        .tool-card.pinned {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .tool-card.selected {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.05), transparent);
        }
        /* Style for shared highlight */
        .tool-card.shared-highlight {
            border-color: var(--primary); /* Highlight with primary color */
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.08), transparent);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }


        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .tool-title {
            font-size: 1.15rem; /* Slightly larger title */
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-favicon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .tool-url {
            font-size: 0.8rem; /* Slightly smaller URL */
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .external-link-icon {
            color: var(--primary);
            font-size: 10px;
            opacity: 0.7;
        }

        .tool-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px; /* Smaller padding for action buttons */
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9rem; /* Slightly smaller icon size */
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary); /* Hover color for actions */
            transform: scale(1.15); /* Slightly more prominent icon scaling */
        }

        .action-btn.starred {
            color: var(--secondary);
        }

        .action-btn.pinned {
            color: var(--accent);
        }

        /* Bulk Actions */
        .bulk-actions {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow); /* Add shadow to bulk actions */
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-checkbox {
            margin-right: 10px;
        }

        .threat-high {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px; /* More padding */
            text-align: center;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-value {
            font-size: 3rem; /* Larger font size */
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px; /* Tighter spacing for numbers */
        }

        .analytics-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .analytics-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .analytics-list {
            list-style: none;
            padding: 0;
        }

        .analytics-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
        }

        .analytics-list li:last-child {
            border-bottom: none;
        }

        .analytics-list li span:first-child {
            color: var(--text-primary);
            font-weight: 500;
        }

        .analytics-list li span:last-child {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }


        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Footer */
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            padding-bottom: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
                margin: 30px 20px; /* Adjust padding for medium screens */
                width: calc(100% - 40px);
            }
            
            .sidebar {
                position: static;
            }
            .header-content, .stats-bar, .nav-tabs, .footer-content {
                padding: 0 20px; /* Adjust padding for medium screens */
            }
            .nav-tabs {
                margin: 20px 20px 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
                padding: 0 15px; /* Further adjust padding for smaller screens */
            }
            
            .search-container {
                min-width: unset;
                width: 100%;
                flex-direction: column; /* Stack search input and select */
                align-items: stretch;
            }
            .search-input {
                margin-bottom: 10px;
            }
            #searchScopeSelect {
                margin-left: 0; /* Reset margin for stacking */
            }
            .search-icon {
                right: 20px; /* Keep position relative to input */
            }

            .controls {
                width: 100%;
                justify-content: center;
            }

            .tools-grid, .tools-list {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                justify-content: center;
                margin: 20px 15px 0; /* Adjust margin for smaller screens */
                padding: 8px;
            }

            .nav-tab {
                flex-basis: 48%;
                margin-bottom: 10px;
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
                padding: 15px;
            }

            .dashboard {
                margin: 20px 15px; /* Adjust margin for smaller screens */
                width: calc(100% - 30px);
            }

            .tips-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .footer {
                padding: 40px 15px 20px;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 24px; /* Adjust logo size */
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .search-input {
                padding: 12px 40px 12px 15px;
                font-size: 13px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
            }
            .sub-nav-tab {
                padding: 8px 10px;
                font-size: 12px;
            }

            .tool-card {
                padding: 15px;
            }

            .tools-list .tool-card {
                padding: 10px 15px;
            }

            .tool-title {
                font-size: 16px;
            }

            .tool-url {
                font-size: 11px;
            }

            .tag {
                font-size: 10px;
            }
        }

        /* Modal and Form Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px; /* More rounded modal corners */
            padding: 40px; /* More generous padding */
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px; /* More space below label */
            font-weight: 600; /* Bolder labels */
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px; /* Larger input fields */
            border: 1px solid var(--border);
            border-radius: 10px; /* Match button rounding */
            background: var(--bg-tertiary); /* Lighter background for inputs */
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Subtle inner shadow */
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 4px rgba(0,0,0,0.1);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }
        .toast.info { /* For read-only banner */
            background: var(--primary-dark);
        }

        .toast-warning {
            background: var(--danger);
        }

        .toast-info { /* For read-only banner */
            background: var(--tab-color-yellow);
        }

        .toast-error {
            background: var(--warning);
        }

        @keyframes fadeIn { 
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px; /* More vertical padding */
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px dashed var(--border-light); /* Dashed border for a softer look */
            margin-top: 20px;
            box-shadow: var(--shadow); /* Add shadow */
        }

        .empty-state i {
            font-size: 72px; /* Larger icon */
            margin-bottom: 20px;
            opacity: 0.2; /* Lighter opacity */
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tag {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 10px; /* More padding for tags */
            border-radius: 16px; /* More rounded */
            font-size: 0.75rem; /* Slightly smaller font */
            margin-right: 6px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .threat-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-shadow: var(--shadow); /* Add shadow */
        }
        
        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .threat-tags {
            margin-top: 10px;
        }

        .threat-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .threat-high {
            background: var(--danger);
            color: white;
        }
        .threat-medium {
            background: var(--warning);
            color: black;
        }
        .threat-low {
            background: var(--success);
            color: white;
        }

        .scan-progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .scan-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .scan-result:last-child {
            border-bottom: none;
        }

        .scan-result i {
            width: 20px;
        }

        /* Custom Tabs Tool Assignment */
        .custom-tab-assignment {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .custom-tab-assignment h4 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .custom-tab-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .custom-tab-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 8px; /* Slightly softer */
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid var(--border-light); /* More prominent default border */
            transition: all 0.2s ease;
        }

        .custom-tab-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .custom-tab-checkbox.checked {
            border-color: var(--primary);
            background: rgba(0, 123, 255, 0.15); /* Match new primary color */
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2);
        }

        /* Style for Icon picker */
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .icon-picker-item {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            border-radius: 6px; /* Slightly softer */
            cursor: pointer;
            border: 1px solid var(--border-light); /* Visible border */
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .icon-picker-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .icon-picker-item.selected {
            background: var(--primary); /* Use primary color */
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        /* Style for Color picker */
        .color-picker-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker-item {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-picker-item.selected {
            border-color: var(--text-primary); /* Border for selected color */
            box-shadow: 0 0 0 3px var(--primary-dark); /* Thicker, slightly darker glow */
        }

        /*calude_investigation  wall*/
        .investigation-wall {
            min-height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

/*background Image
        .investigation-wall {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            width: 100vw;
            background: var(--gradient-bg); 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .investigation-wall::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: url('./wall.png') center center / cover no-repeat;
            filter: blur(15px);
            z-index: -1;
            transform: scale(1.1); 
        }
*/

        .wall-texture {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.015) 1px, transparent 1px);
            background-size: 50px 50px, 75px 75px;
            animation: subtleShift 20s ease-in-out infinite;
        }

        @keyframes subtleShift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-2px, -2px); }
        }

        .evidence-grid {
            position: relative;
            max-width: 1600px;
            width: 100%;
            padding: 3rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 3rem;
            z-index: 2;
        }

        .evidence-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2.5rem;
            position: relative;
            transform: rotate(-1.5deg);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .evidence-card:nth-child(even) {
            transform: rotate(1.5deg);
        }

        .evidence-card:hover {
            transform: rotate(0deg) scale(1.02);
            background: var(--bg-tertiary);
            box-shadow: var(--shadow-lg), var(--glow);
            border-color: var(--border-light);
        }

        .evidence-card::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: var(--secondary);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .evidence-card::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 12px;
            background: var(--bg-primary);
            border-radius: 2px;
        }

        .card-header-wall {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon-wall {
            width: 24px;
            height: 24px;
            margin-right: 0.75rem;
            fill: currentColor;
        }

        .card-content-wall {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 1rem;
        }

        .highlight-wall {
            background: var(--gradient-primary);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .connecting-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .line {
            position: absolute;
            background: var(--gradient-primary);
            height: 2px;
            transform-origin: left center;
            animation: lineGlow 3s ease-in-out infinite alternate;
            opacity: 0.6;
        }

        @keyframes lineGlow {
            0% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }

        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: var(--primary);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        .section-title-wall {
            position: absolute;
            top: 3rem;
            color: var(--primary);
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            z-index: 4;
            text-shadow: var(--glow);
            border-bottom: 2px solid var(--tab-color-blue);
        }

        @media (max-width: 768px) {
            .evidence-grid {
                grid-template-columns: 1fr;
                padding: 2rem;
                gap: 2rem;
            }
            
            .evidence-card {
                padding: 2rem;
            }
            
            .section-title-wall {
                top: 2rem;
                left: 2rem;
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .evidence-grid {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            
            .evidence-card {
                padding: 1.5rem;
            }
            
            .section-title-wall {
                top: 1.5rem;
                left: 1.5rem;
                font-size: 1.5rem;
            }
        }
        /*-------- End of Investigation Wall Styles --------*/
/* NEW: Handbook & Notes Styles */
        .handbook-layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            min-height: calc(100vh - 300px); /* Adjust based on header/footer height */
            align-items: flex-start; /* Align items to the top */
        }

        .handbook-sidebar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
            max-width: 300px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: sticky;
            top: 100px; /* Adjust based on header height */
            height: fit-content;
            transition: all 0.3s ease;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .handbook-sidebar.collapsed {
            min-width: 60px;
            max-width: 60px;
            padding: 10px;
            overflow: hidden;
        }

        .handbook-sidebar.collapsed .sidebar-header h3 {
            display: none;
        }

        .handbook-sidebar.collapsed .handbook-search-input,
        .handbook-sidebar.collapsed .sidebar-menu {
            display: none;
        }

        .handbook-sidebar.collapsed .sidebar-toggle-btn {
            position: static;
            transform: none;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .handbook-toolbar {
            margin-bottom: 20px;
        }

        .handbook-search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .handbook-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-item {
            display: block;
            padding: 12px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: 5px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-item.parent {
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .sub-menu {
            list-style: none;
            padding: 5px 0 5px 20px; /* Indent sub-menu items */
            margin-top: 5px;
            border-left: 2px solid var(--border-light);
        }

        .sub-menu-item {
            padding: 8px 10px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: 3px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sub-menu-item.active {
            background: var(--primary-dark); /* Slightly darker for active sub-item */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 86, 179, 0.2);
        }

        .handbook-main-content {
            flex-grow: 1;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            min-height: 500px; /* Ensure a minimum height */
        }

        .handbook-content-display {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }

        .handbook-section-title {
            font-size: 2.2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .handbook-description {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 25px;
            font-size: 1.05em;
        }

        .code-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent); /* Accent border */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--text-primary);
            position: relative;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-all; /* Break long words */
            overflow-x: auto; /* Allow horizontal scroll for very long lines */
        }

        .code-block code {
            display: block;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-dark);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary);
        }

        .handbook-tags {
            margin-top: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .handbook-tag {
            display: inline-block;
            background: var(--accent); /* Use accent color for handbook tags */
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .user-notes-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.05); /* Inner shadow for notes */
        }

        .user-notes-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .user-notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            resize: vertical; /* Allow vertical resizing */
        }

        .user-notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        /* Notes Editor Sub-tab Styles */
        .notes-editor-content {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }

        .notes-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .rich-editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .editor-button, .editor-select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .editor-button:hover, .editor-select:hover {
            background: var(--border);
            color: var(--primary);
        }

        .editor-button i {
            pointer-events: none; /* Prevent icon from being target of command */
        }

        .editor-select {
            appearance: none;
            padding-right: 25px; /* Space for dropdown arrow */
            background-image: url('data:image/svg+xml;utf8,<svg fill="%239BAEC8" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }

        .editor-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .editor-content:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow), inset 0 1px 3px rgba(0,0,0,0.15);
        }

        /* Microsoft OneNote-like list */
        .note-list-container h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .note-list {
            list-style: none;
            padding: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-height: 300px; /* Fixed height for scrolling */
            overflow-y: auto;
        }

        .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .note-item:last-child {
            border-bottom: none;
        }

        .note-item:hover {
            background: var(--bg-tertiary);
        }

        .note-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
        }

        .note-item-title {
            font-weight: 600;
            color: var(--text-primary);
            flex-grow: 1;
        }

        .note-item.active .note-item-title,
        .note-item.active .note-item-date {
            color: white;
        }

        .note-item-date {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-left: 15px;
            flex-shrink: 0;
        }

        .note-actions {
            display: flex;
            gap: 5px;
        }

        .note-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1em;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .note-item.active .note-action-btn {
            color: white;
        }

        .note-action-btn:hover {
            background: var(--border);
            color: var(--primary);
        }


        /* Responsive Adjustments for Handbook */
        @media (max-width: 1200px) {
            .handbook-layout {
                flex-direction: column;
                gap: 20px;
            }

            .handbook-sidebar {
                position: static;
                min-width: unset;
                max-width: 100%;
                width: 100%;
            }

            .handbook-sidebar.collapsed {
                min-width: unset;
                max-width: 100%;
                width: 100%;
                padding: 15px;
            }

            .handbook-sidebar.collapsed .sidebar-header {
                justify-content: center;
                gap: 0;
            }

            .handbook-sidebar.collapsed .sidebar-toggle-btn {
                margin: 0;
            }

            .handbook-sidebar.collapsed .sidebar-header h3 {
                display: none;
            }

            .handbook-sidebar.collapsed .handbook-search-input,
            .handbook-sidebar.collapsed .sidebar-menu {
                display: none;
            }

            .handbook-main-content {
                width: 100%;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .handbook-layout {
                margin: 20px 15px;
            }

            .handbook-section-title {
                font-size: 1.8rem;
            }

            .code-block {
                font-size: 0.85em;
            }
        }

        @media (max-width: 480px) {
            .handbook-section-title {
                font-size: 1.5rem;
            }

            .handbook-description {
                font-size: 0.95em;
            }

            .rich-editor-toolbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .editor-button, .editor-select {
                width: 100%;
            }

            .note-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .note-item-date {
                margin-left: 0;
            }
        }

        /* Styling for Pinned Notes */
        .note-item.pinned {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), transparent); /* Subtle green tint for pinned */
            border-left: 4px solid var(--accent); /* Stronger accent for pinned */
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2); /* Soft shadow for pinned */
        }

        .note-item.active.pinned {
            background: var(--accent); /* Full accent color when active and pinned */
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .note-item-title-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .note-pin-icon {
            font-size: 0.9em;
            color: var(--text-muted);
            transition: color 0.2s ease;
        }

        .note-pin-icon.pinned {
            color: var(--accent); /* Color for pinned icon */
        }

        /* Ensure the editor content for viewing is styled correctly */
        .editor-content[contenteditable="false"] {
            background: var(--bg-secondary); /* Same background as non-editable areas */
            border: 1px solid var(--border);
            padding: 15px;
            /* Other styles like line-height, font-size inherited from editor-content */
        }

        .editor-content[contenteditable="false"] h3 {
            color: var(--primary); /* Title color */
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo">
                        <i class="fas fa-shield-alt"></i>
                        OSINTVault
                    </div>
                    <span class="tagline">Carry your investigations everywhere.</span>
                </div>
                <div class="controls">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search intelligence tools, techniques, indicators...">
                        <i class="fas fa-search search-icon"></i>
                        <select id="searchScopeSelect">
                            <option value="currentTab">Current Tab</option>
                            <option value="allVault">All Intelligence Vault</option>
                            <option value="allData">All Data</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="addEntryBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Tool
                    </button>
                    <button class="btn btn-secondary" id="exportBtn">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn btn-secondary" id="shareOptionsBtn">
                        <i class="fas fa-share-alt"></i>
                        Share
                    </button>
                    <button class="btn btn-secondary" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <i class="fas fa-tools"></i>
                <span>Tools:</span>
                <span class="stat-value" id="totalTools">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-folder"></i>
                <span>Categories:</span>
                <span class="stat-value" id="totalCategories">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-star"></i>
                <span>Starred:</span>
                <span class="stat-value" id="starredToolsCount">0</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-thumbtack"></i>
                <span>Pinned:</span>
                <span class="stat-value" id="pinnedToolsCount">0</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="sidebar">
                <div class="filter-section">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sort By</label>
                        <select id="sortFilter">
                            <option value="name">Name (A-Z)</option>
                            <option value="recent">Recently Added</option>
                            <option value="popular">Most Used</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <button class="btn btn-secondary" id="showAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-eye"></i>
                        Show All
                    </button>
                    <button class="btn btn-secondary" id="pinAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-thumbtack"></i>
                        Pinned Entries
                    </button>
                    <button class="btn btn-secondary" id="starAllBtn" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-star"></i>
                        Starred Entries
                    </button>
                    <button class="btn btn-success" id="reportBtn" style="width: 100%;">
                        <i class="fas fa-file-alt"></i>
                        Generate Report
                    </button>
                </div>

                <div class="filter-section" style="margin-top: 25px;">
                    <h3><i class="fas fa-random"></i> Discovery</h3>
                    <div class="random-display" id="randomDiscovery">
                        <div class="random-content-wrapper">
                            <div class="random-display-header">
                                <span class="header-icon"><i class="fas fa-magic"></i></span>
                                <h3 class="header-text">Daily OSINT Discovery</h3>
                            </div>
                            <div class="random-item-placeholder" id="randomItemDisplay">
                                <div class="loading"></div> Loading discovery...
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" id="newRandomBtn">
                            <i class="fas fa-sync-alt"></i> New Discovery
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="intelligence-vault">
                        <i class="fas fa-database"></i>
                        Intelligence Vault
                    </button>
                    <button class="nav-tab" data-tab="custom-tabs">
                        <i class="fas fa-layer-group"></i>
                        Custom Tabs
                    </button>
                    <button class="nav-tab" data-tab="analytics">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                    <button class="nav-tab" data-tab="threats">
                        <i class="fas fa-exclamation-triangle"></i>
                        Threat Intel
                    </button>
                    <button class="nav-tab" data-tab="handbook-notes">
                        <i class="fas fa-book"></i>
                        Handbook & Notes
                    </button>
                </div>

                <div class="bulk-actions" id="bulkActions">
                    <span>Selected: <span id="selectedCount">0</span> tools</span>
                    <button class="btn btn-secondary" id="bulkStarBtn">
                        <i class="fas fa-star"></i>
                        Star/Unstar Selected
                    </button>
                    <button class="btn btn-secondary" id="bulkPinBtn">
                        <i class="fas fa-thumbtack"></i>
                        Pin/Unpin Selected
                    </button>
                    <button class="btn btn-danger" id="bulkDeleteBtn">
                        <i class="fas fa-trash"></i>
                        Delete Selected
                    </button>
                </div>

                <div class="tab-content" id="toolsTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Tools Arsenal</h2>
                        <div class="controls">
                            <button class="btn btn-secondary" id="viewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                    
                    <div class="tools-grid" id="toolsGrid">
                        </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-search"></i>
                        <h3>No Tools Found</h3>
                        <p>No intelligence tools match your current search criteria.</p>
                        <button class="btn btn-primary" id="clearFiltersBtn">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <div class="tab-content" id="analyticsTab">
                    <div class="content-header">
                        <h2 class="content-title">Usage Analytics</h2>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="toolsUsed">0</div>
                            <div>Tools Used Today</div>
                        </div>
                    </div>

                    <div class="analytics-section">
                        <h4>Top 5 Most Used Tools</h4>
                        <ul class="analytics-list" id="mostUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noMostUsedTools" style="display:none; padding:20px;">
                            <p>No usage data available yet.</p>
                        </div>
                    </div>

                    <div class="analytics-section">
                        <h4>Tools Never Used</h4>
                        <ul class="analytics-list" id="neverUsedToolsList">
                            </ul>
                        <div class="empty-state" id="noNeverUsedTools" style="display:none; padding:20px;">
                            <p>All tools have been used at least once!</p>
                        </div>
                    </div>

                     <div class="analytics-section">
                        <h4>Tools Added Per Week</h4>
                        <ul class="analytics-list" id="toolsAddedPerWeekList">
                            </ul>
                        <div class="empty-state" id="noToolsAdded" style="display:none; padding:20px;">
                            <p>No tools added recently.</p>
                        </div>
                    </div>

                </div>

                <div class="tab-content" id="threatsTab">
                    <div class="content-header">
                        <h2 class="content-title">Threat Intelligence Feed</h2>
                        <button class="btn btn-primary" id="refreshThreatsBtn">
                            <i class="fas fa-sync"></i>
                            Refresh Feed
                        </button>
                    </div>
                    
                    <div id="threatsList">
                        </div>
                </div>

                <div class="tab-content active" id="intelligence-vaultTab">
                    <div class="content-header">
                        <h2 class="content-title">Intelligence Vault</h2>
                        <div class="controls">
                            <button class="btn btn-secondary" id="vaultViewToggle" title="Switch to List View">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                    </div>
                
                    <div class="sub-nav-tabs" id="intelligenceVaultSubTabs">
                        <button class="sub-nav-tab active intelligence-vault-sub-tab" data-sub-tab="tools">
                            <i class="fas fa-tools"></i> Tools
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="emails">
                            <i class="fas fa-envelope"></i> Emails
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="phones">
                            <i class="fas fa-phone"></i> Phones
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="crypto">
                            <i class="fas fa-coins"></i> Crypto
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="locations">
                            <i class="fas fa-map-marker-alt"></i> Locations
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="links">
                            <i class="fas fa-link"></i> Links
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="media">
                            <i class="fas fa-camera"></i> Media
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="passwords">
                            <i class="fas fa-key"></i> Passwords
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="keywords">
                            <i class="fas fa-font"></i> Keywords
                        </button>
                        <button class="sub-nav-tab intelligence-vault-sub-tab" data-sub-tab="socials">
                            <i class="fas fa-users"></i> Socials
                        </button>
                    </div>
                
                    <div class="tools-grid" id="intelligenceVaultEntries" style="margin-top: 20px;">
                        </div>
                
                    <div class="empty-state" id="emptyIntelligenceVaultState" style="display: none;">
                        <i class="fas fa-database"></i>
                        <h3>No Entries Found</h3>
                        <p>No intelligence entries match your current criteria in this vault category.</p>
                        <button class="btn btn-primary" id="addEntryBtnEmptyState">
                            <i class="fas fa-plus-circle"></i>
                            Add New Entry
                        </button>
                    </div>
                </div>


                <div class="tab-content" id="custom-tabsTab">
                    <div class="content-header">
                        <h2 class="content-title">Custom Tool Categories</h2>
                        <div class="controls">
                            <button class="btn btn-primary" id="createSubTabBtn">
                                <i class="fas fa-plus"></i>
                                Create Sub-tab
                            </button>
                            <button class="btn btn-secondary" id="editSubTabBtn" style="display: none;">
                                <i class="fas fa-edit"></i>
                                Edit Sub-tab
                            </button>
                            <button class="btn btn-danger" id="deleteSubTabBtn" style="display: none;">
                                <i class="fas fa-trash"></i>
                                Delete Sub-tab
                            </button>
                            <button class="btn btn-secondary" id="exportSubTabBtn" style="display: none;">
                                <i class="fas fa-download"></i>
                                Export Tab
                            </button>
                            </div>
                    </div>

                    <div class="sub-nav-tabs" id="customSubTabs">
                        </div>

                    <div class="tools-grid" id="customTabToolsGrid" style="margin-top: 20px;">
                        </div>

                    <div class="empty-state" id="emptyCustomTabState" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Custom Tabs Yet</h3>
                        <p>Create your first custom sub-tab to organize your tools!</p>
                        <button class="btn btn-primary" id="createSubTabBtnEmptyState">
                            <i class="fas fa-plus"></i>
                            Create Sub-tab
                        </button>
                    </div>
                    <div class="empty-state" id="emptyCurrentCustomTabState" style="display: none;">
                        <i class="fas fa-tools"></i>
                        <h3>No Tools in this Sub-tab</h3>
                        <p>Add tools to this sub-tab using the "Edit Tool" option on individual tools.</p>
                    </div>
                </div>

                <div class="tab-content" id="handbook-notesTab">
                    <div class="handbook-layout">
                        <aside class="handbook-sidebar">
                            <div class="sidebar-header">
                                <h3><i class="fas fa-book-open"></i> OSINT Handbook</h3>
                                <button class="sidebar-toggle-btn" id="sidebarToggleBtn">
                                    <i class="fas fa-bars"></i>
                                </button>
                            </div>
                            <div class="handbook-toolbar">
                                <input type="text" class="handbook-search-input" id="handbookSearchInput" placeholder="Search handbook...">
                            </div>
                            <nav class="sidebar-menu" id="handbookSidebarMenu">
                                </nav>
                        </aside>

                        <main class="handbook-main-content">
                            <div class="sub-nav-tabs" id="handbookSubTabs">
                                <button class="sub-nav-tab active handbook-sub-tab" data-sub-tab="handbook-viewer">
                                    <i class="fas fa-glasses"></i> Handbook Viewer
                                </button>
                                <button class="sub-nav-tab handbook-sub-tab" data-sub-tab="notes-editor">
                                    <i class="fas fa-pencil-alt"></i> My Notes
                                </button>
                            </div>

                            <div class="handbook-content-display" id="handbookViewerContent">
                                <div class="empty-state" id="emptyHandbookState">
                                    <i class="fas fa-book"></i>
                                    <h3>Welcome to the OSINT Handbook!</h3>
                                    <p>Select a topic from the left sidebar to start learning or reviewing OSINT techniques and tools.</p>
                                </div>
                            </div>

                            <div class="notes-editor-content" id="notesEditorContent" style="display: none;">
                                <div class="notes-controls">
                                    <button class="btn btn-primary btn-sm" id="newNoteBtn"><i class="fas fa-plus-circle"></i> New Note</button>
                                    <button class="btn btn-secondary btn-sm" id="saveCurrentNoteBtn" style="display:none;"><i class="fas fa-save"></i> Save Note</button>
                                    <button class="btn btn-danger btn-sm" id="deleteCurrentNoteBtn" style="display:none;"><i class="fas fa-trash"></i> Delete Note</button>
                                </div>

                                <div class="rich-editor-toolbar" id="richEditorToolbar" style="display:none;">
                                    <button class="editor-button" data-command="bold"><i class="fas fa-bold"></i></button>
                                    <button class="editor-button" data-command="italic"><i class="fas fa-italic"></i></button>
                                    <button class="editor-button" data-command="underline"><i class="fas fa-underline"></i></button>
                                    <button class="editor-button" data-command="createLink"><i class="fas fa-link"></i></button>
                                    <button class="editor-button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                    <button class="editor-button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                    <select class="editor-select" data-command="formatBlock">
                                        <option value="p">Paragraph</option>
                                        <option value="h1">Heading 1</option>
                                        <option value="h2">Heading 2</option>
                                        <option value="h3">Heading 3</option>
                                    </select>
                                </div>

                                <div contenteditable="true" class="editor-content" id="noteEditor" style="display:none;"></div>

                                <div class="note-list-container">
                                    <h4>Your Saved Notes</h4>
                                    <ul class="note-list" id="savedNotesList">
                                        </ul>
                                    <div class="empty-state" id="emptyNotesState" style="padding: 20px; display: block;">
                                        <i class="fas fa-sticky-note" style="font-size: 32px; opacity: 0.3;"></i>
                                        <p style="margin-top: 10px;">No notes yet. Click 'New Note' to get started!</p>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>

            </div>
        </div>



        <!------Claude Investigation Wall Start -->
        <section class="investigation-wall">
            <div class="wall-texture"></div>
            <div class="floating-particles" id="particles"></div>
            <h2 class="section-title-wall"><i class="fas fa-clipboard-list"></i>Investigation Wall: OSINT Tips & Tricks</h2>
            
            <div class="connecting-lines" id="connecting-lines"></div>
            
            <div class="evidence-grid">
                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 13 15.5l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        Search Techniques
                    </div>
                    <div class="card-content-wall">
                        Use <span class="highlight-wall">Google Dorks</span> for advanced searches. Try operators like site:, filetype:, and intitle: to narrow results. Remember: <span class="highlight-wall">"" for exact phrases</span> and - to exclude terms.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Social Media Intel
                    </div>
                    <div class="card-content-wall">
                        Check <span class="highlight-wall">metadata</span> in images and posts. Use reverse image searches. Look for <span class="highlight-wall">connected accounts</span> across platforms using same usernames or profile pics.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        Documentation
                    </div>
                    <div class="card-content-wall">
                        Always <span class="highlight-wall">screenshot evidence</span> before it disappears. Use timestamps and archive tools like Wayback Machine. Document your <span class="highlight-wall">methodology</span> for legal purposes.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Digital Footprints
                    </div>
                    <div class="card-content-wall">
                        Check <span class="highlight-wall">WHOIS data</span> for domains. Look at DNS records, SSL certificates. Use tools like Shodan for IoT devices. Email headers reveal routing paths.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                        </svg>
                        Privacy & Security
                    </div>
                    <div class="card-content-wall">
                        Use <span class="highlight-wall">VPN and Tor</span> for anonymity. Create separate investigation personas. Never use personal accounts. Clear browser data and use <span class="highlight-wall">incognito mode</span>.
                    </div>
                </div>

                <div class="evidence-card">
                    <div class="card-header-wall">
                        <svg class="card-icon-wall" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Verification
                    </div>
                    <div class="card-content-wall">
                        <span class="highlight-wall">Cross-reference</span> information from multiple sources. Use fact-checking sites. Verify timestamps and locations. Look for <span class="highlight-wall">digital inconsistencies</span> in manipulated content.
                    </div>
                </div>
            </div>
        </section>
        <!----- Claude Investigation Wall End ------->

        <footer class="footer-bottom">
            <p>&copy; 2025 OSINTVault. Built for cybersecurity professionals and researchers.</p>
            <p style="margin-top: 10px; font-size: 12px;">
                <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                Secure  Anonymous  Professional
            </p>
        </footer>
    </div>

    <div class="modal" id="addEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-plus-circle"></i> Add New Entry</h3>
            <form id="addEntryForm">
                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="entryTypeSelect">
                        <option value="tool">Tool</option>
                        <option value="email">Email Address</option>
                        <option value="phone">Phone Number</option>
                        <option value="crypto">Crypto Transaction</option>
                        <option value="location">Location</option>
                        <option value="link">Social / Internet Link</option>
                        <option value="media">Image / Video</option>
                        <option value="password">Password</option>
                        <option value="keyword">Keyword</option>
                        <option value="social">Social Media Profile</option>
                    </select>
                </div>
                
                <div id="addToolFields" class="entry-fields">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolName">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="toolUrl">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="toolCategory">
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="newCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="toolDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="toolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                </div>
                
                <div id="addEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="emailAddress">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="emailNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="emailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="emailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                </div>
                
                <div id="addPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="phoneNumber">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="phoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="phoneLocation" placeholder="City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="phoneNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="addCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="cryptoAddress">
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="cryptoTxid">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" id="cryptoAmount" placeholder="e.g., 0.005 BTC">
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="cryptoSource" placeholder="exchange, darkweb, personal">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="cryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                </div>
                
                <div id="addLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="locationName" placeholder="e.g., Target building, Suspect's residence">
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="locationCoordinates" placeholder="e.g., 34.0522, -118.2437">
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="locationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="locationNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="locationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                </div>
                
                <div id="addLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="linkUrl">
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="linkPlatform" placeholder="twitter, reddit, pastebin, forum">
                    </div>
                    <div class="form-group">
                        <label>Notes</labe>
                        <textarea id="linkNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="linkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                </div>
                
                <div id="addMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="mediaTitle">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="mediaNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="mediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload File (Local Only)</label>
                        <input type="file" id="mediaFile" accept="image/*,video/*">
                        <input type="hidden" id="mediaBase64Data"> <small style="color: var(--text-muted);">For local storage only. File will be base64 encoded.</small>
                    </div>
                </div>

                <div id="addPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="passwordService" placeholder="e.g., Facebook, Gmail, Database">
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="passwordUsername">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="passwordValue">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="passwordNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="passwordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                </div>

                <div id="addKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="keywordValue">
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="keywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="keywordNotes" rows="3"></textarea>
                    </div>
                </div>

                <div id="addSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="socialPlatform" placeholder="e.g., Twitter, Instagram, TikTok">
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="socialUrl">
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="socialUsername">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="socialNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="socialFollowCounts" placeholder="e.g., 12k followers, 500 following">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelAddEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editEntryModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-edit"></i> Edit Entry</h3>
            <form id="editEntryForm">
                <input type="hidden" id="editEntryId"> <input type="hidden" id="editEntryType">
                <div id="editToolFields" class="entry-fields">
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="editToolName" required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editToolUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="editToolCategory" required>
                            <option value="">Select Category</option>
                        </select>
                        <input type="text" id="editNewCategoryInput" placeholder="Or enter new category" style="margin-top: 10px; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editToolDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editToolTags" placeholder="osint, investigation, cybersecurity">
                    </div>
                </div>
                
                <div id="editEmailFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="editEmailAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editEmailNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Linked Platforms (comma separated)</label>
                        <input type="text" id="editEmailLinkedPlatforms" placeholder="facebook, instagram">
                    </div>
                    <div class="form-group">
                        <label>Breach Check Results</label>
                        <input type="text" id="editEmailBreachResults" placeholder="HIBP: Pwned, No breach found">
                    </div>
                </div>
                
                <div id="editPhoneFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="editPhoneNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editPhoneType">
                            <option value="mobile">Mobile</option>
                            <option value="landline">Landline</option>
                            <option value="voip">VoIP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="editPhoneLocation" placeholder="City, State, Country">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editPhoneNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="editCryptoFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Crypto Address</label>
                        <input type="text" id="editCryptoAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Transaction ID (TXID)</label>
                        <input type="text" id="editCryptoTxid" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" step="0.00000001" id="editCryptoAmount" placeholder="e.g., 0.005 BTC" required>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" id="editCryptoSource" placeholder="exchange, darkweb, personal">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editCryptoTags" placeholder="suspicious, darkweb, stolen">
                    </div>
                </div>
                
                <div id="editLocationFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="editLocationName" placeholder="e.g., Target building, Suspect's residence" required>
                    </div>
                    <div class="form-group">
                        <label>Coordinates (Lat, Long)</label>
                        <input type="text" id="editLocationCoordinates" placeholder="e.g., 34.0522, -118.2437" required>
                    </div>
                    <div class="form-group">
                        <label>Map Link</label>
                        <input type="url" id="editLocationMapLink" placeholder="e.g., Google Maps link">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editLocationNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Possible IP/Geo Intel</label>
                        <input type="text" id="editLocationIpGeoIntel" placeholder="e.g., 192.168.1.1, ISP provider, Country">
                    </div>
                </div>
                
                <div id="editLinkFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="editLinkUrl" required>
                    </div>
                    <div class="form-group">
                        <label>Platform/Type</label>
                        <input type="text" id="editLinkPlatform" placeholder="twitter, reddit, pastebin, forum">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editLinkNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="editLinkTags" placeholder="profile, leaked-content, social-engineering">
                    </div>
                </div>
                
                <div id="editMediaFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editMediaTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editMediaNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select id="editMediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload New File (Optional)</label>
                        <input type="file" id="editMediaFile" accept="image/*,video/*">
                        <input type="hidden" id="editMediaBase64Data"> <small style="color: var(--text-muted);">Upload a new file to replace the existing one.</small>
                    </div>
                </div>

                <div id="editPasswordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Associated Service/Website</label>
                        <input type="text" id="editPasswordService" placeholder="e.g., Facebook, Gmail, Database">
                    </div>
                    <div class="form-group">
                        <label>Username/Email</label>
                        <input type="text" id="editPasswordUsername">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="editPasswordValue">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editPasswordNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Strength/Status</label>
                        <input type="text" id="editPasswordStrength" placeholder="e.g., Weak, Strong, Leaked, Reset">
                    </div>
                </div>

                <div id="editKeywordFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Keyword/Phrase</label>
                        <input type="text" id="editKeywordValue">
                    </div>
                    <div class="form-group">
                        <label>Context/Category</label>
                        <input type="text" id="editKeywordContext" placeholder="e.g., Project Name, Person of Interest, Common Alias">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editKeywordNotes" rows="3"></textarea>
                    </div>
                </div>

                <div id="editSocialFields" class="entry-fields" style="display: none;">
                    <div class="form-group">
                        <label>Platform</label>
                        <input type="text" id="editSocialPlatform" placeholder="e.g., Twitter, Instagram, TikTok">
                    </div>
                    <div class="form-group">
                        <label>Profile URL</label>
                        <input type="url" id="editSocialUrl">
                    </div>
                    <div class="form-group">
                        <label>Username/Handle</label>
                        <input type="text" id="editSocialUsername">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editSocialNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Followers/Following Count</label>
                        <input type="text" id="editSocialFollowCounts" placeholder="e.g., 12k followers, 500 following">
                    </div>
                </div>


                <div class="custom-tab-assignment" id="assignCustomTabs">
                    <h4>Assign to Custom Tabs</h4>
                    <div class="custom-tab-checkboxes" id="assignCustomTabsCheckboxes">
                        </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditEntry">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-plus-circle"></i>
                Create New Sub-tab
            </h3>
            <form id="createSubTabForm">
                <div class="form-group">
                    <label>Sub-tab Name</label>
                    <input type="text" id="newSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="newSubTabIcon" placeholder="fas fa-globe">
                    <div class="icon-picker-grid" id="newSubTabIconPicker"></div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="newSubTabColor">
                    <div class="color-picker-grid" id="newSubTabColorPicker"></div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelCreateSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editSubTabModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-edit"></i>
                Edit Sub-tab
            </h3>
            <form id="editSubTabForm">
                <input type="hidden" id="editSubTabId">
                <div class="form-group">
                    <label>Sub-tab Name</label>
                    <input type="text" id="editedSubTabName" required>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class, e.g., 'fas fa-globe')</label>
                    <input type="text" id="editedSubTabIcon" placeholder="fas fa-globe">
                     <div class="icon-picker-grid" id="editedSubTabIconPicker"></div>
                </div>
                 <div class="form-group">
                    <label>Color</label>
                    <input type="hidden" id="editedSubTabColor">
                    <div class="color-picker-grid" id="editedSubTabColorPicker"></div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditSubTab">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="shareOptionsModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: var(--primary);">
                <i class="fas fa-share-alt"></i> Share Intelligence
            </h3>
            <form id="shareForm">
                <div class="form-group">
                    <label>What would you like to share?</label>
                    <select id="shareScopeSelect">
                        <option value="currentTab">Current Tab (Read-Only View)</option>
                        <option value="allVault">All Intelligence Vault (Read-Only View)</option>
                        <option value="allData">All Data (Read-Only View)</option>
                        <option value="specificCustomTab" style="display:none;">Specific Custom Tab...</option>
                        </select>
                </div>

                <div id="specificCustomTabSelector" class="form-group" style="display:none;">
                    <label>Select a Custom Tab to share:</label>
                    <select id="selectCustomTabForSharing">
                        </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelShareOptions">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Link</button>
                </div>
            </form>
        </div>
    </div>


    <script>
      // Application State
        let appState = {
            tools: [],
            emails: [],
            phones: [],
            crypto: [],
            locations: [],
            links: [],
            media: [], // Stores objects for images/videos
            passwords: [], // New
            keywords: [], // New
            socials: [], // New
            selectedEntries: new Set(), // Now stores IDs of any selected entry type
            currentTab: 'intelligence-vault', // Default to intelligence-vault for initial rendering check
            currentIntelligenceVaultSubTab: 'tools', // Default sub-tab for intelligence vault
            customTabs: [], // Array of { id: '...', name: '...', toolIds: [], icon: '...', color: '...' }
            filters: {
                category: '',
                search: '',
                sort: 'name',
                searchScope: 'currentTab' // New: 'currentTab', 'allVault', 'allData'
            },
            theme: localStorage.getItem('theme') || 'dark', // Load theme from localStorage
            viewMode: localStorage.getItem('viewMode') || 'grid', // 'grid' or 'list'
            usageStats: {
                toolsUsedToday: 0
            },
            // New: for random tips/tools
            osintTips: [
                "Always use a VPN for anonymity during investigations.",
                "Verify your sources: Cross-reference information from multiple independent channels.",
                "Analyze metadata: Hidden data in images and documents can reveal crucial clues.",
                "Utilize archived web pages with tools like the Wayback Machine.",
                "Be mindful of your digital footprint; everything you do online leaves a trace.",
                "Learn advanced search operators for targeted information retrieval.",
                "Understand your target's OPSEC (Operational Security) to anticipate their moves.",
                "Never compromise your own security for an investigation. Think OPSEC first."
            ],
            // New: for shareable tabs
            readOnlyMode: false,
            sharedTabId: null,
            sharedEntryIds: []
        };

        // NEW: Handbook & Notes State
        let handbookState = {
            selectedSection: 'getting-started', // Default selected section
            sidebarCollapsed: false,
            currentHandbookSubTab: 'handbook-viewer', // 'handbook-viewer' or 'notes-editor'
            notes: [], // Stores individual blog-like notes: { id, title, content, addedDate, pinned }
            activeNoteId: null, // ID of the currently active note in the editor
            noteViewMode: 'view', // 'view' or 'edit' for the active note
        };

        // NEW: Handbook Content Data (hardcoded)
        const handbookContent = {
            'getting-started': {
                title: 'Getting Started: Foundations of OSINT',
                description: 'Open-Source Intelligence (OSINT) involves gathering information from publicly available sources. This section covers the fundamental principles and best practices for beginners. Always operate ethically and legally, and prioritize your operational security (OPSEC) and digital hygiene.',
                code: `// Key OSINT Principles:\n// 1. Legality: Only use publicly available data.\n// 2. Ethics: Avoid doxxing, harassment, or illegal activities.\n// 3. OPSEC: Protect your identity and digital footprint.\n// 4. Verification: Cross-reference information from multiple sources.\n// 5. Documentation: Keep meticulous records of your findings and methods.`,
                tags: ['fundamentals', 'principles', 'opsec', 'beginners'],
            },
            'osint-framework-overview': {
                title: 'OSINT Framework Overview',
                description: 'The OSINT Framework is a powerful resource categorizing thousands of tools and resources for various OSINT tasks. Understanding its structure helps in navigating the vast landscape of available information.',
                code: `// Common Categories in OSINT Framework:\n// - Usernames\n// - Email Addresses\n// - Domains\n// - IP Addresses\n// - Social Networks\n// - Public Records\n// - Dark Web\n// - Geospatial`,
                tags: ['framework', 'tools', 'categories'],
            },
            'tools-by-category': {
                title: 'Tools by Category: An Introduction',
                description: 'OSINT tools are diverse, ranging from simple search engines to complex data visualization platforms. This section breaks down common tool categories.',
                code: `// Common Tool Types:\n// - Search Engines (Google, Bing, DuckDuckGo)\n// - Social Media Analysis Tools (e.g., OSINT Combine, Hunchly)\n// - Geo-location Tools (Google Maps, Wikimapia)\n// - Image/Video Analysis (TinEye, YouTube DataViewer)\n// - Domain/IP Research (WHOIS, Shodan)\n// - Financial & Cryptocurrency (Blockchain Explorers)\n// - Public Records (OpenCorporates)\n// - Dark Web Search Engines (Ahmia, DarkSearch)`,
                tags: ['tools', 'categories', 'overview'],
            },
            'people-search': {
                title: 'People Search & Social Media',
                description: 'Techniques and tools for finding information about individuals through social media platforms, public records, and dedicated people search engines. Be mindful of privacy and legal implications.',
                code: `// Example People Search Query (Google Dork):\n// "John Doe" site:facebook.com OR site:linkedin.com "New York"\n\n// Social Media Username Check:\n// https://whatsmyname.app/\n\n// Reverse Image Search:\n// https://tineye.com/ (for images)\n// https://yandex.com/images/ (often better for faces)`,
                tags: ['people', 'social media', 'usernames', 'doxing'],
            },
            'domain-whois': {
                title: 'Domain & WHOIS Research',
                description: 'Investigating website domains involves querying WHOIS databases for registration details, understanding DNS records, and analyzing historical domain data.',
                code: `// WHOIS Lookup (via CLI or web):\n// whois example.com\n\n// DNS Record Lookup (CLI):\n// dig example.com A\n// dig example.com MX\n\n// Historical Domain Data:\n// https://web.archive.org/ (Wayback Machine)\n// https://viewdns.info/ (Various domain tools)`,
                tags: ['domain', 'whois', 'dns', 'website', 'network'],
            },
            'crypto-tracking': {
                title: 'Cryptocurrency Tracking',
                description: 'Tracing cryptocurrency transactions on public blockchains. Tools like blockchain explorers allow you to follow funds, identify addresses, and sometimes link them to real-world entities.',
                code: `// Bitcoin Blockchain Explorer:\n// https://blockchain.com/explorer\n\n// Ethereum Blockchain Explorer:\n// https://etherscan.io/\n\n// Search a Bitcoin Address:\n// https://www.blockchain.com/btc/address/<BTC_ADDRESS>`,
                tags: ['crypto', 'bitcoin', 'ethereum', 'blockchain', 'transactions'],
            },
            'techniques': {
                title: 'OSINT Techniques: Beyond the Basics',
                description: 'Advanced OSINT techniques involve more nuanced approaches to data collection and analysis, often combining multiple tools and methodologies to achieve objectives.',
                code: `// Key Techniques:\n// - Pivoting: Using one piece of info to find another.\n// - Metadata Analysis: Extracting hidden info from files.\n// - Geo-location: Determining physical locations from imagery/data.\n// - Sock Puppet Accounts: Using fictitious online personas (ethically).\n// - Human Intelligence (HUMINT): Gathering info from human sources (cautiously).`,
                tags: ['techniques', 'advanced', 'methodology'],
            },
            'pivoting': {
                title: 'Pivoting in OSINT',
                description: 'Pivoting is a core OSINT technique where a single piece of information (e.g., a username, email, or photo) is used as a starting point to discover related information across different platforms or databases. It helps in building a comprehensive profile or understanding connections.',
                code: `// Example Pivoting Flow:\n// 1. Find a username on one platform (e.g., 'dark_knight_77').\n// 2. Search 'dark_knight_77' on other social media, forums, gaming sites.\n// 3. If an email is found, use it in HaveIBeenPwned or email hunter tools.\n// 4. If a profile picture is found, use reverse image search.\n// 5. If a linked website is found, perform WHOIS and DNS lookups.`,
                tags: ['pivoting', 'techniques', 'connections', 'workflow'],
            },
            'sock-puppet-accounts': {
                title: 'Ethical Use of Sock Puppet Accounts',
                description: 'A "sock puppet" account is an online identity created for a purpose other than one\'s primary identity. In OSINT, these are used for research, testing, or engaging with open-source communities without revealing one\'s true identity. They MUST be used ethically and legally, never for deception or illegal activities. Maintaining strict OPSEC for these accounts is paramount.',
                code: `// Best Practices for Sock Puppet Accounts:\n// - Use separate email addresses and phone numbers.\n// - Do NOT link to real-world identity in any way.\n// - Use VPN/Tor for account creation and access.\n// - Create a consistent, believable persona (profile pic, bio, interests).\n// - Avoid engaging in activities that violate platform ToS or laws.`,
                tags: ['opsec', 'identity', 'techniques', 'ethics'],
            },
            'cheat-sheets': {
                title: 'Cheat Sheets: Quick Reference',
                description: 'Quick reference guides for common commands, search operators, and tool syntax. These cheat sheets are designed to accelerate your workflow during investigations.',
                code: `// Google Dorks:\n// site:example.com\n// filetype:pdf\n// "exact phrase"\n// intitle:"login"\n\n// Linux CLI Basics:\n// ls -la\n// grep "keyword" filename\n// curl -I example.com\n// nslookup example.com`,
                tags: ['cheat sheet', 'reference', 'commands', 'tips'],
            },
            'command-line-tools': {
                title: 'Command Line OSINT Tools',
                description: 'Many powerful OSINT tools are available directly from the command line, offering efficiency and automation capabilities for researchers. This section highlights some essential CLI tools.',
                code: `// Popular CLI Tools:\n// - whois: Domain registration information\n// - dig: DNS lookup utility\n// - curl: Transfer data from or to a server (HTTP, FTP, etc.)\n// - wget: Retrieve content from web servers\n// - exiftool: Read, write and edit meta information in files\n// - testssl.sh: Check SSL/TLS cipher suites and configurations\n// - Nmap: Network scanner (with caution, can be noisy)`,
                tags: ['cli', 'tools', 'linux', 'networking'],
            },
            // 'my-notes' will be handled dynamically as it's a separate feature
        };

        // Ensure this variable is accessible globally or passed correctly
        const ALL_HANDBOOK_SECTIONS = [
            { id: 'getting-started', title: 'Getting Started', parent: null },
            { id: 'osint-framework-overview', title: 'OSINT Framework Overview', parent: null },
            { id: 'tools-by-category', title: 'Tools by Category', parent: null },
            { id: 'people-search', title: 'People Search', parent: 'tools-by-category' },
            { id: 'domain-whois', title: 'Domain/WHOIS', parent: 'tools-by-category' },
            { id: 'crypto-tracking', title: 'Crypto Tracking', parent: 'tools-by-category' },
            { id: 'techniques', title: 'Techniques', parent: null },
            { id: 'pivoting', title: 'Pivoting', parent: 'techniques' },
            { id: 'sock-puppet-accounts', title: 'Sock Puppet Accounts', parent: 'techniques' },
            { id: 'cheat-sheets', title: 'Cheat Sheets', parent: null },
            { id: 'command-line-tools', title: 'Command Line Tools', parent: 'cheat-sheets' },
            // 'my-notes' is a special section, handled separately as a sub-tab
        ];

        const availableIcons = [
            'fas fa-globe', 'fas fa-search', 'fas fa-fingerprint', 'fas fa-shield-alt',
            'fas fa-link', 'fas fa-network-wired', 'fas fa-envelope', 'fas fa-image',
            'fas fa-map-marker-alt', 'fas fa-book', 'fas fa-coins', 'fas fa-users',
            'fas fa-camera', 'fas fa-lock', 'fas fa-key', 'fas fa-bug', 'fas fa-cloud',
            'fas fa-mobile-alt', 'fas fa-server', 'fas fa-database', 'fas fa-code',
            'fas fa-chart-line', 'fas fa-user-secret', 'fas fa-lightbulb', 'fas fa-laptop-code',
            'fas fa-phone', 'fas fa-money-bill-wave', 'fas fa-video', 'fas fa-paste', 'fas fa-location-arrow',
            'fas fa-font' // For keywords
        ];

        const availableColors = [
            'var(--tab-color-default)', 'var(--tab-color-red)', 'var(--tab-color-blue)',
            'var(--tab-color-green)', 'var(--tab-color-yellow)', 'var(--tab-color-purple)',
            'var(--tab-color-orange)'
        ];

        // Default Tools Database
        const defaultTools = [
            {
                id: 'google-advanced-search',
                type: 'tool',
                name: 'Google Advanced Search',
                url: 'https://www.google.com/advanced_search',
                category: 'search engines',
                description: 'Advanced search operators and techniques for comprehensive information gathering',
                tags: ['search', 'google', 'operators'],
                starred: false,
                pinned: false,
                favicon: 'https://www.google.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-01-15T10:00:00Z'),
                customTabs: [] // Initialize customTabs array
            },
            {
                id: 'shodan',
                type: 'tool',
                name: 'Shodan',
                url: 'https://www.shodan.io',
                category: 'network analysis',
                description: 'Search engine for Internet-connected devices and systems',
                tags: ['iot', 'network', 'scanning', 'security'],
                starred: true,
                pinned: false,
                favicon: 'https://www.shodan.io/static/img/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-02-20T11:30:00Z'),
                customTabs: []
            },
            {
                id: 'maltego',
                type: 'tool',
                name: 'Maltego',
                url: 'https://www.maltego.com',
                category: 'network analysis',
                description: 'Link analysis and data mining application for gathering and connecting information',
                tags: ['analysis', 'visualization', 'mapping'],
                starred: false,
                pinned: true,
                favicon: 'https://www.maltego.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-03-01T14:00:00Z'),
                customTabs: []
            },
            {
                id: 'have-i-been-pwned',
                type: 'tool',
                name: 'Have I Been Pwned',
                url: 'https://haveibeenpwned.com',
                category: 'email investigation',
                description: 'Check if email addresses have been compromised in data breaches',
                tags: ['breach', 'email', 'security', 'compromise'],
                starred: true,
                pinned: false,
                favicon: 'https://haveibeenpwned.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-04-10T09:00:00Z'),
                customTabs: []
            },
            {
                id: 'virustotal',
                type: 'tool',
                name: 'VirusTotal',
                url: 'https://www.virustotal.com',
                category: 'threat intelligence',
                description: 'Analyze suspicious files and URLs to detect types of malware',
                tags: ['malware', 'analysis', 'threat', 'security'],
                starred: false,
                pinned: false,
                favicon: 'https://www.virustotal.com/gui/images/favicon.png',
                lastUsed: 0,
                addedDate: new Date('2023-05-05T16:00:00Z'),
                customTabs: []
            },
            {
                id: 'wayback-machine',
                type: 'tool',
                name: 'Wayback Machine',
                url: 'https://web.archive.org',
                category: 'archive',
                description: 'Browse historical snapshots of websites',
                tags: ['archive', 'history', 'web', 'research'],
                starred: false,
                pinned: false,
                favicon: 'https://web.archive.org/static/images/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-06-01T08:00:00Z'),
                customTabs: []
            },
            {
                id: 'whois-lookup',
                type: 'tool',
                name: 'WHOIS Lookup',
                url: 'https://whois.net',
                category: 'domain research',
                description: 'Domain registration and ownership information',
                tags: ['domain', 'registration', 'ownership'],
                starred: false,
                pinned: false,
                favicon: 'https://whois.net/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-07-12T13:00:00Z'),
                customTabs: []
            },
            {
                id: 'tineye',
                type: 'tool',
                name: 'TinEye',
                url: 'https://tineye.com',
                category: 'image analysis',
                description: 'Reverse image search engine',
                tags: ['image', 'reverse', 'search', 'verification'],
                starred: false,
                pinned: false,
                favicon: 'https://tineye.com/favicon.ico',
                lastUsed: 0,
                addedDate: new Date('2023-08-20T10:00:00Z'),
                customTabs: []
            }
        ];

        // Initialize Application
        // In initApp()
        function initApp() {
            loadState();
            loadHandbookState(); // NEW: Load handbook state
            parseShareableLink();
            updateStats();
            bindEvents();
            initTheme();
            // Ensure currentTab is valid, otherwise default to 'tools'
            const validTabs = ['tools', 'analytics', 'threats', 'custom-tabs', 'intelligence-vault', 'handbook-notes']; // ADD 'handbook-notes'
            if (!validTabs.includes(appState.currentTab)) {
                appState.currentTab = 'intelligence-vault';
            }
            switchTab(appState.currentTab);
            
            // Explicitly call sub-tab rendering if starting in intelligence-vault
            if (appState.currentTab === 'intelligence-vault') {
                switchIntelligenceVaultSubTab(appState.currentIntelligenceVaultSubTab);
            }
            // NEW: Explicitly call handbook sub-tab rendering if starting in handbook-notes
            if (appState.currentTab === 'handbook-notes') {
                switchHandbookSubTab(handbookState.currentHandbookSubTab);
            }


            showRandomDiscovery();
            populateCategoryFilter();
            renderIntelligenceEntries();
            updateAnalytics();
            applyReadOnlyMode();

            const viewToggleButton = document.getElementById('viewToggle');
            const vaultViewToggleButton = document.getElementById('vaultViewToggle');
            if (appState.viewMode === 'grid') {
                viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                viewToggleButton.title = 'Switch to List View';
                vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
                vaultViewToggleButton.title = 'Switch to List View';
            } else {
                viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                viewToggleButton.title = 'Switch to Grid View';
                vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
                vaultViewToggleButton.title = 'Switch to Grid View';
            }
        }

        // Load application state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('osintArsenalState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                appState.tools = (parsedState.tools || []).map(entry => ({ // Ensure tools is an array
                    ...entry,
                    addedDate: new Date(entry.addedDate), // Convert string back to Date object
                    lastUsed: entry.lastUsed || 0, // Ensure lastUsed is a number, default to 0
                    customTabs: entry.customTabs || [] // Ensure customTabs array exists
                }));
                // Load new entry types
                appState.emails = parsedState.emails || [];
                appState.phones = parsedState.phones || [];
                appState.crypto = parsedState.crypto || [];
                appState.locations = parsedState.locations || [];
                appState.links = parsedState.links || [];
                appState.media = parsedState.media || [];
                appState.passwords = parsedState.passwords || []; // New
                appState.keywords = parsedState.keywords || []; // New
                appState.socials = parsedState.socials || []; // New

                appState.selectedEntries = new Set(Array.isArray(parsedState.selectedEntries) ? parsedState.selectedEntries : []); // Ensure it's an array
                appState.filters = parsedState.filters || {category: '', search: '', sort: 'name', searchScope: 'currentTab'}; // Updated default filter
                appState.theme = parsedState.theme || 'dark';
                appState.viewMode = parsedState.viewMode || 'grid';
                appState.usageStats = parsedState.usageStats || {
                    toolsUsedToday: 0
                };
                appState.customTabs = parsedState.customTabs || [];
                appState.currentCustomTab = parsedState.currentCustomTab || (appState.customTabs.length > 0 ? appState.customTabs[0].id : null);
                appState.currentIntelligenceVaultSubTab = parsedState.currentIntelligenceVaultSubTab || 'tools';

            } else {
                appState.tools = [...defaultTools];
                 // Initialize default custom tabs if no state is loaded
                appState.customTabs = [
                    { id: generateId(), name: 'Crypto', toolIds: [], icon: 'fas fa-coins', color: 'var(--tab-color-yellow)' },
                    { id: generateId(), name: 'Social Media Analysis', toolIds: [], icon: 'fas fa-users', color: 'var(--tab-color-blue)' }
                ];
                appState.currentCustomTab = appState.customTabs[0]?.id || null;
                // Initialize empty arrays for new types if starting fresh
                appState.emails = [];
                appState.phones = [];
                appState.crypto = [];
                appState.locations = [];
                appState.links = [];
                appState.media = [];
                appState.passwords = [];
                appState.keywords = [];
                appState.socials = [];
            }
        }

        // Save application state to localStorage
        function saveState() {
            localStorage.setItem('osintArsenalState', JSON.stringify(appState));
        }

        // Update statistics
        function updateStats() {
            // Include new types in allEntries
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const categories = new Set(appState.tools.map(tool => tool.category)); // Only tools have categories for now
            document.getElementById('totalTools').textContent = allEntries.length; // Count all entries, not just tools
            document.getElementById('totalCategories').textContent = categories.size;
            document.getElementById('starredToolsCount').textContent = allEntries.filter(entry => entry.starred).length;
            document.getElementById('pinnedToolsCount').textContent = allEntries.filter(entry => entry.pinned).length;
        }

        // Populate category filter and Add Tool modal
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const toolCategorySelect = document.getElementById('toolCategory');
            const editToolCategorySelect = document.getElementById('editToolCategory');
            
            const existingCategories = new Set(appState.tools.map(tool => tool.category.toLowerCase()));
            
            // Add static options
            const defaultCategories = [
                'Search Engines', 'Social Media', 'Network Analysis', 'Email Investigation', 
                'Domain Research', 'Image Analysis', 'GEOINT', 'Threat Intelligence', 'Archive', 'Other'
            ];

            const allCategories = new Set([...defaultCategories.map(cat => cat.toLowerCase()), ...Array.from(existingCategories)]);
            
            // Clear existing options
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            toolCategorySelect.innerHTML = '<option value="">Select Category</option>';
            editToolCategorySelect.innerHTML = '<option value="">Select Category</option>';


            // Sort categories alphabetically for dropdowns
            const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));

            sortedCategories.forEach(category => {
                // Filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(filterOption);

                // Add Tool dropdown
                const toolOption = document.createElement('option');
                toolOption.value = category;
                toolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                toolCategorySelect.appendChild(toolOption);

                // Edit Tool dropdown
                const editToolOption = document.createElement('option');
                editToolOption.value = category;
                editToolOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                editToolCategorySelect.appendChild(editToolOption);
            });

            // Add "Custom" option to tool category select
            const customOptionAdd = document.createElement('option');
            customOptionAdd.value = 'custom';
            customOptionAdd.textContent = 'Custom Category';
            toolCategorySelect.appendChild(customOptionAdd);

            const customOptionEdit = document.createElement('option');
            customOptionEdit.value = 'custom';
            customOptionEdit.textContent = 'Custom Category';
            editToolCategorySelect.appendChild(customOptionEdit);


            // Set selected values for filters
            categoryFilter.value = appState.filters.category;
            document.getElementById('sortFilter').value = appState.filters.sort;
        }

        // Render intelligence entries (tools, emails, phones, etc.)
        function renderIntelligenceEntries() {
            const toolsContainer = document.getElementById('toolsGrid'); 
            const customTabToolsContainer = document.getElementById('customTabToolsGrid');
            const intelligenceVaultEntriesContainer = document.getElementById('intelligenceVaultEntries');
            const emptyState = document.getElementById('emptyState');
            const emptyCustomTabState = document.getElementById('emptyCustomTabState');
            const emptyCurrentCustomTabState = document.getElementById('emptyCurrentCustomTabState');
            const emptyIntelligenceVaultState = document.getElementById('emptyIntelligenceVaultState');

            // Hide all empty states and containers initially
            toolsContainer.style.display = 'none';
            customTabToolsContainer.style.display = 'none';
            intelligenceVaultEntriesContainer.style.display = 'none';
            emptyState.style.display = 'none';
            emptyCustomTabState.style.display = 'none';
            emptyCurrentCustomTabState.style.display = 'none';
            emptyIntelligenceVaultState.style.display = 'none';

            let filteredEntries = filterEntries();
            let targetContainer = null;
            let currentEmptyState = null;

            if (appState.currentTab === 'custom-tabs') {
                targetContainer = customTabToolsContainer;
                // If there are no custom tabs created yet
                if (appState.customTabs.length === 0) {
                    emptyCustomTabState.style.display = 'block';
                    return;
                }
                // If a custom tab is selected but has no tools
                if (appState.currentCustomTab && filteredEntries.length === 0) {
                    emptyCurrentCustomTabState.style.display = 'block';
                }
                 // If a custom tab is selected and has entries, show the grid
                 if (appState.currentCustomTab && filteredEntries.length > 0) {
                    targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
                 }
            } else if (appState.currentTab === 'intelligence-vault') {
                targetContainer = intelligenceVaultEntriesContainer;
                currentEmptyState = emptyIntelligenceVaultState;
                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                    return;
                }
                 targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
            } else { // 'tools' tab (which is no longer a main tab, but still handled for backward compatibility or if structure changes)
                targetContainer = toolsContainer; // This branch might not be hit with current tab structure
                currentEmptyState = emptyState;
                if (filteredEntries.length === 0) {
                    currentEmptyState.style.display = 'block';
                    targetContainer.style.display = 'none';
                    return;
                }
                 targetContainer.style.display = appState.viewMode === 'grid' ? 'grid' : 'flex';
            }
            
            // Set the appropriate class based on viewMode
            if (appState.viewMode === 'grid') {
                targetContainer.classList.remove('tools-list');
                targetContainer.classList.add('tools-grid');
                document.getElementById('viewToggle').innerHTML = '<i class="fas fa-list"></i> List View';
            } else {
                targetContainer.classList.remove('tools-grid');
                targetContainer.classList.add('tools-list');
                document.getElementById('viewToggle').innerHTML = '<i class="fas fa-th"></i> Grid View';
            }
            
            targetContainer.innerHTML = filteredEntries.map(entry => createEntryCard(entry)).join('');
            
            // New: Apply shared-highlight if in read-only mode and relevant entries are found
            if (appState.readOnlyMode && appState.sharedEntryIds.length > 0) {
                // Determine if the current view corresponds to the shared scope
                let shouldHighlight = false;
                if (appState.sharedTabId === 'allData' || appState.sharedTabId === 'allVault') {
                    shouldHighlight = true; // Always highlight all if allData/allVault shared
                } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared custom tab
                } else if (appState.currentTab === 'intelligence-vault' && appState.currentIntelligenceVaultSubTab === appState.sharedTabId) {
                    shouldHighlight = true; // Highlight if shared intel vault sub-tab
                }

                if (shouldHighlight) {
                    appState.sharedEntryIds.forEach(id => {
                        const entryCard = document.querySelector(`.tool-card[data-entry-id="${id}"]`);
                        if (entryCard) {
                            entryCard.classList.add('shared-highlight');
                        }
                    });
                }
            }

            saveState(); // Save state after rendering entries
        }

        // Filter entries based on current filters and active tab
        function filterEntries() {
            let entriesToSearch = [];

            // Determine the base set of entries based on searchScope and currentTab
            if (appState.filters.searchScope === 'allData') {
                entriesToSearch = [
                    ...appState.tools,
                    ...appState.emails,
                    ...appState.phones,
                    ...appState.crypto,
                    ...appState.locations,
                    ...appState.links,
                    ...appState.media,
                    ...appState.passwords, // New
                    ...appState.keywords,  // New
                    ...appState.socials    // New
                ];
            } else if (appState.filters.searchScope === 'allVault') {
                 // Combine all entries from the Intelligence Vault (excluding Custom Tabs)
                 entriesToSearch = [
                    ...appState.tools,
                    ...appState.emails,
                    ...appState.phones,
                    ...appState.crypto,
                    ...appState.locations,
                    ...appState.links,
                    ...appState.media,
                    ...appState.passwords, // New
                    ...appState.keywords,  // New
                    ...appState.socials    // New
                ];
            } else { // 'currentTab' is default and also for 'custom-tabs' specifics
                if (appState.currentTab === 'tools') { // This case might not be reached if 'intelligence-vault' is default
                    entriesToSearch = [...appState.tools];
                } else if (appState.currentTab === 'intelligence-vault') {
                    switch (appState.currentIntelligenceVaultSubTab) {
                        case 'tools': entriesToSearch = [...appState.tools]; break;
                        case 'emails': entriesToSearch = [...appState.emails]; break;
                        case 'phones': entriesToSearch = [...appState.phones]; break;
                        case 'crypto': entriesToSearch = [...appState.crypto]; break;
                        case 'locations': entriesToSearch = [...appState.locations]; break;
                        case 'links': entriesToSearch = [...appState.links]; break;
                        case 'media': entriesToSearch = [...appState.media]; break;
                        case 'passwords': entriesToSearch = [...appState.passwords]; break; // New
                        case 'keywords': entriesToSearch = [...appState.keywords]; break; // New
                        case 'socials': entriesToSearch = [...appState.socials]; break; // New
                        default: entriesToSearch = []; break;
                    }
                } else if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
                    const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
                    if (activeCustomTab) {
                        const allEntriesCombined = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                        entriesToSearch = allEntriesCombined.filter(entry => (entry.customTabs || []).includes(activeCustomTab.id));
                    } else {
                        entriesToSearch = [];
                    }
                }
            }
            
            let filtered = [...entriesToSearch]; // Start filtering from this base set

            // Apply search filter
            if (appState.filters.search) {
                const searchTerm = appState.filters.search.toLowerCase();
                filtered = filtered.filter(entry => {
                    const searchableFields = [
                        entry.name, 
                        entry.description, 
                        entry.category, // For tools
                        entry.email, entry.number, entry.address, entry.txid, entry.locationName, entry.url, entry.title, // For other entry types
                        entry.service, entry.username, entry.password, entry.strength, // For passwords
                        entry.value, entry.context, // For keywords
                        entry.platform, entry.socialUsername, entry.followCounts // For socials
                    ].map(field => String(field || '').toLowerCase()); // Ensure all fields are strings or empty strings

                    if (entry.tags) {
                        searchableFields.push(...entry.tags.map(tag => tag.toLowerCase()));
                    }

                    return searchableFields.some(field => field.includes(searchTerm));
                });
            }
            
            // Apply universal "category" filters for pinned/starred
            if (appState.filters.category === 'pinned') {
                filtered = filtered.filter(entry => entry.pinned);
            } else if (appState.filters.category === 'starred') {
                filtered = filtered.filter(entry => entry.starred);
            } else if (appState.filters.category) {
                // This 'else if' block handles actual categories, only apply if the current view is for tools
                if (appState.currentTab === 'tools' || (appState.currentTab === 'intelligence-vault' && appState.currentIntelligenceVaultSubTab === 'tools')) {
                    filtered = filtered.filter(entry => entry.category === appState.filters.category);
                } else {
                    // If a category filter is applied while not on a 'tools' tab, clear it visually.
                    document.getElementById('categoryFilter').value = '';
                    appState.filters.category = ''; // Ensure state is reset too
                }
            }

            // Apply sorting
            filtered.sort((a, b) => {
                switch (appState.filters.sort) {
                    case 'recent':
                        return new Date(b.addedDate || 0) - new Date(a.addedDate || 0);
                    case 'popular': // Sort by lastUsed (most recent first)
                        return (b.lastUsed || 0) - (a.lastUsed || 0);
                    default: // 'name' (or primary identifier)
                        const nameA = a.name || a.email || a.number || a.address || a.locationName || a.url || a.title || a.service || a.value || a.username || '';
                        const nameB = b.name || b.email || b.number || b.address || b.locationName || b.url || b.title || b.service || b.value || b.username || '';
                        return nameA.localeCompare(nameB);
                }
            });
            
            return filtered;
        }

        // Create a generic entry card HTML
        function createEntryCard(entry) {
            const isSelected = appState.selectedEntries.has(entry.id);
            let title, subtitle, description, icon, faviconHtml = '', extraContent = '';

            switch (entry.type) {
                case 'tool':
                    title = entry.name;
                    subtitle = entry.url;
                    description = entry.description;
                    icon = 'fas fa-tools';
                    faviconHtml = `<img src="${entry.favicon}" alt="" class="tool-favicon" onerror="this.src='https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}'">`;
                    break;
                case 'email':
                    title = entry.email;
                    subtitle = entry.linkedPlatforms.join(', ') || 'No linked platforms';
                    description = entry.notes;
                    icon = 'fas fa-envelope';
                    extraContent = entry.breachResults ? `<p style="color: var(--danger); font-size: 12px; margin-top: 5px;"><i class="fas fa-exclamation-triangle"></i> Breach: ${entry.breachResults}</p>` : '';
                    break;
                case 'phone':
                    title = entry.number;
                    subtitle = `Type: ${entry.phoneType}`; // Changed to phoneType as per schema
                    description = entry.notes;
                    icon = 'fas fa-phone';
                    extraContent = entry.location ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${entry.location}</p>` : '';
                    break;
                case 'crypto':
                    title = entry.address;
                    subtitle = `TXID: ${entry.txid}`;
                    description = `Amount: ${entry.amount} | Source: ${entry.source}`;
                    icon = 'fas fa-coins';
                    break;
                case 'location':
                    title = entry.name;
                    subtitle = `Coordinates: ${entry.coordinates}`;
                    description = entry.notes;
                    icon = 'fas fa-map-marker-alt';
                    extraContent = entry.mapLink ? `<p style="font-size: 12px; margin-top: 5px;"><a href="${entry.mapLink}" target="_blank" style="color: var(--primary); text-decoration: none;"><i class="fas fa-external-link-alt"></i> View Map</a></p>` : '';
                    extraContent += entry.ipGeoIntel ? `<p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">IP/Geo: ${entry.ipGeoIntel}</p>` : '';
                    break;
                case 'link':
                    title = entry.url;
                    subtitle = entry.platform || 'General Link';
                    description = entry.notes;
                    icon = 'fas fa-link';
                    try { // Safely get favicon for links
                        faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
                    } catch (e) {
                        faviconHtml = '';
                    }
                    break;
                case 'media':
                    title = entry.title;
                    subtitle = entry.mediaType === 'image' ? 'Image' : 'Video';
                    description = entry.notes;
                    icon = entry.mediaType === 'image' ? 'fas fa-image' : 'fas fa-video';
                    extraContent = entry.base64Data ? (entry.mediaType === 'image' ? `<img src="${entry.base64Data}" alt="Media thumbnail" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">` : `<video controls style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;"><source src="${entry.base64Data}" type="video/mp4"></video>`) : '';
                    break;
                case 'password': // New
                    title = entry.service;
                    subtitle = `Username: ${entry.username || 'N/A'}`;
                    description = `Password: ${entry.password} | Strength: ${entry.strength || 'N/A'}\nNotes: ${entry.notes || 'N/A'}`;
                    icon = 'fas fa-key';
                    break;
                case 'keyword': // New
                    title = entry.value;
                    subtitle = `Context: ${entry.context || 'General'}`;
                    description = entry.notes;
                    icon = 'fas fa-font';
                    break;
                case 'social': // New
                    title = entry.username;
                    subtitle = `Platform: ${entry.platform}`;
                    description = `URL: ${entry.url}\nFollowers/Following: ${entry.followCounts || 'N/A'}\nNotes: ${entry.notes || 'N/A'}`;
                    icon = 'fas fa-users';
                    try { // Safely get favicon for socials if URL exists
                        faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${new URL(entry.url).hostname}" alt="" class="tool-favicon">`;
                    } catch (e) {
                        faviconHtml = '';
                    }
                    break;
                default:
                    title = entry.name || 'Unknown Entry';
                    subtitle = '';
                    description = '';
                    icon = 'fas fa-question-circle';
            }

            return `
                <div class="tool-card ${entry.starred ? 'starred' : ''} ${entry.pinned ? 'pinned' : ''} ${isSelected ? 'selected' : ''}" 
                     data-entry-id="${entry.id}" data-entry-type="${entry.type}">
                    <div class="tool-header">
                        <div>
                            <div class="tool-title">
                                <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''}>
                                ${faviconHtml}
                                <i class="${icon}" style="margin-right: 5px;"></i>
                                ${title}
                            </div>
                            <div class="tool-url">
                                <span>${subtitle}</span>
                                ${entry.url ? '<i class="fas fa-external-link-alt external-link-icon"></i>' : ''}
                            </div>
                        </div>
                        <div class="tool-actions">
                            <button class="action-btn" data-action="edit" title="Edit Entry">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn ${entry.starred ? 'starred' : ''}" data-action="star" title="Star Entry">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="action-btn ${entry.pinned ? 'pinned' : ''}" data-action="pin" title="Pin Entry">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            ${entry.url ? `<button class="action-btn" data-action="visit" title="Visit Link">
                                <i class="fas fa-external-link-alt"></i>
                            </button>` : ''}
                            <button class="action-btn" data-action="delete" title="Delete Entry">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                        ${description}
                    </p>
                    ${extraContent}
                    <div class="tool-tags">
                        ${entry.tags ? entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                    </div>
                </div>
            `;
        }

        // Bind event listeners
        function bindEvents() {

            // NEW: Handbook & Notes Tab activation
            document.querySelector('.nav-tab[data-tab="handbook-notes"]').addEventListener('click', () => {
                // Ensure handbook is rendered when its tab is clicked
                switchTab('handbook-notes');
                renderSidebar(); // Initial render of sidebar
                // If no section is selected, default to 'getting-started'
                if (!handbookState.selectedSection) {
                    selectHandbookSection('getting-started');
                } else {
                    selectHandbookSection(handbookState.selectedSection); // Re-render active section
                }
                switchHandbookSubTab(handbookState.currentHandbookSubTab); // Activate default sub-tab
            });

            // NEW: Handbook Sub-tabs
            document.querySelectorAll('.handbook-sub-tab').forEach(subTab => {
                subTab.addEventListener('click', (e) => {
                    // Ensure any active note is unselected/reset when switching sub-tabs
                    handbookState.activeNoteId = null;
                    handbookState.noteViewMode = 'view'; // Default to view mode on sub-tab switch
                    switchHandbookSubTab(e.target.dataset.subTab);
                });
            });

            // NEW: Handbook Sidebar Menu Clicks (Delegation)
            document.getElementById('handbookSidebarMenu').addEventListener('click', (e) => {
                const item = e.target.closest('.sidebar-item, .sub-menu-item');
                if (item && item.dataset.sectionId) {
                    selectHandbookSection(item.dataset.sectionId);
                }
            });

            // NEW: Handbook Search Input
            document.getElementById('handbookSearchInput').addEventListener('input', (e) => {
                renderSidebar(e.target.value);
            });

            // NEW: Sidebar Toggle Button
            document.getElementById('sidebarToggleBtn').addEventListener('click', toggleSidebar);

            // NEW: Notes Editor Controls
            document.getElementById('newNoteBtn').addEventListener('click', createNote);
            document.getElementById('saveCurrentNoteBtn').addEventListener('click', saveNoteContent);
            document.getElementById('deleteCurrentNoteBtn').addEventListener('click', () => {
                if (handbookState.activeNoteId) {
                    deleteNote(handbookState.activeNoteId);
                } else {
                    showToast('No note selected to delete.', 'warning');
                }
            });

            // NEW: Rich Editor Toolbar Commands (No Change)
            document.getElementById('richEditorToolbar').addEventListener('click', (e) => {
                const button = e.target.closest('.editor-button');
                if (button) {
                    formatDoc(button.dataset.command);
                }
            });
            document.getElementById('richEditorToolbar').addEventListener('change', (e) => {
                const select = e.target.closest('.editor-select');
                if (select) {
                    formatDoc(select.dataset.command, select.value);
                }
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                appState.filters.search = e.target.value;
                renderIntelligenceEntries();
            });

            // Search Scope Select
            document.getElementById('searchScopeSelect').addEventListener('change', (e) => {
                appState.filters.searchScope = e.target.value;
                renderIntelligenceEntries(); // Re-render with new scope
            });


            // Filter controls
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                appState.filters.category = e.target.value;
                renderIntelligenceEntries();
            });

            document.getElementById('sortFilter').addEventListener('change', (e) => {
                appState.filters.sort = e.target.value;
                renderIntelligenceEntries();
            });

            document.getElementById('addEntryBtnEmptyState').addEventListener('click', () => showModal('addEntryModal'));

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });

            // Intelligence Vault Sub-tabs
            document.querySelectorAll('.intelligence-vault-sub-tab').forEach(subTab => {
                subTab.addEventListener('click', (e) => {
                    switchIntelligenceVaultSubTab(e.target.dataset.subTab);
                });
            });

            // Tool actions (now generic for all entries)
            // Event delegation on the main content container to handle clicks on dynamically loaded tool cards
            document.getElementById('toolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('customTabToolsGrid').addEventListener('click', handleEntryAction);
            document.getElementById('intelligenceVaultEntries').addEventListener('click', handleEntryAction);
            
            // Event delegation for bulk selection checkboxes
            document.getElementById('toolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('customTabToolsGrid').addEventListener('change', handleBulkSelection);
            document.getElementById('intelligenceVaultEntries').addEventListener('change', handleBulkSelection);


            // Modal controls (Add New Entry)
            document.getElementById('addEntryBtn').addEventListener('click', () => showModal('addEntryModal'));
            document.getElementById('cancelAddEntry').addEventListener('click', () => hideModal('addEntryModal'));

            // Dynamic form display for Add Entry modal
            document.getElementById('entryTypeSelect').addEventListener('change', displayEntryForm);
            
            // Custom category input (Add Tool)
            document.getElementById('toolCategory').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('newCategoryInput');
                if (e.target.value === 'custom') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.setAttribute('required', 'required');
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.removeAttribute('required');
                    newCategoryInput.value = ''; // Clear input if not custom
                }
            });

            // Form submission (Add Entry)
            document.getElementById('addEntryForm').addEventListener('submit', handleAddEntry);

            // Modal controls (Edit Entry)
            document.getElementById('cancelEditEntry').addEventListener('click', () => hideModal('editEntryModal'));
            // Custom category input (Edit Tool)
            document.getElementById('editToolCategory').addEventListener('change', (e) => {
                const editNewCategoryInput = document.getElementById('editNewCategoryInput');
                if (e.target.value === 'custom') {
                    editNewCategoryInput.style.display = 'block';
                    editNewCategoryInput.setAttribute('required', 'required');
                } else {
                    editNewCategoryInput.style.display = 'none';
                    editNewCategoryInput.removeAttribute('required');
                    editNewCategoryInput.value = ''; // Clear input if not custom
                }
            });
            // Form submission (Edit Entry)
            document.getElementById('editEntryForm').addEventListener('submit', handleEditEntry);


            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Quick actions
            document.getElementById('pinAllBtn').addEventListener('click', togglePinFilter);
            document.getElementById('starAllBtn').addEventListener('click', toggleStarFilter);
            document.getElementById('showAllBtn').addEventListener('click', clearFilters);
            document.getElementById('reportBtn').addEventListener('click', generateReport);

            // Clear filters (from empty state button)
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

            // Bulk actions
            document.getElementById('bulkStarBtn').addEventListener('click', () => bulkAction('star'));
            document.getElementById('bulkPinBtn').addEventListener('click', () => bulkAction('pin'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', () => bulkAction('delete'));

            // Export
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // View toggle (Grid/List)
            document.getElementById('viewToggle').addEventListener('click', toggleViewMode);
            // Intelligence Vault View Toggle
            document.getElementById('vaultViewToggle').addEventListener('click', toggleViewMode); // Both can use the same toggle

            // Refresh Threats button
            document.getElementById('refreshThreatsBtn').addEventListener('click', loadThreats);

            // Custom Sub-tab buttons
            document.getElementById('createSubTabBtn').addEventListener('click', () => showCreateSubTabModal());
            document.getElementById('createSubTabBtnEmptyState').addEventListener('click', () => showCreateSubTabModal()); // For empty state button
            document.getElementById('cancelCreateSubTab').addEventListener('click', () => hideModal('createSubTabModal'));
            document.getElementById('createSubTabForm').addEventListener('submit', handleCreateSubTab);

            document.getElementById('editSubTabBtn').addEventListener('click', () => openEditSubTabModal());
            document.getElementById('cancelEditSubTab').addEventListener('click', () => hideModal('editSubTabModal'));
            document.getElementById('editSubTabForm').addEventListener('submit', handleEditSubTab);

            document.getElementById('deleteSubTabBtn').addEventListener('click', handleDeleteSubTab);
            document.getElementById('exportSubTabBtn').addEventListener('click', exportCustomTab);
            document.getElementById('newRandomBtn').addEventListener('click', showRandomDiscovery); // New: Random Tool/Tip button
            
            // New: Share options button and modal events
            document.getElementById('shareOptionsBtn').addEventListener('click', showShareOptionsModal);
            document.getElementById('cancelShareOptions').addEventListener('click', () => hideModal('shareOptionsModal'));
            document.getElementById('shareScopeSelect').addEventListener('change', handleShareScopeChange);
            document.getElementById('shareForm').addEventListener('submit', handleShareFormSubmit);


            // Click listener for custom sub-tabs (delegated)
            document.getElementById('customSubTabs').addEventListener('click', (e) => {
                const tabBtn = e.target.closest('.sub-nav-tab');
                if (tabBtn && tabBtn.dataset.subTabId) {
                    switchCustomTab(tabBtn.dataset.subTabId);
                }
            });

            // Event listener for custom tab checkboxes in Edit Tool Modal
            document.getElementById('assignCustomTabsCheckboxes').addEventListener('change', (e) => {
                if (e.target.classList.contains('custom-tab-assign-checkbox')) {
                    const checkbox = e.target;
                    const label = checkbox.closest('.custom-tab-checkbox');
                    if (label) {
                        label.classList.toggle('checked', checkbox.checked);
                    }
                }
            });

            // Icon picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#newSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('newSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Icon picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabIconPicker').addEventListener('click', (e) => {
                const iconItem = e.target.closest('.icon-picker-item');
                if (iconItem) {
                    document.querySelectorAll('#editedSubTabIconPicker .icon-picker-item').forEach(item => item.classList.remove('selected'));
                    iconItem.classList.add('selected');
                    document.getElementById('editedSubTabIcon').value = iconItem.dataset.iconClass;
                }
            });

            // Color picker click handler (Create Sub-tab Modal)
            document.getElementById('newSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#newSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('newSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

            // Color picker click handler (Edit Sub-tab Modal)
            document.getElementById('editedSubTabColorPicker').addEventListener('click', (e) => {
                const colorItem = e.target.closest('.color-picker-item');
                if (colorItem) {
                    document.querySelectorAll('#editedSubTabColorPicker .color-picker-item').forEach(item => item.classList.remove('selected'));
                    colorItem.classList.add('selected');
                    document.getElementById('editedSubTabColor').value = colorItem.dataset.colorValue;
                }
            });

        }

        // Handle generic entry actions
        function handleEntryAction(e) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot perform actions in read-only shared view.", "warning");
                return;
            }

            const targetBtn = e.target.closest('.action-btn');
            if (!targetBtn) return;
            
            e.preventDefault();
            const action = targetBtn.dataset.action;
            const entryCard = e.target.closest('.tool-card'); // Still using tool-card class for styling
            const entryId = entryCard.dataset.entryId;
            const entryType = entryCard.dataset.entryType;

            let entry = null;
            let entryArray = null;

            switch (entryType) {
                case 'tool': entryArray = appState.tools; break;
                case 'email': entryArray = appState.emails; break;
                case 'phone': entryArray = appState.phones; break;
                case 'crypto': entryArray = appState.crypto; break;
                case 'location': entryArray = appState.locations; break;
                case 'link': entryArray = appState.links; break;
                case 'media': entryArray = appState.media; break;
                case 'password': entryArray = appState.passwords; break; // New
                case 'keyword': entryArray = appState.keywords; break; // New
                case 'social': entryArray = appState.socials; break; // New
            }

            if (entryArray) {
                entry = entryArray.find(t => t.id === entryId);
            }
            
            if (!entry) return;

            switch (action) {
                case 'edit':
                    openEditEntryModal(entry);
                    break;
                case 'star':
                    entry.starred = !entry.starred;
                    showToast(entry.starred ? 'Entry starred!' : 'Entry unstarred!');
                    break;
                case 'pin':
                    entry.pinned = !entry.pinned;
                    showToast(entry.pinned ? 'Entry pinned!' : 'Entry unpinned!');
                    break;
                case 'visit':
                    if (entry.url) {
                        entry.lastUsed = Date.now(); // Update lastUsed timestamp
                        appState.usageStats.toolsUsedToday++; // Increment usage stat (generic for now)
                        updateAnalytics(); // Update analytics display
                        window.open(entry.url, '_blank');
                        showToast('Opening link...');
                    }
                    break;
                case 'delete':
                    if (confirm('Are you sure you want to delete this entry?')) {
                        // Remove entry from any custom tabs it belongs to
                        appState.customTabs.forEach(tab => {
                            tab.toolIds = tab.toolIds.filter(id => id !== entryId);
                        });

                        if (entryArray) {
                            // Find index and remove
                            const index = entryArray.findIndex(e => e.id === entryId);
                            if (index > -1) {
                                entryArray.splice(index, 1);
                            }
                        }
                        appState.selectedEntries.delete(entryId); // Remove from selected if deleted
                        showToast('Entry deleted!', 'error');
                        updateStats();
                        populateCategoryFilter(); // Recalculate categories (if a tool was deleted)
                        renderCustomTabs(); // Re-render custom tabs to update counts/content
                    }
                    break;
            }
            
            renderIntelligenceEntries();
            updateStats(); // Also update stats bar after individual entry action
            saveState(); // Save state after any action
        }

        // Handle bulk selection checkbox
        function handleBulkSelection(e) {
            if (appState.readOnlyMode) { // New: Prevent bulk selection in read-only mode
                e.target.checked = !e.target.checked; // Revert checkbox state
                showToast("Cannot select entries in read-only shared view.", "warning");
                return;
            }

            if (!e.target.classList.contains('bulk-checkbox')) return;
            
            const entryCard = e.target.closest('.tool-card');
            const entryId = entryCard.dataset.entryId;
            
            if (e.target.checked) {
                appState.selectedEntries.add(entryId);
            } else {
                appState.selectedEntries.delete(entryId);
            }
            
            updateBulkActions();
            entryCard.classList.toggle('selected', e.target.checked); // Visually mark selected
        }

        // Update bulk actions visibility and count
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (appState.readOnlyMode) { // New: Always hide bulk actions in read-only
                bulkActions.classList.remove('active');
                return;
            }

            if (appState.selectedEntries.size > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = appState.selectedEntries.size;
            } else {
                bulkActions.classList.remove('active');
            }
        }

        // Bulk actions (star, pin, delete selected)
        function bulkAction(action) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot perform bulk actions in read-only shared view.", "warning");
                return;
            }

            const selectedIds = Array.from(appState.selectedEntries);
            
            if (selectedIds.length === 0) {
                showToast(`No entries selected for ${action} action.`, 'warning');
                return;
            }

            if (action === 'delete' && !confirm('Are you sure you want to delete all selected entries?')) {
                return;
            }
            
            // Determine if all selected are already starred/pinned for toggling
            let allStarred = true;
            let allPinned = true;
            
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const selectedEntriesArray = allEntries.filter(entry => selectedIds.includes(entry.id));

            if (action === 'star' || action === 'pin') {
                allStarred = selectedEntriesArray.every(entry => entry.starred);
                allPinned = selectedEntriesArray.every(entry => entry.pinned);
            }

            selectedIds.forEach(id => {
                const entry = allEntries.find(e => e.id === id);
                if (!entry) return;
                
                switch (action) {
                    case 'star':
                        entry.starred = !allStarred; // Toggle based on current state of all
                        break;
                    case 'pin':
                        entry.pinned = !allPinned; // Toggle based on current state of all
                        break;
                    case 'delete':
                        // Remove entry from any custom tabs it belongs to before deleting
                        appState.customTabs.forEach(tab => {
                            tab.toolIds = tab.toolIds.filter(entryIdInTab => entryIdInTab !== id);
                        });
                        // Remove from respective appState array
                        ['tools', 'emails', 'phones', 'crypto', 'locations', 'links', 'media', 'passwords', 'keywords', 'socials'].forEach(key => {
                            appState[key] = appState[key].filter(e => e.id !== id);
                        });
                        break;
                }
            });
            
            appState.selectedEntries.clear();
            updateBulkActions();
            renderIntelligenceEntries();
            updateStats();
            populateCategoryFilter();
            renderCustomTabs(); // Update custom tabs if entries were deleted
            showToast(`Bulk ${action} completed!`);
            saveState();
        }

        // Quick actions (UPDATED)
        function togglePinFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'pinned') { // If already filtering by pinned, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'pinned'; // Set filter to show only pinned
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'pinned' ? 'Showing only pinned entries!' : 'Cleared pinned entries filter!');
        }

        function toggleStarFilter() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot apply filters in read-only shared view.", "warning");
                return;
            }

            if (appState.filters.category === 'starred') { // If already filtering by starred, clear it
                appState.filters.category = '';
            } else {
                appState.filters.category = 'starred'; // Set filter to show only starred
            }
            appState.filters.search = ''; // Clear search when applying this filter
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = appState.filters.category;
            renderIntelligenceEntries();
            showToast(appState.filters.category === 'starred' ? 'Showing only starred entries!' : 'Cleared starred entries filter!');
        }


        // Switch main tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabBtn) {
                targetTabBtn.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTabContent = document.getElementById(`${tabName}Tab`);
            if (targetTabContent) {
                 targetTabContent.classList.add('active');
            }
           
            appState.currentTab = tabName;
            appState.filters.category = ''; // Clear category filter when switching main tabs
            document.getElementById('categoryFilter').value = '';
            appState.filters.search = ''; // Clear search when switching main tabs
            document.getElementById('searchInput').value = '';

            // Handle specific tab initializations
            if (tabName === 'threats') {
                loadThreats();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'custom-tabs') {
                renderCustomTabs(); // Render sub-tabs when custom tab is active
                // If there are custom tabs, activate the first one by default if none is selected
                if (appState.customTabs.length > 0 && !appState.currentCustomTab) {
                    appState.currentCustomTab = appState.customTabs[0].id;
                }
                switchCustomTab(appState.currentCustomTab); // Render tools for the active custom tab
            } else if (tabName === 'intelligence-vault') {
                 switchIntelligenceVaultSubTab(appState.currentIntelligenceVaultSubTab);
            }
            renderIntelligenceEntries(); // Re-render entries based on new tab context
            saveState();
        }

        // Switch Intelligence Vault Sub-tabs
        function switchIntelligenceVaultSubTab(subTabName) {
            document.querySelectorAll('.intelligence-vault-sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetSubTabBtn = document.querySelector(`.intelligence-vault-sub-tab[data-sub-tab="${subTabName}"]`);
            if (targetSubTabBtn) {
                targetSubTabBtn.classList.add('active');
            }
            appState.currentIntelligenceVaultSubTab = subTabName;
            appState.filters.category = ''; // Clear category filter for intelligence vault sub-tabs
            document.getElementById('categoryFilter').value = '';
            renderIntelligenceEntries();
            saveState();
        }


        // Load threat intelligence
        function loadThreats() {
            const threatsList = document.getElementById('threatsList');
            const mockThreats = [
                {
                    id: 1,
                    title: 'New Phishing Campaign Detected',
                    description: 'Targeting financial institutions with COVID-19 themed lures. Be cautious of emails resembling official health advisories.',
                    severity: 'high',
                    tags: ['phishing', 'covid-19', 'financial', 'email'],
                    timestamp: new Date(Date.now() - 3600000)
                },
                {
                    id: 2,
                    title: 'Malware Sample Analysis: Xylos Variant',
                    description: 'New variant of banking trojan "Xylos" discovered in the wild. It employs obfuscation techniques and targets online banking portals. Update your antivirus signatures immediately.',
                    severity: 'medium',
                    tags: ['malware', 'banking', 'trojan', 'xylos', 'analysis'],
                    timestamp: new Date(Date.now() - 7200000)
                },
                {
                    id: 3,
                    title: 'Data Breach Alert: Gaming Platform',
                    description: 'Credentials leak detected on underground forums originating from a popular gaming platform. Users are advised to change passwords and enable multi-factor authentication.',
                    severity: 'high',
                    tags: ['breach', 'credentials', 'darkweb', 'gaming'],
                    timestamp: new Date(Date.now() - 10800000)
                },
                {
                    id: 4,
                    title: 'Ransomware Attack on Healthcare Provider',
                    description: 'A critical ransomware attack impacted a regional healthcare provider, compromising patient data. Incident response teams are engaged, and data recovery efforts are underway. Backups are crucial!',
                    severity: 'high',
                    tags: ['ransomware', 'healthcare', 'data-loss', 'cyberattack'],
                    timestamp: new Date(Date.now() - 86400000 * 2) // 2 days ago
                },
                {
                    id: 5,
                    title: 'Zero-Day Exploit in Popular Web Server',
                    description: 'A zero-day vulnerability has been identified in a widely used web server software. Patches are not yet available. Organizations are advised to implement temporary mitigation strategies and monitor their logs closely.',
                    severity: 'medium',
                    tags: ['zero-day', 'vulnerability', 'web-server', 'exploit'],
                    timestamp: new Date(Date.now() - 86400000 * 5) // 5 days ago
                }
            ];

            // Sort threats by timestamp (most recent first)
            mockThreats.sort((a, b) => b.timestamp - a.timestamp);
            
            threatsList.innerHTML = mockThreats.map(threat => `
                <div class="threat-item">
                    <div class="threat-header">
                        <h4>${threat.title}</h4>
                        <div class="threat-level threat-${threat.severity}">${threat.severity}</div>
                    </div>
                    <p>${threat.description}</p>
                    <div class="threat-tags">
                        ${threat.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="threat-time">${formatTime(threat.timestamp)}</div>
                </div>
            `).join('');
            
        }

        // Update analytics data (display)
        function updateAnalytics() {
            document.getElementById('toolsUsed').textContent = appState.usageStats.toolsUsedToday;
            renderMostUsedTools();
            renderNeverUsedTools();
            renderToolsAddedPerWeek();

            saveState();
        }

        function renderMostUsedTools() {
            const mostUsedToolsList = document.getElementById('mostUsedToolsList');
            const noMostUsedTools = document.getElementById('noMostUsedTools');
            
            // Combine all entry types that have lastUsed property and filter
            const allUsedEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials]
                                    .filter(entry => entry.lastUsed > 0);

            const usedTools = allUsedEntries.sort((a, b) => b.lastUsed - a.lastUsed)
                                            .slice(0, 5); // Get top 5

            if (usedTools.length === 0) {
                mostUsedToolsList.innerHTML = '';
                noMostUsedTools.style.display = 'block';
            } else {
                noMostUsedTools.style.display = 'none';
                mostUsedToolsList.innerHTML = usedTools.map(entry => {
                    const name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    return `
                        <li>
                            <span>${name} (${entry.type})</span>
                            <span>Last Used: ${new Date(entry.lastUsed).toLocaleString()}</span>
                        </li>
                    `;
                }).join('');
            }
        }

        function renderNeverUsedTools() {
            const neverUsedToolsList = document.getElementById('neverUsedToolsList');
            const noNeverUsedTools = document.getElementById('noNeverUsedTools');
            
            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const neverUsed = allEntries.filter(entry => (entry.type === 'tool' && entry.lastUsed === 0) || (entry.lastUsed === undefined || entry.lastUsed === 0)); // Checks for 0 or undefined lastUsed

            if (neverUsed.length === 0) {
                neverUsedToolsList.innerHTML = '';
                noNeverUsedTools.style.display = 'block';
            } else {
                noNeverUsedTools.style.display = 'none';
                neverUsedToolsList.innerHTML = neverUsed.map(entry => {
                    const name = entry.name || entry.email || entry.number || entry.address || entry.locationName || entry.url || entry.title || entry.service || entry.value || entry.username || 'N/A';
                    const addedDate = entry.addedDate ? new Date(entry.addedDate).toLocaleDateString() : 'N/A';
                    return `
                        <li>
                            <span>${name} (${entry.type})</span>
                            <span>Added: ${addedDate}</span>
                        </li>
                    `;
                }).join('');
            }
        }

        function renderToolsAddedPerWeek() {
            const toolsAddedPerWeekList = document.getElementById('toolsAddedPerWeekList');
            const noToolsAdded = document.getElementById('noToolsAdded');
            
            const weeklyData = {}; // { 'YYYY-WW': count }
            
            // Only count tools for this statistic for now
            appState.tools.forEach(tool => {
                const date = new Date(tool.addedDate);
                const year = date.getFullYear();
                const week = getWeekNumber(date); // Custom function to get week number
                const weekKey = `${year}-${String(week).padStart(2, '0')}`;
                
                weeklyData[weekKey] = (weeklyData[weekKey] || 0) + 1;
            });

            const sortedWeeks = Object.keys(weeklyData).sort().reverse(); // Sort descending for most recent weeks

            if (sortedWeeks.length === 0) {
                toolsAddedPerWeekList.innerHTML = '';
                noToolsAdded.style.display = 'block';
            } else {
                noToolsAdded.style.display = 'none';
                toolsAddedPerWeekList.innerHTML = sortedWeeks.map(weekKey => `
                    <li>
                        <span>Week ${weekKey.split('-')[1]}, ${weekKey.split('-')[0]}</span>
                        <span>${weeklyData[weekKey]} tools added</span>
                    </li>
                `).join('');
            }
        }

        // Helper function to get week number (ISO week date standard)
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }


        // Modal functions
        function showModal(modalId) {
            if (appState.readOnlyMode) { // New: Prevent opening modals in read-only mode
                showToast("Cannot modify entries in read-only shared view.", "warning");
                return;
            }

            document.getElementById(modalId).classList.add('show');
            // Logic specific to addEntryModal
            if (modalId === 'addEntryModal') {
                document.getElementById('addEntryForm').reset();
                document.getElementById('entryTypeSelect').value = 'tool'; // Default to tool
                displayEntryForm(); // Show tool form by default
                populateCategoryFilter(); // Re-populate to include any new categories
                document.getElementById('toolCategory').value = ''; // Reset select to default
                document.getElementById('newCategoryInput').style.display = 'none'; // Hide custom input initially
                document.getElementById('newCategoryInput').value = ''; // Clear custom input
            } else if (modalId === 'editEntryModal') {
                 // The edit modal form content will be set by openEditEntryModal
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Display the correct form fields based on selected entry type
        function displayEntryForm() {
            const entryType = document.getElementById('entryTypeSelect').value;
            // Hide all specific forms
            document.getElementById('addToolFields').style.display = 'none';
            document.getElementById('addEmailFields').style.display = 'none';
            document.getElementById('addPhoneFields').style.display = 'none';
            document.getElementById('addCryptoFields').style.display = 'none';
            document.getElementById('addLocationFields').style.display = 'none';
            document.getElementById('addLinkFields').style.display = 'none';
            document.getElementById('addMediaFields').style.display = 'none';
            document.getElementById('addPasswordFields').style.display = 'none'; // New
            document.getElementById('addKeywordFields').style.display = 'none';  // New
            document.getElementById('addSocialFields').style.display = 'none';   // New
            
            // Reset required attributes for all inputs to manage them dynamically
            document.querySelectorAll('#addEntryForm input, #addEntryForm select, #addEntryForm textarea').forEach(input => {
                input.removeAttribute('required');
            });

            // Show the selected form and set required fields
            switch (entryType) {
                case 'tool':
                    document.getElementById('addToolFields').style.display = 'block';
                    document.getElementById('toolName').setAttribute('required', 'required');
                    document.getElementById('toolUrl').setAttribute('required', 'required');
                    document.getElementById('toolCategory').setAttribute('required', 'required');
                    populateCategoryFilter(); // Ensure categories are up-to-date for tools
                    break;
                case 'email':
                    document.getElementById('addEmailFields').style.display = 'block';
                    document.getElementById('emailAddress').setAttribute('required', 'required');
                    break;
                case 'phone':
                    document.getElementById('addPhoneFields').style.display = 'block';
                    document.getElementById('phoneNumber').setAttribute('required', 'required');
                    break;
                case 'crypto':
                    document.getElementById('addCryptoFields').style.display = 'block';
                    document.getElementById('cryptoAddress').setAttribute('required', 'required');
                    document.getElementById('cryptoTxid').setAttribute('required', 'required');
                    document.getElementById('cryptoAmount').setAttribute('required', 'required');
                    break;
                case 'location':
                    document.getElementById('addLocationFields').style.display = 'block';
                    document.getElementById('locationName').setAttribute('required', 'required');
                    document.getElementById('locationCoordinates').setAttribute('required', 'required');
                    break;
                case 'link':
                    document.getElementById('addLinkFields').style.display = 'block';
                    document.getElementById('linkUrl').setAttribute('required', 'required');
                    break;
                case 'media':
                    document.getElementById('addMediaFields').style.display = 'block';
                    document.getElementById('mediaTitle').setAttribute('required', 'required');
                    document.getElementById('mediaType').setAttribute('required', 'required');
                    // Add change listener for media file input for base64 encoding
                    document.getElementById('mediaFile').addEventListener('change', handleMediaFileSelect);
                    break;
                case 'password': // New
                    document.getElementById('addPasswordFields').style.display = 'block';
                    document.getElementById('passwordService').setAttribute('required', 'required');
                    document.getElementById('passwordValue').setAttribute('required', 'required');
                    break;
                case 'keyword': // New
                    document.getElementById('addKeywordFields').style.display = 'block';
                    document.getElementById('keywordValue').setAttribute('required', 'required');
                    break;
                case 'social': // New
                    document.getElementById('addSocialFields').style.display = 'block';
                    document.getElementById('socialPlatform').setAttribute('required', 'required');
                    document.getElementById('socialUrl').setAttribute('required', 'required');
                    document.getElementById('socialUsername').setAttribute('required', 'required');
                    break;
            }
        }

        // Add new entry
        function handleAddEntry(e) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot add entries in read-only shared view.", "warning");
                return;
            }

            e.preventDefault();
            
            const entryType = document.getElementById('entryTypeSelect').value;
            let newEntry = {
                id: generateId(),
                type: entryType,
                starred: false,
                pinned: false,
                addedDate: new Date(),
                lastUsed: 0 // Initialize lastUsed for all new types
            };

            switch (entryType) {
                case 'tool':
                    newEntry.name = document.getElementById('toolName').value;
                    newEntry.url = document.getElementById('toolUrl').value;
                    let toolCategory = document.getElementById('toolCategory').value;
                    const newCategoryInput = document.getElementById('newCategoryInput').value.trim();
                    if (toolCategory === 'custom' && newCategoryInput) {
                        newEntry.category = newCategoryInput.toLowerCase();
                    } else if (toolCategory === 'custom' && !newCategoryInput) {
                        showToast('Please enter a custom category name.', 'error'); return;
                    } else if (!toolCategory) {
                        showToast('Please select or enter a category.', 'error'); return;
                    }
                    newEntry.category = toolCategory;
                    newEntry.description = document.getElementById('toolDescription').value;
                    newEntry.tags = document.getElementById('toolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    newEntry.favicon = `https://www.google.com/s2/favicons?domain=${new URL(newEntry.url).hostname}`;
                    appState.tools.push(newEntry);
                    break;
                case 'email':
                    newEntry.email = document.getElementById('emailAddress').value;
                    newEntry.notes = document.getElementById('emailNotes').value;
                    newEntry.linkedPlatforms = document.getElementById('emailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p !== '');
                    newEntry.breachResults = document.getElementById('emailBreachResults').value;
                    appState.emails.push(newEntry);
                    break;
                case 'phone':
                    newEntry.number = document.getElementById('phoneNumber').value;
                    newEntry.phoneType = document.getElementById('phoneType').value;
                    newEntry.location = document.getElementById('phoneLocation').value;
                    newEntry.notes = document.getElementById('phoneNotes').value;
                    appState.phones.push(newEntry);
                    break;
                case 'crypto':
                    newEntry.address = document.getElementById('cryptoAddress').value;
                    newEntry.txid = document.getElementById('cryptoTxid').value;
                    newEntry.amount = parseFloat(document.getElementById('cryptoAmount').value);
                    newEntry.source = document.getElementById('cryptoSource').value;
                    newEntry.tags = document.getElementById('cryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    appState.crypto.push(newEntry);
                    break;
                case 'location':
                    newEntry.name = document.getElementById('locationName').value;
                    newEntry.coordinates = document.getElementById('locationCoordinates').value;
                    newEntry.mapLink = document.getElementById('locationMapLink').value;
                    newEntry.notes = document.getElementById('locationNotes').value;
                    newEntry.ipGeoIntel = document.getElementById('locationIpGeoIntel').value;
                    appState.locations.push(newEntry);
                    break;
                case 'link':
                    newEntry.url = document.getElementById('linkUrl').value;
                    newEntry.notes = document.getElementById('linkNotes').value;
                    newEntry.platform = document.getElementById('linkPlatform').value;
                    newEntry.tags = document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    appState.links.push(newEntry);
                    break;
                case 'media':
                    newEntry.title = document.getElementById('mediaTitle').value;
                    newEntry.notes = document.getElementById('mediaNotes').value;
                    newEntry.mediaType = document.getElementById('mediaType').value; // 'image' or 'video'
                    // For local-only use, we store base64 if a file was selected.
                    // The handleMediaFileSelect function will populate a hidden input with the base64 data.
                    newEntry.base64Data = document.getElementById('mediaBase64Data').value;
                    appState.media.push(newEntry);
                    break;
                case 'password': // New
                    newEntry.service = document.getElementById('passwordService').value;
                    newEntry.username = document.getElementById('passwordUsername').value;
                    newEntry.password = document.getElementById('passwordValue').value;
                    newEntry.notes = document.getElementById('passwordNotes').value;
                    newEntry.strength = document.getElementById('passwordStrength').value;
                    appState.passwords.push(newEntry);
                    break;
                case 'keyword': // New
                    newEntry.value = document.getElementById('keywordValue').value;
                    newEntry.context = document.getElementById('keywordContext').value;
                    newEntry.notes = document.getElementById('keywordNotes').value;
                    appState.keywords.push(newEntry);
                    break;
                case 'social': // New
                    newEntry.platform = document.getElementById('socialPlatform').value;
                    newEntry.url = document.getElementById('socialUrl').value;
                    newEntry.username = document.getElementById('socialUsername').value;
                    newEntry.notes = document.getElementById('socialNotes').value;
                    newEntry.followCounts = document.getElementById('socialFollowCounts').value;
                    appState.socials.push(newEntry);
                    break;
                default:
                    showToast('Invalid entry type selected.', 'error');
                    return;
            }

            // If currently in a custom tab, assign the new entry to it
            if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
                const activeCustomTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
                if (activeCustomTab) {
                    newEntry.customTabs = newEntry.customTabs || []; // Ensure it's initialized
                    newEntry.customTabs.push(activeCustomTab.id);
                    activeCustomTab.toolIds.push(newEntry.id); // toolIds now holds any entry type ID
                }
            }
            
            updateStats();
            populateCategoryFilter(); // Refresh categories including the new one (if tool)
            renderIntelligenceEntries();
            renderCustomTabs(); // To update the entry count in sub-tabs
            hideModal('addEntryModal');
            showToast('Entry added successfully!');
            
            // Reset form and custom category input
            e.target.reset();
            document.getElementById('newCategoryInput').style.display = 'none';
            document.getElementById('newCategoryInput').value = '';
            saveState();
        }

        // Handle media file selection for base64 encoding
        function handleMediaFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('mediaBase64Data').value = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('mediaBase64Data').value = '';
            }
        }

       // Open Edit Entry Modal and populate fields
       function openEditEntryModal(entry) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit entries in read-only shared view.", "warning");
                return;
            }

            document.getElementById('editEntryId').value = entry.id;
            document.getElementById('editEntryType').value = entry.type;

            // Hide all specific edit forms first
            document.getElementById('editToolFields').style.display = 'none';
            document.getElementById('editEmailFields').style.display = 'none';
            document.getElementById('editPhoneFields').style.display = 'none';
            document.getElementById('editCryptoFields').style.display = 'none';
            document.getElementById('editLocationFields').style.display = 'none';
            document.getElementById('editLinkFields').style.display = 'none';
            document.getElementById('editMediaFields').style.display = 'none';
            document.getElementById('editPasswordFields').style.display = 'none'; // New
            document.getElementById('editKeywordFields').style.display = 'none';  // New
            document.getElementById('editSocialFields').style.display = 'none';   // New


            // Reset required attributes for all inputs to manage them dynamically
            document.querySelectorAll('#editEntryForm input, #editEntryForm select, #editEntryForm textarea').forEach(input => {
                input.removeAttribute('required');
            });


            switch (entry.type) {
                case 'tool':
                    document.getElementById('editToolFields').style.display = 'block';
                    document.getElementById('editToolName').value = entry.name;
                    document.getElementById('editToolUrl').value = entry.url;
                    document.getElementById('editToolDescription').value = entry.description;
                    document.getElementById('editToolTags').value = entry.tags.join(', ');
                    document.getElementById('editToolName').setAttribute('required', 'required');
                    document.getElementById('editToolUrl').setAttribute('required', 'required');
                    document.getElementById('editToolCategory').setAttribute('required', 'required');

                    // Populate category dropdown
                    populateCategoryFilter(); // Ensure dropdown has all categories
                    const editToolCategorySelect = document.getElementById('editToolCategory');
                    editToolCategorySelect.value = entry.category;
                    
                    // Handle custom category selection for editing
                    const editNewCategoryInput = document.getElementById('editNewCategoryInput');
                    if (editToolCategorySelect.value !== entry.category && !editToolCategorySelect.querySelector(`option[value="${entry.category}"]`)) {
                        editToolCategorySelect.value = 'custom';
                        editNewCategoryInput.style.display = 'block';
                        editNewCategoryInput.value = entry.category;
                        editNewCategoryInput.setAttribute('required', 'required');
                    } else {
                        editNewCategoryInput.style.display = 'none';
                        editNewCategoryInput.value = '';
                        editNewCategoryInput.removeAttribute('required');
                    }
                    break;
                case 'email':
                    document.getElementById('editEmailFields').style.display = 'block';
                    document.getElementById('editEmailAddress').value = entry.email;
                    document.getElementById('editEmailNotes').value = entry.notes;
                    document.getElementById('editEmailLinkedPlatforms').value = entry.linkedPlatforms.join(', ');
                    document.getElementById('editEmailBreachResults').value = entry.breachResults;
                    document.getElementById('editEmailAddress').setAttribute('required', 'required');
                    break;
                case 'phone':
                    document.getElementById('editPhoneFields').style.display = 'block';
                    document.getElementById('editPhoneNumber').value = entry.number;
                    document.getElementById('editPhoneType').value = entry.phoneType;
                    document.getElementById('editPhoneLocation').value = entry.location;
                    document.getElementById('editPhoneNotes').value = entry.notes;
                    document.getElementById('editPhoneNumber').setAttribute('required', 'required');
                    break;
                case 'crypto':
                    document.getElementById('editCryptoFields').style.display = 'block';
                    document.getElementById('editCryptoAddress').value = entry.address;
                    document.getElementById('editCryptoTxid').value = entry.txid;
                    document.getElementById('editCryptoAmount').value = entry.amount;
                    document.getElementById('editCryptoSource').value = entry.source;
                    document.getElementById('editCryptoTags').value = entry.tags.join(', ');
                    document.getElementById('editCryptoAddress').setAttribute('required', 'required');
                    document.getElementById('editCryptoTxid').setAttribute('required', 'required');
                    document.getElementById('editCryptoAmount').setAttribute('required', 'required');
                    break;
                case 'location':
                    document.getElementById('editLocationFields').style.display = 'block';
                    document.getElementById('editLocationName').value = entry.name;
                    document.getElementById('editLocationCoordinates').value = entry.coordinates;
                    document.getElementById('editLocationMapLink').value = entry.mapLink;
                    document.getElementById('editLocationNotes').value = entry.notes;
                    document.getElementById('editLocationIpGeoIntel').value = entry.ipGeoIntel;
                    document.getElementById('editLocationName').setAttribute('required', 'required');
                    document.getElementById('editLocationCoordinates').setAttribute('required', 'required');
                    break;
                case 'link':
                    document.getElementById('editLinkFields').style.display = 'block';
                    document.getElementById('editLinkUrl').value = entry.url;
                    document.getElementById('editLinkNotes').value = entry.notes;
                    document.getElementById('editLinkPlatform').value = entry.platform;
                    document.getElementById('editLinkTags').value = entry.tags.join(', ');
                    document.getElementById('editLinkUrl').setAttribute('required', 'required');
                    break;
                case 'media':
                    document.getElementById('editMediaFields').style.display = 'block';
                    document.getElementById('editMediaTitle').value = entry.title;
                    document.getElementById('editMediaNotes').value = entry.notes;
                    document.getElementById('editMediaType').value = entry.mediaType;
                    // For media, the file input itself won't have a value for existing base64.
                    // If they upload a new file, it will overwrite the old base64 data.
                    document.getElementById('editMediaBase64Data').value = entry.base64Data || '';
                    // Remove existing listener to prevent duplicates and add a new one
                    document.getElementById('editMediaFile').removeEventListener('change', handleEditMediaFileSelect);
                    document.getElementById('editMediaFile').addEventListener('change', handleEditMediaFileSelect);
                    document.getElementById('editMediaTitle').setAttribute('required', 'required');
                    document.getElementById('editMediaType').setAttribute('required', 'required');
                    break;
                case 'password': // New
                    document.getElementById('editPasswordFields').style.display = 'block';
                    document.getElementById('editPasswordService').value = entry.service;
                    document.getElementById('editPasswordUsername').value = entry.username;
                    document.getElementById('editPasswordValue').value = entry.password;
                    document.getElementById('editPasswordNotes').value = entry.notes;
                    document.getElementById('editPasswordStrength').value = entry.strength;
                    document.getElementById('editPasswordService').setAttribute('required', 'required');
                    document.getElementById('editPasswordValue').setAttribute('required', 'required');
                    break;
                case 'keyword': // New
                    document.getElementById('editKeywordFields').style.display = 'block';
                    document.getElementById('editKeywordValue').value = entry.value;
                    document.getElementById('editKeywordContext').value = entry.context;
                    document.getElementById('editKeywordNotes').value = entry.notes;
                    document.getElementById('editKeywordValue').setAttribute('required', 'required');
                    break;
                case 'social': // New
                    document.getElementById('editSocialFields').style.display = 'block';
                    document.getElementById('editSocialPlatform').value = entry.platform;
                    document.getElementById('editSocialUrl').value = entry.url;
                    document.getElementById('editSocialUsername').value = entry.username;
                    document.getElementById('editSocialNotes').value = entry.notes;
                    document.getElementById('editSocialFollowCounts').value = entry.followCounts;
                    document.getElementById('editSocialPlatform').setAttribute('required', 'required');
                    document.getElementById('editSocialUrl').setAttribute('required', 'required');
                    document.getElementById('editSocialUsername').setAttribute('required', 'required');
                    break;
            }

            // Populate custom tab checkboxes for all entry types
            const assignCustomTabsCheckboxes = document.getElementById('assignCustomTabsCheckboxes');
            assignCustomTabsCheckboxes.innerHTML = appState.customTabs.map(customTab => {
                const isChecked = (entry.customTabs || []).includes(customTab.id); // Ensure customTabs exists
                return `
                    <label class="custom-tab-checkbox ${isChecked ? 'checked' : ''}">
                        <input type="checkbox" class="custom-tab-assign-checkbox" value="${customTab.id}" ${isChecked ? 'checked' : ''}>
                        ${customTab.name}
                    </label>
                `;
            }).join('');


            showModal('editEntryModal');
       }

       // Handle saving edited entry
       function handleEditEntry(e) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot save changes in read-only shared view.", "warning");
                return;
            }

            e.preventDefault();

            const entryId = document.getElementById('editEntryId').value;
            const entryType = document.getElementById('editEntryType').value; // Get the type from the hidden input

            let entryArray = null;
            switch (entryType) {
                case 'tool': entryArray = appState.tools; break;
                case 'email': entryArray = appState.emails; break;
                case 'phone': entryArray = appState.phones; break;
                case 'crypto': entryArray = appState.crypto; break;
                case 'location': entryArray = appState.locations; break;
                case 'link': entryArray = appState.links; break;
                case 'media': entryArray = appState.media; break;
                case 'password': entryArray = appState.passwords; break; // New
                case 'keyword': entryArray = appState.keywords; break; // New
                case 'social': entryArray = appState.socials; break; // New
            }

            const entryIndex = entryArray ? entryArray.findIndex(t => t.id === entryId) : -1;
            if (entryIndex === -1) {
                showToast('Error: Entry not found for editing.', 'error');
                return;
            }

            const oldEntry = entryArray[entryIndex];
            let updatedEntry = { ...oldEntry };

            switch (entryType) {
                case 'tool':
                    updatedEntry.name = document.getElementById('editToolName').value;
                    updatedEntry.url = document.getElementById('editToolUrl').value;
                    let toolCategory = document.getElementById('editToolCategory').value;
                    const newCategoryInput = document.getElementById('editNewCategoryInput').value.trim();
                    if (toolCategory === 'custom' && newCategoryInput) {
                        updatedEntry.category = newCategoryInput.toLowerCase();
                    } else if (toolCategory === 'custom' && !newCategoryInput) {
                        showToast('Please enter a custom category name for editing.', 'error'); return;
                    } else if (!toolCategory) {
                        showToast('Please select or enter a category for editing.', 'error'); return;
                    }
                    updatedEntry.category = toolCategory;
                    updatedEntry.description = document.getElementById('editToolDescription').value;
                    updatedEntry.tags = document.getElementById('editToolTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    updatedEntry.favicon = `https://www.google.com/s2/favicons?domain=${new URL(updatedEntry.url).hostname}`;
                    break;
                case 'email':
                    updatedEntry.email = document.getElementById('editEmailAddress').value;
                    updatedEntry.notes = document.getElementById('editEmailNotes').value;
                    updatedEntry.linkedPlatforms = document.getElementById('editEmailLinkedPlatforms').value.split(',').map(p => p.trim()).filter(p => p !== '');
                    updatedEntry.breachResults = document.getElementById('editEmailBreachResults').value;
                    break;
                case 'phone':
                    updatedEntry.number = document.getElementById('editPhoneNumber').value;
                    updatedEntry.phoneType = document.getElementById('editPhoneType').value;
                    updatedEntry.location = document.getElementById('editPhoneLocation').value;
                    updatedEntry.notes = document.getElementById('editPhoneNotes').value;
                    break;
                case 'crypto':
                    updatedEntry.address = document.getElementById('editCryptoAddress').value;
                    updatedEntry.txid = document.getElementById('editCryptoTxid').value;
                    updatedEntry.amount = parseFloat(document.getElementById('editCryptoAmount').value);
                    updatedEntry.source = document.getElementById('editCryptoSource').value;
                    updatedEntry.tags = document.getElementById('editCryptoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    break;
                case 'location':
                    updatedEntry.name = document.getElementById('editLocationName').value;
                    updatedEntry.coordinates = document.getElementById('editLocationCoordinates').value;
                    updatedEntry.mapLink = document.getElementById('editLocationMapLink').value;
                    updatedEntry.notes = document.getElementById('editLocationNotes').value;
                    updatedEntry.ipGeoIntel = document.getElementById('editLocationIpGeoIntel').value;
                    break;
                case 'link':
                    updatedEntry.url = document.getElementById('editLinkUrl').value;
                    updatedEntry.notes = document.getElementById('editLinkNotes').value;
                    updatedEntry.platform = document.getElementById('editLinkPlatform').value;
                    updatedEntry.tags = document.getElementById('editLinkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    break;
                case 'media':
                    updatedEntry.title = document.getElementById('editMediaTitle').value;
                    updatedEntry.notes = document.getElementById('editMediaNotes').value;
                    updatedEntry.mediaType = document.getElementById('editMediaType').value;
                    // Only update base64Data if a new file was selected during edit
                    const newBase64Data = document.getElementById('editMediaBase64Data').value;
                    if (newBase64Data) {
                         updatedEntry.base64Data = newBase64Data;
                    }
                    break;
                case 'password': // New
                    updatedEntry.service = document.getElementById('editPasswordService').value;
                    updatedEntry.username = document.getElementById('editPasswordUsername').value;
                    updatedEntry.password = document.getElementById('editPasswordValue').value;
                    updatedEntry.notes = document.getElementById('editPasswordNotes').value;
                    updatedEntry.strength = document.getElementById('editPasswordStrength').value;
                    break;
                case 'keyword': // New
                    updatedEntry.value = document.getElementById('editKeywordValue').value;
                    updatedEntry.context = document.getElementById('editKeywordContext').value;
                    updatedEntry.notes = document.getElementById('editKeywordNotes').value;
                    break;
                case 'social': // New
                    updatedEntry.platform = document.getElementById('editSocialPlatform').value;
                    updatedEntry.url = document.getElementById('editSocialUrl').value;
                    updatedEntry.username = document.getElementById('editSocialUsername').value;
                    updatedEntry.notes = document.getElementById('editSocialNotes').value;
                    updatedEntry.followCounts = document.getElementById('editSocialFollowCounts').value;
                    break;
            }

            // Get selected custom tabs
            const selectedCustomTabIds = Array.from(document.querySelectorAll('#assignCustomTabsCheckboxes .custom-tab-assign-checkbox:checked'))
                                             .map(checkbox => checkbox.value);
            updatedEntry.customTabs = selectedCustomTabIds;


            // Update the entry in its respective array
            entryArray[entryIndex] = updatedEntry;

            // Update toolIds array in customTabs objects for this entry
            appState.customTabs.forEach(customTab => {
                const isEntryInTab = customTab.toolIds.includes(entryId); // toolIds now holds any entry type ID
                const shouldEntryBeInTab = selectedCustomTabIds.includes(customTab.id);

                if (!isEntryInTab && shouldEntryBeInTab) {
                    customTab.toolIds.push(entryId); // Add entry to this custom tab
                } else if (isEntryInTab && !shouldEntryBeInTab) {
                    customTab.toolIds = customTab.toolIds.filter(id => id !== entryId); // Remove entry from this custom tab
                }
            });

            updateStats();
            populateCategoryFilter(); // Refresh categories in case category changed
            renderIntelligenceEntries();
            renderCustomTabs(); // Re-render custom tabs to update counts/content
            hideModal('editEntryModal');
            showToast('Entry updated successfully!');
            saveState();
       }

        // Handle media file selection for base64 encoding in EDIT modal
        function handleEditMediaFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('editMediaBase64Data').value = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('editMediaBase64Data').value = '';
            }
        }


       // Theme functions
       function initTheme() {
           document.documentElement.setAttribute('data-theme', appState.theme);
           // Update theme toggle icon
           const themeToggleBtn = document.getElementById('themeToggle');
           if (appState.theme === 'dark') {
               themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
               themeToggleBtn.title = 'Switch to Light Theme';
           } else {
               themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
               themeToggleBtn.title = 'Switch to Dark Theme';
           }
       }

       function toggleTheme() {
           appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
           localStorage.setItem('theme', appState.theme); // Save theme preference
           initTheme(); // Apply theme and update button
           showToast(`Switched to ${appState.theme} theme`);
       }

       // View Mode Toggle (Grid/List)
       function toggleViewMode() {
           appState.viewMode = appState.viewMode === 'grid' ? 'list' : 'grid';
           localStorage.setItem('viewMode', appState.viewMode); // Save view mode preference
           renderIntelligenceEntries();
           saveState();
           showToast(`Switched to ${appState.viewMode} view`);

           // Update the button text and icon based on the new viewMode
           const viewToggleButton = document.getElementById('viewToggle');
           const vaultViewToggleButton = document.getElementById('vaultViewToggle');

           if (appState.viewMode === 'grid') {
               viewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
               viewToggleButton.title = 'Switch to List View';
               vaultViewToggleButton.innerHTML = '<i class="fas fa-list"></i> List View';
               vaultViewToggleButton.title = 'Switch to List View';
           } else {
               viewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
               viewToggleButton.title = 'Switch to Grid View';
               vaultViewToggleButton.innerHTML = '<i class="fas fa-th"></i> Grid View';
               vaultViewToggleButton.title = 'Switch to Grid View';
           }
       }

       // Utility functions
       function generateId() {
           return Date.now().toString(36) + Math.random().toString(36).substr(2);
       }

       function formatTime(date) {
           const now = new Date();
           const diff = now - date; // difference in milliseconds
           
           const seconds = Math.floor(diff / 1000);
           const minutes = Math.floor(seconds / 60);
           const hours = Math.floor(minutes / 60);
           const days = Math.floor(hours / 24);
           const months = Math.floor(days / 30);
           const years = Math.floor(days / 365);

           if (seconds < 60) return `${seconds}s ago`;
           if (minutes < 60) return `${minutes}m ago`;
           if (hours < 24) return `${hours}h ago`;
           if (days < 30) return `${days}d ago`;
           if (months < 12) return `${months}mo ago`;
           return `${years}y ago`;
       }

       function showToast(message, type = 'success') {
           const toast = document.createElement('div');
           toast.className = `toast toast-${type}`;
           toast.innerHTML = `
               <i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'error' ? 'times-circle' : (type === 'info' ? 'info-circle' : 'exclamation-circle'))}"></i>
               ${message}
           `;
           
           document.body.appendChild(toast);
           
           // Force reflow to ensure animation plays
           void toast.offsetWidth; 

           toast.classList.add('show');
           
           setTimeout(() => {
               toast.classList.remove('show');
               setTimeout(() => {
                   document.body.removeChild(toast);
               }, 300); // Wait for fade out animation
           }, 3000);
       }

       function clearFilters() {
           if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
               showToast("Cannot clear filters in read-only shared view.", "warning");
               return;
           }

           appState.filters = {
               category: '',
               search: '',
               sort: 'name',
               searchScope: 'currentTab' // Reset search scope too
           };
           
           document.getElementById('searchInput').value = '';
           document.getElementById('categoryFilter').value = '';
           document.getElementById('sortFilter').value = 'name';
           document.getElementById('searchScopeSelect').value = 'currentTab'; // Reset search scope select
           
           renderIntelligenceEntries();
           showToast('Filters cleared!');
       }

       function generateReport() {
           if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
               showToast("Cannot generate reports in read-only shared view.", "warning");
               return;
           }

           const report = {
               timestamp: new Date().toISOString(),
               totalTools: appState.tools.length,
               totalEmails: appState.emails.length,
               totalPhones: appState.phones.length,
               totalCrypto: appState.crypto.length,
               totalLocations: appState.locations.length,
               totalLinks: appState.links.length,
               totalMedia: appState.media.length,
               totalPasswords: appState.passwords.length, // New
               totalKeywords: appState.keywords.length,   // New
               totalSocials: appState.socials.length,     // New
               categories: [...new Set(appState.tools.map(t => t.category))], // Only tools have categories for now
               starredEntries: [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials].filter(t => t.starred).length,
               pinnedEntries: [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials].filter(t => t.pinned).length,
               usageStatistics: appState.usageStats,
               recentlyUsedEntries: [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials]
                                                .filter(t => t.lastUsed > 0)
                                                .sort((a,b) => b.lastUsed - a.lastUsed)
                                                .slice(0, 10) // Top 10 recently used
                                                .map(t => ({ name: t.name || t.email || t.number || t.address || t.locationName || t.url || t.title || t.service || t.value || t.username, type: t.type, lastUsed: new Date(t.lastUsed || 0).toLocaleString() }))
           };
           
           const reportWindow = window.open('', '_blank');
           reportWindow.document.write(`
               <html>
               <head>
                   <title>OSINT Arsenal Report</title>
                   <style>
                       body { font-family: 'Inter', sans-serif; margin: 40px; background-color: #f8f9fa; color: #343a40; }
                       .header { border-bottom: 2px solid #007bff; padding-bottom: 20px; margin-bottom: 30px; }
                       h1 { color: #007bff; }
                       h2 { color: #495057; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 5px; }
                       .stat { margin: 10px 0; font-size: 1.1em; }
                       .stat strong { color: #007bff; }
                       .category-list, .tool-list { list-style-type: none; padding: 0; }
                       .category-list li, .tool-list li { background-color: #e9ecef; padding: 10px; margin-bottom: 8px; border-radius: 5px; }
                       .threat-level-dist { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
                       .threat-box { padding: 10px 15px; border-radius: 5px; color: white; font-weight: bold; }
                       .threat-high { background-color: #dc3545; }
                       .threat-medium { background-color: #ffc107; }
                       .threat-low { background-color: #28a745; }
                       .footer { margin-top: 50px; text-align: center; font-size: 0.9em; color: #6c757d; }
                   </style>
               </head>
               <body>
                   <div class="header">
                       <h1>OSINT Arsenal Activity Report</h1>
                       <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                   </div>
                   
                   <h2>Summary Statistics</h2>
                   <div class="stat"><strong>Total Tools:</strong> ${report.totalTools}</div>
                   <div class="stat"><strong>Total Email Entries:</strong> ${report.totalEmails}</div>
                   <div class="stat"><strong>Total Phone Entries:</strong> ${report.totalPhones}</div>
                   <div class="stat"><strong>Total Crypto Entries:</strong> ${report.totalCrypto}</div>
                   <div class="stat"><strong>Total Location Entries:</strong> ${report.totalLocations}</div>
                   <div class="stat"><strong>Total Link Entries:</strong> ${report.totalLinks}</div>
                   <div class="stat"><strong>Total Media Entries:</strong> ${report.totalMedia}</div>
                   <div class="stat"><strong>Total Password Entries:</strong> ${report.totalPasswords}</div>
                   <div class="stat"><strong>Total Keyword Entries:</strong> ${report.totalKeywords}</div>
                   <div class="stat"><strong>Total Social Media Profile Entries:</strong> ${report.totalSocials}</div>
                   <div class="stat"><strong>Unique Categories (Tools):</strong> ${report.categories.length}</div>
                   <div class="stat"><strong>Starred Entries:</strong> ${report.starredEntries}</div>
                   <div class="stat"><strong>Pinned Entries:</strong> ${report.pinnedEntries}</div>
                   
                   <h2>Usage Overview</h2>
                   <div class="stat"><strong>Tools Used Today:</strong> ${report.usageStatistics.toolsUsedToday}</div>
                   
                   <h2>Recently Used Entries</h2>
                   ${report.recentlyUsedEntries.length > 0 ? `
                   <ul class="tool-list">
                       ${report.recentlyUsedEntries.map(entry => `<li>${entry.name} (${entry.type}) (Last Used: ${entry.lastUsed})</li>`).join('')}
                   </ul>` : `<p>No entries have been used recently.</p>`}

                   <h2>Tool Categories Overview</h2>
                   <ul class="category-list">
                       ${report.categories.map(cat => `<li>${cat.charAt(0).toUpperCase() + cat.slice(1)}</li>`).join('')}
                   </ul>

                   <div class="footer">
                       <p>This report provides a snapshot of your OSINT Arsenal activity.</p>
                       <p>For more detailed insights, refer to the platform dashboard.</p>
                   </div>
               </body>
               </html>
           `);
           
           showToast('Report generated in new window!');
       }


       function exportData() {
           if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
               showToast("Cannot export data in read-only shared view.", "warning");
               return;
           }

           const exportData = {
               tools: appState.tools,
               emails: appState.emails,
               phones: appState.phones,
               crypto: appState.crypto,
               locations: appState.locations,
               links: appState.links,
               media: appState.media,
               passwords: appState.passwords, // New
               keywords: appState.keywords,   // New
               socials: appState.socials,     // New
               usageStats: appState.usageStats,
               customTabs: appState.customTabs, // Include custom tabs in export
               exportDate: new Date().toISOString(),
               version: '1.5' // Increased version due to added entry types
           };
           
           const dataStr = JSON.stringify(exportData, null, 2);
           const dataBlob = new Blob([dataStr], {type: 'application/json'});
           const url = URL.createObjectURL(dataBlob);
           
           const link = document.createElement('a');
           link.href = url;
           link.download = 'osint_arsenal_backup.json';
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
           URL.revokeObjectURL(url);
           
           showToast('Data exported successfully!');
       }

        /* Custom Tab Functions */
        function renderCustomTabs() {
            const customSubTabsContainer = document.getElementById('customSubTabs');
            const editSubTabBtn = document.getElementById('editSubTabBtn');
            const deleteSubTabBtn = document.getElementById('deleteSubTabBtn');
            const exportSubTabBtn = document.getElementById('exportSubTabBtn'); // Get the new button
            // const generateShareLinkBtn = document.getElementById('generateShareLinkBtn'); // Moved to header, controlled by applyReadOnlyMode
            const emptyCustomTabState = document.getElementById('emptyCustomTabState');
            const emptyCurrentCustomTabState = document.getElementById('emptyCurrentCustomTabState');
            const customTabToolsGrid = document.getElementById('customTabToolsGrid');


            // Hide action buttons initially
            editSubTabBtn.style.display = 'none';
            deleteSubTabBtn.style.display = 'none';
            exportSubTabBtn.style.display = 'none'; // Hide export button too
            // generateShareLinkBtn.style.display = 'none'; // Moved to header, controlled globally

            customSubTabsContainer.innerHTML = ''; // Clear existing sub-tabs

            if (appState.customTabs.length === 0) {
                emptyCustomTabState.style.display = 'block';
                customTabToolsGrid.style.display = 'none';
                emptyCurrentCustomTabState.style.display = 'none'; // Hide if no custom tabs at all
                appState.currentCustomTab = null; // No active custom tab
            } else {
                emptyCustomTabState.style.display = 'none';
                // Only show these buttons if not in read-only mode
                if (!appState.readOnlyMode) {
                    editSubTabBtn.style.display = 'inline-flex';
                    deleteSubTabBtn.style.display = 'inline-flex';
                    exportSubTabBtn.style.display = 'inline-flex';
                    // generateShareLinkBtn.style.display = 'inline-flex'; // New: Show share button (global)
                }

                // Ensure a custom tab is active if customTabs exist
                if (!appState.currentCustomTab || !appState.customTabs.some(tab => tab.id === appState.currentCustomTab)) {
                    appState.currentCustomTab = appState.customTabs[0].id;
                }

                appState.customTabs.forEach(tab => {
                    const tabButton = document.createElement('button');
                    tabButton.className = `sub-nav-tab ${appState.currentCustomTab === tab.id ? 'active' : ''}`;
                    tabButton.dataset.subTabId = tab.id;
                    tabButton.style.backgroundColor = tab.color || 'transparent'; // Apply background color
                    tabButton.style.borderColor = tab.color || 'transparent'; // Optionally apply border color
                    tabButton.style.color = tab.color ? 'white' : 'var(--text-secondary)'; // Ensure text visibility
                    if (appState.theme === 'light' && tab.color && (tab.color.includes('yellow') || tab.color.includes('green') || tab.color.includes('var(--tab-color-default)'))) {
                        tabButton.style.color = 'var(--text-primary)'; // Adjust text color for light backgrounds
                    }

                    // Count all types of entries assigned to this custom tab
                    const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                    const entryCount = allEntries.filter(entry => (entry.customTabs || []).includes(tab.id)).length;


                    tabButton.innerHTML = `<i class="${tab.icon || 'fas fa-folder-open'}"></i> ${tab.name} <span class="tag">${entryCount}</span>`;
                    customSubTabsContainer.appendChild(tabButton);

                    // Re-activate the selected sub-tab to ensure its styling is correct if it's the active one
                    if (appState.currentCustomTab === tab.id) {
    // Apply background for active state only if a color is defined, otherwise use default
    tabButton.style.background = tab.color || 'var(--gradient-accent)';
    tabButton.style.boxShadow = `0 2px 10px ${tab.color ? tab.color + '40' : 'rgba(0, 255, 136, 0.2)'}`; // Add shadow
    tabButton.style.color = 'white'; // Ensure text is white for active tabs
}

                });

                // Re-activate the selected sub-tab to ensure its styling is correct
                const activeSubTabBtn = document.querySelector(`.sub-nav-tab[data-sub-tab-id="${appState.currentCustomTab}"]`);
                if (activeSubTabBtn) {
                    activeSubTabBtn.classList.add('active');
                }
            }
            renderIntelligenceEntries(); // Render entries specific to the active custom sub-tab (or none if no sub-tabs)
            saveState();
        }

        function switchCustomTab(tabId) {
            document.querySelectorAll('#customSubTabs .sub-nav-tab').forEach(btn => {
                btn.classList.remove('active');
                // Reset original styles when not active
                const tabData = appState.customTabs.find(t => t.id === btn.dataset.subTabId);
                if (tabData) {
                    btn.style.backgroundColor = tabData.color || 'transparent';
                    btn.style.borderColor = tabData.color || 'transparent';
                    btn.style.color = tabData.color ? 'white' : 'var(--text-secondary)';
                     if (appState.theme === 'light' && tabData.color && (tabData.color.includes('yellow') || tabData.color.includes('green') || tabData.color.includes('var(--tab-color-default)'))) {
                        btn.style.color = 'var(--text-primary)';
                    }
                    btn.style.boxShadow = 'none';
                }
            });
            const newActiveTab = document.querySelector(`#customSubTabs .sub-nav-tab[data-sub-tab-id="${tabId}"]`);
            if (newActiveTab) {
    newActiveTab.classList.add('active');
    const tabData = appState.customTabs.find(t => t.id === tabId);
    if (tabData) {
        // Apply active state styles
        newActiveTab.style.background = tabData.color || 'var(--gradient-accent)';
        newActiveTab.style.boxShadow = `0 2px 10px ${tabData.color ? tabData.color + '40' : 'rgba(0, 255, 136, 0.2)'}`;
        newActiveTab.style.color = 'white'; // Active tab text is always white
    }
}

            appState.currentCustomTab = tabId;
            renderIntelligenceEntries(); // Re-render entries filtered by this specific custom tab
            saveState();
        }

        // Populates the icon picker grid
        function populateIconPicker(containerId, currentIcon = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            availableIcons.forEach(iconClass => {
                const iconItem = document.createElement('div');
                iconItem.className = `icon-picker-item ${iconClass === currentIcon ? 'selected' : ''}`;
                iconItem.dataset.iconClass = iconClass;
                iconItem.innerHTML = `<i class="${iconClass}"></i>`;
                container.appendChild(iconItem);
            });
        }

        // Populates the color picker grid
        function populateColorPicker(containerId, currentColor = '') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            availableColors.forEach(colorValue => {
                const colorItem = document.createElement('div');
                colorItem.className = `color-picker-item ${colorValue === currentColor ? 'selected' : ''}`;
                colorItem.dataset.colorValue = colorValue;
                colorItem.style.backgroundColor = colorValue;
                container.appendChild(colorItem);
            });
        }

        function showCreateSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom tabs in read-only shared view.", "warning");
                return;
            }

            showModal('createSubTabModal');
            document.getElementById('newSubTabName').value = '';
            document.getElementById('newSubTabIcon').value = 'fas fa-folder-open'; // Default icon
            document.getElementById('newSubTabColor').value = 'var(--tab-color-default)'; // Default color
            populateIconPicker('newSubTabIconPicker', 'fas fa-folder-open');
            populateColorPicker('newSubTabColorPicker', 'var(--tab-color-default)');
        }


        function handleCreateSubTab(e) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot create custom tabs in read-only shared view.", "warning");
                return;
            }

            e.preventDefault();
            const newSubTabName = document.getElementById('newSubTabName').value.trim();
            const newSubTabIcon = document.getElementById('newSubTabIcon').value.trim();
            const newSubTabColor = document.getElementById('newSubTabColor').value.trim();

            if (!newSubTabName) {
                showToast('Sub-tab name cannot be empty.', 'warning');
                return;
            }

            // Check for duplicate name (case-insensitive)
            if (appState.customTabs.some(tab => tab.name.toLowerCase() === newSubTabName.toLowerCase())) {
                showToast('A sub-tab with this name already exists.', 'warning');
                return;
            }

            const newSubTab = {
                id: generateId(),
                name: newSubTabName,
                toolIds: [], // Now holds IDs for any entry type
                icon: newSubTabIcon || 'fas fa-folder-open', // Fallback to default icon
                color: newSubTabColor || 'var(--tab-color-default)' // Fallback to default color
            };
            appState.customTabs.push(newSubTab);
            appState.currentCustomTab = newSubTab.id; // Make the new tab active
            renderCustomTabs();
            hideModal('createSubTabModal');
            showToast('Custom sub-tab created!');
            saveState();
        }

        function openEditSubTabModal() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot edit custom tabs in read-only shared view.", "warning");
                return;
            }

            if (!appState.currentCustomTab) {
                showToast('Please select a sub-tab to edit.', 'warning');
                return;
            }
            const currentSubTab = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (currentSubTab) {
                document.getElementById('editSubTabId').value = currentSubTab.id;
                document.getElementById('editedSubTabName').value = currentSubTab.name;
                document.getElementById('editedSubTabIcon').value = currentSubTab.icon;
                document.getElementById('editedSubTabColor').value = currentSubTab.color;

                populateIconPicker('editedSubTabIconPicker', currentSubTab.icon);
                populateColorPicker('editedSubTabColorPicker', currentSubTab.color);

                showModal('editSubTabModal');
            }
        }

        function handleEditSubTab(e) {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot save custom tab changes in read-only shared view.", "warning");
                return;
            }

            e.preventDefault();
            const subTabId = document.getElementById('editSubTabId').value;
            const editedSubTabName = document.getElementById('editedSubTabName').value.trim();
            const editedSubTabIcon = document.getElementById('editedSubTabIcon').value.trim();
            const editedSubTabColor = document.getElementById('editedSubTabColor').value.trim();


            if (!editedSubTabName) {
                showToast('Sub-tab name cannot be empty.', 'warning');
                return;
            }

            // Check for duplicate name, excluding the current tab itself
            if (appState.customTabs.some(tab => tab.name.toLowerCase() === editedSubTabName.toLowerCase() && tab.id !== subTabId)) {
                showToast('A sub-tab with this name already exists.', 'warning');
                return;
            }

            const subTab = appState.customTabs.find(tab => tab.id === subTabId);
            if (subTab) {
                subTab.name = editedSubTabName;
                subTab.icon = editedSubTabIcon || 'fas fa-folder-open';
                subTab.color = editedSubTabColor || 'var(--tab-color-default)';
                renderCustomTabs();
                hideModal('editSubTabModal');
                showToast('Sub-tab updated successfully!');
                saveState();
            } else {
                showToast('Error: Sub-tab not found.', 'error');
            }
        }

        function handleDeleteSubTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot delete custom tabs in read-only shared view.", "warning");
                return;
            }

            if (!appState.currentCustomTab) {
                showToast('No sub-tab selected for deletion.', 'warning');
                return;
            }
            if (confirm(`Are you sure you want to delete the sub-tab "${appState.customTabs.find(t => t.id === appState.currentCustomTab)?.name}"? This will NOT delete the entries themselves.`)) {
                
                // Remove the customTabId from all entries that belong to it
                const deletedTabId = appState.currentCustomTab;
                const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
                allEntries.forEach(entry => {
                    if (entry.customTabs) { // Check if customTabs array exists on the entry
                        entry.customTabs = entry.customTabs.filter(tabId => tabId !== deletedTabId);
                    }
                });

                appState.customTabs = appState.customTabs.filter(tab => tab.id !== appState.currentCustomTab);
                
                // Set current custom tab to the first one available or null
                appState.currentCustomTab = appState.customTabs.length > 0 ? appState.customTabs[0].id : null;
                
                renderCustomTabs();
                showToast('Sub-tab deleted successfully!', 'error');
                saveState();
            }
        }

        function exportCustomTab() {
            if (appState.readOnlyMode) { // New: Prevent actions in read-only mode
                showToast("Cannot export custom tabs in read-only shared view.", "warning");
                return;
            }

            if (!appState.currentCustomTab) {
                showToast('Please select a custom tab to export.', 'warning');
                return;
            }

            const customTabToExport = appState.customTabs.find(tab => tab.id === appState.currentCustomTab);
            if (!customTabToExport) {
                showToast('Error: Selected custom tab not found.', 'error');
                return;
            }

            const allEntries = [...appState.tools, ...appState.emails, ...appState.phones, ...appState.crypto, ...appState.locations, ...appState.links, ...appState.media, ...appState.passwords, ...appState.keywords, ...appState.socials];
            const entriesInTab = allEntries.filter(entry => (entry.customTabs || []).includes(customTabToExport.id)); // toolIds now holds any entry type ID
            
            const exportData = {
                tabName: customTabToExport.name,
                tabIcon: customTabToExport.icon,
                tabColor: customTabToExport.color,
                entries: entriesInTab.map(entry => { // Only export relevant entry data
                    const exportedEntry = { id: entry.id, type: entry.type, starred: entry.starred, pinned: entry.pinned, addedDate: entry.addedDate };
                    switch (entry.type) {
                        case 'tool':
                            exportedEntry.name = entry.name;
                            exportedEntry.url = entry.url;
                            exportedEntry.category = entry.category;
                            exportedEntry.description = entry.description;
                            exportedEntry.tags = entry.tags;
                            exportedEntry.favicon = entry.favicon;
                            break;
                        case 'email':
                            exportedEntry.email = entry.email;
                            exportedEntry.notes = entry.notes;
                            exportedEntry.linkedPlatforms = entry.linkedPlatforms;
                            exportedEntry.breachResults = entry.breachResults;
                            break;
                        case 'phone':
                            exportedEntry.number = entry.number;
                            exportedEntry.phoneType = entry.phoneType;
                            exportedEntry.location = entry.location;
                            exportedEntry.notes = entry.notes;
                            break;
                        case 'crypto':
                            exportedEntry.address = entry.address;
                            exportedEntry.txid = entry.txid;
                            exportedEntry.amount = entry.amount;
                            exportedEntry.source = entry.source;
                            exportedEntry.tags = entry.tags;
                            break;
                        case 'location':
                            exportedEntry.name = entry.name;
                            exportedEntry.coordinates = entry.coordinates;
                            exportedEntry.mapLink = entry.mapLink;
                            exportedEntry.notes = entry.notes;
                            exportedEntry.ipGeoIntel = entry.ipGeoIntel;
                            break;
                        case 'link':
                            exportedEntry.url = entry.url;
                            exportedEntry.notes = entry.notes;
                            exportedEntry.platform = entry.platform;
                            exportedEntry.tags = entry.tags;
                            break;
                        case 'media':
                            exportedEntry.title = entry.title;
                            exportedEntry.notes = entry.notes;
                            exportedEntry.mediaType = entry.mediaType;
                            exportedEntry.base64Data = entry.base64Data; // Include base64 for media
                            break;
                        case 'password': // New
                            exportedEntry.service = entry.service;
                            exportedEntry.username = entry.username;
                            exportedEntry.password = entry.password;
                            exportedEntry.notes = entry.notes;
                            exportedEntry.strength = entry.strength;
                            break;
                        case 'keyword': // New
                            exportedEntry.value = entry.value;
                            exportedEntry.context = entry.context;
                            exportedEntry.notes = entry.notes;
                            break;
                        case 'social': // New
                            exportedEntry.platform = entry.platform;
                            exportedEntry.url = entry.url;
                            exportedEntry.username = entry.username;
                            exportedEntry.notes = entry.notes;
                            exportedEntry.followCounts = entry.followCounts;
                            break;
                    }
                    return exportedEntry;
                }),
                exportDate: new Date().toISOString(),
                description: `Export of the "${customTabToExport.name}" custom tab from OSINT Arsenal.`,
                version: '1.5' // Version for custom tab export, reflecting new entry types
            };

            const fileName = `osint_arsenal_tab_${customTabToExport.name.toLowerCase().replace(/\s/g, '_')}.json`;
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast(`Custom tab "${customTabToExport.name}" exported successfully!`);
        }

        // New: Function to display a random tool or OSINT tip professionally
        function showRandomDiscovery() {
            const randomDiscoveryElement = document.getElementById('randomDiscovery');
            if (!randomDiscoveryElement) return;

            const randomItemDisplay = document.getElementById('randomItemDisplay');
            randomItemDisplay.innerHTML = '<div class="loading"></div> Loading discovery...'; // Show loading state

            // Give a slightly higher chance to tools if available
            const hasTools = appState.tools.length > 0;
            const hasTips = appState.osintTips.length > 0;

            let content = '';
            let chosenType = '';

            // Simulate a network request delay for a smoother loading animation
            setTimeout(() => {
                if (hasTools && (!hasTips || Math.random() < 0.7)) { // 70% chance for tool if both exist
                    chosenType = 'tool';
                    const randomIndex = Math.floor(Math.random() * appState.tools.length);
                    const tool = appState.tools[randomIndex];

                    let faviconHtml = '';
                    if (tool.favicon) {
                        faviconHtml = `<img src="${tool.favicon}" alt="" class="tool-favicon" onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?domain=${new URL(tool.url).hostname}'">`;
                    } else {
                        faviconHtml = `<i class="fas fa-link"></i>`; // Fallback icon if no favicon
                    }

                    content = `
                        <p><strong>Featured Tool:</strong></p>
                        <p>
                            <a href="${tool.url}" target="_blank" class="random-tool-link">
                                ${faviconHtml}
                                ${tool.name}
                            </a>
                        </p>
                        <p style="font-size: 0.85em; color: var(--text-secondary;">${tool.description.substring(0, 120)}${tool.description.length > 120 ? '...' : ''}</p>
                    `;
                } else if (hasTips) {
                    chosenType = 'tip';
                    const randomIndex = Math.floor(Math.random() * appState.osintTips.length);
                    const tip = appState.osintTips[randomIndex];
                    content = `
                        <p><strong>OSINT Tip:</strong></p>
                        <p style="font-size: 0.9em;">${tip}</p>
                    `;
                } else {
                    content = `<p>No tools or tips available yet. Add some to get started!</p>`;
                }

                randomItemDisplay.innerHTML = content;
                // Adjust button text based on what was shown
                const newRandomBtn = document.getElementById('newRandomBtn');
                if (newRandomBtn) {
                    newRandomBtn.innerHTML = `<i class="fas fa-sync-alt"></i> New ${chosenType === 'tool' ? 'Tool' : (chosenType === 'tip' ? 'Tip' : 'Discovery')}`;
                }
            }, 500); // 500ms delay to show loading animation
        }

        // New: Function to parse URL for shareable tabs
        function parseShareableLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedTabIdentifier = urlParams.get('tab');
            const sharedEntryIds = urlParams.get('entries');

            if (sharedTabIdentifier && sharedEntryIds) {
                appState.readOnlyMode = true;
                appState.sharedTabId = sharedTabIdentifier;
                appState.sharedEntryIds = sharedEntryIds.split(',');

                // Determine which tab to switch to based on the identifier
                if (sharedTabIdentifier === 'allVault' || sharedTabIdentifier === 'allData') {
                    appState.currentTab = 'intelligence-vault';
                    appState.currentIntelligenceVaultSubTab = 'tools';
                } else if (appState.customTabs.find(tab => tab.id === sharedTabIdentifier)) {
                    appState.currentTab = 'custom-tabs';
                    appState.currentCustomTab = sharedTabIdentifier;
                } else if (['tools', 'emails', 'phones', 'crypto', 'locations', 'links', 'media', 'passwords', 'keywords', 'socials'].includes(sharedTabIdentifier)) {
                    appState.currentTab = 'intelligence-vault';
                    appState.currentIntelligenceVaultSubTab = sharedTabIdentifier;
                } else {
                    showToast('Shared content not found or invalid link.', 'error');
                    appState.readOnlyMode = false; // Reset if invalid
                    // DO NOT clear history here if it's an invalid link,
                    // the user might want to see the malformed URL.
                    return;
                }

                showToast('Viewing shared intelligence vault (Read-Only).', 'info');
                // IMPORTANT CHANGE: Do NOT clear the URL parameters here.
                // history.replaceState({}, document.title, window.location.pathname); // REMOVE OR COMMENT THIS LINE
            } else {
                appState.readOnlyMode = false;
                // When not in read-only mode, it's safe to clear any old share parameters
                // if they happen to be lingering without a valid 'tab' and 'entries'
                const currentUrl = new URL(window.location.href);
                if (currentUrl.searchParams.has('tab') || currentUrl.searchParams.has('entries')) {
                    history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // New: Function to apply or remove read-only mode UI restrictions
        function applyReadOnlyMode() {
            const addEntryBtn = document.getElementById('addEntryBtn');
            const editButtons = document.querySelectorAll('.action-btn[data-action="edit"]');
            const deleteButtons = document.querySelectorAll('.action-btn[data-action="delete"]');
            const bulkActionsDiv = document.getElementById('bulkActions');
            const createSubTabBtn = document.getElementById('createSubTabBtn');
            const editSubTabBtn = document.getElementById('editSubTabBtn');
            const deleteSubTabBtn = document.getElementById('deleteSubTabBtn');
            const exportSubTabBtn = document.getElementById('exportSubTabBtn');
            const shareOptionsBtn = document.getElementById('shareOptionsBtn'); // Reference to the new global share button
            const categoryFilter = document.getElementById('categoryFilter');
            const sortFilter = document.getElementById('sortFilter');
            const searchInput = document.getElementById('searchInput');
            const searchScopeSelect = document.getElementById('searchScopeSelect');
            const showAllBtn = document.getElementById('showAllBtn');
            const pinAllBtn = document.getElementById('pinAllBtn');
            const starAllBtn = document.getElementById('starAllBtn');
            const reportBtn = document.getElementById('reportBtn');
            const newRandomBtn = document.getElementById('newRandomBtn'); // New: Random tool button
            // NEW HANDBOOK ELEMENTS
            const handbookSearchInput = document.getElementById('handbookSearchInput');
            const handbookUserNotesTextarea = document.querySelectorAll('.user-notes-textarea'); // Will be empty now
            const newNoteBtn = document.getElementById('newNoteBtn');
            const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
            const deleteCurrentNoteBtn = document.getElementById('deleteCurrentNoteBtn');
            const richEditorToolbar = document.getElementById('richEditorToolbar');
            const noteEditor = document.getElementById('noteEditor');
            const noteActionButtons = document.querySelectorAll('.note-action-btn'); // Get all note action buttons
            const notePinIcons = document.querySelectorAll('.note-pin-icon'); // Get all pin icons

            if (appState.readOnlyMode) {
                // Hide or disable buttons/controls
                if (addEntryBtn) addEntryBtn.style.display = 'none';
                editButtons.forEach(btn => btn.style.display = 'none');
                deleteButtons.forEach(btn => btn.style.display = 'none');
                if (bulkActionsDiv) bulkActionsDiv.style.display = 'none';
                if (createSubTabBtn) createSubTabBtn.style.display = 'none';
                if (editSubTabBtn) editSubTabBtn.style.display = 'none';
                if (deleteSubTabBtn) deleteSubTabBtn.style.display = 'none';
                if (exportSubTabBtn) exportSubTabBtn.style.display = 'none';
                if (shareOptionsBtn) shareOptionsBtn.style.display = 'none'; // Hide the new global share button
                if (categoryFilter) categoryFilter.setAttribute('disabled', 'disabled');
                if (sortFilter) sortFilter.setAttribute('disabled', 'disabled');
                if (searchInput) searchInput.setAttribute('disabled', 'disabled'); // Disable search too in read-only
                if (searchScopeSelect) searchScopeSelect.setAttribute('disabled', 'disabled');
                if (showAllBtn) showAllBtn.style.display = 'none';
                if (pinAllBtn) pinAllBtn.style.display = 'none';
                if (starAllBtn) starAllBtn.style.display = 'none';
                if (reportBtn) reportBtn.style.display = 'none';
                if (newRandomBtn) newRandomBtn.style.display = 'none'; // Hide random tool button
                // NEW HANDBOOK DISABLES
                if (handbookSearchInput) handbookSearchInput.setAttribute('disabled', 'disabled');
                handbookUserNotesTextarea.forEach(el => el.setAttribute('disabled', 'disabled')); // This query will now return no elements, which is fine
                if (newNoteBtn) newNoteBtn.style.display = 'none';
                if (saveCurrentNoteBtn) saveCurrentNoteBtn.style.display = 'none';
                if (deleteCurrentNoteBtn) deleteCurrentNoteBtn.style.display = 'none';
                if (richEditorToolbar) richEditorToolbar.style.display = 'none'; // Hide editor toolbar
                if (noteEditor) noteEditor.setAttribute('contenteditable', 'false'); // Disable contenteditable

                // Disable note specific action buttons and pin icons
                noteActionButtons.forEach(btn => btn.style.display = 'none');
                notePinIcons.forEach(icon => icon.style.pointerEvents = 'none');

                // Also disable form submissions and inputs in modals
                document.querySelectorAll('.modal form button[type="submit"], .modal input, .modal select, .modal textarea').forEach(el => {
                    if (el.tagName === 'BUTTON') el.style.display = 'none'; // Hide submit buttons
                    else el.setAttribute('disabled', 'disabled'); // Disable inputs
                });

            } else {
                // Re-enable everything for normal use
                if (addEntryBtn) addEntryBtn.style.display = 'inline-flex';
                editButtons.forEach(btn => btn.style.display = 'inline-flex');
                deleteButtons.forEach(btn => btn.style.display = 'inline-flex');
                // updateBulkActions() will handle visibility based on selection for bulk actions
                if (createSubTabBtn) createSubTabBtn.style.display = 'inline-flex';
                // These will be re-enabled by renderCustomTabs() based on currentCustomTab presence
                if (exportSubTabBtn) exportSubTabBtn.style.display = 'inline-flex';
                if (shareOptionsBtn) shareOptionsBtn.style.display = 'inline-flex'; // Show the new global share button
                
                if (categoryFilter) categoryFilter.removeAttribute('disabled');
                if (sortFilter) sortFilter.removeAttribute('disabled');
                if (searchInput) searchInput.removeAttribute('disabled');
                if (searchScopeSelect) searchScopeSelect.removeAttribute('disabled');
                if (showAllBtn) showAllBtn.style.display = 'block';
                if (pinAllBtn) pinAllBtn.style.display = 'block';
                if (starAllBtn) starAllBtn.style.display = 'block';
                if (reportBtn) reportBtn.style.display = 'block';
                if (newRandomBtn) newRandomBtn.style.display = 'block'; // Show random tool button
                // NEW HANDBOOK ENABLES
                if (handbookSearchInput) handbookSearchInput.removeAttribute('disabled');
                handbookUserNotesTextarea.forEach(el => el.removeAttribute('disabled')); // This query will now return no elements, which is fine
                if (newNoteBtn) newNoteBtn.style.display = 'inline-flex';
                // Visibility of save/delete/toolbar/editor will be handled by switchHandbookSubTab and renderNoteList
                if (noteEditor) noteEditor.setAttribute('contenteditable', 'true');

                // Enable note specific action buttons and pin icons (visibility handled by renderNoteList)
                noteActionButtons.forEach(btn => btn.style.display = 'inline-block'); // Or 'inline-flex'
                notePinIcons.forEach(icon => icon.style.pointerEvents = 'auto');

                document.querySelectorAll('.modal form button[type="submit"], .modal input, .modal select, .modal textarea').forEach(el => {
                    if (el.tagName === 'BUTTON') el.style.removeProperty('display');
                    else el.removeAttribute('disabled');
                });
                updateBulkActions(); // Ensure bulk actions bar visibility is correct
                renderCustomTabs(); // This will re-evaluate display of edit/delete/share buttons based on current state
            }
        }

        // New: Function to open the selective share options modal
        function showShareOptionsModal() {
            if (appState.readOnlyMode) {
                showToast("Cannot generate share links in read-only shared view.", "warning");
                return;
            }

            const shareScopeSelect = document.getElementById('shareScopeSelect');
            const specificCustomTabSelector = document.getElementById('specificCustomTabSelector');
            const selectCustomTabForSharing = document.getElementById('selectCustomTabForSharing');

            // Reset default selections and hide specific custom tab selector
            shareScopeSelect.value = 'currentTab';
            specificCustomTabSelector.style.display = 'none';
            selectCustomTabForSharing.innerHTML = ''; // Clear previous custom tab options

            // Populate the 'specificCustomTab' option and dropdown if custom tabs exist
            const specificCustomTabOption = shareScopeSelect.querySelector('option[value="specificCustomTab"]');

            if (appState.customTabs.length > 0) {
                specificCustomTabOption.style.display = 'block'; // Show the option
                appState.customTabs.forEach(tab => {
                    const option = document.createElement('option');
                    option.value = tab.id;
                    option.textContent = tab.name;
                    selectCustomTabForSharing.appendChild(option);
                });
            } else {
                specificCustomTabOption.style.display = 'none'; // Hide if no custom tabs
            }

            // Attempt to set default selection based on current active tab
            if (appState.currentTab === 'custom-tabs' && appState.currentCustomTab) {
                shareScopeSelect.value = 'specificCustomTab';
                specificCustomTabSelector.style.display = 'block';
                selectCustomTabForSharing.value = appState.currentCustomTab;
            } else if (appState.currentTab === 'intelligence-vault') {
                // If in intelligence vault, default to sharing the current sub-tab
                // The 'currentTab' option in the select actually corresponds to current intelligence vault sub-tab for this case.
                shareScopeSelect.value = 'currentTab'; // This maps to intelligence vault sub-tabs
            } else {
                // For Analytics or Threat Intel tabs, default to sharing All Data
                shareScopeSelect.value = 'allData';
            }
            
            showModal('shareOptionsModal');
        }

        // New: Handle change in share scope selection
        function handleShareScopeChange(e) {
            const specificCustomTabSelector = document.getElementById('specificCustomTabSelector');
            if (e.target.value === 'specificCustomTab') {
                specificCustomTabSelector.style.display = 'block';
            } else {
                specificCustomTabSelector.style.display = 'none';
            }
        }

        // New: Handle submission of the share options form
        function handleShareFormSubmit(e) {
            e.preventDefault();
            hideModal('shareOptionsModal');

            const shareScope = document.getElementById('shareScopeSelect').value;
            let shareLink = '';
            const currentBaseUrl = window.location.origin + window.location.pathname;

            let sharedTabIdentifier = ''; // Will be the 'tab' URL parameter
            let entryIdsToShare = [];

            // Helper to collect all entries
            const getAllEntriesCombined = () => [...appState.tools, ...appState.emails, ...appState.phones,
                                                ...appState.crypto, ...appState.locations, ...appState.links,
                                                ...appState.media, ...appState.passwords, ...appState.keywords,
                                                ...appState.socials];

            switch (shareScope) {
                case 'currentTab':
                    // This maps to sharing the current active Intelligence Vault sub-tab.
                    // If the user is on Analytics or Threat Intel, it defaults to 'allData' during modal open.
                    sharedTabIdentifier = appState.currentIntelligenceVaultSubTab;
                    let currentEntries = [];
                    switch(sharedTabIdentifier) {
                        case 'tools': currentEntries = appState.tools; break;
                        case 'emails': currentEntries = appState.emails; break;
                        case 'phones': currentEntries = appState.phones; break;
                        case 'crypto': currentEntries = appState.crypto; break;
                        case 'locations': currentEntries = appState.locations; break;
                        case 'links': currentEntries = appState.links; break;
                        case 'media': currentEntries = appState.media; break;
                        case 'passwords': currentEntries = appState.passwords; break;
                        case 'keywords': currentEntries = appState.keywords; break;
                        case 'socials': currentEntries = appState.socials; break;
                        default:
                            showToast('Cannot share "Current Tab" from Analytics/Threats. Select "All Data".', 'warning');
                            return;
                    }
                    entryIdsToShare = currentEntries.map(entry => entry.id);
                    shareLink = `${currentBaseUrl}?tab=${sharedTabIdentifier}&entries=${entryIdsToShare.join(',')}`;
                    break;

                case 'allVault':
                    // Share all entries from the Intelligence Vault (all sub-tabs combined)
                    sharedTabIdentifier = 'allVault'; // A special identifier for the shared view
                    entryIdsToShare = getAllEntriesCombined().map(entry => entry.id);
                    shareLink = `${currentBaseUrl}?tab=${sharedTabIdentifier}&entries=${entryIdsToShare.join(',')}`;
                    break;

                case 'allData':
                    // Share all available data, including Analytics and Threats (though only entries will be highlighted)
                    sharedTabIdentifier = 'allData'; // A special identifier for the shared view
                    entryIdsToShare = getAllEntriesCombined().map(entry => entry.id);
                    shareLink = `${currentBaseUrl}?tab=${sharedTabIdentifier}&entries=${entryIdsToShare.join(',')}`;
                    break;

                case 'specificCustomTab':
                    const customTabId = document.getElementById('selectCustomTabForSharing').value;
                    const customTab = appState.customTabs.find(tab => tab.id === customTabId);
                    if (customTab) {
                        sharedTabIdentifier = customTab.id; // The custom tab's actual ID
                        entryIdsToShare = customTab.toolIds; // Custom tabs already store all assigned entry IDs
                        shareLink = `${currentBaseUrl}?tab=${sharedTabIdentifier}&entries=${entryIdsToShare.join(',')}`;
                    } else {
                        showToast('Error: Selected custom tab not found for sharing.', 'error');
                        return;
                    }
                    break;
            }

            if (entryIdsToShare.length === 0) {
                showToast('No entries found to share for the selected scope.', 'warning');
                return;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(shareLink).then(() => {
                showToast('Share link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showToast('Failed to copy link. Please copy manually: ' + shareLink, 'error');
            });
        }

        // NEW: Handbook & Notes Functions

// Load handbook state from localStorage
function loadHandbookState() {
    const savedHandbookState = localStorage.getItem('osintHandbookState');
    if (savedHandbookState) {
        Object.assign(handbookState, JSON.parse(savedHandbookState));
    }
    const savedNotes = localStorage.getItem('osintUserNotes');
    if (savedNotes) {
        handbookState.notes = JSON.parse(savedNotes);
        // Ensure addedDate is Date object and pinned is boolean for each note
        handbookState.notes.forEach(note => {
            if (typeof note.addedDate === 'string') {
                note.addedDate = new Date(note.addedDate);
            }
            if (typeof note.pinned === 'undefined') { // Initialize pinned if it doesn't exist
                note.pinned = false;
            }
        });
    } else {
        handbookState.notes = [];
    }
}

// Save handbook state to localStorage
function saveHandbookState() {
    localStorage.setItem('osintHandbookState', JSON.stringify(handbookState));
    // Notes are saved separately
    localStorage.setItem('osintUserNotes', JSON.stringify(handbookState.notes));
}

// Render handbook sidebar
function renderSidebar(searchTerm = '') {
    const sidebarMenu = document.getElementById('handbookSidebarMenu');
    sidebarMenu.innerHTML = ''; // Clear existing items

    const filteredSections = ALL_HANDBOOK_SECTIONS.filter(section =>
        section.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        handbookContent[section.id]?.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        handbookContent[section.id]?.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    const parentSections = filteredSections.filter(s => s.parent === null);

    parentSections.forEach(parentSection => {
        const parentItem = document.createElement('li');
        parentItem.className = `sidebar-item parent ${handbookState.selectedSection === parentSection.id ? 'active' : ''}`;
        parentItem.dataset.sectionId = parentSection.id;
        parentItem.innerHTML = `<i class="${handbookContent[parentSection.id]?.icon || 'fas fa-folder'}"></i> ${parentSection.title}`;
        sidebarMenu.appendChild(parentItem);

        const subMenu = document.createElement('ul');
        subMenu.className = 'sub-menu';
        sidebarMenu.appendChild(subMenu);

        const childSections = filteredSections.filter(s => s.parent === parentSection.id);
        childSections.forEach(childSection => {
            const childItem = document.createElement('li');
            childItem.className = `sub-menu-item ${handbookState.selectedSection === childSection.id ? 'active' : ''}`;
            childItem.dataset.sectionId = childSection.id;
            childItem.innerHTML = `<i class="${handbookContent[childSection.id]?.icon || 'fas fa-file-alt'}"></i> ${childSection.title}`;
            subMenu.appendChild(childItem);
        });
    });

    // Special handling for the "My Notes" section if it were part of the sidebar structure
    // For now, it's a sub-tab, so no need to render it here
}

// Select a handbook section and render its content
function selectHandbookSection(sectionId) {
    if (!handbookContent[sectionId]) {
        document.getElementById('handbookViewerContent').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Content Not Found</h3>
                <p>The selected handbook section could not be loaded.</p>
            </div>
        `;
        handbookState.selectedSection = null;
        renderSidebar(document.getElementById('handbookSearchInput').value); // Re-render sidebar without active selection
        return;
    }

    handbookState.selectedSection = sectionId;
    renderSidebar(document.getElementById('handbookSearchInput').value); // Update active state in sidebar

    const content = handbookContent[sectionId];
    const handbookViewerContent = document.getElementById('handbookViewerContent');
    handbookViewerContent.innerHTML = ''; // Clear previous content

    const fragment = document.createDocumentFragment();

    const titleElem = document.createElement('h2');
    titleElem.className = 'handbook-section-title';
    titleElem.textContent = content.title;
    fragment.appendChild(titleElem);

    const descriptionElem = document.createElement('p');
    descriptionElem.className = 'handbook-description';
    descriptionElem.textContent = content.description;
    fragment.appendChild(descriptionElem);

    if (content.code) {
        const codeBlockDiv = document.createElement('div');
        codeBlockDiv.className = 'code-block';
        const codePre = document.createElement('pre');
        const codeElem = document.createElement('code');
        codeElem.textContent = content.code;
        codePre.appendChild(codeElem);
        codeBlockDiv.appendChild(codePre);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', () => copyCode(codeElem.textContent, copyBtn));
        codeBlockDiv.appendChild(copyBtn);
        fragment.appendChild(codeBlockDiv);
    }

    if (content.tags && content.tags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'handbook-tags';
        content.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'handbook-tag';
            tagSpan.textContent = tag;
            tagsDiv.appendChild(tagSpan);
        });
        fragment.appendChild(tagsDiv);
    }

    handbookViewerContent.appendChild(fragment);
    saveHandbookState();
}

// Function to copy code to clipboard
function copyCode(text, button) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
            showToast('Code copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            showToast('Failed to copy code.', 'error');
        });
    } else {
        // Fallback for older browsers (not strictly required by prompt, but good practice)
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-99999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
            showToast('Code copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy text (fallback): ', err);
            showToast('Failed to copy code.', 'error');
        }
        document.body.removeChild(textArea);
    }
}



// Toggle sidebar collapse
function toggleSidebar() {
    const sidebar = document.querySelector('.handbook-sidebar');
    handbookState.sidebarCollapsed = !handbookState.sidebarCollapsed;
    sidebar.classList.toggle('collapsed', handbookState.sidebarCollapsed);
    saveHandbookState();
    // Re-render sidebar to show/hide text content correctly if needed
    renderSidebar(document.getElementById('handbookSearchInput').value);
}

// NEW: Notes Editor Functions

// Switch handbook sub-tabs
function switchHandbookSubTab(subTabName) {
    // Update sub-tab buttons
    document.querySelectorAll('.handbook-sub-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    const targetSubTabBtn = document.querySelector(`[data-sub-tab="${subTabName}"]`);
    if (targetSubTabBtn) {
        targetSubTabBtn.classList.add('active');
    }

    // Get all relevant content areas and hide them initially
    const handbookViewerContent = document.getElementById('handbookViewerContent');
    const notesEditorContent = document.getElementById('notesEditorContent');
    const richEditorToolbar = document.getElementById('richEditorToolbar');
    const noteEditor = document.getElementById('noteEditor');
    const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
    const deleteCurrentNoteBtn = document.getElementById('deleteCurrentNoteBtn');
    const emptyHandbookState = document.getElementById('emptyHandbookState');
    const emptyNotesState = document.getElementById('emptyNotesState'); // Ensure this is obtained

    // Use null-conditional checks for safety
    if (handbookViewerContent) handbookViewerContent.style.display = 'none';
    if (notesEditorContent) notesEditorContent.style.display = 'none';
    if (richEditorToolbar) richEditorToolbar.style.display = 'none';
    if (noteEditor) noteEditor.style.display = 'none';
    if (saveCurrentNoteBtn) saveCurrentNoteBtn.style.display = 'none';
    if (deleteCurrentNoteBtn) deleteCurrentNoteBtn.style.display = 'none';
    if (emptyHandbookState) emptyHandbookState.style.display = 'none';
    if (emptyNotesState) emptyNotesState.style.display = 'none'; // Also hide this at the start

    if (subTabName === 'handbook-viewer') {
        if (handbookViewerContent) handbookViewerContent.style.display = 'block';
        // Ensure initial handbook content is rendered if no section is selected
        if (!handbookState.selectedSection) {
            if (emptyHandbookState) emptyHandbookState.style.display = 'block'; // Show empty state for handbook
        } else {
            selectHandbookSection(handbookState.selectedSection); // Re-render selected section
            // selectHandbookSection will manage emptyHandbookState display
        }

    } else if (subTabName === 'notes-editor') {
        if (notesEditorContent) notesEditorContent.style.display = 'block';
        
        renderNoteList(); // Render the list of saved notes (this will also manage emptyNotesState visibility)

        // Show/hide editor and its controls based on activeNoteId
        if (handbookState.activeNoteId) {
            const activeNote = handbookState.notes.find(note => note.id === handbookState.activeNoteId);
            if (activeNote) {
                if (noteEditor) noteEditor.innerHTML = activeNote.content;
                if (richEditorToolbar) richEditorToolbar.style.display = 'flex';
                if (noteEditor) noteEditor.style.display = 'block';
                if (saveCurrentNoteBtn) saveCurrentNoteBtn.style.display = 'inline-flex';
                if (deleteCurrentNoteBtn) deleteCurrentNoteBtn.style.display = 'inline-flex';
            }
        }
        // If no active note, editor and controls remain hidden as per initial `display = 'none'`
    }
    handbookState.currentHandbookSubTab = subTabName;
    saveHandbookState();
}

// Render the list of saved notes
function renderNoteList() {
    const savedNotesList = document.getElementById('savedNotesList');
    const emptyNotesState = document.getElementById('emptyNotesState');
    const richEditorToolbar = document.getElementById('richEditorToolbar');
    const noteEditor = document.getElementById('noteEditor');
    const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
    const deleteCurrentNoteBtn = document.getElementById('deleteCurrentNoteBtn');
    const newNoteBtn = document.getElementById('newNoteBtn'); // Get new note button

    if (!savedNotesList || !emptyNotesState || !richEditorToolbar || !noteEditor || !saveCurrentNoteBtn || !deleteCurrentNoteBtn || !newNoteBtn) {
        console.error("renderNoteList: Required DOM elements for notes list or editor not found.");
        return;
    }

    savedNotesList.innerHTML = ''; // Clear existing items

    if (handbookState.notes.length === 0) {
        emptyNotesState.style.display = 'block';
        // Hide editor and controls if no notes
        richEditorToolbar.style.display = 'none';
        noteEditor.style.display = 'none';
        noteEditor.innerHTML = ''; // Clear editor content
        saveCurrentNoteBtn.style.display = 'none';
        deleteCurrentNoteBtn.style.display = 'none';
        newNoteBtn.style.display = 'inline-flex'; // Ensure New Note button is visible
        return;
    } else {
        emptyNotesState.style.display = 'none'; // Hide empty state if there are notes
        newNoteBtn.style.display = 'inline-flex'; // Ensure New Note button is visible
    }

    // Sort: pinned notes first, then by most recent date
    handbookState.notes.sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return b.addedDate - a.addedDate; // Most recent first for unpinned/equally pinned
    });

    handbookState.notes.forEach(note => {
        const noteItem = document.createElement('li');
        // Add 'active' class if this is the currently viewed/edited note
        noteItem.className = `note-item ${handbookState.activeNoteId === note.id ? 'active' : ''} ${note.pinned ? 'pinned' : ''}`;
        noteItem.dataset.noteId = note.id;

        const noteTitleContainer = document.createElement('div');
        noteTitleContainer.className = 'note-item-title-container';

        const pinIcon = document.createElement('i');
        pinIcon.className = `fas fa-thumbtack note-pin-icon ${note.pinned ? 'pinned' : ''}`;
        pinIcon.style.marginRight = '8px';
        pinIcon.style.color = note.pinned ? 'var(--accent)' : 'var(--text-muted)';
        pinIcon.style.cursor = 'pointer';
        pinIcon.title = note.pinned ? 'Unpin Note' : 'Pin Note';
        pinIcon.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the parent <li> click
            toggleNotePin(note.id);
        });
        noteTitleContainer.appendChild(pinIcon);

        const noteTitle = document.createElement('span');
        noteTitle.className = 'note-item-title';
        noteTitle.textContent = note.title;
        noteTitleContainer.appendChild(noteTitle);

        const noteDate = document.createElement('span');
        noteDate.className = 'note-item-date';
        noteDate.textContent = new Date(note.addedDate).toLocaleDateString();

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'note-actions';

        const viewBtn = document.createElement('button');
        viewBtn.className = 'note-action-btn';
        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
        viewBtn.title = 'View Note';
        viewBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            viewNote(note.id); // NEW: Call viewNote function
        });

        const editBtn = document.createElement('button');
        editBtn.className = 'note-action-btn';
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Edit Note';
        editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openNoteInEditor(note.id); // NEW: Call openNoteInEditor function
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'note-action-btn';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Delete Note';
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteNote(note.id);
        });

        actionsDiv.appendChild(viewBtn); // Add view button
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        noteItem.appendChild(noteTitleContainer);
        noteItem.appendChild(noteDate);
        noteItem.appendChild(actionsDiv);

        // Clicking the item itself should view the note by default
        noteItem.addEventListener('click', () => {
            viewNote(note.id);
        });

        savedNotesList.appendChild(noteItem);
    });

    // Handle initial display of editor/toolbar based on handbookState.noteViewMode and activeNoteId
    if (handbookState.activeNoteId && handbookState.noteViewMode === 'edit') {
        richEditorToolbar.style.display = 'flex';
        noteEditor.style.display = 'block';
        noteEditor.setAttribute('contenteditable', 'true');
        saveCurrentNoteBtn.style.display = 'inline-flex';
        deleteCurrentNoteBtn.style.display = 'inline-flex';
    } else if (handbookState.activeNoteId && handbookState.noteViewMode === 'view') {
        richEditorToolbar.style.display = 'none';
        noteEditor.style.display = 'block';
        noteEditor.setAttribute('contenteditable', 'false');
        saveCurrentNoteBtn.style.display = 'none'; // No need to save in view mode
        deleteCurrentNoteBtn.style.display = 'inline-flex'; // Can still delete in view mode
    } else { // No active note selected
        richEditorToolbar.style.display = 'none';
        noteEditor.style.display = 'none';
        noteEditor.innerHTML = ''; // Clear content when no note is active
        saveCurrentNoteBtn.style.display = 'none';
        deleteCurrentNoteBtn.style.display = 'none';
    }

    applyReadOnlyMode(); // Ensure action buttons are hidden/shown based on read-only mode after rendering the list
}

// Toggle pin status for a note
function toggleNotePin(noteId) {
    if (appState.readOnlyMode) {
        showToast("Cannot pin/unpin notes in read-only shared view.", "warning");
        return;
    }
    const note = handbookState.notes.find(n => n.id === noteId);
    if (note) {
        note.pinned = !note.pinned;
        renderNoteList(); // Re-render to reflect new pin status and sorting
        saveHandbookState();
        showToast(note.pinned ? 'Note pinned!' : 'Note unpinned!');
    }
}

// Create a new note
function createNote() {
    if (appState.readOnlyMode) {
        showToast("Cannot create notes in read-only shared view.", "warning");
        return;
    }

    const noteTitle = prompt("Enter a title for your new note:");
    if (noteTitle === null || noteTitle.trim() === "") {
        showToast("Note creation cancelled or title is empty.", "warning");
        return;
    }

    const newNote = {
        id: generateId(),
        title: noteTitle.trim(),
        content: '',
        addedDate: new Date(),
        pinned: false, // NEW: Initialize pinned status
    };
    handbookState.notes.unshift(newNote); // Add to the beginning
    handbookState.activeNoteId = newNote.id;
    handbookState.noteViewMode = 'edit'; // NEW: Automatically switch to edit mode for new note

    document.getElementById('noteEditor').innerHTML = newNote.content;
    document.getElementById('noteEditor').focus(); // Focus the editor for immediate typing

    // Update UI visibility based on new state
    switchHandbookSubTab('notes-editor'); // Re-render the sub-tab to ensure correct UI state
    showToast('New note created!');
}

// Open an existing note in the editor for editing
function openNoteInEditor(noteId) {
    if (appState.readOnlyMode) {
        showToast("Cannot edit notes in read-only shared view.", "warning");
        return;
    }

    const noteToEdit = handbookState.notes.find(note => note.id === noteId);
    if (noteToEdit) {
        handbookState.activeNoteId = noteId;
        handbookState.noteViewMode = 'edit'; // NEW: Set mode to edit

        document.getElementById('noteEditor').innerHTML = noteToEdit.content;
        document.getElementById('noteEditor').focus(); // Focus the editor
        
        // Update UI visibility based on new state
        switchHandbookSubTab('notes-editor'); // Re-render the sub-tab to ensure correct UI state
        renderNoteList(); // Update active class
        saveHandbookState();
    } else {
        showToast('Note not found.', 'error');
    }
}

// View a note (read-only)
function viewNote(noteId) {
    const noteToView = handbookState.notes.find(note => note.id === noteId);
    if (noteToView) {
        handbookState.activeNoteId = noteId;
        handbookState.noteViewMode = 'view'; // NEW: Set mode to view

        const noteEditor = document.getElementById('noteEditor');
        const richEditorToolbar = document.getElementById('richEditorToolbar');
        const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
        const deleteCurrentNoteBtn = document.getElementById('deleteCurrentNoteBtn');

        // Hide editor components and show content as read-only
        if (richEditorToolbar) richEditorToolbar.style.display = 'none';
        if (saveCurrentNoteBtn) saveCurrentNoteBtn.style.display = 'none';
        if (deleteCurrentNoteBtn) deleteCurrentNoteBtn.style.display = 'none';

        if (noteEditor) {
            noteEditor.innerHTML = `<h3>${noteToView.title}</h3><p class="text-muted" style="font-size: 0.85em; margin-bottom: 15px;">Last Modified: ${new Date(noteToView.addedDate).toLocaleString()}</p>${noteToView.content}`;
            noteEditor.style.display = 'block';
            noteEditor.setAttribute('contenteditable', 'false'); // Make it read-only
            noteEditor.scrollTop = 0; // Scroll to top
        }
        renderNoteList(); // Update active class
        saveHandbookState();
    } else {
        showToast('Note not found.', 'error');
    }
}

// Save content of the currently active note
function saveNoteContent() {
    if (appState.readOnlyMode) {
        showToast("Cannot save notes in read-only shared view.", "warning");
        return;
    }

    if (!handbookState.activeNoteId) {
        showToast('No note selected to save.', 'warning');
        return;
    }

    const noteIndex = handbookState.notes.findIndex(note => note.id === handbookState.activeNoteId);
    if (noteIndex > -1) {
        // Prompt for title if currently empty or generic
        let currentTitle = handbookState.notes[noteIndex].title || 'Untitled Note';
        const newTitle = prompt("Edit note title:", currentTitle);

        if (newTitle === null) { // User cancelled
            showToast('Note title update cancelled.', 'info');
            return;
        }

        if (newTitle.trim() === "") {
            showToast("Note title cannot be empty. Keeping previous title.", "warning");
            handbookState.notes[noteIndex].title = currentTitle; // Revert to old title
        } else {
            handbookState.notes[noteIndex].title = newTitle.trim();
        }

        handbookState.notes[noteIndex].content = document.getElementById('noteEditor').innerHTML;
        handbookState.notes[noteIndex].addedDate = new Date(); // Update modified date

        handbookState.noteViewMode = 'view'; // NEW: Switch to view mode after saving

        // Update UI visibility based on new state
        switchHandbookSubTab('notes-editor'); // Re-render the sub-tab to ensure correct UI state
        showToast('Note saved successfully!');
    } else {
        showToast('Error saving note.', 'error');
    }
}

// Delete a note
function deleteNote(noteId) {
    if (appState.readOnlyMode) {
        showToast("Cannot delete notes in read-only shared view.", "warning");
        return;
    }

    if (confirm('Are you sure you want to delete this note?')) {
        handbookState.notes = handbookState.notes.filter(note => note.id !== noteId);
        if (handbookState.activeNoteId === noteId) {
            handbookState.activeNoteId = null;
            handbookState.noteViewMode = 'view'; // NEW: Reset view mode

            // Clear editor content and hide editor elements
            const noteEditor = document.getElementById('noteEditor');
            const richEditorToolbar = document.getElementById('richEditorToolbar');
            const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
            const deleteCurrentNoteBtn = document.getElementById('deleteCurrentNoteBtn');

            if (noteEditor) noteEditor.innerHTML = '';
            if (richEditorToolbar) richEditorToolbar.style.display = 'none';
            if (noteEditor) noteEditor.style.display = 'none';
            if (saveCurrentNoteBtn) saveCurrentNoteBtn.style.display = 'none';
            if (deleteCurrentNoteBtn) deleteCurrentNoteBtn.style.display = 'none';
        }
        renderNoteList(); // Re-render to update list
        saveHandbookState();
        showToast('Note deleted!', 'error');
    }
}

// Rich Text Editor Commands
function formatDoc(command, value = null) {
    if (appState.readOnlyMode) {
        showToast("Cannot edit notes in read-only shared view.", "warning");
        return;
    }
    if (command === 'createLink') {
        const url = prompt('Enter the URL:', 'http://');
        if (url) {
            document.execCommand(command, false, url);
        }
    } else if (command === 'formatBlock') {
        document.execCommand(command, false, value);
    } else {
        document.execCommand(command, false, value);
    }
}

// NEW: Update applyReadOnlyMode to include handbook specific elements
        function applyReadOnlyMode() {
            const addEntryBtn = document.getElementById('addEntryBtn');
            const editButtons = document.querySelectorAll('.action-btn[data-action="edit"]');
            const deleteButtons = document.querySelectorAll('.action-btn[data-action="delete"]');
            const bulkActionsDiv = document.getElementById('bulkActions');
            const createSubTabBtn = document.getElementById('createSubTabBtn');
            const editSubTabBtn = document.getElementById('editSubTabBtn');
            const deleteSubTabBtn = document.getElementById('deleteSubTabBtn');
            const exportSubTabBtn = document.getElementById('exportSubTabBtn');
            const shareOptionsBtn = document.getElementById('shareOptionsBtn');
            const categoryFilter = document.getElementById('categoryFilter');
            const sortFilter = document.getElementById('sortFilter');
            const searchInput = document.getElementById('searchInput');
            const searchScopeSelect = document.getElementById('searchScopeSelect');
            const showAllBtn = document.getElementById('showAllBtn');
            const pinAllBtn = document.getElementById('pinAllBtn');
            const starAllBtn = document.getElementById('starAllBtn');
            const reportBtn = document.getElementById('reportBtn');
            const newRandomBtn = document.getElementById('newRandomBtn');
            // NEW HANDBOOK ELEMENTS
            const handbookSearchInput = document.getElementById('handbookSearchInput');
            const handbookUserNotesTextarea = document.querySelectorAll('.user-notes-textarea');
            const newNoteBtn = document.getElementById('newNoteBtn');
            const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
            const deleteCurrentNoteBtn = document.getElementById('deleteCurrentNoteBtn');
            const richEditorToolbar = document.getElementById('richEditorToolbar');
            const noteEditor = document.getElementById('noteEditor');

            if (appState.readOnlyMode) {
                if (addEntryBtn) addEntryBtn.style.display = 'none';
                editButtons.forEach(btn => btn.style.display = 'none');
                deleteButtons.forEach(btn => btn.style.display = 'none');
                if (bulkActionsDiv) bulkActionsDiv.style.display = 'none';
                if (createSubTabBtn) createSubTabBtn.style.display = 'none';
                if (editSubTabBtn) editSubTabBtn.style.display = 'none';
                if (deleteSubTabBtn) deleteSubTabBtn.style.display = 'none';
                if (exportSubTabBtn) exportSubTabBtn.style.display = 'none';
                if (shareOptionsBtn) shareOptionsBtn.style.display = 'none';
                if (categoryFilter) categoryFilter.setAttribute('disabled', 'disabled');
                if (sortFilter) sortFilter.setAttribute('disabled', 'disabled');
                if (searchInput) searchInput.setAttribute('disabled', 'disabled');
                if (searchScopeSelect) searchScopeSelect.setAttribute('disabled', 'disabled');
                if (showAllBtn) showAllBtn.style.display = 'none';
                if (pinAllBtn) pinAllBtn.style.display = 'none';
                if (starAllBtn) starAllBtn.style.display = 'none';
                if (reportBtn) reportBtn.style.display = 'none';
                if (newRandomBtn) newRandomBtn.style.display = 'none';

                // NEW HANDBOOK DISABLES
                if (handbookSearchInput) handbookSearchInput.setAttribute('disabled', 'disabled');
                handbookUserNotesTextarea.forEach(el => el.setAttribute('disabled', 'disabled'));
                if (newNoteBtn) newNoteBtn.style.display = 'none';
                if (saveCurrentNoteBtn) saveCurrentNoteBtn.style.display = 'none';
                if (deleteCurrentNoteBtn) deleteCurrentNoteBtn.style.display = 'none';
                if (richEditorToolbar) richEditorToolbar.style.display = 'none'; // Hide editor toolbar
                if (noteEditor) noteEditor.setAttribute('contenteditable', 'false'); // Disable contenteditable
                
                document.querySelectorAll('.modal form button[type="submit"], .modal input, .modal select, .modal textarea').forEach(el => {
                    if (el.tagName === 'BUTTON') el.style.display = 'none';
                    else el.setAttribute('disabled', 'disabled');
                });

                // Also disable click events on handbook sidebar items (for notes)
                document.querySelectorAll('#handbookSidebarMenu .sidebar-item, #handbookSidebarMenu .sub-menu-item').forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.7';
                });
                document.querySelectorAll('.note-action-btn').forEach(btn => btn.style.display = 'none');


            } else {
                if (addEntryBtn) addEntryBtn.style.display = 'inline-flex';
                editButtons.forEach(btn => btn.style.display = 'inline-flex');
                deleteButtons.forEach(btn => btn.style.display = 'inline-flex');
                if (createSubTabBtn) createSubTabBtn.style.display = 'inline-flex';
                if (exportSubTabBtn) exportSubTabBtn.style.display = 'inline-flex';
                if (shareOptionsBtn) shareOptionsBtn.style.display = 'inline-flex';
                
                if (categoryFilter) categoryFilter.removeAttribute('disabled');
                if (sortFilter) sortFilter.removeAttribute('disabled');
                if (searchInput) searchInput.removeAttribute('disabled');
                if (searchScopeSelect) searchScopeSelect.removeAttribute('disabled');
                if (showAllBtn) showAllBtn.style.display = 'block';
                if (pinAllBtn) pinAllBtn.style.display = 'block';
                if (starAllBtn) starAllBtn.style.display = 'block';
                if (reportBtn) reportBtn.style.display = 'block';
                if (newRandomBtn) newRandomBtn.style.display = 'block';

                // NEW HANDBOOK ENABLES
                if (handbookSearchInput) handbookSearchInput.removeAttribute('disabled');
                handbookUserNotesTextarea.forEach(el => el.removeAttribute('disabled'));
                if (newNoteBtn) newNoteBtn.style.display = 'inline-flex';
                // Visibility of save/delete/toolbar/editor will be handled by switchHandbookSubTab and editNote
                if (noteEditor) noteEditor.setAttribute('contenteditable', 'true');
                
                document.querySelectorAll('.modal form button[type="submit"], .modal input, .modal select, .modal textarea').forEach(el => {
                    if (el.tagName === 'BUTTON') el.style.removeProperty('display');
                    else el.removeAttribute('disabled');
                });

                // Re-enable click events on handbook sidebar items
                document.querySelectorAll('#handbookSidebarMenu .sidebar-item, #handbookSidebarMenu .sub-menu-item').forEach(item => {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '1';
                });
                document.querySelectorAll('.note-action-btn').forEach(btn => btn.style.display = 'inline-block'); // Or 'inline-flex' if you use that for buttons

                updateBulkActions();
                renderCustomTabs();
            }
        }


       // Initialize the application when DOM is loaded
       document.addEventListener('DOMContentLoaded', initApp);
   </script>
   
   <script>
        // Create connecting lines between evidence cards
        function createConnectingLines() {
            const cards = document.querySelectorAll('.evidence-card');
            const linesContainer = document.getElementById('connecting-lines');
            
            for (let i = 0; i < cards.length - 1; i++) {
                const line = document.createElement('div');
                line.className = 'line';
                
                const card1 = cards[i].getBoundingClientRect();
                const card2 = cards[i + 1].getBoundingClientRect();
                
                const x1 = card1.left + card1.width / 2;
                const y1 = card1.top + card1.height / 2;
                const x2 = card2.left + card2.width / 2;
                const y2 = card2.top + card2.height / 2;
                
                const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                
                line.style.width = length + 'px';
                line.style.left = x1 + 'px';
                line.style.top = y1 + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                line.style.animationDelay = `${i * 0.5}s`;
                
                linesContainer.appendChild(line);
            }
        }

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 4 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 10 + 8) + 's';
                particle.style.animationDelay = Math.random() * 8 + 's';
                
                particlesContainer.appendChild(particle);
            }
        }

        // Add hover effects to evidence cards
        function addCardEffects() {
            const cards = document.querySelectorAll('.evidence-card');
            
            cards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.filter = 'brightness(1.1) saturate(1.1)';
                    card.style.borderColor = 'var(--primary)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.filter = 'none';
                    card.style.borderColor = 'var(--border)';
                });
            });
        }

        // Initialize everything when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                createConnectingLines();
            }, 100);
            createParticles();
            addCardEffects();
        });

        // Recreate lines on window resize
        window.addEventListener('resize', () => {
            const linesContainer = document.getElementById('connecting-lines');
            linesContainer.innerHTML = '';
            setTimeout(() => {
                createConnectingLines();
            }, 100);
        });
    </script>

</body>
</html>
